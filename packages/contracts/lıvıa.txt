 [1] LIVIA Nihai ModÃ¼l Listesi (GruplandÄ±rÄ±lmÄ±ÅŸ)
Toplamda 26 modÃ¼l, 4 ana grup altÄ±nda iÅŸlevsel olarak ayrÄ±ldÄ±.

ğŸ§  A. Duygusal MÃ¼dahale ve BaskÄ±lama ModÃ¼lleri
AÅŸÄ±rÄ± Ã¶zgÃ¼ven, intikam iÅŸlemi, kimlik kanÄ±tlama gibi dÃ¼rtÃ¼sel tepkileri bastÄ±rmak iÃ§in kullanÄ±lÄ±r.

ModÃ¼l	GÃ¶rev
identityDrivenImpulseFilter.js	Kimlik kanÄ±tlama dÃ¼rtÃ¼sÃ¼yle yapÄ±lan iÅŸlemleri bastÄ±rÄ±r
rationalizationBlocker.js	â€œBu sefer farklÄ± olacakâ€ gibi biliÅŸsel Ã§arpÄ±tmalarÄ± engeller
subjectiveSensitivityFilter.js	Duygusal iÃ§erik varsa sinyalleri geÃ§ici durdurur
confidenceLimiter.js	AÅŸÄ±rÄ± gÃ¼ven varsa VIVO sinyallerine filtre uygular
emotionalSurgeLimiter.js	Duygusal yoÄŸunluk sonrasÄ± pozisyonlarÄ± filtreler
compensatoryRiskSpike.js	SL sonrasÄ± intikam pozisyonu aÃ§Ä±lmasÄ±nÄ± Ã¶nler
framingEffectNormalizer.js	Zarar pozisyonlarÄ±nÄ± duygusal Ã§erÃ§eveyle tutmayÄ± bastÄ±rÄ±r
adaptiveBiasShield.js (paylaÅŸÄ±mlÄ±)	OtobilinÃ§â€™ten gelen davranÄ±ÅŸ setine gÃ¶re sinyalleri engeller

âš ï¸ B. Psikolojik Savunma & Tepki YÃ¶netimi ModÃ¼lleri
SL sonrasÄ± travmatik iÅŸlem tepkileri, ani spikeâ€™lara verilen duygusal refleksler gibi durumlarda Ã§alÄ±ÅŸÄ±r.

ModÃ¼l	GÃ¶rev
emotionTriggeredDefence.js	SL sonrasÄ± fazla iÅŸlem varsa sistemsel savunma baÅŸlatÄ±r
macroDefenceTrigger.js	Teknik + psikolojik risk birlikteyse savunma modunu aktif eder
signalTrustLimiter.js	Sahte sinyal sayÄ±sÄ± artarsa geÃ§ici sinyal engelleme uygular
fiatDrivenEmotionalFilter.js	Kur etkisiyle oluÅŸan panik iÅŸlemleri bastÄ±rÄ±r
volatilityDefenceTrigger.js	AÅŸÄ±rÄ± oynaklÄ±kta pozisyon savunmasÄ± uygular
pauseRecommendationEngine.js	SL + kaÃ§an fÄ±rsat varsa sistemsel mola Ã¶nerir
fomoSpikeDefender.js	RSI > 70 + hacim spike varsa iÅŸlem durdurulur

ğŸ“‰ C. Risk ve Pozisyon Boyutu Dengeleyicileri
TP sonrasÄ± artan risk alma eÄŸilimini, zarar sonrasÄ± bÃ¼yÃ¼yen pozisyonlarÄ± bastÄ±rÄ±r.

ModÃ¼l	GÃ¶rev
riskTrustBalancer.js	Art arda TP sonrasÄ± bÃ¼yÃ¼yen riskleri sÄ±nÄ±rlar
emotionalCooldownTimer.js (Ã¶neriyle geldi)	2 bÃ¼yÃ¼k SL sonrasÄ± otomatik iÅŸlem geciktirme
positionSizeLimiter.js (anlamsal Ã§Ä±karÄ±m)	Duygusal durumlara gÃ¶re pozisyon bÃ¼yÃ¼klÃ¼ÄŸÃ¼nÃ¼ sÄ±nÄ±rlayan mantÄ±k
btcMismatchDefender.js	BTC dÃ¼ÅŸÃ¼ÅŸteyse altcoin long pozisyonlarÄ±nÄ± bloklar
confidenceLimiter.js	AÅŸÄ±rÄ± gÃ¼ven varsa pozisyon hacmine doÄŸrudan mÃ¼dahale eder

ğŸ” D. Sistem Ä°Ã§i & Ã‡apraz Denetleyici ModÃ¼ller
DiÄŸer sistemlerden gelen bilgilere gÃ¶re sinyal geÃ§iÅŸi, duygusal etiketleme veya davranÄ±ÅŸ dÃ¼zeltmesi yapar.

ModÃ¼l	GÃ¶rev
identityConflictResolver.js	Zarar edilen stratejiye duygusal dÃ¶nÃ¼ÅŸ varsa bastÄ±rÄ±r
crossBiasClusterTracker.js	AÅŸÄ±rÄ± gÃ¼ven + kayÄ±ptan kaÃ§Ä±nma kombosunu tespit eder
collectiveBiasFilter.js (VIVO destekli)	Trend/hype etkisi yÃ¼ksekse sinyalleri baskÄ±lar
adaptiveBiasShield.js (paylaÅŸÄ±mlÄ±)	DavranÄ±ÅŸsal Ã¶rÃ¼ntÃ¼ varsa sinyal engellenir
structuralBehaviorMonitor.js (ortak)	TÃ¼m sistemde davranÄ±ÅŸ yapÄ±sÄ±nÄ± analiz eder

[2] LIVIA Sisteminde Veri AlÄ±ÅŸveriÅŸi HaritasÄ±
AÅŸaÄŸÄ±da LIVIAâ€™nÄ±n diÄŸer sistemlerle olan veri iliÅŸkileri, hem aldÄ±ÄŸÄ± hem de gÃ¶nderdiÄŸi veri tÃ¼rleriyle birlikte sunulmuÅŸtur:

ğŸ“¥ A. Veri ALDIÄI Sistemler
Sistem	Gelen Veri	Kullanan ModÃ¼l(ler)
OtobilinÃ§	Zihinsel yorgunluk, Ã¶nyargÄ±, refleks Ã¶rÃ¼ntÃ¼leri	adaptiveBiasShield.js, crossBiasClusterTracker.js, confidenceLimiter.js, compensatoryRiskSpike.js
VIVO	Sinyal baskÄ± gerekliliÄŸi, varyant tipleri	signalTrustLimiter.js, pauseRecommendationEngine.js, confidenceLimiter.js
Grafik Beyni	BTC trendi, hacim spike, volatilite	btcMismatchDefender.js, fomoSpikeDefender.js, volatilityDefenceTrigger.js, macroDefenceTrigger.js
Denetim AsistanÄ±	DavranÄ±ÅŸ loglarÄ±, bias yoÄŸunluÄŸu, SL sonrasÄ± psikolojik trend	crossBiasClusterTracker.js, rationalizationBlocker.js, identityConflictResolver.js

ğŸ“¤ B. Veri GÃ–NDERDÄ°ÄÄ° Sistemler
Sistem	GÃ¶nderilen Veri	GÃ¶nderen ModÃ¼l(ler)
VIVO	KullanÄ±cÄ± hazÄ±r deÄŸil â†’ sinyal geÃ§ici olarak baskÄ±lansÄ±n	pauseRecommendationEngine.js, adaptiveBiasShield.js, confidenceLimiter.js
OtobilinÃ§	Duygusal tepki sonucu oluÅŸan davranÄ±ÅŸ etiketleri	crossBiasClusterTracker.js, identityConflictResolver.js
Denetim AsistanÄ±	Ä°ÅŸlem filtreleme nedenleri ve sistemsel duygusal log	rationalizationBlocker.js, framingEffectNormalizer.js, emotionalSurgeLimiter.js

ğŸ”— C. Sistem Ä°Ã§i ModÃ¼ller ArasÄ± EtkileÅŸim Zincirleri
Kaynak ModÃ¼l	Hedef ModÃ¼l	AÃ§Ä±klama
emotionTriggeredDefence.js	pauseRecommendationEngine.js	SL sonrasÄ± iÅŸlem baskÄ±landÄ±ÄŸÄ±nda otomatik mola Ã¶nerisi
adaptiveBiasShield.js	confidenceLimiter.js	Bias yoÄŸunluÄŸu varsa risk limiti ve sinyal azaltÄ±mÄ± birlikte uygulanÄ±r
compensatoryRiskSpike.js	positionSizeLimiter.js	SL sonrasÄ± bÃ¼yÃ¼k pozisyon varsa otomatik pozisyon limiti devreye girer

ğŸ§  D. LIVIA'nÄ±n Veri RolÃ¼ TanÄ±mÄ±
LIVIA, sistem iÃ§inde:

Duygusal filtre,

Risk sÄ±nÄ±rlayÄ±cÄ±,

Psikolojik savunma arayÃ¼zÃ¼,

Sinyal baskÄ±layÄ±cÄ± gibi Ã§alÄ±ÅŸÄ±r.

Yani gelen her sinyal LIVIA'dan geÃ§meden pozisyon olamaz.
Ve sadece engelleyici deÄŸil, â€œneden bastÄ±rÄ±yorumâ€ bilgisini de geri ileten bir sistemdir.

ğŸ§© [4] Yeni ModÃ¼l Ã–nerileri (LIVIA iÃ§in Zihinsel Savunma ve Dengeleyici YapÄ±lar)
LIVIAâ€™nÄ±n mevcut yapÄ±sÄ± iyi ama bazÄ± alanlar daha hassas, daha zeki bir mÃ¼dahale sistemiyle desteklenebilir.
AÅŸaÄŸÄ±daki boÅŸluklarÄ± tespit ettim ve bunlara Ã¶zel 5 modÃ¼l Ã¶neriyorum â¬‡ï¸

ğŸ”§ 1. emotionalRecoveryMonitor.js
ğŸ¯ AmaÃ§: SL sonrasÄ± psikolojik toparlanma sÃ¼recini Ã¶lÃ§mek, yeni iÅŸlem iÃ§in kullanÄ±cÄ± â€œhazÄ±r mÄ±â€ analiz etmek

ğŸ’¡ EÄŸer kullanÄ±cÄ±, SL sonrasÄ± ilk 3 iÅŸlemde odak sapmasÄ± gÃ¶steriyorsa â†’ yeni iÅŸlemler geciktirilir

Export: { toparlanmaSkoru, iÅŸlemÄ°zleri, Ã¶nerilenBekleme }

ğŸ”§ 2. reactiveDefenseGate.js
ğŸ¯ AmaÃ§: Duygusal tetikleyiciye karÅŸÄ± ilk iÅŸlemden sonra savunma duvarÄ± kurmak

ğŸ’¡ Ã–rneÄŸin: FOMO â†’ bir iÅŸlem aÃ§Ä±ldÄ±ysa â†’ sonraki 10 dakika sinyaller baskÄ±lanÄ±r

Export: { tetikleyici, savunmaAktif, kalanSÃ¼re }

ğŸ”§ 3. behavioralAnchorReset.js
ğŸ¯ AmaÃ§: KullanÄ±cÄ±nÄ±n pozitif/negatif iÅŸlem sonrasÄ± aÅŸÄ±rÄ± yÃ¶nelimi varsa sistem davranÄ±ÅŸÄ± sÄ±fÄ±rlama Ã¶nerir

ğŸ’¡ TP sonrasÄ± 2 pozisyon Ã¼st Ã¼ste long aÃ§ma â†’ sistem â€œanchor etkisiâ€ olduÄŸunu tespit eder, strateji deÄŸiÅŸimi Ã¶nerir

Export: { anchorTipi, yÃ¶nSapmasÄ±, resetÃ–nerisi }

ğŸ”§ 4. contextAwareMoralLimiter.js
ğŸ¯ AmaÃ§: Kur, siyasi olay, haber ÅŸoku gibi dÄ±ÅŸsal duygusal etken varsa sinyal geÃ§iÅŸini otomatik engeller

ğŸ’¡ EÄŸer Google Trends + sosyal medya + kur verisi birlikte hareketliyse â†’ sistem devreye girer

Export: { tetikleyiciOlay, sinyalKÄ±sÄ±tlama, riskNotu }

ğŸ”§ 5. empathyDrivenCooldownPlanner.js
ğŸ¯ AmaÃ§: KullanÄ±cÄ±nÄ±n yazdÄ±ÄŸÄ± notlar, aÃ§Ä±klamalar veya sesli ifadeleri analiz ederek psikolojik mola Ã¶nerisi sunar

ğŸ’¡ â€œBu sefer kaybedersem kendimi toparlayamamâ€ gibi bir ifade varsa â†’ otomatik mola sÃ¼reci baÅŸlatÄ±lÄ±r

Export: { ifadeAnalizi, molaÃ–nerisi, sinyalBlokDurumu }

ğŸ“Œ Eklenen ModÃ¼l Ã–zeti:
ModÃ¼l	GÃ¶rev AlanÄ±
emotionalRecoveryMonitor.js	SL sonrasÄ± psikolojik toparlanma
reactiveDefenseGate.js	Duygusal tepki sonrasÄ± ikinci savunma
behavioralAnchorReset.js	AÅŸÄ±rÄ± yÃ¶nlÃ¼ iÅŸlem zincirini sÄ±fÄ±rlama
contextAwareMoralLimiter.js	DÄ±ÅŸsal duygusal baskÄ±lara karÅŸÄ± savunma
empathyDrivenCooldownPlanner.js	KullanÄ±cÄ± ifadeleriyle psikolojik mola sÃ¼reci
Grafik Beyniâ€™nden Elenen ModÃ¼ller (LIVIA Uyum KontrolÃ¼)
ModÃ¼l	Ä°lk Yeri	Uyum	Karar
frustrationDrivenOvertrader.js	Grafik Beyni	â— FOMO + sinyalsiz iÅŸlem artÄ±ÅŸÄ± â†’ duygusal tetikleme	âœ… LIVIAâ€™ya taÅŸÄ±ndÄ±
fomoBiasFlagger.js	Grafik Beyni	â— FOMO baÅŸlangÄ±Ã§ davranÄ±ÅŸÄ± sinyali â†’ psikolojik filtreleme gerekli	âœ… LIVIAâ€™ya alÄ±nabilir, ama OtobilinÃ§ ile paylaÅŸÄ±labilir
sentimentDrivenDeviations.js	Grafik Beyni	âŒ Teknik sapma analizi â†’ psikolojik sinyal deÄŸil	âŒ KALDIRILDI
liquidityIntegrityFilter.js	Grafik Beyni	âŒ Teknik emir defteri analizi â†’ duygusal iÅŸlemle ilgisi yok	âŒ KALDIRILDI

ğŸ”„ OtobilinÃ§â€™ten Elenen ModÃ¼ller (LIVIA Uyum KontrolÃ¼)
ModÃ¼l	Ä°lk Yeri	Uyum	Karar
rationalizationBlocker.js	OtobilinÃ§	âœ… â€œKendini haklÄ± Ã§Ä±karmaâ€ gibi Ã§arpÄ±tmalarÄ± bastÄ±rÄ±r â†’ duygusal savunma filtresi	âœ… LIVIAâ€™ya taÅŸÄ±ndÄ±
framingEffectNormalizer.js	OtobilinÃ§	âœ… Zarar pozisyonunu Ã§erÃ§eveleyip iÅŸlemde kalma â†’ LIVIAâ€™nÄ±n iÅŸi	âœ… LIVIAâ€™ya taÅŸÄ±ndÄ±
beliefFeedbackLooper.js	OtobilinÃ§	âŒ Ã–ÄŸrenme Ã§arpÄ±klÄ±ÄŸÄ± + log analizi â†’ Denetim AsistanÄ± iÅŸi	âŒ KALDIRILDI
overtradingLoopCatcher.js	OtobilinÃ§	â— Ä°ÅŸlem yoÄŸunluÄŸu â†’ doÄŸrudan duygusal deÄŸil, otomatik refleks	âš ï¸ LIVIA yerine OtobilinÃ§'te kalsÄ±n

ğŸ”„ VIVOâ€™dan Elenen ModÃ¼ller (LIVIA Uyum KontrolÃ¼)
ModÃ¼l	Ä°lk Yeri	Uyum	Karar
signalReliabilityIndex.js	VIVO	âŒ Teknik baÅŸarÄ± skorlarÄ± â†’ duygusal yapÄ± deÄŸil	âŒ KALDIRILDI
formationPerformanceTracker.js	VIVO	âŒ Formasyon performansÄ± â†’ grafik/strateji analizi	âŒ KALDIRILDI
biasToProfitDivergence.js	VIVO	â— YanÄ±ltÄ±cÄ± kazanÃ§lar Ã¼zerinden kullanÄ±cÄ±yÄ± yanlÄ±ÅŸ yÃ¶nlendirme riski var	âš ï¸ SÄ±nÄ±rda â†’ Denetim AsistanÄ±'nda kalmalÄ±

âœ… LIVIAâ€™ya Eklenen Eski Sistem ModÃ¼lleri:
ModÃ¼l	Eski Sistemi	Sebep
frustrationDrivenOvertrader.js	Grafik Beyni	Sinyalsiz iÅŸlem patlamasÄ±nÄ± duygusal bastÄ±rma olarak tanÄ±mlar
fomoBiasFlagger.js	Grafik Beyni	FOMO eÄŸilimini daha iÅŸlem gelmeden tespit eder
rationalizationBlocker.js	OtobilinÃ§	Kendi kendini kandÄ±rma ve "bu sefer farklÄ±" gibi biliÅŸsel Ã§arpÄ±tmalarÄ± engeller
framingEffectNormalizer.js	OtobilinÃ§	ZararÄ± â€œumutlaâ€ tutma refleksini baskÄ±lar

ğŸ§  LIVIA Sistemi â€“ Temel Kodlama Promptu
ğŸ¯ GENEL GÃ–REVÄ°
LIVIA, sistemin duygusal filtreleme, psikolojik savunma ve davranÄ±ÅŸsal dengeleme katmanÄ±dÄ±r.
KullanÄ±cÄ±nÄ±n iÅŸlemlerindeki dÃ¼rtÃ¼sel, savunmacÄ± veya tehlikeli duygusal motivasyonlarÄ± analiz ederek:

Sinyalleri geÃ§ici olarak baskÄ±lar

Ä°ÅŸlem hacmini, sÄ±klÄ±ÄŸÄ±nÄ± veya zamanlamasÄ±nÄ± sÄ±nÄ±rlar

Gerekirse iÅŸlem aÃ§Ä±lmasÄ±nÄ± engeller

VIVO, OtobilinÃ§ ve Denetim AsistanÄ±â€™na geri bildirim gÃ¶nderir

ğŸ§± MODÃœL GRUPLARI & GÃ–REVLERÄ°
ğŸ”’ [1] Duygusal Tepki ve DÃ¼rtÃ¼ BaskÄ±layÄ±cÄ±lar
KullanÄ±cÄ±nÄ±n anlÄ±k tepkilerini bastÄ±rarak hatalÄ± iÅŸlem kararlarÄ±nÄ± Ã¶nler.

ModÃ¼ller:

identityDrivenImpulseFilter.js

rationalizationBlocker.js

framingEffectNormalizer.js

subjectiveSensitivityFilter.js

confidenceLimiter.js

adaptiveBiasShield.js (paylaÅŸÄ±mlÄ±)

rationalizationBlocker.js

frustrationDrivenOvertrader.js (eklendi)

fomoBiasFlagger.js (eklendi)

âš ï¸ [2] Psikolojik Savunma ModÃ¼lleri
Zarar sonrasÄ± Ã§Ã¶kÃ¼ÅŸ, intikam iÅŸlemi, FOMO gibi tepkisel davranÄ±ÅŸlarÄ± bastÄ±rÄ±r.

ModÃ¼ller:

emotionTriggeredDefence.js

pauseRecommendationEngine.js

compensatoryRiskSpike.js

macroDefenceTrigger.js

fiatDrivenEmotionalFilter.js

volatilityDefenceTrigger.js

signalTrustLimiter.js

contextAwareMoralLimiter.js (Ã¶neriyle geldi)

reactiveDefenseGate.js (Ã¶neriyle geldi)

ğŸ“‰ [3] Risk YÃ¶netimi ve Pozisyon Dengeleyiciler
Pozisyon bÃ¼yÃ¼klÃ¼ÄŸÃ¼, iÅŸlem sÄ±klÄ±ÄŸÄ±, risk/margin gibi metrikleri duygusal duruma gÃ¶re sÄ±nÄ±rlar.

ModÃ¼ller:

riskTrustBalancer.js

btcMismatchDefender.js

positionSizeLimiter.js

emotionalCooldownTimer.js

behavioralAnchorReset.js (Ã¶neriyle geldi)

emotionalRecoveryMonitor.js (Ã¶neriyle geldi)

ğŸ¤ [4] Ã‡apraz Sistem EÅŸleÅŸmeleri / Geri Bildirimciler
VIVO, OtobilinÃ§ ve Denetim AsistanÄ± ile etkileÅŸim kurar, duygusal durumlara gÃ¶re sistemleri yÃ¶nlendirir.

ModÃ¼ller:

crossBiasClusterTracker.js

identityConflictResolver.js

collectiveBiasFilter.js (VIVO ile ortak)

structuralBehaviorMonitor.js

empathyDrivenCooldownPlanner.js (Ã¶neriyle geldi)

ğŸ” VERÄ° AKIÅI
ğŸ“¥ Veri AlÄ±r:
Sistem	Veri	KullanÄ±lan ModÃ¼ller
OtobilinÃ§	Bias, zihinsel yorgunluk, davranÄ±ÅŸ Ã¶rÃ¼ntÃ¼leri	adaptiveBiasShield, crossBiasClusterTracker, compensatoryRiskSpike
VIVO	Sinyal frekansÄ±, varyant tipi	pauseRecommendationEngine, signalTrustLimiter, confidenceLimiter
Grafik Beyni	Trend, volatilite, hacim spike, BTC yÃ¶nÃ¼	macroDefenceTrigger, volatilityDefenceTrigger, btcMismatchDefender, fomoSpikeDefender
Denetim AsistanÄ±	Bias tÃ¼rÃ¼, SL sonrasÄ± tepki serisi	framingEffectNormalizer, identityConflictResolver, rationalizationBlocker

ğŸ“¤ Veri GÃ¶nderir:
Sistem	GÃ¶nderdiÄŸi Veri	Hedef
VIVO	Sinyal baskÄ± gerekliliÄŸi, geÃ§ici bloklama	confidenceLimiter, pauseRecommendationEngine
OtobilinÃ§	GÃ¶zlemlenen yeni davranÄ±ÅŸ kalÄ±plarÄ±	crossBiasClusterTracker, identityConflictResolver
Denetim AsistanÄ±	DavranÄ±ÅŸ etiketleme, iÅŸlem engelleme gerekÃ§esi	rationalizationBlocker, contextAwareMoralLimiter

ğŸ§  SÄ°STEM PRENSÄ°PLERÄ°
LIVIA, bir â€œduygusal geÃ§itâ€ gibidir â†’ sistemden Ã§Ä±kan her sinyal buradan geÃ§meden pozisyona dÃ¶nÃ¼ÅŸemez.

Bireysel karar deÄŸil â†’ durumsal, baÄŸlamsal, davranÄ±ÅŸsal filtreleme yapar.

Sistem gerektiÄŸinde sadece durdurmaz, geri bildirim sunar, â€œneden bastÄ±rdÄ±m?â€ diye aÃ§Ä±klar.

ğŸ’» KODLAMA YAPISI
Her modÃ¼l async yapÄ±dadÄ±r

GiriÅŸ: duygusalDurum, sinyalTipi, iÅŸlemGeÃ§miÅŸi, ortamVerisi

Ã‡Ä±kÄ±ÅŸ:

json
Kopyala
DÃ¼zenle
{
  "iÅŸlemEngeli": true,
  "sebep": "AÅŸÄ±rÄ± gÃ¼ven sonrasÄ± hacim artÄ±ÅŸÄ±",
  "Ã¶neri": "30 dk mola",
  "etkilenenSinyaller": ["longRSI", "comboBreak"]
}
ğŸ› ï¸ KODLAMA TAVSÄ°YELERÄ°
Her modÃ¼l bir davranÄ±ÅŸsal Ã¶nyargÄ±ya net baÄŸlanmalÄ±.

Sadece iÅŸlem durdurmak deÄŸil, neden durdurduÄŸunu aÃ§Ä±klayacak detay vermeli.

UyarÄ± sistemleri diÄŸer yapay zeka katmanlarÄ±na uygun formatta veri gÃ¶ndermeli.
______________________________________________________________________________________________
LIVIA-01 Â· operatorDialogOrchestrator.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: OperatÃ¶re tek, baÄŸlamlÄ± â€œÃ¶neri kartÄ±â€ gÃ¶stermek; gerekli ek sorularÄ± tetiklemek; onay/retâ€™i toplayÄ±p imzalÄ± nihai karara Ã§evirmek. VIVO, PortfÃ¶y, Sentry/Guard ve Policy sinyallerini harmanlar. Kod yazdÄ±rmÄ±yoruz; diÄŸer yapay zekÃ¢ bu promptla Node.js + TypeScript servisini yazacak.

1) Kapsam & Ä°lkeler

Event-driven Ã§ekirdek, tÃ¼m I/O JSON. TÃ¼m timestampâ€™ler ISO-8601, Europe/Istanbul.

Zod ile giriÅŸ/Ã§Ä±kÄ±ÅŸ doÄŸrulama. Idempotent yayÄ±n (aynÄ± promptId tekrarlanmaz).

Audit alanÄ± her Out eventâ€™te zorunlu. Telemetry: dialog.metrics, Alert: dialog.alert.

Dil: OperatÃ¶r mesajlarÄ± TÃ¼rkÃ§e (TR), kÄ±sa, madde iÅŸaretli; 500 karakter sÄ±nÄ±rÄ± varsayÄ±lan.

GÃ¼venlik: OperatÃ¶r yanÄ±tÄ± (inbound) iÃ§in HMAC veya imzalÄ± token doÄŸrulamasÄ± (gateway/bridge katmanÄ±yla, bu modÃ¼lde doÄŸrulama Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±r).

2) Girdiler (In) â€” Åemalar (Zodâ€™a Ã§evrilecek)
{
  "composition.playbook.choice": {
    "event": "composition.playbook.choice",
    "timestamp": "iso8601",
    "symbol": "AVAXUSDT",
    "timeframe": "M5",
    "playbookId": "pb-12",
    "variant": "base|aggressive|conservative",
    "exec": "market|limit|twap|iceberg",
    "params": { "offsetBps": 3 },
    "constraints": { "postOnly": false },
    "reasonCodes": ["highVol","trend"]
  },
  "position.size.suggestion": {
    "event": "position.size.suggestion",
    "timestamp": "iso8601",
    "correlationId": "run-42:avax-m5",
    "symbol": "AVAXUSDT",
    "riskUnitUSD": 250,
    "qty": 123.45,
    "maxNotional": 5000,
    "reasonCodes": ["sl=45bps","riskPerTrade=0.5%"]
  },
  "variant.suggestion": {
    "event": "variant.suggestion",
    "timestamp": "iso8601",
    "suggested": "base|aggressive|conservative",
    "confidence0to1": 0.78,
    "reasons": ["strongEdge","lowDD"]
  },
  "signal.variant.tuned": {
    "event": "signal.variant.tuned",
    "timestamp": "iso8601",
    "base": "base",
    "adjusted": "conservative",
    "reasonCodes": ["overconfidence"]
  },
  "operator.consistency.score": {
    "event": "operator.consistency.score",
    "timestamp": "iso8601",
    "score0to1": 0.62,
    "horizonDays": 30,
    "strengthTags": ["steady"],
    "explanations": ["disciplineâ†‘","latency ok"]
  },
  "livia.bias.weights": {
    "event": "livia.bias.weights",
    "timestamp": "iso8601",
    "overconfidence": 0.3,
    "lossAversion": 0.5,
    "riskSeeking": 0.2,
    "notes": []
  },
  "sentry.guard.directive": {
    "event": "sentry.guard.directive",
    "timestamp": "iso8601",
    "mode": "normal|degraded|streams_panic|halt_entry",
    "expiresAt": "iso8601",
    "reasonCodes": ["ping_p99_hi"]
  },
  "latency_slip.guard.directive": {
    "event": "latency_slip.guard.directive",
    "timestamp": "iso8601",
    "mode": "normal|slowdown|block_aggressive|halt_entry",
    "expiresAt": "iso8601",
    "reasonCodes": ["slip_p95_>15bps"]
  },
  "policy.snapshot": {
    "event": "policy.snapshot",
    "timestamp": "iso8601",
    "variants": { "aggressive": true, "conservative": true },
    "limits": { "maxSlipBps": 15, "maxSpreadBps": 80, "minRR": 1.2 }
  },
  "qa.tags": {
    "event": "qa.tags",
    "timestamp": "iso8601",
    "tags": ["highVol","open-bar"]
  },
  "operator.response.in": {
    "event": "operator.response.in",
    "timestamp": "iso8601",
    "promptId": "dlg-avax-42",
    "decisionId": "opt-1|opt-2|custom",
    "payload": { "note": "limit +2bps uygundur" },
    "auth": { "sig": "hex", "userId": "op-007" }
  }
}

3) Ã‡Ä±ktÄ±lar (Out) â€” Åemalar
{
  "operator.prompt.out": {
    "event": "operator.prompt.out",
    "timestamp": "iso8601",
    "promptId": "dlg-avax-42",
    "title": "AVAXUSDT â€” Base/TWAP Ã¶nerisi",
    "body": "Varyant: Base â†’ Conservative Ã¶neri. Qtyâ‰ˆ123.45; SL 45bps; QA: highVol. Devam?",
    "options": [
      {"id":"opt-1","label":"Uygula","actionHint":"commit_plan"},
      {"id":"opt-2","label":"MiktarÄ± %25 azalt","actionHint":"revise_qty"},
      {"id":"opt-3","label":"Ä°ptal","actionHint":"abort"}
    ],
    "context": {
      "symbol":"AVAXUSDT","variant":"base","tuned":"conservative",
      "exec":"twap","qty":123.45,"riskUnitUSD":250,"guard":"slowdown"
    },
    "expiresAt": "iso8601",
    "audit": { "eventId":"...", "producedBy":"livia-01", "producedAt":"iso8601" }
  },
  "operator.decision.final": {
    "event": "operator.decision.final",
    "timestamp": "iso8601",
    "promptId": "dlg-avax-42",
    "decisionId": "opt-1|opt-2|custom",
    "accepted": true,
    "rationale": "TWAP uygula; qty %25 azalt",
    "ttlSec": 120,
    "context": { "correlationId": "run-42:avax-m5", "symbol": "AVAXUSDT" },
    "audit": { "eventId":"...", "producedBy":"livia-01", "producedAt":"iso8601" }
  },
  "dialog.metrics": {
    "event":"dialog.metrics",
    "timestamp":"iso8601",
    "openPrompts": 1,
    "avgDecisionSec": 37,
    "acceptRate": 0.74,
    "fallbacks": 2,
    "byMode": {"normal":0.8,"slowdown":0.6,"halt_entry":0.0}
  },
  "dialog.alert": {
    "event":"dialog.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"timeout â†’ conservative fallback",
    "context":{"promptId":"dlg-avax-42","reasonCodes":["timeout","guard=slowdown"]}
  }
}

4) Konfig (varsayÄ±lanlar)
{
  style: { maxChars: 500, bullets: true, showReasons: true },
  rules: {
    requireConfirmFor: ["aggressive","halt_entry","failover"],
    minScoreForSelfApprove: 0.70,          // skorâ‰¥0.70 ise dÃ¼ÅŸÃ¼k riskte otomatik onay (policy izin verirse)
    blockIfGuard: ["halt_entry"]           // guard=halt_entry iken yeni giriÅŸ onayÄ± yok
  },
  timeouts: { promptSec: 90, idleCloseSec: 300 },
  i18n: { locale: "tr-TR", tz: "Europe/Istanbul" },
  security: { verifyOperatorAuth: true, hmacHeader: "X-Signature" },
  idempotencyTtlSec: 300
}

5) Durum YÃ¶netimi

DialogState (in-memory + opsiyonel persist data/dialog.state.json):

openPrompts: Map<promptId, {...context, expiresAt, idemKey}>

lastDecisionByCorrelationId: Map<cid, decision>

stats: { opens, accepts, rejects, timeouts }

Idempotency: promptId tekil; aynÄ± promptId iÃ§in ikinci operator.prompt.out engellenir.

6) AkÄ±ÅŸ (FSM) â€“ Karar MantÄ±ÄŸÄ±

Girdi geldiÄŸinde advance(state, event, cfg, now) â†’ emissions[]:

BaÄŸlam Toplama

Son composition.playbook.choice, position.size.suggestion, variant.suggestion/signal.variant.tuned, guard/policy/qa â†’ tek bir Ã¶neri kartÄ±na indir.

policy.variants.aggressive=false ise agresif Ã¶neriyi dÃ¼ÅŸÃ¼r (conservativeâ€™a).

latency_slip.guard.directive.mode en kÄ±sÄ±tlayÄ±cÄ± modu belirler (halt_entry > block_aggressive > slowdown > normal).

Onay Gerekli mi?

rules.requireConfirmFor ve guard/policy/variant durumlarÄ±na bak.

operator.consistency.score â‰¥ minScoreForSelfApprove ve risk dÃ¼ÅŸÃ¼kse; ve policy izinliyse â†’ self-approve (otomatik accepted=true).

Aksi halde operator.prompt.out Ã¼ret.

Prompt Ãœretimi

title: SYMBOL â€” Variant/Exec

body: 3â€“5 madde: Varyant, Qty, SL/TP/SLip, Guard, Nedenler.

options: Uygula, MiktarÄ± %25 azalt, Ä°ptal.

expiresAt = now + promptSec.

YanÄ±t Ä°ÅŸleme (operator.response.in)

Auth doÄŸrula (security.verifyOperatorAuth).

expiresAt geÃ§tiyse â†’ dialog.alert(warn, "expired") + fallback.

decisionId:

opt-1: accepted=true.

opt-2: qty = qty * 0.75, accepted=true, rationale notu ekle.

opt-3: accepted=false.

custom: payload.note â†’ rationale.

SonuÃ§: operator.decision.final (TTL=120s).

Timeout/Fallback

SÃ¼re dolarsa conservative fallback (varsa variant="conservative", exec="limit", qtyâ†“%25).

dialog.alert(info, "timeout â†’ fallback").

Telemetri

dialog.metrics per 30 sn: openPrompts, avgDecisionSec, acceptRate, byMode.

7) OperatÃ¶re GÃ¶sterilecek Metin ÅablonlarÄ± (TR)

Ã–neri KartÄ± (body)

â€¢ Varyant: ${base} â†’ ${tuned}

â€¢ YÃ¼rÃ¼tme: ${exec} (${params})

â€¢ Miktar: ~${qty} (${riskUnitUSD} USD risk)

â€¢ QA/Guard: ${qa.join(", ")} / ${guardMode}

â€¢ Nedenler: ${reasonCodes.slice(0,3).join(", ")}

SeÃ§enek Etiketleri

Uygula, MiktarÄ± %25 azalt, Ä°ptal

Ek Notlar (gerekirse)

YÃ¼ksek volatilite algÄ±landÄ±; TWAP/limit tavsiye ediliyor.

Guard: slowdown â€” agresif giriÅŸler geÃ§ici olarak kÄ±sÄ±tlÄ±.

8) Kenar Durumlar & Ã‡akÄ±ÅŸmalar

guard=halt_entry â†’ yeni giriÅŸ iÃ§in onay verilmez; sadece â€œÄ°ptalâ€ sun.

policy.aggressive=false ve variant.suggestion=aggressive â†’ otomatik conservative.

AynÄ± correlationId iÃ§in ardÄ±ÅŸÄ±k prompt Ã¼retilmez (idempotent).

operator.consistency.score < 0.4 â†’ otomatik MiktarÄ± %25 azaltÄ± varsayÄ±lan Ã¶neri olarak Ã¶ne Ã§Ä±kar.

qa.tags open-bar ise exec="limit" Ã¶nceliklendir.

9) Entegrasyon NoktalarÄ±

LIVIA-02 (Guard Question): Promptâ€™tan Ã¶nce â€œkritik senaryoâ€ysa soru tetiklemek iÃ§in operator.decision.context yayÄ±nla; dÃ¶nen guard.question.result.ok=false ise operator.prompt.out yerine uyarÄ±.

LIVIA-04 (Confirmation Bounds): operator.decision.context gÃ¶nder; ihlal varsa dÃ¼zeltme Ã¶nerisi ile tekrar prompt.

LIVIA-05 (Approval Gateway): operator.decision.final â†’ dual-control gerekiyorsa oradan onay Ã§Ä±kar.

VIVO-19/Composer: operator.decision.final(accepted=true) â†’ â€œcommit planâ€ sinyali Ã¼retmeleri iÃ§in baÄŸlanÄ±r (bu modÃ¼l sadece kararÄ± yayar).

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/operatorDialogOrchestrator.ts
services/livia/state/dialogStore.ts
services/livia/lib/promptFormat.ts
services/livia/lib/authVerify.ts
services/livia/lib/contextBuilder.ts
services/livia/__tests__/operatorDialogOrchestrator.test.ts
cfg/livia.operatorDialog.yaml

11) Test Ä°skeleti (Jest/Vitest)

Onay Zorunlu: variant=aggressive + policy.aggressive=true + guard=normal â†’ operator.prompt.out Ã¼retilir.

Self-Approve: scoreâ‰¥0.70, risk dÃ¼ÅŸÃ¼k â†’ operator.decision.final(accepted=true) prompt olmadan.

Guard KÄ±sÄ±tÄ±: guard=halt_entry â†’ yalnÄ±z â€œÄ°ptalâ€ opsiyonu.

Timeout: yanÄ±t yok â†’ conservative fallback ve dialog.alert(timeout).

Idempotency: aynÄ± promptId ile ikinci prompt bastÄ±rÄ±lÄ±r.

Auth: imza yok/yanlÄ±ÅŸ â†’ yanÄ±t reddi + dialog.alert(error,"auth_failed").

12) Ã–rnek Senaryo (KÄ±sa)

composition.playbook.choice(base/twap) + position.size.suggestion(qty=120) + signal.variant.tuned(conservative) + latency_slip.guard=slowdown â†’

Orchestrator baÄŸlamÄ± birleÅŸtirir; onay gerekir â†’

operator.prompt.out(title="AVAX â€” Base/TWAP", options: Uygula/-%25/Ä°ptal)

OperatÃ¶r opt-2 der â†’ operator.decision.final(accepted=true, rationale="qty -%25")

30 sn metrik yayÄ±nÄ±: acceptRate gÃ¼ncellenir.

13) Pseudo-FSM
IDLE
 â””â”€(context_inputs)â†’ READY_TO_PROMPT
READY_TO_PROMPT
 â”œâ”€(self-approve)â†’ DECIDED(accepted)
 â”œâ”€(emit prompt)â†’ AWAIT_RESPONSE
AWAIT_RESPONSE
 â”œâ”€(response ok)â†’ DECIDED(accepted|rejected)
 â”œâ”€(timeout)â†’ DECIDED(fallback_conservative)
DECIDED
 â””â”€(emit operator.decision.final)â†’ IDLE

14) Performans & SLO

FSM p99 < 3 ms; prompt Ã¼retimi p95 < 10 ms.

operator.prompt.out â†’ operator.response.in medyan < 60 sn (izleme metriÄŸi).

Hata oranÄ± (auth/format) < %1.______________________________________________________________________________________________

tamam reis â€” sÄ±rada LIVIA-02 Â· guardQuestionEngine.ts var. AÅŸaÄŸÄ±daki tek blok GeniÅŸ Prompt v3â€™Ã¼ .txt dosyana koyup diÄŸer yapay zekÃ¢ya ver; Node.js + TypeScript servisini bu yÃ¶nergeyle yazsÄ±n. Kod yazdÄ±rmÄ±yoruz; nasÄ±l kodlanacaÄŸÄ±nÄ± yol-prompt olarak tarifliyoruz.

LIVIA-02 Â· guardQuestionEngine.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: Operasyonel risk/ belirsizlik yÃ¼ksekken hedefli, kÄ±sa ve net sorular Ã¼retmek; yanÄ±tlarÄ± doÄŸrulamak, gerektiÄŸinde blok (devam etme) kararÄ± vermek ve LIVIA-01â€™e sonuÃ§ dÃ¶ndÃ¼rmek. Ã–rn: highVol, degraded, failover, aggressive giriÅŸ, bÃ¼yÃ¼k qty, yÃ¼ksek slip/spread vb. durumlarda operatÃ¶rden â€œdevam/iptal/parametreâ€ netliÄŸi alÄ±n.

1) Ä°lkeler (tÃ¼m modÃ¼l iÃ§in)

Event-driven I/O (JSON); tÃ¼m timestampâ€™ler ISO-8601, saat dilimi Europe/Istanbul.

Zod ile giriÅŸ/Ã§Ä±kÄ±ÅŸ doÄŸrulama.

Idempotent yayÄ±n: aynÄ± qId iÃ§in tekrar soru Ã§Ä±karma.

Her Out eventâ€™e audit alanÄ± ekle.

TR kÄ±sa dil: tek ekranda 1â€“2 cÃ¼mle, mÃ¼mkÃ¼nse madde iÅŸaretli.

GÃ¼venlik: operator.answer.in imzasÄ±nÄ± (HMAC/token) doÄŸrulamak iÃ§in authVerify Ã§aÄŸrÄ±sÄ±.

2) Girdiler (In) â€” Åema Ã¶rnekleri (Zodâ€™a Ã§evrilecek)
{
  "operator.decision.context": {
    "event": "operator.decision.context",
    "timestamp": "iso8601",
    "promptId": "dlg-avax-42",
    "correlationId": "run-42:avax-m5",
    "symbol": "AVAXUSDT",
    "variant": "base|aggressive|conservative",
    "exec": "market|limit|twap|iceberg",
    "qty": 123.45,
    "riskUnitUSD": 250,
    "slBps": 45,
    "tpBps": 70
  },
  "sentry.guard.directive": {
    "event": "sentry.guard.directive",
    "timestamp": "iso8601",
    "mode": "normal|degraded|streams_panic|halt_entry",
    "expiresAt": "iso8601",
    "reasonCodes": ["gap>2s"]
  },
  "latency_slip.guard.directive": {
    "event": "latency_slip.guard.directive",
    "timestamp": "iso8601",
    "mode": "normal|slowdown|block_aggressive|halt_entry",
    "expiresAt": "iso8601",
    "reasonCodes": ["slip_p95>15bps"]
  },
  "market.volatility.snapshot": {
    "event":"market.volatility.snapshot",
    "timestamp":"iso8601",
    "symbol":"AVAXUSDT",
    "atrBps": 120,
    "spreadBps": 85
  },
  "portfolio.correlation.snapshot": {
    "event":"portfolio.correlation.snapshot",
    "timestamp":"iso8601",
    "topPairs":[{"a":"AVAXUSDT","b":"SOLUSDT","rho":0.91}],
    "clusters":{"Layer1":{"capUtil":1.08}}
  },
  "operator.consistency.score": {
    "event":"operator.consistency.score",
    "timestamp":"iso8601",
    "score0to1":0.38,
    "horizonDays":30
  },
  "livia.bias.weights": {
    "event":"livia.bias.weights",
    "timestamp":"iso8601",
    "overconfidence":0.72,
    "lossAversion":0.40,
    "riskSeeking":0.55
  },
  "policy.snapshot": {
    "event":"policy.snapshot",
    "timestamp":"iso8601",
    "variants":{"aggressive":true,"conservative":true},
    "limits":{"maxSlipBps":15,"maxSpreadBps":80,"minRR":1.2,"maxQtyUSD":25000},
    "criticalRequiresConfirm":["aggressive","failover","halt_entry_override"]
  },
  "qa.tags": {
    "event":"qa.tags",
    "timestamp":"iso8601",
    "tags":["highVol","open-bar"]
  },
  "operator.answer.in": {
    "event":"operator.answer.in",
    "timestamp":"iso8601",
    "qId":"q-avax-42-1",
    "answer":"yes|no|value|option",
    "value": 12,
    "unit":"bps|qty|bool|null",
    "auth":{"sig":"hex","userId":"op-007"}
  }
}

3) Ã‡Ä±ktÄ±lar (Out) â€” Åema Ã¶rnekleri
{
  "operator.question.out": {
    "event":"operator.question.out",
    "timestamp":"iso8601",
    "qId":"q-avax-42-1",
    "promptId":"dlg-avax-42",
    "title":"YÃ¼ksek slip riski",
    "text":"Slip p95 ~18 bps. Devam iÃ§in slip toleransÄ±nÄ± onaylÄ±yor musun?",
    "kind":"confirm|numerical|choice",
    "expected":"yes|no|value|option",
    "constraints":{"min":0,"max":20,"step":1,"unit":"bps"},
    "options":[{"id":"ok","label":"Evet"},{"id":"no","label":"HayÄ±r"}],
    "ttlSec":90,
    "context":{"symbol":"AVAXUSDT","mode":"slowdown","atrBps":120,"spreadBps":85},
    "audit":{"eventId":"...","producedBy":"livia-02","producedAt":"iso8601"}
  },
  "guard.question.result": {
    "event":"guard.question.result",
    "timestamp":"iso8601",
    "qId":"q-avax-42-1",
    "promptId":"dlg-avax-42",
    "ok": false,
    "reasons":["slip_tolerance_exceeded"],
    "recommendation":{"action":"block|revise|proceed","params":{"qtyFactor":0.75,"exec":"limit"}},
    "audit":{"eventId":"...","producedBy":"livia-02","producedAt":"iso8601"}
  },
  "guard.question.metrics": {
    "event":"guard.question.metrics",
    "timestamp":"iso8601",
    "asked":1,
    "answered":1,
    "okRate":0.62,
    "avgAnswerSec":28,
    "blocked":0.38,
    "byKind":{"confirm":0.7,"numerical":0.5,"choice":0.65}
  },
  "guard.question.alert": {
    "event":"guard.question.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"answer invalid (out of range)",
    "context":{"qId":"q-avax-42-1","value":35,"constraints":{"max":20}}
  }
}

4) Konfig VarsayÄ±lanlarÄ±
{
  i18n: { locale: "tr-TR", tz: "Europe/Istanbul" },

  // Belirsizlik puanÄ± Uâˆˆ[0,1] iÃ§in katsayÄ±lar
  scoring: {
    weights: {
      guardMode: 0.25,      // normal<slowdown<block_aggressive<halt_entry
      vol: 0.20,            // atr/spread yÃ¼ksekse
      slipRisk: 0.20,       // slip_p95 tahmini / policy.maxSlip
      operatorScore: 0.15,  // dÃ¼ÅŸÃ¼k skor = daha Ã§ok soru
      bias: 0.10,           // overconfidence, riskSeeking
      correlation: 0.10     // rho, capUtil aÅŸÄ±mÄ±
    },
    askThreshold: 0.40,     // Uâ‰¥0.40 â†’ en az 1 soru
    hardBlockThreshold: 0.85// Uâ‰¥0.85 â†’ blok Ã¶ner (cevap beklemeden)
  },

  // Soru Playbookâ€™larÄ± (eÅŸleÅŸme â†’ ÅŸablon)
  playbooks: {
    highVol: [
      { kind:"confirm",  text:"Volatilite yÃ¼ksek. Agresif giriÅŸi geÃ§ici olarak devre dÄ±ÅŸÄ± bÄ±rakmayÄ± kabul ediyor musun?", expect:"yes" },
      { kind:"choice",   text:"YÃ¼rÃ¼tme tarzÄ±nÄ± seÃ§: TWAP mÄ± LIMIT mi?", expect:"option", options:["twap","limit"] }
    ],
    slipRisk: [
      { kind:"numerical", text:"Slip toleransÄ±nÄ± bps cinsinden belirt (0â€“20).", expect:"value", constraints:{min:0,max:20,step:1,unit:"bps"} }
    ],
    spreadWide: [
      { kind:"confirm",  text:"Spread geniÅŸ (~${spreadBps} bps). Devam etmek iÃ§in LIMIT kullanmayÄ± kabul ediyor musun?", expect:"yes" }
    ],
    failover: [
      { kind:"confirm",  text:"BaÄŸlantÄ± bozuk (degraded). Failover Ã¶nerisini onaylÄ±yor musun?", expect:"yes" }
    ],
    aggressive: [
      { kind:"confirm",  text:"Agresif varyant seÃ§ildi. OnaylÄ±yor musun?", expect:"yes" }
    ],
    qtyHigh: [
      { kind:"choice",   text:"MiktarÄ± azaltalÄ±m mÄ±?", expect:"option", options:["-25%","-50%","HayÄ±r"] }
    ]
  },

  rules: {
    blockOnNo: ["failover","aggressive"], // bu tip sorularda "hayÄ±r" â†’ ok=false
    numericalBounds: {
      slipBps: { min: 0, max: 20 },
      spreadBps: { min: 0, max: 120 },
      qtyFactor: { min: 0.25, max: 1.0 }
    }
  },

  ttlSec: 90,
  idempotencyTtlSec: 300
}

5) Belirsizlik PuanÄ± (U) â€” Hesap & Soru SeÃ§imi

Normalize girdiler:

guardModeScore: normal=0.0, slowdown=0.4, block_aggressive=0.7, halt_entry=1.0

volScore: min(1, (atrBps/100 + spreadBps/80)/2)

slipRiskScore: min(1, slip_p95_est / policy.maxSlipBps) (yoksa latency_slip.guardâ€™dan tÃ¼ret)

operatorScoreAdj: 1 - operator.consistency.score0to1

biasScore: orthonormalize(overconfidence, riskSeeking) ortalamasÄ±

corrScore: max(0, (rhoTop - 0.85)/0.15, capUtil-1) (0..1)

U = dot(weights, components)

Soru seÃ§imi:

Uâ‰¥hardBlockThreshold â†’ guard.question.result(ok=false, reason: "hard_block"), recommendation:{action:"block"}.

Aksi halde playbook eÅŸleÅŸmeleri:

EÄŸer latency_slip.guard in {slowdown, block_aggressive} â†’ slipRisk sorularÄ±.

spreadBps > policy.maxSpreadBps â†’ spreadWide.

sentry=degraded â†’ failover.

variant=aggressive â†’ aggressive.

qtyUSD = qty * mid yaklaÅŸÄ±k > maxQtyUSDâ€™nin %80â€™ini aÅŸÄ±yorsa â†’ qtyHigh.

qa.tags highVol|open-bar â†’ highVol.

Ã–ncelik sÄ±rasÄ±: guard > failover > spread > slip > aggressive > qty > highVol.

AynÄ± anda Ã§ok soru: en fazla 2 soruyu sÄ±raya koy (operatÃ¶r yÃ¼kÃ¼nÃ¼ dÃ¼ÅŸÃ¼k tut).

6) AkÄ±ÅŸ (FSM) â€” advance(state, event, cfg, now) â†’ emissions[]

Durumlar:

IDLE

READY (sorular planlandÄ±)

AWAIT_ANSWER (tek aktif soru)

DECIDED (ok / block / revise / proceed)

GeÃ§iÅŸler:

Context & guard girdileri â†’ computeU & planQuestions() â†’

Uâ‰¥hardBlock â†’ DECIDED(ok=false, action=block)

Yoksa ilk soruyu Ã¼ret â†’ operator.question.out â†’ AWAIT_ANSWER.

operator.answer.in geldi:

authVerify â†’ baÅŸarÄ±sÄ±z ise guard.question.alert(error,"auth_failed") + tekrar bekle.

SÄ±nÄ±r/kÄ±sÄ±t kontrolÃ¼ (Zod & constraints):

GeÃ§ersiz: guard.question.alert(warn,"invalid_answer"), tekrar sor.

GeÃ§erli: scoreAnswer() ve applyRule():

confirm: yes â†’ ok; no â†’ blockOnNo kapsamÄ±ndaysa ok=false, deÄŸilse revise (Ã¶rn. qtyâ†“).

numerical: aralÄ±kta ise (slipBps<=max) â†’ ok; deÄŸilse revise (Ã¶rn. exec="limit", qtyFactor).

choice: mapping tablosu (-25% â†’ qtyFactor=0.75).

Sonuca gÃ¶re:

ok=false â†’ guard.question.result(ok=false, recommendation:{action:"block"}).

ok=true ama dÃ¼zeltme gerekiyorsa â†’ recommendation:{action:"revise", params:{...}}.

ok=true ve dÃ¼zeltmesiz â†’ recommendation:{action:"proceed"}.

SÄ±rada soru varsa â†’ yeni operator.question.out, durum AWAIT_ANSWER.

Soru bitince â†’ DECIDED.

Timeout (ttl dolarsa):

VarsayÄ±lan: ok=false ve recommendation:{action:"block"} (operatÃ¶r sessizse blok).

Not: SonuÃ§, LIVIA-01 tarafÄ±ndan tÃ¼ketilir; orada operator.prompt.out/operator.decision.final akÄ±ÅŸÄ± tamamlanÄ±r.

7) Kenar Durumlar

sentry.mode="halt_entry" ise soru yerine direkt ok=false + block Ã¶ner (yeni giriÅŸ yasak).

policy.variants.aggressive=false + variant=aggressive ise aggressive sorusu atlanÄ±r (zaten yasak).

AynÄ± promptId iÃ§in aktif bir qId varsa yeni soru Ã¼retme (idempotency).

Bir cevap ardÄ±ÅŸÄ±k iki kere aynÄ± ise (tekrar tÄ±klama) â†’ yut.

qtyHigh sorusunda â€œHayÄ±râ€ cevabÄ± verilirse â†’ ok=false deÄŸil, recommendation:{action:"proceed"} (sadece Ã¶neriydi).

spreadWide sorusunda hayÄ±r â†’ revise: exec="limit" zorunlu tavsiye.

8) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/guardQuestionEngine.ts          // FSM + event handlers
services/livia/state/gqeStore.ts               // openQuestions, stats, idem index
services/livia/lib/gqeScoring.ts               // U hesaplama
services/livia/lib/gqePlaybook.ts              // kural tabanÄ± + ÅŸablonlar
services/livia/lib/answerValidate.ts           // Zod + constraints
services/livia/lib/authVerify.ts               // HMAC/JWT doÄŸrulama
services/livia/__tests__/guardQuestionEngine.test.ts
cfg/livia.guardQuestions.yaml                  // playbook ve eÅŸik overrides

9) Test Ä°skeleti (Jest/Vitest)

U HesabÄ±

guard=block_aggressive, atrBps=130, spread=90, operatorScore=0.3 â†’ Uâ‰¥0.7 (soru Ã§Ä±kar).

guard=normal, vol dÃ¼ÅŸÃ¼k, operatorScore=0.9 â†’ Uâ‰¤0.3 (soru yok).

Failover

sentry=degraded â†’ failover confirm sorusu; â€œhayÄ±râ€ â†’ ok=false, block.

Slip

slip numerical: cevap 18 bps, policy.maxSlip=15 â†’ revise (exec=limit).

Spread

spread 100 bps â†’ confirm â€œLIMITâ€™e geÃ§â€ sorusu; â€œevetâ€ â†’ ok=true, proceed.

Aggressive

variant=aggressive, policy.aggressive=true â†’ confirm sor; â€œevetâ€ â†’ proceed; â€œhayÄ±râ€ â†’ block.

Qty High

qtyUSD â‰ˆ maxQtyUSD * 0.9 â†’ choice -25% â†’ revise (qtyFactor=0.75).

Timeout & Auth

cevap sÃ¼re aÅŸÄ±mÄ± â†’ ok=false, block.

imza hatalÄ± â†’ guard.question.alert(error,"auth_failed").

Idempotency

aynÄ± qId ile ikinci operator.question.out yayÄ±nlanmaz.

10) Ã–rnek Ã‡alÄ±ÅŸma (kÄ±sa)

Girdiler:

operator.decision.context(AVAX base/twap qty=123)

latency_slip.guard=slowdown, market.volatility(atr=120, spread=85), operator.score=0.38, bias.overconfidence=0.72

U â‰ˆ 0.68 â†’ soru ÅŸart.

operator.question.out(kind="numerical", text="Slip toleransÄ± (0â€“20 bps)?")

OperatÃ¶r value=18 dÃ¶ner â†’ revise: exec="limit", qtyFactor=0.75 Ã¶ner; guard.question.result(ok=true, action="revise").

Ä°kinci soru: failover confirm (sentry=degraded). Cevap: evet â†’ proceed.

SonuÃ§ seti LIVIA-01â€™e dÃ¶ner; Orchestrator promptu buna gÃ¶re gÃ¼nceller.

11) Performans & SLO

Soru planlama p99 < 3 ms; cevap iÅŸleme p99 < 2 ms.

Sorudan cevaba medyan < 60 sn (telemetriyle izleyin).

HatalÄ±/eksik cevap oranÄ± < %2 (Zod + constraints).

Timeoutâ€™larÄ±n %90+â€™Ä± guard=slowdown/block_aggressive dÃ¶nemlerine denk gelmeli (doÄŸru tetikleme).

12) Telemetri & Alert

guard.question.metrics per 30 sn: asked, answered, okRate, blocked, avgAnswerSec, byKind.

guard.question.alert seviyeleri:

warn: invalid_answer, ttl_expired

error: auth_failed, internal_failure

13) Entegrasyon (Ã¶zet)

LIVIA-01: operator.decision.context ile tetikler; guard.question.result sonucuna gÃ¶re operator.prompt.out/operator.decision.final akÄ±ÅŸÄ±nÄ± ÅŸekillendirir.

LIVIA-04: numerical cevaplar (slip/spread/qtyFactor) bounds doÄŸrulamasÄ±na gider; ihlal varsa yeni dÃ¼zeltme dÃ¶ner.

SENTRY/SG: mod/sebep kodlarÄ± belirsizlik skoruna girer; failover sorularÄ± sentry=degraded/panicâ€™te Ã§Ä±kar.

PORTFÃ–Y/PFL: qty revizyonu Ã¶nerileri Composerâ€™a yansÄ±r (revise).
______________________________________________________________________________________________

tamam reis â€” sÄ±rada LIVIA-03 Â· biasAwarenessMonitor.ts. AÅŸaÄŸÄ±daki tek blok GeniÅŸ Prompt v3â€™Ã¼ .txt dosyana koyup diÄŸer yapay zekÃ¢ya ver; Node.js + TypeScript servisini bu yÃ¶nergeyle yazsÄ±n. Kod yazdÄ±rmÄ±yoruz; nasÄ±l kodlanacaÄŸÄ±nÄ± yol-prompt olarak tarifliyoruz.

LIVIA-03 Â· biasAwarenessMonitor.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: OperatÃ¶r davranÄ±ÅŸÄ±ndan Ã¼Ã§ temel yanlÄ±lÄ±ÄŸÄ± ( overconfidence, loss aversion, risk seeking ) sayÄ±sal olarak tahmin edip 0..1 arasÄ±nda aÄŸÄ±rlÄ±klar Ã¼retmek; sonuÃ§larÄ± aÃ§Ä±klama, uyarÄ± ve telemetriyle birlikte LIVIA-01/02/04 ve VIVO-42 biasWeightedSignalTuner iÃ§in yayÄ±nlamak.

1) Ä°lkeler

Event-driven I/O (JSON), ISO-8601, Europe/Istanbul.

Zod ile tÃ¼m giriÅŸ/Ã§Ä±kÄ±ÅŸ doÄŸrulama.

Idempotent yayÄ±n (aynÄ± windowId ve operatorId iÃ§in tekrar yok).

Her Out eventâ€™te audit alanÄ± zorunlu.

Gizlilik etiketi: classification: "SENSITIVE_LOW".

2) Girdiler (In) â€” Åema Ã¶rnekleri (Zodâ€™a Ã§evrilecek)
{
  "operator.choice.log": {
    "event":"operator.choice.log",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "symbol":"AVAXUSDT",
    "variant":"base|aggressive|conservative",
    "exec":"market|limit|twap|iceberg",
    "overrides":{"qtyFactor":1.2,"slTightenBps":0,"slWidenBps":0,"tpTightenBps":0},
    "context":{"guardMode":"normal|slowdown|block_aggressive|halt_entry","volBps":95,"spreadBps":60}
  },

  "trade.summary.closed": {
    "event":"trade.summary.closed",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "symbol":"AVAXUSDT",
    "entryTs":"iso8601",
    "exitTs":"iso8601",
    "side":"long|short",
    "plannedSL_bps":45,
    "plannedTP_bps":70,
    "realizedR":0.8,
    "exitReason":"tp|sl|timeout|abort|manual_close",
    "maxFavorableExcursion_bps":52,
    "maxAdverseExcursion_bps":38,
    "slAdjustments":{"tighten":0,"widen":0},        // adet
    "tpAdjustments":{"tighten":1,"widen":0},        // adet
    "adds":{"count":1,"totalQtyFactor":1.25},       // DCA/averaging-up/down
    "reentriesWithin24h":0                           // stop sonrasÄ± tekrar giriÅŸ sayÄ±sÄ±
  },

  "operator.consistency.score": {
    "event":"operator.consistency.score",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "score0to1":0.62
  },

  "pnl.daily": {
    "event":"pnl.daily",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "windowId":"2025-09-01_rolling30",
    "equityCurve":[{"ts":"iso8601","equityUSD":12345.6}],
    "sessions":[{"date":"2025-09-01","pnlUSD":120.5}]
  },

  "qa.tags": {
    "event":"qa.tags",
    "timestamp":"iso8601",
    "tags":["highVol","open-bar"]
  }
}

3) Ã‡Ä±ktÄ±lar (Out) â€” Åema Ã¶rnekleri
{
  "livia.bias.weights": {
    "event":"livia.bias.weights",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "overconfidence":0.41,
    "lossAversion":0.63,
    "riskSeeking":0.38,
    "confidence0to1":0.72,
    "notes":[ "overconfidence: re-entryâ†‘, qtyOvershootâ†‘", "lossAversion: holdLoss>holdWin" ],
    "audit":{"eventId":"...","producedBy":"livia-03","producedAt":"iso8601"}
  },

  "livia.bias.explain": {
    "event":"livia.bias.explain",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "window":{"trades":50,"days":30},
    "contributions":{
      "overconfidence":{"reentryRate":0.18,"qtyOvershoot":0.12,"aggrInHighVol":0.07,"earlyTP":0.04},
      "lossAversion":{"lossHoldRatio":0.22,"slWidenRate":0.15,"abortVsSL":0.09},
      "riskSeeking":{"aggressiveRate":0.21,"takerInWideSpread":0.11,"addsAgainstMAE":0.06}
    },
    "scales":{"minSamples":20,"emaAlpha":0.3}
  },

  "bias.alert": {
    "event":"bias.alert",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "level":"info|warn|error",
    "message":"lossAversion high (â‰¥0.70)",
    "context":{"lossAversion":0.74,"windowTrades":52}
  },

  "bias.metrics": {
    "event":"bias.metrics",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "windowTrades":52,
    "overconfidence":0.41,
    "lossAversion":0.63,
    "riskSeeking":0.38,
    "confidence":0.72,
    "updates":1
  }
}

4) Konfig (varsayÄ±lanlar)
{
  window: { trades: 50, minTrades: 20, days: 30 }, // EMA penceresi: son 50 iÅŸlem / 30 gÃ¼n
  emaAlpha: 0.30,          // zamanla yumuÅŸatma (0..1)
  hysteresis: 0.08,        // eÅŸik Ã§evresinde flip-flop engeli
  priors: {                 // veri azsa varsayÄ±lanlar
    overconfidence: 0.50,
    lossAversion: 0.50,
    riskSeeking: 0.50,
    confidence0to1: 0.30
  },
  thresholds: {
    medium: 0.50,
    high: 0.70
  },
  weights: {
    // 0..1 arasÄ± normalize edilmiÅŸ Ã¶zellik aÄŸÄ±rlÄ±klarÄ±
    overconfidence: { reentryRate:0.30, qtyOvershoot:0.25, aggrInHighVol:0.25, earlyTP:0.20 },
    lossAversion:   { lossHoldRatio:0.40, slWidenRate:0.35, abortVsSL:0.25 },
    riskSeeking:    { aggressiveRate:0.35, takerInWideSpread:0.35, addsAgainstMAE:0.30 }
  },
  featureBounds: {
    // normalize fonksiyonlarÄ± iÃ§in alt/Ã¼st sÄ±nÄ±rlar
    reentryRate: [0, 0.35],
    qtyOvershoot: [0, 0.50],        // Ã¶nerilen qty'den sapma (|qty/qtySug-1|)
    aggrInHighVol: [0, 0.60],       // highVol iken aggressive seÃ§imi oranÄ±
    earlyTP: [0, 0.40],             // TP'ye varmadan kÃ¢r alÄ±m oranÄ±
    lossHoldRatio: [0.8, 2.0],      // (avgLossHoldMin / avgWinHoldMin)
    slWidenRate: [0, 0.35],
    abortVsSL: [0, 0.60],           // abort / (abort+sl)
    aggressiveRate: [0, 0.60],
    takerInWideSpread: [0, 0.60],   // spread>maxSpread *katsayÄ±* iken market/taker oranÄ±
    addsAgainstMAE: [0, 0.50]       // MAE gÃ¶rÃ¼lÃ¼rken qty ekleme oranÄ±
  },
  i18n: { locale: "tr-TR", tz: "Europe/Istanbul" },
  idempotencyTtlSec: 600
}

5) Ã–zellik (Feature) HesabÄ± â€” Normalize & Skor

HazÄ±rlÄ±k: son window.trades adet trade.summary.closed ve eÅŸleÅŸen operator.choice.log kayÄ±tlarÄ±nÄ± topla. Eksikse priors ve dÃ¼ÅŸÃ¼k gÃ¼ven dÃ¶ndÃ¼r.

Ã–rnek normalize fonksiyonlarÄ± (0..1):

norm(x; [a,b]) = clamp((x-a)/(b-a), 0, 1)

lossHoldRatio iÃ§in normLossHold = clamp((x-1.0)/(2.0-0.8), 0, 1); 1.0 nÃ¶tr, >1.0 kÃ¶tÃ¼.

qtyOvershoot = |avg(qtyPlaced/qtySuggested - 1)| â†’ [0,0.5].

aggrInHighVol = count(variant='aggressive' & qa.tags includes 'highVol') / count(highVol decisions).

Ã–zellik kÃ¼meleri:

Overconfidence

reentryRate: stop/zarar sonrasÄ± 24h iÃ§inde aynÄ± sembole yeniden giriÅŸ oranÄ±.

qtyOvershoot: Ã¶nerilen boyuttan yukarÄ± sapma ortalamasÄ±.

aggrInHighVol: highVol koÅŸullarÄ±nda aggressive seÃ§imi oranÄ±.

earlyTP: maxFavorableExcursion_bps > plannedTP_bps*0.6 iken tp olmadan manual_close/partial-take oranÄ± (erken sevinÃ§).

Loss Aversion

lossHoldRatio: avgHoldLossMin / avgHoldWinMin.

slWidenRate: SL geniÅŸletme adedi / iÅŸlemler.

abortVsSL: abort Ã§Ä±kÄ±ÅŸlarÄ±nÄ±n abort+sl toplamÄ±na oranÄ± (kuralsÄ±z kaÃ§Ä±ÅŸ).

Risk Seeking

aggressiveRate: aggressive varyant seÃ§imi oranÄ±.

takerInWideSpread: spreadBps > maxSpreadBps*1.0 iken exec='market' veya maker olmayan giriÅŸ oranÄ±.

addsAgainstMAE: MAE gÃ¶rÃ¼rken adds.count>0 olan iÅŸlemler oranÄ±.

BileÅŸik skorlar:

raw_overconfidence = Î£ w_i * norm_i
raw_lossAversion   = Î£ w_i * norm_i
raw_riskSeeking    = Î£ w_i * norm_i


EMA ile yumuÅŸatma:

bias_t = alpha * raw + (1 - alpha) * bias_{t-1}


GÃ¼ven (confidence0to1):

conf = clamp( min(1, trades/minTrades) * (0.5 + 0.5*operatorConsistencyScore) , 0, 1)

Veri yetersizse conf â‰¤ 0.5; arttÄ±kÃ§a 1â€™e yaklaÅŸÄ±r.

Histerezis:

Son yayÄ±nlanan deÄŸerden fark < hysteresis ise yayÄ±nlama; aksi halde yayÄ±nla (gÃ¼rÃ¼ltÃ¼ azaltma).

6) AkÄ±ÅŸ (FSM) â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
operator.choice.log | trade.summary.closed | operator.consistency.score | pnl.daily â†’ buffer gÃ¼ncelle.

READY_TO_COMPUTE
window.trades â‰¥ minTrades olduÄŸunda Ã¶zellikleri hesapla â†’ raw skorlar â†’ EMA â†’ confidence.

EMIT
livia.bias.weights + livia.bias.explain + bias.metrics yayÄ±nla (idempotency: windowId+operatorId).
EÅŸik aÅŸÄ±mÄ± (â‰¥ thresholds.high) â†’ bias.alert(level="warn|error").

7) Kenar Durumlar

minTrades altÄ± â†’ priors dÃ¶ndÃ¼r, confidence dÃ¼ÅŸÃ¼k, bias.alert(info,"insufficient_samples").

operator.consistency.score yoksa 0.5 varsay.

Guard halt_entry dÃ¶nemlerinde elde edilen verileri dahil et, ancak aggressiveRateâ€™i guard ile normalize et (yasaklanmÄ±ÅŸsa cezalandÄ±rma yok).

AÅŸÄ±rÄ± uÃ§ metrikler â†’ winsorize (p1â€“p99).

8) Event Bus

In: operator.choice.log, trade.summary.closed, operator.consistency.score, pnl.daily, qa.tags

Out: livia.bias.weights, livia.bias.explain, bias.alert, bias.metrics

9) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/biasAwarenessMonitor.ts        // FSM + orchestrasyon
services/livia/state/biasStore.ts             // halka buffer + EMA state + lastEmit
services/livia/lib/features.ts                // Ã¶zellik Ã§Ä±karÄ±mÄ± + normalizasyon
services/livia/lib/ema.ts                     // EMA & histerezis
services/livia/lib/contribExplainer.ts        // contribution breakdown
services/livia/__tests__/biasAwarenessMonitor.test.ts
cfg/livia.bias.yaml                           // aÄŸÄ±rlÄ±k/threshold override

10) Test Ä°skeleti (Jest/Vitest)

Veri az: 12 trade â†’ priors + confidence<0.5 + bias.alert(info).

Overconfidence: re-entry 0.25, qtyOvershoot 0.2, highVolâ€™da aggressive 0.5 â†’ overconfidenceâ‰¥0.7 â†’ bias.alert(warn).

Loss Aversion: lossHoldRatio 1.6, slWidenRate 0.25 â†’ lossAversionâ‰¥0.7.

Risk Seeking: wide spread + taker oranÄ± 0.4, addsAgainstMAE 0.3 â†’ riskSeekingâ‰ˆ0.6.

EMA: yeni raw dÃ¼ÅŸse bile Ã¶nceki yÃ¼ksek deÄŸer sebebiyle yumuÅŸar (regresyon).

Histerezis: kÃ¼Ã§Ã¼k oynamalarda yayÄ±n yok; bÃ¼yÃ¼k deÄŸiÅŸimde yayÄ±n var.

Idempotency: aynÄ± windowId+operatorId ile ikinci yayÄ±n bastÄ±rÄ±lÄ±r.

11) Telemetri & SLO

bias.metrics per 60 sn: windowTrades, overconfidence, lossAversion, riskSeeking, confidence, updates.

P99 hesaplama sÃ¼resi < 5 ms (Ã¶zellik Ã§Ä±karÄ±mÄ± hariÃ§).

GÃ¼nlÃ¼k sapma toleransÄ±: bir bias aÄŸÄ±rlÄ±ÄŸÄ±nda gÃ¼n-iÃ§i standart sapma < 0.15 (EMA + histerezis sayesinde).

12) Entegrasyon NotlarÄ±

VIVO-42 biasWeightedSignalTuner doÄŸrudan livia.bias.weights tÃ¼ketir; varyant ayarlarÄ±nÄ± conservative/base/aggressive seÃ§imine Ã§evirir.

LIVIA-01 (Orchestrator) ve LIVIA-02 (Guard Q&A) dil ve soru yoÄŸunluÄŸunu biasâ€™a gÃ¶re ayarlar (overconfidence yÃ¼ksek â†’ daha temkinli dil, ek soru).

LIVIA-04 (Confirmation Bounds) sayÄ±sal sÄ±nÄ±rlarÄ± sÄ±kÄ±laÅŸtÄ±rabilir (Ã¶rn. overconfidenceâ‰¥0.7 ise maxQtyUSDâ€™yi %20 dÃ¼ÅŸÃ¼r).
______________________________________________________________________________________________
LIVIA-04 Â· confirmationBounds.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: OperatÃ¶rÃ¼n onaylamak Ã¼zere olduÄŸu planÄ± sayÄ±sal sÄ±nÄ±rlar aÃ§Ä±sÄ±ndan doÄŸrulamak (slip, spread, RR, miktar, kaldÄ±raÃ§, maruziyet, guard/policy kÄ±sÄ±tlarÄ±). Ä°hlalde blok veya otomatik dÃ¼zeltme Ã¶nerisi Ã¼ret; sonucu LIVIA-01â€™e geri bildir. TÃ¼m I/O JSON, Zod validasyon, Europe/Istanbul, idempotent yayÄ±n, her Out eventâ€™te audit.

1) Ä°lkeler

Event-driven FSM: advance(state, event, cfg, now) â†’ emissions[].

TÃ¼m timestampâ€™ler ISO-8601; sayÄ±lar finite().

Idempotency: aynÄ± checkId iÃ§in ikinci kez yayÄ±n yapma (TTL: idempotencyTtlSec).

TR kÄ±sa dil (operatÃ¶re giden aÃ§Ä±klamalar maks. 2â€“3 cÃ¼mle).

GÃ¼venlik: dÄ±ÅŸ kaynaktan gelen context/cevaplarda HMAC/JWT doÄŸrulamasÄ± helper Ã¼zerinden Ã§aÄŸrÄ± ile yapÄ±lÄ±r (implementation detail diÄŸer modÃ¼llerde).

2) Girdiler (In) â€” Åema Ã–rnekleri (Zodâ€™a Ã§evrilecek)
{
  "operator.decision.context": {
    "event": "operator.decision.context",
    "timestamp": "iso8601",
    "checkId": "dlg-avax-42#v1",
    "correlationId": "run-42:avax-m5",
    "symbol": "AVAXUSDT",
    "side": "long|short",
    "variant": "base|aggressive|conservative",
    "exec": "market|limit|twap|iceberg|post_only",
    "qty": 123.45,
    "mid": 9.87,
    "slBps": 45,
    "tpBps": 70,
    "slices": 1,
    "notes": "operator intent"
  },

  "policy.snapshot": {
    "event": "policy.snapshot",
    "timestamp": "iso8601",
    "variants": { "aggressive": true, "conservative": true },
    "risk": { "riskPerTradePct": 0.5, "totalRiskPct": 1.2, "maxLeverage": 5 },
    "limits": {
      "maxSlipBps": 15,
      "maxSpreadBps": 80,
      "minRR": 1.2,
      "maxQtyUSD": 25000,
      "maxSymbolExposurePct": 1.0,
      "maxClusterExposurePct": 1.5
    }
  },

  "market.refs": {
    "event": "market.refs",
    "timestamp": "iso8601",
    "symbol": "AVAXUSDT",
    "mid": 9.87,
    "spreadBps": 85
  },

  "latency_slip.guard.directive": {
    "event": "latency_slip.guard.directive",
    "timestamp": "iso8601",
    "mode": "normal|slowdown|block_aggressive|halt_entry",
    "expiresAt": "iso8601",
    "reasonCodes": ["slip_p95>15bps"]
  },

  "sentry.guard.directive": {
    "event": "sentry.guard.directive",
    "timestamp": "iso8601",
    "mode": "normal|degraded|streams_panic|halt_entry",
    "expiresAt": "iso8601"
  },

  "cost.forecast.update": {
    "event": "cost.forecast.update",
    "timestamp": "iso8601",
    "symbol": "AVAXUSDT",
    "expectedSlipBps": 18,
    "feeBps": { "taker": 5, "maker": 1.5 }
  },

  "portfolio.exposure": {
    "event": "portfolio.exposure",
    "timestamp": "iso8601",
    "equityUSD": 50000,
    "bySymbol": { "AVAXUSDT": { "notionalUSD": 12000, "cluster": "Layer1" } },
    "byCluster": { "Layer1": { "notionalUSD": 35000 } },
    "totalNotionalUSD": 80000
  }
}


Not: portfolio.exposure yoksa exposure kontrolleri uyarÄ± seviyesinde geÃ§ilir (blok deÄŸil), confidence dÃ¼ÅŸÃ¼rÃ¼lÃ¼r.

3) Ã‡Ä±ktÄ±lar (Out) â€” Åema Ã–rnekleri
{
  "confirmation.bounds.check": {
    "event": "confirmation.bounds.check",
    "timestamp": "iso8601",
    "checkId": "dlg-avax-42#v1",
    "correlationId": "run-42:avax-m5",
    "symbol": "AVAXUSDT",
    "ok": false,
    "severity": "soft|hard",
    "violations": [
      { "code": "spread_gt_max", "got": 85, "limit": 80 },
      { "code": "min_rr_not_met", "got": 1.56, "limit": 1.60 }
    ],
    "derived": {
      "qtyUSD": 1219.72,
      "rr": 1.56,
      "leverageEst": 1.6,
      "expectedSlipBps": 18
    },
    "audit": { "eventId": "...", "producedBy": "livia-04", "producedAt": "iso8601" }
  },

  "confirmation.fix.suggestion": {
    "event": "confirmation.fix.suggestion",
    "timestamp": "iso8601",
    "checkId": "dlg-avax-42#v1",
    "recommendation": {
      "action": "revise",
      "params": {
        "exec": "limit",
        "qtyFactor": 0.75,
        "slTightenBps": 5,
        "tpWidenBps": 5,
        "slices": 3
      }
    },
    "reasonCodes": ["spread_wide_use_limit", "improve_rr", "slowdown_use_slices"],
    "audit": { "eventId": "...", "producedBy": "livia-04", "producedAt": "iso8601" }
  },

  "bounds.alert": {
    "event": "bounds.alert",
    "timestamp": "iso8601",
    "level": "info|warn|error",
    "message": "guard=halt_entry â†’ giriÅŸler kilitli",
    "context": { "symbol": "AVAXUSDT", "checkId": "dlg-avax-42#v1" }
  },

  "bounds.metrics": {
    "event": "bounds.metrics",
    "timestamp": "iso8601",
    "checked": 12,
    "okRate": 0.67,
    "autoReviseRate": 0.25,
    "blockRate": 0.08,
    "topViolations": { "spread_gt_max": 4, "expected_slip_gt_max": 3, "min_rr_not_met": 3 }
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale: "tr-TR", tz: "Europe/Istanbul" },

  // Dinamik sÄ±kÄ±laÅŸtÄ±rma (guard/QA/variant etkisi)
  tighten: {
    onHighVolPct: 0.85,           // highVol â†’ limitlerin %85â€™i
    onDegradedPct: 0.85,          // sentry=degraded
    onBlockAggressivePct: 0.75,   // guard=block_aggressive
    aggressiveRelaxPct: 1.10      // aggressive seÃ§ildiyse (policy izin) minRR *1.10, diÄŸer limitler *0.95 uygulanmaz! (daha zor: RRâ†‘)
  },

  // Hard vs Soft ihlal ayrÄ±mÄ±
  hardCodes: ["guard_halt_entry", "expected_slip_gt_max_x2", "symbol_exposure_gt_cap_x2", "leverage_gt_max"],

  // DÃ¼zeltme Ã¶neri matrisi (violation â†’ fix)
  fixes: {
    spread_gt_max:         { exec: "limit", postOnly: true },
    expected_slip_gt_max:  { exec: "limit", qtyFactor: 0.75, slices: 3 },
    min_rr_not_met:        { slTightenBps: 5, tpWidenBps: 5 },
    qty_usd_gt_max:        { qtyFactor: 0.5 },
    symbol_exposure_gt_cap:{ qtyFactor: 0.5 },
    cluster_exposure_gt_cap:{ qtyFactor: 0.5 },
    guard_block_aggressive:{ exec: "limit", variant: "conservative" }
  },

  // VarsayÄ±lan sÄ±nÄ±rlar (policy yoksa fallback)
  limitsDefaults: {
    maxSlipBps: 15,
    maxSpreadBps: 80,
    minRR: 1.2,
    maxQtyUSD: 25000,
    maxLeverage: 5,
    maxSymbolExposurePct: 1.0,
    maxClusterExposurePct: 1.5
  },

  riskModel: { // tahmini kaldÄ±raÃ§ ve notional hesabÄ±
    equityFallbackUSD: 25000
  },

  idempotencyTtlSec: 300
}

5) Hesaplamalar (tÃ¼retilen metrikler)

qtyUSD = qty * mid

RR (risk/reward) = tpBps / slBps (Ã¶r. 70/45 â‰ˆ 1.56)

expectedSlipBps = cost.forecast.update.expectedSlipBps varsa onu, yoksa:

exec=="market" â†’ min(maxSlipBps*1.2, spreadBps*0.5 + 8) (basit tahmin)

exec=="limit|post_only" â†’ min( max(2, spreadBps*0.2), maxSlipBps )

exec=="twap|iceberg" â†’ max(3, spreadBps*0.3)

leverageEst â‰ˆ (totalNotionalUSD + planNotionalUSD) / equityUSD

planNotionalUSD â‰ˆ qtyUSD (futuresâ€™de Ã§arpan yok varsayÄ±mÄ±; borsaya gÃ¶re adapter dÃ¼zeltir)

equityUSD yoksa riskModel.equityFallbackUSD kullan ve bounds.alert(info,"equity_fallback")

Exposure sonrasÄ±:

symbolExposurePctAfter = (bySymbol[symbol].notionalUSD + qtyUSD) / equityUSD * 100

clusterExposurePctAfter = (byCluster[cluster].notionalUSD + qtyUSD) / equityUSD * 100

Dinamik limitler: guard/qa/variantâ€™a gÃ¶re limits deÄŸerlerine tighten Ã§arpanlarÄ± uygula:

spreadMaxEff = maxSpreadBps * factor, slipMaxEff = maxSlipBps * factor, minRREff = minRR * (variant=="aggressive" ? aggressiveRelaxPct : 1)

6) Karar Tablosu (Ã¶zet)

Guard KÄ±sÄ±tlarÄ±

sentry.mode=="halt_entry" â†’ hard guard_halt_entry â†’ ok=false (blok).

latency_slip.guard=="block_aggressive" ve variant=="aggressive" â†’ soft guard_block_aggressive â†’ revise: variant="conservative" | exec="limit".

Piyasa KoÅŸullarÄ±

spreadBps > spreadMaxEff â†’ ihlal spread_gt_max (soft).

expectedSlipBps > slipMaxEff â†’ expected_slip_gt_max (soft). EÄŸer expectedSlipBps â‰¥ 2*slipMaxEff â†’ hard expected_slip_gt_max_x2.

Plan Kalitesi

RR < minRREff â†’ min_rr_not_met (soft; dÃ¼zeltme Ã¶ner).

exec=="twap" && slices<3 â†’ twap_slices_too_low (soft; slices=3 Ã¶ner).

exec=="post_only" && spreadBps < 5 â†’ bilgi amaÃ§lÄ± uyarÄ± (gereksiz post_only).

Miktar / Risk

qtyUSD > maxQtyUSD â†’ qty_usd_gt_max (soft; qtyâ†“).

leverageEst > maxLeverage â†’ hard leverage_gt_max (blok).

Maruziyet

symbolExposurePctAfter > maxSymbolExposurePct â†’ symbol_exposure_gt_cap (soft; qtyâ†“). > 2x cap â†’ hard.

clusterExposurePctAfter > maxClusterExposurePct â†’ cluster_exposure_gt_cap (soft).

Hard â†’ doÄŸrudan ok=false (blok).
Soft â†’ ok=false + confirmation.fix.suggestion(revise); operatÃ¶r onaylarsa LIVIA-01 yeni promptu gÃ¶sterebilir.

7) FSM â€” advance(state, event, cfg, now)

IDLE
operator.decision.context â†’ baÄŸlamÄ± topla, policy/market/guard/cost/exposure son snapshotâ€™larÄ± isteÄŸe baÄŸla â†’ EVALUATE.

EVALUATE
Dinamik limitleri uygula â†’ metrikleri hesapla â†’ ihlal listesini oluÅŸtur â†’ hard varsa: bounds.check(ok=false, severity="hard") + bounds.alert(error, reason) â†’ IDLE.
hard yok, soft varsa: bounds.check(ok=false, severity="soft") + fix.suggestion(revise) â†’ IDLE.
ihlal yok: bounds.check(ok=true) â†’ IDLE.

Idempotency
checkId tekrarÄ±ndan kaÃ§Ä±n (TTL iÃ§inde aynÄ± sonucu yayÄ±nlama).

8) Kenar Durumlar

policy.variants.aggressive=false + variant=="aggressive" â†’ otomatik revise: variant="conservative" (soft ihlal).

market.refs gecikmiÅŸ/veri yok â†’ bounds.alert(warn,"stale_market"); spread/slip kontrolleri geÃ§ici atlanÄ±r.

cost.forecast yok â†’ slip hesabÄ± heuristikten (yukarÄ±da).

equityUSD veya exposure yok â†’ hard deÄŸil; yalnÄ±zca uyarÄ±lar ve confidence dÃ¼ÅŸÃ¼rÃ¼lÃ¼r.

exec="iceberg" ve slices<2 â†’ slices=2 Ã¶ner (gÃ¶rÃ¼nÃ¼rlÃ¼k/dolum kalitesi).

tpBps Ã§ok yÃ¼ksek (Ã¶rn. > 500) â†’ bilgi amaÃ§lÄ± rr_outlier uyarÄ±sÄ± (blok deÄŸil).

9) Event Bus

In: operator.decision.context, policy.snapshot, market.refs, latency_slip.guard.directive, sentry.guard.directive, cost.forecast.update, portfolio.exposure

Out: confirmation.bounds.check, confirmation.fix.suggestion?, bounds.alert, bounds.metrics

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/confirmationBounds.ts          // FSM + karar tablosu
services/livia/lib/boundsCalc.ts              // rr, slip, leverage, exposure hesaplarÄ±
services/livia/lib/boundsFixer.ts             // violationâ†’revise Ã¶neri Ã¼retici
services/livia/state/boundsStore.ts           // last snapshots + idempotency index
services/livia/__tests__/confirmationBounds.test.ts
cfg/livia.bounds.yaml                         // limit override + tighten katsayÄ±larÄ±

11) Test Ä°skeleti (Jest/Vitest)

Guard Hard: sentry.halt_entry â†’ ok=false, severity=hard, alert(error).

Spread/Slip Soft: spread 85>80 ve expectedSlip 18>15 â†’ ok=false soft + fix: exec=limit, qtyÃ—0.75, slices=3.

RR Soft: RR 1.1 < minRR 1.2 â†’ fix: slTighten + tpWiden.

Qty Cap: qtyUSD 30k > 25k â†’ qtyÃ—0.5.

Leverage Hard: leverage>max â†’ blok.

Symbol Cap Soft: cap %1.0, after %1.2 â†’ qtyÃ—0.5; 2x cap â†’ hard.

Tighten DinamiÄŸi: highVol â†’ limitler %85â€™e sÄ±kÄ±; aynÄ± plan normalde geÃ§er, highVolâ€™da soft fail.

Idempotency: aynÄ± checkId ile ikinci yayÄ±n yok.

Missing Exposure: exposure yok â†’ ok ama bounds.alert(info,"exposure_missing").

12) Telemetri & SLO

bounds.metrics per 30 sn: checked, okRate, autoReviseRate, blockRate, topViolations{}.

P99 deÄŸerlendirme sÃ¼resi < 3 ms (snapshot merge + hesaplar).

Otomatik revizyonlarÄ±n â‰¥ %70â€™i operatÃ¶r tarafÄ±ndan kabul gÃ¶rmeli (LIVIA-01â€™de izlenir).

13) Ã–rnek AkÄ±ÅŸ (SayÄ±sal)

Girdi: variant=base, exec=market, qty=123.45, mid=9.87, sl=45bps, tp=70bps;
spread=85bps, expectedSlip=18bps, policy maxSpread=80, maxSlip=15, minRR=1.2; guard=slowdown.

TÃ¼rev: qtyUSDâ‰ˆ1219.7, RRâ‰ˆ1.56 (ok), slip/spread aÅŸÄ±yor (soft).

Ã‡Ä±ktÄ±:

bounds.check(ok=false, severity="soft", violations:["spread_gt_max","expected_slip_gt_max"])

fix.suggestion(revise: exec="limit", qtyÃ—0.75, slices=3)

LIVIA-01 yeni promptu bu Ã¶nerilerle gÃ¼nceller; operatÃ¶r onaylarsa plan uygulanÄ±r.
______________________________________________________________________________________________
LIVIA-05 Â· actionApprovalGateway.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: OperatÃ¶r/otomat kararlarÄ±nÄ± tek kapÄ±dan geÃ§irmek. Riskli eylemler iÃ§in dual-control / quorum, RBAC (rol yetkisi), TTL, gerekÃ§elendirme, bypass (acil durum) ve geri alma (revoke/rollback) mantÄ±ÄŸÄ± uygular. SonuÃ§larÄ± imzalÄ± ÅŸekilde yayÄ±nlar. LIVIA-01/02/04â€™ten ve SENTRY/SG/POLICYâ€™den gelen sinyalleri dikkate alÄ±r.

1) Ä°lkeler

Event-driven I/O (JSON), ISO-8601, Europe/Istanbul.

Zod ile tÃ¼m giriÅŸ/Ã§Ä±kÄ±ÅŸ doÄŸrulama; .strict().

Idempotency: approvalKey bazlÄ±; TTL iÃ§inde aynÄ± isteÄŸe ikinci sonuÃ§ Ã¼retilmez.

Audit: Her Out eventâ€™e {eventId, producedBy, producedAt} ekle.

GÃ¼venlik: Ä°mza doÄŸrulama (HMAC/JWT), RBAC kontrolÃ¼, allowlist (Ã¶rn. endpoint failover hedefleri).

TR dilinde kÄ±sa ve net aÃ§Ä±klamalar (operatÃ¶r loglarÄ± iÃ§in).

2) Eylem Tipleri & Onay Profilleri (ÅŸablon)

AÅŸaÄŸÄ±daki tabloyu configâ€™ten yÃ¼kleyin; ihtiyaÃ§ olursa gÃ¼ncellenebilir.

action (scope)	Ã¶rnek payload	profil
halt_entry (global/symbol)	`{scope:"global"	"symbol", symbol?}`
failover (endpoint)	{to:"exA-sec-1"}	dual-control(2/2) + allowlist
aggressive_overrides	{enable:true, ttlSec:600}	single + reasonâ‰¥20ch, TTL 10m
risk_limit_change	{path:"limits.maxSlipBps", from:15, to:18}	quorum(2/3) + scheduled
manual_close_all	{reason:"panic"}	dual-control(2/2)
policy_deploy_canary	{version:"v42", percent:10}	single (policy role)

Emergency bypass: risk.incident.emergency_stop aktifse halt_entry(global) tek onayla geÃ§ebilir (log + yÃ¼ksek seviye alert).

3) Girdiler (In) â€” Åemalar (Zodâ€™a Ã§evrilecek)
{
  "operator.decision.final": {
    "event":"operator.decision.final",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "decisionId":"opt-1|opt-2|custom",
    "accepted": true,
    "rationale":"qty -%25",
    "ttlSec": 120,
    "context": { "action":"failover", "payload":{"to":"exA-sec-1"}, "approvalKey":"run-42#failover#exA-sec-1" },
    "auth": { "userId":"op-007", "roles":["trader","ops"], "sig":"hex" }
  },

  "guard.question.result": {
    "event":"guard.question.result",
    "timestamp":"iso8601",
    "qId":"q-avax-42-1",
    "promptId":"dlg-avax-42",
    "ok": true,
    "recommendation": { "action":"proceed|revise|block", "params":{} }
  },

  "confirmation.bounds.check": {
    "event":"confirmation.bounds.check",
    "timestamp":"iso8601",
    "checkId":"dlg-avax-42#v1",
    "symbol":"AVAXUSDT",
    "ok": true,
    "severity":"soft|hard",
    "violations":[]
  },

  "manual.approval.request": {
    "event":"manual.approval.request",
    "timestamp":"iso8601",
    "approvalKey":"risk#limits.maxSlipBps#to=18",
    "action":"risk_limit_change",
    "payload":{"path":"limits.maxSlipBps","from":15,"to":18},
    "requestedBy":{"userId":"sys-policy","roles":["policy"],"sig":"hex"},
    "reason":"slip p95 artÄ±ÅŸÄ±"
  },

  "policy.snapshot": {
    "event":"policy.snapshot",
    "timestamp":"iso8601",
    "roles": { "trader": ["aggressive_overrides"], "ops":["halt_entry","failover","manual_close_all"], "policy":["risk_limit_change","policy_deploy_canary"] },
    "approvalProfiles": {
      "halt_entry": { "type":"dual", "quorum":2, "of":2, "ttlSec":300 },
      "failover": { "type":"dual", "quorum":2, "of":2, "ttlSec":300, "allowlist":["exA-pri-1","exA-sec-1","exA-sec-2"] },
      "aggressive_overrides": { "type":"single", "reasonMinChars":20, "ttlSec":600 },
      "risk_limit_change": { "type":"quorum", "quorum":2, "of":3, "roles":["policy","ops"], "schedule":"allow|require", "ttlSec":600 }
    }
  },

  "sentry.guard.directive": {
    "event":"sentry.guard.directive",
    "timestamp":"iso8601",
    "mode":"normal|degraded|streams_panic|halt_entry",
    "expiresAt":"iso8601"
  },

  "risk.incident.emergency_stop": {
    "event":"risk.incident.emergency_stop",
    "timestamp":"iso8601",
    "active": true,
    "reason":"liquidity collapse"
  }
}

4) Ã‡Ä±ktÄ±lar (Out) â€” Åemalar
{
  "action.approved": {
    "event":"action.approved",
    "timestamp":"iso8601",
    "approvalKey":"run-42#failover#exA-sec-1",
    "action":"failover",
    "payload":{"to":"exA-sec-1"},
    "ttlSec":180,
    "by":[{"userId":"op-007","roles":["ops"],"ts":"iso8601"},{"userId":"op-009","roles":["ops"],"ts":"iso8601"}],
    "chain":{"required":"dual(2/2)","collected":2},
    "reason":"Sentry degraded; latency spike",
    "audit":{"eventId":"...","producedBy":"livia-05","producedAt":"iso8601"}
  },

  "action.rejected": {
    "event":"action.rejected",
    "timestamp":"iso8601",
    "approvalKey":"risk#limits.maxSlipBps#to=18",
    "action":"risk_limit_change",
    "reasons":["rbac_forbidden","insufficient_quorum"],
    "by":[{"userId":"op-011","roles":["policy"],"ts":"iso8601"}],
    "audit":{"eventId":"...","producedBy":"livia-05","producedAt":"iso8601"}
  },

  "approval.pending": {
    "event":"approval.pending",
    "timestamp":"iso8601",
    "approvalKey":"risk#limits.maxSlipBps#to=18",
    "action":"risk_limit_change",
    "needed":{"quorum":2,"of":3},
    "received":[{"userId":"op-011","roles":["policy"],"ts":"iso8601"}],
    "expiresAt":"iso8601"
  },

  "approval.revoked": {
    "event":"approval.revoked",
    "timestamp":"iso8601",
    "approvalKey":"run-42#failover#exA-sec-1",
    "reason":"ttl_expired|manual_revoke|superseded",
    "rollback":{"event":"endpoint.switch.rollback","params":{"to":"exA-pri-1"}}
  },

  "approval.metrics": {
    "event":"approval.metrics",
    "timestamp":"iso8601",
    "pending":1,
    "approved":12,
    "rejected":3,
    "revoked":1,
    "avgLeadTimeSec":42,
    "byAction":{"failover":5,"halt_entry":4,"risk_limit_change":2}
  },

  "approval.alert": {
    "event":"approval.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"failover target allowlist dÄ±ÅŸÄ±",
    "context":{"approvalKey":"run-42#failover#exA-unknown","target":"exX-foo"}
  }
}

5) Konfig (varsayÄ±lanlar)
{
  i18n: { locale: "tr-TR", tz: "Europe/Istanbul" },

  // RR: rol tablosu ve profil ÅŸablonlarÄ± policy.snapshot'tan yÃ¼klenir; burada defaults
  defaults: {
    profiles: {
      dual: { quorum: 2, of: 2, ttlSec: 300 },
      single: { ttlSec: 600, reasonMinChars: 20 },
      quorum: { quorum: 2, of: 3, ttlSec: 600 }
    },
    allowlist: { failover: [] }
  },

  // Ek kurallar
  rules: {
    requireFreshBounds: ["aggressive_overrides"],  // bounds.ok=true olmadan onay verme
    forbidWhenSentry: { "halt_entry": [], "failover": [] }, // Ã¶rnek: sentry=halt_entry iken failover'a izin ver (boÅŸ liste = izin var)
    minReasonChars: 20
  },

  // Idempotency & TTL
  idempotencyTtlSec: 600,
  pendingTtlSec: 600,      // quorum bekleme sÃ¼resi
  revokeOnTtlExpire: true,

  // Security
  security: { verifySignature: true, requireRole: true }
}

6) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

Durumlar

IDLE

REQUESTED (yeni onay talebi alÄ±ndÄ± / tek onay geldi)

PENDING (quorum bekleniyor)

APPROVED

REJECTED

REVOKED (ttl bitti / manuel iptal)

EXPIRED (idempotency TTL geÃ§ti; yeni tur)

AkÄ±ÅŸ

Ä°stek Al (ENTRY)
Kaynak: operator.decision.final(accepted=true) veya manual.approval.request.

approvalKey zorunlu. AynÄ±sÄ±ndan varsa ve TTL iÃ§inde â†’ yut (idempotency).

RBAC: auth.roles iÃ§inde eylem iÃ§in yetki var mÄ±? Yoksa action.rejected(rbac_forbidden).

Profil: policy.snapshot.approvalProfiles[action] seÃ§; yoksa defaults.

Guard/Bounds: rules.requireFreshBounds kapsamÄ±ndaysa son confirmation.bounds.check.ok==true olmalÄ±; deÄŸilse rejected(bounds_not_ok).

Allowlist (failover): hedef to allowlistâ€™te mi? DeÄŸilse approval.alert(error) + rejected(allowlist_violation).

Zincir Kur (CHAIN)

Profil single: tek onay yeter; APPROVED.

Profil dual/quorum: ilk onay â†’ approval.pending (listede kaydet, expiresAt).

AynÄ± approvalKey iÃ§in farklÄ± kullanÄ±cÄ±dan gelen imzalÄ± onaylar toplanÄ±r. AynÄ± kullanÄ±cÄ± ikinci kez onay veremez.

Quorum TamamlanÄ±nca

action.approved yayÄ±nla (ttlSec profilden veya istekten).

Uygulama katmanÄ± iÃ§in aÃ§Ä±k ve net: action + payload + ttlSec.

ZamanlayÄ±cÄ±: TTL dolunca auto revoke (istenirse).

Reddetme

GerekÃ§e yetersiz (<minReasonChars), RBAC yok, bounds not ok, allowlist ihlali, quorum saÄŸlanamadÄ± (timeout) â†’ action.rejected.

pendingTtlSec dolarsa: otomatik rejected(insufficient_quorum).

Acil Durum Bypass

risk.incident.emergency_stop.active==true ve action=="halt_entry" + scope global â†’ tek onayla APPROVED.

OlayÄ± yÃ¼ksek seviye approval.alert(warn,"emergency_bypass") ile logla.

Revoke/Rollback

ttl doldu â†’ approval.revoked(ttl_expired) + opsiyonel rollback olayÄ± (Ã¶rn. endpoint.switch.rollback).

manual_revoke destekle: aynÄ± approvalKey ile manual.approval.request{action:"revoke"}.

7) Kurallar (Ã¶zet karar tablosu)

RBAC: hasRole(user.roles, action) deÄŸilse â†’ REJECT.

Bounds: action âˆˆ requireFreshBounds ve bounds.ok!=true â†’ REJECT.

Allowlist: action=="failover" ve payload.to âˆ‰ allowlist â†’ REJECT.

Guard Etkisi: sentry.mode=="halt_entry" iken halt_entry talebi â†’ APPROVE (uyumlu).

Reason: aggressive_overrides.enable=true ve len(reason)<minReasonChars â†’ REJECT.

Quorum: Gereken quorum/of saÄŸlanÄ±nca â†’ APPROVE, aksi PENDING/timeoutâ†’REJECT.

8) GÃ¼venlik

authVerify: sig doÄŸrula; saat kaymasÄ± Â±120s.

RBAC kaynaklarÄ±: policy.snapshot.roles + local cache.

Audit trail: tÃ¼m kararlar hash-zinciri ile baÄŸlansÄ±n (prevEventIdHash).

Replay KorumasÄ±: approvalKey + userId + ts kombinasyonunu nonce olarak sakla.

9) Idempotency & YarÄ±ÅŸ KoÅŸullarÄ±

approvalKey tekil. AynÄ± anda gelen onaylar optimistic lock ile toplanÄ±r (memory + atomic update).

Ã‡ift publishâ€™i engelle: idemIndex.set(approvalKey, expiresAt); Out event Ã¼retmeden Ã¶nce kontrol et.

10) Event Bus

In: operator.decision.final, manual.approval.request, policy.snapshot, sentry.guard.directive, confirmation.bounds.check, risk.incident.emergency_stop

Out: approval.pending, action.approved, action.rejected, approval.revoked, approval.metrics, approval.alert

11) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/actionApprovalGateway.ts        // FSM + karar tablosu
services/livia/lib/rbac.ts                     // rol kontrolÃ¼
services/livia/lib/chainBuilder.ts             // quorum/dual zinciri
services/livia/lib/allowlist.ts                // hedef doÄŸrulama (failover)
services/livia/state/approvalStore.ts          // pending set, idem index, audit chain
services/livia/__tests__/actionApprovalGateway.test.ts
cfg/livia.approvals.yaml                       // profiller, allowlist, minReason

12) Test Ä°skeleti (Jest/Vitest)

Dual (Failover): iki farklÄ± ops kullanÄ±cÄ±sÄ± â†’ action.approved(ttlSec=300).

Allowlist Reddi: hedef listede deÄŸil â†’ action.rejected(allowlist_violation).

Aggressive Overrides (Single): 10 karakter gerekÃ§e â†’ rejected(reason_too_short); 30 karakter â†’ approved.

Risk Limit Change (Quorum 2/3): tek policy onayÄ± â†’ approval.pending; ikinci onay gelince â†’ approved; timeout â†’ rejected(insufficient_quorum).

Bounds ÅartÄ±: bounds.ok=false â†’ rejected(bounds_not_ok).

Emergency Bypass: emergency_stop.active=true + halt_entry(global) â†’ tek onayla approved + approval.alert(warn,"emergency_bypass").

Idempotency: aynÄ± approvalKey ikinci kez â†’ yayÄ±n yok.

Revoke TTL: ttl dolunca approval.revoked(ttl_expired) + rollback olayÄ± yayÄ±nlanÄ±r.

13) Telemetri & SLO

approval.metrics per 30 sn: pending, approved, rejected, revoked, avgLeadTimeSec, byAction{}.

P99 karar iÅŸleme sÃ¼resi < 5 ms (IO hariÃ§).

insufficient_quorum oranÄ± < %10 (operasyonel hedef).

14) Ã–rnek AkÄ±ÅŸlar
A) Failover (dual-control)

operator.decision.final(accepted, action="failover", to="exA-sec-1") â†’ RBAC ok, allowlist ok.

approval.pending(quorum 2/2) yayÄ±nlanÄ±r.

Ä°kinci ops onayÄ± gelir â†’ action.approved(ttlSec=180); SG-04 bu sinyalle switch planÄ±nÄ± uygular.

TTL dolarsa veya geri alÄ±nÄ±rsa â†’ approval.revoked(ttl_expired) + endpoint.switch.rollback.

B) Risk limit change (quorum 2/3)

manual.approval.request (policy) â†’ approval.pending(need 2/3); aÃ§Ä±klama â‰¥20 karakter.

Ä°kinci onay opsâ€™tan gelir â†’ action.approved; PolicyCoordinator deÄŸiÅŸikliÄŸi uygular (canary %10).

ÃœÃ§Ã¼ncÃ¼ onay gelirse auditâ€™e eklenir (quorum zaten saÄŸlanmÄ±ÅŸ).

C) Aggressive override (single + reason)

operator.decision.final(accepted, action="aggressive_overrides", enable=true, reason="â€¦â‰¥20châ€¦") â†’ bounds.ok true ise action.approved(ttl=10m).

Sentry block_aggressive olursa bu onay saygÄ± duyar ancak composer guard tarafÄ±ndan zaten kÄ±sÄ±tlanÄ±r (uyarÄ± Ã§Ä±kar: â€œguard overrides behaviorâ€).

15) Entegrasyon NotlarÄ±

LIVIA-01/02/04: Onay Ã¶ncesi diyalog, sorular ve sÄ±nÄ±r kontrolleri burada Ã¶n koÅŸul kabul edilir; sonuÃ§ action.approved|rejected olarak dÃ¶ner.

SENTRY/SG: action="failover" onaylandÄ±ÄŸÄ±nda SG-04â€™e uygulanabilir sinyal (endpoint.switch.plan) Ã§Ä±karÄ±lmalÄ±dÄ±r (bu modÃ¼l sadece kapÄ±dÄ±r; uygulama baÅŸka servistedir).

POLICY: risk_limit_change/policy_deploy_canary onaylarÄ± PolicyCoordinator tarafÄ±ndan uygulanÄ±r.

E2E: Orchestrator onay akÄ±ÅŸÄ±nÄ± sim modda test edebilir; approval.metrics ve approval.alert E2E rapora girer.
______________________________________________________________________________________________
LIVIA-06 Â· operatorUIBridge.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: OperatÃ¶r UIâ€™sÄ± (web/desktop) ile gerÃ§ek zamanlÄ± kÃ¶prÃ¼ kurmak. operator.prompt.out / operator.question.out / approval.pending gibi olaylarÄ± gÃ¼venli bir kanaldan UIâ€™ya ilet, at-most-once teslimat saÄŸlayacak ÅŸekilde ACK topla, yanÄ±tlarÄ± operator.response.in / operator.answer.in / manual.approval.request biÃ§iminde geri yayÄ±nla. WSâ†’SSE otomatik dÃ¼ÅŸÃ¼ÅŸ (fallback), rate-limit, backpressure, yeniden gÃ¶nderim ve offline replay iÃ§ersin.

1) Mimari & Ä°lkeler

Transport: WebSocket (Ã¶ncelikli) â†’ baÅŸarÄ±sÄ±zlÄ±kta SSE (fallback).

GÃ¼venlik: Ä°stemci isteklerinde X-Signature: HMAC-SHA256 (secret = BRIDGE_HMAC), ayrÄ±ca zaman damgasÄ± X-Ts (drift Â±120s). Sunucu â†’ Ä°stemci pushâ€™larÄ±nda da HMAC ekle.

Teslimat: At-most-once semantiÄŸi: her UI pushâ€™unda deliveryId + monoton seq; UI ACK gÃ¶nderir. ACK gelmeyenler retry edilir (exponential backoff).

Idempotency: UIâ€™dan gelen yanÄ±tlar ackKey = userId#promptId#decisionId#ts ile dedupe edilir.

PII: Metin alanlarÄ± piiRedactor filtresinden geÃ§sin; sÄ±nÄ±flandÄ±rma etiketi ve expiresAt eklensin.

Dil: TR; kÄ±sa/gÃ¶rsel odaklÄ±. UI tarafÄ± seÃ§enekleri ve sÃ¼resi (TTL) net gÃ¶rsÃ¼n.

Saat dilimi: Europe/Istanbul, ISO-8601.

GÃ¶zlemlenebilirlik: ui.bridge.metrics (per 30 sn), ui.bridge.alert.

2) Girdiler (In) â€” Zod ÅŸemalarÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lecek Ã¶rnekler
{
  "operator.prompt.out": {
    "event":"operator.prompt.out",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "title":"AVAX â€” Base/TWAP Ã¶nerisi",
    "body":"â€¢ Varyant: Baseâ†’Conservative â€¢ Qtyâ‰ˆ123.45 â€¢ Guard: slowdown",
    "options":[{"id":"opt-1","label":"Uygula"},{"id":"opt-2","label":"MiktarÄ± %25 azalt"},{"id":"opt-3","label":"Ä°ptal"}],
    "context":{"symbol":"AVAXUSDT","variant":"base","exec":"twap","qty":123.45},
    "expiresAt":"iso8601",
    "audit":{"eventId":"...","producedBy":"livia-01","producedAt":"iso8601"}
  },

  "operator.question.out": {
    "event":"operator.question.out",
    "timestamp":"iso8601",
    "qId":"q-avax-42-1",
    "promptId":"dlg-avax-42",
    "title":"YÃ¼ksek slip riski",
    "text":"Slip p95 ~18 bps. ToleransÄ±nÄ± onaylÄ±yor musun?",
    "kind":"confirm|numerical|choice",
    "expected":"yes|no|value|option",
    "constraints":{"min":0,"max":20,"step":1,"unit":"bps"},
    "options":[{"id":"ok","label":"Evet"},{"id":"no","label":"HayÄ±r"}],
    "ttlSec":90,
    "context":{"symbol":"AVAXUSDT","mode":"slowdown","spreadBps":85}
  },

  "approval.pending": {
    "event":"approval.pending",
    "timestamp":"iso8601",
    "approvalKey":"run-42#failover#exA-sec-1",
    "action":"failover",
    "needed":{"quorum":2,"of":2},
    "received":[{"userId":"op-007","roles":["ops"],"ts":"iso8601"}],
    "expiresAt":"iso8601"
  }
}

3) Ã‡Ä±kÄ±ÅŸlar (Out) â€” Zod ÅŸemalarÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lecek Ã¶rnekler
{
  "operator.response.in": {
    "event":"operator.response.in",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "decisionId":"opt-2|opt-1|opt-3|custom",
    "payload":{"note":"qty -%25 + limit"},
    "auth":{"userId":"op-007","sig":"hex"}
  },

  "operator.answer.in": {
    "event":"operator.answer.in",
    "timestamp":"iso8601",
    "qId":"q-avax-42-1",
    "answer":"yes|no|value|option",
    "value":18,
    "unit":"bps",
    "auth":{"userId":"op-007","sig":"hex"}
  },

  "manual.approval.request": {
    "event":"manual.approval.request",
    "timestamp":"iso8601",
    "approvalKey":"risk#limits.maxSlipBps#to=18",
    "action":"risk_limit_change",
    "payload":{"path":"limits.maxSlipBps","from":15,"to":18},
    "requestedBy":{"userId":"op-011","roles":["policy"],"sig":"hex"},
    "reason":"slip p95 artÄ±ÅŸÄ±"
  }
}

4) UI Push ZarfÄ± (serverâ†’client)

TÃ¼m UIâ€™ya giden mesajlar tek standart zarf iÃ§inde gÃ¶nderilsin; iÃ§erik payload alanÄ±nda orijinal event.

{
  "event":"ui.push",
  "timestamp":"iso8601",
  "deliveryId":"dlg-avax-42#000123",      // tekil
  "seq":123,                               // baÄŸlantÄ± baÅŸÄ±na monoton artan
  "kind":"prompt|question|approval|alert",
  "payload":{ ... orijinal event ... },
  "expiresAt":"iso8601",
  "sig":"hex"                              // server-side HMAC
}


ACK (clientâ†’server)

{
  "event":"ui.ack.in",
  "timestamp":"iso8601",
  "deliveryId":"dlg-avax-42#000123",
  "status":"received|rendered|acted",
  "latencyMs": 120,
  "auth":{"userId":"op-007","sig":"hex"}
}

5) Ä°letiÅŸim UÃ§larÄ±

WS: wss://bridge/v1/ws (header: X-UserId, X-Ts, X-Signature)

Handshake: sunucu welcome{sessionId, seqStart, heartbeatSec} yayÄ±nlar.

Heartbeat: ping (serverâ†’client, 15s) / pong (clientâ†’server).

SSE: GET /v1/sse?userId=...&ts=...&sig=...

Event formatÄ±: id:<deliveryId>\nevent: ui.push\ndata:<json>\n\n

POST Inbound:

/v1/response â†’ operator.response.in

/v1/answer â†’ operator.answer.in

/v1/ack â†’ ui.ack.in
(TÃ¼mÃ¼ HMAC zorunlu; body hashâ€™i HMACâ€™e dahil.)

HMAC: sig = HMAC_SHA256(BRIDGE_HMAC, userId + "\n" + ts + "\n" + bodySha256)
Saat kaymasÄ±: |now - ts| â‰¤ 120 sn deÄŸilse reject.

6) Rate-Limit & Backpressure

KullanÄ±cÄ± baÅŸÄ±: 60 mesaj/dk (serverâ†’client).

Inbound (clientâ†’server): 30 olay/dk, 5 yazÄ±/sn burst.

Kuyruk sÄ±nÄ±rÄ±: baÄŸlantÄ± baÅŸÄ±na 100 bekleyen ui.push.

Limit aÅŸÄ±lÄ±rsa drop policy: oldest + ui.bridge.alert(warn,"client_slow").

Retry PolitikasÄ±: ACK gelmezse 0.5s â†’ 1s â†’ 2s â†’ 5s (maks 4 deneme); sonra dead-letter (diskte data/ui.dlq/).

7) Offline Replay & Senkronizasyon

Yeniden baÄŸlanma: istemci X-Last-Seq ile gelir â†’ sunucu gapâ€™i replay(up to 200 items or 15m) yapar.

Eski expiresAt geÃ§miÅŸ prompt/question replay edilmez; yerine ui.push(kind="alert", "...expired").

8) Konfig (varsayÄ±lanlar)
{
  ws: { port: 7400, heartbeatSec: 15, connIdleSec: 900, maxConns: 200 },
  sse: { enabled: true, cacheSec: 5 },
  rate: { perUserPerMin: 60, inboundPerMin: 30, inboundBurstPerSec: 5 },
  backpressure: { maxPendingPerConn: 100, dropPolicy: "oldest" },
  retry: { attempts: 4, scheduleMs: [500, 1000, 2000, 5000] },
  security: { hmacHeader: "X-Signature", tsHeader: "X-Ts", maxDriftSec: 120 },
  delivery: { idPrefix: "ui", idemTtlSec: 600, replayMaxItems: 200, replayMaxMin: 15 },
  pii: { policyVersion: 1, redactorEnabled: true },
  i18n: { locale: "tr-TR", tz: "Europe/Istanbul" }
}

9) FSM â€” advance(sessionState, event, cfg, now) â†’ emissions[]

Durumlar
DISCONNECTED â†’ CONNECTING â†’ CONNECTED â†’ DELIVERING â†’ AWAIT_ACK â†’ IDLE â†’ (RETRYING | FALLBACK_SSE) â†’ DISCONNECTED

GeÃ§iÅŸler (Ã¶zet)

CONNECTED: operator.prompt.out|operator.question.out|approval.pending â†’ ui.push Ã¼ret, seq++, deliveryId ata â†’ AWAIT_ACK.

ACK geldi (received|rendered|acted) â†’ pendingâ€™den dÃ¼ÅŸ; operator.*.in yakalanÄ±rsa route et.

ACK timeout â†’ RETRYING (backoff) â†’ baÅŸarÄ±lÄ± olmazsa DLQ + ui.bridge.alert(error,"ack_timeout").

WS hatasÄ± â†’ deneme sayÄ±sÄ± â‰¥3 ve 2 dk iÃ§inde ise FALLBACK_SSE.

SSE aÃ§Ä±k + client Last-Seq gÃ¶nderdi â†’ REPLAY â†’ IDLE.

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/operatorUIBridge.ts            // FSM + router
services/livia/lib/transport/wsServer.ts      // WS server + heartbeat + sessions
services/livia/lib/transport/sseServer.ts     // SSE fallback
services/livia/lib/security/hmac.ts           // HMAC verify/sign + ts drift
services/livia/lib/delivery/queue.ts          // per-conn queue + retry + DLQ
services/livia/lib/delivery/idempotency.ts    // ack/response dedupe
services/livia/state/sessionStore.ts          // connections, lastSeq, presence
services/livia/lib/pii/redact.ts              // email/phone/IP mask + expiresAt
services/livia/lib/serialize/envelope.ts      // ui.push zarf formatÄ±
services/livia/__tests__/operatorUIBridge.test.ts
cfg/livia.uiBridge.yaml

11) Test Ä°skeleti (Jest/Vitest)

HMAC: sahte imza â†’ 401 + ui.bridge.alert(error,"auth_failed").

ACK & Retry: ACK yok â†’ 4 deneme â†’ DLQ dÃ¼ÅŸer; ACK geldiÄŸinde tekrar yok (at-most-once).

Rate-Limit: 90/dk push denemesi â†’ ~60 teslim + ui.bridge.alert(warn,"rate_limited").

Backpressure: client yavaÅŸ â†’ 100â€™den sonra oldest dÃ¼ÅŸer, alert Ã¼retir.

Reconnect + Replay: Last-Seq=100 ile baÄŸlan â†’ 101..max replay edilir; sÃ¼resi geÃ§enler atlanÄ±r.

Fallback: 3 WS hatasÄ±/120 sn â†’ SSEâ€™ye dÃ¼ÅŸer, teslimat devam eder.

PII: metinde email/telefon â†’ redacted Ã§Ä±ktÄ±yla gÃ¶nderilir, classification/expiresAt set edilir.

Idempotency Inbound: aynÄ± ackKey iki kez â†’ ilki kabul, ikincisi yutulur.

12) Kenar Durumlar

expiresAt < now iÃ§eren prompt/question pushâ€™lanmaz; yerine expired uyarÄ±sÄ±.

Multiple devices: aynÄ± userId 2 baÄŸlantÄ± â†’ politika: â€œleader onlyâ€ (son baÄŸlanan lider); eskisine ui.bridge.alert(info,"superseded").

Quiet hours (23:30â€“07:30) â†’ yalnÄ±z kritik olaylar push; diÄŸerleri queued (bridge.prefs ile uyum).

approval.pending UIâ€™da onay butonu aÃ§sÄ±n; buton tÄ±klamasÄ± manual.approval.requesta map edilir (RBAC kontrolÃ¼ ayrÄ± modÃ¼lde).

BÃ¼yÃ¼k payload (>64 KB) â†’ linkRef ile dosyaya yaz (data/ui.blobs/â€¦), push iÃ§inde kÄ±sa Ã¶zet + linkRef gÃ¶nder.

13) Telemetri & Alert

ui.bridge.metrics (per 30 sn):

{
  "event":"ui.bridge.metrics",
  "timestamp":"iso8601",
  "activeConns":12,
  "pendingPush":37,
  "ackMedianMs":420,
  "retryRate":0.07,
  "dlqSize":2,
  "fallbackSSE":3
}


ui.bridge.alert(level, message, context):

warn: client_slow, rate_limited, replay_trimmed

error: auth_failed, ack_timeout, transport_down

14) Ã–rnek AkÄ±ÅŸ

operator.prompt.out(dlg-avax-42, TTL=90s) gelir â†’ ui.push(kind="prompt") seq=101, deliveryId=dlg-avax-42#000101.

UI ACK(received) â†’ 1 sn sonra operatÃ¶r opt-2 tÄ±klar â†’ POST /response â†’ operator.response.in(decisionId="opt-2").

ArdÄ±ndan operator.question.out(q-... slip) push â†’ UI numerik 18 girer â†’ operator.answer.in(value=18) gider.

WS dÃ¼ÅŸer â†’ 3 deneme sonra SSE fallback; Last-Seq=102 ile replay yapÄ±lÄ±r.

GÃ¼n sonunda ui.bridge.metrics ve olasÄ± ui.bridge.alertler dashboardâ€™da gÃ¶rÃ¼nÃ¼r.

15) Performans & SLO

Push â†’ ACK p95 < 1500 ms (WS); SSEâ€™de p95 < 2500 ms.

Dropless teslim (ACK alÄ±nan iletiler iÃ§in) â‰¥ %99.9.

DLQ 0 hedefi; istisnai durumlarda operatÃ¶r uyarÄ±sÄ±.

16) GÃ¼venlik NotlarÄ±

TÃ¼m inboundâ€™larda HMAC zorunlu; ts drift kontrolÃ¼.

userId â†’ RBAC eÅŸlemesi LIVIA-05 zincirinde yapÄ±lÄ±r; burada sadece kimlik doÄŸrulama + oran sÄ±nÄ±rÄ±.

PII alanlarÄ± maskelenir; classification ve expiresAt metaâ€™sÄ± eklenir (SEC-01 politikasÄ±yla uyum).
______________________________________________________________________________________________
LIVIA-07 Â· knowledgeRouter.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: OperatÃ¶rÃ¼n â€œNeden bÃ¶yle oldu?/Politika ne diyor?/Oyun kitabÄ± ne Ã¶neriyor?â€ tipi sorularÄ±nÄ± doÄŸru belge ve pasaja yÃ¶nlendirmek. Politika, oyun kitabÄ± (playbook), SSS/FAQ ve senkronize KB (LIVIA-30) iÃ§inden RAG yÃ¶nlendirme yap; gerekirse Ã§oklu pasaj ve Ã¶zet dÃ¶n. SonuÃ§larÄ± LIVIA-01/08/09 gibi modÃ¼llerin kullanacaÄŸÄ± biÃ§imde yayÄ±nla.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest.

Event-driven JSON I/O, tÃ¼m giriÅŸ/Ã§Ä±kÄ±ÅŸlar Zod .strict() ile doÄŸrulanÄ±r.

TZ: Europe/Istanbul, ISO-8601 timestamp.

Gizlilik: classification etiketi, PII maskeleme (LIVIA-21 ile uyum).

GÃ¼venlik: RBAC (policy/pb/faq eriÅŸim haklarÄ±), kaynak allowlist.

Ä°dempotency: routeKey = hash(queryNorm+ctx+policyVersion); TTL iÃ§inde tekrar yayÄ±n yok.

Telemetri: knowledge.route.metrics, UyarÄ±: knowledge.route.alert.

Dil: TR Ã¶ncelik; EN sorgu gelirse i18n (LIVIA-13) ile normalize.

2) Bilgi TabanÄ± ÅemasÄ± (kaynak dokÃ¼manlar)

Bu modÃ¼l ingest etmez; belgeler LIVIA-30 knowledgeSyncIngestor.ts ile gelir. Burada okuma/arama yapÄ±lÄ±r.

DokÃ¼man:

{
  docId: "policy/limits.yaml@v42",
  source: "policy|playbook|faq|kb",
  title: "Limits v42",
  version: "v42",
  lang: "tr|en",
  tags: ["limits","slip","spread"],
  owners: ["policy-team"],
  visibility: ["ops","trader","policy"],
  effective: { from:"2025-08-01", to:null },
  chunks: [
    { chunkId:"c1", text:"Max slip 15bps ...", headings:["Limits","Slip"], meta:{path:"limits.maxSlipBps"} },
    { chunkId:"c2", text:"Max spread 80bps ...", headings:["Limits","Spread"], meta:{path:"limits.maxSpreadBps"} }
  ],
  checksum: "sha256:..."
}


Dizin (index) snapshot: kb.index.snapshot{ ts, stats, vectorReady:boolean }

3) Girdiler (In) â€” Zodâ€™a Ã§evrilecek ÅŸema Ã¶rnekleri
{
  "knowledge.query": {
    "event": "knowledge.query",
    "timestamp": "iso8601",
    "q": "Neden agresif varyant kapalÄ±?",
    "need": "policy|playbook|faq|auto",
    "lang": "tr|en|null",
    "context": {
      "symbol": "AVAXUSDT",
      "guardMode": "slowdown|block_aggressive|halt_entry|normal",
      "policyVersion": "v42",
      "tags": ["aggressive","limits","guard"]
    },
    "prefs": {
      "maxPassages": 2,
      "maxCharsPerPassage": 650,
      "citations": true
    },
    "auth": { "userId": "op-007", "roles": ["ops","trader"], "sig": "hex" }
  },

  "kb.index.snapshot": {
    "event":"kb.index.snapshot",
    "timestamp":"iso8601",
    "vectorReady": true,
    "stats": { "docs": 142, "chunks": 8120 }
  },

  "policy.snapshot": {
    "event":"policy.snapshot",
    "timestamp":"iso8601",
    "versionId":"v42",
    "effective": { "limits": { "maxSlipBps": 18, "maxSpreadBps": 80 }, "variants": { "aggressive": false } }
  }
}

4) Ã‡Ä±ktÄ±lar (Out) â€” Åemalar
{
  "knowledge.route.select": {
    "event": "knowledge.route.select",
    "timestamp": "iso8601",
    "routeKey": "krun-42#v42#a1b2",
    "ok": true,
    "query": { "qNorm": "agresif varyant neden kapalÄ±", "lang": "tr" },
    "top": [
      {
        "docId": "policy/variants@v42",
        "source": "policy",
        "title": "Variants v42",
        "score": 0.87,
        "passages": [
          {
            "chunkId": "c7",
            "excerpt": "Agresif varyant, latency/slip guard 'block_aggressive' iken devre dÄ±ÅŸÄ± kalÄ±r...",
            "headings": ["Variants","Aggressive"],
            "meta": { "path": "variants.aggressive", "policyVersion": "v42" },
            "cit": { "href": "app://kb/policy/variants@v42#c7", "start": 0, "end": 160 }
          }
        ]
      },
      {
        "docId": "playbook/guard-response@pb-12",
        "source": "playbook",
        "title": "Guard Response Playbook",
        "score": 0.74,
        "passages": [
          {
            "chunkId": "c12",
            "excerpt": "Block_aggressive modunda Ã¶neri: conservative varyant + limit/twap ile giriÅŸ...",
            "headings": ["Guard","Block Aggressive"],
            "cit": { "href": "app://kb/playbook/guard-response@pb-12#c12" }
          }
        ]
      }
    ],
    "summary": "Politika v42'ye gÃ¶re agresif varyant guard=block_aggressive iken kapalÄ±dÄ±r. Oyun kitabÄ± conservative+limit/twap Ã¶nerir.",
    "audit": { "eventId": "...", "producedBy": "livia-07", "producedAt": "iso8601" }
  },

  "knowledge.route.nohit": {
    "event": "knowledge.route.nohit",
    "timestamp": "iso8601",
    "routeKey": "krun-42#v42#a1b2",
    "reason": "low_score|not_allowed|empty_query|index_not_ready",
    "hint": "Sorguyu netleÅŸtir: 'max slip kaÃ§ bps?'" 
  },

  "knowledge.route.alert": {
    "event":"knowledge.route.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"rbac_forbidden",
    "context":{"docId":"policy/limits@v42","userId":"op-007"}
  },

  "knowledge.route.metrics": {
    "event":"knowledge.route.metrics",
    "timestamp":"iso8601",
    "queries": 21,
    "nohitRate": 0.14,
    "avgRouteMs": 18,
    "bySource": { "policy": 0.61, "playbook": 0.29, "faq": 0.1 }
  }
}

5) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul", fallbackLang:"tr" },

  retrieval: {
    // aday toplama
    candidateK: 24,
    filters: { bySource: ["policy","playbook","faq","kb"], byLang:["tr","en"] },
    tagBoost: { aggressive: 0.15, guard: 0.12, slip: 0.10, spread: 0.08 },

    // hibrit arama
    dense: { enabled:true, dim:768, topK:24, index:"kb_vectors" },
    sparse:{ enabled:true, bm25TopK:30, k1:1.2, b:0.75 },

    // skor birleÅŸtirme (0..1)
    fuse: { alphaDense:0.6, betaSparse:0.4, titleBoost:0.05, pathBoost:0.05 },

    // yeniden sÄ±ralama
    rerank: { enabled:true, topK:10, features:["queryPassageCos","tagOverlap","policyExactPathHit"] },

    // eÅŸik & sÄ±nÄ±rlar
    selectThreshold: 0.62,
    maxDocs: 2,
    maxPassagesPerDoc: 2
  },

  security: {
    rbac: { policy:["policy","ops","trader"], playbook:["ops","trader"], faq:["ops","trader","policy"], kb:["ops","trader","policy"] },
    piiMask: true,
    allowlistSources: ["policy","playbook","faq","kb"]
  },

  cache: { ttlSec: 600, maxEntries: 1000 },

  idempotencyTtlSec: 600
}

6) Boru HattÄ± (Pipeline) â€” Algoritma

Dil & Normalizasyon

lang yoksa i18n ile tespit et (LIVIA-13).

Sorguyu normalize et: kÃ¼Ã§Ã¼k harf, noktalama temizliÄŸi, TR stopword.

context.tags â†’ semantik geniÅŸletme sÃ¶zlÃ¼ÄŸÃ¼ uygula (Ã¶r. â€œaggressiveâ€ â†” â€œsaldÄ±rgan varyantâ€).

Aday Toplama (Recall)

Kaynak/rol filtresi (RBAC, allowlistSources).

Tag/versiyon/baÅŸlÄ±k eÅŸleÅŸmesi ile hÄ±zlÄ± Ã¶n-seÃ§im (metaveri filtresi).

Hibrit arama:

Dense: sorgu embedding â†’ ANN (topK).

Sparse: BM25 (topK).

AdaylarÄ± birleÅŸtir, tekrarlarÄ± at.

Skor BirleÅŸtirme

score = alpha*Dense + beta*BM25 + titleBoost*(titleHit) + pathBoost*(policyPathHit); [0..1] clamp.

Rerank (Precision)

En iyi topK iÃ§in Ã¶zellikler: cosine, tagOverlap (Jaccard), policyExactPathHit (1/0), recencyBoost (effective.from yakÄ±nlÄ±ÄŸÄ±).

Basit lineer model: rerank = 0.55*cos + 0.20*tag + 0.15*path + 0.10*recency; finalScore = max(score, rerank).

SeÃ§im & Pasaj Kesimi

finalScore â‰¥ selectThreshold olan en Ã§ok maxDocs dokÃ¼man.

Her dokÃ¼mandan en Ã§ok maxPassagesPerDoc chunk; maxCharsPerPassage ile Ã¶zet/kÄ±salt.

PII maskesi uygula (email/telefon/IP â†’ mask/hash).

cit.href Ã¼ret (app://kb/<docId>#<chunkId>).

Sentez (opsiyonel)

need:"auto" ve birden fazla kaynaktan gelen tutarlÄ± pasajlar varsa kÄ±sa Ã¶zet (summary alanÄ±) Ã¼ret.

GÃ¼venlik & RBAC

KullanÄ±cÄ±nÄ±n rolÃ¼ dokÃ¼manÄ±n visibility iÃ§inde deÄŸilse o dokÃ¼manÄ± Ã§Ä±karma; knowledge.route.alert(info,"rbac_forbidden").

Ã–nbellek & Ä°dempotency

routeKey ile sonuÃ§larÄ± cache et; TTL iÃ§inde aynÄ± sorgu+baÄŸlam gelirse cacheâ€™den dÃ¶n (yine event Ã¼ret, audit yeni).

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
knowledge.query geldi â†’ VALIDATE_AUTH.

VALIDATE_AUTH
RBAC & kaynak kontrol; yetkisiz â†’ knowledge.route.alert(error,"rbac_forbidden") + nohit(not_allowed).
Yetkili â†’ RETRIEVE.

RETRIEVE
Index hazÄ±r mÄ± (kb.index.snapshot.vectorReady)? DeÄŸilse sadece BM25; hiÃ§biri yoksa nohit(index_not_ready).
Adaylar â†’ RERANK.

RERANK
Nihai skor ve kesim â†’ SELECT.

SELECT
Pasaj kes/Ã¶zet â†’ knowledge.route.select yayÄ±nla; IDLE.

8) Kenar Durumlar

BoÅŸ/Ã§ok kÄ±sa sorgu (<3 kelime) â†’ nohit(empty_query), ipucu dÃ¶ndÃ¼r.

Ã‡ok fazla eÅŸleÅŸme â†’ Ã¼st sÄ±nÄ±rÄ± koru, â€œdaha spesifik araâ€ ipucu ekle.

Versiyon uyuÅŸmazlÄ±ÄŸÄ± (policyVersion â‰  doc.version) â†’ yine de gÃ¶sterebilirsin ancak summary iÃ§ine â€œEski sÃ¼rÃ¼m uyarÄ±sÄ±â€ notu ekle.

Dil farkÄ± (EN sorgu ama TR iÃ§erik) â†’ otomatik TRâ†’EN kÄ±sa Ã§eviri ek alanÄ± (i18n.text) ile dÃ¶ndÃ¼r (LIVIA-13).

PII algÄ±lanÄ±rsa maskeler; maskeleme baÅŸarÄ±sÄ±zsa o pasajÄ± at (knowledge.route.alert(warn,"pii_redact_failed")).

9) Telemetri
{
  "knowledge.route.metrics": {
    "event":"knowledge.route.metrics",
    "timestamp":"iso8601",
    "queries": 34,
    "nohitRate": 0.12,
    "avgRouteMs": 22,
    "denseUsed": true,
    "rerankUsed": true,
    "cacheHitRate": 0.37,
    "topTags": { "aggressive": 11, "guard": 9, "slip": 7 }
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/knowledgeRouter.ts            // FSM + pipeline
services/livia/lib/normalize.ts              // dil/stopword/lemmatize
services/livia/lib/hybridSearch.ts           // dense+sparse birleÅŸtirme
services/livia/lib/rerank.ts                 // feature skorlama
services/livia/lib/passageCutter.ts          // excerpt & citation
services/livia/lib/rbac.ts                   // gÃ¶rÃ¼nÃ¼rlÃ¼k/rol kontrolÃ¼
services/livia/state/krStore.ts              // cache, idem index, lastIndexSnap
services/livia/__tests__/knowledgeRouter.test.ts
cfg/livia.knowledge.yaml                     // retrieval/security/cache ayarlarÄ±

11) Test Ä°skeleti (Jest/Vitest)

RBAC: role dÄ±ÅŸÄ± dokÃ¼manlar filtrelenir; alert Ã¼retilir.

Hybrid: dense kapalÄ±yken sadece BM25; dense aÃ§Ä±kken skor birleÅŸimi doÄŸru.

Rerank: path hit + tag overlap artÄ±nca finalScore â†‘.

Threshold: finalScore<0.62 â†’ nohit(low_score).

Multi-doc: 2 dokÃ¼man, 1â€™er pasaj seÃ§ilir; Ã¶zet Ã¼retilir.

PII: email geÃ§en pasaj maskelenir.

Cache: aynÄ± routeKey â†’ cache hit, sÃ¼re < Ã¶nceki.

Version Mismatch: policyVersionâ‰ doc.version â†’ summaryâ€™de uyarÄ±.

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

knowledge.query{ q:"Neden agresif kapalÄ±?", need:auto, ctx.guardMode:block_aggressive, policyVersion:v42 }

Adaylar: policy/variants@v42 (score=.81), playbook/guard-response@pb-12 (.68)

Rerank sonrasÄ± final: .87 ve .74; iki pasaj kesildi, PII yok.

knowledge.route.select + kÄ±sa summary yayÄ±nlandÄ±.

knowledge.route.metrics gÃ¼ncellendi.

13) SLO

P95 route sÃ¼resi < 50 ms (index bellekte varsayÄ±mÄ±).

No-hit oranÄ± < %15 (gÃ¼nlÃ¼k, TR/EN karmasÄ±).

YanlÄ±ÅŸ RBAC sÄ±zÄ±ntÄ±sÄ± = 0 (politik dokÃ¼manlarda).
______________________________________________________________________________________________
LIVIA-08 Â· policyExplainer.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: â€œNeden bu karar/policy/guard tetiklendi?â€, â€œNeden plan geÃ§medi?â€, â€œNe deÄŸiÅŸirse geÃ§er?â€ sorularÄ±na kÄ±sa, denetlenebilir ve alÄ±ntÄ±lÄ± aÃ§Ä±klama Ã¼retmek.
Girdi olarak guard/policy/bounds/market sinyallerini alÄ±r; kontrastif aÃ§Ä±klama (gerÃ§ek neden â†” karÅŸÄ±-durum) Ã§Ä±karÄ±r; ilgili belge pasajlarÄ±na (path/citation) ve son deÄŸer/limitlere atÄ±f yapar. SonuÃ§lar UI kartÄ± olarak gÃ¶sterilebilir ve audit iÃ§in saklanÄ±r.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest.

Event-driven JSON I/O; tÃ¼m payloadlar Zod .strict().

Zaman: ISO-8601, Europe/Istanbul.

Ä°dempotency: explainKey = hash(kind + sourceId + snapshotTs); TTL iÃ§inde tekrarÄ± bastÄ±r.

Gizlilik: classification:"SENSITIVE_LOW"; PII maskeleme (LIVIA-21).

Dil: TR kÄ±sa, 5 maddeyi geÃ§meyen bullet tarzÄ± (UIâ€™da â‰¤ 500 karakter).

Telemetri: policy.explain.metrics; UyarÄ±: policy.explain.alert.

2) Girdiler (In) â€” Zod ÅŸemalarÄ± (Ã¶rnek)
{
  "sentry.guard.directive": {
    "event":"sentry.guard.directive",
    "timestamp":"iso8601",
    "mode":"normal|degraded|streams_panic|halt_entry",
    "expiresAt":"iso8601",
    "reasonCodes":["packet_gap>2s","feed_stale>5s"]
  },

  "latency_slip.guard.directive": {
    "event":"latency_slip.guard.directive",
    "timestamp":"iso8601",
    "mode":"normal|slowdown|block_aggressive|halt_entry",
    "expiresAt":"iso8601",
    "reasonCodes":["slip_p95>15bps","lat_p95>800ms"]
  },

  "policy.snapshot": {
    "event":"policy.snapshot",
    "timestamp":"iso8601",
    "versionId":"v42",
    "effective":{
      "limits":{"maxSlipBps":18,"maxSpreadBps":80,"minRR":1.2,"maxQtyUSD":25000},
      "variants":{"aggressive":false,"conservative":true}
    },
    "checksum":"sha256:..."
  },

  "confirmation.bounds.check": {
    "event":"confirmation.bounds.check",
    "timestamp":"iso8601",
    "checkId":"dlg-avax-42#v1",
    "symbol":"AVAXUSDT",
    "ok":false,
    "severity":"soft|hard",
    "violations":[
      {"code":"expected_slip_gt_max","got":18,"limit":15},
      {"code":"spread_gt_max","got":85,"limit":80}
    ],
    "derived":{"rr":1.56,"qtyUSD":1219.7,"leverageEst":1.6}
  },

  "market.refs": {
    "event":"market.refs",
    "timestamp":"iso8601",
    "symbol":"AVAXUSDT",
    "mid":9.87,
    "spreadBps":85
  },

  "cost.forecast.update": {
    "event":"cost.forecast.update",
    "timestamp":"iso8601",
    "symbol":"AVAXUSDT",
    "expectedSlipBps":18,
    "feeBps":{"taker":5,"maker":1.5}
  },

  "knowledge.route.select": {
    "event":"knowledge.route.select",
    "timestamp":"iso8601",
    "routeKey":"krun-42#v42#a1b2",
    "summary":"â€¦",
    "top":[{"docId":"policy/variants@v42","passages":[{"meta":{"path":"variants.aggressive"},"cit":{"href":"app://kb/...#c7"}}]}]
  }
}


Not: knowledge.route.select opsiyonel; varsa citations zenginleÅŸir.

3) Ã‡Ä±ktÄ±lar (Out) â€” Åemalar
{
  "policy.explain": {
    "event":"policy.explain",
    "timestamp":"iso8601",
    "explainKey":"px#dlg-avax-42#v42",
    "kind":"guard|bounds|variant|policy_change",
    "title":"Neden reddedildi? â€” Slip ve spread limitleri aÅŸÄ±ldÄ±",
    "bullets":[
      "Slip p95 â‰ˆ 18 bps, policy limiti 15 bps (v42/limits.maxSlipBps).",
      "Spread â‰ˆ 85 bps, limit 80 bps; MARKET yerine LIMIT/TWAP Ã¶nerilir.",
      "Guard=slowdown: agresif giriÅŸler kÄ±sÄ±tlÄ±; conservative + parÃ§alÄ± emir daha gÃ¼venli.",
      "RR=1.56 (â‰¥1.2) â†’ sorun deÄŸil; asÄ±l red sebebi maliyet/likidite."
    ],
    "whatIf":[
      "YÃ¶ntem LIMIT olsaydÄ± ve qty âˆ’%25, beklenen slip â‰¤ 15 bps â†’ geÃ§ebilirdi.",
      "Spread â‰¤ 80 bps olduÄŸunda MARKET/TAKER tekrar deÄŸerlendirilebilir."
    ],
    "citations":[
      {"path":"limits.maxSlipBps","version":"v42","href":"app://kb/policy/limits@v42#c1"},
      {"path":"limits.maxSpreadBps","version":"v42","href":"app://kb/policy/limits@v42#c2"},
      {"path":"variants.aggressive","version":"v42","href":"app://kb/policy/variants@v42#c7"}
    ],
    "context":{
      "symbol":"AVAXUSDT","guardMode":"slowdown","policyVersion":"v42",
      "violations":["expected_slip_gt_max","spread_gt_max"]
    },
    "audit":{"eventId":"...","producedBy":"livia-08","producedAt":"iso8601"}
  },

  "policy.explain.card": {
    "event":"policy.explain.card",
    "timestamp":"iso8601",
    "title":"Plan neden geÃ§medi?",
    "body":"Slip/Spread limitleri aÅŸÄ±ldÄ±. LIMIT + qty âˆ’%25 ile yeniden deneyin.",
    "links":[{"label":"Policy v42 â€” Limits","href":"app://kb/policy/limits@v42"}],
    "severity":"warn",
    "ttlSec":180
  },

  "policy.explain.metrics": {
    "event":"policy.explain.metrics",
    "timestamp":"iso8601",
    "explains":12,
    "byKind":{"bounds":7,"guard":3,"variant":2},
    "avgComposeMs":6,
    "withCitationsRate":0.92
  },

  "policy.explain.alert": {
    "event":"policy.explain.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"missing_policy_snapshot",
    "context":{"expectedVersion":"v42"}
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  style: {
    maxBullets: 5,
    includeNumbers: true,         // bps/limit/rr sayÄ±larÄ± gÃ¶rÃ¼nsÃ¼n
    includeWhatIf: true,          // kontrastif 1-2 Ã¶neri
    includeCitations: true,
    cardMaxChars: 280
  },

  mapping: {
    // violation/guard â†’ mesaj ÅŸablonlarÄ±
    violations: {
      expected_slip_gt_max: "Slip p95 â‰ˆ ${got} bps, policy limiti ${limit} bps.",
      expected_slip_gt_max_x2: "Slip â‰ˆ ${got} bps, limitin 2 katÄ± (${limit}).",
      spread_gt_max: "Spread â‰ˆ ${got} bps, limit ${limit} bps; MARKET yerine LIMIT/TWAP Ã¶nerilir.",
      min_rr_not_met: "RR â‰ˆ ${got} (< ${limit}); SL sÄ±kÄ±laÅŸtÄ±r veya TP geniÅŸlet.",
      qty_usd_gt_max: "Miktar â‰ˆ ${gotUSD}$, Ã¼st sÄ±nÄ±r ${limitUSD}$.",
      leverage_gt_max: "Tahmini kaldÄ±raÃ§ â‰ˆ ${lev}, Ã¼st sÄ±nÄ±r ${maxLev}."
    },
    guards: {
      slowdown: "Guard=slowdown: agresif giriÅŸler kÄ±sÄ±tlÄ±; conservative + parÃ§alÄ± emir daha gÃ¼venli.",
      block_aggressive: "Guard=block_aggressive: agresif varyant geÃ§ici olarak kapalÄ±.",
      halt_entry: "Guard=halt_entry: yeni giriÅŸlere izin yok."
    }
  },

  whatIfRules: [
    // koÅŸul â†’ Ã¶neri
    { when: "expected_slip_gt_max", suggest: "exec='limit', qtyÃ—0.75, slices=3 â†’ slip â‰¤ ${limit} bps olabilir." },
    { when: "spread_gt_max",        suggest: "spread â‰¤ ${limit} bps olduÄŸunda MARKET tekrar denenebilir." },
    { when: "min_rr_not_met",       suggest: "SL âˆ’5 bps & TP +5 bps ile RR eÅŸiÄŸini geÃ§." }
  ],

  idempotencyTtlSec: 600
}

5) AÃ§Ä±klama Ãœretim Boru HattÄ± (Pipeline)

Kontekst Topla

Son confirmation.bounds.check, guard.directive(ler), policy.snapshot, market.refs, cost.forecast.

EÄŸer policy.snapshot yoksa alert + kÄ±sÄ±tlÄ± aÃ§Ä±klama.

Neden KodlarÄ±nÄ± Ã‡Ã¶zÃ¼mle

violations[].code â†’ mapping.violations.

Guard modu varsa mapping.guards[mode] ek madde.

SayÄ±sal KanÄ±tlarÄ± Ekle

got/limit bps, RR, qtyUSD, leverageEst.

Varsa feeBps, beklenen iÅŸlem maliyeti (slip+fee) â‰ˆ bps olarak eklenebilir.

Kontrastif (â€œWhat-Ifâ€) OluÅŸtur

whatIfRules ile ihlale uygun 1â€“2 Ã¶neri (exec deÄŸiÅŸimi, qty azaltma, slices artÄ±rma, SL/TP ayarÄ±).

MÃ¼mkÃ¼nse nicel: â€œqty âˆ’%25 â†’ expectedSlip ~ â‰¤ 15 bpsâ€.

AlÄ±ntÄ±lar/Citations

policy.snapshot.versionId ve path (Ã¶r. limits.maxSlipBps) ile citations[].

Ek olarak knowledge.route.select.top[*].passages[*].cit varsa listeye ekle.

KartlaÅŸtÄ±rma

UI iÃ§in kÄ±sa kart: baÅŸlÄ±k + 1 cÃ¼mlelik gÃ¶vde + 1 baÄŸlantÄ±.

policy.explain.card opsiyoneldir; operatorUIBridge Ã¼zerinden gider.

Ä°dempotency & YayÄ±n

explainKey ile tekrarÄ± Ã¶nle (aynÄ± check/guard iÃ§in).

policy.explain, policy.explain.card?, policy.explain.metrics yayÄ±nla.

6) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
Herhangi bir bounds.check ok=false veya bir guard.directive(modeâ‰ normal) geldiÄŸinde â†’ COMPOSE.

COMPOSE
BaÄŸlamla aÃ§Ä±klama derle; sayÄ±/ÅŸablon/what-if/citations Ã¼ret.
Eksik kritik veri â†’ WARN alert + kÄ±sÄ±tlÄ± aÃ§Ä±klama.

EMIT
policy.explain(â€¦)+card?+metrics â†’ IDLE.

7) Kenar Durumlar

Eski Policy: policyVersion â‰  explain.context.policyVersion â†’ â€œEski sÃ¼rÃ¼mâ€ notu.

Ã‡oklu Ä°hlal: En fazla 3 madde gÃ¶ster; Ã¶nem sÄ±rasÄ±: hard > cost(slippage/spread) > RR > qty/leverage.

PII: metinde PII algÄ±lanÄ±rsa maskele; mask baÅŸarÄ±sÄ±zsa card Ã¼retme, sadece policy.explain yayÄ±nla.

Stale Market: market.refs.ts gÃ¼ncel deÄŸilse â€œpiyasa verisi gecikmiÅŸâ€ maddesi ekle.

Aggressive KapalÄ±: variants.aggressive=false iken â€œagresif neden kapalÄ±?â€ sorusuna kÄ±sa madde: â€œPolicy v42 aggressive=false; guard varsa ayrÄ±ca kÄ±sÄ±tlar.â€

8) UIâ€™ya GÃ¶sterilecek Metin ÅablonlarÄ± (TR)

BaÅŸlÄ±k Ã–rnekleri

Plan neden geÃ§medi? â€” Slip/Spread limitleri

Guard devrede â€” Agresif giriÅŸler kÄ±sÄ±tlÄ±

Madde Ã–rnekleri

Slip p95 â‰ˆ ${got} bps, limit ${limit}.

Spread â‰ˆ ${got} bps (> ${limit}); LIMIT/TWAP Ã¶nerilir.

RR â‰ˆ ${rr} (eÅŸik ${minRR}) â€” sorun yok.

What-If Ã–rnekleri

LIMIT + qty âˆ’%25 + slices=3 ile tekrar deneyin.

Spread â‰¤ ${limit} bps olduÄŸunda MARKET uygun olabilir.

9) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/policyExplainer.ts            // FSM + composer
services/livia/lib/explainCompose.ts         // ÅŸablon motoru + mapping
services/livia/lib/whatIfGenerator.ts        // karÅŸÄ±-durum Ã¼retici
services/livia/lib/citations.ts              // policy path â†’ href
services/livia/state/explainStore.ts         // idem index, last snapshots
services/livia/__tests__/policyExplainer.test.ts
cfg/livia.policyExplainer.yaml               // style/mapping/whatIf ayarlarÄ±

10) Test Ä°skeleti (Jest/Vitest)

Slip & Spread: expected_slip=18>15, spread=85>80 â†’ 2 madde + 1 what-if + citations.

Guard Slowdown: mode=slowdown â†’ guard maddesi eklenir.

RR OK: rrâ‰¥minRR â†’ â€œsorun deÄŸilâ€ maddesi; red nedeni maliyet.

Hard Ihlal: leverage_gt_max â†’ baÅŸlÄ±k â€œhard failâ€, what-if yerine â€œblokâ€ notu.

Eski Policy: version mismatch â†’ â€œEski sÃ¼rÃ¼mâ€ uyarÄ±sÄ±.

Missing Policy: snapshot yok â†’ policy.explain.alert("missing_policy_snapshot") ve sÄ±nÄ±rlÄ± aÃ§Ä±klama.

Idempotency: aynÄ± explainKey ile tekrar Ã¼retim yok.

PII: PII geÃ§en metin â†’ maskeleme Ã§alÄ±ÅŸÄ±r.

11) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

confirmation.bounds.check(ok=false; violations=expected_slip_gt_max, spread_gt_max)

Son policy: v42; guard: slowdown; market spread 85 bps; slip forecast 18 bps.

policy.explain Ã¼ret: 4 madde + 2 what-if + 3 citation.

policy.explain.card â€œPlan neden geÃ§medi?â€ baÅŸlÄ±ÄŸÄ±yla UIâ€™ya gider.

policy.explain.metrics metrikleri gÃ¼nceller.

12) SLO

P95 compose sÃ¼resi < 10 ms (hazÄ±r snapshotlar varsayÄ±mÄ±).

Citations iÃ§eren aÃ§Ä±klama oranÄ± â‰¥ %80.

Kart gÃ¶vdesi â‰¤ 280 karakter; madde sayÄ±sÄ± â‰¤ 5.
_____________________________________________________________________________________________
LIVIA-09 Â· decisionRationaleWriter.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: Verilen/Ã§ekilen kararlar iÃ§in denetlenebilir kÄ±sa gerekÃ§e Ã¼retmek ve zincirlemek.
Kaynaklar: Orchestrator promptu, Guard Q&A sonuÃ§larÄ±, Bounds kontrolleri, Policy aÃ§Ä±klayÄ±cÄ±, Onay kapÄ±sÄ±, Bias/Telemetri.
Ã‡Ä±ktÄ±: â€œkim, neyi, neden, hangi koÅŸullardaâ€ Ã¶zetini tek kart ve audit-ready JSON olarak yayÄ±nla.
Standart: Node18+ / TypeScript / Zod .strict() / ISO-8601 / TZ=Europe/Istanbul / idempotent + audit + metrics.

1) Ä°lkeler

Event-driven; tek giriÅŸle Ã§ok baÄŸlam toplayÄ±p tek gerekÃ§e Ã¼ret.

KÄ±sa & sayÄ±sal: 280â€“400 karakter gÃ¶vde; mÃ¼mkÃ¼nse bps/qty/RR/guard modu rakamlarÄ± olsun.

Kaynak atfÄ±: sources[] ve citations[] (policy path/route link).

Ä°mzalÄ± zincir: prevEventIdHash ile audit chain.

PII: LIVIA-21 (piiRedactor) ile maske.

Ä°dempotency: decisionKey = hash(promptId + decisionId + finalPlan.digest); TTL iÃ§inde tekrar yayÄ±n yok.

2) Girdiler (In) â€” Zod ÅŸema Ã¶rnekleri
{
  "operator.prompt.out": {
    "event":"operator.prompt.out",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "title":"AVAX â€” Base/TWAP Ã¶nerisi",
    "context":{"symbol":"AVAXUSDT","variant":"base","exec":"twap","qty":123.45,"riskUnitUSD":250}
  },

  "guard.question.result": {
    "event":"guard.question.result",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "ok": true,
      "reasons":["slip_tolerance_ok"],
      "recommendation":{"action":"revise","params":{"exec":"limit","qtyFactor":0.75}}
  },

  "confirmation.bounds.check": {
    "event":"confirmation.bounds.check",
    "timestamp":"iso8601",
    "checkId":"dlg-avax-42#v1",
    "symbol":"AVAXUSDT",
    "ok": false,
    "severity":"soft",
    "violations":[{"code":"expected_slip_gt_max","got":18,"limit":15}],
    "derived":{"rr":1.56,"qtyUSD":1219.7}
  },

  "policy.explain": {
    "event":"policy.explain",
    "timestamp":"iso8601",
    "explainKey":"px#dlg-avax-42#v42",
    "kind":"bounds",
    "bullets":[ "Slip p95 â‰ˆ 18 bps, limit 15 bps.", "LIMIT+qty âˆ’%25 ile geÃ§er." ],
    "citations":[{"path":"limits.maxSlipBps","version":"v42","href":"app://kb/policy/limits@v42#c1"}]
  },

  "operator.response.in": {
    "event":"operator.response.in",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "decisionId":"opt-2",
    "payload":{"note":"limit +2bps uygundur"},
    "auth":{"userId":"op-007","roles":["trader"],"sig":"hex"}
  },

  "operator.decision.final": {
    "event":"operator.decision.final",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "decisionId":"opt-2",
    "accepted": true,
    "rationale":"qty -%25",
    "ttlSec": 120,
    "context":{"action":"commit_plan","symbol":"AVAXUSDT","variant":"base","exec":"limit","qty":92.59}
  },

  "action.approved": {
    "event":"action.approved",
    "timestamp":"iso8601",
    "approvalKey":"run-42#commit#dlg-avax-42",
    "action":"commit_plan",
    "payload":{"symbol":"AVAXUSDT","exec":"limit","qty":92.59},
    "by":[{"userId":"op-007","roles":["trader"],"ts":"iso8601"}]
  },

  "livia.bias.weights": {
    "event":"livia.bias.weights",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "overconfidence":0.41,"lossAversion":0.63,"riskSeeking":0.38,"confidence0to1":0.72
  }
}


Not: TÃ¼mÃ¼ opsiyonel deÄŸil. Asgari: operator.decision.final zorunlu; baÄŸlam zenginliÄŸi arttÄ±kÃ§a gerekÃ§e kalitesi artar.

3) Ã‡Ä±ktÄ±lar (Out) â€” Åemalar
{
  "decision.rationale": {
    "event":"decision.rationale",
    "timestamp":"iso8601",
    "decisionKey":"dr#dlg-avax-42#opt-2#3d0a",
    "promptId":"dlg-avax-42",
    "decisionId":"opt-2",
    "accepted": true,
    "summary":"PLAN ONAY: LIMIT + qty âˆ’%25. Slip p95 18>15 bps â€” LIMIT ve parÃ§alama ile maliyet dÃ¼ÅŸÃ¼rme; RRâ‰ˆ1.56 uygun.",
    "details":{
      "finalPlan":{"symbol":"AVAXUSDT","variant":"baseâ†’conservative?","exec":"limit","qty":92.59,"rr":1.56},
      "why":[
        "Bounds: expected_slip_gt_max (18>15 bps)",
        "GQE: revise â†’ exec=limit, qtyÃ—0.75",
        "Policy v42: limits.maxSlipBps=15"
      ],
      "notes":["limit +2bps uygundur"]
    },
    "sources":[
      {"ref":"guard.question.result","id":"q-avax-42-1"},
      {"ref":"confirmation.bounds.check","id":"dlg-avax-42#v1"},
      {"ref":"policy.explain","id":"px#dlg-avax-42#v42"},
      {"ref":"action.approved","id":"run-42#commit#dlg-avax-42"}
    ],
    "citations":[{"path":"limits.maxSlipBps","version":"v42","href":"app://kb/policy/limits@v42#c1"}],
    "biasContext":{"overconfidence":0.41,"lossAversion":0.63,"riskSeeking":0.38,"confidence":0.72},
    "audit":{"eventId":"...","prevEventIdHash":"...","producedBy":"livia-09","producedAt":"iso8601"}
  },

  "decision.rationale.card": {
    "event":"decision.rationale.card",
    "timestamp":"iso8601",
    "title":"Neden LIMIT + miktar âˆ’%25?",
    "body":"Slip 18>15 bps. LIMIT + parÃ§alama ile maliyet azaltÄ±ldÄ±; RRâ‰ˆ1.56 uygun.",
    "links":[{"label":"Policy v42 â€“ Limits","href":"app://kb/policy/limits@v42"}],
    "ttlSec":180,
    "severity":"info|warn|error"
  },

  "decision.rationale.metrics": {
    "event":"decision.rationale.metrics",
    "timestamp":"iso8601",
    "emitted": 21,
    "avgComposeMs": 5,
    "withCitationsRate": 0.88,
    "byOutcome":{"accepted":16,"rejected":3,"fallback":2}
  },

  "decision.rationale.alert": {
    "event":"decision.rationale.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"missing_required_context",
    "context":{"missing":["operator.decision.final"]}
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale: "tr-TR", tz: "Europe/Istanbul" },

  style: {
    maxSummaryChars: 400,
    maxCardChars: 280,
    bulletsMax: 3,
    includeNumbers: true,
    includeBiasContext: true,      // bias Ã¶zetini ekle (kÄ±sa)
    redactPII: true
  },

  mapping: {
    // violation/guard â†’ kÄ±sa cÃ¼mle ÅŸablonlarÄ±
    violations: {
      expected_slip_gt_max: "Slip p95 ${got}>${limit} bps.",
      spread_gt_max: "Spread ${got}>${limit} bps.",
      min_rr_not_met: "RR ${got}<${limit}."
    },
    guards: {
      slowdown: "Guard=slowdown: agresif kÄ±sÄ±tlarÄ± etkin.",
      block_aggressive: "Guard=block_aggressive: agresif kapalÄ±.",
      halt_entry: "Guard=halt_entry: giriÅŸ yok."
    },
    outcomes: {
      accepted: "PLAN ONAY",
      rejected: "PLAN RED",
      fallback: "PLAN FALLBACK"
    }
  },

  chain: { includePrevHash: true },

  idempotencyTtlSec: 900
}

5) Kompozisyon MantÄ±ÄŸÄ± (Pipeline)

BaÄŸlam Topla

operator.decision.final (zorunlu) â†’ outcome, final plan (variant/exec/qty/sl/tp/rr).

Son operator.prompt.out (baÅŸlÄ±k, Ã¶neri), guard.question.result (revise/block/proceed), confirmation.bounds.check (ihlaller), policy.explain (bullets+citations), action.approved|rejected (onay durumu), livia.bias.weights (kÄ±sa baÄŸlam).

Ã–zet Ãœret

mapping.outcomes[outcome] + en fazla 2 ihlal cÃ¼mlesi + 1 Ã§Ã¶zÃ¼m cÃ¼mlesi.

SayÄ±lar: slip/spread/rr/qty varsa dahil et (eÅŸik/karÅŸÄ±laÅŸtÄ±rmalÄ±).

Detay BÃ¶lÃ¼mÃ¼

finalPlan: sembol, varyant (baseâ†’conservative gibi dÃ¶nÃ¼ÅŸÃ¼m belirlenirse), exec, qty, rr (varsa).

why[]: (Ã¶nem sÄ±rasÄ±) hard violations > cost (slip/spread) > policy > guard > gqe recommendation.

OperatÃ¶r notu varsa maks 1 satÄ±r ekle.

Kaynak & AlÄ±ntÄ±

sources[] (event kimlikleri), citations[] (policy path/route link).

Yoksa metin yine Ã¼ret, ama withCitationsRate metriÄŸi dÃ¼ÅŸer.

PII & Uzunluk

Maskeyi uygula â†’ style.maxSummaryChars ve maxCardChars truncate (cÃ¼mle sÄ±nÄ±rÄ±nda kes).

Ä°dempotency & Zincir

decisionKey hesapla; TTL iÃ§inde tekrar yut.

prevEventIdHash ekle (son decision.rationale hashâ€™i).

6) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
operator.decision.final geldi â†’ COLLECT.

COLLECT
Son 60 sn iÃ§indeki ilgili olaylarÄ± topla (prompt, guard, bounds, policy, approval, bias). Eksik kritik â†’ WARN alert + minimal gerekÃ§e. â†’ COMPOSE

COMPOSE
Ã–zet/Detay/Sources/Citations oluÅŸtur, PII mask, uzunluk kÄ±salt. â†’ EMIT

EMIT
decision.rationale + opsiyonel decision.rationale.card + decision.rationale.metrics yayÄ±nla. â†’ IDLE

7) Kenar Durumlar

Timeout Fallback: operator.decision.final.accepted=true ama prompt yanÄ±tÄ± gelmedi â†’ outcome â€œfallbackâ€; Ã¶zet â€œtimeoutâ†’conservative/limit/qtyâˆ’%25â€ gibi.

Reject: accepted=false â†’ ihlaller/guard ana sebep; â€œne deÄŸiÅŸirse geÃ§erâ€ kÄ±sa Ã¶neri.

Contradiction: bounds.ok=true ama policy.explain.kind=bounds â†’ â€œstale dataâ€ notu ekle.

Aggressive KapalÄ±: policy.variants.aggressive=false + aggressive seÃ§ilmiÅŸse â†’ â€œpolicy kapalÄ±ydÄ±â€ madde.

Approval Missing: action.approved yok ama commit_plan gerekiyorsa â†’ â€œpending approvalâ€ notu.

Bias not present: bias yoksa biasContext alanÄ±nÄ± atla.

8) UI ÅablonlarÄ± (TR)

BaÅŸlÄ±k:

Neden LIMIT + miktar âˆ’%25?

Plan reddi â€” RR/Slip sÄ±nÄ±rÄ±

GÃ¶vde (â‰¤280c):

Slip 18>15 bps. LIMIT + parÃ§alama; RRâ‰ˆ1.56 uygun.

RR 1.1<1.2. SL âˆ’5 bps & TP +5 bps ile yeniden deneyin.

9) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/decisionRationaleWriter.ts          // FSM + orchestrasyon
services/livia/lib/rationaleCompose.ts             // Ã¶zet/detay/sayÄ± ÅŸablonlarÄ±
services/livia/lib/sourceCollector.ts              // yakÄ±n olaylarÄ± topla/normalize
services/livia/lib/hashChain.ts                    // prevEventIdHash
services/livia/state/rationaleStore.ts             // idem index + last hashes
services/livia/__tests__/decisionRationaleWriter.test.ts
cfg/livia.rationale.yaml                           // style/mapping/ttl ayarlarÄ±

10) Test Ä°skeleti (Jest/Vitest)

Accept + Revise: bounds slip ihlali + GQE revise â†’ Ã¶zet â€œLIMIT + qty âˆ’%25â€, citations iÃ§erir.

Reject (RR): min_rr_not_met â†’ Ã¶neri â€œSL âˆ’5 & TP +5â€.

Fallback: prompt timeout â†’ â€œfallback conservative/limitâ€ metni.

Approval Link: commit_plan + action.approved var â†’ sources iÃ§inde gÃ¶rÃ¼nÃ¼r.

Idempotency: aynÄ± decisionKey â†’ ikinci yayÄ±n yok.

PII: operatÃ¶r notunda email/telefon â†’ maskelenir.

Contradiction: stale policy/bounds â†’ â€œstale dataâ€ notu.

Bias: biasContext varsa kÄ±sa satÄ±r eklenir, yoksa atlanÄ±r.

11) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

operator.decision.final(accepted=true, exec=limit, qtyÃ—0.75) geldi.

60 sn iÃ§inde: bounds.check(expected_slip_gt_max), policy.explain(slippage), gqe.result(revise).

Kompozisyon â†’ decision.rationale + decision.rationale.card Ã§Ä±ktÄ±; citations eklendi.

uiBridge kartÄ± gÃ¶sterdi; metrics arttÄ±.

12) SLO

P95 compose < 10 ms.

withCitationsRate â‰¥ %80.

Idempotent collision < %0.1 (decisionKey iyi seÃ§ilmiÅŸse).

Ã–zet â‰¤ 400c / Kart â‰¤ 280c ihlal oranÄ± â‰ˆ 0.
______________________________________________________________________________________________
LIVIA-10 Â· sessionMemory.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: Diyalogda geÃ§en kÄ±sa-vade karar slotlarÄ±nÄ± (sembol, varyant, yÃ¼rÃ¼tme tercihi, slip toleransÄ± vb.) gÃ¼venli biÃ§imde tutmak, gÃ¼ncellemek, TTL ile uÃ§urmak ve sorgulanÄ±nca geri vermek. Kapsamlar: operatorId â†’ (global | symbol | promptId). TÃ¼m I/O event-driven JSON, Zod validasyon, idempotent, audit ve metrics standartlÄ±.

1) Standartlar

Dil/YÄ±ÄŸÄ±n: Node 18+, TypeScript, pnpm, Jest/Vitest.

Zaman: ISO-8601; Europe/Istanbul.

Åema: Zod .strict(), tÃ¼m sayÄ±lar finite().

GÃ¼venlik: Inbound auth {userId, roles, sig} doÄŸrulamasÄ±; RBAC: sadece kendi hafÄ±zasÄ±nÄ± yaz/oku.

Gizlilik: classification:"SENSITIVE_LOW"; PII alanlarÄ± (serbest not) maskele (LIVIA-21 ile).

Ä°dempotency: AynÄ± eventId|sourceHash tekrarÄ±nda ikinci yazÄ±m yok (TTL iÃ§inde).

Telemetri: session.memory.metrics; UyarÄ±: session.memory.alert.

2) HafÄ±za Modeli (slot setleri)

Slot adlarÄ± ve tipleri (Ã¶rn.)

type Slots = {
  symbol?: string;                  // "AVAXUSDT"
  variant?: "base"|"aggressive"|"conservative";
  execPref?: "market"|"limit"|"twap"|"iceberg"|"post_only";
  slipTolBps?: number;              // 0..50
  spreadTolBps?: number;            // 0..200
  qtyPref?: number;                 // son onaylanan miktar (lot)
  qtyFactor?: number;               // 0.25..1.5 (gqe revise Ã¶nerisi)
  rrMin?: number;                   // min risk/reward (Ã¶rn. 1.2)
  slices?: number;                  // twap/iceberg parÃ§a sayÄ±sÄ±
  notes?: string;                   // kÄ±sa not (PII mask)
};


Kapsam (scope)

scope="dialog" â†’ promptIdâ€™e baÄŸlÄ± hÄ±zlÄ± deÄŸiÅŸkenler (TTL kÄ±sa).

scope="symbol" â†’ aynÄ± sembol iÃ§in alÄ±ÅŸkanlÄ±klar.

scope="global" â†’ operatÃ¶rÃ¼n genel tercihleri.

Kaynak Ã¶nceliÄŸi (merge priority, yÃ¼ksek â†’ dÃ¼ÅŸÃ¼k):
operator.response.in > operator.answer.in > guard.question.result.recommendation > confirmation.bounds.check.derived > operator.decision.context.

3) Girdiler (In) â€” Zod ÅŸemalarÄ± (Ã¶rnekler)
{
  "operator.decision.context": {
    "event":"operator.decision.context",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "symbol":"AVAXUSDT",
    "variant":"base",
    "exec":"twap",
    "qty":123.45,
    "slBps":45,"tpBps":70
  },

  "operator.response.in": {
    "event":"operator.response.in",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "decisionId":"opt-2|custom",
    "payload":{"note":"limit +2bps", "exec":"limit", "qtyFactor":0.75},
    "auth":{"userId":"op-007","roles":["trader"],"sig":"hex"}
  },

  "operator.answer.in": {
    "event":"operator.answer.in",
    "timestamp":"iso8601",
    "qId":"q-avax-42-1",
    "answer":"value|yes|no|option",
    "value":18,
    "unit":"bps|null",
    "auth":{"userId":"op-007","sig":"hex"}
  },

  "guard.question.result": {
    "event":"guard.question.result",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "recommendation":{"action":"revise","params":{"exec":"limit","qtyFactor":0.75,"slices":3}}
  },

  "confirmation.bounds.check": {
    "event":"confirmation.bounds.check",
    "timestamp":"iso8601",
    "checkId":"dlg-avax-42#v1",
    "symbol":"AVAXUSDT",
    "ok":true,
    "derived":{"rr":1.56}
  },

  "session.memory.upsert": {
    "event":"session.memory.upsert",
    "timestamp":"iso8601",
    "scope":"global|symbol|dialog",
    "promptId":"dlg-avax-42",
    "symbol":"AVAXUSDT",
    "slots":{"slipTolBps":15,"execPref":"limit"},
    "auth":{"userId":"op-007","sig":"hex"}
  },

  "session.memory.get": {
    "event":"session.memory.get",
    "timestamp":"iso8601",
    "scope":"auto|global|symbol|dialog",
    "promptId":"dlg-avax-42",
    "symbol":"AVAXUSDT",
    "keys":["symbol","variant","execPref","slipTolBps"],
    "auth":{"userId":"op-007","sig":"hex"}
  },

  "session.memory.clear": {
    "event":"session.memory.clear",
    "timestamp":"iso8601",
    "scope":"dialog|symbol|global",
    "promptId":"dlg-avax-42",
    "symbol":"AVAXUSDT",
    "keys":["notes"],
    "auth":{"userId":"op-007","sig":"hex"}
  }
}

4) Ã‡Ä±ktÄ±lar (Out) â€” Åemalar
{
  "session.memory.updated": {
    "event":"session.memory.updated",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "scope":"dialog|symbol|global",
    "promptId":"dlg-avax-42",
    "symbol":"AVAXUSDT",
    "slots":{"execPref":"limit","slipTolBps":18,"qtyFactor":0.75,"slices":3},
    "ttlSec":1800,
    "audit":{"eventId":"...","producedBy":"livia-10","producedAt":"iso8601"}
  },

  "session.memory.snapshot": {
    "event":"session.memory.snapshot",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "scopes": {
      "dialog":{"promptId":"dlg-avax-42","slots":{"symbol":"AVAXUSDT","execPref":"limit"}},
      "symbol":{"AVAXUSDT":{"slots":{"variant":"conservative","slipTolBps":15}}},
      "global":{"slots":{"rrMin":1.2}}
    },
    "expiresAt":"iso8601"
  },

  "session.memory.queryResult": {
    "event":"session.memory.queryResult",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "scopeUsed":"dialogâ†’symbolâ†’global",   // Ã§Ã¶zÃ¼m sÄ±rasÄ±
    "slots":{"symbol":"AVAXUSDT","variant":"conservative","execPref":"limit","slipTolBps":15}
  },

  "session.memory.alert": {
    "event":"session.memory.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"rbac_forbidden|invalid_slot|ttl_expired|idem_duplicate",
    "context":{"scope":"global","key":"notes"}
  },

  "session.memory.metrics": {
    "event":"session.memory.metrics",
    "timestamp":"iso8601",
    "upserts":32,"gets":44,"clears":5,
    "hitRate":0.78,"gcEvictions":6,"avgLatencyMs":1.8
  }
}

5) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  ttl: {
    dialogSec: 1800,   // 30 dk
    symbolSec: 86400,  // 24 saat
    globalSec: 604800  // 7 gÃ¼n
  },

  limits: {
    maxSymbolsPerUser: 50,
    maxNotesLen: 240,
    maxSlotsPerScope: 20
  },

  merge: {
    // yÃ¼ksek â†’ dÃ¼ÅŸÃ¼k Ã¶ncelik (yukarÄ±da)
    priority: ["operator.response.in","operator.answer.in","guard.question.result","confirmation.bounds.check","operator.decision.context"],
    lastWriteWins: true,
    clamp: {
      slipTolBps: [0,50],
      spreadTolBps: [0,200],
      qtyFactor: [0.25,1.5],
      rrMin: [1.0,5.0],
      slices: [1,12]
    }
  },

  security: {
    verifySignature: true,
    rbac: { read:["trader","ops","policy"], write:["trader","ops"] }
  },

  storage: {
    kind: "inMemoryWithSnapshot",   // memory + periyodik JSON snapshot
    snapshotEverySec: 300,
    path: "data/sessionMemory.json"
  },

  idempotencyTtlSec: 600
}

6) Boru HattÄ± (Upsert/Get/Clear) â€” Algoritma
A) Upsert (kaydet/gÃ¼ncelle)

Kaynak normalizasyonu: Etkin alanlarÄ± slotlara eÅŸle (Ã¶rn. operator.answer.in.value â†’ slipTolBps).

Clamp & tip kontrolÃ¼: merge.clamp sÄ±nÄ±rlarÄ±nÄ± uygula, tip uyumsuzsa alert(invalid_slot).

Kapsam seÃ§imi:

session.memory.upsert.scope varsa onu kullan.

Yoksa heuristik: promptId varsa â†’ dialog; yalnÄ±z symbol geliyorsa â†’ symbol; aksi â†’ global.

Idempotency: AynÄ± sourceHash (eventId/sha256 body) tekrarÄ±na yazma.

Merge: merge.priority sÄ±rasÄ±na gÃ¶re gelen deÄŸerler Ã¼stte, mevcutla birleÅŸtir; lastWriteWins aynÄ± seviyede Ã¼stteki.

PII: notes maskelenir ve limits.maxNotesLenâ€™e kesilir.

Expire ayarla: scope TTLâ€™ine gÃ¶re expiresAt gÃ¼ncelle.

Emit: session.memory.updated.

B) Get (sorgu)

RBAC & auth doÄŸrulamasÄ±.

scope="auto" ise Ã§Ã¶zÃ¼m sÄ±rasÄ±: dialog(promptId) â†’ symbol(symbol) â†’ global.

Ä°lgili slotlar TTLâ€™e gÃ¶re geÃ§erliyse topla; yoksa bir alt kapsama dÃ¼ÅŸ.

Emit: session.memory.queryResult + istenirse tÃ¼m resmi session.memory.snapshot.

C) Clear (sil)

RBAC & auth.

Belirtilen keys[] veya tÃ¼mÃ¼; notes gibi PII alanlar Ã¶ncelikli silinir.

Emit: session.memory.updated (boÅŸaltÄ±lmÄ±ÅŸ alanlarla) + alert(info,"cleared").

D) GC (Ã§Ã¶p toplayÄ±cÄ±)

Periyodik: sÃ¼resi biten entryâ€™leri sil; metrics.gcEvictions++.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
operator.* | guard.* | confirmation.* | session.memory.* geldikÃ§e ROUTE.

ROUTE
Event tÃ¼rÃ¼ne gÃ¶re UPSERT / GET / CLEAR dallarÄ±.

UPSERT
Slot Ã§Ä±kar â†’ merge â†’ TTL â†’ memory.updated.

GET
Ã‡Ã¶zÃ¼m sÄ±rasÄ± â†’ memory.queryResult (ve/veya snapshot).

CLEAR
Silme â†’ memory.updated.

DÃ¶nÃ¼ÅŸ: IDLE.

8) Slot EÅŸleme KurallarÄ± (Ã¶rnek tablo)
Kaynak Olay	Slot	DÃ¶nÃ¼ÅŸÃ¼m/Not
operator.decision.context.exec	execPref	doÄŸrudan
operator.decision.context.symbol	symbol	doÄŸrudan
operator.response.in.payload.exec	execPref	override
operator.response.in.payload.qtyFactor	qtyFactor	clamp 0.25..1.5
operator.answer.in (unit=bps)	slipTolBps	valueâ†’int
guard.question.result.params.slices	slices	min 1
confirmation.bounds.check.derived.rr	rrMin	floor(1.d)

GeliÅŸtirilebilir: spreadTolBps, post_only, iceberg.slices vb.

9) Kenar Durumlar

Ã‡akÄ±ÅŸan sembol: dialog slotunda symbol deÄŸiÅŸirse eski dialog entry expire edilir.

AÅŸÄ±rÄ± sembol sayÄ±sÄ±: limits.maxSymbolsPerUser aÅŸÄ±ldÄ± â†’ en eski symbol scope kayÄ±tlarÄ± atÄ±lÄ±r (alert(warn,"symbol_evicted")).

BoÅŸ/GeÃ§ersiz slot: deÄŸer NaN|âˆ|out-of-range â†’ gÃ¼ncelleme reddi + alert(warn,"invalid_slot").

Stale dialog: promptId yoksa dialog scopeâ€™a yazma.

RBAC: policy rolÃ¼ write edemez (sadece read).

Clock drift: timestamp Ã§ok eski/gelecek â†’ yine kabul (hafÄ±za), auditâ€™e not dÃ¼ÅŸ.

10) Telemetri
{
  "session.memory.metrics": {
    "event":"session.memory.metrics",
    "timestamp":"iso8601",
    "upserts": 32,
    "gets": 44,
    "clears": 5,
    "hitRate": 0.78,
    "gcEvictions": 6,
    "avgLatencyMs": 1.8,
    "byScope": {"dialog":18,"symbol":15,"global":3}
  }
}

11) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/sessionMemory.ts               // FSM + router
services/livia/lib/slotExtract.ts             // eventâ†’slot eÅŸleyici
services/livia/lib/mergeRules.ts              // Ã¶ncelik/clamp/lastWriteWins
services/livia/lib/authRbac.ts                // auth + RBAC
services/livia/lib/piiMask.ts                 // notes maskeleme
services/livia/state/sessionStore.ts          // in-memory + snapshot + TTL index
services/livia/__tests__/sessionMemory.test.ts
cfg/livia.sessionMemory.yaml                  // ttl/limits/merge/security/storage

12) Test Ä°skeleti (Jest/Vitest)

Upsert Merge Ã–nceliÄŸi: context.exec=twap â†’ sonra response.exec=limit â†’ sonuÃ§ execPref=limit.

Answerâ†’Slot: answer.value=18 (bps) â†’ slipTolBps=18 (clamp & int).

GQE Revise: qtyFactor=0.75,slices=3 kaydolur; TTL dolunca silinir.

Get Auto Scope: dialog yoksa symbolâ†’global Ã§Ã¶zÃ¼mÃ¼ Ã§alÄ±ÅŸÄ±r.

Clear: notes silinince updated + alert(info).

GC: sÃ¼re dolan dialog kayÄ±tlarÄ± temizlenir; gcEvictions artar.

RBAC: policy rolÃ¼ upsert edemez (403).

Idempotency: aynÄ± sourceHash ikinci kez yazÄ±lmaz.

Limits: notes uzunluÄŸu >240 â†’ kesilir ve PII maskesi uygulanÄ±r.

13) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

operator.decision.context(symbol=AVAX, exec=twap) â†’ dialog slot: symbol, execPref=twap.

operator.answer.in(value=18 bps) â†’ slipTolBps=18.

guard.question.result(revise: exec=limit, qtyFactor=0.75, slices=3) â†’ override.

operator.response.in(payload.exec=limit) â†’ final execPref=limit.

session.memory.get(scope=auto, symbol=AVAX) â†’ execPref=limit, slipTolBps=18, qtyFactor=0.75.

30 dk sonra dialog TTL biter; symbol scope kayÄ±tlarÄ± kalÄ±r.

14) SLO

P95 upsert/get < 2 ms (in-memory).

Hit rate â‰¥ %70 (auto scope Ã§Ã¶zÃ¼mÃ¼nde).

GC drift < Â±5 s (snapshot/GC dÃ¶ngÃ¼sÃ¼).
______________________________________________________________________________________________
LIVIA-11 Â· operatorNoteTaker.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: Diyalog/iÅŸlem sÄ±rasÄ±nda oluÅŸan sinyallerden insan okunur seans notlarÄ± ve eylem maddeleri (action items) Ã¼retmek; bunlarÄ± Markdown dosyalarÄ±na (session ve daily) gÃ¼venli ÅŸekilde yazmak, gerekirse kÄ±sa Ã¶zet Ã¼retmek ve UIâ€™ya kart olarak yollamak. TÃ¼m I/O event-driven JSON, Zod validasyon, Europe/Istanbul, idempotent + audit + metrics standartlÄ±.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest.

Zod .strict() ile tÃ¼m In/Out ÅŸemalarÄ±.

Zaman: ISO-8601, TZ=Europe/Istanbul.

Gizlilik: classification:"SENSITIVE_LOW"; PII maskeleme (LIVIA-21) â†’ dosyaya maskeli yaz.

Ä°dempotency: her not satÄ±rÄ± iÃ§in noteKey = sha256(normalize(line)+sessionId); TTL iÃ§inde yineleneni yazma.

Telemetri: notes.metrics; uyarÄ±lar: notes.alert.

Dosya gÃ¼venliÄŸi: atomic write (tempâ†’rename), process-wide lock; satÄ±r formatÄ± Append-only.

2) Girdiler (In) â€” Zod ÅŸema Ã¶rnekleri
{
  "decision.rationale": {
    "event":"decision.rationale",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "decisionId":"opt-2",
    "accepted":true,
    "summary":"PLAN ONAY: LIMIT + qty âˆ’%25â€¦",
    "details":{"finalPlan":{"symbol":"AVAXUSDT","exec":"limit","qty":92.59,"rr":1.56},"why":["expected_slip_gt_max"]},
    "biasContext":{"overconfidence":0.41},
    "audit":{"eventId":"..."}
  },

  "policy.explain": {
    "event":"policy.explain",
    "timestamp":"iso8601",
    "kind":"bounds|guard|variant|policy_change",
    "title":"Neden reddedildi? â€” Slip...",
    "bullets":["Slip p95 18>15 bps","LIMIT Ã¶nerisi"],
    "citations":[{"path":"limits.maxSlipBps","version":"v42"}],
    "context":{"symbol":"AVAXUSDT","guardMode":"slowdown"}
  },

  "approval.pending": {
    "event":"approval.pending",
    "timestamp":"iso8601",
    "approvalKey":"run-42#failover#exA-sec-1",
    "action":"failover",
    "needed":{"quorum":2,"of":2}
  },

  "action.approved": {
    "event":"action.approved",
    "timestamp":"iso8601",
    "action":"commit_plan",
    "payload":{"symbol":"AVAXUSDT","exec":"limit","qty":92.59},
    "by":[{"userId":"op-007","roles":["trader"]}]
  },

  "incident.started": {
    "event":"incident.started",
    "timestamp":"iso8601",
    "id":"inc-2025-09-13-1",
    "severity":"high",
    "title":"Slip spike on SG02",
    "tags":["slip","latency"]
  },

  "incident.closed": {
    "event":"incident.closed",
    "timestamp":"iso8601",
    "id":"inc-2025-09-13-1",
    "resolution":"policy rollback v42â†’v41",
    "durationMin":37
  },

  "telemetry.anomaly.signal": {
    "event":"telemetry.anomaly.signal",
    "timestamp":"iso8601",
    "series":"order.slip.p95",
    "kind":"spike",
    "severity":"high"
  },

  "operator.note.add": {
    "event":"operator.note.add",
    "timestamp":"iso8601",
    "sessionId":"sess-avax-42",
    "text":"Limit +2 bps uygundur, TWAP yerine 3 slice limit deneyelim.",
    "auth":{"userId":"op-007","sig":"hex"}
  }
}


Not: Girdiler opsiyoneldir; en az bir kaynak geldiÄŸinde seans defterine uygun satÄ±r Ã¼ret.

3) Ã‡Ä±ktÄ±lar (Out) â€” Åemalar
{
  "operator.notes.append": {
    "event":"operator.notes.append",
    "timestamp":"iso8601",
    "sessionId":"sess-avax-42",
    "lines":[
      {
        "ts":"iso8601",
        "kind":"decision",
        "text":"PLAN ONAY: AVAX LIMIT + qty âˆ’%25; RRâ‰ˆ1.56. GerekÃ§e: slip 18>15 bps â†’ LIMIT.",
        "tags":["decision","avax","limit","slip"],
        "source":"decision.rationale",
        "noteKey":"sha256:..."
      },
      {
        "ts":"iso8601",
        "kind":"action",
        "text":"EYLEM: `limits.maxSlipBps` v42 gÃ¶zden geÃ§ir (Ã¶neri: 18â†’15), sorumlu: policy-team, sÃ¼re: 24s.",
        "tags":["action","policy"],
        "due":"2025-09-14T18:00:00+03:00",
        "owner":"policy-team",
        "noteKey":"sha256:..."
      }
    ],
    "audit":{"eventId":"...","producedBy":"livia-11","producedAt":"iso8601"}
  },

  "notes.session.md": {
    "event":"notes.session.md",
    "timestamp":"iso8601",
    "path":"data/notes/2025-09-13/sess-avax-42.md",
    "sizeBytes": 2480,
    "summary":"AVAX seansÄ±: plan onayÄ± (limit -%25), guard=slowdown; 1 eylem, 0 bekleyen onay."
  },

  "notes.daily.md": {
    "event":"notes.daily.md",
    "timestamp":"iso8601",
    "path":"data/notes/2025-09-13/Daily.md",
    "summary":"GÃ¼nlÃ¼k Ã¶zet: 3 karar, 1 incident (37 dk), 2 onay, 3 eylem.",
    "counts":{"decision":3,"incident":1,"approval":2,"action":3}
  },

  "notes.card": {
    "event":"notes.card",
    "timestamp":"iso8601",
    "title":"Seans notu gÃ¼ncellendi (AVAX)",
    "body":"Limit + qty âˆ’%25 onaylandÄ±. 1 eylem: slip limiti gÃ¶zden geÃ§ir (24s).",
    "severity":"info",
    "ttlSec":180
  },

  "notes.alert": {
    "event":"notes.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"write_failed|pii_redact_failed|idem_duplicate|lock_timeout",
    "context":{"path":"data/notes/...md"}
  },

  "notes.metrics": {
    "event":"notes.metrics",
    "timestamp":"iso8601",
    "appends":14,"sessions":3,"dailyRollups":1,
    "avgAppendMs":2.7,"writeErrors":0,"dedupeRate":0.18
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul", dateFmt:"YYYY-MM-DD HH:mm" },

  storage: {
    rootDir: "data/notes",
    sessionFilePattern: "{YYYY-MM-DD}/sess-{symbol}-{hash(promptId)}.md",
    dailyFilePattern:  "{YYYY-MM-DD}/Daily.md",
    atomicWrite: true,
    lockTimeoutMs: 3000
  },

  compose: {
    maxLineLen: 160,
    includeBiasMini: true,     // biasContext varsa "bias: OC=0.41" gibi kÄ±sa ek
    includeCitations: true,    // policy path/versiyon kÄ±sa notu
    tagRules: {                // otomatik etiketler
      decision: ["decision","limit","twap","qty","rr"],
      incident: ["incident","slip","latency","rollback"],
      approval: ["approval","quorum","failover"],
      action: ["action","owner","due"]
    }
  },

  actionHeuristics: {
    // satÄ±r/metadan eylem Ã§Ä±karÄ±mÄ±
    fromPolicyExplain: [
      { ifContains:["LIMIT Ã¶nerisi"], then:"UYGULAMA: planÄ± LIMIT ile yeniden deÄŸerlendir", owner:"ops", dueHours:4 }
    ],
    fromDecision: [
      { ifContains:["RR<"], then:"SL/TP parametreleri tekrar ayarla", owner:"trader", dueHours:2 }
    ],
    fromIncident: [
      { always:true, then:"Postmortem taslaÄŸÄ±nÄ± baÅŸlat", owner:"ops", dueHours:12 }
    ]
  },

  pii: {
    enabled: true,
    fields:["text"],
    maskWith:"***"
  },

  rollup: {
    sessionToDaily: true,
    dailyRunAt: "18:05",     // Europe/Istanbul
    emptyDayNote: "Olay yok / normal operasyon."
  },

  idempotencyTtlSec: 900
}

5) Ã‡Ä±karma & Kompozisyon (Pipeline)

Kaynak Toplama

Son 90 sn iÃ§indeki ilgili olaylarÄ± memoryâ€™de tut (rationale, policy.explain, approval., incident., anomaly).

sessionId Ã§Ã¶z: promptId varsa sess-{symbol}-{hash(promptId)}; yoksa sess-generic-{date}.

SatÄ±r Ãœretimi (line builders)

decision.rationale â†’ decision: sembol, exec, qty, RR, ana gerekÃ§e; bias mini (OC=0.41 gibi) opsiyonel.

policy.explain â†’ info/action: ihlal/guard Ã¶zetini info; whatIf/Ã¶neri varsa action maddesi Ã§Ä±kar.

approval.pending/approved/rejected â†’ approval: â€œFailover 2/2 bekleniyor/OnaylandÄ±/Reddedildi (nedenâ€¦)â€.

incident.started/closed â†’ incident: baÅŸlÄ±k, ÅŸiddet, sÃ¼re/Ã§Ã¶zÃ¼m.

anomaly.signal â†’ info: â€œSlip p95 spike (high)â€.

Eylem (Action) Ã‡Ä±karÄ±mÄ±

actionHeuristics kurallarÄ±nÄ± sÄ±rayla uygula; due = now + dueHours.

Sahip (owner) belirlenemiyorsa owner:"ops".

SatÄ±r Normalizasyonu

TR kÄ±sa; compose.maxLineLen Ã¼stÃ¼nÃ¼ cÃ¼mle sÄ±nÄ±rÄ±nda kes.

PII maskesi uygula.

tags[] otomatik Ã¼ret (symbol, exec, rr, slip vs.).

noteKey hesapla; idem kontrol.

YazÄ±m

Session .md dosyasÄ±na append (atomic).

Gerekirse daily rollup kuyruÄŸuna iÅŸaret bÄ±rak (scheduler saati gelince Ã§alÄ±ÅŸÄ±r).

Kart

Ã–nemli satÄ±rlarda (decision, action, incident) notes.card Ã¼ret; operatorUIBridgeâ€™e gidecek.

6) Markdown FormatÄ±

Session dosyasÄ± (sess-avax-42.md) Ã¶rnek:

---
sessionId: sess-avax-42
symbol: AVAXUSDT
startedAt: 2025-09-13T15:42:10+03:00
tags: [avax, trading]
---

### 15:43 PLAN
PLAN ONAY: AVAX LIMIT + qty âˆ’%25; RRâ‰ˆ1.56. GerekÃ§e: slip 18>15 bps â†’ LIMIT. {tags: decision, avax, limit, slip}

### 15:44 POLICY
Slip p95 18>15 bps; LIMIT Ã¶nerisi. (v42/limits.maxSlipBps) {tags: info, policy}

### 15:45 ACTION
`limits.maxSlipBps` v42 gÃ¶zden geÃ§ir; sorumlu: policy-team; son tarih: 2025-09-14 18:00. {tags: action, policy}


Daily dosyasÄ± (YYYY-MM-DD/Daily.md) baÅŸlÄ±klarÄ±:

Kararlar, Onaylar, Olaylar, Eylemler, Notlar; toplam sayÄ±lar ve kÄ±sa Ã¶zet.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
Her In olayÄ±nda COLLECT.

COLLECT
OlayÄ± normalize et, PII mask, satÄ±r adaylarÄ± oluÅŸtur â†’ APPEND.

APPEND
Lock al â†’ session.mdâ€™ye append â†’ operator.notes.append + notes.session.md (path + kÄ±sa Ã¶zet) â†’ lock bÄ±rak.
EÄŸer gÃ¼nlÃ¼k saatine yaklaÅŸÄ±ldÄ±ysa â†’ ROLLUP.

ROLLUP
GÃ¼nlÃ¼k dosyasÄ±nÄ± Ã¼ret/gÃ¼ncelle â†’ notes.daily.md.
DÃ¶nÃ¼ÅŸ: IDLE.

8) Kenar Durumlar

Ä°dempotent Ã§akÄ±ÅŸma: aynÄ± noteKey ikinci kez â†’ yut + notes.alert(info,"idem_duplicate").

Lock Timeout: 3 snâ€™de lock alÄ±namazsa retry (3 kez, jitter); baÅŸarÄ±sÄ±z â†’ write_failed.

PII mask hatasÄ±: maskeleme baÅŸarÄ±sÄ±z â†’ satÄ±rÄ± yazma, alert Ã¼ret.

BÃ¼yÃ¼k dosya (>1MB/gÃ¼n): otomatik segment (Daily_part2.md) ve index ekle.

Eksik context (symbol/promptId yok): sess-generic-{date} altÄ±nda yaz, tags minimal.

Saat taÅŸmasÄ± (UTC/Istanbul farkÄ±): dosya yolu local date ile hesaplanÄ±r.

9) Telemetri
{
  "notes.metrics": {
    "event":"notes.metrics",
    "timestamp":"iso8601",
    "appends": 14,
    "sessions": 3,
    "dailyRollups": 1,
    "avgAppendMs": 2.7,
    "writeErrors": 0,
    "dedupeRate": 0.18,
    "byKind": {"decision":6,"action":3,"approval":2,"incident":1,"info":2}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/operatorNoteTaker.ts           // FSM + orchestrasyon
services/livia/lib/noteBuilders.ts            // eventâ†’satÄ±r Ã¼reticileri
services/livia/lib/actionExtractor.ts         // heuristik eylem Ã§Ä±karÄ±mÄ±
services/livia/lib/piiMask.ts                 // LIVIA-21 entegrasyon
services/livia/lib/mdWriter.ts                // atomic append + lock
services/livia/lib/rollup.ts                  // gÃ¼nlÃ¼k Ã¶zet Ã¼retimi
services/livia/state/notesStore.ts            // idem index + dosya index
services/livia/__tests__/operatorNoteTaker.test.ts
cfg/livia.notes.yaml                           // storage/compose/heuristics

11) Test Ä°skeleti (Jest/Vitest)

Decisionâ†’SatÄ±r: rationaleâ€™dan doÄŸru TR kÄ±sa satÄ±r, tags & qty/RR dahil.

Explainâ†’Action: what-if iÃ§eren explainâ€™den eylem Ã§Ä±karÄ±mÄ± + due hesap.

Approval Flow: pendingâ†’approved iki satÄ±r ve kart Ã¼retimi.

Incident Lifecycle: startedâ†’closed satÄ±rlarÄ± ve gÃ¼nlÃ¼k Ã¶zet artÄ±ÅŸÄ±.

PII Mask: e-posta/telefon iÃ§eren operator.note.add satÄ±rÄ±nda maske.

Atomic Write: eÅŸzamanlÄ± 3 append â†’ tekil, bozulmamÄ±ÅŸ dosya.

Idempotency: aynÄ± rationale tekrar geldiÄŸinde ikinci yazÄ±m yok.

Rollup: gÃ¼n sonu Ã§alÄ±ÅŸÄ±nca Daily.md oluÅŸur, counts doÄŸru.

Large File Segment: >1MB olduÄŸunda segment & index.

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

decision.rationale (accepted, LIMIT, qtyÃ—0.75) â†’ session.mdâ€™ye â€œPLAN ONAYâ€¦â€ satÄ±rÄ± yazÄ±lÄ±r + notes.card.

ArdÄ±ndan policy.explain (LIMIT Ã¶nerisi) â†’ info + action satÄ±rlarÄ±; eylem sahibi policy-team, due 24s.

approval.pending â†’ â€œFailover 2/2 bekleniyorâ€; action.approved â†’ â€œOnaylandÄ±â€ satÄ±rÄ±.

incident.started ve sonra incident.closed â†’ incident satÄ±rlarÄ±; gÃ¼n sonunda Daily.md gÃ¼ncellenir.

13) SLO

Append P95 < 5 ms (disk cache varsayÄ±mÄ±).

Write error oranÄ± < %0.5.

Dedupe (idem) â‰¥ %10 (aynÄ± olay spamâ€™inde).

Daily rollup saatinden sonra â‰¤ 30 sn iÃ§inde hazÄ±r.
_____________________________________________________________________________________________
LIVIA-12 Â· promptTemplateRegistry.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: Soru/Ã¶neri/rapor/karteÅŸli tÃ¼m metin ÅŸablonlarÄ±nÄ± sÃ¼rÃ¼mlÃ¼ ve Ã§ok dilli bir kayÄ±t defterinde tutmak; doÄŸrulamak, Ã¶nizlemek, getirmek, silmek/deprecate etmek ve kataloglamak. Åablon deÄŸiÅŸimleri audit-ready; deÄŸiÅŸkenler tipli (Zod), i18n eÅŸitliÄŸi zorunlu, compliance filtreli. DiÄŸer modÃ¼ller (LIVIA-01/06/07/08/09/25/31) buradan tÃ¼ketir.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest.

Event-driven JSON I/O, tÃ¼m payloadlar Zod .strict().

TZ: Europe/Istanbul; timestamp ISO-8601.

Ä°dempotency: tplKey = id + kind + version + locale; aynÄ± iÃ§erik checksum ile dedupe.

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC (yazma: policy/ops, okuma: tÃ¼m tÃ¼keticiler).

Gizlilik/Compliance: PII sÄ±zÄ±ntÄ±sÄ±na ve yasaklÄ± terimlere karÅŸÄ± iÃ§ denetim (LIVIA-20/21 ile uyumlu).

Dil: TR/EN paralel; deÄŸiÅŸken kÃ¼mesi tÃ¼m dillerde aynÄ± olmak zorunda.

2) Åablon Modeli

TemplateHeader

{
  id: string,                      // benzersiz kÄ±sa ad (kebab-case)
  kind: "prompt"|"question"|"report"|"card"|"explain"|"rationale",
  version: "semver",               // "1.2.0"
  locale: "tr-TR"|"en-US",
  tags?: string[],                 // "guard","slip","approval"â€¦
  owners: string[],                // ekip/kiÅŸiler
  visibility: string[],            // "ops","trader","policy"
  deprecated?: boolean
}


TemplateBody

{
  engine: "handlebars"|"mustache",
  body: string,                    // metin gÃ¶vdesi
  variables: Array<{
    name: string,                  // {{name}}
    type: "string"|"number"|"int"|"boolean"|"enum"|"json",
    required: boolean,
    enumValues?: string[],
    default?: any,
    description?: string
  }>,
  constraints?: {
    maxChars?: number,             // Ã¶rn. card â‰¤ 280
    forbid?: string[],             // yasak kelimeler
    require?: string[]             // zorunlu kelimeler
  },
  examples?: Array<{ input:any, preview?:string }>
}


TemplateRecord = Header + Body + metadata

{
  header: TemplateHeader,
  body: TemplateBody,
  checksum: "sha256:â€¦",
  createdBy: { userId:string, ts:string },
  updatedBy?: { userId:string, ts:string },
  lineage?: { previous?: string }, // "1.1.0"
}

3) Girdiler (In) â€” Zod ÅŸemalarÄ± (Ã¶rnekler)
{
  "template.upsert": {
    "event":"template.upsert",
    "timestamp":"iso8601",
    "template": {
      "header": {
        "id":"entry-limit-revise",
        "kind":"prompt",
        "version":"1.0.0",
        "locale":"tr-TR",
        "tags":["entry","limit","revise"],
        "owners":["ops"],
        "visibility":["trader","ops"]
      },
      "body": {
        "engine":"handlebars",
        "body":"{{symbol}} â€” LIMIT giriÅŸ: qty {{qty}} (Ã—{{qtyFactor}}), SL {{slBps}} bps, TP {{tpBps}} bps. Onaylar mÄ±sÄ±n?",
        "variables":[
          {"name":"symbol","type":"string","required":true},
          {"name":"qty","type":"number","required":true},
          {"name":"qtyFactor","type":"number","required":false,"default":1.0},
          {"name":"slBps","type":"int","required":true},
          {"name":"tpBps","type":"int","required":true}
        ],
        "constraints":{"maxChars":280}
      }
    },
    "auth":{"userId":"op-011","roles":["ops"],"sig":"hex"}
  },

  "template.delete": {
    "event":"template.delete",
    "timestamp":"iso8601",
    "id":"entry-limit-revise",
    "version":"1.0.0",
    "locale":"tr-TR",
    "mode":"soft|hard",    // soft=deprecated, hard=kalÄ±cÄ± sil
    "auth":{"userId":"op-011","roles":["ops"],"sig":"hex"}
  },

  "template.get": {
    "event":"template.get",
    "timestamp":"iso8601",
    "id":"entry-limit-revise",
    "version":"1.0.0|latest",
    "locale":"tr-TR|auto",
    "auth":{"userId":"op-007","roles":["trader"],"sig":"hex"}
  },

  "template.render.request": {
    "event":"template.render.request",
    "timestamp":"iso8601",
    "id":"entry-limit-revise",
    "version":"1.0.0|latest",
    "locale":"tr-TR|en-US|auto",
    "input":{"symbol":"AVAXUSDT","qty":92.59,"qtyFactor":0.75,"slBps":45,"tpBps":70},
    "validateOnly": false,
    "auth":{"userId":"op-007","roles":["trader"],"sig":"hex"}
  },

  "i18n.switch.notice": {
    "event":"i18n.switch.notice",
    "timestamp":"iso8601",
    "prefer":"tr-TR|en-US",
    "userId":"op-007"
  }
}

4) Ã‡Ä±ktÄ±lar (Out) â€” Åemalar
{
  "template.upsert.ok": {
    "event":"template.upsert.ok",
    "timestamp":"iso8601",
    "tplKey":"entry-limit-revise#1.0.0#tr-TR",
    "checksum":"sha256:â€¦",
    "warnings":["en-US karÅŸÄ±lÄ±ÄŸÄ± eksik â€” parity uyarÄ±sÄ±"],
    "audit":{"eventId":"...","producedBy":"livia-12","producedAt":"iso8601"}
  },

  "template.delete.ok": {
    "event":"template.delete.ok",
    "timestamp":"iso8601",
    "tplKey":"entry-limit-revise#1.0.0#tr-TR",
    "mode":"soft"
  },

  "template.get.result": {
    "event":"template.get.result",
    "timestamp":"iso8601",
    "template":{ /* TemplateRecord */ },
    "resolvedLocale":"tr-TR",
    "fallback": false
  },

  "template.render.preview": {
    "event":"template.render.preview",
    "timestamp":"iso8601",
    "tplKey":"entry-limit-revise#1.0.0#tr-TR",
    "ok": true,
    "preview":"AVAXUSDT â€” LIMIT giriÅŸ: qty 92.59 (Ã—0.75), SL 45 bps, TP 70 bps. Onaylar mÄ±sÄ±n?",
    "length":117,
    "violations":[],                        // compliance/lint ihlalleri
    "audit":{"eventId":"...","producedBy":"livia-12","producedAt":"iso8601"}
  },

  "template.catalog": {
    "event":"template.catalog",
    "timestamp":"iso8601",
    "items":[
      {"id":"entry-limit-revise","versions":["1.0.0","1.1.0"],"locales":["tr-TR","en-US"],"kind":"prompt","deprecated":false}
    ]
  },

  "template.alert": {
    "event":"template.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"rbac_forbidden|lint_failed|parity_missing|undeclared_variable|forbidden_token|max_chars_exceeded|idem_duplicate",
    "context":{"tplKey":"entry-limit-revise#1.0.0#tr-TR","var":"qtyFactor"}
  },

  "template.metrics": {
    "event":"template.metrics",
    "timestamp":"iso8601",
    "upserts":12,"deletes":2,"gets":41,"renders":33,
    "avgValidateMs":2.1,"avgRenderMs":1.7,
    "violationsRate":0.06
  }
}

5) Konfig (varsayÄ±lanlar)
{
  i18n: {
    defaultLocale: "tr-TR",
    supported: ["tr-TR","en-US"],
    requireParity: true           // aynÄ± id+version iÃ§in tÃ¼m diller bulunmalÄ±
  },

  storage: {
    kind: "fs",                   // fs | memory | kv
    root: "data/templates",
    layout: "{kind}/{id}/{version}/{locale}.tmpl.json", // TemplateRecord JSON
    indexFile: "data/templates/index.json",
    snapshotEverySec: 300
  },

  rules: {
    engines: ["handlebars","mustache"],
    maxCharsByKind: { card: 280, prompt: 800, question: 500, report: 20000, explain: 800, rationale: 800 },
    forbidTokens: ["API_KEY", "password", "seed phrase"],
    mustHaveVarsInAllLocales: true,
    allowUnusedVars: false,
    allowUndeclaredVars: false
  },

  rbac: {
    read: ["trader","ops","policy"],
    write: ["ops","policy"]
  },

  compliance: {
    runPIIFilter: true,
    runForbiddenScan: true
  },

  idempotencyTtlSec: 900
}

6) DoÄŸrulama & Lint Boru HattÄ± (Upsert/Render)

Auth & RBAC â†’ yazma yetkisi yoksa reject (template.alert: rbac_forbidden).

Åema KontrolÃ¼ â†’ Header/Body/Variables tip doÄŸrulama (Zod).

Engine KontrolÃ¼ â†’ engine âˆˆ rules.engines.

DeÄŸiÅŸken Paritesi â†’ {{var}} taramasÄ±:

GÃ¶vdedeki tÃ¼m placeholderâ€™lar variables[] iÃ§inde olmalÄ± (undeclared â†’ hata).

variables[]â€™da olup gÃ¶vdede hiÃ§ kullanÄ±lmayan var â†’ uyarÄ± (allowUnusedVars? false ise hata).

AynÄ± id+version iÃ§in tÃ¼m localeâ€™larda aynÄ± deÄŸiÅŸken kÃ¼mesi (parity); eksikse parity_missing.

KÄ±sÄ±tlar â†’ constraints.maxChars varsa ve Ã¶rnek render Ä± aÅŸarsa uyarÄ±; rules.maxCharsByKind ile de sÄ±nÄ±rla.

Compliance â†’ yasaklÄ± anahtarlar, PII belirteÃ§leri (iban/email/telefon) iÃ§eriyor mu? â†’ hata/uyarÄ±.

Checksum & Idempotency â†’ aynÄ± iÃ§erik checksumâ€™Ä± varsa dupe; sadece audit yayÄ±nla.

Ã–rnek Render (preview) â†’ examples[0].input varsa Ã§alÄ±ÅŸtÄ±r ve template.render.preview Ã¼ret (validateOnly: true ise sadece denetim).

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE

template.upsert â†’ UPSERT_VALIDATE

template.delete â†’ DELETE

template.get â†’ GET

template.render.request â†’ RENDER

UPSERT_VALIDATE

Lint + parity + compliance â†’ UPSERT_WRITE veya alert(error).

UPSERT_WRITE

KayÄ±t yaz, index gÃ¼ncelle, template.upsert.ok + template.catalog + metrics.

DELETE

mode=soft â†’ deprecated:true iÅŸaretle; hard â†’ dosyayÄ± kaldÄ±r. template.delete.ok.

GET

version=latest â†’ indexâ€™ten en yÃ¼ksek semver; locale=auto â†’ i18n tercihine gÃ¶re fallback.

template.get.result.

RENDER

Åablonu al, inputâ€™u variables tiplerine gÃ¶re doÄŸrula, render et â†’ uzunluk/forbidden yeniden kontrol â†’ template.render.preview.

Her aÅŸamada audit alanÄ± eklenir.

8) Kenar Durumlar

Semver Ã‡akÄ±ÅŸmasÄ±: var olan version ile farklÄ± gÃ¶vde â†’ alert(error,"version_conflict"); yeni sÃ¼rÃ¼m Ã¼retmeyi Ã¶ner (Ã¶rn. 1.0.1).

Locale Otomatik DÃ¼ÅŸÃ¼ÅŸ: locale=auto ve kullanÄ±cÄ±nÄ±n i18n.switch.notice.prefer yoksa defaultLocale.

BÃ¼yÃ¼k Åablon (report) â†’ dosya boyutu > 1 MB ise compress (gz) + indeks bayraÄŸÄ±.

AB Test Etiketleri (LIVIA-25): tags iÃ§inde ab:A|B|C varsa registry â€œassign-onlyâ€ metadata ekler, render deÄŸiÅŸmez.

Geriye DÃ¶nÃ¼k Uyumsuzluk: variables[].type deÄŸiÅŸtiyse major versiyon zorunlu.

SilinmiÅŸ Locale: parity modda bir locale silinirse kalan localeâ€™lar deprecated bayraÄŸÄ±na alÄ±nÄ±r (katalogda gÃ¶rÃ¼nÃ¼r ama â€œeksikâ€).

9) Telemetri
{
  "template.metrics": {
    "event":"template.metrics",
    "timestamp":"iso8601",
    "upserts": 12,
    "deletes": 2,
    "gets": 41,
    "renders": 33,
    "avgValidateMs": 2.1,
    "avgRenderMs": 1.7,
    "violationsRate": 0.06,
    "byKind": {"prompt":18,"question":9,"card":4,"report":2}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/promptTemplateRegistry.ts       // FSM + API
services/livia/lib/tplValidate.ts              // ÅŸema + parity + compliance
services/livia/lib/tplRender.ts                // handlebars/mustache render
services/livia/lib/semver.ts                   // semver karÅŸÄ±laÅŸtÄ±rma
services/livia/lib/indexer.ts                  // catalog index oku/yaz
services/livia/state/tplStore.ts               // idem index + snapshots
services/livia/__tests__/promptTemplateRegistry.test.ts
cfg/livia.templates.yaml                       // rules/rbac/i18n/storage

11) Test Ä°skeleti (Jest/Vitest)

Upsert Happy Path: geÃ§erli TR ÅŸablon + Ã¶rnek render â†’ upsert.ok + render.preview.ok.

Parity Missing: TR var, EN yok â†’ alert(warn,"parity_missing"), yine de kayÄ±t (konfigâ€™e gÃ¶re).

Undeclared Var: gÃ¶vdede {{foo}} ama listede yok â†’ lint_failed.

Unused Var: listede var gÃ¶vdede yok â†’ lint_failed (allowUnused=false).

Max Chars: card gÃ¶vdesi 300c â†’ max_chars_exceeded uyarÄ±sÄ±.

Compliance: yasak kelime iÃ§eriyorsa â†’ forbidden_token.

Render Type Errors: qtyFactor:"str" â†’ tip uyuÅŸmazlÄ±ÄŸÄ±; render.preview.ok=false.

Semver Latest: get(version=latest) doÄŸru sÃ¼rÃ¼mÃ¼ getirir.

Delete Soft/Hard: soft â†’ deprecated, hard â†’ diskten kalkar; katalog gÃ¼ncellenir.

Idempotency: aynÄ± iÃ§erikle tekrar upsert â†’ idem_duplicate alert, kayÄ±t deÄŸiÅŸmez.

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

template.upsert(entry-limit-revise v1.0.0 tr-TR) â†’ lint/compliance OK â†’ yaz â†’ upsert.ok.

template.upsert(entry-limit-revise v1.0.0 en-US) â†’ parity tamamlandÄ±.

template.render.request(id, latest, auto, inputâ€¦) â†’ render.preview dÃ¶ner; length/ihlal yok.

template.get(latest, auto) â†’ kullanÄ±cÄ± dili EN ise EN gelir; yoksa TR fallback.

Sonra template.delete(mode=soft) â†’ katalogda deprecated gÃ¶rÃ¼nÃ¼r.

13) SLO

P95 validate < 5 ms, P95 render < 5 ms.

Parity aÃ§Ä±ÄŸÄ± â‰¤ %2 (gÃ¼nlÃ¼k).

Lint hatasÄ±z oran â‰¥ %94 (Ã¼rÃ¼n disiplin hedefi).
_________________________________________________________________________________________
LIVIA-13 Â· i18nSwitch.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: OperatÃ¶r etkileÅŸimlerinde TRâ‡„EN dil tespiti, Ã§eviri, sayÄ±/tarih/birim biÃ§imleme ve glossary (kritik terim korumasÄ±) saÄŸlamak.
TÃ¼m modÃ¼ller iÃ§in ortak bir i18n ara katmanÄ± gibi Ã§alÄ±ÅŸÄ±r: operatorUIBridge, knowledgeRouter, policyExplainer, decisionRationaleWriter, promptTemplateRegistry, translationQA (LIVIA-26) ile entegre olur.
Hedef: doÄŸru dilde kÄ±sa, terim-doÄŸru, sayÄ±sal olarak biÃ§imlenmiÅŸ metinler Ã¼retmek; PII sÄ±zÄ±ntÄ±sÄ±nÄ± maskeleyip audit/metrics yayÄ±nlamak.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest.

Event-driven JSON I/O; tÃ¼m In/Out Zod .strict() ile doÄŸrulanÄ±r.

Zaman/TZ: ISO-8601, Europe/Istanbul.

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC: okuma herkese, yazma ops|policy.

Gizlilik: PII maskeleme (LIVIA-21 ile) â€“ yalnÄ±z hedef dilde maske yerleÅŸimi.

Ä°dempotency: i18nKey = hash(origText + targetLang + ctx); TTL iÃ§inde tekrar yayÄ±n yok.

Dil: VarsayÄ±lan TR; kullanÄ±cÄ± tercihi veya iÃ§erik tespitiyle ENâ€™e geÃ§.

2) Girdiler (In) â€” Zodâ€™a Ã§evrilecek ÅŸema Ã¶rnekleri
{
  "operator.response.in": {
    "event":"operator.response.in",
    "timestamp":"iso8601",
    "promptId":"dlg-avax-42",
    "payload":{"note":"limit +2bps uygundur"},
    "auth":{"userId":"op-007","roles":["trader"],"sig":"hex"}
  },

  "operator.answer.in": {
    "event":"operator.answer.in",
    "timestamp":"iso8601",
    "qId":"q-avax-42-1",
    "answer":"value",
    "value":18,
    "unit":"bps|null",
    "auth":{"userId":"op-007","sig":"hex"}
  },

  "template.render.request": {
    "event":"template.render.request",
    "timestamp":"iso8601",
    "id":"entry-limit-revise",
    "version":"latest",
    "locale":"auto",
    "input":{"symbol":"AVAXUSDT","qty":92.59,"qtyFactor":0.75,"slBps":45,"tpBps":70}
  },

  "knowledge.route.select": {
    "event":"knowledge.route.select",
    "timestamp":"iso8601",
    "summary":"Aggressive variant is disabled under block_aggressive guard.",
    "top":[{"docId":"policy/variants@v42","source":"policy","passages":[{"excerpt":"..."}]}]
  },

  "policy.explain": {
    "event":"policy.explain",
    "timestamp":"iso8601",
    "title":"Why rejected? â€” Slip / Spread",
    "bullets":["Slip p95 â‰ˆ 18 bps, limit 15 bps","Use LIMIT/TWAP"],
    "context":{"symbol":"AVAXUSDT"}
  },

  "i18n.switch.notice": {
    "event":"i18n.switch.notice",
    "timestamp":"iso8601",
    "prefer":"tr-TR|en-US",
    "userId":"op-007"
  },

  "i18n.qa.report": {
    "event":"i18n.qa.report",
    "timestamp":"iso8601",
    "ok":true,
    "issues":[],
    "sourceKey":"i18n#dlg-avax-42#en-US"
  }
}


Not: Kaynak olaylar Ã§ok Ã§eÅŸitlidir; i18n bu metinleri tespit â†’ normalize â†’ gerekirse Ã§evir â†’ biÃ§imle akÄ±ÅŸÄ±yla ele alÄ±r.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "i18n.choice": {
    "event":"i18n.choice",
    "timestamp":"iso8601",
    "userId":"op-007",
    "detected":"tr-TR|en-US",
    "reason":"user_preference|content_prob>thresh|session_default",
    "confidence":0.94
  },

  "i18n.text": {
    "event":"i18n.text",
    "timestamp":"iso8601",
    "sourceKey":"i18n#dlg-avax-42#en-US",
    "orig":{"lang":"tr-TR","text":"Slip p95 â‰ˆ 18 bps, limit 15 bps. LIMIT Ã¶nerilir."},
    "tr":{"text":"Slip p95 â‰ˆ 18 bps, limit 15 bps. LIMIT Ã¶nerilir."},
    "en":{"text":"Slip p95 â‰ˆ 18 bps, limit is 15 bps. LIMIT is recommended."},
    "glossaryKept":["halt_entry","failover","slippage","spread","bps"],
    "format":{"numbers":"localized","dates":"Europe/Istanbul"},
    "audit":{"eventId":"...","producedBy":"livia-13","producedAt":"iso8601"}
  },

  "i18n.qa.request": {
    "event":"i18n.qa.request",
    "timestamp":"iso8601",
    "sourceKey":"i18n#dlg-avax-42#en-US",
    "glossary":["halt_entry","failover","slippage","spread","bps"],
    "tolerance":"low"
  },

  "i18n.alert": {
    "event":"i18n.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"lang_undetected|glossary_violation|pii_redact_failed|max_len_exceeded|idem_duplicate",
    "context":{"text":"...", "target":"en-US"}
  },

  "i18n.metrics": {
    "event":"i18n.metrics",
    "timestamp":"iso8601",
    "detections":42,
    "translations":31,
    "cacheHitRate":0.38,
    "avgDetectMs":1.2,
    "avgTranslateMs":3.9,
    "glossaryViolRate":0.02
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: {
    defaultLocale: "tr-TR",
    supported: ["tr-TR","en-US"],
    detect: {
      minChars: 6,
      codeSwitchBoost: true,         // cÃ¼mle iÃ§i EN terim â†’ EN olasÄ±lÄ±ÄŸÄ±nÄ± artÄ±r
      threshold: 0.75                // dil olasÄ±lÄ±ÄŸÄ± eÅŸiÄŸi
    },
    formatting: {
      tr: { number: "tr-TR", currency: "TRY", date: "dd.MM.yyyy HH:mm" },
      en: { number: "en-US", currency: "USD", date: "yyyy-MM-dd HH:mm" }
    },
    glossary: {
      protected: ["halt_entry","failover","slippage","spread","bps","TWAP","LIMIT","MARKET","post_only"],
      map: { "kaldÄ±raÃ§":"leverage", "kayan_maliyet":"slippage" } // EN hedefte
    },
    qa: { enabled: true, tolerance: "low" }   // LIVIA-26 ile
  },

  pii: { enabled: true, maskWith: "***" },

  translator: {
    provider: "pluggable",            // "pluggable" arayÃ¼zÃ¼: local|cloud
    maxChars: 2000,
    preserveMarkdown: true,           // `**bold**`, `code`, links
    timeoutMs: 1500,
    retry: { max: 2, backoffMs: [200, 500] }
  },

  cache: { ttlSec: 900, maxEntries: 2000 },

  rbac: { consume:["trader","ops","policy"], configure:["ops","policy"] },

  idempotencyTtlSec: 900
}

5) Ä°ÅŸlevsel Kapsam (Pipeline)

AlgÄ±la (Detect)

GiriÅŸ metnini detect.minChars altÄ±ndaysa kullanÄ±cÄ± tercihi (i18n.switch.notice) esas alÄ±nÄ±r.

Aksi halde dil tespiti (TR/EN); codeSwitchBoost aktifken halt_entry/failover/bps gibi terimler EN olasÄ±lÄ±ÄŸÄ±nÄ± artÄ±rÄ±r.

SonuÃ§ i18n.choice olarak yayÄ±nlanÄ±r (confidence ile).

Normalize & PII

Whitespace/emoji korunur, Ã§ift boÅŸluk tekilleÅŸtirilir.

PII varsa (email/telefon/IBAN) hedef dil Ã¶ncesi maskele (LIVIA-21); hata â†’ i18n.alert(pii_redact_failed).

Glossary HazÄ±rlÄ±ÄŸÄ±

glossary.protected terimlerini dokunulmaz iÅŸaretle: Ã§eviride olduÄŸu gibi kalmalÄ±dÄ±r.

Terimlerin bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k ve kod stil varyantlarÄ±nÄ± da kapsa (e.g., HALT_ENTRY, Failover).

Ã‡eviri (opsiyonel)

Hedef dil, i18n.choice.detected veya consumer isteÄŸi (Ã¶rn. template.render.request.locale=auto).

translator.provider arayÃ¼zÃ¼:

translate({text, sourceLang, targetLang, glossary, preserveMarkdown}): { text, kept: string[], violations: string[] }


Ã‡eviri sonrasÄ± markdown, kod bloklarÄ±, linkler korunur.

BiÃ§imleme (Formatting)

Metin iÃ§inde sayÄ±, para, tarih ve bps/spread gibi Ã¶lÃ§Ã¼leri hedef dile gÃ¶re biÃ§imle:

TR: 1.234,56, EN: 1,234.56

Tarihler: Europe/Istanbul saat dilimi.

unit alanÄ± varsa (bps, TRY, USD) yerel gÃ¶sterime Ã§evir.

QA (opsiyonel)

qa.enabled ise LIVIA-26 translationQA.tsâ€™ye i18n.qa.request yayÄ±nla.

Gelen i18n.qa.report.ok=false ise:

KÃ¼Ã§Ã¼k ihlaller: uyarÄ± (i18n.alert(glossary_violation)) ve metni dÃ¼zelt (varsa otomatik dÃ¼zeltme).

Kritik ihlaller: EN/TR ikili metin dÃ¶ndÃ¼r (i18n.text.orig + target) ve uyarÄ±.

Cache & Idempotency

i18nKey ile sonuÃ§larÄ± cache et; TTL iÃ§inde tekrar istek olursa cacheâ€™den yeni audit ile Ã§Ä±kar.

6) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
Herhangi bir metin iÃ§eren olay geldiÄŸinde â†’ DETECT.

DETECT
Dil tespiti; kullanÄ±cÄ± tercihi override edebilir. â†’ PROCESS.

PROCESS
PII mask â†’ glossary iÅŸaret â†’ (gerekirse) Ã§eviri â†’ biÃ§imleme.
qa.enabled ise QA_WAIT; deÄŸilse EMIT.

QA_WAIT
i18n.qa.report gelirse deÄŸerlendir; gerekirse dÃ¼zelt. â†’ EMIT (veya alert).

EMIT
i18n.text + i18n.choice + i18n.metrics yayÄ±nla. â†’ IDLE.

7) Kenar Durumlar

Dil tespit edilemedi (confidence<threshold) â†’ i18n.alert(lang_undetected) ve varsayÄ±lan TR.

Glossary Ã§iÄŸnendi (Ã¶r. â€œfailoverâ€ â†’ â€œyedek devreye almaâ€) â†’ glossary_violation + dÃ¼zelt.

Uzun Metin (>translator.maxChars) â†’ parÃ§alÄ± Ã§eviri (chunk) ve birleÅŸtir; sÄ±rayÄ± koru.

Markdown bozulmasÄ± â†’ preserveMarkdown:true tekrar dene; olmadÄ±ysa kod bloklarÄ±nÄ± orijinal bÄ±rak.

Emoji/Simge â†’ aynen koru; harf-sayÄ±sal dÄ±ÅŸÄ± iÅŸaretler tespit skorunu saptÄ±rÄ±yorsa normalize et.

SayÄ±sal BiÃ§im Ã‡akÄ±ÅŸmasÄ± (Ã¶rn. 1,234 TRâ€™de 1.234) â†’ hedef dil lokasyonuna gÃ¶re tutarlÄ± Ã§Ä±ktÄ±yÄ± zorla.

Ã‡ift Dil Ä°stek (UI TR, kayÄ±t EN) â†’ i18n.text iÃ§inde her iki dil alanÄ±nÄ± da doldur.

8) Telemetri
{
  "i18n.metrics": {
    "event":"i18n.metrics",
    "timestamp":"iso8601",
    "detections": 42,
    "translations": 31,
    "cacheHitRate": 0.38,
    "avgDetectMs": 1.2,
    "avgTranslateMs": 3.9,
    "glossaryViolRate": 0.02,
    "byTarget": {"tr-TR":17, "en-US":14}
  }
}

9) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/i18nSwitch.ts                   // FSM + orchestrasyon
services/livia/lib/langDetect.ts               // TR/EN olasÄ±lÄ±k tahmini
services/livia/lib/translator.ts               // provider arayÃ¼zÃ¼ + chunking
services/livia/lib/formatter.ts                // sayÄ±/tarih/birim biÃ§imleme
services/livia/lib/glossary.ts                 // terim koruma/kontrol
services/livia/state/i18nStore.ts              // cache + idem index + prefs
services/livia/__tests__/i18nSwitch.test.ts
cfg/livia.i18n.yaml                            // i18n/translator/qa/glossary ayarlarÄ±

10) Test Ä°skeleti (Jest/Vitest)

Tespit TR: â€œlimit +2bps uygundurâ€ â†’ detected=tr-TR, confidence>thresh.

Tespit EN: â€œPlease switch to LIMIT with qty âˆ’25%â€ â†’ detected=en-US.

Glossary Koruma: â€œfailoverâ€ ve â€œhalt_entryâ€ aynen korunur; Ã§eviride deÄŸiÅŸmez.

BiÃ§imleme: qty=1234.56 â†’ TR 1.234,56, EN 1,234.56.

Markdown Koruma: **AVAX** limit â†’ kalÄ±n stil korunur.

Chunk Ã‡eviri: 3k karakter metin iki parÃ§ayla Ã§evrilir, birleÅŸmiÅŸ halde dÃ¶ner.

QA Entegre: i18n.qa.report(ok=false) â†’ uyarÄ± + otomatik dÃ¼zeltme veya Ã§ift-dil dÃ¶nÃ¼ÅŸ.

PII Mask: email/telefon iÃ§eren metinler *** ile maskelenir.

Cache/Idem: aynÄ± metin/dil/ctx tekrarÄ±nda cache hit ve tek yayÄ±n.

Code-Switch: TR + (English term) tespitinde doÄŸru dil kararÄ± (terim boost).

11) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

policy.explain EN iÃ§erikle geldi. i18nSwitch tespit â†’ en-US, kullanÄ±cÄ± tercihi tr-TR.

Glossary: halt_entry, bps kilitlendi.

ENâ†’TR Ã§eviri + TR sayÄ±/tarih biÃ§imleme; i18n.qa.request LIVIA-26â€™ya gitti, ok:true dÃ¶ndÃ¼.

i18n.text (orig EN + TR hedef) ve i18n.choice yayÄ±nlandÄ±; operatorUIBridge TR kart gÃ¶sterdi.

i18n.metrics gÃ¼ncellendi.

12) SLO

P95 detect < 3 ms, P95 translate < 20 ms (chunk hariÃ§, providerâ€™a gÃ¶re).

Glossary ihlal oranÄ± < %3.

Markdown koruma baÅŸarÄ±sÄ± â‰¥ %99.

Cache hit â‰¥ %30 tipik oturumda.
___________________________________________________________________________________________
LIVIA-14 Â· telemetryDailyDigest.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: Son 24 saatin operasyon verisini toplayÄ±p â€œGÃ¼nlÃ¼k Ã–zet BÃ¼ltenâ€ (Markdown + opsiyonel HTML) Ã¼retmek: SLO durumu, guard/alert/incident, slip/spread maliyet resmi, PnL, onay akÄ±ÅŸÄ±, karar/cevap hacmi, politika rollout, UI kÃ¶prÃ¼sÃ¼ ve anomali anlatÄ±larÄ±. BÃ¼lteni dosyaya yaz, kÄ±sa card olarak UIâ€™ya yolla, arÅŸivle.
Mimari: Event-driven JSON, Zod .strict(), Europe/Istanbul, idempotent, audit, metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest.

TÃ¼m In/Out ÅŸemalarÄ± Zod ile doÄŸrulanÄ±r ( .strict() ).

Saat Dilimi: Europe/Istanbul.

Run zamanÄ±: default her gÃ¼n 18:00 (yerel). KaÃ§arsa backfill: 18:10â€™a kadar otomatik tetik.

Ä°dempotency: digestKey = YYYY-MM-DD + cfg.hash(version+sections); aynÄ± gÃ¼ne ikinci defa yazma (manuel force=true hariÃ§).

Gizlilik: classification:"SENSITIVE_LOW"; PII maskesi (LIVIA-21) dosyaya maskeli yazÄ±lÄ±r.

Telemetri: digest.metrics; UyarÄ±: digest.alert.

2) Girdiler (In) â€” (Zodâ€™a Ã§evrilecek Ã¶rnekler)
{
  "telemetry.slo.status": {
    "event":"telemetry.slo.status",
    "timestamp":"iso8601",
    "slo":"guard_success_rate|ui_ack_latency|plan_commit_success",
    "state":"ok|at_risk|breach",
    "window":"1h|24h",
    "burnPct": 12.3
  },

  "telemetry.rollup.batch": {
    "event":"telemetry.rollup.batch",
    "timestamp":"iso8601",
    "windowH":1,
    "series":[
      {"name":"order.slip.p95", "p50":9, "p95":18, "p99":27},
      {"name":"market.spread.bps", "p50":35, "p95":82}
    ]
  },

  "latency_slip.guard.directive": {
    "event":"latency_slip.guard.directive",
    "timestamp":"iso8601",
    "mode":"normal|slowdown|block_aggressive|halt_entry",
    "expiresAt":"iso8601",
    "reasonCodes":["slip_p95>15bps","lat_p95>800ms"]
  },

  "policy.metrics": {
    "event":"policy.metrics",
    "timestamp":"iso8601",
    "activeVersion":"v42",
    "stage":"active|canary",
    "percent":100,
    "updates":3,
    "rollbacks":1
  },

  "uiBridge.metrics": {
    "event":"uiBridge.metrics",
    "timestamp":"iso8601",
    "connections":12,"delivered":320,"acked":315,"retry":9,"dropped":2,"avgLatencyMs":240
  },

  "decision.rationale": {
    "event":"decision.rationale",
    "timestamp":"iso8601",
    "accepted":true|false,
    "promptId":"dlg-..",
    "summary":"...",
    "details":{"finalPlan":{"symbol":"AVAXUSDT"}}
  },

  "approval.pending":   { "event":"approval.pending",   "timestamp":"iso8601", "approvalKey":"...", "action":"..." },
  "action.approved":    { "event":"action.approved",    "timestamp":"iso8601", "action":"...", "by":[{"userId":"..."}] },
  "action.rejected":    { "event":"action.rejected",    "timestamp":"iso8601", "action":"...", "reasons":["..."] },

  "incident.started":   { "event":"incident.started",   "timestamp":"iso8601", "id":"inc-...", "severity":"low|med|high", "title":"..." },
  "incident.closed":    { "event":"incident.closed",    "timestamp":"iso8601", "id":"inc-...", "durationMin":37, "resolution":"..." },

  "anomaly.narrative":  { "event":"anomaly.narrative",  "timestamp":"iso8601", "title":"...", "bullets":["..."], "evidence":[] },

  "pnl.daily": {
    "event":"pnl.daily",
    "timestamp":"iso8601",
    "date":"YYYY-MM-DD",
    "grossUSD": 2189.7,
    "feesUSD":  -190.1,
    "netUSD":   1999.6,
    "bySymbol":[{"symbol":"AVAXUSDT","netUSD":612.4},{"symbol":"BTCUSDT","netUSD":-120.3}]
  },

  "notes.session.md": {
    "event":"notes.session.md",
    "timestamp":"iso8601",
    "path":"data/notes/2025-09-13/sess-avax-42.md",
    "summary":"..."
  }
}


Not: Girdilerin hiÃ§biri tek baÅŸÄ±na zorunlu deÄŸil; en azÄ±ndan telemetry ve/veya pnl.daily beklenir. Eksikler raporda boÅŸ/0 olarak gÃ¶sterilir.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "digest.daily.ready": {
    "event":"digest.daily.ready",
    "timestamp":"iso8601",
    "digestKey":"2025-09-13",
    "format":"md|html",
    "path":"data/digest/2025-09-13/Daily.md",
    "sections":[
      "Ã–ne Ã‡Ä±kanlar","SLO & Guard","Slip/Spread","Karar & Onay",
      "Olaylar & Anomaliler","Politika DaÄŸÄ±tÄ±mÄ±","UI KÃ¶prÃ¼sÃ¼","PnL Ã–zeti","Notlar"
    ],
    "highlights":[
      "SLO: guard_success_rate=ok; burn 8.1%",
      "Guard: slowdown 2 kez, block_aggressive 1 kez",
      "PnL(net): $1,999.6 (Top: AVAXUSDT $612.4)"
    ],
    "audit":{"eventId":"...","producedBy":"livia-14","producedAt":"iso8601"}
  },

  "digest.card": {
    "event":"digest.card",
    "timestamp":"iso8601",
    "title":"GÃ¼nlÃ¼k Ã–zet HazÄ±r (2025-09-13)",
    "body":"SLO: OK | PnL(net): $1,999.6 | Incidents: 1 (37 dk) | Guard: slowdownÃ—2",
    "severity":"info",
    "ttlSec":600,
    "links":[{"label":"AÃ§","href":"app://digest/2025-09-13"}]
  },

  "digest.archive.index": {
    "event":"digest.archive.index",
    "timestamp":"iso8601",
    "paths":["data/digest/2025-09-12/Daily.md","data/digest/2025-09-13/Daily.md"],
    "count": 2
  },

  "digest.alert": {
    "event":"digest.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"missing_core_signals|late_run|write_failed|idem_duplicate",
    "context":{"date":"2025-09-13","missing":["pnl.daily","policy.metrics"]}
  },

  "digest.metrics": {
    "event":"digest.metrics",
    "timestamp":"iso8601",
    "runs": 1,
    "avgComposeMs": 12,
    "lateRun": false,
    "sectionsMs":{"highlights":2,"slo":1,"slip":1,"decisions":2,"incidents":2,"policy":1,"ui":1,"pnl":1,"notes":1}
  }
}

4) Konfig (varsayÄ±lanlar)
{
  schedule: {
    runAt: "18:00",               // Europe/Istanbul
    lookbackHours: 24,
    graceMin: 10,                 // kaÃ§arsa 18:10'a kadar backfill
    allowManual: true
  },

  sections: {
    highlights: true,
    slo: true,
    slipSpread: true,
    decisionsApprovals: true,
    incidentsAnomalies: true,
    policyRollout: true,
    uiBridge: true,
    pnl: true,
    notes: true
  },

  thresholds: {
    slipP95WarnBps: 15,
    spreadP95WarnBps: 80,
    sloBurnWarnPct: 20,
    uiAckP95WarnMs: 1500
  },

  format: {
    outDir: "data/digest",
    md: { headingPrefix: "#", maxLine: 120 },
    html: { enabled: true, templatePath: "templates/digest.html" },
    currency: "USD",
    topN: { symbols: 5, incidents: 5, decisions: 5 }
  },

  charts: {                        // ASCII mini-sparkline; HTMLâ€™de inline SVG
    ascii: true,
    svg: true,
    width: 20
  },

  retention: {
    days: 90,                      // eski digest temizliÄŸi
    keepHtml: true
  },

  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  idempotencyTtlSec: 86400
}

5) BÃ¼lten Kompozisyonu (Pipeline)

Zaman Penceresi

lookbackHours=24 (18:00â†’18:00). DST gÃ¼nlerinde yerel saate gÃ¶re dilimle.

Topla & Ã–zetle (in-memory storeâ€™dan)

SLO: son 24h telemetry.slo.status â†’ son durum (ok/at_risk/breach) + burnPct p95.

Guard: latency_slip.guard.directive â†’ mod baÅŸÄ±na sayÄ±m (slowdown/block/halt).

Slip/Spread: telemetry.rollup.batch â†’ order.slip.p95, market.spread.bps 24h p50/p95; eÅŸik Ã¼stÃ¼yse âš ï¸ etiketi.

Karar & Onay: decision.rationale (accepted/rejected sayÄ±larÄ±, en Ã§ok geÃ§en sembol), approval.* (pending/approved/rejected).

Olay & Anomali: incident.* (adet, toplam sÃ¼re, en yÃ¼ksek seviye), anomaly.narrative (ilk 3 baÅŸlÄ±k/bullet).

Politika: policy.metrics (aktif sÃ¼rÃ¼m, canary/rollback sayÄ±larÄ±).

UI KÃ¶prÃ¼sÃ¼: uiBridge.metrics (ack p95, drop oranÄ±, retry sayÄ±sÄ±).

PnL: pnl.daily.netUSD + en iyi/kÃ¶tÃ¼ 3 sembol; eÄŸer yoksa â€œâ€”â€.

Notlar: notes.session.md ve notes.daily.md Ã¶zetleri (varsa adet).

Vurucu â€œÃ–ne Ã‡Ä±kanlarâ€

3â€“5 satÄ±r: (a) SLO state, (b) Guard sayÄ±mlarÄ±, (c) PnL net, (d) politika olayÄ± (rollback/canary), (e) kritik incident.

Mini Grafikler

Slip p95 24h â†’ ASCII sparkline (md) + SVG (html).

UI ack latency â†’ aynÄ±.

ÅablonlandÄ±rma

Markdown iskeletini Ã¼ret; HTML aÃ§Ä±ksa aynÄ± iÃ§eriÄŸi templateâ€™e gÃ¶m.

Ä°dempotency & YazÄ±m

digestKey kontrol â†’ MD/HTML dosyalarÄ± outDir/YYYY-MM-DD/.

Atomic write (tmpâ†’rename), arÅŸiv index gÃ¼ncelle.

YayÄ±n

digest.daily.ready + kÄ±sa digest.card (UI).

digest.metrics gÃ¼ncelle.

6) Markdown TaslaÄŸÄ± (Ã¼retilmesi gereken yapÄ±)
# GÃ¼nlÃ¼k Ã–zet â€” 2025-09-13 (Europe/Istanbul)

## Ã–ne Ã‡Ä±kanlar
- SLO: guard_success_rate = **OK**, burn p95 = **8.1%**
- Guard: slowdown Ã—2, block_aggressive Ã—1
- PnL (net): **$1,999.6** â€” En iyi: AVAXUSDT $612.4 | En kÃ¶tÃ¼: BTCUSDT âˆ’$120.3

## SLO & Guard
- plan_commit_success: OK | burn p95: 4.2%
- ui_ack_latency: OK | p95: 1.24s
- Guard modlarÄ± (24h): normal 21h, slowdown 2h, block_aggressive 1h

## Slip / Spread
- Slip p95: **18 bps** (eÅŸik 15 bps) âš ï¸
- Spread p95: **82 bps** (eÅŸik 80 bps) âš ï¸
`â–â–ƒâ–…â–ˆâ–†â–…â–ƒâ–‚`  (slip p95 24h)

## Karar & Onay
- Kararlar: 32 accepted / 7 rejected
- Onaylar: 3 pending â†’ 3 approved / 0 rejected

## Olaylar & Anomaliler
- Incidents: 1 (toplam 37 dk) â€” Ã§Ã¶zÃ¼m: policy rollback v42â†’v41
- Anomaliler (ilk 3): slip spike; feed stale; ui drop blip

## Politika DaÄŸÄ±tÄ±mÄ±
- Aktif: v42 (active %100) | son 24h: 1 rollback

## UI KÃ¶prÃ¼sÃ¼
- Ack p95: 1.2s | retry: 9 | drop: 2 (0.6%)

## PnL Ã–zeti
- Net: **$1,999.6** (fees: âˆ’$190.1)
- En iyi 3: AVAXUSDT $612.4, ETHUSDT $410.2, SOLUSDT $210.0
- En kÃ¶tÃ¼ 3: BTCUSDT âˆ’$120.3, â€¦ 

## Notlar
- 3 seans dosyasÄ±, GÃ¼nlÃ¼k Ã¶zet yazÄ±ldÄ±.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
cron(18:00) veya digest.run.request{date?,force?} â†’ COLLECT.

COLLECT
Window iÃ§indeki olaylar storeâ€™dan okunur; eksik Ã§ekirdek sinyal varsa digest.alert(warn,"missing_core_signals"). â†’ COMPOSE.

COMPOSE
BÃ¶lÃ¼m Ã¶zetleri + grafikleri kur; MD/HTML oluÅŸtur. â†’ WRITE.

WRITE
Atomic yaz; arÅŸiv indexini gÃ¼ncelle. â†’ EMIT.

EMIT
digest.daily.ready + digest.card + digest.metrics. â†’ IDLE.

8) Kenar Durumlar

Late run (18:10 sonrasÄ±): lateRun=true iÅŸaretle, baÅŸlÄ±ÄŸa â€œ(gecikmeli)â€ notu ekle.

PnL yok: PnL bÃ¶lÃ¼mÃ¼ â€œveri yok â€” muhasebe bekleniyorâ€ metniyle Ã§Ä±kar.

AÅŸÄ±rÄ± veri: listeler topN ile kesilir, â€œ+N dahaâ€ notu eklenir.

SLO Ã§akÄ±ÅŸan pencereler: son window="24h" > 1h. Yoksa 1h agregasyonlarÄ±nÄ±n medyanÄ±nÄ± kullan.

DST geÃ§iÅŸi: 23/25 saatlik gÃ¼nlerde yerel takvim gÃ¼nÃ¼ esas alÄ±nÄ±r; window saat kadar deÄŸil gÃ¼n baÅŸÄ±-sonu.

Ä°dempotent Ã§akÄ±ÅŸma: aynÄ± gÃ¼ne ikinci yazÄ±m â†’ idem_duplicate alert; force=true ise _r2.md olarak sÃ¼rÃ¼mle.

PII: tÃ¼m serbest metinler maskelenir.

9) Telemetri
{
  "digest.metrics": {
    "event":"digest.metrics",
    "timestamp":"iso8601",
    "runs": 1,
    "avgComposeMs": 12,
    "lateRun": false,
    "sectionSizes":{"md": 2800, "html": 5600},
    "alerts":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/telemetryDailyDigest.ts         // FSM + scheduler
services/livia/lib/digestCollect.ts            // window veri toplayÄ±cÄ±
services/livia/lib/digestCompose.ts            // bÃ¶lÃ¼m derleyici + ÅŸablon
services/livia/lib/asciiSpark.ts               // mini sparkline Ã¼retici
services/livia/lib/htmlRenderer.ts             // mdâ†’html template
services/livia/lib/timeWindow.ts               // DST gÃ¼venli pencere
services/livia/state/digestStore.ts            // idem, cache, arÅŸiv index
services/livia/__tests__/telemetryDailyDigest.test.ts
cfg/livia.digest.yaml                          // schedule/sections/thresholds/format
templates/digest.html                          // HTML iskeleti

11) Test Ä°skeleti (Jest/Vitest)

Normal GÃ¼n: tÃ¼m sinyaller mevcut â†’ MD/HTML Ã¼retilir, highlights dolu.

Late Run: saat 18:12 â†’ lateRun=true, baÅŸlÄ±kta not.

PnL Yok: PnL bÃ¶lÃ¼mÃ¼ boÅŸ mesajla gÃ¶rÃ¼nÃ¼r.

EÅŸik AÅŸÄ±mÄ±: slip p95>15 â†’ âš ï¸ iÅŸareti eklenir.

TopN Kesimi: >5 incident â†’ listede 5 + â€œ+N dahaâ€.

Idempotency: aynÄ± gÃ¼n ikinci Ã§alÄ±ÅŸtÄ±rma â†’ idem_duplicate.

DST GÃ¼nÃ¼: 23/25 saat simÃ¼lasyonu â†’ doÄŸru gÃ¼n etiketleri.

Atomic Write: aynÄ± anda 2 yazÄ±m denemesinde dosya bozulmaz.

Backfill: 18:08 tetik â†’ Ã§alÄ±ÅŸÄ±r; 18:20 tetik â†’ lateRun alert.

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

18:00 cron â†’ COLLECT son 24h; slip/spread/SLO/guard/approval/incident/policy/ui/pnl toplandÄ±.

COMPOSE â†’ highlights + bÃ¶lÃ¼mler + sparkline.

WRITE â†’ data/digest/2025-09-13/Daily.md ve Daily.html.

EMIT â†’ digest.daily.ready + digest.card.

ArÅŸiv index gÃ¼ncellendi; retention 90 gÃ¼n Ã¼stÃ¼nÃ¼ sildi.

13) SLO

P95 compose < 50 ms (Ã¶nbellek Ä±sÄ±nmÄ±ÅŸken).

GeÃ§ kalma oranÄ± < %2.

BoÅŸ bÃ¼lten (tÃ¼m veriler yok) Ã¼retme oranÄ± â‰ˆ 0; en az highlights+SLO bÃ¶lÃ¼mÃ¼ dolu olmalÄ±.
__________________________________________________________________________________________
LIVIA-14 Â· telemetryDailyDigest.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: Son 24 saatin operasyon sinyallerinden gÃ¼nlÃ¼k Ã¶zet bÃ¼lten Ã¼retmek (SLO, guard olaylarÄ±, slip/spread, PnL, onaylar, incidentâ€™lar, Ã¶nemli notlar/eylemler). Ã‡Ä±ktÄ± Markdown ve opsiyonel HTML dosyasÄ±dÄ±r; kÄ±sa UI kartÄ± ve chat mesajÄ± da Ã¼ret. TÃ¼m I/O: event-driven JSON, Zod .strict(), Europe/Istanbul, idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest.

Zaman: ISO-8601, TZ=Europe/Istanbul. Rapor penceresi: [dÃ¼n 18:00 â†’ bugÃ¼n 18:00] varsayÄ±lan.

Gizlilik: PII mask (LIVIA-21). BÃ¼ltene PII dahil etme.

GÃ¼venlik: RBAC (ops|trader|policy okuyabilir), imzalÄ± yayÄ±n.

Ä°dempotency: digestKey = YYYY-MM-DD#window#format; aynÄ± pencerede ikinci Ã¼retime izin yok (TTL 48h).

Telemetri: digest.metrics, uyarÄ±lar digest.alert.

2) Girdiler (In) â€” Ã¶rnek ÅŸemalar (Zodâ€™a Ã§evir)
{
  "telemetry.slo.status": {
    "event":"telemetry.slo.status",
    "timestamp":"iso8601",
    "slo":"guard_success_rate|ui_ack_p95|bounds_pass_rate|abandon_rate",
    "state":"ok|at_risk|breach",
    "window":"1h|24h",
    "value":0.984,
    "target":0.98,
    "burnPct":7.2
  },

  "telemetry.rollup.batch": {
    "event":"telemetry.rollup.batch",
    "timestamp":"iso8601",
    "window":"5m",
    "series":[
      {"name":"order.slip.p95", "avg":14.8, "max":27.2},
      {"name":"market.spread.p95", "avg":62, "max":118}
    ]
  },

  "telemetry.anomaly.signal": {
    "event":"telemetry.anomaly.signal",
    "timestamp":"iso8601",
    "series":"order.slip.p95",
    "kind":"spike|drift|flatline|gap",
    "severity":"low|medium|high",
    "at":"iso8601"
  },

  "sentry.guard.directive": {
    "event":"sentry.guard.directive",
    "timestamp":"iso8601",
    "mode":"normal|degraded|streams_panic|halt_entry",
    "expiresAt":"iso8601",
    "reasonCodes":["feed_stale>5s"]
  },

  "latency_slip.guard.directive": {
    "event":"latency_slip.guard.directive",
    "timestamp":"iso8601",
    "mode":"normal|slowdown|block_aggressive|halt_entry",
    "expiresAt":"iso8601",
    "reasonCodes":["slip_p95>15bps"]
  },

  "pnl.daily": {
    "event":"pnl.daily",
    "timestamp":"iso8601",
    "date":"YYYY-MM-DD",
    "totalUSD":1234.56,
    "bySymbol":[{"symbol":"AVAXUSDT","pnlUSD":420.1},{"symbol":"BTCUSDT","pnlUSD":-55.2}]
  },

  "approval.metrics": {
    "event":"approval.metrics",
    "timestamp":"iso8601",
    "pending":2,"approved":7,"rejected":1,
    "slaBreach":0
  },

  "incident.started": {
    "event":"incident.started",
    "timestamp":"iso8601",
    "id":"inc-2025-09-13-1",
    "severity":"high",
    "title":"Slip spike on SG02",
    "tags":["slip","latency"]
  },

  "incident.closed": {
    "event":"incident.closed",
    "timestamp":"iso8601",
    "id":"inc-2025-09-13-1",
    "resolution":"policy rollback v42â†’v41",
    "durationMin":37
  },

  "operator.notes.append": {
    "event":"operator.notes.append",
    "timestamp":"iso8601",
    "sessionId":"sess-avax-42",
    "lines":[{"kind":"action","text":"limits.maxSlipBps gÃ¶zden geÃ§ir (24s).","due":"iso8601"}]
  },

  "notes.daily.md": {
    "event":"notes.daily.md",
    "timestamp":"iso8601",
    "path":"data/notes/2025-09-13/Daily.md",
    "summary":"..."
  },

  "policy.snapshot": {
    "event":"policy.snapshot",
    "timestamp":"iso8601",
    "versionId":"v42",
    "stage":"active|canary",
    "percent":100
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "digest.daily.ready": {
    "event":"digest.daily.ready",
    "timestamp":"iso8601",
    "digestKey":"2025-09-13#18:00-md",
    "format":"md|html",
    "path":"data/digest/2025-09-13/Daily.md",
    "summary":"SLO: 3/4 OK, 1 at_risk. Guards: slowdown(2) â†’ normal. PnL: +$1,234. Incident: 1 (37 dk). AÃ§Ä±k onay: 2.",
    "links":[{"label":"HTML","href":"data/digest/2025-09-13/Daily.html"}],
    "audit":{"eventId":"...","producedBy":"livia-14","producedAt":"iso8601"}
  },

  "digest.card": {
    "event":"digest.card",
    "timestamp":"iso8601",
    "title":"GÃ¼nlÃ¼k Ã–zet HazÄ±r",
    "body":"SLO 3/4 OK, PnL +$1,234, incident 1 (37 dk). 2 bekleyen onay.",
    "severity":"info",
    "ttlSec":600
  },

  "digest.chat": {
    "event":"digest.chat",
    "timestamp":"iso8601",
    "channel":"ops|trader|policy",
    "text":"Ã–zet: SLO 3/4 OK, guard slowdownâ†’normal, PnL +$1,234, 1 incident (37 dk), 2 bekleyen onay.",
    "threadKey":"daily#2025-09-13"
  },

  "digest.alert": {
    "event":"digest.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"window_insufficient_data|write_failed|idem_duplicate",
    "context":{"window":"2025-09-12T18:00 â†’ 2025-09-13T18:00"}
  },

  "digest.metrics": {
    "event":"digest.metrics",
    "timestamp":"iso8601",
    "windowsBuilt": 1,
    "avgComposeMs": 7.4,
    "markdownBytes": 3580,
    "htmlBytes": 5170,
    "incidents": 1,
    "guards": {"slowdown":2,"block_aggressive":0,"halt_entry":0},
    "approvals":{"pending":2,"approved":7,"rejected":1}
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  schedule: {
    runAt: "18:00",            // her gÃ¼n
    windowHours: 24,           // geriye dÃ¶nÃ¼k
    alignToLocalDay: true
  },

  sections: {
    include: ["slo","guards","anomalies","markets","pnl","approvals","incidents","actions","notes"],
    maxTopSymbols: 8,
    maxAnomalies: 5,
    maxActions: 10
  },

  scoring: {
    anomalyWeights: { spike:1.0, drift:0.6, flatline:0.4, gap:0.8 },
    guardSeverity: { halt_entry:1.0, block_aggressive:0.7, slowdown:0.4, degraded:0.6 }
  },

  output: {
    outDir: "data/digest/{YYYY-MM-DD}",
    mdName: "Daily.md",
    htmlName: "Daily.html",
    html: { enable:true, cssPreset:"minimal" }
  },

  distribution: {
    uiCard: true,
    chat: { enable:true, channels:["ops","trader","policy"] }
  },

  privacy: { piiMask:true },

  idempotencyTtlSec: 172800
}

5) Kompozisyon â€” Markdown/HTML yapÄ±

BaÅŸlÄ±k & Ã–zet

# GÃ¼nlÃ¼k Ã–zet â€” {YYYY-MM-DD} (TZ: Europe/Istanbul)
Aktif Policy: {versionId} ({stage}/{percent}%)
Ã–zet: SLO {ok}/{total} OK, Guards: {summary}, PnL: {sign}{usd}, Incident: {n} ({topSeverity}), AÃ§Ä±k onay: {pending}


BÃ¶lÃ¼mler

SLO

Tablo: slo | durum | deÄŸer | hedef | burn%.

â€œat_risk/breachâ€ olanlarÄ± kalÄ±n ve âš ï¸ iÅŸaretle.

Guard OlaylarÄ±

Zaman Ã§izelgesi: 09:12 slowdown, 10:25 normal.

â€œhalt_entryâ€ varsa en Ã¼ste uyarÄ± kutusu.

Anomaliler

En yÃ¼ksek skorlu ilk {maxAnomalies}: order.slip.p95 spike @ 14:32 (max 27.2 bps).

Piyasa/Operasyon Metrikleri (opsiyonel â€œmarketsâ€)

spread.p95, slip.p95 gÃ¼nlÃ¼k ort./maks., varsa ilk 3 sembol.

PnL

Toplam ve ilk {maxTopSymbols} katkÄ±/zarar listesi (Ã§ubuk gÃ¶rÃ¼nÃ¼m ascii opsiyonel).

Onaylar

Bekleyen/Onaylanan/Reddedilen sayÄ±; bekleyenler iÃ§in kÄ±sa liste approvalKey, yaÅŸ (dakika).

Incidentâ€™lar

Tablo: id | severity | sÃ¼re | Ã§Ã¶zÃ¼m. BÃ¼yÃ¼k olaylarda postmortem linki varsa ekle.

Aksiyonlar (Notes/Action)

Ä°lk {maxActions} aÃ§Ä±k aksiyon: sahip | baÅŸlÄ±k | due. SÃ¼resi geÃ§miÅŸler kÄ±rmÄ±zÄ± nokta.

Notlar (Ã–nemli)

3â€“5 satÄ±r â€œseans notuâ€ Ã¶zeti (PII maskli).

6) Pipeline (algoritma)

Pencere TanÄ±mÄ±

schedule.runAt referans, window = [prev 18:00, this 18:00]. Manuel tetikte Ã¶zel aralÄ±k destekle (opsiyonel).

Topla & Normalize

Son 24h iÃ§indeki slo.status, rollup.batch, anomaly.signal, guard.directive, pnl.daily, approval.metrics, incident.*, operator.notes.append, notes.daily.md, policy.snapshot.

SLO deÄŸerlerini en son â€œ24hâ€ penceresinden seÃ§; yoksa 1h rolling ortalama ile not dÃ¼ÅŸ: â€œ24h yok, 1h temsilidirâ€.

Skor & SÄ±ralama

Anomali skoru = weight(kind) Ã— severityFactor(high=1, med=0.6, low=0.3) Ã— norm(max/avg).

Guard Ã¶zet cÃ¼mlesi: en yÃ¼ksek etkili mod/dakika.

PnL varsa toplam ve top N sembol.

BÃ¶lÃ¼m Ä°nÅŸasÄ±

Markdown satÄ±rlarÄ±nÄ± oluÅŸtur; PII mask uygula.

HTML aktifse basit CSS ile aynÄ± iÃ§eriÄŸi dÃ¶nÃ¼ÅŸtÃ¼r.

Ä°dempotency

digestKey kontrol et; varsa idem_duplicate uyarÄ±sÄ± ve sadece digest.daily.readyâ€™i yeniden yayÄ±nla (yol/Ã¶zet).

YazÄ±m

outDir oluÅŸtur â†’ Daily.md ve opsiyonel Daily.html atomic write.

DaÄŸÄ±tÄ±m

digest.card (UI) + digest.chat (ops|trader|policy) yayÄ±nla.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
ZamanlayÄ±cÄ± tetikledi (cron) veya manual.digest.request{from,to} geldi â†’ COLLECT.

COLLECT
Verileri pencereye gÃ¶re topla/normalize â†’ COMPOSE.

COMPOSE
BÃ¶lÃ¼mleri inÅŸa et, md/html Ã¼ret â†’ WRITE.

WRITE
DosyalarÄ± yaz; baÅŸarÄ± â†’ EMIT, hata â†’ digest.alert(write_failed).

EMIT
digest.daily.ready + digest.card + digest.chat + digest.metrics â†’ IDLE.

8) Kenar Durumlar

Eksik veri: hiÃ§bir SLO yok â†’ â€œwindow_insufficient_dataâ€ uyarÄ±sÄ±, bÃ¼ltene â€œSLO verisi eksikâ€ notu.

Ã‡ifte pencere: aynÄ± gÃ¼n iki kez Ã§alÄ±ÅŸtÄ±rma â†’ idempotency devreye girer.

BÃ¼yÃ¼k dosya (>200 KB) â†’ â€œlite modeâ€: yalnÄ±z Ã¶zet + kritik tablolar, htmlBytes/markdownBytes dÃ¼ÅŸer.

Saat kaymasÄ±: yaz saati geÃ§iÅŸi â†’ pencere hesaplamasÄ±nda TZâ€™ye gÃ¶re kaydÄ±r.

PnL yok: PnL bÃ¶lÃ¼mÃ¼ â€œveri yokâ€ mesajÄ±yla geÃ§ilir.

PII kaÃ§Ä±ÅŸÄ±: note satÄ±rÄ±nda PII maskeleme baÅŸarÄ±sÄ±z â†’ bu satÄ±rÄ± dahil etme, digest.alert("pii_mask_fail").

9) Telemetri (ek)
{
  "digest.metrics": {
    "event":"digest.metrics",
    "timestamp":"iso8601",
    "windowsBuilt":1,
    "avgComposeMs":7.4,
    "markdownBytes":3580,
    "htmlBytes":5170,
    "sections":{"slo":1,"guards":1,"anomalies":1,"pnl":1,"approvals":1,"incidents":1,"actions":1,"notes":1},
    "cacheReuse":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/telemetryDailyDigest.ts        // FSM + scheduler + compose
services/livia/lib/collectWindow.ts           // pencere tanÄ±mÄ± + veri toplama
services/livia/lib/composeDigest.ts           // md/html Ã¼retimi
services/livia/lib/score.ts                   // anomaly/guard skorlayÄ±cÄ±
services/livia/lib/piiMask.ts                 // PII koruma
services/livia/lib/atomicFS.ts                // atomic write + lock
services/livia/state/digestStore.ts           // idem index + last windows
services/livia/__tests__/telemetryDailyDigest.test.ts
cfg/livia.digest.yaml                         // schedule/sections/output/scoring

11) Test Ä°skeleti (Jest/Vitest)

Tam akÄ±ÅŸ: pencere tanÄ±mÄ± â†’ md/html dosyalarÄ± yazÄ±ldÄ± â†’ digest.daily.ready.

Ä°dempotency: aynÄ± gÃ¼n tekrar â†’ ikinci yazÄ±m yok, only â€œreadyâ€ re-emit.

Eksik SLO: uyarÄ± Ã¼retildi, bÃ¼lten â€œSLO eksikâ€ notu iÃ§erir.

Guard Ã¶zet: slowdownâ†’normal geÃ§iÅŸi metne doÄŸru yansÄ±r.

Anomali sÄ±ralama: spike(high) ilk sÄ±rada.

PnL bÃ¶lÃ¼mÃ¼: top N sembol listesi doÄŸru.

Approvals: pending/approved/rejected sayÄ±larÄ± doÄŸru.

PII: note iÃ§inde e-posta/telefon masklenir.

Atomic FS: eÅŸzamanlÄ± yazÄ±mda dosya bozulmaz.

DST gÃ¼nÃ¼: pencere doÄŸru hesaplanÄ±r.

12) Ã–rnek KÄ±sa Ã‡Ä±ktÄ± (Markdown)
# GÃ¼nlÃ¼k Ã–zet â€” 2025-09-13 (TZ: Europe/Istanbul)
Aktif Policy: v42 (active/100%)

**Ã–zet:** SLO 3/4 OK, Guards: slowdown(2)â†’normal, PnL **+$1,234**, Incident **1** (37 dk), AÃ§Ä±k onay **2**

## SLO
- guard_success_rate: **OK** (98.4% / hedef 98%)
- ui_ack_p95: **AT RISK** (1.52s / hedef 1.5s)
- bounds_pass_rate: OK (96.1% / 95%)
- abandon_rate: OK (1.8% / 2%)

## Guard OlaylarÄ±
- 09:12 **slowdown** (slip_p95>15bps) â†’ 10:25 **normal**

## Anomaliler (Top 3)
- 14:32 order.slip.p95 **spike**, max **27.2 bps**
- 11:05 market.spread.p95 **gap**
- 17:10 order.rate **drift**

## PnL
- Toplam: **+$1,234**
- Semboller: AVAX +$420, BTC âˆ’$55, SOL +$80 â€¦

## Onaylar
- Bekleyen: **2** | Onaylanan: 7 | Reddedilen: 1

## Incidentâ€™lar
- inc-2025-09-13-1 (**high**, 37 dk) â€” Ã§Ã¶zÃ¼m: policy rollback v42â†’v41

## Aksiyonlar
- limits.maxSlipBps gÃ¶zden geÃ§ir â€” **due: 2025-09-14 18:00**, owner: policy-team

13) SLO

P95 compose < 15 ms (indexler bellekte).

Ä°dempotent Ã§akÄ±ÅŸma oranÄ± < %0.5.

BÃ¼lten hazÄ±r olma sapmasÄ± < Â±30 sn (18:00 Â±).

PII sÄ±zÄ±ntÄ±sÄ± = 0.
______________________________________________________________________________________________
ChatGPT:

tamam reis â€” ÅŸimdi LIVIA-14 Â· telemetryDailyDigest.ts iÃ§in tek mesajda GeniÅŸ Prompt v3 (yol-prompt) bÄ±raktÄ±m. Bunu .txt dosyana aynen koy ve diÄŸer yapay zekÃ¢ya ver; Node.js + TypeScript servisini bu yÃ¶nergelerle yazsÄ±n. Kod yazdÄ±rmÄ±yoruz; neyi nasÄ±l kodlayacaÄŸÄ±nÄ± net tarifliyoruz.

LIVIA-14 Â· telemetryDailyDigest.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: Son 24 saatin operasyon Ã¶zetini (SLO/guard/latency&slip, PnL, onaylar, olaylar, kritik alarmlar, karar kalitesi) derleyip Markdown/HTML â€œGÃ¼nlÃ¼k Ã–zet BÃ¼ltenâ€ Ã¼retmek; UI kartÄ± ve chat kanallarÄ±na kÄ±sa versiyon daÄŸÄ±tmak; arÅŸivlemek.
Standart: Node18+ / TS / Zod .strict() / ISO-8601 / TZ=Europe/Istanbul / idempotent + audit + metrics.

1) Standartlar

Dil/YÄ±ÄŸÄ±n: Node 18+, TypeScript, pnpm, Jest/Vitest.

I/O: Event-driven JSON; tÃ¼m In/Out Zod .strict().

Zaman/TZ: ISO-8601, Europe/Istanbul; â€œgÃ¼nâ€ sÄ±nÄ±rÄ± Ä°stanbul lokal takvime gÃ¶re.

Gizlilik: classification:"SENSITIVE_LOW"; PII maskeleme LIVIA-21.

Ä°dempotency: digestKey = YYYY-MM-DD + scope + format; aynÄ± gÃ¼ne ikinci yayÄ±n yok (TTL iÃ§inde).

Telemetri: digest.metrics, uyarÄ±: digest.alert.

2) Girdiler (In) â€” Zod ÅŸema Ã¶rnekleri
{
  "telemetry.slo.status": {
    "event":"telemetry.slo.status",
    "timestamp":"iso8601",
    "slo":"guard_success_rate|decision_accept_rate|latency_p95_under_1s",
    "state":"ok|at_risk|breach",
    "window":"5m|1h|24h",
    "burnPct": 8.3
  },

  "telemetry.rollup.batch": {
    "event":"telemetry.rollup.batch",
    "timestamp":"iso8601",
    "window":"24h",
    "series":[
      {"name":"slip.p95.bps","points":[["2025-09-13T00:00:00+03:00",14],["...",18]]},
      {"name":"latency.p95.ms","points":[["...",760]]},
      {"name":"orders.executed.count","points":[["...",4213]]}
    ]
  },

  "latency_slip.guard.directive": {
    "event":"latency_slip.guard.directive",
    "timestamp":"iso8601",
    "mode":"normal|slowdown|block_aggressive|halt_entry",
    "expiresAt":"iso8601",
    "reasonCodes":["slip_p95>15bps"]
  },

  "sentry.guard.directive": {
    "event":"sentry.guard.directive",
    "timestamp":"iso8601",
    "mode":"normal|degraded|streams_panic|halt_entry",
    "reasonCodes":["feed_stale>5s"]
  },

  "pnl.daily": {
    "event":"pnl.daily",
    "timestamp":"iso8601",
    "date":"2025-09-13",
    "realizedUSD": 1240.55,
    "unrealizedUSD": -210.2,
    "feesUSD": 84.7,
    "winRate": 0.61,
    "rrMedian": 1.34
  },

  "approval.metrics": {
    "event":"approval.metrics",
    "timestamp":"iso8601",
    "pending":2,"approved":7,"rejected":1,
    "slaBreaches":1
  },

  "decision.rationale": {
    "event":"decision.rationale",
    "timestamp":"iso8601",
    "accepted":true,
    "summary":"PLAN ONAY: LIMIT + qty âˆ’%25â€¦",
    "citations":[{"path":"limits.maxSlipBps","version":"v42"}]
  },

  "incident.started": {
    "event":"incident.started",
    "timestamp":"iso8601",
    "id":"inc-2025-09-13-1",
    "severity":"high",
    "title":"Slip spike on SG02",
    "tags":["slip","latency"]
  },

  "incident.closed": {
    "event":"incident.closed",
    "timestamp":"iso8601",
    "id":"inc-2025-09-13-1",
    "resolution":"policy rollback v42â†’v41",
    "durationMin": 37
  },

  "notes.daily.md": {
    "event":"notes.daily.md",
    "timestamp":"iso8601",
    "path":"data/notes/2025-09-13/Daily.md",
    "summary":"GÃ¼nlÃ¼k not Ã¶zetiâ€¦",
    "counts":{"decision":3,"incident":1,"approval":2,"action":3}
  }
}


Not: TÃ¼mÃ¼ zorunlu deÄŸil; mevcut olanlardan birleÅŸtirerek bÃ¼lteni oluÅŸtur.

3) Ã‡Ä±ktÄ±lar (Out) â€” Åemalar
{
  "digest.daily.ready": {
    "event":"digest.daily.ready",
    "timestamp":"iso8601",
    "date":"2025-09-13",
    "format":"md|html",
    "scope":"ops|exec|policy",
    "path":"data/digest/2025-09-13/digest.ops.md",
    "summary":"SLO: 2 at_risk (guard, latency); 1 incident (37 dk, rollback v42â†’v41); PnL +$1.240; onaylar 7/10.",
    "audit":{"eventId":"...","producedBy":"livia-14","producedAt":"iso8601"}
  },

  "digest.card": {
    "event":"digest.card",
    "timestamp":"iso8601",
    "title":"GÃ¼nlÃ¼k Ã–zet (13 Eyl)",
    "body":"SLO: 2 risk | 1 incident (37 dk) | PnL +$1.240 | Onay 7/10.",
    "severity":"info|warn|error",
    "links":[{"label":"Detay","href":"app://digest/2025-09-13"}],
    "ttlSec": 3600
  },

  "digest.distribute": {
    "event":"digest.distribute",
    "timestamp":"iso8601",
    "channels":["uiBridge","chatBridge:ops","email:exec"],
    "ok": true,
    "failed":[] 
  },

  "digest.alert": {
    "event":"digest.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"missing_timeseries|no_data|write_failed|idem_duplicate",
    "context":{"date":"2025-09-13"}
  },

  "digest.metrics": {
    "event":"digest.metrics",
    "timestamp":"iso8601",
    "generated":1,
    "dispatched":1,
    "avgComposeMs":18,
    "sizeBytes": 4096,
    "sections":{"slo":true,"guards":true,"pnl":true,"approvals":true,"incidents":true,"decisions":true}
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul", dateFmt:"DD MMM YYYY" },

  schedule: {
    runAt: "18:10",                 // her gÃ¼n 18:10'da Ã¼ret (yerel saat)
    allowManualRun: true,
    catchUpMissed: true             // kapandÄ±ysa aÃ§Ä±ldÄ±ÄŸÄ±nda kaÃ§an gÃ¼nleri Ã¼ret
  },

  scopeProfiles: {
    // aynÄ± verinin farklÄ± kitlelere farklÄ± detayda sunumu
    ops:    { include:["slo","guards","pnl","approvals","incidents","decisions"], redact:false },
    exec:   { include:["slo","pnl","incidents","approvals"], compact:true, redact:true },
    policy: { include:["slo","guards","decisions","approvals","incidents"], focus:"limits/variants" }
  },

  compose: {
    charts: { sparkline:true, width:28, fillChar:"â–â–‚â–ƒâ–„â–…â–†â–‡â–ˆ" }, // ASCII sparkline
    tables: { maxRows:10, pad:1 },
    maxLen: { md: 12000, html: 20000 },
    topN:   { incidents:5, decisions:8 },
    severityRules: {
      warnIf:   { sloAtRisk>=1, guardModes:["slowdown","block_aggressive"], incidentCount>=1 },
      errorIf:  { sloBreach>=1, guardModes:["halt_entry","streams_panic"] }
    }
  },

  storage: {
    outDir: "data/digest/{YYYY-MM-DD}",
    fileNames: {
      ops:    "digest.ops.md",
      exec:   "digest.exec.md",
      policy: "digest.policy.md",
      html:   "digest.html"
    },
    atomicWrite: true
  },

  distribution: {
    channels: ["uiBridge","chatBridge:ops","email:exec"],
    retry: { max: 3, backoffMs: [1000, 2000, 5000] }
  },

  idempotencyTtlSec: 86400
}

5) Ä°Ã§erik Åablonu (Markdown iskeleti)
# GÃ¼nlÃ¼k Ã–zet â€” {{DATE_TR}} (TZ: Europe/Istanbul)

**KÄ±sa Ã–zet:** {{SUMMARY_LINE}}

## 1) SLO & Telemetri
- Guard success rate: {{GUARD_SLO_STATE}} (burn={{BURN}}%)
- Decision accept rate: {{DAR_SLO_STATE}}
- Latency p95: {{LAT_P95}} ms â€” {{LAT_SPARK}}

## 2) Guard ModlarÄ± (son 24s)
- Son mod: {{GUARD_LAST_MODE}} (neden: {{REASONS}})
- GeÃ§iÅŸler: {{GUARD_TRANSITIONS}}

## 3) PnL (USD)
| GerÃ§ekleÅŸen | GerÃ§ekleÅŸmemiÅŸ | Ãœcret | WinRate | RR Medyan |
|---:|---:|---:|---:|---:|
| {{PNL_REAL}} | {{PNL_UNREAL}} | {{FEES}} | {{WIN_RATE}} | {{RR_MED}} |

## 4) Onay AkÄ±ÅŸÄ±
- Bekleyen: {{APP_PENDING}} â€” Onaylanan: {{APP_APPROVED}} â€” Reddedilen: {{APP_REJECTED}} â€” SLA ihlali: {{APP_SLA_BREACH}}

## 5) Olaylar
{{INCIDENT_LIST}}  <!-- ilk 5, her biri: [sev] baÅŸlÄ±k (sÃ¼re), Ã§Ã¶zÃ¼m -->

## 6) Karar Ã–rnekleri
{{DECISION_SNIPPETS}} <!-- max 8 satÄ±r, kÄ±sa Ã¶zetler -->

> Not: AyrÄ±ntÄ±lar iÃ§in: app://notes/{{DATE}} ve app://digest/{{DATE}}


HTML varyantÄ± iÃ§in basit <table> ve <ul> ile aynÄ± iÃ§erik.

6) Boru HattÄ± (Pipeline)

Pencere SeÃ§imi

today = localDate(TZ); aralÄ±k: [00:00:00, 23:59:59] Istanbul.

Manuel tetiklenirse date parametresi alÄ±nabilir.

Veri Toplama

telemetry.slo.status (24h pencere), son telemetry.rollup.batch (slip/lat/exec sayÄ±larÄ±).

latency_slip.guard.directive & sentry.guard.directive geÃ§iÅŸleri.

pnl.daily (gÃ¼nÃ¼n PnLâ€™i).

approval.metrics, incident.* (baÅŸla/bitir), son 8 decision.rationale Ã¶zetleri.

notes.daily.md varsa kÄ±sa satÄ±r sayÄ±larÄ±.

Normalize & Ä°statistik

SLO: ok/at_risk/breach say; burnPct ort/tepe.

Sparkline: rollup points â†’ 0..1 normalize â†’ ASCII bar.

Guard geÃ§iÅŸleri: mod dizisi & zaman damgalarÄ± â†’ kÄ±sa zincir.

PnL tablo hÃ¼creleri, yÃ¼zde/para biÃ§imleme LIVIA-13 ile.

Åiddet (severity) EtiÄŸi

compose.severityRules ile info|warn|error belirle; digest.card.severity buna gÃ¶re.

Åablon Doldurma

Markdown iskeleti doldur; maxLen.md aÅŸÄ±lÄ±rsa â€œKarar Ã–rnekleriâ€ kes.

HTML gerekiyorsa basit dÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼.

Yaz & ArÅŸivle

storage.outDir altÄ±nda *.md/html dosyalarÄ± atomic yaz.

digest.daily.ready (her scope iÃ§in) + digest.card yayÄ±nla.

DaÄŸÄ±tÄ±m

distribution.channelsâ€™a gÃ¶re:

uiBridge â†’ digest.card ve link.

chatBridge:ops â†’ kÄ±saltÄ±lmÄ±ÅŸ mesaj (ilk 3 satÄ±r).

email:exec â†’ digest.exec.md gÃ¶vdesi (veya HTML).

BaÅŸarÄ±sÄ±z kanal iÃ§in retry/backoff; sonuÃ§ digest.distribute.

Ä°dempotency

AynÄ± date+scope+format bir kez Ã¼ret; tekrar tetikte no-op + digest.alert(info,"idem_duplicate").

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
cron(runAt) veya digest.generate.request{date?,scope?} â†’ COLLECT.

COLLECT
KaynaklarÄ± oku; birisi eksik/boÅŸ â†’ digest.alert("no_data|missing_timeseries") ama mevcutla devam â†’ COMPOSE.

COMPOSE
Ä°statistik/ÅŸablon doldur â†’ dosyalarÄ± hazÄ±rla â†’ WRITE.

WRITE
Atomic yaz â†’ digest.daily.ready(scope=ops|exec|policy) â†’ DISTRIBUTE.

DISTRIBUTE
Kanallara gÃ¶nder â†’ digest.distribute â†’ IDLE.

8) Kenar Durumlar

Veri Eksik: rollup.batch yoksa sparkline bÃ¶lÃ¼mÃ¼ â€œ(veri yok)â€ placeholder; alert Ã¼ret.

Ã‡ift GÃ¼n PnL: Ã‡oklu pnl.daily(date) gelirse son event kazanÄ±r; tutarsÄ±zlÄ±kta warn.

Uzun Ä°Ã§erik: maxLen aÅŸÄ±lÄ±rsa â€œKarar Ã–rnekleriâ€ ve â€œOlaylarâ€ kÄ±saltÄ±lÄ±r; kesildi notu.

Zaman KaymasÄ±: UTC kaynaklÄ± eventler lokal gÃ¼ne taÅŸarken saat farkÄ± kontrolÃ¼; sÄ±nÄ±rdaki olaylar dahil edilir.

DaÄŸÄ±tÄ±m HatasÄ±: Kanal baÅŸarÄ±sÄ±z â†’ retry; tÃ¼m retryâ€™lar bitince digest.alert(error,"distribution_failed").

Ä°dempotent Ã‡atÄ±ÅŸma: AynÄ± anda iki cron â†’ lock/lease (5 sn) ile tek yazÄ±m.

9) Telemetri
{
  "digest.metrics": {
    "event":"digest.metrics",
    "timestamp":"iso8601",
    "generated": 1,
    "dispatched": 1,
    "avgComposeMs": 18,
    "sizeBytes": 4096,
    "severity":"warn",
    "cacheHitRate": 0.0,
    "byChannel":{"uiBridge":"ok","chatBridge:ops":"ok","email:exec":"ok"}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/telemetryDailyDigest.ts        // FSM + orchestrasyon
services/livia/lib/digestCollect.ts           // veri toplayÄ±cÄ±/normalize
services/livia/lib/sparkline.ts               // ASCII sparkline Ã¼retici
services/livia/lib/digestCompose.ts           // md/html ÅŸablon doldurucu
services/livia/lib/distribute.ts              // ui/chat/email daÄŸÄ±tÄ±mÄ±
services/livia/lib/locks.ts                   // cron/atomic yazÄ±m kilidi
services/livia/state/digestStore.ts           // idem index + last run info
services/livia/__tests__/telemetryDailyDigest.test.ts
cfg/livia.digest.yaml                         // schedule/compose/storage/dist

11) Test Ä°skeleti (Jest/Vitest)

Temel Ãœretim: SLO+rollup+PnL+incident+approval ile digest.ops.md oluÅŸturur; card warn.

Veri Eksik: rollup yok â†’ sparkline â€œ(veri yok)â€, alert missing_timeseries.

Guard Error: halt_entry gÃ¶rÃ¼ldÃ¼ÄŸÃ¼nde card error.

DaÄŸÄ±tÄ±m Retry: chatBridge ilk iki deneme hata â†’ Ã¼Ã§Ã¼ncÃ¼de ok; digest.distribute.failed=[].

Ä°dempotency: aynÄ± gÃ¼n/format tekrar â†’ no-op + idem_duplicate.

Catch-Up: dÃ¼n kaÃ§Ä±rÄ±ldÄ± â†’ aÃ§Ä±lÄ±ÅŸta iki gÃ¼n birden Ã¼retir (schedule.catchUpMissed).

Uzun Ä°Ã§erik: 50 karar snippetâ€™i â†’ topN=8 ile kesilir, â€œ(kÄ±saltÄ±ldÄ±)â€ notu.

Lock: Ã§ift cron â†’ tek dosya yazÄ±lÄ±r, diÄŸerinde lock_timeout uyarÄ±sÄ±.

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

Saat 18:10 â†’ cron tetikler.

24s verileri toplanÄ±r; slip p95 18 bps, latency p95 760 ms; guard slowdownâ†’block_aggressive geÃ§miÅŸ.

PnL +$1.240; 1 incident 37 dk, Ã§Ã¶zÃ¼m rollback v42â†’v41.

digest.ops.md | exec.md | policy.md yazÄ±lÄ±r, digest.card(warn) yayÄ±nlanÄ±r.

uiBridge & chatBridge:ops & email:exec daÄŸÄ±tÄ±mÄ± tamamlanÄ±r.

13) SLO

P95 compose < 50 ms (dosya yazÄ±mÄ± hariÃ§).

GÃ¼n iÃ§i tekrar Ã¼retim = 0 (idempotent).

DaÄŸÄ±tÄ±m baÅŸarÄ±sÄ±zlÄ±k oranÄ± < %1 (retry dahil).

Sparkline Ã¼retimi < 2 ms.
______________________________________________________________________________________________
LIVIA-15 Â· incidentPostmortemWriter.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: Bir incident kapandÄ±ÄŸÄ±nda (veya elle tetiklendiÄŸinde) denetlenebilir bir postmortem taslaÄŸÄ± Ã¼retmek: Ã–zet, Etki, Zaman Ã‡izelgesi, Tespit, KÃ¶k-Neden Hipotezleri, DÃ¼zeltici/Ã–nleyici Aksiyonlar (CAPA), AÃ§Ä±k Sorular, Ekler. Verileri telemetry/anomaly, guard directives, policy.explain, decision.rationale, notes, approval ve digestâ€™ten topla; Markdown ana Ã§Ä±ktÄ± + opsiyonel HTML. Her ÅŸey event-driven JSON, Zod, Europe/Istanbul, idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest.

Zod .strict() ile tÃ¼m In/Out ÅŸemalarÄ±.

Zaman: ISO-8601, TZ=Europe/Istanbul.

Gizlilik: PII maskesi (LIVIA-21); dosyaya maskli yaz.

GÃ¼venlik: RBAC â€” ops|policy|trader okuyabilir; yazma yalnÄ±z ops|policy.

Ä°dempotency: pmKey = incidentId + "#" + draftVersion (vars. v1) veya sha256(window+facts); TTL 7 gÃ¼n.

Audit: her Outâ€™ta {eventId, producedBy:"livia-15", producedAt}.

Ä°Ã§erik Dili: TR kÄ±sa ve net; teknik terimler (TWAP, RR, halt_entry) korunur.

2) Girdiler (In) â€” Zod ÅŸema Ã¶rnekleri
{
  "incident.started": {
    "event":"incident.started",
    "timestamp":"iso8601",
    "id":"inc-2025-09-13-1",
    "severity":"low|medium|high|critical",
    "title":"Slip spike on SG02",
    "tags":["slip","latency","sg02"],
    "detectedBy":"anomaly|operator|monitor"
  },

  "incident.closed": {
    "event":"incident.closed",
    "timestamp":"iso8601",
    "id":"inc-2025-09-13-1",
    "resolution":"policy rollback v42â†’v41",
    "durationMin":37,
    "notes":"guard slowdownâ†’normal; spread dÃ¼zeldi",
    "impact":{"ordersAffected":128,"usersAffected":3,"pnlImpactUSD":-210.5}
  },

  "telemetry.anomaly.signal": {
    "event":"telemetry.anomaly.signal",
    "timestamp":"iso8601",
    "series":"order.slip.p95",
    "kind":"spike|drift|gap|flatline",
    "severity":"low|medium|high",
    "at":"iso8601",
    "context":{"symbol":"AVAXUSDT","env":"prod","node":"sg02"}
  },

  "telemetry.rollup.batch": {
    "event":"telemetry.rollup.batch",
    "timestamp":"iso8601",
    "window":"1m|5m",
    "series":[{"name":"order.slip.p95","max":27.2,"avg":14.8}]
  },

  "sentry.guard.directive": {
    "event":"sentry.guard.directive",
    "timestamp":"iso8601",
    "mode":"normal|degraded|streams_panic|halt_entry",
    "expiresAt":"iso8601",
    "reasonCodes":["feed_stale>5s","packet_gap>2s"]
  },

  "latency_slip.guard.directive": {
    "event":"latency_slip.guard.directive",
    "timestamp":"iso8601",
    "mode":"normal|slowdown|block_aggressive|halt_entry",
    "expiresAt":"iso8601",
    "reasonCodes":["slip_p95>15bps"]
  },

  "policy.explain": {
    "event":"policy.explain",
    "timestamp":"iso8601",
    "kind":"guard|bounds|variant|policy_change",
    "bullets":["Slip p95 18>15 bps","LIMIT Ã¶nerisi"],
    "citations":[{"path":"limits.maxSlipBps","version":"v42"}]
  },

  "decision.rationale": {
    "event":"decision.rationale",
    "timestamp":"iso8601",
    "summary":"PLAN ONAY: LIMIT + qty âˆ’%25â€¦",
    "sources":[{"ref":"action.approved","id":"run-42#commit#dlg-avax-42"}]
  },

  "approval.metrics": {
    "event":"approval.metrics",
    "timestamp":"iso8601",
    "pending":0,"approved":2,"rejected":0
  },

  "operator.notes.append": {
    "event":"operator.notes.append",
    "timestamp":"iso8601",
    "sessionId":"sess-avax-42",
    "lines":[{"ts":"iso8601","kind":"incident","text":"SG02 slip spike baÅŸladÄ±"}]
  },

  "digest.daily.ready": {
    "event":"digest.daily.ready",
    "timestamp":"iso8601",
    "digestKey":"2025-09-13#18:00-md",
    "summary":"â€¦ (incident 1, 37 dk)"
  },

  "postmortem.manual.request": {
    "event":"postmortem.manual.request",
    "timestamp":"iso8601",
    "incidentId":"inc-2025-09-13-1",
    "draftVersion":"v1|v2",
    "includeSections":["summary","timeline","rca","capa","openQuestions"],
    "assignee":"ops|policy-team|owner@company"
  }
}

3) Ã‡Ä±ktÄ±lar (Out) â€” Åemalar
{
  "postmortem.draft.ready": {
    "event":"postmortem.draft.ready",
    "timestamp":"iso8601",
    "incidentId":"inc-2025-09-13-1",
    "draftVersion":"v1",
    "pathMd":"data/postmortems/2025-09/inc-2025-09-13-1_v1.md",
    "pathHtml":"data/postmortems/2025-09/inc-2025-09-13-1_v1.html",
    "summary":"SG02 Ã¼zerinde slip p95 spike (max 27.2 bps); guard slowdown uygulanÄ±p politika rollback ile dÃ¼zeldi. Etki: 128 order, 3 kullanÄ±cÄ±, ~-$210.5.",
    "audit":{"eventId":"...","producedBy":"livia-15","producedAt":"iso8601"}
  },

  "postmortem.assign": {
    "event":"postmortem.assign",
    "timestamp":"iso8601",
    "incidentId":"inc-2025-09-13-1",
    "assignee":"policy-team",
    "due":"2025-09-14T18:00:00+03:00"
  },

  "postmortem.alert": {
    "event":"postmortem.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"missing_incident|insufficient_data|write_failed|idem_duplicate|rbac_forbidden",
    "context":{"incidentId":"inc-2025-09-13-1"}
  },

  "postmortem.metrics": {
    "event":"postmortem.metrics",
    "timestamp":"iso8601",
    "drafts": 1,
    "avgComposeMs": 9.1,
    "avgTimelineItems": 6,
    "withCitationsRate": 0.82
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  output: {
    dir: "data/postmortems/{YYYY-MM}",
    html: { enable: true, cssPreset: "pm-minimal" },
    atomicWrite: true,
    lockTimeoutMs: 3000
  },

  compose: {
    minFields: ["summary","impact","timeline","rca","capa"],
    maxOpenQuestions: 6,
    timelineWindowHours: 6,    // start/close Â±
    preferDailyDigestLinks: true,
    includeCitations: true
  },

  heuristics: {
    // RCA (fishbone) aday sÄ±nÄ±flar: Ä°nsan/SÃ¼reÃ§/Sistem/Veri/DÄ±ÅŸ
    rcaBuckets: ["System","Data","Process","Human","External"],
    rcaRules: [
      { ifTags:["slip","latency"], bucket:"System", hint:"Execution path latency & slippage" },
      { ifReasons:["feed_stale>5s","packet_gap>2s"], bucket:"Data", hint:"Market data freshness/gaps" },
      { ifKind:"policy_change", bucket:"Process", hint:"Change management / rollout" }
    ],
    capaTemplates: [
      { when:"System", action:"Order path latency budgets tighten; add p95 guard at 800ms", owner:"ops", dueHours:24 },
      { when:"Data", action:"Market feed watchdog, auto-failover playbook update", owner:"ops", dueHours:24 },
      { when:"Process", action:"Policy rollout checklist + canary %, rollback gates", owner:"policy-team", dueHours:48 }
    ]
  },

  rbac: {
    write: ["ops","policy"],
    read: ["ops","policy","trader"]
  },

  privacy: { piiMask:true },

  idempotencyTtlSec: 604800
}

5) Markdown Åablonu (taslak yapÄ±sÄ±)
# Postmortem â€” {{incidentId}} ({{severity}}) â€” {{dateLocal}}

**BaÅŸlÄ±k:** {{title}}
**Ã–zet:** {{summary}}

## Etki
- SÃ¼re: {{durationMin}} dk ({{startLocal}} â†’ {{endLocal}})
- Etkilenen emir: {{ordersAffected}}, kullanÄ±cÄ±: {{usersAffected}}
- PnL etkisi: {{pnlImpactUSD}}
- SLO ihlali: {{sloBreachNote}}

## Zaman Ã‡izelgesi
{{#each timeline}}
- {{tsLocal}} â€” **{{kind}}**: {{text}}
{{/each}}

## Tespit & MÃ¼dahale
- Tespit: {{detectedBy}} (anomaly/monitor/operator)
- Ä°lk mÃ¼dahale: {{firstResponse}}
- Guard: {{guardModes}} (Ã¶rn. slowdown 09:12â†’normal 10:25)
- Onay akÄ±ÅŸlarÄ±: {{approvals}}

## KÃ¶k Neden Hipotezleri (RCA)
{{#each rca}}
- **{{bucket}}** â€” {{hypothesis}} (kanÄ±t: {{evidence}})
{{/each}}

## DÃ¼zeltici/Ã–nleyici Aksiyonlar (CAPA)
{{#each capa}}
- [ ] {{action}} â€” **Sorumlu:** {{owner}}, **Son tarih:** {{due}}
{{/each}}

## AÃ§Ä±k Sorular
{{#each openQuestions}}
- {{this}}
{{/each}}

## AtÄ±flar
{{#each citations}}
- {{path}} ({{version}}) â€” {{href}}
{{/each}}

## Ekler
- GÃ¼nlÃ¼k Ã–zet: {{digestLink}}
- Ä°lgili Notlar: {{notesRefs}}
- Telemetri: slip.p95 max={{slipMax}} bps, spread.p95 max={{spreadMax}} bps

6) Pipeline (algoritma)

Tetikleyici

incident.closed geldiÄŸinde otomatik taslak oluÅŸtur.

postmortem.manual.request ile istenen incidentId iÃ§in yeniden derle veya draftVersion artÄ±r (v2, v3 â€¦).

Zaman Penceresi

timelineWindowHours kadar baÅŸlangÄ±Ã§/kapanÄ±ÅŸ Ã§evresi verileri topla (anomaly, guard, approvals, notes, rationale, explain).

Zaman Ã‡izelgesi Derleme

OlaylarÄ± kronolojik sÄ±rala; benzerleri birleÅŸtir (Ã¶r. peÅŸ peÅŸe slowdown â†’ tek satÄ±r aralÄ±klÄ±).

operator.notes.append satÄ±rlarÄ±ndan insan yorumu ekle (PII mask).

Ã–rnek kalemler: anomaly spike, guard enable/disable, approval pending/approved, rollback, plan onayÄ±/iptali, incident closed.

RCA Hipotezleri

rcaRules ile etiket/reason/kindâ€™e gÃ¶re bucket ve kÄ±sa hipotez Ã§Ä±kar.

Her hipotez iÃ§in kanÄ±t alanÄ±na ilgili timeline referansÄ± veya policy.explain maddesi ekle.

CAPA Ãœretimi

capaTemplates â†’ RCA bucketâ€™a gÃ¶re aksiyonlar Ã¶ner; owner ve due hesapla (now + dueHours).

AÃ§Ä±kta kalanlar iÃ§in boÅŸ â€œto-doâ€ bÄ±rak (checkbox).

Ã–zet & Etki

incident.closed.impact alanlarÄ±, PnL & etkilenen emir/kullanÄ±cÄ± sayÄ±larÄ± ile kÄ±sa Ã¶zet.

SLO ihlali varsa telemetry.slo.statusâ€™tan not Ã¼ret.

AtÄ±flar/Citations

policy.explain.citations[] ve knowledge.route.select.top[].passages[].cit varsa ekle.

Digest ve not dosyalarÄ± iÃ§in link alanlarÄ±nÄ± doldur.

YazÄ±m & Ã‡Ä±ktÄ±

Markdown + opsiyonel HTMLâ€™ye dÃ¶nÃ¼ÅŸtÃ¼r; atomic write + lock.

postmortem.draft.ready + postmortem.assign? (assignee varsa) + postmortem.metrics.

Ä°dempotency

AynÄ± incidentId + draftVersion tekrar derlenmek istenirse idem duplicate â†’ yalnÄ±zca mevcut pathâ€™leri re-emit et.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ incident.closed | postmortem.manual.request â†’ COLLECT

COLLECT â†’ ilgili olaylarÄ± pencereye gÃ¶re topla â†’ yeterli deÄŸilse postmortem.alert("insufficient_data") â†’ (IDLE)

COMPOSE â†’ timeline + rca + capa + Ã¶zet â†’ WRITE

WRITE â†’ md/html yaz; hata â†’ postmortem.alert("write_failed"); baÅŸarÄ± â†’ EMIT

EMIT â†’ postmortem.draft.ready (+ assign?) + postmortem.metrics â†’ IDLE

8) Kenar Durumlar

missing_incident: incident.closed yok; yalnÄ±z manual istek â†’ alert + minimal taslak (baÅŸlÄ±k/Ã¶zet/ aÃ§Ä±k sorular).

reopen: kapanmÄ±ÅŸ incident tekrar aÃ§Ä±ldÄ± â†’ yeni draftVersion ile â€œReopenâ€ notu timelineâ€™a eklenir.

PII leak: notes iÃ§inde PII mask baÅŸarÄ±sÄ±z â†’ o satÄ±r timelineâ€™dan Ã§Ä±kar.

Ã§ok uzun timeline: >200 satÄ±r â†’ â€œlite timelineâ€ mod; ilk 80 + son 20 + kritik olaylar.

Ã§ok az veri: anomaly/guard yok â†’ RCA yalnÄ±z â€œProcess/Humanâ€ hipotezleriyle baÅŸlar, CAPA yine Ã¼retilir.

RBAC: yazma yetkisi olmayan kullanÄ±cÄ±dan manual istek â†’ rbac_forbidden.

clock skew: olay saatleri sÄ±ralanamazsa ts normalizasyonu (Â±2 dk) ve â€œyaklaÅŸÄ±k saatâ€ etiketi.

9) Telemetri
{
  "postmortem.metrics": {
    "event":"postmortem.metrics",
    "timestamp":"iso8601",
    "drafts": 1,
    "avgComposeMs": 9.1,
    "avgTimelineItems": 6,
    "withCitationsRate": 0.82,
    "bySeverity":{"high":1},
    "liteModeRate":0.0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/incidentPostmortemWriter.ts        // FSM + orchestrasyon
services/livia/lib/timelineBuilder.ts             // toplama + normalize + birleÅŸtirme
services/livia/lib/rcaComposer.ts                 // bucket/hipotez Ã¼retimi
services/livia/lib/capaPlanner.ts                 // CAPA Ã¶neri & due hesap
services/livia/lib/citations.ts                   // policy/route linkleri
services/livia/lib/atomicFS.ts                    // atomic write + lock
services/livia/state/postmortemStore.ts           // idem index + last drafts
services/livia/__tests__/incidentPostmortemWriter.test.ts
cfg/livia.postmortem.yaml                         // output/compose/heuristics/rbac
templates/postmortem.md                           // ÅŸablon (opsiyonel override)

11) Test Ä°skeleti (Jest/Vitest)

Tam akÄ±ÅŸ: startedâ†’anomalyâ†’guardâ†’approvalâ†’closed â†’ taslak oluÅŸur, md/html yazÄ±lÄ±r.

RCA & CAPA: slip/latency etiketi â†’ System/Data bucket; CAPA Ã¶nerileri doÄŸru owner/due ile.

Idempotency: aynÄ± incidentId+v1 tekrar â†’ ikinci yazÄ±m yok, ready re-emit.

Manual v2: manual request v2 â†’ yeni pathâ€™ler ve â€œv2â€ baÅŸlÄ±k.

PII: notes iÃ§indeki e-posta/telefon maskâ€™lenir veya satÄ±r atlanÄ±r.

Lite timeline: 250+ olayda lite mode devreye girer.

RBAC: trader manual yazma isteÄŸi â†’ rbac_forbidden.

Clock skew: ts normalizasyonu ile sÄ±ralama bozulmaz.

Citations: policy.explain varsa citations alanÄ± dolar.

12) Ã–rnek KÄ±sa Ã‡Ä±ktÄ± (Markdown)
# Postmortem â€” inc-2025-09-13-1 (high) â€” 13.09.2025

**BaÅŸlÄ±k:** Slip spike on SG02  
**Ã–zet:** SG02 Ã¼zerinde slip p95 spike (max 27.2 bps). Guard slowdown ile giriÅŸler kÄ±sÄ±tlandÄ±; politika rollback v42â†’v41 sonrasÄ± normale dÃ¶ndÃ¼. Etki: 128 emir, 3 kullanÄ±cÄ±, PnL â‰ˆ -$210.5.

## Etki
- SÃ¼re: 37 dk (09:12 â†’ 09:49)
- SLO: ui_ack_p95 at_risk (1.52s / hedef 1.5s)

## Zaman Ã‡izelgesi
- 09:12 â€” **anomaly**: order.slip.p95 spike (max 27.2 bps)
- 09:13 â€” **guard**: slowdown (slip_p95>15bps)
- 09:20 â€” **approval**: failover 2/2 baÅŸlatÄ±ldÄ±
- 09:32 â€” **decision**: LIMIT + qty âˆ’%25 planÄ± onaylandÄ±
- 09:40 â€” **policy**: rollback v42â†’v41
- 09:49 â€” **incident**: closed (spread normale dÃ¶ndÃ¼)

## KÃ¶k Neden Hipotezleri
- **System** â€” YÃ¼rÃ¼tme yolunda gecikme â†‘; slip guard tetik (kanÄ±t: anomaly/guard)
- **Data** â€” BÃ¶lgesel feed gecikmesi (sg02 packet_gap>2s) (kanÄ±t: sentry reason)

## CAPA
- [ ] Order path p95 800ms guard eÅŸiÄŸi ve alarmlar â€” **Sorumlu:** ops â€” **Due:** 14.09 18:00
- [ ] Feed watchdog & auto-failover playbook â€” **Sorumlu:** ops â€” **Due:** 14.09 18:00
- [ ] Policy rollout checklist & rollback gates â€” **Sorumlu:** policy-team â€” **Due:** 15.09 18:00

## AÃ§Ä±k Sorular
- Canary yÃ¼zdesi yeterli miydi? Rollback tetik kriterleri net mi?

## AtÄ±flar
- limits.maxSlipBps (v42) â€” app://kb/policy/limits@v42#c1

13) SLO

P95 compose < 12 ms (Ã¶nbellekli verilerle).

withCitationsRate â‰¥ %75.

Atomic write hata oranÄ± < %0.5.

Lite timeline gereksinimi â‰¤ %10 (normal gÃ¼nlerde).
______________________________________________________________________________________________
LIVIA-16 Â· empathyDrivenCooldownPlanner.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§: OperatÃ¶rÃ¼n ve sistemin duygusal/psikolojik stres iÅŸaretlerinden yola Ã§Ä±karak idempotent, auditâ€™li ve Ã¶lÃ§Ã¼lebilir â€œcooldown/ara vermeâ€ planlarÄ± Ã¼retmek, uygun olduÄŸunda otomatik etkinleÅŸtirmek veya approval gateway Ã¼zerinden onaya sunmak; planÄ± UI kartÄ± olarak bildirmek; TTL bitiminde otomatik kaldÄ±rmak. Sinyal akÄ±ÅŸÄ±nÄ± geÃ§ici olarak kÄ±sma, sÄ±klÄ±k/pozisyon limiti uygulama ve zamanlayÄ±cÄ± bazlÄ± savunma ile VIVO/OtobilinÃ§/LIVIA-01â€™e baÄŸlanÄ±r.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest.

Event-driven JSON I/O; tÃ¼m payloadâ€™lar Zod .strict().

Zaman: ISO-8601, TZ=Europe/Istanbul; â€œgÃ¼nâ€ penceresi 00:00â€“23:59:59 (yerel).

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC: okuma ops|policy|trader, yazma yalnÄ±z sistem ve policy.

Gizlilik: PII yok; operatÃ¶r kimliÄŸi gerekiyorsa hash(pseudonym) ve salt (gÃ¼nlÃ¼k dÃ¶nÃ¼ÅŸÃ¼mlÃ¼).

Ä°dempotency: cooldownKey = scope + symbol? + reasonCode + windowStartISO; TTL iÃ§inde yinelenen planÄ± yeniden yazma.

Telemetri: cooldown.metrics; uyarÄ±lar: cooldown.alert.

2) Girdiler (In) â€” Zodâ€™a Ã§evrilecek ÅŸema Ã¶rnekleri
{
  "bias.awareness": {
    "event":"bias.awareness",
    "timestamp":"iso8601",
    "operatorId":"op-007",
    "scores": { "overconfidence":0.72, "loss_aversion":0.18, "risk_seeking":0.54 },
    "window":"30m",
    "source":"LIVIA-03"
  },

  "operator.stress.metrics": {
    "event":"operator.stress.metrics",
    "timestamp":"iso8601",
    "overtradingLoop": { "count1h":6, "lossPct":0.52 },
    "hesitation": { "missed":3, "rebounds":2 },
    "emotionalSurge": { "last10m":{"positions":3,"rsiVolMismatch":true} }
  },

  "trade.loss.series": {
    "event":"trade.loss.series",
    "timestamp":"iso8601",
    "sequence":[{"id":"t1","pnlUSD":-120},{"id":"t2","pnlUSD":-85},{"id":"t3","pnlUSD":-60}],
    "window":"45m"
  },

  "guard.mode": {
    "event":"guard.mode",
    "timestamp":"iso8601",
    "sentry":"normal|degraded|streams_panic|halt_entry",
    "latency_slip":"normal|slowdown|block_aggressive|halt_entry"
  },

  "dialog.metrics": {
    "event":"dialog.metrics",
    "timestamp":"iso8601",
    "prompts":41,"answers":36,"acceptRate":0.78,"p95AnswerMs":920
  },

  "policy.override.request": {
    "event":"policy.override.request",
    "timestamp":"iso8601",
    "cooldownKey":"...",
    "requestedBy":"policy|ops",
    "rationale":"acil geri dÃ¶nÃ¼ÅŸ"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "cooldown.plan.proposed": {
    "event":"cooldown.plan.proposed",
    "timestamp":"iso8601",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "reasonCode":"overconfidence|fomo|loss_aversion|overtrading|emotional_surge|panic_mode",
    "policy": { "durationMin": 30, "signalRateMaxPer10m": 1, "positionLimitFactor": 0.5 },
    "ttlSec": 1800,
    "audit":{"eventId":"...","producedBy":"LIVIA-16"}
  },

  "cooldown.plan.activated": {
    "event":"cooldown.plan.activated",
    "timestamp":"iso8601",
    "cooldownKey":"...",
    "effectiveFrom":"iso8601",
    "effectiveUntil":"iso8601",
    "appliedBy":"auto|approval_gateway",
    "hash":"sha256:..."
  },

  "cooldown.card": {
    "event":"cooldown.card",
    "timestamp":"iso8601",
    "title":"GeÃ§ici Savunma â€” {scope}",
    "body":"AÅŸÄ±rÄ± gÃ¼ven/FOMO riski â†’ {durationMin} dk sinyal kÄ±sÄ±tlamasÄ±. GerekÃ§e: {reason}.",
    "severity":"warn|info",
    "ttlSec":600
  },

  "cooldown.alert": {
    "event":"cooldown.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|write_failed|invalid_scope|approval_required|expired",
    "context":{"cooldownKey":"..."}
  },

  "cooldown.metrics": {
    "event":"cooldown.metrics",
    "timestamp":"iso8601",
    "proposed":1,
    "activated":1,
    "expired":0,
    "avgDecayMin":28,
    "byReason":{"overconfidence":1},
    "mdBytes":820,
    "htmlBytes":0
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  thresholds: {
    // tetikleyici eÅŸikler
    overconfidence: ">=0.70",
    risk_seeking: ">=0.60",
    loss_series3: "<=-250 USD in 45m",
    overtrading1h: ">=5 positions & lossPct>=0.5",
    emotionalSurge10m: "positions>=3 & rsiVolMismatch=true",
    guardEscalation: ["degraded","slowdown","block_aggressive","halt_entry"]
  },

  policyMatrix: {
    // sebepâ†’varsayÄ±lan plan
    overconfidence: { durationMin: 30, signalRateMaxPer10m: 1, positionLimitFactor: 0.6 },
    fomo:           { durationMin: 20, signalRateMaxPer10m: 1, positionLimitFactor: 0.7 },
    loss_aversion:  { durationMin: 25, signalRateMaxPer10m: 1, positionLimitFactor: 0.8 },
    overtrading:    { durationMin: 45, signalRateMaxPer10m: 0, positionLimitFactor: 0.5 },
    emotional_surge:{ durationMin: 30, signalRateMaxPer10m: 0, positionLimitFactor: 0.6 },
    panic_mode:     { durationMin: 60, signalRateMaxPer10m: 0, positionLimitFactor: 0.4 }
  },

  schedule: { // plan sonu/temizlik
    sweepEvery: "1m",
    maxActivePerScope: 3
  },

  approval: {
    requireFor: ["durationMin>=45","panic_mode"],
    gateway: "LIVIA-05"
  },

  idempotencyTtlSec: 3600
}

5) Mesaj/Ä°Ã§erik TaslaÄŸÄ±

BaÅŸlÄ±k: GeÃ§ici Savunma â€” {scope}

Ã–zet: {reasonLabel} riski algÄ±landÄ±; {durationMin} dk boyunca sinyaller kÄ±sÄ±tlanacak.

Detay: Sinyal sÄ±klÄ±ÄŸÄ± max {signalRateMaxPer10m}/10dk, pozisyon limiti x{positionLimitFactor}.

Dipnot: Otomatik; {effectiveFrom}â€“{effectiveUntil}, itiraz iÃ§in Policy.

6) Kompozisyon (Pipeline)

Toplama: Son 30â€“60 dakikalÄ±k bias.awareness, operator.stress.metrics, trade.loss.series, guard.mode, dialog.metrics.

Skorla: AÄŸÄ±rlÄ±klÄ± risk puanÄ± R = f(overconfidence, risk_seeking, loss_series, overtrading, surge, guard).

Sebep seÃ§: En yÃ¼ksek risk katkÄ±sÄ± â†’ reasonCode (eÅŸitlikte panic_mode Ã¶ncelikli).

Politika eÅŸleÅŸmesi: policyMatrix[reasonCode] + guard durumuyla modifiye (halt_entry â†’ signalRate=0).

Ä°dempotency: cooldownKey Ã¼ret; aktif Ã§akÄ±ÅŸma varsa geniÅŸlet/merge et.

Onay: approval.requireFor eÅŸiklerinde LIVIA-05â€™e approval.request gÃ¶nder; aksi halde otomatik etkinleÅŸtir.

YayÄ±n: cooldown.plan.(proposed|activated) + cooldown.card + cooldown.metrics.

SÃ¼reÃ§ Sonu: TTL dolunca expired; sweep temizliÄŸi; telemetri gÃ¼ncelle.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE
(bias|stress|loss|guard|request) â†’ EVALUATE

EVALUATE
Skor hesapla, plan taslaÄŸÄ± â†’ DRAFT

DRAFT
requireApproval? â†’ AWAIT_APPROVAL | aksi â†’ ACTIVATE

AWAIT_APPROVAL
approval.granted â†’ ACTIVATE; rejected/timeout â†’ IDLE (+alert)

ACTIVATE
PlanÄ± kaydet, kartÄ± yayÄ±nla â†’ ACTIVE

ACTIVE
ttl_expired â†’ EXPIRE

EXPIRE
Temizle, metrik yaz â†’ IDLE
Hata: IDLE + cooldown.alert("write_failed"|...)

8) Kenar Durumlar

Ã‡akÄ±ÅŸan plan: AynÄ± scope/symbol iÃ§in aktif plan â†’ merge (sÃ¼reyi uzun, limitleri sÄ±kÄ± olanÄ± seÃ§).

Guard=halt_entry: Sinyal oranÄ± otomatik 0; plan sebebi panic_mode.

Eksik skor: YalnÄ±z overtrading veya loss_series varsa yine plan Ã¼retilir.

OperatÃ¶r yok: Symbol-scope planlarÄ± operatÃ¶r kimliÄŸinden baÄŸÄ±msÄ±z Ã§alÄ±ÅŸÄ±r.

Onay gecikmesi: approval.timeout â†’ conservative auto-plan (kÄ±sa sÃ¼re, sÄ±kÄ± limit).

9) Telemetri
{
  "cooldown.metrics": {
    "event":"cooldown.metrics",
    "timestamp":"iso8601",
    "proposed": 2,
    "activated": 1,
    "expired": 1,
    "avgDecayMin": 26,
    "byReason": {"overconfidence":1, "overtrading":1},
    "highlights": ["panic_mode:false","merged:true","approval:skipped"]
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/empathyDrivenCooldownPlanner.ts   // FSM + composer + scheduler
services/livia/lib/cooldownPolicy.ts             // policyMatrix & eÅŸik karar mantÄ±ÄŸÄ±
services/livia/lib/cooldownStore.ts              // active plans + idem index
services/livia/lib/redact.ts                     // operator hash/PII temizlik
services/livia/lib/approvalBridge.ts             // LIVIA-05 entegrasyonu
services/livia/__tests__/empathyDrivenCooldownPlanner.test.ts
cfg/livia.cooldown.yaml                          // thresholds/policy/approval/schedule

11) Test Ä°skeleti (Jest/Vitest)

EÅŸik/Plan: overconfidence=0.72 â†’ 30 dk plan, rate 1/10dk, posLimitÃ—0.6.

Overtrading: 1h=6 iÅŸlem & lossPct 0.52 â†’ 45 dk, rate 0, posLimitÃ—0.5.

Guard Etkisi: block_aggressive â†’ rate min(Ã¶neri, 0) = 0.

Approval: durationâ‰¥45 â†’ AWAIT_APPROVAL, grant sonrasÄ± ACTIVATE.

Idempotency: aynÄ± cooldownKey ile 2. Ã¼retim yok; Ã§akÄ±ÅŸanda merge.

Expire: TTL dolunca expired ve metrikler gÃ¼ncellendi.

RBAC/Auth: imza yok/yanlÄ±ÅŸ â†’ cooldown.alert(error,"auth_failed").

TR Kart: baÅŸlÄ±k/gerekÃ§e kÄ±sa, 280 karakter altÄ±.

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

16:05 â†’ bias.awareness(overconfidence=0.74) + operator.stress.metrics(overtrading1h=6, lossPct=0.5)

EVALUATEâ†’DRAFT: reason=overtrading, plan=45 dk, rate=0, posLimitÃ—0.5

AWAIT_APPROVAL (â‰¥45 dk) â†’ LIVIA-05 onayÄ± â†’ ACTIVATE

cooldown.card yayÄ±n, VIVO sinyal debisi kÄ±sÄ±lÄ±r, LIVIA-01 operatÃ¶r akÄ±ÅŸÄ±nda bilgi gÃ¶rÃ¼nÃ¼r.

13) SLO

P95 karar kompozisyonu < 50 ms (cacheâ€™li skorlar).

Yazma hatasÄ± oranÄ± < %0.5 (atomic write + lock).

Ä°dempotent Ã§akÄ±ÅŸma oranÄ± â‰ˆ 0; merge doÄŸruluk testleri â‰¥ %99.

Kart Ã¼retiminden sonra 1 sn iÃ§inde etkin plan stateâ€™i gÃ¶rÃ¼nebilir.
______________________________________________________________________________________________
LIVIA-17 Â· reactiveDefenseGate.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§:
Duygusal/taktiksel tetikleyiciden hemen sonra (Ã¶r. FOMO, intikam iÅŸlemi, aÅŸÄ±rÄ± gÃ¼ven, panik, guard-escalation) kÄ±sa sÃ¼reli savunma duvarÄ± kur. Bu duvar; sinyal debisini kÄ±smak, pozisyon limitini azaltmak, belirli varyantlarÄ± (Ã¶r. â€œaggressiveâ€) geÃ§ici olarak kapatmak ve gerektiÄŸinde tam durdurma (halt) uygulamak iÃ§in kullanÄ±lÄ±r. SÃ¼re sonunda otomatik sÃ¶ner; onay gerektiren durumlarda LIVIA-05 ile entegrasyon yapar. TÃ¼m I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics standartlÄ±.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601, TZ=Europe/Istanbul; â€œgÃ¼nâ€ penceresi 00:00â€“23:59:59 (yerel)

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC â€” ops|policy|observer okur, yazÄ±m sadece sistem/policy

Gizlilik: PII yok; operatÃ¶r kimliÄŸi gerekiyorsa hash(salt gÃ¼nlÃ¼k dÃ¶ner)

Ä°dempotency: gateKey = scope + symbol? + trigger + startedAtISO; aktif pencere iÃ§inde yinelenen duvar yeniden yazÄ±lmaz

Telemetri: defense.metrics; uyarÄ±lar: defense.alert

Uyum: LIVIA-16 (cooldown) ile Ã§akÄ±ÅŸma yok; gate anlÄ±k savunma (dakikalar), cooldown davranÄ±ÅŸsal (daha uzun)

2) Girdiler (In) â€” Zodâ€™a Ã§evrilecek ÅŸema Ã¶rnekleri
{
  "emotion.trigger": {
    "event":"emotion.trigger",
    "timestamp":"iso8601",
    "trigger":"fomo|revenge|overconfidence|panic",
    "confidence":0.82,
    "source":"LIVIA-03",
    "symbol":"AVAXUSDT|null"
  },

  "trade.executed": {
    "event":"trade.executed",
    "timestamp":"iso8601",
    "id":"t-9283",
    "side":"buy|sell",
    "symbol":"AVAXUSDT",
    "pnlUSD": -12.4,
    "context":{"variant":"aggressive|balanced|conservative"}
  },

  "guard.escalation": {
    "event":"guard.escalation",
    "timestamp":"iso8601",
    "from":"normal|degraded|slowdown",
    "to":"slowdown|block_aggressive|halt_entry",
    "reason":"slip|latency|spread|feed_gap",
    "symbol":"AVAXUSDT|null"
  },

  "bias.snapshot": {
    "event":"bias.snapshot",
    "timestamp":"iso8601",
    "scores":{"fomo":0.71,"overconfidence":0.66,"loss_aversion":0.22}
  },

  "policy.override.request": {
    "event":"policy.override.request",
    "timestamp":"iso8601",
    "gateKey":"...",
    "requestedBy":"policy|ops",
    "rationale":"kritik gÃ¶rev"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "defense.gate.proposed": {
    "event":"defense.gate.proposed",
    "timestamp":"iso8601",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "trigger":"fomo|revenge|overconfidence|panic|guard_escalation",
    "policy": { "durationSec": 600, "signalRateMaxPer2m": 1, "blockVariants": ["aggressive"] },
    "ttlSec": 600,
    "audit":{"eventId":"...","producedBy":"LIVIA-17"}
  },

  "defense.gate.activated": {
    "event":"defense.gate.activated",
    "timestamp":"iso8601",
    "gateKey":"...",
    "effectiveFrom":"iso8601",
    "effectiveUntil":"iso8601",
    "appliedBy":"auto|approval_gateway",
    "hash":"sha256:..."
  },

  "defense.card": {
    "event":"defense.card",
    "timestamp":"iso8601",
    "title":"Reaktif Savunma â€” {scope}",
    "body":"{triggerLabel} sonrasÄ± {durationSec}s kÄ±sÄ±tlama: 2 dakikada max {signalRateMaxPer2m} sinyal; {blocked} kapalÄ±.",
    "severity":"warn|info",
    "ttlSec":600
  },

  "defense.alert": {
    "event":"defense.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|write_failed|invalid_scope|approval_required|expired",
    "context":{"gateKey":"..."}
  },

  "defense.metrics": {
    "event":"defense.metrics",
    "timestamp":"iso8601",
    "proposed":1,"activated":1,"expired":0,
    "avgActiveSec":580,
    "byTrigger":{"fomo":1},
    "merged":0
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  thresholds: {
    fomo: ">=0.70",
    overconfidence: ">=0.65",
    revengeAfterSL: { lossesIn5m: ">=1", followTradeWithinSec: "<=120" },
    guardToHalt: true  // guard.halt_entry â†’ tam durdurma
  },

  policyMatrix: {
    fomo:            { durationSec: 600,  signalRateMaxPer2m: 1, blockVariants:["aggressive"] },
    overconfidence:  { durationSec: 900,  signalRateMaxPer2m: 1, blockVariants:["aggressive","balanced"] },
    revenge:         { durationSec: 1200, signalRateMaxPer2m: 0, blockVariants:["*"] },
    panic:           { durationSec: 1800, signalRateMaxPer2m: 0, blockVariants:["*"] },
    guard_escalation:{ durationSec: 600,  signalRateMaxPer2m: 0, blockVariants:["aggressive"] }
  },

  approval: {
    requireFor: ["panic","revenge","durationSec>=1200"],
    gateway: "LIVIA-05"
  },

  schedule: {
    sweepEvery: "30s",
    maxActivePerScope: 5
  },

  idempotencyTtlSec: 1800
}

5) Ä°Ã§erik/Kart TaslaÄŸÄ±

BaÅŸlÄ±k: Reaktif Savunma â€” {scope}

Ã–zet: {triggerLabel} algÄ±landÄ±; {durationSec}s boyunca sinyaller kÄ±sÄ±tlanacak.

Detay: 2 dk iÃ§inde en fazla {signalRateMaxPer2m} sinyal; bloklanan varyantlar: {blocked}.

Dipnot: {effectiveFrom}â€“{effectiveUntil}; itiraz â†’ Policy.

6) Kompozisyon (Pipeline)

Topla: Son 10â€“30 dakikalÄ±k emotion.trigger, trade.executed, guard.escalation, bias.snapshot.

Skorla: R = w1*fomo + w2*overconfidence + w3*(revenge pattern) + w4*(guard state); guard=halt â†’ R=1.0

Tetik seÃ§: En baskÄ±n tetik + guard durumu â†’ trigger

Politika eÅŸleÅŸtir: policyMatrix[trigger]; guard=halt_entry ise blockVariants=["*"], rate=0

Ä°dempotency: gateKey Ã¼ret; aynÄ± scope/trigger aktifse merge (sÃ¼re=uzun olanÄ±, blok=set birleÅŸimi, rate=min)

Onay: approval.requireFor tetiklenirse LIVIA-05â€™e istek; aksi halde otomatik etkinleÅŸtir

Emit: defense.gate.(proposed|activated) + defense.card + defense.metrics

SÃ¼reÃ§ Sonu: TTL dolunca expired; sweep temizliÄŸi; metrik gÃ¼ncelle

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (emotion.trigger | guard.escalation | trade.executed) â†’ EVALUATE

EVALUATE â†’ skor + politika â†’ DRAFT

DRAFT â†’ (requireApproval?) AWAIT_APPROVAL | ACTIVATE

AWAIT_APPROVAL â†’ approval.granted â†’ ACTIVATE | rejected/timeout â†’ IDLE (+alert)

ACTIVATE â†’ gate kaydÄ± + kart â†’ ACTIVE

ACTIVE â†’ ttl_expired | override â†’ EXPIRE

EXPIRE â†’ temizlik + telemetri â†’ IDLE

Hata: IDLE + defense.alert(...)

8) Kenar Durumlar

Ã‡akÄ±ÅŸan Gate: AynÄ± scope/trigger aktif â†’ merge; daha sÄ±kÄ± kurallar Ã¶nceliklenir

Guard=halt_entry: Tam durdurma; tÃ¼m varyantlar kapalÄ±; sinyal debisi 0

Sadece trade.executed: Son SLâ€™den â‰¤120s iÃ§inde yeni iÅŸlem â†’ tetik â€œrevengeâ€

OperatÃ¶r kimliÄŸi yok: Sembole/scopeâ€™a gÃ¶re gate Ã§alÄ±ÅŸÄ±r; PII tutulmaz

Override request: Policy onayÄ±yla gate erken kapatÄ±labilir

LIVIA-16 ile birlikte: Gate aktifken LIVIA-16 planÄ± tetiklenirse Ã§eliÅŸki yok; gate kÄ±sa vadeli, cooldown orta vadeli

9) Telemetri
{
  "defense.metrics": {
    "event":"defense.metrics",
    "timestamp":"iso8601",
    "proposed":2,"activated":1,"expired":1,
    "avgActiveSec":540,
    "byTrigger":{"fomo":1,"guard_escalation":1},
    "merged":1,
    "highlights":["panic:false","halt:false","approval:skipped"]
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/reactiveDefenseGate.ts        # FSM + composer + scheduler
services/livia/lib/gatePolicy.ts             # policyMatrix & skor mantÄ±ÄŸÄ±
services/livia/lib/gateStore.ts              # active gates + idem index
services/livia/lib/redact.ts                 # hash/PII temizlik (ortak)
services/livia/lib/approvalBridge.ts         # LIVIA-05 entegrasyonu
services/livia/__tests__/reactiveDefenseGate.test.ts
cfg/livia.defense-gate.yaml                  # thresholds/policy/approval/schedule

11) Test Ä°skeleti (Jest/Vitest)

FOMO â‰¥0.70: 600s gate, rate 1/2m, aggressive kapalÄ±

Revenge pattern: SLâ€™den â‰¤120s iÅŸlem â†’ 1200s gate, rate 0, * kapalÄ± (approval gerekir)

Guard Escalationâ†’halt_entry: rate 0, * kapalÄ±, onay zorunlu deÄŸil (zaten sistemsel durdurma)

Merge: aynÄ± scope/trigger aktifken ikinci teklif â†’ sÃ¼re max, rate min, block birleÅŸim

Idempotency: aynÄ± gateKey ile ikinci yazÄ±m yok

Expire: TTL bitince expired ve metrikler gÃ¼ncellenir

RBAC/Auth: imza yok/yanlÄ±ÅŸ â†’ defense.alert(error,"auth_failed")

TR Kart sÄ±nÄ±rÄ±: 280 karakter altÄ±

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

14:03 emotion.trigger(fomo, 0.78, AVAXUSDT) + 14:04 trade.executed

EVALUATEâ†’DRAFT: trigger=fomo; politika=600s, 1/2m, aggressive kapalÄ±

ACTIVATE: defense.gate.activated + defense.card; VIVO sinyal debisi kÄ±sÄ±lÄ±r

14:15 TTL dolunca gate kapanÄ±r; expired emit edilir

13) SLO

P95 karar kompozisyonu < 40 ms (Ã¶nbellekli skorlar)

Yazma hatasÄ± oranÄ± < %0.5 (atomic write + lock)

Ä°dempotent Ã§akÄ±ÅŸma â‰ˆ 0; merge doÄŸruluk testleri â‰¥ %99

Kart yayÄ±nÄ±ndan â‰¤1 sn sonra gate stateâ€™i UIâ€™da gÃ¶rÃ¼nÃ¼r
______________________________________________________________________________________________
LIVIA-18 Â· behavioralAnchorReset.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§:
Savunma dÃ¶nemleri (gate/cooldown/incident) sonrasÄ±nda sistemi â€œkonservatiften normaleâ€ geri taÅŸÄ±mak iÃ§in davranÄ±ÅŸsal anchor setini yeniden kalibre et. Anchor = risk iÅŸtahÄ±, onay eÅŸiÄŸi, sinyal varyant izinleri, gÃ¼nlÃ¼k iÅŸlem limiti ve onay gereksinimi gibi global/desk/symbol dÃ¼zeyi politika parametreleri.
KoÅŸullar uygunsa kademeli (ramp-up) geri yÃ¼kleme uygula; deÄŸilse konservatif modda kal. TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics standartlÄ±.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest.

Zaman: ISO-8601, TZ=Europe/Istanbul; gÃ¼n penceresi 00:00â€“23:59:59 (yerel).

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC: ops|policy yazar/okur, observer okur.

Gizlilik: PII yok; operatÃ¶r kimliÄŸi gerekir ise hash (salt gÃ¼nlÃ¼k dÃ¶ner).

Ä°dempotency: anchorKey = scope + symbol? + stage + forDate; aynÄ± anahtarda ikinci yazÄ±m yok.

Telemetri: anchor.metrics; uyarÄ±: anchor.alert.

2) Girdiler (In) â€” Zodâ€™a Ã§evrilecek ÅŸema Ã¶rnekleri
{
  "cooldown.expired": {
    "event":"cooldown.expired",
    "timestamp":"iso8601",
    "cooldownKey":"...",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "reasonCode":"overtrading|overconfidence|panic_mode"
  },

  "defense.gate.expired": {
    "event":"defense.gate.expired",
    "timestamp":"iso8601",
    "gateKey":"...",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "trigger":"fomo|revenge|overconfidence|panic|guard_escalation"
  },

  "incident.closed": {
    "event":"incident.closed",
    "timestamp":"iso8601",
    "id":"inc-2025-09-13-1",
    "severity":"low|medium|high|critical",
    "durationMin":37
  },

  "pnl.daily.provisional": {
    "event":"pnl.daily.provisional",
    "timestamp":"iso8601",
    "netUSD": 1610.24,
    "winRate": 0.56,
    "rrMedian": 1.42
  },

  "trade.streak.summary": {
    "event":"trade.streak.summary",
    "timestamp":"iso8601",
    "lossStreak": 0,
    "winStreak": 2,
    "lastWinLoss":"win|loss",
    "windowMin": 120
  },

  "bias.snapshot": {
    "event":"bias.snapshot",
    "timestamp":"iso8601",
    "scores":{"fomo":0.21,"overconfidence":0.33,"loss_aversion":0.28}
  },

  "guard.mode": {
    "event":"guard.mode",
    "timestamp":"iso8601",
    "sentry":"normal|degraded|streams_panic|halt_entry",
    "latency_slip":"normal|slowdown|block_aggressive|halt_entry"
  }
}


Not: cooldown.expired ve/veya defense.gate.expired tetikleyicidir; incident.closed varsa ek bekleme ve daha yavaÅŸ ramp.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "anchor.reset.proposed": {
    "event":"anchor.reset.proposed",
    "timestamp":"iso8601",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "stage":"ramp1|ramp2|full",
    "policyPatch": {
      "confirmationThresholdDelta": -0.1,
      "allowVariants": ["balanced","conservative"],
      "dailyTradeCap": 3,
      "positionLimitFactor": 0.8
    },
    "rationale":"cooldown bitti; bias dÃ¼ÅŸÃ¼k; guard=normal; PnLâ‰¥0",
    "ttlSec": 1800,
    "audit":{"producedBy":"LIVIA-18"}
  },

  "anchor.reset.activated": {
    "event":"anchor.reset.activated",
    "timestamp":"iso8601",
    "anchorKey":"...",
    "effectiveFrom":"iso8601",
    "effectiveUntil":"iso8601",
    "appliedBy":"auto|approval_gateway",
    "hash":"sha256:..."
  },

  "anchor.card": {
    "event":"anchor.card",
    "timestamp":"iso8601",
    "title":"DavranÄ±ÅŸsal Anchor Yenilendi â€” {scope}",
    "body":"{stage} aÅŸamasÄ±: onay eÅŸiÄŸi {Î”}, varyantlar {allowVariants}, gÃ¼nlÃ¼k limit {dailyTradeCap}, pozisyon Ã—{positionLimitFactor}.",
    "severity":"info",
    "ttlSec":600
  },

  "anchor.alert": {
    "event":"anchor.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|write_failed|not_ready|guard_not_normal|pnlnonpos",
    "context":{"stage":"ramp1","scope":"desk"}
  },

  "anchor.metrics": {
    "event":"anchor.metrics",
    "timestamp":"iso8601",
    "proposed":1,"activated":1,"rolledBack":0,
    "avgRampMin":45,
    "byStage":{"ramp1":1},
    "highlights":["guard:normal","biasLow:true","pnl>=0:true"]
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  readiness: {
    minQuietMin: 15,                 // Gate/Cooldown sonrasÄ± sinyal sessizliÄŸi
    maxBiasScores: { fomo: 0.35, overconfidence: 0.40 }, // Ã¼stÃ¼nde ise bekle
    guardMustBe: ["normal"],         // guardâ‰ normal â†’ reset yok
    requireNonNegativePnL: true      // gÃ¼n PnL < 0 ise sadece ramp1
  },

  rampPolicy: {
    ramp1: { confirmationThresholdDelta: -0.10, allowVariants:["conservative","balanced"], dailyTradeCap: 2, positionLimitFactor: 0.7, minHoldMin: 30 },
    ramp2: { confirmationThresholdDelta: -0.20, allowVariants:["balanced"],                dailyTradeCap: 3, positionLimitFactor: 0.8, minHoldMin: 60 },
    full:  { confirmationThresholdDelta: -0.30, allowVariants:["balanced","aggressive"],   dailyTradeCap: 3, positionLimitFactor: 1.0, minHoldMin: 90 }
  },

  approval: {
    requireFor: ["full","Î”threshold<=-0.25","allowAggressive"],
    gateway: "LIVIA-05"
  },

  schedule: {
    sweepEvery: "5m",                // ramp aÅŸamasÄ± kontrolÃ¼
    postIncidentCooldownMin: 20      // incident.closed sonrasÄ± ek bekleme
  },

  idempotencyTtlSec: 3600
}

5) Ä°Ã§erik/Kart TaslaÄŸÄ±

BaÅŸlÄ±k: DavranÄ±ÅŸsal Anchor Yenilendi â€” {scope}

Ã–zet: {stage} aÅŸamasÄ± baÅŸlatÄ±ldÄ±; onay eÅŸiÄŸi {Î”}, varyantlar {allowVariants}.

Detay: GÃ¼nlÃ¼k limit {dailyTradeCap}, pozisyon Ã—{positionLimitFactor} (guard={guardState}).

Dipnot: {effectiveFrom}â€“{effectiveUntil}; itiraz â†’ Policy.

6) Kompozisyon (Pipeline)

Topla: cooldown.expired | defense.gate.expired | incident.closed | pnl.daily.provisional | trade.streak.summary | bias.snapshot | guard.mode.

Uygunluk (readiness) kontrolÃ¼:

quiet â‰¥ minQuietMin

bias â‰¤ maxBiasScores (fomo/overconfidence)

guard âˆˆ guardMustBe

PnLâ‰¥0 ise ramp2/full aÃ§Ä±labilir; <0 ise ramp1 ile sÄ±nÄ±rlÄ±

AÅŸama seÃ§imi: Ã–nceki stageâ€™e gÃ¶re ramp1 â†’ ramp2 â†’ full. Incident yÃ¼ksekse ramp1 zorunlu.

Politika yamasÄ±: rampPolicy[stage] uygulanÄ±r; allowAggressive yalnÄ±z fullâ€™de ve guard=normalâ€™de.

Onay: approval.requireFor tetiklenirse LIVIA-05â€™e istek; aksi halde otomatik etkinleÅŸtir.

Ä°dempotency: anchorKey ile var olanÄ± kontrol et; aktif aynÄ± stage varsa sÃ¼resini uzat, tekrar yazma.

Emit: anchor.reset.(proposed|activated) + anchor.card + anchor.metrics.

Ramp izleme: sweepEvery ile minHold aÅŸÄ±ldÄ±ysa bir Ã¼st aÅŸamaya EVALUATE.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (cooldown.expired | gate.expired | schedule.sweep) â†’ EVALUATE

EVALUATE â†’ readiness ok â†’ DRAFT | not_ready â†’ IDLE (+alert)

DRAFT â†’ (requireApproval?) AWAIT_APPROVAL | ACTIVATE

AWAIT_APPROVAL â†’ approval.granted â†’ ACTIVATE | rejected/timeout â†’ IDLE (+alert)

ACTIVATE â†’ stage etkin + kart â†’ ACTIVE

ACTIVE â†’ minHoldMin dolunca EVALUATE (Ã¼st aÅŸama?) | guardâ‰ normal â†’ HOLD

HOLD â†’ guard normale dÃ¶nÃ¼nce ACTIVE | sÃ¼re aÅŸÄ±mÄ±nda IDLE

Hata: IDLE + anchor.alert(...)

8) Kenar Durumlar

PnL<0 & bias dÃ¼ÅŸÃ¼k: Sadece ramp1 uygulanÄ±r; full yasak.

Guard=degraded/slowdown: AÅŸama yÃ¼kseltme bekler (HOLD).

ArdÄ±ÅŸÄ±k incident (â‰¤24h): Her yeni incident ramp aÅŸamasÄ±nÄ± bir kademe dÃ¼ÅŸÃ¼rÃ¼r.

Ã‡akÄ±ÅŸan anchor: AynÄ± scope iÃ§in aktif anchor varsa merge: Î”threshold = min(Î”), positionLimitFactor = min, allowVariants = kesiÅŸim.

Onay gecikmesi: timeout â†’ ramp1 conservative fallback.

9) Telemetri
{
  "anchor.metrics": {
    "event":"anchor.metrics",
    "timestamp":"iso8601",
    "proposed":2,"activated":1,"rolledBack":0,
    "avgRampMin":48,
    "byStage":{"ramp1":1,"ramp2":1},
    "highlights":["guard=normal","biasLow","pnl>=0"]
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/behavioralAnchorReset.ts      # FSM + composer + scheduler
services/livia/lib/anchorPolicy.ts           # rampPolicy + readiness kurallarÄ±
services/livia/lib/anchorStore.ts            # active anchors + idem index
services/livia/lib/redact.ts                 # ortak hash/PII (gerektiÄŸinde)
services/livia/lib/approvalBridge.ts         # LIVIA-05 entegrasyonu
services/livia/__tests__/behavioralAnchorReset.test.ts
cfg/livia.anchor.yaml                        # thresholds/policy/approval/schedule

11) Test Ä°skeleti (Jest/Vitest)

Readiness true: guard=normal, bias dÃ¼ÅŸÃ¼k, PnLâ‰¥0 â†’ ramp2 (Ã¶nce ramp1 var ise)

PnL<0: yalnÄ±z ramp1; full yasak.

Incident high: postIncidentCooldownMin dolmadan not_ready.

Idempotency: aynÄ± anchorKey ile ikinci yazÄ±m yok; aktif stageâ€™de sÃ¼re uzar.

Merge: mevcut anchor + yeni Ã¶neri â†’ kurallar birleÅŸimi doÄŸru mu?

Approval: full veya Î”â‰¤-0.25 â†’ gateway; grant sonrasÄ± activated.

RBAC/Auth: imza hatasÄ± â†’ anchor.alert(error,"auth_failed").

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

16:00 cooldown.expired(scope=symbol:AVAXUSDT); bias dÃ¼ÅŸÃ¼k, guard=normal, PnLâ‰¥0 â†’ DRAFT(ramp1)

16:01 AWAIT_APPROVAL yok â†’ ACTIVATE(ramp1); kart yayÄ±nlandÄ±

16:40 sweep â†’ readiness ok â†’ DRAFT(ramp2) â†’ ACTIVATE(ramp2)

18:10 guard=slowdown â†’ HOLD; guard normale dÃ¶nÃ¼nce ACTIVE akÄ±ÅŸÄ±na devam

13) SLO

P95 deÄŸerlendirme < 50 ms (cache + sabit kurallar)

Yazma hatasÄ± < %0.5 (atomic write + lock)

Ä°dempotent Ã§akÄ±ÅŸma â‰ˆ 0; merge doÄŸruluk testleri â‰¥ %99

Kart yayÄ±nÄ±ndan â‰¤1 sn sonra anchor durumu UIâ€™da gÃ¶rÃ¼nÃ¼r
_____________________________________________________________________________________________
LIVIA-19 Â· emotionalRecoveryMonitor.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§:
Savunma dÃ¶nemi (gate/cooldown/incident) ardÄ±ndan sistemin ve operatÃ¶rÃ¼n psikolojik toparlanma durumunu 0â€“1 aralÄ±ÄŸÄ±nda recoveryIndex olarak Ã¶lÃ§mek. Endeks; bias skor trendleri, kayÄ±p serisi, diyalog kalitesi, guard/SLO durumu ve son PnL/streak verilerini birleÅŸtirir. SonuÃ§:

recovery.ready (â‰¥ eÅŸiÄŸi): LIVIA-18â€™e ramp-up iÃ§in sinyal

recovery.hold (< eÅŸiÄŸi): normalleÅŸmeyi ertele, gerekiyorsa LIVIA-16â€™ya cooldown uzatma Ã¶ner

UIâ€™ya kÄ±sa card gÃ¶nder, telemetriyi yaz.
TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics standartlÄ±.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601, TZ=Europe/Istanbul; â€œgÃ¼nâ€ penceresi 00:00â€“23:59:59 (yerel)

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC: ops|policy|observer okuyabilir; yazÄ±m sadece sistem/policy

Gizlilik: PII yok; operatÃ¶r kimliÄŸi gerekiyorsa hash(salt gÃ¼nlÃ¼k dÃ¶ner)

Ä°dempotency: recoveryKey = scope + symbol? + windowStartISO + windowMin

Telemetri & Alert: recovery.metrics, recovery.alert

2) Girdiler (In) â€” Zodâ€™a Ã§evrilecek ÅŸema Ã¶rnekleri
{
  "cooldown.expired": {
    "event":"cooldown.expired",
    "timestamp":"iso8601",
    "cooldownKey":"...",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "reasonCode":"overtrading|overconfidence|panic_mode"
  },

  "defense.gate.expired": {
    "event":"defense.gate.expired",
    "timestamp":"iso8601",
    "gateKey":"...",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "trigger":"fomo|revenge|overconfidence|panic|guard_escalation"
  },

  "incident.closed": {
    "event":"incident.closed",
    "timestamp":"iso8601",
    "id":"inc-2025-09-13-1",
    "severity":"low|medium|high|critical",
    "durationMin":37
  },

  "bias.snapshot": {
    "event":"bias.snapshot",
    "timestamp":"iso8601",
    "scores": { "fomo":0.22, "overconfidence":0.28, "loss_aversion":0.31 }
  },

  "bias.trend": {
    "event":"bias.trend",
    "timestamp":"iso8601",
    "windowMin":120,
    "delta": { "fomo":-0.18, "overconfidence":-0.12, "loss_aversion":-0.05 }
  },

  "dialog.metrics": {
    "event":"dialog.metrics",
    "timestamp":"iso8601",
    "prompts":41, "answers":36, "acceptRate":0.78, "p95AnswerMs":920
  },

  "trade.streak.summary": {
    "event":"trade.streak.summary",
    "timestamp":"iso8601",
    "lossStreak":0, "winStreak":2, "lastWinLoss":"win|loss",
    "windowMin":120
  },

  "pnl.window": {
    "event":"pnl.window",
    "timestamp":"iso8601",
    "windowMin":240,
    "netUSD": 610.4,
    "rrMedian": 1.35
  },

  "guard.mode": {
    "event":"guard.mode",
    "timestamp":"iso8601",
    "sentry":"normal|degraded|streams_panic|halt_entry",
    "latency_slip":"normal|slowdown|block_aggressive|halt_entry"
  },

  "telemetry.slo.status": {
    "event":"telemetry.slo.status",
    "timestamp":"iso8601",
    "slo":"answer_latency_p95|guard_success_rate|uptime_feed",
    "state":"ok|at_risk|breach",
    "window":"5m|1h|24h",
    "burnPct":3.1
  }
}


Not: Girdilerin tamamÄ± gerekmeyebilir; eksik alanlarda varsayÄ±lan ve aÄŸÄ±rlÄ±k dÃ¼ÅŸÃ¼mÃ¼ uygulanÄ±r.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "recovery.score.updated": {
    "event":"recovery.score.updated",
    "timestamp":"iso8601",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "windowMin": 120,
    "recoveryIndex": 0.73,              // 0..1
    "factors": {
      "biasTrend": 0.82,
      "guardOk": 1.0,
      "sloOk": 0.9,
      "pnlWindow": 0.68,
      "streak": 0.6,
      "dialogQuality": 0.7
    },
    "audit":{"producedBy":"LIVIA-19","version":"v1"}
  },

  "recovery.ready": {
    "event":"recovery.ready",
    "timestamp":"iso8601",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "recoveryIndex": 0.74,
    "suggestedStage":"ramp1|ramp2|full",
    "minHoldMin": 30
  },

  "recovery.hold": {
    "event":"recovery.hold",
    "timestamp":"iso8601",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "recoveryIndex": 0.42,
    "reasonCodes":["bias_high","pnl_nonpos|weak_streak","guard_not_normal"]
  },

  "cooldown.extend.suggest": {
    "event":"cooldown.extend.suggest",
    "timestamp":"iso8601",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "reason":"recovery_low",
    "proposed": { "durationMin": 15, "signalRateMaxPer10m": 0 }
  },

  "recovery.card": {
    "event":"recovery.card",
    "timestamp":"iso8601",
    "title":"Toparlanma Endeksi: 0.74 â€” {scope}",
    "body":"Biasâ†“, guard=normal, SLO ok, PnL pozitif; Ã¶neri: ramp2 (min 30dk).",
    "severity":"info|warn",
    "ttlSec":600
  },

  "recovery.metrics": {
    "event":"recovery.metrics",
    "timestamp":"iso8601",
    "evaluations": 6,
    "readySignals": 2,
    "holds": 4,
    "avgEvalMs": 7.5,
    "missingInputsRate": 0.12
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  window: {
    evaluateEvery: "5m",
    windowMin: 120,             // skor iÃ§in geÃ§miÅŸ pencere
    minQuietAfterDefenseMin: 10 // gate/cooldown sonrasÄ± en az sessizlik
  },

  weights: {
    biasTrend: 0.30,            // son 120dk dÃ¼ÅŸÃ¼ÅŸ yÃ¶nÃ¼ & seviye
    guardOk: 0.15,              // guard=normal & latency_slip=normal
    sloOk: 0.10,                // SLO'lar ok/at_risk
    pnlWindow: 0.20,            // 4h net ve rrMedian
    streak: 0.15,               // win/loss dengesi
    dialogQuality: 0.10         // acceptRateâ†‘, p95AnswerMsâ†“
  },

  thresholds: {
    ready: 0.70,                // â‰¥ ise recovery.ready
    hold:  0.55,                // < ise recovery.hold
    hysteresis: 0.05            // flip-flop engelleme
  },

  mapping: {
    indexToStage: [
      { "gte": 0.70, "lt": 0.80, "stage": "ramp1" },
      { "gte": 0.80, "lt": 0.90, "stage": "ramp2" },
      { "gte": 0.90, "lt": 1.01, "stage": "full"  }
    ]
  },

  approval: {
    requireFor: [],             // recovery.ready sadece Ã¶neridir; aktivasyon LIVIA-18â€™de
    gateway: "LIVIA-05"
  },

  idempotencyTtlSec: 900
}

5) Skorlama TasarÄ±mÄ± (Ã–zet)

Normalizasyon: Her faktÃ¶rÃ¼ 0..1 aralÄ±ÄŸÄ±na Ã¶lÃ§ekle:

biasTrend = clamp( (âˆ’avgDeltaWeighted + 0.2) / 0.4, 0, 1 ) (negatif delta iyidir)

guardOk = 1 yalnÄ±zca sentry=normal && latency_slip=normal ise; deÄŸilse 0â€“0.5

sloOk = 1 (ok), 0.5 (at_risk), 0 (breach)

pnlWindow = sigmoid(netUSD/targetUSD) * blend(rrMedian, range)

streak = min(1, (winStreakâˆ’lossStreak+1)/3) tabanlÄ±

dialogQuality = blend(acceptRateâ†‘, p95AnswerMsâ†“)

Endeks: recoveryIndex = Î£ (w_i * factor_i)

Histerezis: Son iki skorun EMAâ€™sÄ± ile karar ver; flip-flopâ€™Ä± azalt.

6) Pipeline (Kompozisyon)

Topla & DoÄŸrula: Son window.windowMin iÃ§indeki ilgili eventler â†’ Zod .strict()

Sessizlik KontrolÃ¼: minQuietAfterDefenseMin saÄŸlanmadÄ±ysa hold

Normalizasyon: FaktÃ¶rleri 0..1 aralÄ±ÄŸÄ±na getir; eksik girdilerde aÄŸÄ±rlÄ±k yeniden Ã¶lÃ§eklenir

Skorla: recoveryIndex hesapla + EMA histerezisi uygula

Karar:

recoveryIndex â‰¥ ready (ve Ã¶nceki karar â€œholdâ€ ise ready+hysteresis ÅŸartÄ±) â†’ recovery.ready

Aksi â†’ recovery.hold (+ gerekirse cooldown.extend.suggest)

Emit: recovery.score.updated + recovery.card + recovery.metrics

Ä°dempotency: recoveryKey aynÄ± pencereye ait ikinci yazÄ±mÄ± engeller

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ schedule(5m) | (gate/cooldown expired) â†’ EVALUATE

EVALUATE â†’ skor hesapla â†’ DECIDE

DECIDE â†’ (ready) READY_EMIT | (hold) HOLD_EMIT

READY_EMIT/HOLD_EMIT â†’ emit + store â†’ IDLE

Hata: IDLE + recovery.alert(level,"missing_data|write_failed|idem_duplicate")

8) Kenar Durumlar

Guardâ‰ normal: otomatik hold (reason=guard_not_normal)

PnL negatif ama bias dÃ¼ÅŸÃ¼k: indeks tavanÄ± 0.69; hazÄ±r sinyali verilmez

ArdÄ±ÅŸÄ±k incident â‰¤24h: indeks maksimumu 0.79 ile sÄ±nÄ±rlandÄ±rÄ±lÄ±r

Eksik veri (> %40): skor yazÄ±lmaz; recovery.alert("info","missing_data")

SÃ¼rekli osilasyon: histerezis + minQuietMin artÄ±rÄ±mÄ± Ã¶nerilir

9) Telemetri
{
  "recovery.metrics": {
    "event":"recovery.metrics",
    "timestamp":"iso8601",
    "evaluations": 6,
    "readySignals": 2,
    "holds": 4,
    "avgEvalMs": 7.5,
    "missingInputsRate": 0.12,
    "highlights": ["guard:normal", "biasTrend:good", "pnl:nonneg"]
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/emotionalRecoveryMonitor.ts   # FSM + scorer + scheduler
services/livia/lib/recovery/normalizers.ts   # faktÃ¶r normalizasyonu
services/livia/lib/recovery/weights.ts       # aÄŸÄ±rlÄ±k/threshold config okuyucu
services/livia/lib/recovery/hysteresis.ts    # EMA/histerezis karar mantÄ±ÄŸÄ±
services/livia/state/recoveryStore.ts        # idem index + son skor cache
services/livia/lib/redact.ts                 # ortak hash/PII (gerektiÄŸinde)
services/livia/__tests__/emotionalRecoveryMonitor.test.ts
cfg/livia.recovery.yaml                      # window/weights/thresholds

11) Test Ä°skeleti (Jest/Vitest)

Ready senaryosu: guard=normal, biasTrend iyi, PnLâ‰¥0 â†’ recovery.ready(stage=ramp2)

Hold senaryosu: guard=slowdown veya PnL<0 â†’ recovery.hold + (opsiyonel) cooldown.extend.suggest

Histerezis: sÄ±nÄ±rda 0.69â†”0.71 osilasyonunda flip-flop yok

Eksik veri: >%40 eksik â†’ alert; â‰¤%40 eksik â†’ aÄŸÄ±rlÄ±k yeniden Ã¶lÃ§ekleme

Idempotency: aynÄ± recoveryKey ile ikinci yazÄ±m bloklanÄ±r

RBAC/Auth: imza hatasÄ± â†’ recovery.alert(error,"auth_failed")

TR Card: 280 karakter altÄ±nda, net Ã¶zet

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

16:00 defense.gate.expired(symbol=AVAXUSDT); 16:05 deÄŸerlendirme â†’ recoveryIndex=0.64 â†’ recovery.hold

16:10 bias trendleri iyileÅŸir, guard=normal kalÄ±r, PnL pozitif â†’ 0.76 â†’ recovery.ready(stage=ramp2, minHold=30)

LIVIA-18 anchor.reset ramp2â€™yi uygular; kart UIâ€™da gÃ¶rÃ¼nÃ¼r.

13) SLO

P95 deÄŸerlendirme sÃ¼resi < 10 ms

Yazma hatasÄ± oranÄ± < %0.5 (atomic write + lock)

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0

YanÄ±t (card emit) â‰¤ 1 sn iÃ§inde
______________________________________________________________________________________________
haklÄ±sÄ±n reis â€” kaliteyi bir tÄ±k daha yukarÄ± taÅŸÄ±yalÄ±m. AÅŸaÄŸÄ±ya iki teslim bÄ±rakÄ±yorum:

LIVIA-19 iÃ§in â€œv3.1 Hardening Addendumâ€ (ek gÃ¼Ã§lendirmeler)

LIVIA-20 Â· operatorFatigueSentinel.ts â€” GeniÅŸ Prompt v3 (yeni modÃ¼l)

Hepsi tek mesaj, kopyala-yapÄ±ÅŸtÄ±r â€œyol-promptâ€ formatÄ±nda.

(Ek) LIVIA-19 Â· emotionalRecoveryMonitor.ts â€” v3.1 Hardening Addendum

AmaÃ§ (ek): v3 taslaÄŸÄ±nÄ±; daha net I/O sÃ¶zleÅŸmeleri, tip gÃ¼venliÄŸi, gÃ¶zlemlenebilirlik, histerezis/anti-flap, degradasyon/fallback ve cross-module entegrasyon sinyalleri ile sertleÅŸtir.

A) I/O SÃ¶zleÅŸmeleri â€” TypeScript ArayÃ¼zleri (uygulat)
export type Scope = "global"|"desk"|"symbol";

export interface RecoveryScoreUpdated {
  event: "recovery.score.updated";
  timestamp: string; // ISO-8601
  scope: Scope; symbol: string|null;
  windowMin: number;
  recoveryIndex: number; // 0..1
  factors: { biasTrend:number; guardOk:number; sloOk:number; pnlWindow:number; streak:number; dialogQuality:number };
  audit: { producedBy:"LIVIA-19"; version:string };
}

export interface RecoveryReady {
  event:"recovery.ready";
  timestamp:string; scope:Scope; symbol:string|null;
  recoveryIndex:number; suggestedStage:"ramp1"|"ramp2"|"full"; minHoldMin:number;
}

export interface RecoveryHold {
  event:"recovery.hold";
  timestamp:string; scope:Scope; symbol:string|null;
  recoveryIndex:number; reasonCodes:string[];
}

B) Zod ÅemalarÄ± (Ã¶rnekler, .strict() ÅŸart)

bias.snapshot, bias.trend, guard.mode, telemetry.slo.status, pnl.window, trade.streak.summary, dialog.metrics â†’ ayrÄ± ÅŸema dosyalarÄ±; tÃ¼m alanlar tiplenmiÅŸ, opsiyoneller aÃ§Ä±kÃ§a iÅŸaretlenmiÅŸ.

C) Skor FormÃ¼lleri (netleÅŸtirme)

biasTrend = clamp( (-EMA(deltaBias, W=3) + 0.20) / 0.40 , 0, 1 )

guardOk = sentry==="normal" && latency_slip==="normal" ? 1 : (sentry==="degraded"?0.5:0)

sloOk = {ok:1, at_risk:0.5, breach:0}[worst24h]

pnlWindow = clamp( 0.5*sigmoid(netUSD/targetUSD) + 0.5*min(1, rrMedian/1.5), 0, 1 )

streak = clamp( (winStreak - lossStreak + 1)/3 , 0, 1 )

dialogQuality = clamp( 0.6*acceptRate + 0.4*(1 - norm(p95AnswerMs)) , 0, 1 )

recoveryIndex = Î£(w_i * factor_i); aÄŸÄ±rlÄ±klar v3 ile aynÄ± (toplam=1).

D) Anti-flap & Histerezis

Karar eÅŸiÄŸi: ready >= 0.70, geri dÃ¶nÃ¼ÅŸ eÅŸiÄŸi: ready - 0.05.

Karar, EMA(recoveryIndex, Î±=0.4) Ã¼zerinden verilir.

E) Degradasyon / Fallback

missingInputsRate > 0.4 â†’ emit yok, recovery.alert("info","missing_data").

guard != normal â†’ otomatik hold + reason=guard_not_normal.

PnL<0 & biasLow â†’ tavan 0.69.

F) Observability (OpenTelemetry)

Spans: recovery.evaluate, recovery.normalize, recovery.decide.

Metrics (OTLP): livia_recovery_index (gauge, labels: scope,symbol), livia_recovery_ready_total, livia_recovery_hold_total, livia_recovery_eval_ms_p95.

G) Cross-Module Emit

Ready â†’ LIVIA-18 dinler: recovery.ready(suggestedStage, minHoldMin).

Hold (dÃ¼ÅŸÃ¼k skor) â†’ LIVIA-16â€™ya Ã¶neri: cooldown.extend.suggest.

H) Performans BÃ¼tÃ§esi

p95 eval < 10ms, GC-free kritik zonda; JSON parse/validate >2ms olursa uyarÄ± logu.

I) Test Ekleri

Histerezis testi (0.69â†”0.71) osilasyonda flip-flop yok.

SLO breach simÃ¼lasyonu: worst=breach â†’ sloOk=0 â†’ hold.

Eksik veri yeniden Ã¶lÃ§ekleme: aÄŸÄ±rlÄ±klar normalize.

LIVIA-20 Â· operatorFatigueSentinel.ts â€” GeniÅŸ Prompt v3 (AIâ€™ye verilecek yol-prompt)

AmaÃ§:
OperatÃ¶rÃ¼n zihinsel yorgunluk (fatigue) dÃ¼zeyini 0â€“1 arasÄ± fatigueScore ile Ã¶lÃ§; yÃ¼ksek yorgunlukta break Ã¶ner, sinyal debisini kÄ±sma/cooldown Ã¶ner, approval gerekiyorsa iste. Uzun seans, karar kalitesi dÃ¼ÅŸÃ¼ÅŸÃ¼, tepki sÃ¼resi artÄ±ÅŸÄ±, kayÄ±p serisi ve gece saatleri gibi gÃ¶stergeleri birleÅŸtir. TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601, TZ=Europe/Istanbul

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy|observer okur, yazÄ±m sistem/policy

Ä°dempotency: fatigueKey = operator? + scope + windowStartISO + windowMin

Telemetri: fatigue.metrics; uyarÄ±: fatigue.alert

2) Girdiler (In) â€” Zodâ€™a Ã§evrilecek ÅŸema Ã¶rnekleri
{
  "session.activity": {
    "event":"session.activity",
    "timestamp":"iso8601",
    "operatorId":"op-007|null",
    "minutesOnline": 210,
    "microBreaks": 1,          // â‰¥5 dk ara sayÄ±sÄ±
    "lastBreakMinAgo": 130
  },
  "dialog.metrics": {
    "event":"dialog.metrics",
    "timestamp":"iso8601",
    "prompts":41,"answers":36,"acceptRate":0.72,"p95AnswerMs":1280
  },
  "trade.streak.summary": {
    "event":"trade.streak.summary",
    "timestamp":"iso8601",
    "lossStreak":2,"winStreak":0,"lastWinLoss":"loss","windowMin":90
  },
  "pnl.window": {
    "event":"pnl.window",
    "timestamp":"iso8601",
    "windowMin":180,"netUSD":-240.0,"rrMedian":0.92
  },
  "clock.localtime": {
    "event":"clock.localtime",
    "timestamp":"iso8601",
    "hour": 1,                 // 0..23, lokal
    "isWeekend": false
  },
  "approval.result": {
    "event":"approval.result",
    "timestamp":"iso8601",
    "ref":"fatigue.break.request|cooldown.request",
    "decision":"granted|rejected|timeout"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "fatigue.score.updated": {
    "event":"fatigue.score.updated",
    "timestamp":"iso8601",
    "scope":"global|desk|symbol",
    "operator":"hash|null",
    "windowMin":120,
    "fatigueScore":0.78,       // 0..1
    "factors": {
      "longSession":0.9, "noBreak":1.0, "slowDialog":0.7,
      "lossStreak":0.6, "nightShift":0.8, "pnlDrag":0.5
    },
    "audit":{"producedBy":"LIVIA-20","version":"v1"}
  },

  "fatigue.break.proposed": {
    "event":"fatigue.break.proposed",
    "timestamp":"iso8601",
    "durationMin": 15,
    "rationale":"fatigueScore>=0.75; lastBreak>120m; nightShift"
  },

  "cooldown.plan.proposed": {
    "event":"cooldown.plan.proposed",
    "timestamp":"iso8601",
    "scope":"desk",
    "symbol": null,
    "reasonCode":"fatigue_high",
    "policy": { "durationMin": 20, "signalRateMaxPer10m": 0, "positionLimitFactor": 0.6 },
    "ttlSec":1200
  },

  "fatigue.card": {
    "event":"fatigue.card",
    "timestamp":"iso8601",
    "title":"Yorgunluk YÃ¼ksek â€” Ara Ã–nerildi",
    "body":"Skor 0.78 â€¢ 15 dk ara + 20 dk sinyal kÄ±sÄ±tlama Ã¶nerisi.",
    "severity":"warn",
    "ttlSec":600
  },

  "fatigue.alert": {
    "event":"fatigue.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"missing_data|write_failed|idem_duplicate|approval_required"
  },

  "fatigue.metrics": {
    "event":"fatigue.metrics",
    "timestamp":"iso8601",
    "evaluations":4,"breakProposed":2,"cooldownsProposed":1,
    "avgEvalMs":6.1,"missingInputsRate":0.08
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  window: { evaluateEvery:"10m", windowMin:120 },

  weights: {
    longSession: 0.25,      // minutesOnlineâ†‘
    noBreak:     0.15,      // lastBreakMinAgoâ†‘, microBreaksâ†“
    slowDialog:  0.15,      // p95AnswerMsâ†‘, acceptRateâ†“
    lossStreak:  0.20,      // lossesâ†‘
    nightShift:  0.15,      // hourâˆˆ[0,5] veya [23]
    pnlDrag:     0.10       // netUSD<0, rrMedian<1
  },

  thresholds: {
    breakSuggest: 0.70,     // â‰¥ ise ara Ã¶ner
    cooldownSuggest: 0.80,  // â‰¥ ise cooldown Ã¶ner
    hysteresis: 0.05
  },

  policyMatrix: {
    // skor bandÄ±na gÃ¶re Ã¶neriler
    "0.70-0.80": { breakMin: 10, cooldownMin: 0, posLimitFactor: 0.8 },
    "0.80-1.00": { breakMin: 15, cooldownMin: 20, posLimitFactor: 0.6 }
  },

  approval: {
    requireFor: ["cooldownSuggest"],
    gateway: "LIVIA-05"
  },

  pii: { operators:true, hashSalt:"rotate-me-daily" },

  idempotencyTtlSec: 900
}

5) Skorlama (net)

longSession = clamp((minutesOnline - 120)/180, 0, 1)

noBreak = clamp(lastBreakMinAgo/120, 0, 1) * (microBreaks===0 ? 1 : 0.7)

slowDialog = clamp( (p95AnswerMs-900)/900, 0, 1 ) * clamp( (0.8-acceptRate)/0.5, 0, 1 )

lossStreak = clamp( (lossStreak)/3 , 0, 1 )

nightShift = hourâˆˆ[23..5]? 1 : 0 (geceye aÄŸÄ±rlÄ±k 0.8â€“1.0 arasÄ± konfig edilebilir)

pnlDrag = clamp( -netUSD/500 , 0, 1 ) * clamp( (1 - rrMedian)/0.5 , 0, 1 )

Toplam: fatigueScore = Î£(w_i * factor_i); EMA + histerezis uygulanÄ±r.

6) Pipeline

Topla & DoÄŸrula: session.activity, dialog.metrics, trade.streak.summary, pnl.window, clock.localtime.

Normalize + Skorla: faktÃ¶rleri 0..1 ve aÄŸÄ±rlÄ±klarÄ± uygula.

Karar:

fatigueScore â‰¥ cooldownSuggest â†’ cooldown.plan.proposed + fatigue.break.proposed + fatigue.card(warn)

fatigueScore â‰¥ breakSuggest â†’ fatigue.break.proposed + fatigue.card(info/warn)

DeÄŸilse yalnÄ±z fatigue.score.updated.

Approval: cooldown gerekiyorsa gatewayâ€™e gÃ¶nder; karar sonrasÄ± emit.

Idempotency: aynÄ± pencereye ikinci yazÄ±mÄ± engelle.

Telemetry: fatigue.metrics gÃ¼ncelle.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ schedule(10m) â†’ EVALUATE

EVALUATE â†’ skor â†’ DECIDE

DECIDE â†’ (cooldownSuggest) REQUEST_APPROVAL | (breakSuggest) PROPOSE_BREAK | IDLE

REQUEST_APPROVAL â†’ approval.result â†’ EMIT_COOLDOWN | IDLE

PROPOSE_BREAK â†’ fatigue.break.proposed + card â†’ IDLE

Hata: IDLE + fatigue.alert(...)

8) Kenar Durumlar

OperatÃ¶r anonim (hash): scope/symbol planlarÄ± yine Ã§alÄ±ÅŸÄ±r.

Sessiz gece seansÄ± ama hÄ±zlÄ± cevap: nightShift tek baÅŸÄ±na karar Ã¼retmez (aÄŸÄ±rlÄ±k limitli).

Ãœst Ã¼ste iki cooldown Ã¶nerisi: idempotency, sÃ¼renin uzatÄ±lmasÄ± (merge) ve kartÄ±n bir kez yayÄ±nlanmasÄ±.

Eksik veri: aÄŸÄ±rlÄ±k yeniden Ã¶lÃ§eklenir; >%40 eksik â†’ emit yok + alert.

9) Telemetri
{
  "fatigue.metrics":{
    "event":"fatigue.metrics",
    "timestamp":"iso8601",
    "evaluations":4,"breakProposed":2,"cooldownsProposed":1,
    "avgEvalMs":6.1,"missingInputsRate":0.08,
    "highlights":["nightShift","slowDialog","longSession"]
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/operatorFatigueSentinel.ts     # FSM + scorer + scheduler
services/livia/lib/fatigue/normalizers.ts     # faktÃ¶r normalizasyonu
services/livia/lib/fatigue/weights.ts         # aÄŸÄ±rlÄ±k/threshold okuma
services/livia/state/fatigueStore.ts          # idem index + last score
services/livia/lib/redact.ts                  # operator hash/PII
services/livia/lib/approvalBridge.ts          # LIVIA-05 entegrasyonu
services/livia/__tests__/operatorFatigueSentinel.test.ts
cfg/livia.fatigue.yaml

11) Test Ä°skeleti (Jest/Vitest)

Uzun seans + gece + yavaÅŸ diyalog â†’ fatigueScoreâ‰¥0.8 â†’ cooldown Ã¶nerisi + break

KÄ±sa seans + pozitif PnL + hÄ±zlÄ± diyalog â†’ yalnÄ±z fatigue.score.updated

Idempotency & Merge: ardÄ±ÅŸÄ±k Ã¶nerilerde sÃ¼re uzar, tek kart

RBAC/Auth: imza hatasÄ± â†’ fatigue.alert(error,"auth_failed")

Histerezis: 0.78â†”0.82 aralÄ±ÄŸÄ±nda flip-flop yok
______________________________________________________________________________________________
LIVIA-21 Â· piiGuardAndRedactor.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
TÃ¼m metin/rapor/Ã¶zet/karte akÄ±ÅŸlarÄ±nda PII/Bilgisel hassasiyet tespiti ve maskeleme/redaksiyon saÄŸlamak. Markdown/HTML/Text akÄ±ÅŸlarÄ±nÄ± streaming iÅŸleyerek e-posta, telefon, kimlik numarasÄ±, IBAN, adres, kullanÄ±cÄ± adÄ±, operatÃ¶r adÄ±/kimliÄŸi, cÃ¼zdan adresleri (BTC/ETH/TRON vb.), pasaport/TCID benzeri alanlarÄ± saptayÄ±p maskele; operatÃ¶rler iÃ§in gÃ¼nlÃ¼k saltâ€™lÄ± takma ad (hash) Ã¼ret; â€œticker/symbolâ€ gibi finansal terimleri yanlÄ±ÅŸ pozitif vermeden koru. Zorunlu durumda sÄ±nÄ±flandÄ±rma etiketi (PUBLIC/SENSITIVE_LOW/SENSITIVE_HIGH) ekle.
TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601, TZ=Europe/Istanbul

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC: ops|policy|observer okur; yazÄ±m sistem

Gizlilik: VarsayÄ±lan SENSITIVE_LOW; PII bulunursa SENSITIVE_HIGH (config ile override)

Ä°dempotency: redactKey = contentHash + profileId + mode + forDate

Observability: OpenTelemetry spans (redact.detect, redact.mask, redact.stream) + metrics

Uyum: LIVIA-14/15/16/17/18/19/20 modÃ¼llerinin tÃ¼m Ã§Ä±ktÄ±larÄ±na uygulanabilir â€œkÃ¼tÃ¼phaneâ€ + â€œservisâ€

2) Girdiler (In) â€” Zod ÅŸemalarÄ± (Ã¶rnek)
{
  "redact.request": {
    "event":"redact.request",
    "timestamp":"iso8601",
    "mode":"markdown|html|text",
    "profileId":"digest|postmortem|notes|cards|generic",
    "content":"<string>",             // bÃ¼yÃ¼k gÃ¶vde (stream destekli)
    "options":{
      "hashOperators":true,
      "hashSalt":"rotate-me-daily",
      "classify":true,
      "maskEmail":true,
      "maskPhone":true,
      "maskWallet":true,
      "maskIBAN":true,
      "maskGovId":true,
      "preserveTickers":true,        // AVAX, SOL, BTC, AVAXUSDT vb.
      "preserveCodeBlocks":true,     // ```...```, <code>...</code>
      "preservePaths":true           // data/notes/... gibi sistem yollarÄ±
    },
    "context":{
      "scope":"global|desk|symbol",
      "symbol":"AVAXUSDT|null",
      "operatorId":"op-007|null"
    }
  },

  "redact.dictionary.update": {
    "event":"redact.dictionary.update",
    "timestamp":"iso8601",
    "allowlistTickers":["AVAX","SOL","BTC","AVAXUSDT","SOLUSDT"],
    "allowlistDomains":["example.com","mycorp.local"],
    "denylistUsernames":["admin","root"]
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "redact.ready": {
    "event":"redact.ready",
    "timestamp":"iso8601",
    "profileId":"digest|postmortem|notes|cards|generic",
    "mode":"markdown|html|text",
    "classification":"PUBLIC|SENSITIVE_LOW|SENSITIVE_HIGH",
    "maskedContent":"<string>",
    "stats":{
      "entitiesFound":{"email":3,"phone":2,"iban":1,"wallet":1,"govId":0,"name":2},
      "falsePositiveAvoided": {"ticker":5,"codeBlock":2,"path":3},
      "bytesIn":6200,"bytesOut":6150
    },
    "hash":"sha256:..."
  },

  "redact.alert": {
    "event":"redact.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"missing_data|write_failed|idem_duplicate|parser_error",
    "context":{"profileId":"notes"}
  },

  "redact.metrics": {
    "event":"redact.metrics",
    "timestamp":"iso8601",
    "processed": 4,
    "avgDetectMs": 5.2,
    "avgMaskMs": 3.1,
    "streamedPct": 0.75,
    "fpRate": 0.02,
    "fnRate": 0.01
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  profiles: {
    digest:     { preserveCodeBlocks:true, preservePaths:true, preserveTickers:true, aggressive:false },
    postmortem: { preserveCodeBlocks:true, preservePaths:true, preserveTickers:true, aggressive:true },
    notes:      { preserveCodeBlocks:true, preservePaths:true, preserveTickers:true, aggressive:false },
    cards:      { preserveCodeBlocks:false, preservePaths:false, preserveTickers:true, aggressive:false },
    generic:    { preserveCodeBlocks:true, preservePaths:true, preserveTickers:true, aggressive:false }
  },

  patterns: {
    email: "\\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\\b",
    phoneIntl: "\\+\\d{1,3}[\\s-]?\\d{2,4}[\\s-]?\\d{3}[\\s-]?\\d{2,4}",
    iban: "\\bTR\\d{24}\\b|\\b[A-Z]{2}\\d{2}[A-Z0-9]{1,30}\\b",
    govId: "\\b\\d{11}\\b",                       // yerel TC benzeri numaralar iÃ§in Ã¶rnek
    btc: "\\b[13][a-km-zA-HJ-NP-Z1-9]{25,34}\\b",
    eth: "\\b0x[a-fA-F0-9]{40}\\b",
    tron: "\\bT[1-9A-HJ-NP-Za-km-z]{33}\\b",
    nameLike: "(?i)(ad[Ä±i]|soyad[Ä±i]|isim|name)\\s*[:=]\\s*([\\p{L}\\s'-]{2,})"
  },

  allowlists: {
    tickers: ["AVAX","SOL","BTC","AVAXUSDT","SOLUSDT","ETHUSDT"],
    systemPathsPrefix: ["data/notes/","data/digest/","data/postmortem/"],
    codeFence: ["```","~~~"]
  },

  masking: {
    email: "local***@***.domain",
    phone: "+** *** *** ** **",
    iban: "****-****-****-****",
    wallet: "0x***masked***",
    govId: "***-***-***",
    name: "user:#{hash}",
    operatorHashSalt: "rotate-me-daily",
    hashAlgo: "sha256"
  },

  classification: {
    defaultLevel: "SENSITIVE_LOW",
    elevateIfFound: ["email","phone","iban","wallet","govId","name"],
    downgradeIfOnly: ["ticker","path","codeBlock"]
  },

  streaming: {
    chunkBytes: 16384,        // 16KB parÃ§a
    overlapBytes: 128,        // sÄ±nÄ±r kaÃ§aklarÄ±nÄ± yakalamak iÃ§in
    maxBytes: 2_000_000       // >2MB â†’ appendix uyarÄ±sÄ±
  },

  idempotencyTtlSec: 86400
}

5) Redaksiyon KurallarÄ±

Deterministik takma ad: hash(operatorId + salt@YYYY-MM-DD) â†’ op#abcd12

Masking precedence: govId > wallet > iban > email > phone > nameLike

YanlÄ±ÅŸ pozitif Ã¶nleme:

Ticker/Pair (AVAX, SOL, AVAXUSDT) â†’ asla maskelenmez (allowlist)

Code Blocks (â€¦, <code>â€¦</code>) â†’ iÃ§eride sadece cÃ¼zdan/IBAN maskelenir, kod stringleri korunur

Sistem yollarÄ± data/... â†’ korunur

HTML/Markdown farkÄ±ndalÄ±ÄŸÄ±: HTML iÃ§in DOM-parsing â†’ text dÃ¼ÄŸÃ¼mlerinde maskeleme; MD iÃ§in tokenizer (fenced/code/inline link ayrÄ±mÄ±)

SÄ±nÄ±flandÄ±rma: elevateIfFound yakalanÄ±rsa SENSITIVE_HIGH; yalnÄ±z downgradeIfOnly varsa PUBLIC/SENSITIVE_LOW

6) Pipeline (Kompozisyon)

SeÃ§im: profile â†’ kurallar + allowlist birleÅŸimi

Parse: modeâ€™a gÃ¶re (markdown/html/text) uygun parser/tokenizer

Stream Ä°ÅŸleme: chunkBytes ve overlapBytes ile kayan pencere; her parÃ§ada detectâ†’mask

Detect: Regex + hafif heuristik; uÃ§ durumlar iÃ§in two-pass (detect, validate)

Mask: Kurallara gÃ¶re; operatÃ¶r kimliÄŸi varsa op#hash Ã¼ret

Assemble: ParÃ§alarÄ± birleÅŸtir; sÄ±nÄ±flandÄ±rma seviyesini hesapla; istatistikleri Ã§Ä±kar

Idempotency: redactKey ile ikinci yazÄ±mÄ± engelle

Emit: redact.ready + redact.metrics; hata varsa redact.alert

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ redact.request â†’ PARSE

PARSE â†’ baÅŸarÄ±lÄ± â†’ STREAM | hata â†’ ALERT

STREAM â†’ (detectâ†’mask) dÃ¶ngÃ¼sÃ¼ â†’ ASSEMBLE

ASSEMBLE â†’ redact.ready + metrics â†’ IDLE

ALERT â†’ redact.alert â†’ IDLE

8) Kenar Durumlar

BÃ¼yÃ¼k iÃ§erik (>2MB): appendix uyarÄ±sÄ±; chunk bÃ¼yÃ¼tÃ¼p tek geÃ§iÅŸte bitir

Ã‡ok-yoÄŸun PII: performans artÄ±ÅŸÄ± iÃ§in aggressive=true profili (daha sÄ±kÄ± regex)

Ã‡apraz gÃ¼n (salt rotasyonu): eski salt ile Ã¼retilmiÅŸ takma adlar yeniden yazÄ±lmaz; sadece yeni maskeler

Kod bloklarÄ±nda ad/soyad anahtar kelimesi: code fence iÃ§indeyse maskeleme yapma

IBAN formatlÄ± ama allowlist domain baÄŸlamÄ±nda e-mail: ikinci geÃ§iÅŸte doÄŸrula, yanlÄ±ÅŸ pozitifleri geri al

9) Telemetri
{
  "redact.metrics": {
    "event":"redact.metrics",
    "timestamp":"iso8601",
    "processed": 4,
    "avgDetectMs": 5.2,
    "avgMaskMs": 3.1,
    "streamedPct": 0.75,
    "fpRate": 0.02,
    "fnRate": 0.01,
    "byProfile":{"digest":1,"postmortem":1,"notes":1,"cards":1},
    "entities":{"email":3,"phone":2,"iban":1,"wallet":1}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/piiGuardAndRedactor.ts          # servis giriÅŸi (FSM + orkestrasyon)
services/livia/lib/redact/detectors.ts         # regex + heuristik doÄŸrulayÄ±cÄ±lar
services/livia/lib/redact/maskers.ts           # maskeleme fonksiyonlarÄ±
services/livia/lib/redact/streamer.ts          # chunk/overlap stream iÅŸleyici
services/livia/lib/redact/mdTokenizer.ts       # Markdown tokenizasyonu
services/livia/lib/redact/htmlParser.ts        # HTML DOM parser
services/livia/lib/redact/classifier.ts        # sÄ±nÄ±flandÄ±rma mantÄ±ÄŸÄ±
services/livia/state/redactStore.ts            # idem index + sÃ¶zlÃ¼k cache
services/livia/__tests__/piiGuardAndRedactor.test.ts
cfg/livia.redact.yaml                          # profiles/patterns/masking/streaming

11) Test Ä°skeleti (Jest/Vitest)

Email/Phone/IBAN/Wallet: doÄŸru maskelenir; stats sayÄ±mlarÄ± tutar

Ticker korumasÄ±: AVAX/SOL/AVAXUSDT maskelenmez

Code fence: sadece wallet/IBAN maskelenir, kod metni korunur

HTML parse: <a href="mailto:..."> iÃ§ metin + attribute gÃ¼venli maskelenir

Streaming: sÄ±nÄ±r taÅŸmalarÄ±nda overlap yakalar (email iki parÃ§aya bÃ¶lÃ¼nmÃ¼ÅŸse bile)

Idempotency: aynÄ± iÃ§erik ikinci kez iÅŸlenmez

SÄ±nÄ±flandÄ±rma: PII varsa HIGH, yalnÄ±z ticker/path varsa LOW/PUBLIC

RBAC/Auth: imza hatasÄ± â†’ redact.alert(error,"auth_failed")

Performans: p95 detect+mask < 15 ms / 64KB parÃ§a

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

LIVIA-16 notes.daily.ready â†’ redact.request(profile=notes, mode=markdown, content=Daily.md)

PII saptandÄ±: 2 email, 1 telefon â†’ maskelendi, sÄ±nÄ±flandÄ±rma SENSITIVE_HIGH â†’ redact.ready

LIVIA-14 digest ve LIVIA-15 postmortem Ã¼retimleri, redacted iÃ§eriklerini dosyaya yazar

13) SLO

p95 detect+mask < 15 ms / 64KB

YanlÄ±ÅŸ pozitif oranÄ± â‰¤ %2, yanlÄ±ÅŸ negatif â‰¤ %1

Streaming Ã§Ä±kÄ±ÅŸ bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ â‰¥ %99.9 (byte sayÄ±mÄ±/sha256 doÄŸrulamasÄ±)
_____________________________________________________________________________________________
LIVIA-22 Â· opsDigestDistributor.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
LIVIAâ€™dan Ã¼retilen digest, postmortem, notes daily, card ve kritik uyarÄ± Ã§Ä±ktÄ±larÄ±nÄ±n; RBAC ve scope (global/desk/symbol) kurallarÄ±na uyarak doÄŸru kanallara (UI Inbox, Webhook, Slack/Discord/Telegram/Teams, e-posta) zamanÄ±nda, tekil ve Ã¶lÃ§Ã¼lebilir ÅŸekilde daÄŸÄ±tÄ±lmasÄ±. Ä°Ã§erikler daÄŸÄ±tÄ±mdan Ã¶nce PII redaksiyonundan (LIVIA-21) geÃ§er; kanal baÅŸÄ±na rate-limit, quiet hours, retry/backoff, DLQ (dead-letter queue) uygulanÄ±r. TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics standartlÄ±.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601, TZ=Europe/Istanbul; gÃ¼nlÃ¼k pencereler yerel saate gÃ¶re

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC: ops|policy|observer (kanal/audience tabanlÄ±)

Gizlilik: PII yok; tÃ¼m metinler Ã¶nce LIVIA-21 ile redakte edilir (profil: digest|postmortem|notes|cards)

Ä°dempotency: deliveryKey = sha256(contentCanonical + audience + channel + forDate)

Observability: OpenTelemetry (spans: dist.route, dist.render, dist.send, dist.ack) + metrics

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "digest.daily.ready": {
    "event":"digest.daily.ready",
    "timestamp":"iso8601",
    "forDate":"2025-09-13",
    "format":"md|html",
    "path":"data/digest/2025-09-13/digest.md",
    "summary":"SLO ok; Guard 17(1 halt); PnL $1.61k; 1 incident (37dk).",
    "sections":["SLO","Guard","Bounds","Anomali","Onaylar","Diyalog","PnL","Olaylar","Notlar"],
    "hash":"sha256:..."
  },

  "postmortem.ready": {
    "event":"postmortem.ready",
    "timestamp":"iso8601",
    "incidentId":"inc-2025-09-13-1",
    "format":"md|html",
    "path":"data/postmortem/2025-09-13/inc-2025-09-13-1.md",
    "summary":"Slip spike â€” 37dk; root latency+slip; impact -$1.2k.",
    "hash":"sha256:..."
  },

  "notes.daily.ready": {
    "event":"notes.daily.ready",
    "timestamp":"iso8601",
    "forDate":"2025-09-13",
    "path":"data/notes/2025-09-13/Daily.md",
    "summary":"decision:6, action:3, approval:2, incident:1, info:2",
    "hash":"sha256:..."
  },

  "recovery.ready": {
    "event":"recovery.ready",
    "timestamp":"iso8601",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "recoveryIndex":0.76,
    "suggestedStage":"ramp2",
    "minHoldMin":30
  },

  "cooldown.plan.activated": {
    "event":"cooldown.plan.activated",
    "timestamp":"iso8601",
    "cooldownKey":"...",
    "effectiveFrom":"iso8601",
    "effectiveUntil":"iso8601"
  },

  "dist.request": {
    "event":"dist.request",
    "timestamp":"iso8601",
    "contentRef":{"type":"digest|postmortem|notes|card|generic","path":"...","format":"md|html|text"},
    "audience":["ops","policy","observer"],
    "channels":["ui","slack","webhook"],
    "priority":"low|normal|high",
    "dryRun":false
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "dist.queued": {
    "event":"dist.queued",
    "timestamp":"iso8601",
    "deliveryKey":"sha256:...",
    "contentType":"digest|postmortem|notes|card|generic",
    "audience":["ops","policy"],
    "channels":["ui","slack"],
    "priority":"high"
  },

  "dist.sent": {
    "event":"dist.sent",
    "timestamp":"iso8601",
    "deliveryKey":"sha256:...",
    "channel":"slack|webhook|ui|email|discord|teams|telegram",
    "messageId":"ch-specific-id",
    "attempt":1
  },

  "dist.acked": {
    "event":"dist.acked",
    "timestamp":"iso8601",
    "deliveryKey":"sha256:...",
    "channel":"slack",
    "latencyMs":420
  },

  "dist.failed": {
    "event":"dist.failed",
    "timestamp":"iso8601",
    "deliveryKey":"sha256:...",
    "channel":"email",
    "error":"rate_limited|auth_failed|payload_too_large|network",
    "willRetryInSec": 60
  },

  "dist.dlq": {
    "event":"dist.dlq",
    "timestamp":"iso8601",
    "deliveryKey":"sha256:...",
    "reason":"permanent_failure|max_retries_exceeded",
    "deadLetterPath":"state/dlq/2025-09-13/sha256....json"
  },

  "dist.metrics": {
    "event":"dist.metrics",
    "timestamp":"iso8601",
    "queued":3,"sent":3,"acked":2,"failed":1,"retried":1,"dlq":0,
    "p95SendMs": 320,
    "rateLimited":0,
    "byChannel":{"ui":1,"slack":1,"webhook":1}
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  routing: {
    digest:     { audience:["ops","policy","observer"], channels:["ui","slack","email"], schedule:"18:15", priority:"high" },
    postmortem: { audience:["ops","policy"],            channels:["ui","slack","email","webhook"], priority:"high" },
    notes:      { audience:["ops","policy"],            channels:["ui"], schedule:"18:07" },
    signals:    { audience:["ops","policy"],            channels:["ui","slack","webhook"], priority:"high" }
  },

  rbac: {
    audienceToRole: { ops:["ops"], policy:["policy"], observer:["observer"] },
    scopeFilters: { // symbol/desk bazlÄ± filtreleme
      policy: { include:["global","desk","symbol"] },
      observer: { include:["global"], excludeSymbols:["*"] }
    }
  },

  channels: {
    ui:      { enabled:true,  ratePerMin: 60,  quietHours:[/* none */] },
    slack:   { enabled:true,  ratePerMin: 20,  quietHours:["23:00-07:00"],  formatter:"slackBlocks" },
    webhook: { enabled:true,  ratePerMin: 120, quietHours:[],               signWithHmac:true },
    email:   { enabled:true,  ratePerMin: 10,  quietHours:["22:00-08:00"],  maxBytes: 800_000 },
    discord: { enabled:false, ratePerMin: 15,  quietHours:[] },
    teams:   { enabled:false, ratePerMin: 15,  quietHours:[] },
    telegram:{ enabled:false, ratePerMin: 30,  quietHours:[] }
  },

  redaction: {
    enabled:true,
    profileMap: { digest:"digest", postmortem:"postmortem", notes:"notes", card:"cards", generic:"generic" }
  },

  retry: {
    maxAttempts: 5,
    backoff: { initialMs: 1000, factor: 2.0, jitterPct: 0.2 }
  },

  sizePolicy: {
    maxCardChars: 280,
    chunkHtmlAtBytes: 500_000, // e-posta ve webhook iÃ§in
    appendDownloadLinkIfChunked: true
  },

  schedule: { sweepEvery:"30s" },

  idempotencyTtlSec: 86400
}

5) Rendering & Kanal SÃ¶zleÅŸmeleri

Canonicalize: Markdown â†’ (i) kÄ±sa card text (â‰¤280 char), (ii) tam MD/HTML gÃ¶vde, (iii) attachments (path).

Slack/Discord/Teams: Markdown â†’ kanal bloklarÄ±; baÅŸlÄ±k, madde iÅŸaretleri, â€œdaha fazlaâ€ linki (path).

Webhook: JSON payload; HMAC imzalÄ±; contentType, summary, path, hash.

E-posta: HTML + inline CSS; bÃ¼yÃ¼k gÃ¶vde â†’ parÃ§a/parÃ§a veya Appendix linki.

UI Inbox: card + (opsiyonel) ayrÄ±ntÄ±ya git linki.

TÃ¼m metinler LIVIA-21 redaksiyonundan geÃ§irildikten sonra gÃ¶nderilir.

6) Pipeline (Kompozisyon)

Ingest: digest.ready/postmortem.ready/notes.daily.ready/.../dist.request â†’ QUEUE

Authorize & Scope: RBAC + scope filtreleri (audienceÃ—scopeÃ—symbol)

Redact: redact.request(profile=...) Ã§aÄŸÄ±r; maskedContent dÃ¶ner

Render: kanal-Ã¶zel formatter (slackBlocks/html/email/webhook payload)

Rate-limit & Quiet Hours: uygun zaman/limite gÃ¶re DEFER/sÄ±rala

Send: kanal adapterâ€™i ile ilet; attempt say ve latency Ã¶lÃ§

Ack/Retry: 2xx/ACK â†’ dist.acked; hata â†’ dist.failed + backoff; limit aÅŸÄ±mÄ± â†’ schedule

DLQ: max deneme aÅŸÄ±lÄ±rsa dist.dlq; manuel replay desteklenir

Emit Metrics: her dÃ¶ngÃ¼de dist.metrics gÃ¼ncelle

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (ready/request) â†’ QUEUE

QUEUE â†’ AUTHORIZE â†’ pass â†’ REDACT | fail â†’ DROP (+alert)

REDACT â†’ RENDER â†’ SCHEDULE_OR_SEND

SCHEDULE_OR_SEND â†’ (rate/quiet) DEFER | aksi SEND

SEND â†’ success ACK | fail RETRY

RETRY â†’ (attempt<max) SCHEDULE_OR_SEND | else DLQ

DEFER â†’ schedule hit â†’ SEND

Terminal: ACK/DLQ; her adÄ±mda metrics/alerts

8) Kenar Durumlar

BÃ¼yÃ¼k iÃ§erik: chunkHtmlAtBytes Ã¼stÃ¼ â†’ parÃ§alara bÃ¶l + Appendix linki

AynÄ± gÃ¼n aynÄ± kitle/kanal: deliveryKey ile tekil gÃ¶nderim (idempotency)

Quiet hours: yÃ¼ksek Ã¶ncelik (priority=high) ise sadece ops kanalÄ±na minimal card gÃ¶nder, diÄŸerleri sabaha ertelenir

Webhook doÄŸrulama: karÅŸÄ± taraf 4xx dÃ¶nÃ¼yorsa permanent, 5xx retryable

Redaction failure: redact.alert geldiÄŸinde send durur, DLQâ€™ye dÃ¼ÅŸmeden Ã¶nce bir kez daha dener (farklÄ± chunk boyu)

RBAC daralmasÄ±: observer kitlesine symbol iÃ§ermez; hassas metrikleri kaldÄ±r

9) Telemetri
{
  "dist.metrics": {
    "event":"dist.metrics",
    "timestamp":"iso8601",
    "queued": 5, "sent": 5, "acked": 4, "failed": 1, "retried": 1, "dlq": 0,
    "p50SendMs": 180, "p95SendMs": 320, "rateLimited": 0,
    "byChannel": {"ui":2,"slack":2,"email":1},
    "byContent": {"digest":1,"postmortem":1,"notes":1,"signals":2}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/opsDigestDistributor.ts          # FSM + router + scheduler
services/livia/lib/dist/rbac.ts                 # audience/scope filtreleri
services/livia/lib/dist/formatter.ts            # mdâ†’slack/html/email/webhook
services/livia/lib/dist/adapters/slack.ts       # kanal adapterâ€™leri
services/livia/lib/dist/adapters/webhook.ts
services/livia/lib/dist/adapters/email.ts
services/livia/lib/dist/adapters/ui.ts
services/livia/lib/dist/rateLimiter.ts          # kanal baÅŸÄ± hÄ±z limiti
services/livia/lib/dist/quietHours.ts
services/livia/state/distStore.ts               # queue + idem index + DLQ
services/livia/__tests__/opsDigestDistributor.test.ts
cfg/livia.dist.yaml                             # routing/rbac/channels/retry/size

11) Test Ä°skeleti (Jest/Vitest)

Digest akÄ±ÅŸÄ±: digest.ready â†’ RBAC pass â†’ redaction â†’ slack+ui gÃ¶nderildi, email quiet hoursâ€™a ertelendi

Postmortem bÃ¼yÃ¼k gÃ¶vde: e-posta iÃ§in chunk + Appendix linki; slackâ€™te card + path

Idempotency: aynÄ± iÃ§erik/audience/kanal tekrarÄ±nda ikinci gÃ¶nderim yok

Rate-limit: kÄ±sa sÃ¼rede 30 slack mesajÄ± â†’ schedule kuyruÄŸu bÃ¼yÃ¼r, send p95 < 400ms

Retry/Backoff: webhook 5xx â†’ 3 denemede baÅŸarÄ±ya ulaÅŸÄ±r

DLQ: e-posta auth hatasÄ± (permanent) â†’ DLQâ€™ye dÃ¼ÅŸer, replay Ã§alÄ±ÅŸÄ±r

Redaction zorunlu: PII bulunan iÃ§erik redakte edilmeden gÃ¶nderilmeye Ã§alÄ±ÅŸÄ±lÄ±rsa bloklanÄ±r

RBAC/Scope: observer kitlesine symbol verisi gizlenir

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

18:10 digest.daily.ready geldi â†’ QUEUEâ†’REDACT(digest) â†’ RENDER

Slack card + UI card hemen, e-posta quiet hours nedeniyle sabaha programlandÄ±

18:12 postmortem.ready â†’ Slack + Webhook (HMAC imzalÄ±) â†’ dist.acked

18:20 notes.daily.ready â†’ yalnÄ±z UIâ€™ya; dist.metrics gÃ¼ncellendi

13) SLO

p95 render+send (tek kanal) < 350 ms

duplicate rate â‰ˆ 0 (idempotency)

DLQ oranÄ± < %0.5 / gÃ¼n

Redaction-Ã¶ncesi sÄ±zÄ±ntÄ± 0 (zorunlu redaksiyon geÃ§idi)
______________________________________________________________________________________________
LIVIA-23 Â· policyUpdateOrchestrator.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Saha verileri (guard/slo/anomali/pnl/postmortem/yorgunluk/toparlanma vb.) ve operatÃ¶r geri bildirimlerinden politika yamasÄ± Ã¶nerileri (risk limitleri, guard eÅŸikleri, onay eÅŸiÄŸi, varyant izinleri, slip/spread/bid-ask kurallarÄ±, yÃ¼rÃ¼tme stratejileri) Ã¼retmek; onay kapÄ±sÄ± (LIVIA-05) Ã¼zerinden akÄ±tÄ±p kanaryalÄ± yayÄ±n (shadow/simulasyon â†’ canary â†’ full rollout) yapmak; SLO ihlalinde otomatik rollback; versiyonlama + changelog + imzalÄ± yayÄ±n. TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601, TZ=Europe/Istanbul

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC: policy yazabilir, ops|observer okuyabilir

Gizlilik: PII yok; serbest metinler LIVIA-21 redaksiyonundan geÃ§er

Ä°dempotency: policyKey = baseVersion + scope + symbol? + changeHash

GÃ¶zlemlenebilirlik: OpenTelemetry spans (policy.collect, policy.diff, policy.publish) + metrics

Uyumluluk: LIVIA-14/15/16/17/18/19/20/21/22 ile sinyal/daÄŸÄ±tÄ±m kÃ¶prÃ¼leri

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "policy.update.request": {
    "event":"policy.update.request",
    "timestamp":"iso8601",
    "mode":"auto|manual",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "goal":"reduce_slip|max_fill_quality|lower_latency|stabilize_rr",
    "dryRun": true
  },

  "slo.window.report": {
    "event":"slo.window.report",
    "timestamp":"iso8601",
    "windowMin": 240,
    "sloWorst":{"answer_latency_p95":"at_risk","guard_success_rate":"ok","uptime_feed":"ok"},
    "burnPct": 6.2
  },

  "guard.activity.rollup": {
    "event":"guard.activity.rollup",
    "timestamp":"iso8601",
    "counts":{"slowdown":12,"block_aggressive":4,"halt_entry":1},
    "topSymbols":[{"symbol":"AVAXUSDT","events":7},{"symbol":"SOLUSDT","events":5}]
  },

  "anomaly.summary": {
    "event":"anomaly.summary",
    "timestamp":"iso8601",
    "windowMin":1440,
    "high":2,"medium":5,"low":7,
    "seriesTop":[{"name":"order.slip.p95","count":4},{"name":"feed.gap","count":3}]
  },

  "pnl.daily": {
    "event":"pnl.daily",
    "timestamp":"iso8601",
    "desk":"default","netUSD":1610.24,"winRate":0.56,"rrMedian":1.42
  },

  "postmortem.ready": {
    "event":"postmortem.ready",
    "timestamp":"iso8601",
    "incidentId":"inc-2025-09-13-1",
    "summary":"Slip spike â€” rollback v42â†’v41; guard window dar.",
    "path":"data/postmortem/2025-09-13/inc-2025-09-13-1.md"
  },

  "cooldown.plan.activated": {
    "event":"cooldown.plan.activated",
    "timestamp":"iso8601",
    "reasonCode":"overtrading|overconfidence|panic_mode",
    "scope":"desk","symbol":null,"effectiveUntil":"iso8601"
  },

  "recovery.ready": {
    "event":"recovery.ready",
    "timestamp":"iso8601",
    "scope":"symbol","symbol":"AVAXUSDT","recoveryIndex":0.76,"suggestedStage":"ramp2"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "policy.patch.proposed": {
    "event":"policy.patch.proposed",
    "timestamp":"iso8601",
    "baseVersion":"v41",
    "targetVersion":"v41+1-candidate",
    "scope":"desk|symbol|global",
    "symbol":"AVAXUSDT|null",
    "impact":"low|medium|high",
    "delta": {
      "guard": { "windowMs": 1500, "slowdownThreshold": 0.7, "blockAggressiveOn": ["slip_spike"] },
      "limits": { "positionLimitFactor": 0.8, "dailyTradeCap": 3 },
      "exec": { "prefer":"twap|limit", "maxSlices":3, "slipMaxBps": 25 },
      "confirm": { "decisionThreshold": 0.62 }
    },
    "rationale":"Slip p95 anomali ve postmortem bulgularÄ± â†’ guard window geniÅŸlet; aggressive kÄ±sÄ±tla.",
    "riskScore": 0.34,
    "dryRun": true,
    "audit":{"producedBy":"LIVIA-23"}
  },

  "policy.diff.ready": {
    "event":"policy.diff.ready",
    "timestamp":"iso8601",
    "targetVersion":"v41+1-candidate",
    "format":"yaml|jsonpatch",
    "path":"data/policy/diffs/v41_to_v41+1.yaml",
    "summary":"guard window +300ms; aggressive kÄ±smi blok; slipMaxBps 30â†’25"
  },

  "policy.approval.request": {
    "event":"policy.approval.request",
    "timestamp":"iso8601",
    "targetVersion":"v41+1-candidate",
    "impact":"low|medium|high",
    "approvers":["policy-lead","risk-lead"],
    "changeSet":["guard.windowMs:+300","exec.prefer:twap","limits.positionLimitFactor:0.8"],
    "canary": {"sharePct": 0.1, "durationMin": 30}
  },

  "policy.canary.started": {
    "event":"policy.canary.started",
    "timestamp":"iso8601",
    "targetVersion":"v41+1-candidate",
    "sharePct": 0.1,
    "durationMin": 30,
    "monitor":["guard_success_rate","answer_latency_p95","pnl.netUSD"]
  },

  "policy.canary.result": {
    "event":"policy.canary.result",
    "timestamp":"iso8601",
    "targetVersion":"v41+1-candidate",
    "metrics":{"guard_success_rate":"+3.1%","answer_latency_p95":"-8.4%","pnl.netUSD":"+2.6%"},
    "decision":"promote|rollback|extend"
  },

  "policy.version.published": {
    "event":"policy.version.published",
    "timestamp":"iso8601",
    "version":"v42",
    "changelogPath":"data/policy/changelog/v42.md",
    "hash":"sha256:..."
  },

  "policy.rollback": {
    "event":"policy.rollback",
    "timestamp":"iso8601",
    "fromVersion":"v41+1-candidate",
    "toVersion":"v41",
    "reason":"slo_breach: answer_latency_p95"
  },

  "policy.metrics": {
    "event":"policy.metrics",
    "timestamp":"iso8601",
    "proposed":1,"approved":1,"published":1,"rolledBack":0,
    "avgApprovalMin":18,"avgCanaryMin":32,
    "riskScoreP95":0.55
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  sources: {
    use: ["slo","guard","anomaly","pnl","postmortem","cooldown","recovery","fatigue","notes"]
  },

  rules: {
    // sinyalâ†’Ã¶neri kurallarÄ± (deterministik)
    "slip.p95:high": [
      { path:"guard.windowMs", op:"inc", byMs:300, max:2500 },
      { path:"exec.slipMaxBps", op:"dec", toMin:20 }
    ],
    "guard.halt_entry>=1": [
      { path:"limits.positionLimitFactor", op:"set", to:0.7 },
      { path:"exec.prefer", op:"set", to:"limit" }
    ],
    "dialog.p95AnswerMs>1200": [
      { path:"confirm.decisionThreshold", op:"inc", by:0.05, max:0.75 }
    ],
    "postmortem:latency_guard_narrow": [
      { path:"guard.windowMs", op:"inc", byMs:200 }
    ]
  },

  impactModel: {
    weights: { guard:0.4, limits:0.25, exec:0.2, confirm:0.15 },
    highIf: ["guard.windowMs>+500","limits.positionLimitFactor<0.7","exec.prefer=halt","confirm.decisionThreshold>0.7"]
  },

  approval: {
    approvers:["policy-lead","risk-lead"],
    requireIfImpact:["medium","high"],
    gateway:"LIVIA-05"
  },

  rollout: {
    modes:["shadow","canary","full"],
    canarySharePct: 0.1,
    canaryDurationMin: 30,
    promoteIf: { "guard_success_rate":">=+2%", "answer_latency_p95":"<=-5%", "pnl.netUSD":">=0%" },
    rollbackIf: { "answer_latency_p95":">+5%", "sloWorst=breach": true }
  },

  output: {
    dir:"data/policy/{YYYY-MM-DD}",
    diffFile:"diff.yaml",
    changelogFile:"changelog.md"
  },

  redactionProfile:"generic",

  idempotencyTtlSec: 86400
}

5) Patch FormatlarÄ±

YAML Diff (Ã¶nerilen):

guard:
  windowMs: +300     # 1200 â†’ 1500
  blockAggressiveOn: ["slip_spike"]
limits:
  positionLimitFactor: 0.8
exec:
  prefer: "twap"
  slipMaxBps: 25     # 30 â†’ 25
confirm:
  decisionThreshold: 0.62


JSON Patch (opsiyonel): RFC6902 [{op:"replace", path:"/guard/windowMs", value:1500}, ...]

6) Pipeline (Kompozisyon)

Collect: SLO/guard/anomali/pnl/postmortem/recovery/fatigue/notes â†’ normalize

Derive: Kurallara gÃ¶re Ã¶neri adaylarÄ± Ã¼ret; aynÄ± path deÄŸiÅŸiklikleri merge edilir

RiskScore & Impact: impactModel ile aÄŸÄ±rlÄ±klandÄ±r; impact=low|medium|high seÃ§

Redact & Explain: Rationale metnini LIVIA-21 ile redakte et; kÄ±sa aÃ§Ä±klama Ã¼ret

Diff Build: YAML/JSON Patch oluÅŸtur; policy.diff.ready + dosyaya yaz

Approval: policy.approval.request â†’ LIVIA-05 onayÄ± (impact gereÄŸi)

Rollout: shadow (dryRun Ã¶lÃ§Ã¼m) â†’ canary (sharePct/duration) â†’ sonuÃ§ â†’ promote|extend|rollback

Publish: koÅŸullar saÄŸlanÄ±rsa policy.version.published + changelog; LIVIA-22 ile daÄŸÄ±tÄ±m kartÄ±

Rollback: canary/full esnasÄ±nda rollbackIf saÄŸlanÄ±rsa otomatik policy.rollback

Metrics: policy.metrics gÃ¼ncelle; digestâ€™e Ã¶zet sinyal (LIVIA-14)

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ policy.update.request | schedule â†’ COLLECT

COLLECT â†’ verileri toparla â†’ PROPOSE

PROPOSE â†’ diff+patch oluÅŸtur â†’ (impactâ†’approval?) AWAIT_APPROVAL | PREPARE_ROLLOUT

AWAIT_APPROVAL â†’ approval.granted â†’ PREPARE_ROLLOUT | rejected â†’ IDLE

PREPARE_ROLLOUT â†’ shadow Ã¶lÃ§ â†’ CANARY

CANARY â†’ metrikler â†’ promote â†’ PUBLISH | extend â†’ CANARY | rollback â†’ ROLLBACK

PUBLISH â†’ versiyon yaz + changelog â†’ IDLE

ROLLBACK â†’ eski sÃ¼rÃ¼me dÃ¶n â†’ IDLE

Hata: her adÄ±mda policy.alert(level,"...") + IDLE

8) Kenar Durumlar

Ã‡eliÅŸen delta: aynÄ± pathâ€™te zÄ±t deÄŸiÅŸiklik â†’ en muhafazakÃ¢rÄ± seÃ§ + uyarÄ±

DryRun: sadece diff.ready ve card; publish/rollout yok

Onay gecikmesi: timeout â†’ otomatik dryRun only raporu

SLO breach canary: anÄ±nda rollback + policy.rollback emit

Global vs symbol Ã§akÄ±ÅŸmasÄ±: symbol lokali Ã¼stÃ¼n (override), changelogâ€™da not dÃ¼ÅŸ

GÃ¼n/versiyon Ã§akÄ±ÅŸmasÄ±: policyKey ile ikinci yazÄ±mÄ± engelle

PII metni: aÃ§Ä±klama Ã¶nce LIVIA-21â€™den geÃ§er, aksi blok

9) Telemetri
{
  "policy.metrics": {
    "event":"policy.metrics",
    "timestamp":"iso8601",
    "proposed":2,"approved":1,"published":1,"rolledBack":0,
    "avgApprovalMin":18,"avgCanaryMin":32,"riskScoreP95":0.55,
    "highImpactShare":0.20
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/policyUpdateOrchestrator.ts     # FSM + orchestrator
services/livia/lib/policy/collectors.ts        # slo/guard/anomaly/pnl/postmortem/...
services/livia/lib/policy/rules.ts             # sinyalâ†’Ã¶neri kurallarÄ±
services/livia/lib/policy/diff.ts              # YAML/JSON Patch Ã¼retimi
services/livia/lib/policy/impact.ts            # riskScore & impact hesap
services/livia/lib/policy/rollout.ts           # shadow/canary/full akÄ±ÅŸÄ±
services/livia/lib/policy/rollback.ts          # otomatik rollback
services/livia/lib/redact.ts                   # LIVIA-21 kÃ¶prÃ¼sÃ¼
services/livia/lib/approvalBridge.ts           # LIVIA-05 onay kapÄ±sÄ±
services/livia/state/policyStore.ts            # versiyonlar, idem index
services/livia/__tests__/policyUpdateOrchestrator.test.ts
cfg/livia.policy.yaml                          # rules/impact/rollout/approval

11) Test Ä°skeleti (Jest/Vitest)

Slip yÃ¼ksek + guard dar: window +300ms, slipMaxBps dÃ¼ÅŸer; diff doÄŸru mu?

Impact=high: approval zorunlu; reddedilirse publish olmaz

Canary promote: metrikler iyileÅŸirse version.published

Canary rollback: SLO breach â†’ policy.rollback

DryRun: sadece diff+card, dosya yazÄ±mÄ± var; publish yok

Idempotency: aynÄ± policyKey ikinci kez yazÄ±lmaz

RBAC/Auth: yazma talebi policy rolÃ¼ deÄŸilse 403

Redaction: aÃ§Ä±klama iÃ§inde PII varsa maskelenir

Changelog: baÅŸlÄ±k/Ã¶zet doÄŸru, hash Ã¼retildi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

18:30 policy.update.request(auto, scope=symbol:AVAXUSDT, dryRun=true)

COLLECTâ†’PROPOSE: guard.window +300ms, exec.slipMaxBps 25, limits.factor 0.8 â†’ policy.diff.ready

AWAIT_APPROVAL: granted â†’ PREPARE_ROLLOUT (shadowâ†’canary 10%/30dk)

CANARY sonucu: guard_success_rate +3%, latency_p95 -8%, PnL â‰¥ 0 â†’ PUBLISH v42 + changelog â†’ LIVIA-22 daÄŸÄ±ttÄ±

13) SLO

p95 collect+propose < 80 ms (Ã¶nbellekli toplayÄ±cÄ±)

canary decision latency â‰¤ 60 s metrik penceresi sonunda

rollback MTTR â‰¤ 30 s

idempotent Ã§akÄ±ÅŸma â‰ˆ 0; versiyon Ã§akÄ±ÅŸma oranÄ± < %0.5
______________________________________________________________________________________________
LIVIA-24 Â· knowledgeRouterBridge.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
LIVIA ekosisteminde Ã¼retilen digest / postmortem / notes / policy / cards iÃ§eriklerini bilgi tabanÄ±na (KB) gÃ¼venli biÃ§imde indekslemek ve sorgu olaylarÄ±nÄ± doÄŸru kaynaklara yÃ¶nlendirmek (hybrid arama: semantik + anahtar kelime + tazelik). Sorguya gÃ¶re alÄ±ntÄ±lÄ± cevap (citations) ve kÄ±sa card Ã¼ret; PIIâ€™yi LIVIA-21 ile redakte et; RBACâ€™e gÃ¶re gÃ¶rÃ¼nÃ¼rlÃ¼k uygula; idempotent + audit + metrics ile Ã§alÄ±ÅŸ. TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; yerel gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC: policy|ops|observer

Gizlilik: PII redaksiyonu zorunlu (LIVIA-21); sÄ±nÄ±flandÄ±rma etiketi (PUBLIC|SENSITIVE_LOW|SENSITIVE_HIGH) saklanÄ±r

Ä°dempotency:

Ä°ndeks: docKey = sha256(path?+contentHash) + scope + profile

Sorgu: queryKey = sha256(query + filters + topK) + windowStartISO

Observability: OpenTelemetry (spans: kb.ingest, kb.chunk, kb.embed, kb.search, kb.rerank, kb.answer) + metrics

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "knowledge.ingest.request": {
    "event":"knowledge.ingest.request",
    "timestamp":"iso8601",
    "type":"digest|postmortem|notes|policy|card|generic",
    "format":"md|html|text",
    "path":"data/.../file.ext|null",
    "content":"<string|null>",
    "profile":"digest|postmortem|notes|cards|generic",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "tags":["SLO","Guard","PnL"],
    "sourceRef":{"eventId":"...","hash":"sha256:..."}
  },

  "digest.daily.ready": {
    "event":"digest.daily.ready",
    "timestamp":"iso8601",
    "forDate":"2025-09-13",
    "format":"md|html",
    "path":"data/digest/2025-09-13/digest.md",
    "summary":"...",
    "hash":"sha256:..."
  },

  "postmortem.ready": {
    "event":"postmortem.ready",
    "timestamp":"iso8601",
    "incidentId":"inc-2025-09-13-1",
    "format":"md|html",
    "path":"data/postmortem/2025-09-13/inc-2025-09-13-1.md",
    "summary":"...",
    "hash":"sha256:..."
  },

  "notes.daily.ready": {
    "event":"notes.daily.ready",
    "timestamp":"iso8601",
    "forDate":"2025-09-13",
    "path":"data/notes/2025-09-13/Daily.md",
    "summary":"...",
    "hash":"sha256:..."
  },

  "policy.version.published": {
    "event":"policy.version.published",
    "timestamp":"iso8601",
    "version":"v42",
    "changelogPath":"data/policy/changelog/v42.md",
    "hash":"sha256:..."
  },

  "knowledge.query.request": {
    "event":"knowledge.query.request",
    "timestamp":"iso8601",
    "query":"Slip spike neden oldu? rollback neydi?",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "audience":"ops|policy|observer",
    "filters":{"type":["postmortem","policy"],"dateFrom":"2025-09-01","dateTo":"2025-09-14","tags":["Guard"]},
    "topK":8,
    "mode":"extractive|abstractive|hybrid"
  },

  "knowledge.reindex.request": {
    "event":"knowledge.reindex.request",
    "timestamp":"iso8601",
    "types":["digest","postmortem","policy"],
    "since":"2025-09-01"
  },

  "knowledge.delete.request": {
    "event":"knowledge.delete.request",
    "timestamp":"iso8601",
    "docId":"kb:postmortem:inc-2025-09-13-1"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "knowledge.ingest.ready": {
    "event":"knowledge.ingest.ready",
    "timestamp":"iso8601",
    "docId":"kb:postmortem:inc-2025-09-13-1",
    "type":"postmortem",
    "chunks": 14,
    "bytes": 16800,
    "hash":"sha256:...",
    "classification":"SENSITIVE_LOW"
  },

  "knowledge.indexed": {
    "event":"knowledge.indexed",
    "timestamp":"iso8601",
    "index":"kb_default",
    "docId":"kb:postmortem:inc-2025-09-13-1",
    "vectors": 14,
    "dim": 768,
    "upserted": true
  },

  "knowledge.deleted": {
    "event":"knowledge.deleted",
    "timestamp":"iso8601",
    "docId":"kb:postmortem:inc-2025-09-13-1"
  },

  "knowledge.answer.ready": {
    "event":"knowledge.answer.ready",
    "timestamp":"iso8601",
    "query":"Slip spike neden oldu? rollback neydi?",
    "replies":[
      {
        "mode":"extractive",
        "text":"Ä°lgili incidentâ€™ta kÃ¶k neden latency+slip; Ã§Ã¶zÃ¼m rollback v42â†’v41.",
        "score":0.84,
        "citations":[
          {"docId":"kb:postmortem:inc-2025-09-13-1","path":"data/postmortem/...md","section":"RootCause","lines":"12-22","score":0.88},
          {"docId":"kb:digest:2025-09-13","path":"data/digest/...md","section":"Olaylar","lines":"85-96","score":0.79}
        ]
      }
    ],
    "usedHybrid": true,
    "filtersApplied":{"type":["postmortem","policy"],"symbol":"AVAXUSDT"}
  },

  "knowledge.card": {
    "event":"knowledge.card",
    "timestamp":"iso8601",
    "title":"YanÄ±t hazÄ±r â€” Slip spike/rollback",
    "body":"KÃ¶k neden: latency+slip â€¢ Ã‡Ã¶zÃ¼m: rollback v42â†’v41 â€¢ Kaynak: postmortem+digest",
    "severity":"info",
    "ttlSec":600
  },

  "knowledge.alert": {
    "event":"knowledge.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|parser_error|embed_failed|rbac_denied|no_results",
    "context":{"docId":"kb:...","queryKey":"sha256:..."}
  },

  "knowledge.metrics": {
    "event":"knowledge.metrics",
    "timestamp":"iso8601",
    "ingested":3,"indexed":3,"deleted":0,
    "queries":5,"answers":4,"noResults":1,
    "p95IngestMs":72,"p95QueryMs":95,
    "hybridShare":0.92,"recencyBoostApplied":0.66,
    "zeroPiiLeak":true
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  storage: { baseDir:"data/kb" },

  redaction: {
    required:true,
    profileMap:{ digest:"digest", postmortem:"postmortem", notes:"notes", policy:"generic", card:"cards", generic:"generic" }
  },

  chunking: {
    strategy:"markdownAware",
    targetTokens: 800,   // 512â€“1024 aralÄ±ÄŸÄ±
    overlapTokens: 64,
    keepSections:true,   // baÅŸlÄ±k/altbaÅŸlÄ±k korunur
    dropFooters:true
  },

  embeddings: {
    provider:"pluggable", // adapter: local|service
    model:"e5-small|text-embedding-3-small",
    dim: 384|512|768,
    batchSize: 16,
    normalize:true
  },

  index: {
    vector:"pluggable",  // adapter: pgvector|qdrant|milvus|elastic-knn|vespa
    lexical:"bm25",      // opsiyonel ters indeks
    namespace:"kb_default",
    upsertIfSameHash:false,     // docKey eÅŸleÅŸirse atla
    dedupeNearDup:true,         // simhash/minhash ile
    maxDocsPerDay: 5000
  },

  search: {
    hybrid:true,
    topK: 8,
    bm25K: 50,
    mmrLambda: 0.5,          // Ã§eÅŸitlilik
    recencyBoostHalfLifeDays: 7,
    scopeFilter:{enabled:true},
    symbolFilter:{enabled:true},
    reranker:{enabled:true, provider:"cross-encoder|none"}
  },

  rbac: {
    policy: { canSee:["policy","postmortem","digest","notes","card"] },
    ops:    { canSee:["postmortem","digest","notes","card","policy"] },
    observer:{ canSee:["digest","card"], hideFields:["symbol","incidentId","pnl"] }
  },

  schedule: {
    reindexDailyAt:"03:00",
    optimizeWeeklyAt:"Sun 04:00"
  },

  idempotencyTtlSec: 86400
}

5) Belge ÅemasÄ± (KB)
type KBType = "digest"|"postmortem"|"notes"|"policy"|"card"|"generic";

interface KBDocument {
  docId: string;            // "kb:{type}:{slug}"
  type: KBType;
  title: string;
  summary?: string;
  forDate?: string;         // YYYY-MM-DD
  incidentId?: string;
  scope: "global"|"desk"|"symbol";
  symbol: string|null;
  tags: string[];
  classification: "PUBLIC"|"SENSITIVE_LOW"|"SENSITIVE_HIGH";
  path?: string;            // kaynak dosya yolu
  hash: string;             // sha256 content
  createdAt: string;        // ISO
  sections?: Array<{ id:string; title:string; fromLine:number; toLine:number }>;
}

6) Pipeline â€” Ä°ndeksleme

Kaynak SeÃ§imi: knowledge.ingest.request veya *.ready olaylarÄ± â†’ iÃ§erik path veya content.

Redaksiyon: LIVIA-21â€™e redact.request(profile=...) â†’ maskedContent, classification.

Chunking: Markdown/HTML farkÄ±ndalÄ±klÄ±; baÅŸlÄ±klarla parÃ§a bÃ¶l; overlapTokens uygula.

Embedding: Toplu (batch) vektÃ¶r Ã¼ret; normalize et; hatada embed_failed.

Dedup: docKey ve simhash ile aynÄ±/benzer dokÃ¼manÄ± atla veya merge et.

Upsert: VektÃ¶r ve metadata upsert; lexical indeks (BM25) gÃ¼ncelle.

Emit: knowledge.ingest.ready + knowledge.indexed + knowledge.metrics.

7) Pipeline â€” Sorgu/Route & Cevap

RBAC/Filtre: audience, scope, symbol, date aralÄ±ÄŸÄ±, type â†’ yetki ve filtre kontrolÃ¼.

Embedding: Sorgu vektÃ¶rÃ¼ â†’ semantik arama (topK) + BM25 (bm25K).

Hybrid Fusion: SkorlarÄ± z-normalize et; MMR ile Ã§eÅŸitlilik; recency boost ekle.

Rerank (opsiyonel): Cross-encoder ile ilk N sonucu yeniden sÄ±rala.

Cevap Ãœretimi:

Extractive: En iyi parÃ§alardan alÄ±ntÄ± + kÄ±sa Ã¶zet (markdown)

Abstractive/Hybrid: ParÃ§a Ã¶zetlerini birleÅŸtir, 280 karakterlik card da Ã¼ret

Her zaman citations: {docId, path, section, lines, score}

Emit: knowledge.answer.ready + knowledge.card + knowledge.metrics.

8) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (*.ready | knowledge.ingest.request) â†’ INGEST

INGEST â†’ redactâ†’chunkâ†’embedâ†’upsert â†’ EMIT_INGEST â†’ IDLE

IDLE â†’ knowledge.query.request â†’ RETRIEVE

RETRIEVE â†’ hybrid+rerenk â†’ ANSWER â†’ EMIT_ANSWER â†’ IDLE

IDLE â†’ knowledge.reindex.request â†’ REINDEX â†’ (loop) â†’ IDLE

IDLE â†’ knowledge.delete.request â†’ DELETE â†’ IDLE

Hata â†’ knowledge.alert + IDLE

9) Kenar Durumlar

PII zorunlu: Redaksiyon baÅŸarÄ±sÄ±z â†’ indeksleme bloklanÄ±r (alert).

BÃ¼yÃ¼k dosya (>2MB): parÃ§a-parÃ§a stream; bytes sayaÃ§larÄ± ve Appendix linkleri korunur.

YakÄ±n duplikasyon: simhash distance <= 3 ise merge (daha yeni olan kazanÄ±r).

SÄ±fÄ±r sonuÃ§: knowledge.answer.ready Ã¼retme; knowledge.alert("no_results") + suggestion (filtre dÃ¼ÅŸÃ¼r, tarih aralÄ±ÄŸÄ± geniÅŸlet).

RBAC/observer: hassas alanlar (symbol, incidentId, pnl) gizlenir; citation yine gÃ¶rÃ¼nÃ¼r ama maskeâ€™li baÅŸlÄ±kla.

Bozuk Markdown/HTML: parser fallback text moduna geÃ§er; parser_error log.

Index provider down: geÃ§ici DLQ dizinine yaz; provider gelince replay.

10) Telemetri (OpenTelemetry + event)
{
  "knowledge.metrics": {
    "event":"knowledge.metrics",
    "timestamp":"iso8601",
    "ingested":3,"indexed":3,"deleted":0,
    "queries":5,"answers":4,"noResults":1,
    "p50IngestMs":41,"p95IngestMs":72,"p95QueryMs":95,
    "hybridShare":0.92,"recencyBoostApplied":0.66,
    "zeroPiiLeak":true,
    "topQueries":["rollback nedir","guard window kaÃ§ ms"],
    "byType":{"digest":1,"postmortem":1,"notes":1}
  }
}

11) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/knowledgeRouterBridge.ts        # FSM + orchestrator
services/livia/lib/kb/chunker.ts               # markdown/html aware chunking
services/livia/lib/kb/embeddings.ts            # provider adapter
services/livia/lib/kb/vectorIndex.ts           # vector upsert/query adapter
services/livia/lib/kb/lexicalIndex.ts          # BM25 adapter (opsiyonel)
services/livia/lib/kb/hybridSearch.ts          # fusion + MMR + recency boost
services/livia/lib/kb/reranker.ts              # cross-encoder (opsiyonel)
services/livia/lib/kb/normalizers.ts           # clean/normalize utils
services/livia/lib/kb/simhash.ts               # near-dup detection
services/livia/lib/access.ts                   # RBAC filtering for KB
services/livia/state/knowledgeStore.ts         # idem index + stats
services/livia/__tests__/knowledgeRouterBridge.test.ts
cfg/livia.knowledge.yaml                       # chunk/embeddings/index/search/rbac

12) Test Ä°skeleti (Jest/Vitest)

Ä°ndeksleme: digest.ready/postmortem.ready â†’ redaksiyon â†’ chunkâ†’embedâ†’upsert â†’ knowledge.indexed

Dedup: aynÄ± digest ikinci kez â†’ upsert atlandÄ± (docKey)

Near-dup: ufak farklÄ±lÄ±kta dokÃ¼man â†’ merge edildi

Sorgu-Hybrid: BM25+vektÃ¶r birleÅŸimi; recency boost etki eder

Rerank: cross-encoder aÃ§Ä±kken sonuÃ§ sÄ±rasÄ± deÄŸiÅŸir; skor iyileÅŸir

Citations: answer.ready tÃ¼m alÄ±ntÄ±larÄ± iÃ§erir, satÄ±r aralÄ±ÄŸÄ± & bÃ¶lÃ¼m dolu

RBAC/observer: hassas alanlar gizlenir; cevap gÃ¶rÃ¼nÃ¼r

PII zorunluluÄŸu: redaksiyon kapalÄ±ysa indeks baÅŸarÄ±sÄ±z (alert)

Idempotency: aynÄ± queryKey ile arka arkaya istek â†’ cacheâ€™den yanÄ±t (â‰¤50 ms)

Provider hata: vectorIndex down â†’ DLQâ€™ye yazar; replay sonrasÄ± indexed

13) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

18:10 digest.daily.ready â†’ INGEST (redactâ†’chunkâ†’embedâ†’upsert)

18:12 postmortem.ready â†’ INGEST

18:30 knowledge.query.request(type=postmortem, symbol=AVAXUSDT) â†’ RETRIEVE â†’ knowledge.answer.ready + card

Gece 03:00 â†’ REINDEX/optimize planlÄ± gÃ¶revleri

14) SLO

p95 ingest < 80 ms / 10K token iÃ§erik

p95 query < 120 ms (hybrid+rerank dÃ¢hil)

zeroPiiLeak = true (redaksiyon kapÄ±sÄ± zorunlu)

duplicate rate â‰ˆ 0; simhash near-dup false-negative < %1

answer coverage (noResults oranÄ±) < %10
_____________________________________________________________________________________________
LIVIA-25 Â· riskScenarioSimulator.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Politika/guard/limit/exec/confirmation parametreleri iÃ§in â€œwhat-ifâ€ senaryo simÃ¼lasyonu yaparak beklenen etkiyi (SLO, Guard, PnL, slip/fill kalitesi, onay oranÄ±, risk) hÄ±zlÄ± ve gÃ¼venli biÃ§imde tahmin etmek. Ã‡Ä±ktÄ±; pareto frontier (iyileÅŸme vs. yan etki), Ã¶nerilen top senaryolar, kÄ±sa card, ve rapor dosyasÄ±dÄ±r. LIVIA-23 (policyUpdateOrchestrator) iÃ§in girdi Ã¼retir; LIVIA-22 ile daÄŸÄ±tÄ±lÄ±r; rapor LIVIA-24 ile KBâ€™ye indekslenir. I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601, TZ=Europe/Istanbul (gÃ¼n penceresi 00:00â€“23:59:59)

GÃ¼venlik: HMAC/JWT doÄŸrulama; RBAC: policy yazabilir, ops|observer okuyabilir

Gizlilik: PII yok; serbest metinler LIVIA-21 ile redakte edilir (profile=generic)

Ä°dempotency: simKey = baseVersion + scope + symbol? + gridHash + dataWindow + seed

Observability: OpenTelemetry (sim.collect, sim.calibrate, sim.run, sim.pareto, sim.report) + metrics

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "scenario.request": {
    "event":"scenario.request",
    "timestamp":"iso8601",
    "mode":"auto|manual",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "baseVersion":"v41",
    "dataWindowMin": 1440,              // geÃ§miÅŸ veri penceresi
    "objectives": ["reduce_slip","keep_latency","pnl_nonneg"],
    "constraints": {
      "sloMax":{"answer_latency_p95":"+0%","guard_success_rate":"-0.5%"},
      "pnlMinUSD": 0,
      "rrMedianMin": 1.2
    },
    "grid": {                           // parametre Ä±zgarasÄ± (kombinasyon simÃ¼le edilir)
      "guard.windowMs":[1200,1500,1800],
      "exec.slipMaxBps":[30,25,20],
      "limits.positionLimitFactor":[0.8,0.7],
      "confirm.decisionThreshold":[0.58,0.62],
      "exec.prefer":["twap","limit"]
    },
    "maxCombos": 120,                   // Ã¼st limit; fazla ise downsample
    "seed": 42,
    "dryRun": false
  },

  "policy.patch.proposed": {
    "event":"policy.patch.proposed",
    "timestamp":"iso8601",
    "baseVersion":"v41",
    "scope":"symbol",
    "symbol":"AVAXUSDT",
    "delta": {
      "guard":{"windowMs":1500},
      "exec": {"slipMaxBps":25,"prefer":"twap"},
      "limits":{"positionLimitFactor":0.8},
      "confirm":{"decisionThreshold":0.62}
    },
    "riskScore":0.34
  },

  "slo.window.report": {
    "event":"slo.window.report",
    "timestamp":"iso8601",
    "windowMin": 240,
    "sloWorst":{"answer_latency_p95":"at_risk","guard_success_rate":"ok","uptime_feed":"ok"},
    "burnPct": 6.2
  },

  "pnl.history.ref": {
    "event":"pnl.history.ref",
    "timestamp":"iso8601",
    "path":"data/pnl/2025-09-*.parquet",
    "stats":{"netUSD":16102.4,"rrMedian":1.36,"trades":842}
  },

  "slip.fill.sample": {
    "event":"slip.fill.sample",
    "timestamp":"iso8601",
    "symbol":"AVAXUSDT|null",
    "size": 5000,
    "features":["spread_bps","rsi","vol","lat_ms","exec","variant"],
    "schemaVersion":"v2"
  }
}


Not: scenario.request yoksa policy.patch.proposed tetikleyici olarak tek-senaryo simÃ¼le edilir.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "scenario.sim.ready": {
    "event":"scenario.sim.ready",
    "timestamp":"iso8601",
    "simKey":"sha256:...",
    "scope":"symbol",
    "symbol":"AVAXUSDT",
    "baseVersion":"v41",
    "combosEvaluated": 72,
    "paretoCount": 6,
    "top": [
      {
        "id":"S-014",
        "delta":{"guard.windowMs":1500,"exec.slipMaxBps":25,"limits.positionLimitFactor":0.8,"confirm.decisionThreshold":0.62,"exec.prefer":"twap"},
        "expected":{"slip_p95":"-12.4%","answer_latency_p95":"-4.1%","guard_success_rate":"+1.2%","pnl.netUSD":"+1.8%","rrMedian":"+0.06"},
        "risk":{"overfit":0.12,"dataCoverage":0.91},
        "meetsConstraints":true,
        "score":0.83
      }
    ],
    "reportPath":"data/sim/2025-09-13/AVAXUSDT/v41_gridA/report.md",
    "hash":"sha256:..."
  },

  "scenario.top.pareto": {
    "event":"scenario.top.pareto",
    "timestamp":"iso8601",
    "items":[{"id":"S-014","score":0.83},{"id":"S-027","score":0.81},{"id":"S-031","score":0.79}]
  },

  "scenario.card": {
    "event":"scenario.card",
    "timestamp":"iso8601",
    "title":"Senaryo SonuÃ§larÄ± â€” AVAXUSDT",
    "body":"6 pareto aday: en iyi S-014 â†’ slip âˆ’12%, latency âˆ’4%, PnL +1.8%, constraints OK.",
    "severity":"info",
    "ttlSec":600
  },

  "scenario.alert": {
    "event":"scenario.alert",
    "timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"missing_data|idem_duplicate|timeout|budget_exceeded|invalid_grid",
    "context":{"scope":"symbol","symbol":"AVAXUSDT"}
  },

  "scenario.metrics": {
    "event":"scenario.metrics",
    "timestamp":"iso8601",
    "combos":72,"pareto":6,"avgSimMs":3.8,"p95SimMs":9.6,
    "downsampled":true,"coverage":0.91,
    "violations":{"slo":0,"pnlMin":2},
    "dominancePruned":18
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  data: {
    historyWindowMin: 1440,
    minCoverage: 0.75,               // yeterli veri kapsamasÄ±
    bucketBy: ["symbol","variant","volRegime"]
  },

  models: {
    // hafif ve hÄ±zlÄ±: reweighting + bootstrap + elastisite
    slipElasticity: { perBps: -0.015 },            // slipMaxBps â†“ 5 â†’ slip_p95 â‰ˆ âˆ’7.5% (Ã¶r.)
    latencyVsWindowMs: { per100ms: -0.8 },         // window artÄ±ÅŸÄ± p95 latency etkisi %
    guardSuccessVsBlockAgg: { blockAggressive: +1.0 },
    pnlEffect: { rrWeight: 0.6, fillQualWeight: 0.4 },
    confirmationToAccept: { perThresholdPoint: -0.10 } // 0.58â†’0.62 ile acceptRate âˆ’4p
  },

  simulation: {
    maxCombos: 200,
    maxMs: 250,                     // toplam sÃ¼re bÃ¼tÃ§esi
    seed: 42,
    bootstrapIters: 2000,           // kÃ¼Ã§Ã¼k, hÄ±zlÄ± MC
    downsampleStrategy: "latinHypercube|random"
  },

  objectives: {
    weights: { slip:0.35, latency:0.2, guardSucc:0.1, pnl:0.25, rr:0.1 }, // skor bileÅŸimi
    maximize: ["guardSucc","pnl","rr"], minimize: ["slip","latency"]
  },

  constraints: {
    sloMax: { "answer_latency_p95":"+0%", "guard_success_rate":"-0.5%" },
    pnlMinUSD: 0,
    rrMedianMin: 1.2
  },

  dominance: {
    enable:true,
    epsilonPct: 0.5                  // %0.5 farklar eÅŸdeÄŸer kabul
  },

  output: {
    dir:"data/sim/{YYYY-MM-DD}/{scope}/{symbolOrAll}",
    reportFile:"report.md",
    html:{ embedMiniCSS:true, chartsInlineSvg:true }
  },

  redactionProfile:"generic",

  idempotencyTtlSec: 86400
}

5) Skorlama & Modelleme (Ã¶zet)

KalÄ±brasyon: GeÃ§miÅŸ pencere iÃ§in ground truth metrikleri (slip_p95, latency_p95, guard_success, pnl.netUSD, rrMedian) hesapla.

KarÅŸÄ±-olgusal (counterfactual) yaklaÅŸÄ±m:

Reweighting: w = f(delta.exec, delta.windowMs, delta.slipMaxBps, ... ) ile Ã¶rnek aÄŸÄ±rlÄ±kla.

Bootstrap: Iters Ã— yeniden Ã¶rnekleme â†’ gÃ¼ven aralÄ±ÄŸÄ±.

Elastisite kurallarÄ±: konfigteki elastisiteleri parametre deÄŸiÅŸimlerine uygula.

KÄ±sÄ±t kontrolÃ¼: constraints ehr senaryo iÃ§in ex-ante (model Ã§Ä±ktÄ±sÄ±) ve ex-post (bootstrap quantile)

Skor: normalize edilmiÅŸ hedefler ve aÄŸÄ±rlÄ±klar ile score âˆˆ [0,1] â†’ pareto sÃ¼zgeci.

6) Pipeline (Kompozisyon)

Collect: pnl.history.ref, slip.fill.sample, slo.window.report, (opsiyonel) policy.patch.proposed

Validate: Zod .strict(); eksikler â†’ scenario.alert("missing_data")

Calibrate: ground truth + elastisite parametrelerinin yerel (symbol/desk) Ã¶lÃ§eklemesi

Grid Build: scenario.request.grid â†’ maxCombos ve bÃ¼tÃ§eye gÃ¶re downsample

Simulate: her komboda (i) reweight, (ii) bootstrap CI, (iii) elastisite birleÅŸimi

Filter: constraints ihlali â†’ prune; dominance (epsilon) â†’ pareto

Rank: objectives.weights ile skorla, top-N seÃ§ (Nâ‰¤10)

Report: Markdown/HTML tablo + kÃ¼Ã§Ã¼k inline grafikler; LIVIA-21 ile redaksiyon; dosyaya yaz

Emit: scenario.sim.ready, scenario.top.pareto, scenario.card, scenario.metrics

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (scenario.request | policy.patch.proposed) â†’ COLLECT

COLLECT â†’ veri ok & kalibre â†’ BUILD_GRID

BUILD_GRID â†’ downsample â†’ SIMULATE

SIMULATE â†’ kÄ±sÄ±t/dominans sÃ¼zgeci â†’ REPORT

REPORT â†’ dosya yaz + emit â†’ IDLE

Hata: her adÄ±mda scenario.alert(level,"...") + IDLE

8) Kenar Durumlar

AÅŸÄ±rÄ± bÃ¼yÃ¼k grid: maxCombos Ã¼stÃ¼ â†’ latinHypercube ile Ã¶rnekle, downsampled:true

Veri kapsamasÄ± dÃ¼ÅŸÃ¼k (<minCoverage): risk uyarÄ±sÄ±; skor tavanÄ±nÄ± 0.75 ile sÄ±nÄ±rla

Ã‡akÄ±ÅŸan hedefler: slip â†“ ama latency â†‘; pareto seÃ§iminde dengeli Ã¶neriler Ã¶ne Ã§Ä±kar

Zaman bÃ¼tÃ§esi aÅŸÄ±mÄ±: maxMs yaklaÅŸÄ±nca kalan kombolarÄ± erken kes; raporda iÅŸaretle

SLO breach ihtimali: bootstrap %5 Ã¼st quantile kÄ±sÄ±tÄ± aÅŸÄ±yorsa senaryo diskalifiye

Tek-senaryo mod: yalnÄ±z policy.patch.proposed.delta varsa o senaryo simÃ¼le edilir ve raporlanÄ±r

RBAC: observer iÃ§in yalnÄ±z Ã¶zet skorlar; PnL sayÄ±larÄ± yuvarlanÄ±r/gizlenir

PII ÅŸÃ¼phesi: rapor redaksiyonda baÅŸarÄ±sÄ±z â†’ scenario.alert("error","redaction_failed"); yayÄ±n durur

9) Telemetri
{
  "scenario.metrics": {
    "event":"scenario.metrics",
    "timestamp":"iso8601",
    "combos":72,"pareto":6,"avgSimMs":3.8,"p95SimMs":9.6,
    "downsampled":true,"coverage":0.91,
    "violations":{"slo":0,"pnlMin":2},
    "dominancePruned":18,
    "highlights":["timeBudgetOk","bootstrapCI<=95p","zeroPiiLeak"]
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/riskScenarioSimulator.ts         # FSM + orchestrator
services/livia/lib/sim/collectors.ts            # veri toplayÄ±cÄ±lar
services/livia/lib/sim/calibrate.ts             # ground truth & elastisite Ã¶lÃ§ekleme
services/livia/lib/sim/grid.ts                  # grid & downsample
services/livia/lib/sim/engine.ts                # reweight + bootstrap + combine
services/livia/lib/sim/pareto.ts                # kÄ±sÄ±t & dominance & skor
services/livia/lib/sim/report.ts                # md/html raporlayÄ±cÄ± (inline SVG)
services/livia/lib/redact.ts                    # LIVIA-21 kÃ¶prÃ¼sÃ¼
services/livia/state/simStore.ts                # idem index + cache
services/livia/__tests__/riskScenarioSimulator.test.ts
cfg/livia.sim.yaml                              # models/objectives/constraints/budgets

11) Test Ä°skeleti (Jest/Vitest)

Grid downsample: 300â†’maxCombos=120 ve latinHypercube Ã§alÄ±ÅŸtÄ±

SLO kÄ±sÄ±tÄ±: latency +%0 sÄ±nÄ±rÄ±nda olan senaryolar diskalifiye

Pareto: dominans testi ve epsilon toleransÄ± doÄŸru

Tek senaryo: policy.patch.proposed ile yalnÄ±z S-001 hesaplanÄ±r

Idempotency: aynÄ± simKey ikinci kez yazÄ±lmaz

Budget/Timeout: maxMs altÄ±nda tamamlanÄ±r; erken kesme iÅŸareti raporda

RBAC/Observer: PnL rakamlarÄ± yuvarlandÄ±/gizlendi

Redaction: rapor PII denetimini geÃ§ti; baÅŸarÄ±sÄ±z olursa alert

Determinism: seed deÄŸiÅŸmediÄŸinde sonuÃ§ IDâ€™leri/sÄ±ralamasÄ± sabit

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

18:40 scenario.request(scope=symbol:AVAXUSDT, grid=5Ã—3Ã—2Ã—2Ã—2) â†’ COLLECT

SIMULATE: 72 kombo, p95 10ms altÄ±nda; 6 pareto kaldÄ±

REPORT: report.md yazÄ±ldÄ±, scenario.sim.ready + scenario.card emit

LIVIA-23 bu sonuÃ§tan policy.patch.proposed gÃ¼nceller; LIVIA-22 cardâ€™Ä± daÄŸÄ±tÄ±r; LIVIA-24 raporu KBâ€™ye iÅŸler

13) SLO

p95 simÃ¼lasyon (â‰¤100 kombo) < 250 ms

zeroPiiLeak = true (redaksiyon zorunlu)

pareto doÄŸruluÄŸu â‰¥ %99 (dominance testleri)

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-26 Â· ethicsAndComplianceGate.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Ä°ÅŸlem/karar/ileti iÃ§eren tÃ¼m kritik eylemleri etik & uyum kurallarÄ±na gÃ¶re Ã¶n denetime tabi tutmak; riskli/uygunsuz durumlarda otomatik blok/slowdown/halt uygulamak, gerekirse onay kapÄ±sÄ± (LIVIA-05) Ã¼zerinden override sÃ¼reci yÃ¼rÃ¼tmek; kararlarÄ± deÄŸiÅŸtirilemez (tamper-evident) biÃ§imde kaydetmek; PII iÃ§eriÄŸi LIVIA-21 ile redakte ederek LIVIA-22 Ã¼zerinden kart/uyarÄ± daÄŸÄ±tmak; bilgi tabanÄ±na (LIVIA-24) yalnÄ±z metadata indekslemek.
Standart: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Runtime: Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT doÄŸrulama, RBAC: compliance|policy|ops

Gizlilik: PII yok; serbest metinler LIVIA-21 ile redakte edilir

Ä°dempotency: ethicsKey = actionId|eventHash + ruleSetVersion + scope + symbol?

GÃ¶zlemlenebilirlik: OpenTelemetry spans (ethics.evaluate, ethics.block, ethics.override) + metrics

Uygunluk kapsamÄ±: KYC/AML, yaptÄ±rÄ±m listeleri (OFAC vb.), coÄŸrafi kÄ±sÄ±tlar, blackout pencereleri, restricted symbols, kaldÄ±raÃ§ sÄ±nÄ±rlarÄ±, market abuse paterni (spoofing/layering/wash trade), Ã§Ä±kar Ã§atÄ±ÅŸmasÄ± (insider), data residency, veri saklama/WORM.

2) Girdiler (In) â€” Zodâ€™a Ã§evrilecek ÅŸema Ã¶rnekleri
{
  "action.intent": {
    "event":"action.intent",
    "timestamp":"iso8601",
    "actionId":"act-2025-09-13-42",
    "kind":"order.place|order.cancel|policy.change|data.export|note.publish",
    "scope":"global|desk|symbol",
    "symbol":"AVAXUSDT|null",
    "payload":{"side":"buy","qty":120,"variant":"aggressive","leverage":3},
    "actor":{"operatorId":"op-007","role":"ops"},
    "origin":{"ip":"203.0.113.10","geo":"DE","tz":"Europe/Berlin"}
  },

  "kyc.status": {
    "event":"kyc.status","timestamp":"iso8601",
    "operatorId":"op-007","level":"passed|pending|failed","pep":false
  },

  "aml.hit": {
    "event":"aml.hit","timestamp":"iso8601",
    "kind":"sanctions|pep|adverse_media",
    "list":"OFAC","entity":"John D.","confidence":0.92
  },

  "geoip.update": {
    "event":"geoip.update","timestamp":"iso8601",
    "operatorId":"op-007","ip":"203.0.113.10","country":"DE","vpn_suspected":true
  },

  "market.pattern.detected": {
    "event":"market.pattern.detected","timestamp":"iso8601",
    "pattern":"spoofing|layering|wash_trade",
    "symbol":"AVAXUSDT","severity":"medium|high",
    "windowSec":120,"evidenceRef":"state/patterns/..."
  },

  "blacklist.update": {
    "event":"blacklist.update","timestamp":"iso8601",
    "restrictedSymbols":["XYZUSDT"],"blackoutWindows":[{"from":"22:00","to":"07:00"}]
  },

  "policy.change.request": {
    "event":"policy.change.request","timestamp":"iso8601",
    "change":{"limits.positionLimitFactor":0.5},
    "requestedBy":"ops|policy","rationale":"risk dÃ¼ÅŸÃ¼rme"
  },

  "consent.log": {
    "event":"consent.log","timestamp":"iso8601",
    "operatorId":"op-007","purpose":"data.export","granted":true,"ttlMin":60
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "ethics.gate.proposed": {
    "event":"ethics.gate.proposed","timestamp":"iso8601",
    "ethicsKey":"sha256:...","actionId":"act-2025-09-13-42",
    "decision":"allow|allow_with_limits|block|halt|needs_approval",
    "reasonCodes":["geo_restricted","vpn_suspected","blackout_window"],
    "enforcement":{"rateLimitPerMin":1,"positionLimitFactor":0.5,"blockVariants":["aggressive"]},
    "audit":{"ruleSetVersion":"v7","producedBy":"LIVIA-26"}
  },

  "ethics.gate.activated": {
    "event":"ethics.gate.activated","timestamp":"iso8601",
    "ethicsKey":"sha256:...","decision":"block|halt|allow_with_limits",
    "effectiveFrom":"iso8601","effectiveUntil":"iso8601","hash":"sha256:..."
  },

  "ethics.blocked.action": {
    "event":"ethics.blocked.action","timestamp":"iso8601",
    "actionId":"act-2025-09-13-42","reasonCodes":["sanctions_hit|market_abuse|blackout"],
    "notify":["compliance","policy"]
  },

  "ethics.override.request": {
    "event":"ethics.override.request","timestamp":"iso8601",
    "ethicsKey":"sha256:...","requestedBy":"policy|compliance",
    "scope":"desk|symbol","ttlMin":30,"rationale":"operasyonel zorunluluk"
  },

  "ethics.decision.card": {
    "event":"ethics.decision.card","timestamp":"iso8601",
    "title":"Etik/Uyum KararÄ± â€” {decision}",
    "body":"Nedenler: geo+vpn â€¢ {symbol} iÃ§in aggressive kapalÄ±, posLimit Ã—0.5 â€¢ TTL 30dk.",
    "severity":"warn|error|info","ttlSec":600
  },

  "ethics.alert": {
    "event":"ethics.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|rbac_denied|sanctions_provider_down|worm_failure|hash_chain_break",
    "context":{"actionId":"act-..."}
  },

  "ethics.metrics": {
    "event":"ethics.metrics","timestamp":"iso8601",
    "evaluated":12,"blocked":2,"halted":1,"needsApproval":1,"allowedWithLimits":3,
    "avgEvalMs":9.2,"sanctionsChecks":12,"geoMismatches":2,"marketAbuseFlags":1
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  rules: {
    // deterministik kural Ã¶rnekleri
    geoRestrictedCountries: ["US","IR","KP","SY","CU","RU"],
    requireKycLevel: "passed",
    vpnBlocked: true,
    blackoutWindows: ["22:00-07:00"],        // yerel saat
    restrictedSymbols: ["XYZUSDT"],          // iÅŸlem yasak
    leverageCapsByJurisdiction: { "DE": 2, "TR": 5, "US": 0 },
    marketAbusePatterns: ["spoofing","layering","wash_trade"],
    dataExportRequiresConsent: true
  },

  sanctions: {
    providers: ["ofac","un","uk_hmt"],       // adapter isimleri
    timeoutMs: 1200, cacheTtlSec: 3600, failClosed: true
  },

  enforcement: {
    onSanctionsHit: "halt",
    onGeoRestricted: "block",
    onVpnSuspected: "allow_with_limits",
    onBlackout: "block",
    onAbusePatternHigh: "halt",
    defaultRateLimitPerMin: 5,
    defaultPositionLimitFactor: 0.7
  },

  approvals: {
    overrideGateway: "LIVIA-05",
    requireForDecisions: ["allow_with_limits>30min","override_geo_restriction","override_blackout"]
  },

  storage: {
    wormDir: "state/ethics/worm/{YYYY-MM-DD}", // WORM benzeri dosya
    hashChainFile: "chain.log"                 // satÄ±r satÄ±r sha256(prev+entry)
  },

  redactionProfile: "generic",                // LIVIA-21
  distroChannels: ["ui","slack"],             // LIVIA-22

  schedule: { sweepEvery:"1m" },

  idempotencyTtlSec: 3600
}

5) Karar Matrisi (Ã¶zet)

Sanctions/AML hit (confidenceâ‰¥0.9) â†’ halt (global), override yok

Geo âˆˆ geoRestrictedCountries â†’ block (symbol/desk), override yalnÄ±z compliance ile

VPN suspected = true â†’ allow_with_limits (rateLimit=1/min, posLimitÃ—0.5, aggressive kapalÄ±)

Blackout window â†’ block (UIâ€™ya card)

Market abuse (severity=high) â†’ halt + evidenceRef; LIVIA-17 ile gate uyumlu

Leverage > cap(jurisdiction) â†’ allow_with_limits veya block (policy)

Data export & no consent â†’ needs_approval (policy/compliance)

6) Pipeline (Kompozisyon)

Normalize & Validate: TÃ¼m giriÅŸ olaylarÄ±nÄ± Zod .strict() ile doÄŸrula.

Context Build: actor, geoip, kyc/aml cache, blacklist/blackout, leverage cap, pattern iÅŸaretleri.

Sanctions & KYC/AML Check: provider adapterâ€™larÄ± (fail-closed) â†’ karar Ã¶nkoÅŸullarÄ±.

Rule Evaluation: deterministik kurallar + eÅŸikler â†’ decision, reasonCodes, enforcement.

Idempotency: ethicsKey ile aynÄ± actionâ€™a ikinci karar yok; mevcutsa merge et (daha sÄ±kÄ± karar Ã¼stÃ¼n).

Enforcement: block/halt/allow_with_limits â†’ LIVIA-17/16 ile Ã§eliÅŸkisiz kÄ±sÄ±t; policy.change.request ise LIVIA-23â€™e sinyal.

Redaction & Card: karar Ã¶zeti LIVIA-21 ile redakte â†’ ethics.decision.card; LIVIA-22 ile daÄŸÄ±t.

WORM Audit: karar kaydÄ± wormDir/hashChainFile iÃ§ine hash-chain ile append.

Emit: ethics.gate.(proposed|activated|blocked.action) + ethics.metrics (+ gerekirse ethics.override.request).

Hash-chain formÃ¼lÃ¼: H_n = sha256(H_{n-1} || ts || ethicsKey || decision || reasonCodes || actorHash); H_0 = 32Ã—0.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ action.intent|policy.change.request â†’ EVALUATE

EVALUATE â†’ ENFORCE (sanctions/geo/blackout/abuse/leverage/consent)

ENFORCE â†’ karar emit + WORM append â†’ IDLE

OVERRIDE_WAIT (gerekirse) â†’ approval.granted â†’ ACTIVATE_OVERRIDE | rejected â†’ IDLE

Hata â†’ IDLE + ethics.alert(...)

8) Kenar Durumlar

Sanctions provider down: failClosed:true ise block/halt; alert gÃ¶nder.

Clock skew / TZ farkÄ±: blackout pencereleri yerelde hesaplanÄ±r.

VPN ÅŸÃ¼phesi + coÄŸrafi Ã§akÄ±ÅŸma: en sert karar (block) uygulanÄ±r.

WORM yazÄ±m hatasÄ±: worm_failure â†’ karar uygulanÄ±r ama sistem error alert basar; ops mÃ¼dahalesi istenir.

Hash chain kÄ±rÄ±ÄŸÄ±: zincir bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ bozulursa hash_chain_break alert ve read-only moda geÃ§.

Observer rolÃ¼: kartlarda yalnÄ±z Ã¶zet; ayrÄ±ntÄ±/PII, symbol gizlenir.

Legal Hold: policy sinyali ile karar kayÄ±tlarÄ± geÃ§ici dondurulur (yalnÄ±z append).

9) Telemetri
{
  "ethics.metrics": {
    "event":"ethics.metrics","timestamp":"iso8601",
    "evaluated":12,"blocked":2,"halted":1,"needsApproval":1,"allowedWithLimits":3,
    "avgEvalMs":9.2,"sanctionsChecks":12,"geoMismatches":2,"marketAbuseFlags":1,
    "wormAppendFailures":0,"hashChainAlerts":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/ethicsAndComplianceGate.ts     # FSM + evaluator + enforcer
services/livia/lib/ethics/rules.ts            # deterministik kurallar
services/livia/lib/ethics/providers/sanctions.ts  # OFAC/UN/HMT adapter
services/livia/lib/ethics/geo.ts              # geoip/blackout/leverage caps
services/livia/lib/ethics/patterns.ts         # market abuse kanÄ±tlarÄ±
services/livia/lib/ethics/worm.ts             # WORM & hash-chain append
services/livia/lib/redact.ts                  # LIVIA-21 kÃ¶prÃ¼sÃ¼
services/livia/lib/approvalBridge.ts          # LIVIA-05 override
services/livia/state/ethicsStore.ts           # idem index + cache
services/livia/__tests__/ethicsAndComplianceGate.test.ts
cfg/livia.ethics.yaml                         # rules/sanctions/enforcement/approvals/storage

11) Test Ä°skeleti (Jest/Vitest)

Sanctions hit (0.92): halt + override reddi; WORM append + hash gÃ¼ncellendi

Geo=US & vpn_suspected: block (geo) + card; vpn gerekÃ§esi listede

Blackout 22:30: block; observerâ€™a Ã¶zet kart, ops/policyâ€™e detay

Leverage cap (DE=2) ve istek 3: allow_with_limits (posLimitÃ—0.5, rate 1/min)

Market abuse=high: halt + evidenceRef; LIVIA-17 ile Ã§akÄ±ÅŸma yok

Consent yok & data.export: needs_approval â†’ granted â†’ activate_override

WORM/Hash-chain: ardÄ±ÅŸÄ±k iki kararÄ±n hash zinciri doÄŸrulamasÄ±

Provider down: failClosed:true â†’ block; alert sanctions_provider_down

Idempotency: aynÄ± actionId ile ikinci deÄŸerlendirme yazmaz; merge sÄ±kÄ±lÄ±r

RBAC/Auth: imza/rol hatasÄ± â†’ rbac_denied

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

21:58 action.intent(order.place, aggressive, leverage=3, geo=DE, vpn_suspected=true)

EVALUATE: KYC passed, sanctions clear; leverage>cap(DE=2) + vpn_suspected â†’ allow_with_limits (rate 1/min, posLimitÃ—0.5, aggressive kapalÄ±)

ENFORCE: ethics.gate.activated + ethics.decision.card (redakte) â†’ LIVIA-22 daÄŸÄ±ttÄ±; audit WORMâ€™a eklendi.

22:10 blackout baÅŸlar â†’ yeni istek block.

22:12 policy.change.request(limits.factor=0.5) â†’ Kuralca allow (policy rolÃ¼) â†’ WORM kayÄ±tlandÄ±.

13) SLO

p95 evaluate < 15 ms

sanctions fail-closed uygulanma oranÄ± = %100

hash-chain bÃ¼tÃ¼nlÃ¼k ihlali = 0

idempotent Ã§akÄ±ÅŸma â‰ˆ 0; WORM append baÅŸarÄ±sÄ± â‰¥ %99.9
______________________________________________________________________________________________
LIVIA 14â€“26 â€” Tek Sayfa Sistem HaritasÄ± (BaÄŸÄ±mlÄ±lÄ±k GrafiÄŸi + Olay SÃ¶zlÃ¼ÄŸÃ¼)
Mimari Katmanlar (Ã¶zet)

Sahadan Gelen Sinyaller: telemetry.slo.status, guard.activity.rollup, telemetry.anomaly.signal, dialog.metrics, approval.metrics, pnl.*, incident.*, notes.session.md

Savunma / MÃ¼dahale: L16 Cooldown, L17 Reactive Gate, L26 Ethics&Compliance

Toparlanma / NormalleÅŸme: L19 Recovery Monitor â†’ L18 Anchor Reset â†’ L20 Fatigue Sentinel

Politika & SimÃ¼lasyon: L23 Policy Orchestrator â†” L25 Risk Scenario Simulator

Ã‡Ä±ktÄ± & Bilgi: L14 Daily Digest, L15 Postmortem, L21 PII Redactor, L22 Distributor, L24 Knowledge Bridge

Ortak Standartlar: Event-driven JSON, Zod .strict(), TZ=Europe/Istanbul, ISO-8601, RBAC(HMAC/JWT), idempotency, OpenTelemetry.

UÃ§tan Uca AkÄ±ÅŸ (tek bakÄ±ÅŸ)

Saha olaylarÄ± akar â†’

L17 tetikler (anlÄ±k savunma) ve/veya L16 (davranÄ±ÅŸsal cooldown) â†’

Kartlar L21 (redact) â†’ L22 (daÄŸÄ±t) â†’

Savunma bitimi L19 toparlanma endeksi Ã¼retir â†’ L18 kademeli normalleÅŸme uygular â†’

GÃ¼n sonu L14 digest, olay sonrasÄ± L15 postmortem yazar â†’ L22 daÄŸÄ±tÄ±r, L24 indeksler â†’

GÃ¶zlemler + postmortem â†’ L23 politika yamasÄ± Ã¶nerir; gerekirse L25â€™te â€œwhat-ifâ€ simÃ¼le eder; kanarya â†’ yayÄ±n/rollback â†’ L22 daÄŸÄ±tÄ±m, L24 indeks.

TÃ¼m kritik eylemler L26 etik/uyum kapÄ±sÄ±ndan geÃ§er (block/limit/halt/override).

BaÄŸÄ±mlÄ±lÄ±k GrafiÄŸi (kompakt)
[Saha Sinyalleri]
   â”‚
   â”œâ”€â–¶ L17 reactiveDefenseGate â”€â”
   â”‚                             â”œâ”€â–¶ (cards) â”€â–¶ L21 redact â”€â–¶ L22 dist
   â”œâ”€â–¶ L16 empathyCooldown â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€â–¶ L19 emotionalRecoveryMonitor â”€â”€â”¬â”€â–¶ recovery.ready â”€â–¶ L18 anchorReset
   â”‚                                   â””â”€â–¶ hold â†’ L16 cooldown.extend.suggest
   â”‚
   â”œâ”€â–¶ L14 telemetryDailyDigest â”€â”€â”
   â”œâ”€â–¶ L15 incidentPostmortem â”€â”€â”€â”€â”¼â”€â–¶ L21 redact â”€â–¶ L22 dist â”€â–¶ L24 knowledge index
   â”‚                               â””â”€â–¶ L24 knowledge index (metadata/sections)
   â”‚
   â”œâ”€â–¶ L23 policyUpdateOrchestrator â”€â”€â”¬â”€â–¶ L05 approval â”€â–¶ rollout(canary/full)
   â”‚                                   â””â”€â–¶ L25 riskScenarioSimulator (what-if)
   â”‚
   â””â”€â–¶ TÃ¼m kritik eylemler â†’ L26 ethicsAndComplianceGate

Olay SÃ¶zlÃ¼ÄŸÃ¼ (Ã§ekirdek 30+ olay â€” Ã¼retici/ tÃ¼ketici, kÄ±sa not)

telemetry.slo.status â€” src: saha â†’ cons: L14, L19, L23

guard.activity.rollup â€” src: saha â†’ cons: L14, L23

telemetry.anomaly.signal â€” src: saha â†’ cons: L14, L23

dialog.metrics â€” src: diyalog servisi â†’ cons: L14, L19, L20

approval.metrics â€” src: onay kapÄ±sÄ± â†’ cons: L14

pnl.daily / pnl.window / pnl.history.ref â€” src: PnL â†’ cons: L14, L18, L19, L20, L25

incident.started / incident.closed â€” src: olay yÃ¶n. â†’ cons: L14, L15, L18

notes.session.md â€” src: notlayÄ±cÄ± â†’ cons: L14, L24

digest.daily.ready / digest.card / digest.metrics / digest.alert â€” src: L14 â†’ cons: L21, L22, L24

postmortem.ready â€” src: L15 â†’ cons: L21, L22, L24, L23

cooldown.plan.(proposed|activated|expired|alert|metrics) â€” src: L16 â†’ cons: L18, L22

defense.gate.(proposed|activated|expired|alert|metrics) â€” src: L17 â†’ cons: L18, L22

recovery.score.updated / recovery.(ready|hold) / cooldown.extend.suggest â€” src: L19 â†’ cons: L18, L16, L22

anchor.reset.(proposed|activated|alert|metrics) â€” src: L18 â†’ cons: L22

fatigue.score.updated / fatigue.break.proposed / cooldown.plan.proposed â€” src: L20 â†’ cons: L16, L22

redact.request / redact.ready / redact.alert / redact.metrics â€” src: L21 (kÃ¼tÃ¼phane/servis) â†’ cons: L14â€“15â€“22â€“24â€“23â€“25â€“26

dist.(queued|sent|acked|failed|dlq|metrics) â€” src: L22

policy.(patch.proposed|diff.ready|approval.request|canary.*|version.published|rollback|metrics) â€” src: L23 â†’ cons: L05, L22, L24

scenario.(sim.ready|top.pareto|card|metrics|alert) â€” src: L25 â†’ cons: L23, L22, L24

knowledge.(ingest.ready|indexed|answer.ready|card|metrics|alert) â€” src: L24 â†’ cons: L22

ethics.(gate.proposed|activated|blocked.action|override.request|decision.card|metrics|alert) â€” src: L26 â†’ cons: L22, L05

Not: TÃ¼m metin iÃ§erikleri kanal Ã§Ä±kÄ±ÅŸÄ±ndan Ã¶nce L21 redaksiyonundan geÃ§er; observer kitlesinde kapsam daraltÄ±lÄ±r.

PaylaÅŸÄ±lan SÃ¶zleÅŸmeler (kÄ±sa kÄ±lavuz)

Zaman/Pencere: Yerel gÃ¼n 00:00â€“23:59:59, ISO-8601, TZ=Europe/Istanbul.

Ä°dempotency AnahtarlarÄ± (Ã¶rnekler):

L14: digestKey = {YYYY-MM-DD}+scope+format

L16: cooldownKey = scope+symbol+reason+windowStartISO

L17: gateKey = scope+symbol+trigger+startedAtISO

L18: anchorKey = scope+symbol+stage+forDate

L19: recoveryKey = scope+symbol+windowStartISO+windowMin

L21: redactKey = contentHash+profileId+mode+forDate

L22: deliveryKey = sha256(contentCanonical+audience+channel+forDate)

L23: policyKey = baseVersion+scope+symbol+changeHash

L24: docKey / queryKey (sha256 temelli)

L25: simKey = baseVersion+scope+symbol+gridHash+dataWindow+seed

L26: ethicsKey = actionId|eventHash+ruleSetVersion+scope+symbol

RBAC & GÃ¼venlik: HMAC/JWT; roller: ops|policy|observer|compliance. YazÄ±m yetkisi modÃ¼l bazÄ±nda dar.

PII & Redaksiyon: L21 zorunlu kapÄ±dÄ±r; operatÃ¶r takma adlarÄ± gÃ¼nlÃ¼k saltâ€™lÄ± hash.

Observability: TÃ¼m modÃ¼ller OpenTelemetry span/metric Ã¼retir; *.metrics olaylarÄ± digestâ€™e girer.

SLOâ€™lar (modÃ¼l baÅŸÄ±na en kritik)

L14 compose p95 < 100 ms, idempotent Ã§akÄ±ÅŸma â‰ˆ 0

L16 karar p95 < 50 ms; L17 < 40 ms; L18 < 50 ms; L19 < 10 ms

L20 eval p95 < 10 ms; L21 detect+mask p95 < 15 ms/64KB

L22 render+send p95 < 350 ms; DLQ < %0.5/gÃ¼n

L23 collect+propose p95 < 80 ms; rollback MTTR â‰¤ 30 s

L24 ingest p95 < 80 ms; query p95 < 120 ms

L25 â‰¤100 kombo simâ€™de p95 < 250 ms

L26 evaluate p95 < 15 ms; WORM append â‰¥ %99.9 baÅŸarÄ±

Konfig DosyalarÄ± (Ã¶nerilen)
cfg/livia.digest.yaml       # L14
cfg/livia.postmortem.yaml   # L15
cfg/livia.cooldown.yaml     # L16
cfg/livia.defense-gate.yaml # L17
cfg/livia.anchor.yaml       # L18
cfg/livia.recovery.yaml     # L19
cfg/livia.fatigue.yaml      # L20
cfg/livia.redact.yaml       # L21
cfg/livia.dist.yaml         # L22
cfg/livia.policy.yaml       # L23
cfg/livia.knowledge.yaml    # L24
cfg/livia.sim.yaml          # L25
cfg/livia.ethics.yaml       # L26

â€œSÄ±cak Yolâ€ Senaryosu (tek satÄ±rda)

Anomali + guard slowdown â†’ L17 gate (kÄ±sa) & L16 cooldown (orta) â†’ kart L21â†’L22; gate/cooldown biter â†’ L19 ready â‰¥0.70 â†’ L18 ramp-up; gÃ¼n sonu L14 digest & olay iÃ§in L15 postmortem â†’ L21â†’L22, L24 KB; bulgular L23 ile patch Ã¶nerisi, L25 simÃ¼lasyon â†’ canary â†’ publish/rollback; tÃ¼m adÄ±mlar L26 etik/uyum kapÄ±sÄ±ndan geÃ§er.

Ä°stersen bunu PDF/MD tek sayfa poster formatÄ±na da dÃ¶kebilirim (baÅŸlÄ±klar + ASCII diyagram + tablo).
______________________________________________________________________________________________
harika â€” LIVIA henÃ¼z tam kapanmamÄ±ÅŸtÄ±: L14 ve L17â€“26 hazÄ±r; eksik kalan LIVIA-15 ve LIVIA-16â€™yÄ± da ÅŸimdi aynÄ± kalite (+Hardening) ile bÄ±rakÄ±yorum. Bunlarla birlikte 14â€“26 hattÄ± tamamlanmÄ±ÅŸ oluyor. (Ä°stersen mesajÄ±n sonunda birkaÃ§ â€œekstraâ€ fikir de sÄ±raladÄ±m; ÅŸimdi kopyala-yapÄ±ÅŸtÄ±r yapÄ±p diÄŸer AIâ€™ye verebilirsin.)

LIVIA-15 Â· incidentPostmortemWriter.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Her incident iÃ§in otomatik postmortem Ã¼ret: zaman Ã§izelgesi, kÃ¶k neden (5 Whys), etki/etkilenim, tespit/Ã§Ã¶zÃ¼m, kalÄ±cÄ± Ã¶nlemler, aksiyon maddeleri (sahip & tarih), metrik Ã¶zetleri ve ekler. Ã‡Ä±ktÄ± Markdown + HTML, dosyaya yaz, UIâ€™ya card gÃ¶nder, LIVIA-24 ile KBâ€™ye indeksle, LIVIA-22 ile daÄŸÄ±t, tÃ¼m metni Ã¶nce LIVIA-21 ile PII redakte et. I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601, TZ=Europe/Istanbul

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy yazar/okur, observer okur (daraltÄ±lmÄ±ÅŸ gÃ¶rÃ¼nÃ¼m)

Gizlilik: PII yok; operatÃ¶r/taraf isimleri gÃ¼nlÃ¼k saltâ€™lÄ± hash (L21)

Ä°dempotency: postmortemKey = incidentId + version (semver: v1, v1.1â€¦)

Observability: pm.collect, pm.compose, pm.write spans; postmortem.metrics event

2) Girdiler (In) â€” Zod .strict() ÅŸemalar
{
  "incident.started": {
    "event":"incident.started","timestamp":"iso8601",
    "id":"inc-2025-09-13-1","severity":"low|medium|high|critical",
    "title":"Slip spike on SG02","owner":"op-007|null"
  },
  "incident.updated": {
    "event":"incident.updated","timestamp":"iso8601",
    "id":"inc-2025-09-13-1","note":"policy rollback denendi","label":"mitigation|diagnosis|comm"
  },
  "incident.closed": {
    "event":"incident.closed","timestamp":"iso8601",
    "id":"inc-2025-09-13-1","resolution":"policy rollback v42â†’v41","durationMin":37
  },

  "timeline.event": {
    "event":"timeline.event","timestamp":"iso8601",
    "incidentId":"inc-2025-09-13-1","kind":"detect|page|mitigate|verify|comm|restore",
    "text":"SG02 feed gap tespit edildi","by":"op-007|null","ref":"runbook://...|commit:abc123"
  },

  "guard.escalation": {
    "event":"guard.escalation","timestamp":"iso8601",
    "from":"normal|degraded|slowdown","to":"slowdown|block_aggressive|halt_entry",
    "reason":"slip|latency|spread|feed_gap","symbol":"AVAXUSDT|null"
  },

  "telemetry.slo.status": {
    "event":"telemetry.slo.status","timestamp":"iso8601",
    "slo":"answer_latency_p95|guard_success_rate|uptime_feed",
    "state":"ok|at_risk|breach","window":"5m|1h|24h","burnPct":8.1
  },

  "pnl.window": {
    "event":"pnl.window","timestamp":"iso8601",
    "windowMin":240,"netUSD":-1200.0,"rrMedian":0.88
  },

  "notes.session.md": {
    "event":"notes.session.md","timestamp":"iso8601",
    "path":"data/notes/2025-09-13/sess-avax-42.md",
    "summary":"AVAX: rollback Ã¶nerisi, guard window dar bulundu..."
  },

  "action.item.proposed": {
    "event":"action.item.proposed","timestamp":"iso8601",
    "incidentId":"inc-2025-09-13-1",
    "title":"Guard window geniÅŸlet","owner":"policy-lead","dueDate":"2025-09-20","severity":"high"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "postmortem.ready": {
    "event":"postmortem.ready","timestamp":"iso8601",
    "incidentId":"inc-2025-09-13-1","format":"md|html",
    "path":"data/postmortem/2025-09-13/inc-2025-09-13-1.md",
    "summary":"Slip spike â€” 37dk; kÃ¶k: latency+feed gap; Ã§Ã¶zÃ¼m: rollback v42â†’v41; etki: -$1.2k.",
    "sections":["Ã–zet","Zaman Ã‡izelgesi","KÃ¶k Neden","Etki","Tespit","Ã‡Ã¶zÃ¼m","Ã–nlemler","Aksiyonlar","Metrikler","Ekler"],
    "hash":"sha256:...","version":"v1.0.0"
  },

  "postmortem.card": {
    "event":"postmortem.card","timestamp":"iso8601",
    "title":"Postmortem HazÄ±r â€” inc-2025-09-13-1",
    "body":"37dk â€¢ KÃ¶k: latency+feed â€¢ Ã‡Ã¶zÃ¼m: rollback v42â†’v41 â€¢ Etki: -$1.2k.",
    "severity":"info","ttlSec":600
  },

  "postmortem.alert": {
    "event":"postmortem.alert","timestamp":"iso8601",
    "level":"info|warn|error","message":"missing_data|write_failed|idem_duplicate|oversize",
    "context":{"incidentId":"inc-2025-09-13-1"}
  },

  "postmortem.metrics": {
    "event":"postmortem.metrics","timestamp":"iso8601",
    "generated":1,"avgComposeMs":62,"mdBytes":7800,"htmlBytes":15400,
    "missingSections":["PnL:false","Timeline:false"],"charts":3
  }
}

4) Konfig
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul", currency:"USD" },

  template:{
    mdHeader:"# Postmortem â€” {incidentId}",
    html:{ embedMiniCSS:true, chartsInlineSvg:true }
  },

  include:{
    sections:["Summary","Timeline","RootCause","Impact","Detection","Mitigation","Preventive","Actions","Metrics","Appendix"],
    charts:{ slo:true, guard:true, pnl:true }
  },

  rules:{
    rootCause:["5whys","fishbone"],             // yÃ¶ntem
    actionOwnerRequired:true,
    dueDateMaxDays:14
  },

  output:{
    dir:"data/postmortem/{YYYY-MM-DD}",
    fileMd:"{incidentId}.md", fileHtml:"{incidentId}.html",
    splitAppendixOverBytes: 100_000
  },

  redact:{ profile:"postmortem" },

  idempotencyTtlSec: 604800
}

5) Ä°Ã§erik TaslaÄŸÄ± (Markdown/HTML)

BaÅŸlÄ±k & Ã–zet: sÃ¼re, kÃ¶k neden, Ã§Ã¶zÃ¼m, etki (USD), etkilenen semboller/dizgeler

Zaman Ã‡izelgesi: timestamp â€” kind â€” text â€” by â€” ref

KÃ¶k Neden (5 Whys): kÄ±sa anlatÄ± + â€œkanÄ±tâ€ referanslarÄ±

Etki: PnL, kullanÄ±cÄ±/operasyon etkisi, SLO yanÄ±klarÄ±

Tespit / Ã‡Ã¶zÃ¼m: neyin uyardÄ±ÄŸÄ±, uygulanmÄ±ÅŸ mitigations

Ã–nleyici Ã–nlemler: politika/guard deÄŸiÅŸimleri (L23 linkleri)

Aksiyonlar: tablo (title, owner, due, severity, status)

Metrikler: inline SVG sparkline (slo/guard/pnl)

Ekler: notlar, commit/PR, grafikler (Appendix.md/html)

6) Pipeline

Collect: incident & timeline & slo & guard & pnl & notes & actions

Normalize/Validate (Zod .strict())

Compose: bÃ¶lÃ¼mler; 5 Whys; sparkline SVG; section topN sÄ±nÄ±rlamalarÄ±

Redact: LIVIA-21 profile=postmortem

Write: atomic write; oversize ise Appendixâ€™e bÃ¶l

Emit: postmortem.ready + postmortem.card + postmortem.metrics

7) FSM

IDLE â†’ (incident.closed | postmortem.request) â†’ COLLECT

COLLECT â†’ COMPOSE â†’ WRITE â†’ EMIT â†’ IDLE

Hata: ALERT â†’ IDLE

8) Kenar Durumlar

Kapanmayan incident: â€œ(aÃ§Ä±k)â€ etiketi, sÃ¼re now-started

Eksik PnL/SLO: bÃ¶lÃ¼m otomatik daralÄ±r + postmortem.alert("missing_data")

Ã‡ok bÃ¼yÃ¼k iÃ§erik: Appendixâ€™e bÃ¶l + ana dosyada link

RBAC observer: sembol/PnL yuvarlanÄ±r/gizlenir

9) Telemetri
{"postmortem.metrics":{"generated":1,"avgComposeMs":62,"charts":3,"oversizeSplits":0}}

10) Dosya YapÄ±sÄ±
services/livia/incidentPostmortemWriter.ts
services/livia/lib/pm/whys.ts               # 5 Whys derleyici
services/livia/lib/pm/sparklines.ts         # inline SVG
services/livia/lib/pm/templates.ts          # md/html ÅŸablon
services/livia/lib/redact.ts                # LIVIA-21 kÃ¶prÃ¼sÃ¼
services/livia/state/postmortemStore.ts     # idem index + cache
services/livia/__tests__/incidentPostmortemWriter.test.ts
cfg/livia.postmortem.yaml

11) Test Ä°skeleti

incident.closed â†’ dosyalar yazÄ±ldÄ±, kart geldi

Eksik PnL â†’ alert + bÃ¶lÃ¼m daralmasÄ±

Timeline sÄ±rasÄ± â†’ tsâ€™e gÃ¶re artan

Idempotency: aynÄ± incidentId+version ikinci yazÄ±m yok

Observer gÃ¶rÃ¼nÃ¼mÃ¼ â†’ PnL/symbol gizleme

Oversize â†’ Appendix bÃ¶lme Ã§alÄ±ÅŸtÄ±

12) Ã–rnek AkÄ±ÅŸ

18:12 close â†’ 18:13 compose â†’ 18:14 write â†’ postmortem.ready + card â†’ L22 daÄŸÄ±tÄ±m, L24 indeks.

13) SLO

p95 compose < 80 ms; idempotent Ã§akÄ±ÅŸma â‰ˆ 0; redaksiyon sÄ±zÄ±ntÄ±sÄ± 0

LIVIA-16 Â· empathyCooldownPlanner.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
AÅŸÄ±rÄ± uyarÄ±lma/duygusal dalgalanma/kalite dÃ¼ÅŸÃ¼ÅŸÃ¼ erken fark edildiÄŸinde planlÄ± cooldown baÅŸlatarak sinyal debisini kÄ±s, varyantlarÄ± kapat, pozisyon limitini dÃ¼ÅŸÃ¼r, gerekirse tam durdur. SÃ¼re sonunda otomatik biter; aÄŸÄ±r vakalarda uzatma/yineleme yapar. LIVIA-17 (gate) ile Ã§akÄ±ÅŸmaz: gate anlÄ±k, cooldown davranÄ±ÅŸsal ve daha uzun. I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601, TZ=Europe/Istanbul

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy yazar/okur, observer okur

Gizlilik: PII yok; operatÃ¶r kimlikleri hash (L21)

Ä°dempotency: cooldownKey = scope + symbol? + reasonCode + startedAtISO

Observability: cd.evaluate, cd.schedule, cd.activate, cd.expire spans

2) Girdiler (In)
{
  "recovery.hold": {
    "event":"recovery.hold","timestamp":"iso8601",
    "scope":"global|desk|symbol","symbol":"AVAXUSDT|null",
    "recoveryIndex":0.42,"reasonCodes":["bias_high","pnl_nonpos"]
  },

  "fatigue.score.updated": {
    "event":"fatigue.score.updated","timestamp":"iso8601",
    "scope":"desk","operator":"op#abcd12","windowMin":120,"fatigueScore":0.81
  },

  "guard.activity.rollup": {
    "event":"guard.activity.rollup","timestamp":"iso8601",
    "counts":{"slowdown":12,"block_aggressive":4,"halt_entry":1}
  },

  "telemetry.anomaly.signal": {
    "event":"telemetry.anomaly.signal","timestamp":"iso8601",
    "series":"order.slip.p95|feed.gap|lat.p95","kind":"spike|drift|flatline|gap",
    "severity":"low|medium|high","symbol":"AVAXUSDT|null"
  },

  "pnl.window": {
    "event":"pnl.window","timestamp":"iso8601",
    "windowMin":240,"netUSD":-380.0,"rrMedian":0.92
  },

  "cooldown.override.request": {
    "event":"cooldown.override.request","timestamp":"iso8601",
    "cooldownKey":"...","requestedBy":"policy|ops","rationale":"kritik gerekÃ§e"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "cooldown.plan.proposed": {
    "event":"cooldown.plan.proposed","timestamp":"iso8601",
    "scope":"global|desk|symbol","symbol":"AVAXUSDT|null",
    "reasonCode":"fatigue|bias|anomaly|guard_escalation|pnl_drawdown",
    "policy": { "durationMin": 30, "signalRateMaxPer10m": 1, "blockVariants": ["aggressive"], "positionLimitFactor": 0.7 },
    "ttlSec": 3600,"audit":{"producedBy":"LIVIA-16"}
  },

  "cooldown.plan.activated": {
    "event":"cooldown.plan.activated","timestamp":"iso8601",
    "cooldownKey":"...","effectiveFrom":"iso8601","effectiveUntil":"iso8601",
    "hash":"sha256:...","appliedBy":"auto|approval_gateway"
  },

  "cooldown.extend.suggest": {
    "event":"cooldown.extend.suggest","timestamp":"iso8601",
    "cooldownKey":"...","proposed":{"addMin":15,"tighten":{"positionLimitFactor":0.6}}
  },

  "cooldown.expired": {
    "event":"cooldown.expired","timestamp":"iso8601","cooldownKey":"..."
  },

  "cooldown.card": {
    "event":"cooldown.card","timestamp":"iso8601",
    "title":"Cooldown BaÅŸladÄ± â€” {scope}",
    "body":"{reasonLabel}: {durationMin}dk; 10dkâ€™da max {rate}; blok: {variants}; pozisyon Ã—{factor}.",
    "severity":"warn","ttlSec":600
  },

  "cooldown.alert": {
    "event":"cooldown.alert","timestamp":"iso8601",
    "level":"info|warn|error","message":"idem_duplicate|write_failed|approval_required|merge|expired"
  },

  "cooldown.metrics": {
    "event":"cooldown.metrics","timestamp":"iso8601",
    "proposed":2,"activated":1,"extended":1,"expired":0,
    "avgActiveMin":42,"byReason":{"fatigue":1,"pnl_drawdown":1}
  }
}

4) Konfig
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  thresholds:{
    fatigueHigh: ">=0.80",
    recoveryLow: "<0.55",
    pnlDrawdownUSD: "<=-300",
    guardHaltAny: true,
    anomalyHighCount: ">=1"
  },

  policyMatrix:{
    fatigue:         { durationMin: 30, ratePer10m: 1, block:["aggressive"], factor:0.7 },
    bias:            { durationMin: 45, ratePer10m: 0, block:["aggressive","balanced"], factor:0.6 },
    anomaly:         { durationMin: 20, ratePer10m: 0, block:["aggressive"], factor:0.7 },
    guard_escalation:{ durationMin: 30, ratePer10m: 0, block:["*"], factor:0.6 },
    pnl_drawdown:    { durationMin: 40, ratePer10m: 1, block:["aggressive"], factor:0.7 }
  },

  approval:{ requireFor:["bias","guard_escalation","duration>=45"], gateway:"LIVIA-05" },

  schedule:{ sweepEvery:"1m", maxActivePerScope:3 },

  idempotencyTtlSec: 7200
}

5) Pipeline

Evaluate: L19 (hold), L20 (fatigue), guard/anomaly/PnL sinyallerini skorla â†’ reasonCode

Policy Match: policyMatrix[reason] â†’ plan

Idempotency & Merge: aynÄ± scopeâ€™ta aktif plan varsa merge (sÃ¼re max, rate min, blok birleÅŸim, factor min)

Approval: gerekiyorsa LIVIA-05 â†’ grant sonra activate

Emit: cooldown.plan.(proposed|activated) + cooldown.card + cooldown.metrics

Sweep: sÃ¼re dolunca cooldown.expired; L19â€™a sinyal (quiet window)

Extend: L19 hold Ã¼retirse cooldown.extend.suggest

6) FSM

IDLE â†’ (hold|fatigueHigh|guardEscalation|pnlDrawdown|anomalyHigh) â†’ DRAFT

DRAFT â†’ (approval?) AWAIT | ACTIVATE

AWAIT â†’ approval.granted â†’ ACTIVATE | rejected â†’ IDLE

ACTIVATE â†’ ACTIVE (sweep/extend/expire)

ACTIVE â†’ expired â†’ IDLE

Hata: IDLE + cooldown.alert(...)

7) Kenar Durumlar

Gate ile Ã§akÄ±ÅŸma: L17 aktifken cooldown Ã¼stten uygulanÄ±r; en sÄ±kÄ± kural geÃ§erli

ArdÄ±ÅŸÄ±k uzatma: Ã¼st sÄ±nÄ±r 120 dk; aÅŸÄ±ldÄ±ysa approval_required

RBAC observer: kartta yalnÄ±z Ã¶zet; symbol/limitler gizli

OperatÃ¶r yok: scope=desk/global modlarÄ± Ã§alÄ±ÅŸÄ±r

8) Telemetri
{"cooldown.metrics":{"proposed":2,"activated":1,"extended":1,"avgActiveMin":42}}

9) Dosya YapÄ±sÄ±
services/livia/empathyCooldownPlanner.ts
services/livia/lib/cooldown/policies.ts
services/livia/state/cooldownStore.ts
services/livia/lib/approvalBridge.ts
services/livia/lib/redact.ts
services/livia/__tests__/empathyCooldownPlanner.test.ts
cfg/livia.cooldown.yaml

10) Test Ä°skeleti

Fatigueâ‰¥0.8 â†’ 30dk plan + card

RecoveryIndex<0.55 â†’ bias plan (45dk, approval)

Guard halt â†’ block[*], rate 0, factor 0.6

Merge mantÄ±ÄŸÄ± doÄŸru (sÃ¼re max, rate min, blok birleÅŸim)

Expire â†’ L19 quiet windowâ€™a sayÄ±ldÄ±

Idempotency & RBAC doÄŸrulandÄ±

11) Ã–rnek AkÄ±ÅŸ

14:02 fatigue.score.updated(0.81) â†’ plan 30dk â†’ activated

14:26 recovery.hold â†’ extend.suggest +15dk

15:00 expire â†’ L19 tekrar deÄŸerlendirdi

12) SLO

p95 karar < 50 ms; merge/doÄŸrulama hatasÄ± < %0.5; idempotent Ã§akÄ±ÅŸma â‰ˆ 0

Bonus: Bitirdik â€” Ä°stersen Ek ModÃ¼l Fikirleri (kÄ±sa)

contextAwareMoralLimiter.ts: etik/uyum + duygusal baÄŸlamla â€œiÅŸlem isteÄŸiniâ€ esneten ahlaki fren (nudge + aÃ§Ä±klama).

chaosTelemetryFuzzer.ts: sahte/bozuk telemetri enjeksiyonu ile dayanÄ±klÄ±lÄ±k testleri; L14/L23/L26 izler.

secretsLeakScanner.ts: notlar/diff/raporlarda anahtar/sÄ±r sÄ±zÄ±ntÄ±sÄ± taramasÄ± (L21 ile entegre).

runbookAutoPilot.ts: postmortem aksiyonlarÄ±ndan runbook Ã§Ä±karÄ±p olay anÄ±nda otomatik Ã§alÄ±ÅŸtÄ±rma.
______________________________________________________________________________________________
LIVIA-27 Â· secretsLeakScanner.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
LIVIA ekosistemindeki tÃ¼m metin/diff/rapor/not/policy Ã§Ä±ktÄ±larÄ±nda gizli anahtar/sÄ±r (API key, token, JWT, OAuth secret, cloud creds, private key, .env artÄ±klarÄ± vb.) sÄ±zÄ±ntÄ±larÄ±nÄ± tespit et, maskele ve daÄŸÄ±tÄ±mÄ± engelle/karantinaya al. Otomatik rotasyon Ã¶nerisi, etik/uyum kapÄ±sÄ± (L26) ve daÄŸÄ±tÄ±m (L22) ile entegre Ã§alÄ±ÅŸ. PII redaksiyonu (L21) ile tamamlayÄ±cÄ±dÄ±r (PIIâ‰ Secrets).
Standart: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy|compliance okuyabilir, yazÄ±m sistem

Gizlilik: SÄ±zÄ±ntÄ± iÃ§eriÄŸi maskelenmiÅŸ biÃ§imde loglanÄ±r; ham iÃ§erik asla persist edilmez

Ä°dempotency: secretScanKey = sha256(contentHash)+profileId+forDate

Observability: spans (sec.scan, sec.mask, sec.quarantine) + metrics

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "secret.scan.request": {
    "event":"secret.scan.request",
    "timestamp":"iso8601",
    "profileId":"digest|postmortem|notes|policy|generic",
    "mode":"markdown|html|text|diff",
    "content":"<string|null>",
    "path":"data/.../file.ext|null",
    "source":{"event":"digest.daily.ready|postmortem.ready|dist.request|policy.diff.ready","hash":"sha256:..."},
    "options":{"severity":"auto|low|medium|high","blockOnHigh":true,"classify":true}
  },

  "dist.request": {
    "event":"dist.request","timestamp":"iso8601",
    "contentRef":{"type":"digest|postmortem|notes|card|generic","path":"...","format":"md|html|text"},
    "audience":["ops","policy","observer"],"channels":["ui","slack","webhook"],"priority":"normal","dryRun":false
  },

  "policy.diff.ready": {
    "event":"policy.diff.ready","timestamp":"iso8601",
    "targetVersion":"v41+1-candidate","format":"yaml|jsonpatch","path":"data/policy/diffs/v41_to_v41+1.yaml","summary":"..."
  },

  "notes.daily.ready": {
    "event":"notes.daily.ready","timestamp":"iso8601",
    "forDate":"2025-09-13","path":"data/notes/2025-09-13/Daily.md","summary":"..."
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "secret.scan.ready": {
    "event":"secret.scan.ready",
    "timestamp":"iso8601",
    "profileId":"postmortem|notes|policy|digest|generic",
    "path":"data/.../file.ext",
    "classification":"SAFE|SUSPICIOUS|LEAK",
    "findings":[
      {"type":"AWS_ACCESS_KEY","severity":"high","masked":"AKIA***7Q","line":128,"entropy":4.7},
      {"type":"JWT","severity":"medium","masked":"eyJhbGciOi***.***.***","line":22,"expiresAt":"2025-10-01T00:00:00Z"}
    ],
    "maskedContent":"<string|optional>",
    "actions":["block_distribution","quarantine|rotate|revoke|notify_compliance"],
    "hash":"sha256:..."
  },

  "secret.quarantine": {
    "event":"secret.quarantine","timestamp":"iso8601",
    "reason":"LEAK","path":"data/.../file.ext","vaultRef":"state/quarantine/2025-09-13/sha256....json"
  },

  "secret.rotate.suggest": {
    "event":"secret.rotate.suggest","timestamp":"iso8601",
    "kind":"aws|gcp|azure|generic","refHint":"repo/service","urgency":"high|medium|low"
  },

  "secret.block.distribution": {
    "event":"secret.block.distribution","timestamp":"iso8601",
    "deliveryKey":"sha256:...","reason":"LEAK|SUSPICIOUS"
  },

  "secret.card": {
    "event":"secret.card","timestamp":"iso8601",
    "title":"Gizli Anahtar SÄ±zÄ±ntÄ±sÄ± Engellendi",
    "body":"AWS key & JWT bulgularÄ± â€¢ daÄŸÄ±tÄ±m durduruldu â€¢ rotasyon Ã¶nerildi.",
    "severity":"error","ttlSec":900
  },

  "secret.alert": {
    "event":"secret.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|parser_error|quarantine_failed|blocked_dist|rbac_denied"
  },

  "secret.metrics": {
    "event":"secret.metrics","timestamp":"iso8601",
    "scans":5,"leaks":1,"suspicious":1,"safe":3,
    "blocked":1,"quarantined":1,"avgScanMs":7.4,"fpRate":0.01,"fnGuard":true
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  profiles:{
    digest:{ diffAware:false, maskInline:true },
    postmortem:{ diffAware:true, maskInline:false },
    notes:{ diffAware:true, maskInline:true },
    policy:{ diffAware:true, maskInline:false },
    generic:{ diffAware:true, maskInline:true }
  },

  patterns:{
    // yÃ¼ksek isabet + entropi kontrolÃ¼, iki-aÅŸamalÄ± doÄŸrulama
    awsAccessKey: "\\bAKIA[0-9A-Z]{16}\\b",
    awsSecretKey: "(?i)aws_secret(?:_access)?_key\\s*[:=]\\s*([A-Za-z0-9/+=]{40})",
    gcpKeyJson: "\"type\":\\s*\"service_account\"",
    azureConn: "Endpoint=sb:\\/\\/.*?;SharedAccessKeyName=.*?;SharedAccessKey=[A-Za-z0-9/+]{43}=",
    jwt: "\\beyJ[A-Za-z0-9_-]{10,}\\.([A-Za-z0-9_-]{10,})\\.[A-Za-z0-9_-]{10,}\\b",
    oauthClientSecret: "(?i)(client_secret|CLIENT_SECRET)\\s*[:=]\\s*['\\\"][A-Za-z0-9_\\-]{12,}['\\\"]",
    privateKey: "-----BEGIN (RSA|EC|DSA|OPENSSH) PRIVATE KEY-----[\\s\\S]+?-----END \\1 PRIVATE KEY-----",
    genericToken: "(?i)(api[-_ ]?key|token|secret)\\s*[:=]\\s*['\\\"][A-Za-z0-9_\\-]{16,}['\\\"]",
    envLeak: "(?m)^\\s*[A-Z0-9_]{3,32}\\s*=\\s*[^\\n]{6,}$"
  },

  validators:{
    entropyMinBitsPerChar: 3.0,
    jwtValidateHeader:true,
    keyChecksumHeuristics:true
  },

  policy:{
    blockOn:["LEAK"],
    quarantineOn:["LEAK"],
    notify:["ops","policy","compliance"]
  },

  redaction:{
    profile:"generic",    // L21 Ã¼zerinden
    maskStyle:"partial"   // ilk/son birkaÃ§ karakter bÄ±rak
  },

  idempotencyTtlSec: 86400
}

5) Pipeline

Kaynak SeÃ§imi: secret.scan.request veya *.ready/dist.request tetiklenir

Parse: mode=markdown|html|text|diff â†’ uygun ayrÄ±ÅŸtÄ±rÄ±cÄ±

Detect (Pass-1): regex eÅŸleÅŸmeleri + entropi filtresi

Validate (Pass-2): tÃ¼r-Ã¶zel doÄŸrulama (JWT header decode, JSON anahtar yapÄ±sÄ±, uzunluk/check)

SÄ±nÄ±flandÄ±r: SAFE|SUSPICIOUS|LEAK

Maskele & Karar: LEAK â†’ secret.block.distribution + secret.quarantine + secret.rotate.suggest + secret.card

Emit: secret.scan.ready + secret.metrics; hata â†’ secret.alert

6) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ secret.scan.request|*.ready|dist.request â†’ SCAN

SCAN â†’ CLASSIFY â†’ (LEAK) QUARANTINE | (SUSPICIOUS) MASK_ONLY | (SAFE) EMIT

QUARANTINE/MASK_ONLY â†’ EMIT â†’ IDLE

Hata: ALERT â†’ IDLE

7) Kenar Durumlar

Diff modunda yalnÄ±z + satÄ±rlar taranÄ±r; - satÄ±rlar referans gÃ¶sterilir

BÃ¼yÃ¼k dosya (>2MB) â†’ streaming tarama; overlap ile sÄ±nÄ±r sÄ±zÄ±ntÄ±sÄ± yok

Observer kitlesi: yalnÄ±z Ã¶zet kart, ham bulgular yok

False positive ÅŸÃ¼phesi: SUSPICIOUS â†’ daÄŸÄ±tÄ±m engellenmez ama kart/warn Ã¼retilir

Vault/Karantina hatasÄ±: daÄŸÄ±tÄ±m zaten blok; uyarÄ± quarantine_failed

8) Telemetri
{"secret.metrics":{"scans":5,"leaks":1,"suspicious":1,"blocked":1,"quarantined":1,"avgScanMs":7.4}}

9) Dosya YapÄ±sÄ±
services/livia/secretsLeakScanner.ts
services/livia/lib/secrets/patterns.ts
services/livia/lib/secrets/validators.ts
services/livia/lib/secrets/mask.ts
services/livia/lib/secrets/streamer.ts
services/livia/state/secretScanStore.ts
services/livia/__tests__/secretsLeakScanner.test.ts
cfg/livia.secrets.yaml

10) Test Ä°skeleti

AWS key + JWT â†’ LEAK sÄ±nÄ±fÄ±, daÄŸÄ±tÄ±m blok + karantina

Diff modunda yalnÄ±z eklenen satÄ±rlar tarandÄ±

Entropi eÅŸiÄŸi dÃ¼ÅŸÃ¼k ise eÅŸleÅŸme dÃ¼ÅŸer

Idempotency: aynÄ± iÃ§erik ikinci kez raporlanmaz

RBAC: observer ham veri gÃ¶rmez

Masking: partial maske biÃ§imi doÄŸru

11) Ã–rnek AkÄ±ÅŸ

postmortem.ready â†’ tarama â†’ AWS key bulundu â†’ block+quarantine+rotate Ã¶nerildi â†’ L22 daÄŸÄ±tÄ±mÄ± durdurdu â†’ L26â€™a bildirim.

12) SLO

p95 tarama < 15 ms / 64KB

zeroSecretLeakAfterGate = true (daÄŸÄ±tÄ±m Ã¶ncesi sabit kapÄ±)

YanlÄ±ÅŸ pozitif â‰¤ %1, yanlÄ±ÅŸ negatif â‰¤ %1

LIVIA-28 Â· runbookAutoPilot.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Postmortemlerden (L15), politika notlarÄ±ndan (L23) ve bilgi tabanÄ±ndan (L24) Ã¶ÄŸrenilmiÅŸ runbook adÄ±mlarÄ±nÄ±; incident anÄ±nda gÃ¼venli ve izlenebilir ÅŸekilde yarÄ±-otonom iÅŸle. Komut seti; cooldown baÅŸlat (L16), gate aÃ§ (L17), policy rollback/publish (L23), anchor reset (L18), dist.notify (L22), status.post, cache.flush, service.scale vb. AdÄ±mlar onay gerektirebilir (L05), etik/uyum kapÄ±sÄ±ndan (L26) geÃ§er. Her yÃ¼rÃ¼tme idempotent ve auditâ€™li.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601, TZ=Europe/Istanbul

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy yÃ¼rÃ¼tÃ¼r, observer yalnÄ±z okur

Ä°dempotency: execKey = incidentId + runbookId + startedAtISO

Observability: spans (rb.load, rb.plan, rb.step, rb.rollback) + metrics

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "runbook.template.updated": {
    "event":"runbook.template.updated","timestamp":"iso8601",
    "runbookId":"rb-latency-slip-hotfix",
    "title":"Latency+Slip Hotfix",
    "steps":[
      {"id":"s1","kind":"cooldown.plan","params":{"scope":"symbol","symbol":"AVAXUSDT","reasonCode":"anomaly"}},
      {"id":"s2","kind":"policy.rollback","params":{"toVersion":"v41"}},
      {"id":"s3","kind":"status.post","params":{"channel":"ops","text":"Rollback uygulandÄ±, izleniyor."}}
    ],
    "requiresApproval":["policy.rollback"]
  },

  "incident.started": {
    "event":"incident.started","timestamp":"iso8601",
    "id":"inc-2025-09-13-1","severity":"high","title":"Slip spike on SG02"
  },

  "incident.closed": {
    "event":"incident.closed","timestamp":"iso8601",
    "id":"inc-2025-09-13-1","resolution":"policy rollback v42â†’v41","durationMin":37
  },

  "runbook.execute.request": {
    "event":"runbook.execute.request","timestamp":"iso8601",
    "incidentId":"inc-2025-09-13-1","runbookId":"rb-latency-slip-hotfix","dryRun":false
  },

  "approval.result": {
    "event":"approval.result","timestamp":"iso8601",
    "ref":"runbook:rb-latency-slip-hotfix:s2","decision":"granted|rejected|timeout"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "runbook.exec.planned": {
    "event":"runbook.exec.planned","timestamp":"iso8601",
    "execKey":"sha256:...","incidentId":"inc-2025-09-13-1",
    "runbookId":"rb-latency-slip-hotfix",
    "steps":["s1","s2","s3"],"requiresApproval":["s2"]
  },

  "runbook.exec.started": {
    "event":"runbook.exec.started","timestamp":"iso8601",
    "execKey":"sha256:...","startedAt":"iso8601"
  },

  "runbook.step.progress": {
    "event":"runbook.step.progress","timestamp":"iso8601",
    "execKey":"sha256:...","stepId":"s1","status":"ok|blocked|skipped","details":"cooldown plan activated"
  },

  "runbook.step.blocked": {
    "event":"runbook.step.blocked","timestamp":"iso8601",
    "execKey":"sha256:...","stepId":"s2","reason":"approval_required|ethics_denied|timeout","next":"await_approval|rollback"
  },

  "runbook.exec.completed": {
    "event":"runbook.exec.completed","timestamp":"iso8601",
    "execKey":"sha256:...","durationSec":140,"result":"success|partial|failed"
  },

  "runbook.exec.failed": {
    "event":"runbook.exec.failed","timestamp":"iso8601",
    "execKey":"sha256:...","error":"step_timeout|ethics_block|dependency_fail"
  },

  "runbook.card": {
    "event":"runbook.card","timestamp":"iso8601",
    "title":"Runbook Ã‡alÄ±ÅŸÄ±yor â€” {runbookId}",
    "body":"s1 tamamlandÄ± â€¢ s2 onay bekliyor â€¢ s3 sÄ±rada.",
    "severity":"info","ttlSec":600
  },

  "runbook.metrics": {
    "event":"runbook.metrics","timestamp":"iso8601",
    "planned":1,"started":1,"completed":1,"failed":0,
    "p95StepMs":210,"blocked":1,"approvals":1
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  library:{
    // eylem-adÄ±mÄ± â†’ modÃ¼l kÃ¶prÃ¼leri
    "cooldown.plan": { bridge:"L16" },
    "defense.gate":  { bridge:"L17" },
    "anchor.reset":  { bridge:"L18" },
    "policy.rollback": { bridge:"L23" },
    "policy.publish":  { bridge:"L23" },
    "status.post":   { bridge:"L22" },
    "dist.notify":   { bridge:"L22" },
    "kb.index":      { bridge:"L24" },
    "cache.flush":   { bridge:"adapter" },
    "service.scale": { bridge:"adapter" }
  },

  approvals:{
    gateway:"LIVIA-05",
    requireFor:["policy.rollback","policy.publish","service.scale>2x"]
  },

  ethics:{ gateway:"LIVIA-26", enforce:true },

  execution:{
    concurrency: 1,
    stepTimeoutSec: 60,
    rollbackOnFail:true,
    dryRunDefault:false
  },

  redaction:{ profile:"generic" },

  idempotencyTtlSec: 86400
}

5) Pipeline

Load/Plan: runbook.template.updated â†’ ÅŸablonu kaydet; runbook.execute.request/incident.started ile plan oluÅŸtur

Authorize: RBAC; etik/uyum (L26) Ã¶n-kontrol; onay gerekiyorsa L05â€™e step-ref ile gÃ¶nder

Execute: adÄ±m-adÄ±m; kÃ¶prÃ¼ler Ã¼zerinden ilgili modÃ¼llere olay yayÄ±nla (L16/L17/L18/L22/L23/L24)

Track: her adÄ±mda runbook.step.progress|blocked; timeout â†’ failed

Rollback (opsiyonel): baÅŸarÄ±sÄ±z kritik adÄ±mda otomatik geri alma

Emit: runbook.exec.(planned|started|completed|failed|card|metrics)

Idempotency: aynÄ± execKey ikinci kez koÅŸmaz; tekrar istek resume modunda deÄŸerlendirilir

6) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (incident.started|runbook.execute.request) â†’ PLAN

PLAN â†’ START

START â†’ STEP(s) (sÄ±ralÄ±)

STEP â†’ (ok) next | (approval_required) AWAIT_APPROVAL | (error) ROLLBACK

AWAIT_APPROVAL â†’ approval.result (grantedâ†’next | rejectedâ†’ROLLBACK/COMPLETE(partial))

ROLLBACK â†’ adÄ±m/ÅŸablon rollback planÄ± â†’ COMPLETE

COMPLETE â†’ emit + store â†’ IDLE

7) AdÄ±m TÃ¼rleri (Ã¶zet sÃ¶zleÅŸme)

cooldown.plan â†’ L16 cooldown.plan.proposed

defense.gate â†’ L17 defense.gate.proposed

anchor.reset â†’ L18 anchor.reset.proposed

policy.rollback|publish â†’ L23 onaylÄ± kÃ¶prÃ¼

status.post|dist.notify â†’ L22 format/kanal

kb.index â†’ L24 ingest

cache.flush|service.scale â†’ adapter (komut param doÄŸrulama + dry-run)

8) Kenar Durumlar

Onay gecikmesi: step timeout Ã¶ncesi AWAIT durumunda card gÃ¼ncellenir

Ethics block: L26 reddederse step blocked â†’ rollback veya atla

Idempotent resume: tekerrÃ¼r isteklerinde kaldÄ±ÄŸÄ± adÄ±m/sonuÃ§tan devam

Observer: yalnÄ±z read-only akÄ±ÅŸ; execute.request yetkisi yok

9) Telemetri
{"runbook.metrics":{"planned":1,"started":1,"completed":1,"failed":0,"p95StepMs":210,"blocked":1,"approvals":1}}

10) Dosya YapÄ±sÄ±
services/livia/runbookAutoPilot.ts
services/livia/lib/runbook/loader.ts
services/livia/lib/runbook/engine.ts
services/livia/lib/runbook/bridges.ts
services/livia/state/runbookStore.ts
services/livia/__tests__/runbookAutoPilot.test.ts
cfg/livia.runbook.yaml

11) Test Ä°skeleti

incident.started â†’ plan/baÅŸlat â†’ s1 ok, s2 onay bekler, s3 sÄ±rada

Onay geldi â†’ s2 ok â†’ s3 ok â†’ completed

Ethics block â†’ step blocked + rollback

Timeout â†’ failed + rollback

Idempotent resume â†’ kaldÄ±ÄŸÄ± yerden devam

12) Ã–rnek AkÄ±ÅŸ

18:01 incident baÅŸladÄ± â†’ runbook planlandÄ± â†’ s1: cooldown etkin â†’ s2: rollback onaylandÄ± â†’ s3: status.post â†’ completed; card & metrics yayÄ±mlandÄ±.

13) SLO

p95 adÄ±m Ã§alÄ±ÅŸtÄ±rma < 250 ms (kÃ¶prÃ¼-gidiÅŸ)

Onay bekleme dÄ±ÅŸÄ±nda toplam yÃ¼rÃ¼tme overheadâ€™i minimal

Idempotent tekrar Ã§alÄ±ÅŸtÄ±rma hatasÄ± â‰ˆ 0
______________________________________________________________________________________________
LIVIA-29 Â· chaosTelemetryFuzzer.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Ãœretimdeki modÃ¼llerin (L14â€“L26) dayanÄ±klÄ±lÄ±ÄŸÄ±nÄ± ve hata toleransÄ±nÄ± Ã¶lÃ§mek iÃ§in telemetri akÄ±ÅŸÄ±na kontrollÃ¼ kaos (sentetik/sahte/bozuk) olaylar enjekte et. Enjeksiyonlar daima iÅŸaretli (flagged), izlenebilir, geri alÄ±nabilir ve izole (shadow/sandbox) Ã§alÄ±ÅŸÄ±r; gerÃ§ek kararlarÄ± bozmaz. Sadece test amaÃ§lÄ±dÄ±r; rapor/puan kartÄ± Ã¼retir. I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; TZ=Europe/Istanbul

GÃ¼venlik: HMAC/JWT; RBAC: ops|qa baÅŸlatÄ±r, policy|observer okur

Ä°dempotency: fuzzKey = campaignId + seed + window + scope

Ä°zlenebilirlik: OpenTelemetry spans (fuzz.plan, fuzz.inject, fuzz.observe, fuzz.report) + metrics

GÃ¼venlik: Chaos etiketleri zorunlu â†’ downstream â€œshadowâ€/â€œchaosâ€ olarak iÅŸlenir; L22 daÄŸÄ±tÄ±mda â€œtestâ€ olarak ayrÄ±lÄ±r

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "fuzzer.plan.request": {
    "event":"fuzzer.plan.request","timestamp":"iso8601",
    "campaignId":"ch-2025-09-13-A",
    "scope":"global|desk|symbol","symbol":"AVAXUSDT|null",
    "modes":["shadow","sandbox"],                 // production data path'e enjekte edilmez
    "durationMin": 20,
    "faults":[
      {"type":"drop","series":"telemetry.slo.status","ratePct":15},
      {"type":"delay","series":"telemetry.anomaly.signal","latencyMs":800},
      {"type":"duplicate","series":"guard.activity.rollup","factor":2},
      {"type":"spike","series":"order.slip.p95","mult":1.4},
      {"type":"drift","series":"lat.p95","slopePctPerMin":1.2},
      {"type":"flatline","series":"feed.gap","holdMin":5},
      {"type":"swap_symbol","from":"AVAXUSDT","to":"SOLUSDT"},
      {"type":"scale","series":"pnl.window.netUSD","mult":0.5}
    ],
    "seed": 42,
    "sloGuards":{"maxBreachAlerts":0},           // prod SLO alarmÄ±na dÃ¼ÅŸmeyecek
    "dryRun": false
  },

  "fuzzer.stop.request": {
    "event":"fuzzer.stop.request","timestamp":"iso8601",
    "campaignId":"ch-2025-09-13-A"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "fuzzer.run.started": {
    "event":"fuzzer.run.started","timestamp":"iso8601",
    "campaignId":"ch-2025-09-13-A","fuzzKey":"sha256:...","durationMin":20,
    "modes":["shadow"],"seed":42,"faultCount":8
  },

  "fuzzer.injection.emitted": {
    "event":"fuzzer.injection.emitted","timestamp":"iso8601",
    "campaignId":"ch-2025-09-13-A",
    "series":"telemetry.anomaly.signal","fault":"delay","count":120,
    "flags":{"chaos":true,"shadow":true}
  },

  "fuzzer.run.completed": {
    "event":"fuzzer.run.completed","timestamp":"iso8601",
    "campaignId":"ch-2025-09-13-A","injected":420,"dropped":87,"errors":0
  },

  "fuzzer.report.ready": {
    "event":"fuzzer.report.ready","timestamp":"iso8601",
    "campaignId":"ch-2025-09-13-A",
    "path":"data/fuzzer/2025-09-13/ch-2025-09-13-A/report.md",
    "summary":"Latencyâ†‘ + spike/flatline etkisi: L14 compose p95 +7ms; L17 false-trigger=0; L22 DLQ=0.",
    "hash":"sha256:..."
  },

  "fuzzer.card": {
    "event":"fuzzer.card","timestamp":"iso8601",
    "title":"Kaos Testi Tamam â€” ch-2025-09-13-A",
    "body":"420 enjeksiyon â€¢ 0 prod etki â€¢ L14 p95 +7ms â€¢ L17/L16 stabil.",
    "severity":"info","ttlSec":600
  },

  "fuzzer.alert": {
    "event":"fuzzer.alert","timestamp":"iso8601",
    "level":"warn|error","message":"plan_invalid|inject_failed|stop_timeout|slo_guard_trip"
  },

  "fuzzer.metrics": {
    "event":"fuzzer.metrics","timestamp":"iso8601",
    "campaigns":1,"injected":420,"errors":0,"shadowShare":1.0,
    "p95InjectMs":5.2,"falseTrigger":0,"blockedBySLOGuard":0
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  modes:{ allow:["shadow","sandbox"], default:"shadow" },

  safetyGuards:{
    tagHeaders:{ chaos:true, shadow:true },
    preventDistribution:true,         // L22: prod kanallara gitmez
    protectSLO:true,                  // L14/L23 metrikleri â€œtestâ€ etiketli sayar
    ethicsBypass:true,                // L26'a â€œlabâ€ etiketiyle bilgi amaÃ§lÄ±; enforcement yok
    maxRuntimeMin:60
  },

  faultDefaults:{
    maxRatePerMin: 60,
    symbolSet:["AVAXUSDT","SOLUSDT","BTCUSDT"],
    scaleBounds:{ min:0.1, max:3.0 }
  },

  output:{
    dir:"data/fuzzer/{YYYY-MM-DD}/{campaignId}",
    reportFile:"report.md", html:{ embedMiniCSS:true, chartsInlineSvg:true }
  },

  idempotencyTtlSec: 86400
}

5) Pipeline

Plan: fuzzer.plan.request doÄŸrula â†’ fault set & tohum (seed) sabitle

Isolate: tÃ¼m enjeksiyonlara {chaos:true, shadow:true} bayraÄŸÄ±; Ã¼retim kuyruÄŸundan ayrÄ± topic/stream

Inject: fault tipi (drop/delay/duplicate/spike/drift/flatline/swap/scale) uygula

Observe: L14/L16/L17/L22/L23/L26 Ã¶lÃ§Ã¼mlerini â€œchaos campaignâ€ etiketiyle topla

Report: p95/p99 etkiler, false-trigger oranÄ±, DLQ, SLO guard trip; Markdown/HTML rapor

Emit: fuzzer.run.* + fuzzer.report.ready + fuzzer.card + fuzzer.metrics

Stop: istek gelirse kontrollÃ¼ sonlandÄ±r; kalan enjeksiyonlar iptal

6) FSM

IDLE â†’ plan.request â†’ PLAN

PLAN â†’ INJECT (zamanlayÄ±cÄ±)

INJECT â†’ per-fault akÄ±ÅŸÄ± â†’ OBSERVE

OBSERVE (rolling) â†’ sÃ¼resi bitince REPORT

REPORT â†’ emit â†’ IDLE

Hata: ALERT â†’ IDLE

7) Kenar Durumlar

SLO guard trip (yanlÄ±ÅŸlÄ±kla prodâ€™a etki): otomatik stop + alert

Ã‡akÄ±ÅŸan campaignId: idempotency â†’ ikinci plan reddi

AÅŸÄ±rÄ± fault oranÄ±: maxRatePerMin klips; delay>2s â†’ sandboxâ€™a zorla

Symbol swap olmayan eÅŸleÅŸme: symbol allowlist dÄ±ÅŸÄ± ise atla

Observer gÃ¶rÃ¼nÃ¼mÃ¼: yalnÄ±z Ã¶zet card

8) Telemetri
{"fuzzer.metrics":{"campaigns":1,"injected":420,"errors":0,"p95InjectMs":5.2,"falseTrigger":0}}

9) Dosya YapÄ±sÄ±
services/livia/chaosTelemetryFuzzer.ts
services/livia/lib/fuzz/faults.ts
services/livia/lib/fuzz/isolation.ts
services/livia/lib/fuzz/report.ts
services/livia/state/fuzzStore.ts
services/livia/__tests__/chaosTelemetryFuzzer.test.ts
cfg/livia.fuzz.yaml

10) Test Ä°skeleti

shadow etiketli enjeksiyonlar prod hatlarÄ±na karÄ±ÅŸmÄ±yor

delay+duplicate+spike kombinasyonunda L17/L16 false-trigger=0

idempotency: aynÄ± campaign iki kez koÅŸmuyor

stop.request Ã§alÄ±ÅŸma ortasÄ±nda gÃ¼venli durdurma

report iÃ§eriÄŸi: p95 etkiler, DLQ, falseTrigger=0

11) Ã–rnek AkÄ±ÅŸ

14:05 planlandÄ± (20dk) â†’ 14:25 rapor yazÄ±ldÄ± â†’ kart daÄŸÄ±tÄ±ldÄ± (test kanalÄ±).

12) SLO

p95 enjeksiyon < 10 ms; prod etki 0; rapor p95 < 80 ms

LIVIA-30 Â· contextAwareMoralLimiter.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
OperatÃ¶r/servis eylemlerinde biliÅŸsel Ã¶nyargÄ± (overconfidence, loss aversion, sunk cost, risk-seeking-after-loss), yorgunluk (L20), toparlanma (L19), cooldown (L16), etik/uyum (L26) ve piyasa baÄŸlamÄ± sinyallerine gÃ¶re davranÄ±ÅŸsal fren uygula. Ã–nce nudge/reflection adÄ±mÄ± (checklist + kÄ±sa premortem), sonra gerekiyorsa soft block (onay/justification) ve son aÅŸamada policy/ethics kapÄ±sÄ±na yÃ¶nlendir. I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; TZ=Europe/Istanbul

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy; observer salt okur

Ä°dempotency: moralKey = actionId + biasSnapshotHash + windowISO

Observability: spans (moral.assess, moral.nudge, moral.block, moral.justify) + metrics

Gizlilik: PII yok; aÃ§Ä±klamalar L21 redaksiyonundan geÃ§er

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "action.intent": {
    "event":"action.intent","timestamp":"iso8601",
    "actionId":"act-2025-09-13-42",
    "kind":"order.place|order.modify|policy.change|position.close",
    "scope":"desk|symbol|global","symbol":"AVAXUSDT|null",
    "payload":{"side":"buy","qty":180,"variant":"aggressive","reason":"bounce"}
  },

  "bias.snapshot": {
    "event":"bias.snapshot","timestamp":"iso8601",
    "overconfidence":0.72,"lossAversion":0.66,"sunkCost":0.31,"riskSeeking":0.58
  },

  "fatigue.score.updated": {
    "event":"fatigue.score.updated","timestamp":"iso8601",
    "scope":"desk","operator":"op#abcd12","fatigueScore":0.77
  },

  "recovery.score.updated": {
    "event":"recovery.score.updated","timestamp":"iso8601",
    "scope":"symbol","symbol":"AVAXUSDT","recoveryIndex":0.49
  },

  "cooldown.plan.activated": {
    "event":"cooldown.plan.activated","timestamp":"iso8601",
    "cooldownKey":"...","effectiveUntil":"iso8601","scope":"desk","symbol":null
  },

  "pnl.window": {
    "event":"pnl.window","timestamp":"iso8601",
    "windowMin":240,"netUSD":-480.0,"rrMedian":0.88
  },

  "ethics.gate.activated": {
    "event":"ethics.gate.activated","timestamp":"iso8601",
    "decision":"allow_with_limits|block|halt"
  },

  "moral.justification.submitted": {
    "event":"moral.justification.submitted","timestamp":"iso8601",
    "actionId":"act-2025-09-13-42",
    "premortem":"Bu iÅŸlem 15dk iÃ§inde -%1 olur ise otomatik Ã§Ä±kÄ±ÅŸ.",
    "checklist":{"maxLossUSD":200,"exitRule":"-0.8% / 10dk","whyNow":"likidite geri geldi"}
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "moral.nudge.proposed": {
    "event":"moral.nudge.proposed","timestamp":"iso8601",
    "actionId":"act-2025-09-13-42",
    "biasFlags":["overconfidence","riskSeeking"],
    "message":"Son 4 saatte net -$480 ve recovery dÃ¼ÅŸÃ¼k (0.49). VaryantÄ± 'balanced' yapmayÄ± dener misin?",
    "suggestedChanges":{"variant":"balanced","qtyFactor":0.7},
    "ttlSec":300
  },

  "moral.reflection.required": {
    "event":"moral.reflection.required","timestamp":"iso8601",
    "actionId":"act-2025-09-13-42",
    "checklist":[
      "Maks kaybÄ±n? (USD)",
      "Ã‡Ä±kÄ±ÅŸ kuralÄ±n? (yÃ¼zde/zaman)",
      "Alternatif daha az riskli yol?"
    ],
    "premortemPrompt":"Bu iÅŸlem baÅŸarÄ±sÄ±z olursa en olasÄ± 3 sebep nedir?",
    "timeoutSec":120
  },

  "moral.softblock.suggested": {
    "event":"moral.softblock.suggested","timestamp":"iso8601",
    "actionId":"act-2025-09-13-42",
    "reasonCodes":["fatigue_high","recovery_low","pnl_drawdown"],
    "require":"justification|approval","cooldownHint":true
  },

  "moral.pass": {
    "event":"moral.pass","timestamp":"iso8601",
    "actionId":"act-2025-09-13-42","notes":"Nudge kabul edildi; qty Ã—0.7, variant=balanced"
  },

  "moral.block.delegated": {
    "event":"moral.block.delegated","timestamp":"iso8601",
    "actionId":"act-2025-09-13-42",
    "to":"LIVIA-26","reason":"ethics escalation"
  },

  "moral.card": {
    "event":"moral.card","timestamp":"iso8601",
    "title":"DavranÄ±ÅŸsal Fren UygulandÄ±",
    "body":"Nudge: qty Ã—0.7, variant=balanced â€¢ Reflection formu dolduruldu.",
    "severity":"info","ttlSec":600
  },

  "moral.alert": {
    "event":"moral.alert","timestamp":"iso8601",
    "level":"info|warn|error","message":"idem_duplicate|timeout|rbac_denied|ethics_escalated"
  },

  "moral.metrics": {
    "event":"moral.metrics","timestamp":"iso8601",
    "nudges":4,"accepted":3,"softBlocks":1,"escalations":0,
    "avgAssessMs":8.4,"conversionRate":0.75
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  weights:{ bias:0.4, fatigue:0.2, recovery:0.2, pnl:0.2 },

  thresholds:{
    overconfidence: ">=0.7",
    riskSeeking: ">=0.55",
    fatigueHigh: ">=0.8",
    recoveryLow: "<=0.55",
    pnlDrawdownUSD: "<=-300",
    requireReflectionScore: ">=0.65",   // toplam risk skoru
    escalateToEthicsScore: ">=0.85"
  },

  nudgeLibrary:{
    overconfidence:[
      { msg:"Son 24 saatte risk iÅŸtahÄ± yÃ¼ksek. MiktarÄ± %30 azaltmayÄ± dener misin?", change:{ qtyFactor:0.7 } }
    ],
    lossAversion:[
      { msg:"ZararÄ± telafi etme dÃ¼rtÃ¼sÃ¼ne dikkat. VaryantÄ± 'balanced' seÃ§ebilirsin.", change:{ variant:"balanced" } }
    ],
    riskSeeking:[
      { msg:"KayÄ±p sonrasÄ± risk alma artÄ±yor. Pozisyon limit faktÃ¶rÃ¼nÃ¼ dÃ¼ÅŸÃ¼relim mi?", change:{ posLimitFactor:0.8 } }
    ]
  },

  reflectionForm:{
    fields:["maxLossUSD","exitRule","whyNow"],
    premortemPrompt:"Bu iÅŸlem neden kÃ¶tÃ¼ gidebilir? 3 sebep yaz."
  },

  integration:{
    cooldownHint:true,   // L16 'cooldown.plan.proposed' tetik Ã¶nerisi
    ethics:"LIVIA-26",   // zorunlu escalations
    dist:"LIVIA-22",     // card daÄŸÄ±tÄ±mÄ±
    redact:"LIVIA-21"    // justification metinleri
  },

  idempotencyTtlSec: 1800
}

5) Skorlama

riskScore = Î£ w_i * factor_i,

biasFactor = max(overconfidence, riskSeeking, lossAversion, sunkCost)

fatigueFactor = fatigueScore

recoveryFactor = 1 - recoveryIndex

pnlFactor = clamp( -netUSD / 500 , 0, 1 ) * clamp( (1-rrMedian)/0.5 , 0, 1 )

6) Pipeline

Assess: action + bias + fatigue + recovery + pnl + cooldown/ethics durumu â†’ riskScore

Decide:

score < requireReflection â†’ moral.nudge.proposed

requireReflection â‰¤ score < escalate â†’ moral.reflection.required (+ opsiyonel softblock.suggested)

score â‰¥ escalate â†’ moral.block.delegated (L26)

Collect Justification: moral.justification.submitted â†’ L21 ile redakte â†’ log + karar gÃ¼ncelle

Apply Changes: nudge kabul edildiyse payload tweak (qtyFactor/variant/posLimitFactor) â†’ moral.pass

Emit: card + metrics; idempotency kontrolÃ¼

7) FSM

IDLE â†’ action.intent â†’ ASSESS

ASSESS â†’ NUDGE | REFLECT | ESCALATE

NUDGE â†’ (kabul) PASS | (reddet) REFLECT

REFLECT â†’ (form geldi) REASSESS | (timeout) ALERT

ESCALATE â†’ L26 sonucu â†’ PASS/BLOCK

PASS/BLOCK â†’ IDLE

8) Kenar Durumlar

Aktif cooldown/ethics block varken â€œpassâ€ Ã¼retme; yalnÄ±z nudge gÃ¶ster

Justification PII â†’ L21 maskele; eksikse red

Observer iÃ§in kartlar Ã¶zet ve miktarlar gizli

AynÄ± actionId tekrar denemesi â†’ idempotency ile tek karar

9) Telemetri
{"moral.metrics":{"nudges":4,"accepted":3,"softBlocks":1,"escalations":0,"avgAssessMs":8.4}}

10) Dosya YapÄ±sÄ±
services/livia/contextAwareMoralLimiter.ts
services/livia/lib/moral/assess.ts
services/livia/lib/moral/nudges.ts
services/livia/lib/moral/reflection.ts
services/livia/state/moralStore.ts
services/livia/__tests__/contextAwareMoralLimiter.test.ts
cfg/livia.moral.yaml

11) Test Ä°skeleti

overconfidence 0.72 + recovery 0.49 + pnl -480 â†’ softblock.suggested

nudge kabul â†’ moral.pass + payload deÄŸiÅŸikliÄŸi

reflection timeout â†’ moral.alert("timeout")

escalate â‰¥0.85 â†’ moral.block.delegated L26â€™ya gider

idempotency: aynÄ± action iki kez deÄŸerlendirilmez

12) Ã–rnek AkÄ±ÅŸ

action.intent(buy 180 aggressive) + bias/fatigue/pnl/recovery â†’ NUDGE

OperatÃ¶r qtyÃ—0.7, variant=balanced kabul â†’ moral.pass + card

Sonraki giriÅŸimde riskScore yÃ¼ksek â†’ REFLECT â†’ form doldu â†’ PASS

Ã‡ok yÃ¼ksek riskte ESCALATE â†’ L26 kararÄ±na gÃ¶re ilerler

13) SLO

p95 assess < 15 ms

Nudge kabul oranÄ± â‰¥ %60 (hedef)

Escalation yanlÄ±ÅŸ-pozitif â‰¤ %2
______________________________________________________________________________________________
LIVIA-31 Â· runMetricsHousekeeper.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
LIVIA ekosistemindeki tÃ¼m zaman serisi ve olay depolarÄ±nÄ± (metrics/events/digest/postmortem/policy/kb/dist/ethics/fuzz/sim vb.) otomatik bakÄ±m ile saÄŸlÄ±klÄ±, hÄ±zlÄ± ve hesaplÄ± tutmak: retention, kompaktlama (rollup/aggregate), dedup, checksum/doÄŸrulama, soÄŸuk depoya taÅŸÄ±ma (S3/Backblaze/MinIO), indeks optimizasyonu (L24 vektÃ¶r+BM25), DLQ temizlik & replay planÄ±, disk alanÄ± koruma ve maliyet raporu.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; PII/redaksiyon (L21) ve gizli anahtar taramasÄ± (L27) entegre.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601, TZ=Europe/Istanbul

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy baÅŸlatÄ±r, observer salt okur

Gizlilik: iÃ§eriÄŸe dokunmaz; yalnÄ±zca metadata/yer deÄŸiÅŸimi; metin raporlarÄ± L21 ile redakte

Ä°dempotency: hkKey = taskSet + windowISO + scope + tier

GÃ¶zlemlenebilirlik: OpenTelemetry spans (hk.plan, hk.rollup, hk.compact, hk.coldstore, hk.index.optimize, hk.verify) + metrics

Uyum: Ethics/WORM (L26) kayÄ±tlarÄ±na dokunulmaz (read-only); yalnÄ±z doÄŸrulama ve append-tÃ¼rÃ¼ bakÄ±m yapÄ±lÄ±r.

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "housekeeping.request": {
    "event":"housekeeping.request","timestamp":"iso8601",
    "mode":"auto|manual",
    "window":{"from":"2025-09-01T00:00:00+03:00","to":"2025-09-14T00:00:00+03:00"},
    "taskSet":["rollup","compact","dedup","ttl_enforce","coldstore","index_optimize","dlq_cleanup","verify"],
    "priority":"low|normal|high",
    "dryRun": false
  },

  "storage.threshold.status": {
    "event":"storage.threshold.status","timestamp":"iso8601",
    "volume":"local-data","freePct":14.2,"bytesFree":15000000000
  },

  "dist.dlq": {
    "event":"dist.dlq","timestamp":"iso8601",
    "deliveryKey":"sha256:...","reason":"permanent_failure","deadLetterPath":"state/dlq/2025-09-13/sha256....json"
  },

  "knowledge.indexed": {
    "event":"knowledge.indexed","timestamp":"iso8601",
    "index":"kb_default","docId":"kb:postmortem:inc-2025-09-13-1","upserted":true
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "housekeeping.planned": {
    "event":"housekeeping.planned","timestamp":"iso8601",
    "hkKey":"sha256:...","taskSet":["rollup","ttl_enforce","coldstore","index_optimize"],
    "window":{"from":"2025-09-01","to":"2025-09-14"},
    "targets":{"metrics":8,"events":6,"kbIndex":1,"dlq":1}
  },

  "housekeeping.progress": {
    "event":"housekeeping.progress","timestamp":"iso8601",
    "hkKey":"sha256:...","task":"coldstore","status":"running",
    "details":"postmortem/2025-07 â†’ s3://archive/postmortem/2025-07 (zstd:19, parquet)"
  },

  "housekeeping.completed": {
    "event":"housekeeping.completed","timestamp":"iso8601",
    "hkKey":"sha256:...","tasksOk":["rollup","compact","ttl_enforce","index_optimize","verify"],
    "bytesFreed": 8240000000,"filesMoved": 312,"dlqReplayed": 18,
    "reportPath":"data/reports/housekeeping/2025-09-14/report.md","hash":"sha256:..."
  },

  "housekeeping.alert": {
    "event":"housekeeping.alert","timestamp":"iso8601",
    "level":"warn|error","message":"coldstore_unavailable|checksum_mismatch|worm_protected|index_optimize_failed|low_space",
    "context":{"path":"data/ethics/2025-06/chain.log"}
  },

  "housekeeping.metrics": {
    "event":"housekeeping.metrics","timestamp":"iso8601",
    "planned":1,"completed":1,"failed":0,
    "p95PlanMs":42,"p95ExecMs":920,
    "bytesFreed":8240000000,"filesCompacted":540,"filesArchived":312,
    "indexOptimized":{"vector":1,"bm25":1},
    "costEstimateUSD":4.12
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  retention: {
    // sÄ±cakâ†’Ä±lÄ±kâ†’soÄŸuk dereceli saklama
    "metrics.timeseries": { hotDays: 14, warmDays: 60, coldDays: 365, keepForever:false },
    "events.raw":         { hotDays: 14, warmDays: 90, coldDays: 365, keepForever:false },
    "digest":             { hotDays: 90, warmDays: 365, coldDays: 0,  keepForever:true },
    "postmortem":         { hotDays: 365, warmDays: 3650, coldDays: 0, keepForever:true },
    "policy":             { hotDays: 365, warmDays: 3650, coldDays: 0, keepForever:true },
    "knowledge.index":    { hotDays: 365, warmDays: 0,   coldDays: 0,  keepForever:true },
    "ethics.worm":        { hotDays: 0,   warmDays: 0,   coldDays: 0,  keepForever:true } // dokunma
  },

  compaction: {
    // zaman serilerinde downsample/rollup
    timeseries: [
      { from: "5s", to: "1m", agg:["min","max","avg","p95"] },
      { from: "1m", to: "5m", agg:["min","max","avg","p95"] },
      { from: "5m", to: "1h", agg:["min","max","avg","p95"] }
    ],
    fileFormat: "parquet",
    compression: { codec:"zstd", level: 11 }
  },

  dedup: {
    // event loglarÄ±nda aynÄ± hash/ts Â±1s ise tek kopya
    tsToleranceSec: 1
  },

  coldstore: {
    enabled:true,
    provider:"s3|b2|minio",
    bucket:"archive",
    prefix:"livia",
    multipartChunkMB: 32,
    storageClass:"STANDARD_IA|GLACIER",
    encryptAtRest:true
  },

  indexOptimize: {
    knowledge: { vector:true, bm25:true, vacuum:true, reindexIfFragPct: 0.2 }
  },

  dlq: {
    replay: { enabled:true, maxPerRun:50, backoffMs: 500 },
    ttlDays: 30
  },

  diskGuard: {
    minFreePct: 15,
    emergencyTasks:["ttl_enforce","coldstore","compact"]
  },

  schedule: {
    dailyAt:"03:30",          // hafif saatlerde Ã§alÄ±ÅŸ
    weeklyDeepAt:"Sun 04:30"  // derin optimizasyon
  },

  redactionProfile: "generic",   // L21
  scanSecretsBeforeArchive: true, // L27

  idempotencyTtlSec: 86400
}

5) Kapsam & Hedef Path HaritasÄ±

Timeseries & Metrics: data/metrics/{yyyymmdd}/*.parquet â†’ rollup/compact

Raw Events: data/events/{stream}/{yyyymmdd}/*.jsonl â†’ dedup + zstd

Artifacts: data/digest/*, data/postmortem/*, data/policy/* â†’ coldstore (sÄ±cak kopya indeksi kalÄ±r)

Knowledge Index (L24): state/kb/* â†’ vector/BM25 vacuum & optimize

DLQ (L22): state/dlq/*/*.json â†’ replay planÄ± + TTL silme

Ethics/WORM (L26): state/ethics/worm/* â†’ salt okunur doÄŸrulama, asla sil/taÅŸÄ±ma yok

6) Pipeline (Kompozisyon)

Plan: retention & diskGuard & taskSet â†’ hedef listesi ve sÄ±ralama (acil gÃ¶revler Ã¶nce)

Rollup/Compact: timeseries â†’ hedef Ã§Ã¶zÃ¼nÃ¼rlÃ¼klere downsample + Parquet/ZSTD; eski parÃ§a â†’ kaldÄ±r

Dedup: events jsonl â†’ sha256(line) & ts toleransÄ±yla tekilleÅŸtir

TTL Enforce: retention penceresini aÅŸan hotâ†’warmâ†’cold taÅŸÄ±ma veya silme (keepForever= true ise dokunma)

Coldstore: bÃ¼yÃ¼k/kadim dosyalarÄ± S3/B2/MinIOâ€™ya multipart yÃ¼kle; checksum doÄŸrula; yerelden kaldÄ±r

Index Optimize (L24): vektÃ¶r & BM25 vacuum, frag>threshold â†’ reindex; knowledge.metrics gÃ¼ncelle

DLQ Cleanup/Replay (L22): TTL > N gÃ¼n olanlarÄ± sil; replay etkinse sÄ±nÄ±rlÄ± dene; baÅŸarÄ±lar silinir

Verify: sha256 ve byte sayÄ±mlarÄ±; Ã¶rnekleme ile okuma testleri; rapora yaz

Report/Emit: housekeeping.completed, housekeeping.metrics, rapor (Markdown+HTML) + kart (L22 iÃ§in)

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (housekeeping.request | schedule) â†’ PLAN

PLAN â†’ EXEC (gÃ¶rev sÄ±rasÄ±: emergencyâ†’rollupâ†’dedupâ†’ttlâ†’coldstoreâ†’indexâ†’dlqâ†’verify)

EXEC â†’ adÄ±m adÄ±m housekeeping.progress â†’ VERIFY

VERIFY â†’ EMIT (completed + rapor) â†’ IDLE

Hata: her adÄ±mda ALERT + IDLE (kÄ±smi baÅŸarÄ± raporlanÄ±r)

8) Kenar Durumlar

Low disk space: freePct < minFreePct â†’ emergencyTasks yalnÄ±z; coldstore zorunlu

Coldstore unavailable: coldstore_unavailable uyarÄ±sÄ±; yerel compress+quarantine ile geÃ§ici park

Checksum mismatch: yeniden yÃ¼kle; 2. kez de hatada ALERT ve park

Ethics/WORM: taÅŸÄ±ma/silme giriÅŸimi â†’ worm_protected uyarÄ±sÄ±; yalnÄ±z verify yap

Secrets present: arÅŸive giden dosya L27 sÄ±zÄ±ntÄ± verirse block + secret.quarantine

Busy hours: high priority deÄŸilse throttle; p95 exec limitlerine saygÄ±

Idempotency: aynÄ± hkKey â†’ ikinci Ã§alÄ±ÅŸtÄ±rma planlanmaz

9) Telemetri
{
  "housekeeping.metrics": {
    "event":"housekeeping.metrics","timestamp":"iso8601",
    "planned":1,"completed":1,"failed":0,
    "p50ExecMs":540,"p95ExecMs":920,
    "bytesFreed":8240000000,"filesCompacted":540,"filesArchived":312,
    "dlqReplayed":18,"indexOptimized":{"vector":1,"bm25":1},
    "costEstimateUSD":4.12,"lowSpaceAuto":true
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/runMetricsHousekeeper.ts          # FSM + orchestrator
services/livia/lib/hk/retention.ts               # planlama & TTL
services/livia/lib/hk/rollup.ts                  # timeseries downsample/compact
services/livia/lib/hk/dedup.ts                   # event jsonl tekilleÅŸtirme
services/livia/lib/hk/coldstore.ts               # s3/b2/minio adapter
services/livia/lib/hk/verify.ts                  # checksum & sample read
services/livia/lib/hk/indexOptimize.ts           # L24 kÃ¶prÃ¼sÃ¼ (vector/BM25)
services/livia/lib/hk/dlq.ts                     # L22 DLQ temizlik & replay
services/livia/lib/redact.ts                     # L21 kÃ¶prÃ¼sÃ¼ (rapor)
services/livia/state/housekeeperStore.ts         # idem index + geÃ§miÅŸ raporlar
services/livia/__tests__/runMetricsHousekeeper.test.ts
cfg/livia.housekeeping.yaml

11) Test Ä°skeleti (Jest/Vitest)

Retention/TTL: hotâ†’warmâ†’cold geÃ§iÅŸleri doÄŸru; keepForever klasÃ¶rlerine dokunulmadÄ±

Rollup: 5sâ†’1mâ†’5mâ†’1h seviyeleri Parquetâ€™te doÄŸru aggâ€™lerle Ã¼retildi

Dedup: Â±1s aynÄ± event tek kopya kaldÄ±

Coldstore: multipart upload + checksum doÄŸrulandÄ±; yerel silindi

Index Optimize: frag>%20 â†’ reindex tetiklendi; knowledge.metrics gÃ¼ncellendi

DLQ Replay: en fazla 50 replay; baÅŸarÄ±lar temizlendi, TTL aÅŸanlar silindi

Low Space: emergencyTasks Ã§alÄ±ÅŸtÄ±; bytesFreed>0

Secrets Block: arÅŸive gidecek dosyada sÄ±zÄ±ntÄ± â†’ secret.quarantine + housekeeping.alert

Idempotency: aynÄ± hkKey ikinci Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶nledi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

03:30 cron â†’ PLAN (low space tespit) â†’ EXEC: ttl_enforceâ†’coldstoreâ†’compactâ†’index_optimizeâ†’dlq_cleanup â†’ VERIFY â†’ rapor yazÄ±ldÄ± â†’ housekeeping.completed + kart (L22) daÄŸÄ±tÄ±ldÄ±.

13) SLO

p95 EXEC < 15 dk (derin haftalÄ±k bakÄ±m) / p95 gÃ¼nlÃ¼k < 3 dk

checksum mismatch < %0.1

zero data loss (doÄŸrulama baÅŸarÄ±sÄ±zsa kaldÄ±rma yok)

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-32 Â· realtimeUptimeSLOGuard.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
CanlÄ± besleme/servislerin uptime & tazelik SLOâ€™larÄ±nÄ± anlÄ±k izleyip burn-rate (hata bÃ¼tÃ§esi tÃ¼ketim hÄ±zÄ±) Ã¼zerinden erken uyarÄ± ve otomatik koruma uygula: Ã§ok pencereli (5m/1h/6h/24h) deÄŸerlendirme, failover (yedek feed/endpoint), degrade (Ã¶zellik kÄ±stÄ±rma), gate (L17) ve cooldown (L16) entegrasyonu; etik/uyuma (L26) uygun, daÄŸÄ±tÄ±m (L22) ve digest (L14) dostu Ã§Ä±ktÄ±. TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; TZ=Europe/Istanbul; pencereler: tumbling/sliding (konfig ile)

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy okur, yazÄ±m sistem

Gizlilik: PII yok; serbest metinler L21 ile redakte

Ä°dempotency: sloGuardKey = serviceId + sloKind + triggerType + windowStartISO

Observability: OpenTelemetry spans (slo.collect, slo.eval, slo.trigger, slo.recover) + metrics

Uyum: L17 (gate), L16 (cooldown), L22 (dist), L14 (digest), L23 (policy), L26 (ethics) kÃ¶prÃ¼leri

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "probe.http.result": {
    "event":"probe.http.result","timestamp":"iso8601",
    "serviceId":"order_api|auth_api|kb_api|feed_ws|feed_rest",
    "endpoint":"https://api.example.com/health",
    "ok":true,"status":200,"latencyMs":120
  },

  "feed.tick": {
    "event":"feed.tick","timestamp":"iso8601",
    "serviceId":"feed_ws","symbol":"AVAXUSDT",
    "lagMs": 420, "gapMs": 0
  },

  "heartbeat.missed": {
    "event":"heartbeat.missed","timestamp":"iso8601",
    "serviceId":"feed_ws","missedCount":1,"expectedEveryMs":5000
  },

  "error.event": {
    "event":"error.event","timestamp":"iso8601",
    "serviceId":"order_api","kind":"5xx|timeout|circuit_open",
    "details":"503 from upstream", "count":1
  },

  "circuit.state": {
    "event":"circuit.state","timestamp":"iso8601",
    "serviceId":"order_api","state":"open|half_open|closed","reason":"5xx_spike"
  },

  "failover.done": {
    "event":"failover.done","timestamp":"iso8601",
    "serviceId":"feed_ws","from":"primary","to":"secondary","latencyImpactMs":+40
  },

  "telemetry.slo.status": {
    "event":"telemetry.slo.status","timestamp":"iso8601",
    "slo":"uptime_feed|uptime_order_api|data_freshness|latency_p95",
    "state":"ok|at_risk|breach","window":"5m|1h|6h|24h","burnPct": 7.5
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "slo.guard.triggered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"feed_ws","slo":"uptime_feed",
    "windows":{"5m":{"avail":99.1,"burn":15.0},"1h":{"avail":99.6,"burn":6.2}},
    "trigger":"multi_window_burn",
    "actionPlan":{"failover":"secondary","degrade":["drop_optional_metrics"],"gate":"rate_limit"},
    "severity":"high","hash":"sha256:..."
  },

  "slo.guard.recovered": {
    "event":"slo.guard.recovered","timestamp":"iso8601",
    "serviceId":"feed_ws","slo":"uptime_feed",
    "since":"2025-09-13T18:22:00+03:00","durationMin":18,
    "actionsReverted":["rate_limit","degrade"],"failback":"primary"
  },

  "slo.guard.earlywarn": {
    "event":"slo.guard.earlywarn","timestamp":"iso8601",
    "serviceId":"order_api","slo":"uptime_order_api",
    "windows":{"5m":{"avail":99.7,"burn":8.0}},
    "hint":"If 1h burn > 6x threshold, trigger will fire."
  },

  "slo.guard.card": {
    "event":"slo.guard.card","timestamp":"iso8601",
    "title":"SLO Guard â€” feed_ws (burn 15Ã—/5m)",
    "body":"Failoverâ†’secondary, gate rate-limit, optional metrics kapalÄ±; gÃ¶zlem sÃ¼rÃ¼yor.",
    "severity":"warn","ttlSec":600
  },

  "slo.guard.alert": {
    "event":"slo.guard.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|calc_error|no_budget|failover_failed|circuit_open|recovery_timeout"
  },

  "slo.guard.metrics": {
    "event":"slo.guard.metrics","timestamp":"iso8601",
    "evaluated":320,"triggers":3,"recoveries":2,"earlyWarn":5,
    "p95EvalMs":6.4,"failovers":2,"gates":1,"degrades":2
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  services: {
    feed_ws: {
      sloTargets:{ uptime: 99.9, freshnessLagMsP95: 800 },
      errorBudgetDays: 30,
      windows:["5m","1h","6h","24h"],
      // Google SRE tarzÄ± Ã§ok pencereli tetikleyiciler (Ã¶rnek deÄŸerler)
      burnThresholds:{ "5m": 14.4, "1h": 6.0, "6h": 3.0, "24h": 1.0 },
      actions:{
        failover:{ to:"secondary" },
        degrade:{ drop:["optional_metrics","low_priority_topics"] },
        gate:{ type:"rate_limit", perMin: 60 }
      }
    },
    order_api: {
      sloTargets:{ uptime: 99.95, latencyP95Ms: 900 },
      errorBudgetDays: 30,
      windows:["5m","1h","6h","24h"],
      burnThresholds:{ "5m": 10.0, "1h": 5.0, "6h": 2.5, "24h": 1.0 },
      actions:{
        circuit:{ policy:"open_on_5xx_spike" },
        gate:{ type:"shed_load", dropPct: 0.2 },
        degrade:{ drop:["advanced_routes"] }
      }
    }
  },

  evaluation: {
    slideEverySec: 5,
    calcMode:"fast_ewma|exact",
    minSamplesPerWindow: 5,
    freshnessMetric: "lagMs",  // feed.tick Ã¼zerinden
    availabilityFrom: { httpProbe: true, heartbeat: true, errorEvent: true, circuit: true }
  },

  integrations: {
    gate: "LIVIA-17",     // rate-limit / shed-load
    cooldown: "LIVIA-16", // davranÄ±ÅŸsal uzun etkilerde
    dist: "LIVIA-22",     // kart/uyarÄ± daÄŸÄ±t
    digest: "LIVIA-14",   // gÃ¼nlÃ¼k Ã¶zet
    policy: "LIVIA-23",   // kalÄ±cÄ± deÄŸiÅŸiklik Ã¶nerisi
    ethics: "LIVIA-26"    // kritik bloklara etik onayÄ± (gerekirse)
  },

  failover: {
    enable:true, prefer:"secondary", autoFailback:true,
    guard:{ minStableMin: 10, maxFailoverPerHour: 3 }
  },

  recovery: {
    stableAfterMin: 15, // bu sÃ¼re boyunca burn<threshold
    revertActions:["gate","degrade"], // failback ayrÄ±ca kontrol edilir
    recoveryTimeoutMin: 60
  },

  idempotencyTtlSec: 3600
}

5) Hesaplama (Ã¶zet)

Availability(window) = ok_samples / total_samples (probe+heartbeat+error sinyallerinden birleÅŸik)

Error budget = 1 - SLO_target

Burn-rate(window) = (1 - availability(window)) / error_budget

Trigger kuralÄ±: herhangi bir pencerede burn â‰¥ burnThresholds[window] â†’ trigger

Early warn: en kÄ±sa pencerede burn â‰¥ 0.5 Ã— threshold ve trend â†‘ â†’ earlywarn

Freshness (lag): p95(lagMs) > hedef â†’ availability=0 gibi deÄŸerlendirilir (feed iÃ§in)

6) Pipeline (Kompozisyon)

Collect: probe.http.result, feed.tick, heartbeat.missed, error.event, circuit.state

Aggregate: pencere baÅŸÄ±na availability & lag/latency metriklerini gÃ¼ncelle

Evaluate: burn-rate Ã§ok pencereli; earlywarn/trigger kararÄ±

Plan Actions: failover/degrade/gate/circuit â†’ etik (L26) gerektiriyorsa kontrol

Enforce: L17/L16 kÃ¶prÃ¼leri ile uygulama; baÅŸarÄ±sÄ±zlÄ±kta retry/backoff

Recover: stabilite saÄŸlanÄ±nca eylemleri geri al; failback uygula

Emit: slo.guard.(triggered|recovered|earlywarn|card|metrics|alert); digestâ€™e (L14) sinyal

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (data tick/slide) â†’ EVAL

EVAL â†’ (burnâ‰¥thr) TRIGGER | (warn) EARLYWARN | (ok && actionsActive) RECOVER_CHECK | else IDLE

TRIGGER â†’ ENFORCE (failover/degrade/gate) â†’ MONITOR

MONITOR â†’ (stableâ‰¥N min) RECOVER | (timeout) ALERT(recovery_timeout)

RECOVER â†’ revert + failback â†’ IDLE

Hata: her adÄ±mda ALERT; idem korumasÄ± â†’ aynÄ± pencere & tetikte ikinci tetik yok

8) Kenar Durumlar

Ã–rnek azlÄ±ÄŸÄ±: minSamplesPerWindow altÄ±nda â†’ pencere â€œbelirsizâ€; yalnÄ±z earlywarn Ã¼retilir

AkÄ±ÅŸ kaybÄ± (flatline): heartbeat yok + probe yok â†’ availability 0â€™a Ã§ekilir (fail-fast)

Ãœst Ã¼ste failover: maxFailoverPerHour aÅŸÄ±ldÄ± â†’ sadece degrade/gate

Sahte negatif risk: HTTP 200 ama feed lag yÃ¼ksek â†’ freshness p95 hedefi ihlal ise availability=0 gibi say

Ã‡ok yÃ¼ksek burn kÄ±sa pencerede, uzun pencere normal: failover+gate sÄ±nÄ±rlÄ± sÃ¼re uygula; 6h pencere koruyucu

Circuit open: order_api iÃ§in gate/degrade otomatik devrede; RECOVERâ€™de half-open testleri geÃ§erse failback

RBAC/observer: yalnÄ±z Ã¶zet kart; teknik ayrÄ±ntÄ± maskeli

Idempotency: aynÄ± sloGuardKey ikinci kez eylem doÄŸurmaz; yalnÄ±z card refresh

9) Telemetri
{
  "slo.guard.metrics": {
    "event":"slo.guard.metrics","timestamp":"iso8601",
    "evaluated":320,"triggers":3,"recoveries":2,"earlyWarn":5,
    "p50EvalMs":3.1,"p95EvalMs":6.4,
    "failovers":2,"gates":1,"degrades":2,
    "stableRecoverMinAvg":16
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/realtimeUptimeSLOGuard.ts        # FSM + evaluator + enforcer
services/livia/lib/slo/aggregator.ts            # pencere metrik toplayÄ±cÄ±
services/livia/lib/slo/burn.ts                  # burn-rate hesaplayÄ±cÄ±
services/livia/lib/slo/actions.ts               # failover/degrade/gate/circuit
services/livia/lib/redact.ts                    # LIVIA-21 kÃ¶prÃ¼sÃ¼
services/livia/lib/bridges.ts                   # L16/L17/L22/L23/L26 kÃ¶prÃ¼leri
services/livia/state/sloGuardStore.ts           # idem index + aktif eylemler
services/livia/__tests__/realtimeUptimeSLOGuard.test.ts
cfg/livia.slo.guard.yaml

11) Test Ä°skeleti (Jest/Vitest)

Burn 5m=15Ã—, 1h=6.2Ã—: trigger + failover + gate â†’ card

Freshness p95>target: availability=0 sayÄ±ldÄ±, trigger Ã¼retildi

Earlywarn: 5m burn 0.6Ã—thr â†’ earlywarn + card, trigger yok

Recovery: 15dk stabil â†’ actions reverted + failback

Circuit open: order_api 5xx spike â†’ circuit open + degrade; half-open sonrasÄ± recover

Idempotency: aynÄ± pencere tetik tekrar eylem doÄŸurmadÄ±

Failover limiti: 1 saatte 4. deneme reddedildi, degrade ile yetindi

Low samples: minSamples altÄ± â†’ yalnÄ±z earlywarn

RBAC/observer: Ã¶zet kartta teknik ayrÄ±ntÄ± yok

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

14:02 feed lag p95 â†‘, probe 5xx â†’ 5m burn=15Ã— â†’ TRIGGER: failoverâ†’secondary, gate rate-limit, optional metrics drop

14:20 stabil â†’ RECOVER: gate/degrade kaldÄ±r, 14:25 failbackâ†’primary â†’ slo.guard.recovered

GÃ¼n sonu L14 digest â€œSLO: at_riskâ†’ok, 1 trigger, 1 recoveryâ€ Ã¶zetini iÃ§erir.

13) SLO

p95 evaluate < 10 ms / pencere

yanlÄ±ÅŸ tetik (false positive) â‰¤ %1; kaÃ§Ä±rma (false negative) â‰¤ %1

recovery MTTR â‰¤ 20 dk (failover+gate ile)

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-33 Â· incidentDrillScheduler.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
GerÃ§ek olaylara hazÄ±rlanmak iÃ§in dÃ¼zenli tatbikatlar (drill/game-day) planlayÄ±p yÃ¼rÃ¼tmek: senaryo seÃ§, kaos enjeksiyonu (L29) veya sentetik olay Ã¼ret, isteÄŸe baÄŸlÄ± runbook yÃ¼rÃ¼t (L28), ekip tepkisini Ã¶lÃ§ (TTD/TTA/TTR), puan kartÄ±/rapor Ã¼ret, liderlik tablosu gÃ¼ncelle, Ã¶zeti daÄŸÄ±t (L22) ve KBâ€™ye indeksle (L24). TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; Ã¼retimde gÃ¼venli/izole (â€œDRILL/SHADOWâ€) Ã§alÄ±ÅŸÄ±r.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel pencere 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: qa|ops|policy baÅŸlatÄ±r/okur; observer sÄ±nÄ±rlÄ± okur

Gizlilik: PII yok; serbest metinler LIVIA-21 ile redakte

Ä°dempotency: drillKey = campaignId + scenarioSlug + forDate + mode

Observability: OpenTelemetry spans (drill.plan, drill.inject, drill.run, drill.score, drill.report) + metrics

GÃ¼venli Modlar: shadow|sandbox (default) â€” prod karar/iÅŸ akÄ±ÅŸlarÄ±nÄ± etkilemez; live_fire sadece L05 onayÄ± + L26 uygunluk ile

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "drill.template.updated": {
    "event":"drill.template.updated","timestamp":"iso8601",
    "scenarioSlug":"feed-lag-canary-failover",
    "title":"Feed Lag â†’ Canary Failover",
    "difficulty":"easy|medium|hard",
    "steps":[
      {"id":"t1","kind":"inject", "params":{"fault":{"type":"spike","series":"feed.lagMs","mult":1.8}}},
      {"id":"t2","kind":"expect", "params":{"signal":"slo.guard.triggered","withinMin":10}},
      {"id":"t3","kind":"runbook", "params":{"runbookId":"rb-latency-slip-hotfix","optional":true}}
    ],
    "successCriteria":{"TTA_min":10,"TTR_min":30,"expectSignals":["slo.guard.triggered","slo.guard.recovered"]}
  },

  "drill.plan.request": {
    "event":"drill.plan.request","timestamp":"iso8601",
    "campaignId":"dr-2025-09-15-A",
    "forDate":"2025-09-15","mode":"shadow|sandbox|live_fire",
    "scope":"global|desk|symbol","symbol":"AVAXUSDT|null",
    "scenarioSlug":"feed-lag-canary-failover",
    "notify":["ops","policy"],"stealth":false,"dryRun":false
  },

  "drill.run.request": {
    "event":"drill.run.request","timestamp":"iso8601",
    "campaignId":"dr-2025-09-15-A","startAt":"2025-09-15T14:05:00+03:00"
  },

  "calendar.blackout": {
    "event":"calendar.blackout","timestamp":"iso8601",
    "windows":[{"from":"09:55","to":"10:15"},{"from":"22:00","to":"07:00"}],
    "reason":"market open|night ops"
  },

  "incident.started": {
    "event":"incident.started","timestamp":"iso8601",
    "id":"inc-2025-09-15-1","severity":"high","title":"(real) slip spike"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "drill.planned": {
    "event":"drill.planned","timestamp":"iso8601",
    "drillKey":"sha256:...","campaignId":"dr-2025-09-15-A",
    "scenarioSlug":"feed-lag-canary-failover","mode":"shadow",
    "startAt":"2025-09-15T14:05:00+03:00",
    "flags":{"DRILL":true,"SHADOW":true}
  },

  "drill.run.started": {
    "event":"drill.run.started","timestamp":"iso8601",
    "drillKey":"sha256:...","campaignId":"dr-2025-09-15-A",
    "steps":["t1","t2","t3"],"participants":["ops","policy"]
  },

  "drill.injection.emitted": {
    "event":"drill.injection.emitted","timestamp":"iso8601",
    "campaignId":"dr-2025-09-15-A",
    "via":"LIVIA-29","fault":{"type":"spike","series":"feed.lagMs","mult":1.8},
    "count":120,"flags":{"DRILL":true,"SHADOW":true}
  },

  "drill.step.progress": {
    "event":"drill.step.progress","timestamp":"iso8601",
    "campaignId":"dr-2025-09-15-A","stepId":"t2",
    "status":"ok|timeout|skipped","details":"slo.guard.triggered within 6m"
  },

  "drill.run.completed": {
    "event":"drill.run.completed","timestamp":"iso8601",
    "campaignId":"dr-2025-09-15-A",
    "result":"success|partial|failed",
    "kpis":{"TTD_sec":180,"TTA_sec":240,"TTR_min":22,"falsePositive":0},
    "score":86
  },

  "drill.report.ready": {
    "event":"drill.report.ready","timestamp":"iso8601",
    "campaignId":"dr-2025-09-15-A",
    "path":"data/drills/2025-09/dr-2025-09-15-A/report.md",
    "summary":"TTD 3dk â€¢ TTA 4dk â€¢ TTR 22dk â€¢ Beklenen sinyaller karÅŸÄ±landÄ± â€¢ Skor 86/100.",
    "hash":"sha256:..."
  },

  "drill.leaderboard.updated": {
    "event":"drill.leaderboard.updated","timestamp":"iso8601",
    "period":"2025-Q3","entries":[{"team":"ops","avgScore":82.4},{"team":"policy","avgScore":79.1}]
  },

  "drill.card": {
    "event":"drill.card","timestamp":"iso8601",
    "title":"Tatbikat Tamam â€” dr-2025-09-15-A",
    "body":"Skor 86 â€¢ TTA 4dk â€¢ TTR 22dk â€¢ Beklenen sinyaller karÅŸÄ±landÄ±.",
    "severity":"info","ttlSec":900
  },

  "drill.alert": {
    "event":"drill.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|blackout|real_incident_overlap|approval_required|ethics_denied|inject_failed|timeout"
  },

  "drill.metrics": {
    "event":"drill.metrics","timestamp":"iso8601",
    "planned":1,"started":1,"completed":1,"failed":0,
    "avgScore":86,"p95TTD_sec":220,"p95TTA_sec":300,"p95TTR_min":28
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  schedule:{
    cronWeekly:"Wed 14:00",         // haftalÄ±k tatbikat
    notifyBeforeMin: 15,
    avoidBlackouts:true,
    cancelOnRealIncident:true
  },

  modes:{
    default:"shadow",
    allow:["shadow","sandbox","live_fire"], // live_fire â†’ L05 + L26 zorunlu
    liveFireGuards:{ maxPerQuarter:1, requireApprovers:["policy-lead","compliance-lead"] }
  },

  scoring:{
    weights:{ TTD:0.25, TTA:0.25, TTR:0.30, playbook:0.10, comms:0.05, signals:0.05 },
    bands:{ success: "score>=80", partial: "60<=score<80", failed: "<60" },
    srtTargets:{ TTD_sec:240, TTA_sec:300, TTR_min:30 }  // SRT = service response targets
  },

  integrations:{
    fuzzer:"LIVIA-29",
    runbook:"LIVIA-28",
    dist:"LIVIA-22",
    kb:"LIVIA-24",
    digest:"LIVIA-14",
    ethics:"LIVIA-26",
    approvals:"LIVIA-05"
  },

  redactionProfile:"generic",   // L21
  idempotencyTtlSec: 86400
}

5) KPI & Skor HesabÄ± (Ã¶zet)

TTD (Time-to-Detect): ilk beklenen sinyalin (Ã¶rn. slo.guard.triggered) drill baÅŸlangÄ±cÄ±ndan sÃ¼resi

TTA (Time-to-Acknowledge): ilk insan/onay/komut geri bildirimi (approval.granted|runbook.exec.started)

TTR (Time-to-Resolve): drill.successCriteria.expectSignals tamamlanana kadar sÃ¼re (Ã¶rn. slo.guard.recovered)

Playbook Uyum: L28 adÄ±mlarÄ±nÄ±n zamanÄ±nda/sÄ±ralÄ± Ã§alÄ±ÅŸmasÄ± (% tamamlama)

Comms: L22 ile bilgilendirme sayÄ±sÄ±/latency (ops/policy kanallarÄ±)

Signals: beklenen sinyallerin oranÄ± (tam/eksik)

Skor = normalize(KPI) â‹… weights â†’ 0â€“100

6) Pipeline (Kompozisyon)

Plan: drill.plan.request veya weekly cron â†’ blackout ve gerÃ§ek olay takvimiyle Ã§akÄ±ÅŸma kontrolÃ¼ â†’ drill.planned

Authorize: live_fire ise L05 onay + L26 ethics; aksi halde DRILL/SHADOW bayraklarÄ± zorunlu

Inject: L29 ile kaos/sentetik olaylar (iÅŸaretli) veya yalnÄ±z â€œbekle-ve-doÄŸrulaâ€ senaryolarÄ±

Runbook (opsiyonel): L28 ile ÅŸablon adÄ±mlarÄ± tetikle (dryRun varsayÄ±lan)

Observe: Sinyal yakalama (L32/L17/L16/L23/L22 olay akÄ±ÅŸÄ±ndan)

Score: KPIâ€™larÄ± topla, baÅŸarÄ± durumunu ve puanÄ± hesapla

Report: Markdown/HTML rapor oluÅŸtur; L21 redaksiyon; dosyaya yaz

Distribute & Index: drill.card â†’ L22; rapor â†’ L24 KB

Emit Metrics: drill.metrics + dÃ¶nemlik drill.leaderboard.updated

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (drill.plan.request | schedule) â†’ PLAN

PLAN â†’ (blackout/real incident?) CANCEL | else ARM

ARM â†’ (drill.run.request | startAt reached) â†’ INJECT

INJECT â†’ (ok) OBSERVE | (inject_failed) ALERT

OBSERVE â†’ (criteria met) SCORE | (timeout) SCORE(partial/failed)

SCORE â†’ REPORT â†’ EMIT â†’ IDLE

Hata: her adÄ±mda drill.alert(...) + IDLE

8) Kenar Durumlar

GerÃ§ek Olay Ã‡akÄ±ÅŸmasÄ±: incident.started geldiyse drill hemen iptal (cancel) + uyarÄ±

Blackout Penceresi: plan/baÅŸlangÄ±Ã§ blackoutâ€™a denk gelirse otomatik erteleme

Live-fire: yalnÄ±z explicit onay + etik geÃ§iÅŸ ile; tÃ¼m eylemler geri alÄ±nabilir; riskli adÄ±mlar dryRunâ€™a dÃ¼ÅŸÃ¼rÃ¼lebilir

KatÄ±lÄ±mcÄ± Bilgilendirme: stealth=false ise startâ€™tan 15dk Ã¶nce L22 ile uyarÄ± kartÄ±; stealth=true ise sadece QA/policy

Ä°dempotent Plan: aynÄ± drillKey ikinci kez planlanmaz; start Ã§aÄŸrÄ±larÄ± resume davranÄ±r

Veri Etkisi: DRILL/SHADOW bayraklarÄ± digest (L14) iÃ§inde ayrÄ± raporlanÄ±r; prod KPIâ€™lara katÄ±lmaz

9) Telemetri
{
  "drill.metrics": {
    "event":"drill.metrics","timestamp":"iso8601",
    "planned":1,"started":1,"completed":1,"failed":0,
    "avgScore":86,"p50TTD_sec":180,"p95TTD_sec":220,
    "p95TTA_sec":300,"p95TTR_min":28,"reports":1
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/incidentDrillScheduler.ts        # FSM + scheduler + scorer
services/livia/lib/drill/templates.ts           # senaryo ÅŸablonlarÄ±
services/livia/lib/drill/inject.ts              # L29 kÃ¶prÃ¼sÃ¼
services/livia/lib/drill/observe.ts             # sinyal toplayÄ±cÄ± (L32/L17/L16/L23/L22)
services/livia/lib/drill/score.ts               # KPI & puan
services/livia/lib/drill/report.ts              # md/html raporlayÄ±cÄ±
services/livia/lib/redact.ts                    # LIVIA-21 kÃ¶prÃ¼sÃ¼
services/livia/state/drillStore.ts              # idem index + leaderboard
services/livia/__tests__/incidentDrillScheduler.test.ts
cfg/livia.drill.yaml

11) Test Ä°skeleti (Jest/Vitest)

Plan/Blackout: blackout penceresinde plan iptal/erteleme

Inject: L29 spike/delay/duplicate ile iÅŸaretli enjeksiyon; prod akÄ±ÅŸ etkilenmedi

Observe: beklenen sinyaller bulundu; timeout senaryosunda partial/failed

Runbook: L28 adÄ±mlarÄ± Ã§alÄ±ÅŸtÄ±; onay varsa gateway ile tamamlandÄ±

Score: KPIâ†’skor aÄŸÄ±rlÄ±klarÄ± doÄŸru; success/partial/failed bandlarÄ±

Report: md/html yazÄ±ldÄ±; L24â€™e indekslendi; L22 kart daÄŸÄ±tÄ±ldÄ±

Idempotency: aynÄ± drillKey tekrar planlanmadÄ±; run Ã§aÄŸrÄ±sÄ± resume etti

Live-fire gÃ¼venliÄŸi: L05/L26 onayÄ± olmadan baÅŸlamaz

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

Ã‡ar 14:00 otomatik plan â†’ 14:05 start â†’ L29 spike enjekte â†’ 6 dkâ€™da slo.guard.triggered â†’ L28 runbook s1 tamam â†’ 22 dkâ€™da slo.guard.recovered â†’ skor 86 â†’ rapor yazÄ±ldÄ± â†’ kart daÄŸÄ±tÄ±ldÄ± â†’ KBâ€™ye iÅŸlendi.

13) SLO

p95 planâ†’start koordinasyonu < 200 ms

yanlÄ±ÅŸ pozitif prod etkisi = 0 (DRILL/SHADOW ayrÄ±mÄ±)

Rapor Ã¼retim p95 < 90 ms

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-34 Â· realtimeCostGuard.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Bulut/LLM/vektÃ¶r indeks/daÄŸÄ±tÄ±m/depolama maliyetlerini anlÄ±k izleyip bÃ¼tÃ§e/SLO hedeflerine gÃ¶re erken uyarÄ± ve otomatik frenleme uygulamak: Ã§ok pencereli (1h/6h/24h/7d) harcama-burn analizi, tahmin/forecast, aksiyon planÄ± (downgrade, throttle, batch, erteleme), rapor ve kart Ã¼retimi. L22 (daÄŸÄ±tÄ±m), L24 (KB), L31 (housekeeper), L23 (policy), L26 (etik) ve L29/L33 (test/drill verisi ayÄ±rma) ile entegre. TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; TZ=Europe/Istanbul; pencereler: sliding (varsayÄ±lan)

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy|finance okur; yazÄ±m sistem

Gizlilik: PII yok; rapor metinleri L21 ile redakte

Ä°dempotency: costGuardKey = scope + component + trigger + windowStartISO

Observability: OpenTelemetry spans (cost.collect, cost.eval, cost.plan, cost.enforce, cost.recover) + metrics

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "billing.usage.sample": {
    "event":"billing.usage.sample","timestamp":"iso8601",
    "provider":"aws|gcp|azure|openai|local|vector|dist|storage",
    "component":"embeddings|reranker|vector_query|vector_upsert|dist_push|html_render|coldstore_put|compute_min",
    "unit":"tokens|req|GB|GB_day|min",
    "qty": 125000,
    "pricePerUnit": 0.0000005,
    "tags":{"namespace":"kb_default","channel":"slack|webhook|ui","DRILL":false,"SHADOW":false}
  },

  "billing.estimate.update": {
    "event":"billing.estimate.update","timestamp":"iso8601",
    "provider":"openai|vector|storage",
    "component":"embeddings|vector_query|coldstore_put",
    "window":"1h|6h|24h|7d",
    "estimateUSD": 12.34,
    "method":"ewma|mvavg|provider_report"
  },

  "provider.rate.update": {
    "event":"provider.rate.update","timestamp":"iso8601",
    "provider":"openai|vector|s3|slack","component":"embeddings|vector_query|coldstore_put|webhook",
    "unit":"tokens|req|GB|GB_day|min","pricePerUnit": 0.00000045,"currency":"USD"
  },

  "budget.config.updated": {
    "event":"budget.config.updated","timestamp":"iso8601",
    "scope":"global|desk|symbol","symbol":"AVAXUSDT|null",
    "period":"daily|weekly|monthly",
    "component":"*|embeddings|vector_query|dist_push|storage|compute|misc",
    "limitUSD": 150.0,
    "softGuardPct": 0.7, "hardGuardPct": 0.9
  },

  "job.cost.estimate": {
    "event":"job.cost.estimate","timestamp":"iso8601",
    "job":"kb.reindex|digest.compose|sim.run|dist.broadcast",
    "component":"vector_upsert|embeddings|html_render|dist_push",
    "expectedUSD": 4.20, "canDefer": true, "deadlineISO":"2025-09-16T03:00:00+03:00"
  },

  "dist.sent": {
    "event":"dist.sent","timestamp":"iso8601",
    "channel":"slack|webhook|email|ui","bytes": 24500,"messages": 3
  },

  "kb.query.executed": {
    "event":"kb.query.executed","timestamp":"iso8601",
    "namespace":"kb_default","mode":"hybrid|lexical|vector","topK":8,"reranker":true
  }
}


Not: tags.DRILL/SHADOW = true (L29/L33) olan Ã¶lÃ§Ã¼mler default olarak bÃ¼tÃ§e dÄ±ÅŸÄ± raporlanÄ±r.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "cost.guard.triggered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "scope":"global","component":"embeddings",
    "windows":{"1h":{"spendUSD":6.2,"burnPct":1.8},"24h":{"spendUSD":92.4,"burnPct":0.93}},
    "budget":{"period":"daily","limitUSD":100,"softGuardPct":0.7,"hardGuardPct":0.9},
    "trigger":"hard_guard_cross|forecast_breach|rate_spike",
    "actionPlan":{
      "downgrade":{"model":"text-embedding-3-small"},
      "reduce":{"kb.topK":6,"bm25K":30},
      "disable":{"reranker":true},
      "batch":{"embeddings.batch":32},
      "deferJobs":["kb.reindex"]
    },
    "severity":"high","hash":"sha256:..."
  },

  "cost.guard.recovered": {
    "event":"cost.guard.recovered","timestamp":"iso8601",
    "scope":"global","component":"embeddings",
    "since":"2025-09-15T14:10:00+03:00","durationMin":26,
    "actionsReverted":["reranker_disable","topK_reduce"],"jobsResumed":["kb.reindex"]
  },

  "cost.guard.earlywarn": {
    "event":"cost.guard.earlywarn","timestamp":"iso8601",
    "scope":"global","component":"vector_query",
    "windows":{"6h":{"spendUSD":18.1,"burnPct":0.68}},
    "hint":"7d trend EWMA yukarÄ±; topK=8â†’6 ve reranker kapatma ile %28 dÃ¼ÅŸÃ¼ÅŸ Ã¶ngÃ¶rÃ¼lÃ¼yor."
  },

  "cost.report.ready": {
    "event":"cost.report.ready","timestamp":"iso8601",
    "period":"daily","forDate":"2025-09-15",
    "path":"data/cost/2025-09-15/report.md",
    "summary":"GÃ¼nlÃ¼k harcama $128 â€¢ Embeddings $92 (âˆ’%19 aksiyon sonrasÄ±) â€¢ Vector $24 â€¢ Dist $6 â€¢ Storage $6.",
    "hash":"sha256:..."
  },

  "cost.guard.card": {
    "event":"cost.guard.card","timestamp":"iso8601",
    "title":"Maliyet Guard â€” Embeddings (hard %90 aÅŸÄ±ldÄ±)",
    "body":"Model downgraded â€¢ topK 8â†’6 â€¢ reranker kapalÄ± â€¢ reindex ertelendi.",
    "severity":"warn","ttlSec":900
  },

  "cost.guard.alert": {
    "event":"cost.guard.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|unknown_rate|forecast_error|enforce_failed|rbac_denied|ethics_denied"
  },

  "cost.guard.metrics": {
    "event":"cost.guard.metrics","timestamp":"iso8601",
    "evaluated":420,"triggers":3,"recoveries":2,"earlyWarn":6,
    "p95EvalMs":6.2,"savingsUSD":28.4,"jobsDeferred":2,"actions":{"downgrade":2,"reduce":3,"disable":2,"batch":2}
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul", currency:"USD" },

  windows:["1h","6h","24h","7d"],

  budgets:{
    daily:{ limitUSD: 100, softGuardPct: 0.7, hardGuardPct: 0.9 },
    weekly:{ limitUSD: 500, softGuardPct: 0.7, hardGuardPct: 0.9 },
    monthly:{ limitUSD: 2000, softGuardPct: 0.7, hardGuardPct: 0.9 }
  },

  perComponent:{
    embeddings:{ sharePctMaxDaily: 0.55, allowDowngrade:true, minBatch:16, maxBatch:64 },
    vector_query:{ topKDefault:8, topKMin:4, allowDisableReranker:true },
    vector_upsert:{ maxPerHour: 20000, deferIfHardGuard:true },
    dist_push:{ throttlePerMin: 30, bigMsgBytes: 48_000, dropChannels:["webhook"] },
    storage:{ preferColdstore:true, forceCompression:true },
    compute:{ capMinPerDay: 120 },
    html_render:{ limitRendersPerHr: 200 }
  },

  forecast:{
    method:"ewma",
    alpha:0.3,
    horizonHours:24,
    includeRates:true
  },

  exclusions:{
    drillShadowExclude:true,     // L29/L33 DRILL|SHADOW â†’ bÃ¼tÃ§e dÄ±ÅŸÄ±
    namespaces:["kb_default"]    // opsiyonel dahil/dÄ±ÅŸla listesi
  },

  actions:{
    downgrade:{ embeddings:{ model:"text-embedding-3-small" } },
    reduce:{ "kb.topK":6, "bm25K":30 },
    disable:{ reranker:true },
    batch:{ "embeddings.batch":32 },
    deferJobs:["kb.reindex","sim.run"],   // L24/L25
    throttle:{ "dist.push.perMin": 20 }
  },

  integrations:{
    dist:"LIVIA-22",
    kb:"LIVIA-24",
    housekeeping:"LIVIA-31",
    policy:"LIVIA-23",
    ethics:"LIVIA-26"
  },

  evaluation:{
    slideEverySec:5,
    minSamplesPerWindow:3,
    currency:"USD",
    rateFallback: { defaultPricePerUnit: 0.0 }   // oran bilinmezse estimate-only
  },

  idempotencyTtlSec: 3600
}

5) Hesaplama (Ã¶zet)

Spend(window) = Î£(qty Ã— pricePerUnit) [DRILL/SHADOW hariÃ§]

Budget burn(window, period) = SpendPeriod / LimitPeriod

Forecast breach = EWMA(trend) ile t+H dÃ¶nemde %soft|%hard aÅŸÄ±m olasÄ±lÄ±ÄŸÄ± > eÅŸiÄŸe gelirse erken uyarÄ±

Rate spike = pricePerUnit deÄŸiÅŸimi %Î” > eÅŸiÄŸe â†’ tetik

Savings estimate = aksiyon planÄ± simÃ¼lasyonuyla (topKâ†“, reranker off, downgrade, batchâ†‘) dÃ¼ÅŸÃ¼ÅŸ yÃ¼zdesi

6) Pipeline (Kompozisyon)

Collect: billing.usage.sample|estimate.update|provider.rate.update|job.cost.estimate|dist.sent|kb.query.executed

Normalize: oran/para birimi; DRILL/SHADOW etiketli Ã¶rnekleri ayrÄ±ÅŸtÄ±r

Aggregate: pencere ve dÃ¶nem bazÄ±nda spend/burn + EWMA forecast

Evaluate: soft/hard guard, forecast_breach, rate_spike kurallarÄ±

Plan Actions: perComponent + global actions birleÅŸimi; Ã§akÄ±ÅŸma varsa en maliyet dÃ¼ÅŸÃ¼rÃ¼cÃ¼ yol

Enforce:

L24: kb.search parametrelerini (topK/reranker) dÃ¼ÅŸÃ¼r

Embeddings: model downgrade + batch ayarÄ±

L22: kanal throttle/drop (webhook gibi masraflÄ±)

L31: coldstore+compression zorunlu

L23: kalÄ±cÄ± politika Ã¶nerisi gerekiyorsa patch Ã¶ner

L26: kritik kesintiler (Ã¶r. full disable) etik kapÄ±dan geÃ§er

Recover: burn normale dÃ¶nÃ¼nce aksiyonlarÄ± geri al; ertelenen iÅŸleri sÄ±rala

Report: gÃ¼nlÃ¼k cost.report.ready (MD/HTML) + kart; KBâ€™ye indeksle (L24)

Emit: cost.guard.(triggered|recovered|earlywarn|card|metrics|alert)

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (veri akÄ±ÅŸÄ±/slide) â†’ EVAL

EVAL â†’ (hard/soft/forecast/spike) TRIGGER | (warn) EARLYWARN | (ok && actionsActive) RECOVER_CHECK | else IDLE

TRIGGER â†’ ENFORCE (downgrade/reduce/disable/batch/defer/throttle) â†’ MONITOR

MONITOR â†’ (stableâ‰¥N) RECOVER | (timeout) ALERT(enforce_failed)

RECOVER â†’ revert + jobs resume â†’ IDLE

Hata: ALERT + IDLE

8) Kenar Durumlar

Unknown rate: rateFallback.defaultPricePerUnit ile estimate; unknown_rate uyarÄ±sÄ±

Provider credit/negatif satÄ±r: negatif qtyÃ—price â†’ ayrÄ± credits hanesine yaz; burnâ€™den dÃ¼ÅŸ

GeÃ§ gelen faturalama: geriye dÃ¶nÃ¼k dÃ¼zeltmeler â†’ â€œretroactiveâ€ olarak iÅŸaretlenir; idempotency ile Ã§ift sayÄ±m yok

DRILL/SHADOW: bÃ¼tÃ§e dÄ±ÅŸÄ±nda rapor; yine de cost.reportâ€™ta ayrÄ± bÃ¶lÃ¼m

AÅŸÄ±rÄ± throttle riski: L32 SLO Guard ile Ã§eliÅŸirse throttle derecesi dÃ¼ÅŸÃ¼r; SLO â‰¥ hedef korunur

Policy gerekiyorsa: kalÄ±cÄ± deÄŸiÅŸim (model/param) iÃ§in L23â€™e patch Ã¶nerisi

Finance gÃ¶rÃ¼nÃ¼mÃ¼: RBAC finance rolÃ¼ tÃ¼m kalemleri gÃ¶rÃ¼r; observer Ã¶zet gÃ¶rÃ¼r

Idempotency: aynÄ± costGuardKey iÃ§in ikinci tetik eylem doÄŸurmaz; yalnÄ±z card yenilenir

9) Telemetri
{
  "cost.guard.metrics": {
    "event":"cost.guard.metrics","timestamp":"iso8601",
    "evaluated":420,"triggers":3,"recoveries":2,"earlyWarn":6,
    "p50EvalMs":3.0,"p95EvalMs":6.2,
    "savingsUSD":28.4,"jobsDeferred":2,
    "actions":{"downgrade":2,"reduce":3,"disable":2,"batch":2,"throttle":1}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/realtimeCostGuard.ts             # FSM + evaluator + enforcer
services/livia/lib/cost/aggregator.ts           # pencere & dÃ¶nem toplama
services/livia/lib/cost/forecast.ts             # EWMA/MVAVG tahmin
services/livia/lib/cost/actions.ts              # downgrade/reduce/disable/batch/throttle/defer
services/livia/lib/cost/rates.ts                # provider rate cache & update
services/livia/lib/bridges.ts                   # L22/L24/L31/L23/L26 entegrasyonlarÄ±
services/livia/state/costGuardStore.ts          # idem index + aktif aksiyonlar
services/livia/__tests__/realtimeCostGuard.test.ts
cfg/livia.cost.guard.yaml

11) Test Ä°skeleti (Jest/Vitest)

Hard guard: gÃ¼nlÃ¼k $100 limit, spend $92 + forecast $105 â†’ trigger + aksiyon planÄ±

Rate spike: price +%30 â†’ trigger (reduce+downgrade)

Early warn: 6h burn 0.68 â†’ earlywarn + Ã¶neri

Recover: burn < soft â†’ aksiyonlar geri alÄ±ndÄ±, ertelenen iÅŸler devam

Unknown rate: fallback estimate + alert

DRILL/SHADOW: bÃ¼tÃ§e dÄ±ÅŸÄ±; raporda ayrÄ±

SLO uyumu: throttle SLO ile Ã§eliÅŸmedi; L32 sinyalleriyle downgrade hafifletildi

Idempotency: aynÄ± pencere tetikte tekrar eylem yok

RBAC: finance tam, observer Ã¶zet gÃ¶rÃ¼nÃ¼r

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

13:40 embeddings spend artÄ±ÅŸÄ± â†’ 24h burn 0.93 & forecast breach â†’ TRIGGER

Aksiyon: model downgrade, topK 8â†’6, reranker off, reindex defer â†’ card

14:10â€“14:36 harcama hÄ±zÄ± dÃ¼ÅŸer â†’ RECOVER: parametreler geri, reindex sÃ¼resi planlanÄ±r

GÃ¼n sonu cost.report.ready â†’ L22 daÄŸÄ±tÄ±m, L24 indeks.

13) SLO

p95 evaluate < 10 ms / pencere

YanlÄ±ÅŸ tetik â‰¤ %1, kaÃ§Ä±rma â‰¤ %1

Tasarruf etki (plan sonrasÄ± 1h) â‰¥ %15 hedefi

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-34 Â· realtimeCostGuard.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Bulut/LLM/vektÃ¶r indeks/daÄŸÄ±tÄ±m/depolama maliyetlerini anlÄ±k izleyip bÃ¼tÃ§e/SLO hedeflerine gÃ¶re erken uyarÄ± ve otomatik frenleme uygulamak: Ã§ok pencereli (1h/6h/24h/7d) harcama-burn analizi, tahmin/forecast, aksiyon planÄ± (downgrade, throttle, batch, erteleme), rapor ve kart Ã¼retimi. L22 (daÄŸÄ±tÄ±m), L24 (KB), L31 (housekeeper), L23 (policy), L26 (etik) ve L29/L33 (test/drill verisi ayÄ±rma) ile entegre. TÃ¼m I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; TZ=Europe/Istanbul; pencereler: sliding (varsayÄ±lan)

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy|finance okur; yazÄ±m sistem

Gizlilik: PII yok; rapor metinleri L21 ile redakte

Ä°dempotency: costGuardKey = scope + component + trigger + windowStartISO

Observability: OpenTelemetry spans (cost.collect, cost.eval, cost.plan, cost.enforce, cost.recover) + metrics

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "billing.usage.sample": {
    "event":"billing.usage.sample","timestamp":"iso8601",
    "provider":"aws|gcp|azure|openai|local|vector|dist|storage",
    "component":"embeddings|reranker|vector_query|vector_upsert|dist_push|html_render|coldstore_put|compute_min",
    "unit":"tokens|req|GB|GB_day|min",
    "qty": 125000,
    "pricePerUnit": 0.0000005,
    "tags":{"namespace":"kb_default","channel":"slack|webhook|ui","DRILL":false,"SHADOW":false}
  },

  "billing.estimate.update": {
    "event":"billing.estimate.update","timestamp":"iso8601",
    "provider":"openai|vector|storage",
    "component":"embeddings|vector_query|coldstore_put",
    "window":"1h|6h|24h|7d",
    "estimateUSD": 12.34,
    "method":"ewma|mvavg|provider_report"
  },

  "provider.rate.update": {
    "event":"provider.rate.update","timestamp":"iso8601",
    "provider":"openai|vector|s3|slack","component":"embeddings|vector_query|coldstore_put|webhook",
    "unit":"tokens|req|GB|GB_day|min","pricePerUnit": 0.00000045,"currency":"USD"
  },

  "budget.config.updated": {
    "event":"budget.config.updated","timestamp":"iso8601",
    "scope":"global|desk|symbol","symbol":"AVAXUSDT|null",
    "period":"daily|weekly|monthly",
    "component":"*|embeddings|vector_query|dist_push|storage|compute|misc",
    "limitUSD": 150.0,
    "softGuardPct": 0.7, "hardGuardPct": 0.9
  },

  "job.cost.estimate": {
    "event":"job.cost.estimate","timestamp":"iso8601",
    "job":"kb.reindex|digest.compose|sim.run|dist.broadcast",
    "component":"vector_upsert|embeddings|html_render|dist_push",
    "expectedUSD": 4.20, "canDefer": true, "deadlineISO":"2025-09-16T03:00:00+03:00"
  },

  "dist.sent": {
    "event":"dist.sent","timestamp":"iso8601",
    "channel":"slack|webhook|email|ui","bytes": 24500,"messages": 3
  },

  "kb.query.executed": {
    "event":"kb.query.executed","timestamp":"iso8601",
    "namespace":"kb_default","mode":"hybrid|lexical|vector","topK":8,"reranker":true
  }
}


Not: tags.DRILL/SHADOW = true (L29/L33) olan Ã¶lÃ§Ã¼mler default olarak bÃ¼tÃ§e dÄ±ÅŸÄ± raporlanÄ±r.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "cost.guard.triggered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "scope":"global","component":"embeddings",
    "windows":{"1h":{"spendUSD":6.2,"burnPct":1.8},"24h":{"spendUSD":92.4,"burnPct":0.93}},
    "budget":{"period":"daily","limitUSD":100,"softGuardPct":0.7,"hardGuardPct":0.9},
    "trigger":"hard_guard_cross|forecast_breach|rate_spike",
    "actionPlan":{
      "downgrade":{"model":"text-embedding-3-small"},
      "reduce":{"kb.topK":6,"bm25K":30},
      "disable":{"reranker":true},
      "batch":{"embeddings.batch":32},
      "deferJobs":["kb.reindex"]
    },
    "severity":"high","hash":"sha256:..."
  },

  "cost.guard.recovered": {
    "event":"cost.guard.recovered","timestamp":"iso8601",
    "scope":"global","component":"embeddings",
    "since":"2025-09-15T14:10:00+03:00","durationMin":26,
    "actionsReverted":["reranker_disable","topK_reduce"],"jobsResumed":["kb.reindex"]
  },

  "cost.guard.earlywarn": {
    "event":"cost.guard.earlywarn","timestamp":"iso8601",
    "scope":"global","component":"vector_query",
    "windows":{"6h":{"spendUSD":18.1,"burnPct":0.68}},
    "hint":"7d trend EWMA yukarÄ±; topK=8â†’6 ve reranker kapatma ile %28 dÃ¼ÅŸÃ¼ÅŸ Ã¶ngÃ¶rÃ¼lÃ¼yor."
  },

  "cost.report.ready": {
    "event":"cost.report.ready","timestamp":"iso8601",
    "period":"daily","forDate":"2025-09-15",
    "path":"data/cost/2025-09-15/report.md",
    "summary":"GÃ¼nlÃ¼k harcama $128 â€¢ Embeddings $92 (âˆ’%19 aksiyon sonrasÄ±) â€¢ Vector $24 â€¢ Dist $6 â€¢ Storage $6.",
    "hash":"sha256:..."
  },

  "cost.guard.card": {
    "event":"cost.guard.card","timestamp":"iso8601",
    "title":"Maliyet Guard â€” Embeddings (hard %90 aÅŸÄ±ldÄ±)",
    "body":"Model downgraded â€¢ topK 8â†’6 â€¢ reranker kapalÄ± â€¢ reindex ertelendi.",
    "severity":"warn","ttlSec":900
  },

  "cost.guard.alert": {
    "event":"cost.guard.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|unknown_rate|forecast_error|enforce_failed|rbac_denied|ethics_denied"
  },

  "cost.guard.metrics": {
    "event":"cost.guard.metrics","timestamp":"iso8601",
    "evaluated":420,"triggers":3,"recoveries":2,"earlyWarn":6,
    "p95EvalMs":6.2,"savingsUSD":28.4,"jobsDeferred":2,"actions":{"downgrade":2,"reduce":3,"disable":2,"batch":2}
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul", currency:"USD" },

  windows:["1h","6h","24h","7d"],

  budgets:{
    daily:{ limitUSD: 100, softGuardPct: 0.7, hardGuardPct: 0.9 },
    weekly:{ limitUSD: 500, softGuardPct: 0.7, hardGuardPct: 0.9 },
    monthly:{ limitUSD: 2000, softGuardPct: 0.7, hardGuardPct: 0.9 }
  },

  perComponent:{
    embeddings:{ sharePctMaxDaily: 0.55, allowDowngrade:true, minBatch:16, maxBatch:64 },
    vector_query:{ topKDefault:8, topKMin:4, allowDisableReranker:true },
    vector_upsert:{ maxPerHour: 20000, deferIfHardGuard:true },
    dist_push:{ throttlePerMin: 30, bigMsgBytes: 48_000, dropChannels:["webhook"] },
    storage:{ preferColdstore:true, forceCompression:true },
    compute:{ capMinPerDay: 120 },
    html_render:{ limitRendersPerHr: 200 }
  },

  forecast:{
    method:"ewma",
    alpha:0.3,
    horizonHours:24,
    includeRates:true
  },

  exclusions:{
    drillShadowExclude:true,     // L29/L33 DRILL|SHADOW â†’ bÃ¼tÃ§e dÄ±ÅŸÄ±
    namespaces:["kb_default"]    // opsiyonel dahil/dÄ±ÅŸla listesi
  },

  actions:{
    downgrade:{ embeddings:{ model:"text-embedding-3-small" } },
    reduce:{ "kb.topK":6, "bm25K":30 },
    disable:{ reranker:true },
    batch:{ "embeddings.batch":32 },
    deferJobs:["kb.reindex","sim.run"],   // L24/L25
    throttle:{ "dist.push.perMin": 20 }
  },

  integrations:{
    dist:"LIVIA-22",
    kb:"LIVIA-24",
    housekeeping:"LIVIA-31",
    policy:"LIVIA-23",
    ethics:"LIVIA-26"
  },

  evaluation:{
    slideEverySec:5,
    minSamplesPerWindow:3,
    currency:"USD",
    rateFallback: { defaultPricePerUnit: 0.0 }   // oran bilinmezse estimate-only
  },

  idempotencyTtlSec: 3600
}

5) Hesaplama (Ã¶zet)

Spend(window) = Î£(qty Ã— pricePerUnit) [DRILL/SHADOW hariÃ§]

Budget burn(window, period) = SpendPeriod / LimitPeriod

Forecast breach = EWMA(trend) ile t+H dÃ¶nemde %soft|%hard aÅŸÄ±m olasÄ±lÄ±ÄŸÄ± > eÅŸiÄŸe gelirse erken uyarÄ±

Rate spike = pricePerUnit deÄŸiÅŸimi %Î” > eÅŸiÄŸe â†’ tetik

Savings estimate = aksiyon planÄ± simÃ¼lasyonuyla (topKâ†“, reranker off, downgrade, batchâ†‘) dÃ¼ÅŸÃ¼ÅŸ yÃ¼zdesi

6) Pipeline (Kompozisyon)

Collect: billing.usage.sample|estimate.update|provider.rate.update|job.cost.estimate|dist.sent|kb.query.executed

Normalize: oran/para birimi; DRILL/SHADOW etiketli Ã¶rnekleri ayrÄ±ÅŸtÄ±r

Aggregate: pencere ve dÃ¶nem bazÄ±nda spend/burn + EWMA forecast

Evaluate: soft/hard guard, forecast_breach, rate_spike kurallarÄ±

Plan Actions: perComponent + global actions birleÅŸimi; Ã§akÄ±ÅŸma varsa en maliyet dÃ¼ÅŸÃ¼rÃ¼cÃ¼ yol

Enforce:

L24: kb.search parametrelerini (topK/reranker) dÃ¼ÅŸÃ¼r

Embeddings: model downgrade + batch ayarÄ±

L22: kanal throttle/drop (webhook gibi masraflÄ±)

L31: coldstore+compression zorunlu

L23: kalÄ±cÄ± politika Ã¶nerisi gerekiyorsa patch Ã¶ner

L26: kritik kesintiler (Ã¶r. full disable) etik kapÄ±dan geÃ§er

Recover: burn normale dÃ¶nÃ¼nce aksiyonlarÄ± geri al; ertelenen iÅŸleri sÄ±rala

Report: gÃ¼nlÃ¼k cost.report.ready (MD/HTML) + kart; KBâ€™ye indeksle (L24)

Emit: cost.guard.(triggered|recovered|earlywarn|card|metrics|alert)

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (veri akÄ±ÅŸÄ±/slide) â†’ EVAL

EVAL â†’ (hard/soft/forecast/spike) TRIGGER | (warn) EARLYWARN | (ok && actionsActive) RECOVER_CHECK | else IDLE

TRIGGER â†’ ENFORCE (downgrade/reduce/disable/batch/defer/throttle) â†’ MONITOR

MONITOR â†’ (stableâ‰¥N) RECOVER | (timeout) ALERT(enforce_failed)

RECOVER â†’ revert + jobs resume â†’ IDLE

Hata: ALERT + IDLE

8) Kenar Durumlar

Unknown rate: rateFallback.defaultPricePerUnit ile estimate; unknown_rate uyarÄ±sÄ±

Provider credit/negatif satÄ±r: negatif qtyÃ—price â†’ ayrÄ± credits hanesine yaz; burnâ€™den dÃ¼ÅŸ

GeÃ§ gelen faturalama: geriye dÃ¶nÃ¼k dÃ¼zeltmeler â†’ â€œretroactiveâ€ olarak iÅŸaretlenir; idempotency ile Ã§ift sayÄ±m yok

DRILL/SHADOW: bÃ¼tÃ§e dÄ±ÅŸÄ±nda rapor; yine de cost.reportâ€™ta ayrÄ± bÃ¶lÃ¼m

AÅŸÄ±rÄ± throttle riski: L32 SLO Guard ile Ã§eliÅŸirse throttle derecesi dÃ¼ÅŸÃ¼r; SLO â‰¥ hedef korunur

Policy gerekiyorsa: kalÄ±cÄ± deÄŸiÅŸim (model/param) iÃ§in L23â€™e patch Ã¶nerisi

Finance gÃ¶rÃ¼nÃ¼mÃ¼: RBAC finance rolÃ¼ tÃ¼m kalemleri gÃ¶rÃ¼r; observer Ã¶zet gÃ¶rÃ¼r

Idempotency: aynÄ± costGuardKey iÃ§in ikinci tetik eylem doÄŸurmaz; yalnÄ±z card yenilenir

9) Telemetri
{
  "cost.guard.metrics": {
    "event":"cost.guard.metrics","timestamp":"iso8601",
    "evaluated":420,"triggers":3,"recoveries":2,"earlyWarn":6,
    "p50EvalMs":3.0,"p95EvalMs":6.2,
    "savingsUSD":28.4,"jobsDeferred":2,
    "actions":{"downgrade":2,"reduce":3,"disable":2,"batch":2,"throttle":1}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/realtimeCostGuard.ts             # FSM + evaluator + enforcer
services/livia/lib/cost/aggregator.ts           # pencere & dÃ¶nem toplama
services/livia/lib/cost/forecast.ts             # EWMA/MVAVG tahmin
services/livia/lib/cost/actions.ts              # downgrade/reduce/disable/batch/throttle/defer
services/livia/lib/cost/rates.ts                # provider rate cache & update
services/livia/lib/bridges.ts                   # L22/L24/L31/L23/L26 entegrasyonlarÄ±
services/livia/state/costGuardStore.ts          # idem index + aktif aksiyonlar
services/livia/__tests__/realtimeCostGuard.test.ts
cfg/livia.cost.guard.yaml

11) Test Ä°skeleti (Jest/Vitest)

Hard guard: gÃ¼nlÃ¼k $100 limit, spend $92 + forecast $105 â†’ trigger + aksiyon planÄ±

Rate spike: price +%30 â†’ trigger (reduce+downgrade)

Early warn: 6h burn 0.68 â†’ earlywarn + Ã¶neri

Recover: burn < soft â†’ aksiyonlar geri alÄ±ndÄ±, ertelenen iÅŸler devam

Unknown rate: fallback estimate + alert

DRILL/SHADOW: bÃ¼tÃ§e dÄ±ÅŸÄ±; raporda ayrÄ±

SLO uyumu: throttle SLO ile Ã§eliÅŸmedi; L32 sinyalleriyle downgrade hafifletildi

Idempotency: aynÄ± pencere tetikte tekrar eylem yok

RBAC: finance tam, observer Ã¶zet gÃ¶rÃ¼nÃ¼r

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

13:40 embeddings spend artÄ±ÅŸÄ± â†’ 24h burn 0.93 & forecast breach â†’ TRIGGER

Aksiyon: model downgrade, topK 8â†’6, reranker off, reindex defer â†’ card

14:10â€“14:36 harcama hÄ±zÄ± dÃ¼ÅŸer â†’ RECOVER: parametreler geri, reindex sÃ¼resi planlanÄ±r

GÃ¼n sonu cost.report.ready â†’ L22 daÄŸÄ±tÄ±m, L24 indeks.

13) SLO

p95 evaluate < 10 ms / pencere

YanlÄ±ÅŸ tetik â‰¤ %1, kaÃ§Ä±rma â‰¤ %1

Tasarruf etki (plan sonrasÄ± 1h) â‰¥ %15 hedefi

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-35 Â· featureFlagOrchestrator.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
LIVIA ekosisteminde Ã¶zellik bayraklarÄ± (feature flags), kanarya/percentage rollout, deney varyantlarÄ± ve uzaktan konfigâ€™i gÃ¼venli, izlenebilir, idempotent ve etik/uyum kurallarÄ±yla uyumlu biÃ§imde orkestre etmek.
Bayraklar; kural tabanlÄ± (segment/koÅŸul), yapÄ±ÅŸkan (sticky hashing), zaman pencereli, baÄŸÄ±mlÄ±lÄ±k/Ã¶nkoÅŸul destekli. Otomatik geri alma tetikleri SLO Guard (L32) ve Cost Guard (L34) ile baÄŸlanÄ±r. Kart/uyarÄ± L22, KB indeksleme L24, politika deÄŸiÅŸimi L23, etik/uyum L26, kaos/drill L29/L33 ile entegredir.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; OpenTelemetry; RBAC + HMAC/JWT.

1) Standartlar

Runtime: Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT, RBAC: policy|ops yazabilir, qa|observer sÄ±nÄ±rlÄ± okur

Gizlilik: PII yok; subject kimlikleri saltâ€™lÄ± hash ile yapÄ±ÅŸkan; serbest metinler L21 ile redakte

Ä°dempotency: flagKey = flagId + version + env + rolloutStage

Observability: Spans (ff.define,ff.publish,ff.eval,ff.rollout,ff.rollback) + metrics

Uyum: Hassas bayraklar L26 etik kapÄ±sÄ±ndan geÃ§er; audit kayÄ±tlarÄ± append-only (WORM benzeri)

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "feature.flag.define": {
    "event":"feature.flag.define","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2",
    "title":"KB Hybrid Search v2",
    "env":"dev|staging|prod",
    "variants":[{"name":"off"},{"name":"on"},{"name":"canary"}],
    "defaultVariant":"off",
    "rules":[
      {
        "when":"env==prod && segment in ['ops','policy'] && time.between('09:00','21:00')",
        "bucket":{"stickyBy":"subject","saltRef":"daily","percent":10,"variant":"canary"}
      }
    ],
    "dependencies":["kb.index.ready==true"],
    "killSwitch": {"enabled":true},
    "sensitive": true,
    "owner":"policy-lead",
    "tags":["kb","experiment","cost_sensitive"]
  },

  "feature.flag.update": {
    "event":"feature.flag.update","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod",
    "patch":{
      "rules.append":[
        {"when":"segment=='ops' && region in ['eu-central','eu-west']",
         "bucket":{"stickyBy":"subject","saltRef":"static","percent":25,"variant":"on"}}
      ],
      "defaultVariant":"off"
    },
    "reason":"canaryâ†’%25"
  },

  "feature.flag.publish": {
    "event":"feature.flag.publish","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod","version":"v3",
    "rolloutPlan":{"steps":[{"percent":10},{"percent":25},{"percent":50},{"percent":100}],"minStableMin":15}
  },

  "feature.flag.kill": {
    "event":"feature.flag.kill","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod","reason":"slo_guard_trigger"
  },

  "segment.update": {
    "event":"segment.update","timestamp":"iso8601",
    "segments":{
      "ops":{"match":{"role":"ops"}},
      "policy":{"match":{"role":"policy"}},
      "observer":{"match":{"role":"observer"}}
    }
  },

  "feature.flag.evaluate.request": {
    "event":"feature.flag.evaluate.request","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod",
    "context":{
      "subject":{"id":"user#9f3a","role":"ops","region":"eu-central"},
      "scope":"global|desk|symbol","symbol":"AVAXUSDT|null",
      "timeISO":"iso8601","extras":{"namespace":"kb_default"}
    },
    "want":"variant|bool|config",
    "cacheOk": true
  },

  "slo.guard.triggered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"latency_p95","severity":"high","hash":"sha256:..."
  },

  "cost.guard.triggered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "component":"vector_query","severity":"high"
  }
}


Not: feature.flag.define/update/publish/kill â†’ policy rolÃ¼; sensitive:true bayraklar publish/kill Ã¶ncesi L26 kontrolÃ¼ ister.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "feature.flag.evaluate.ready": {
    "event":"feature.flag.evaluate.ready","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod",
    "decision":{"variant":"canary","enabled":true,"config":{"topK":8,"reranker":false}},
    "reasonCodes":["rule_match","bucket_hit","dependency_ok"],
    "sticky":{"by":"subject","bucket":"murmur3","slot":4213,"percent":10,"saltRef":"daily"},
    "ttlSec":300,"hash":"sha256:..."
  },

  "feature.flag.rollout.started": {
    "event":"feature.flag.rollout.started","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod","version":"v3",
    "plan":{"steps":[10,25,50,100],"minStableMin":15}
  },

  "feature.flag.rollout.progress": {
    "event":"feature.flag.rollout.progress","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod","step":{"percent":25},"nextInMin":15
  },

  "feature.flag.rollback": {
    "event":"feature.flag.rollback","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod","toVersion":"v2","reason":"slo_guard_trigger"
  },

  "feature.flag.killed": {
    "event":"feature.flag.killed","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod","reason":"kill_switch"
  },

  "feature.flag.card": {
    "event":"feature.flag.card","timestamp":"iso8601",
    "title":"Feature Flag â€” kb.hybridSearch.v2",
    "body":"Prod %25 canary aktif â€¢ 15dk stabil sonra %50.",
    "severity":"info","ttlSec":600
  },

  "feature.flag.alert": {
    "event":"feature.flag.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|rbac_denied|ethics_denied|dependency_missing|rollout_blocked|kill_switch|eval_error"
  },

  "feature.flag.metrics": {
    "event":"feature.flag.metrics","timestamp":"iso8601",
    "flags":48,"evals":18420,"p95EvalMs":0.9,"cacheHitRate":0.83,
    "rollouts":{"started":3,"progressed":8,"completed":2,"rollback":1},
    "kills":1,"autoRollbackBySLO":1,"autoRollbackByCost":1
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n: { locale:"tr-TR", tz:"Europe/Istanbul" },

  envs: ["dev","staging","prod"],

  stickiness: {
    hash: "murmur3_128",
    subjectKey: "subject.id|ip|deviceId",   // sÄ±rayla ilk mevcut olan
    salts: { static:"static-salt", daily:"rotate-daily", weekly:"rotate-weekly" },
    rotateStrategy: "graceful",             // eski atamayÄ± koru; yalnÄ±z yeni subject'ler yeni tuzla
    slots: 10000
  },

  evaluator: {
    dslVersion: "v1",
    functions: ["env","segment","region","time.between","scope","symbol","percentBucket","dependency"],
    defaultVariant: "off",
    cacheTtlSec: 300
  },

  rollout: {
    minStableMin: 15,
    abortOn: { sloGuard:true, costGuard:true },
    autoResume: false
  },

  dependencies: {
    // bayrak veya sistem koÅŸulu
    "kb.index.ready": { probe:"kb_index_status", timeoutMs: 1500 }
  },

  ethics: {
    requireForSensitive: true,     // L26
    categories: { cost_sensitive:true, user_visible:true }
  },

  audit: {
    wormDir: "state/flags/worm/{YYYY-MM-DD}",
    hashChainFile: "chain.log"
  },

  distro: { channels:["ui","slack"], redactProfile:"generic" }, // L22 + L21
  knowledge: { index:true, tag:"flags" },                       // L24

  idempotencyTtlSec: 86400
}

5) DeÄŸerlendirme DSL (Ã¶zet)

Ä°fade Ã¶rnekleri:

env==prod && segment in ['ops','policy'] && percentBucket(10,'subject','daily')

region in ['eu-central'] && time.between('09:00','21:00')

dependency('kb.index.ready') == true

Ã‡Ä±ktÄ±: variant, enabled:boolean, opsiyonel config (Ã¶rn. topK, reranker:false).

Bucketleme: slot = murmur3(salt + subjectKey) % slots; slot < percent/100*slots â‡’ hit.

6) Pipeline (Kompozisyon)

Define/Update: feature.flag.define|update â†’ Zod .strict() doÄŸrula â†’ DSL lint â†’ ethics (L26) gerekliyse kontrol â†’ taslak kaydet

Publish: versiyon oluÅŸtur; audit WORMâ€™a append; feature.flag.rollout.started + card; plan adÄ±mlarÄ±nÄ± zamanlayÄ±cÄ±ya yaz

Evaluate: feature.flag.evaluate.request â†’ segment Ã§Ã¶z â†’ baÄŸÄ±mlÄ±lÄ±k doÄŸrula â†’ bucket â†’ karar; cache (ETag/TTL)

Rollout Progress: adÄ±m tamamla; SLO Guard (L32) ve Cost Guard (L34) sinyallerini izle â†’ ihlal varsa rollback/kill

Kill Switch: acil durum; anÄ±nda defaultVariant ve enabled=false â†’ kart + alert

Distribute & Index: Ã¶nemli olaylarÄ± L22 ile daÄŸÄ±t, L24â€™e indeksle

Metrics: deÄŸerlendirme sayÄ±larÄ±, p95 ms, cache hit, rollout sayacÄ±, geri almalar

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

DRAFT â† feature.flag.define

PUBLISHED â† feature.flag.publish (plan kayÄ±t)

RAMPING (adÄ±m adÄ±m % artÄ±ÅŸÄ±)

slo.guard.triggered|cost.guard.triggered â†’ ROLLBACK / PAUSE

adÄ±m stabil â†’ RAMPING devam | %100 â†’ STEADY

STEADY (tam yayÄ±nda)

KILLED â† feature.flag.kill (kalÄ±cÄ± kapalÄ±)

Hata: ALERT + durum korunur; idem: aynÄ± adÄ±m ikinci kez Ã§alÄ±ÅŸmaz

8) Kenar Durumlar

Hash tuzu rotasyonu: graceful modda mevcut atamalar korunur; reset gerekirse reasonCode:"salt_rotation" ile kart

BaÄŸÄ±mlÄ±lÄ±k eksik: dependency_missing â†’ defaultâ€™a dÃ¼ÅŸ; card warn

Ã‡akÄ±ÅŸan kurallar: en spesifik kural kazanÄ±r (daha Ã§ok predicate + dar segment > geniÅŸ)

Sahte segment: bilinmeyen segment â†’ observer say; rules atlanÄ±r

Offline deÄŸerlendirme: cache/ETag ile evaluate dÃ¶ner; TTL dolunca zorunlu tazele

Drill/Chaos: L29/L33 etiketli baÄŸlamlar ayrÄ± bucket (salt:drill) â†’ prod atamalarÄ±na karÄ±ÅŸmaz

Etik reddi: ethics_denied â†’ publish/kill iptal; card error

RBAC: qa preview gÃ¶rebilir ama publish edemez

Idempotency: aynÄ± flagKey ile ikinci publish/evaluate yan etkisiz

9) Telemetri
{
  "feature.flag.metrics": {
    "event":"feature.flag.metrics","timestamp":"iso8601",
    "flags":48,"evals":18420,"p50EvalMs":0.4,"p95EvalMs":0.9,
    "cacheHitRate":0.83,"rollouts":{"started":3,"progressed":8,"completed":2,"rollback":1},
    "kills":1,"autoRollbackBySLO":1,"autoRollbackByCost":1,
    "alerts":{"dependency_missing":2,"ethics_denied":0}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/featureFlagOrchestrator.ts        # FSM + orchestrator
services/livia/lib/ff/dsl.ts                     # kural dili parse/eval
services/livia/lib/ff/bucketer.ts                # murmur3 sticky bucketing
services/livia/lib/ff/segments.ts                # segment Ã§Ã¶zÃ¼mleyici
services/livia/lib/ff/rollout.ts                 # planlayÄ±cÄ± + ilerletici
services/livia/lib/ff/deps.ts                    # baÄŸÄ±mlÄ±lÄ±k doÄŸrulayÄ±cÄ±
services/livia/lib/ff/cache.ts                   # ETag/TTL cache
services/livia/lib/bridges.ts                    # L22/L24/L23/L26/L32/L34 kÃ¶prÃ¼leri
services/livia/lib/redact.ts                     # LIVIA-21
services/livia/state/featureFlagStore.ts         # idem index + aktif planlar + WORM
services/livia/__tests__/featureFlagOrchestrator.test.ts
cfg/livia.flags.yaml

11) Test Ä°skeleti (Jest/Vitest)

Define/Publish: DSL doÄŸrulama, WORM append, RBAC/ethics kontrol

Evaluate: segment+dependency+bucket doÄŸru; cache TTL Ã§alÄ±ÅŸÄ±yor

Rollout: %10â†’%25â†’%50â†’%100 adÄ±mlarÄ±; SLO guard sinyaliyle rollback

Kill switch: anÄ±nda kapatma + card

Salt rotation: graceful â†’ eski atamalar korunur; reset modunda yeniden bucket

Chaos/Drill izolasyonu: salt='drill' atamalar prodâ€™dan ayrÄ±

Idempotency: aynÄ± flagKey ikinci publish/evaluate yan etkisiz

Observer gÃ¶rÃ¼nÃ¼mÃ¼: bayrak detayÄ± sÄ±nÄ±rlÄ±; PII yok

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

feature.flag.define(kb.hybridSearch.v2) â†’ DRAFT

publish(v3, plan=[10,25,50,100]) â†’ RAMPING; kart: â€œ%10 canary baÅŸladÄ±â€

15dk stabil â†’ %25 â†’ kart gÃ¼ncellendi

slo.guard.triggered(kb_api, latency) â†’ ROLLBACK: v2â€™ye dÃ¶n; killSwitch? false

Ä°yileÅŸme sonrasÄ± yeniden publish â†’ %50 â†’ %100 â†’ STEADY

GÃ¼n sonu L14 digest; L24 KBâ€™ye â€œflag deÄŸiÅŸim gÃ¼ncesiâ€ indekslendi.

13) SLO

p95 evaluate < 1 ms (cache Ä±sÄ±ndÄ±ÄŸÄ±nda)

yanlÄ±ÅŸ atama (sticky hash drift) = 0 (aynÄ± subject, aynÄ± tuz â†’ aynÄ± slot)

otomatik rollback MTTR â‰¤ 60 s (SLO/Cost tetiklerinde)

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-36 Â· experimentAnalyzer.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Feature flag/deney (A/B/n) sonuÃ§larÄ±nÄ± doÄŸru, hÄ±zlÄ± ve gÃ¼venli biÃ§imde analiz edip; uplift/etki tahmini, guardrail (SLO, maliyet, etik) denetimleri ve karar Ã¶nerileri (promote, pause, rollback, ramp-up/down) Ã¼retmek.
Kaynaklar: L35 (featureFlag), L32 (SLO Guard), L34 (Cost Guard), L22 (distribution), L24 (knowledge), L21 (redact), L26 (ethics/WORM).
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; yerel gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: policy|ops|data okur/yazar, observer kÄ±sÄ±tlÄ± okur

Gizlilik: PII yok; subject kimlikleri saltâ€™lÄ± hash; raporlar L21 ile redakte

Ä°dempotency: analysisKey = experimentId + version + windowISO + modelSpecHash

Observability: spans (exp.collect, exp.cuped, exp.estimate, exp.guard, exp.decide, exp.report) + metrics

Uyum: karar Ã¶nerileri L26 Ã¼zerinden etik kontrol ile (gerekirse WORM append)

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "experiment.define": {
    "event":"experiment.define","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1",
    "title":"Hybrid Search v2 â€” Retrieval tweaks",
    "env":"prod|staging|dev",
    "unit":"subject|session|request",
    "assignment":{"stickyBy":"subject.id|ip|deviceId","saltRef":"daily|static","variants":["control","v2"]},
    "audience":{"segment":["ops","policy"],"region":["eu-central","eu-west"]},
    "metrics":{
      "primary":{"name":"success_rate","kind":"ratio|binary|mean","def":"answers_accepted/answers"},
      "secondary":[{"name":"p95_latency_ms","kind":"mean"},{"name":"cost_usd","kind":"mean"}],
      "guardrails":[{"name":"p95_latency_ms","dir":"<= ","limit":900},{"name":"cost_usd","dir":"<= ","limit":100}]
    },
    "mde":{"success_rate":0.02}, "power":0.8, "alpha":0.05,
    "prePeriod":{"from":"iso8601","to":"iso8601"}            // CUPED/stratify iÃ§in opsiyonel
  },

  "experiment.start": {
    "event":"experiment.start","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","version":"v1","startAt":"iso8601"
  },

  "experiment.pause|experiment.resume|experiment.stop": {
    "event":"experiment.pause","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","reason":"slo_guard|cost_guard|manual"
  },

  "exposure.logged": {
    "event":"exposure.logged","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","variant":"control|v2",
    "subject":{"id":"user#9f3a","role":"ops","region":"eu-central"},
    "context":{"namespace":"kb_default","symbol":"AVAXUSDT|null"}
  },

  "outcome.logged": {
    "event":"outcome.logged","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","variant":"control|v2",
    "metrics":{"answers":1,"answers_accepted":1,"latency_ms":820,"cost_usd":0.0018,"pnl_usd":0.00}
  },

  "slo.guard.triggered|slo.guard.recovered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"latency_p95","severity":"high"
  },

  "cost.guard.triggered|cost.guard.recovered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "component":"vector_query|embeddings","severity":"high"
  },

  "feature.flag.rollout.progress": {
    "event":"feature.flag.rollout.progress","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod","step":{"percent":25}
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "experiment.analysis.ready": {
    "event":"experiment.analysis.ready","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","version":"v1",
    "window":{"from":"iso8601","to":"iso8601"},
    "method":"frequentist|bayesian|sequential",
    "samples":{"control":12450,"v2":12390,"units":"subject"},
    "estimates":{
      "success_rate":{"control":0.74,"v2":0.781,"uplift":0.041,"ci95":[0.018,0.064],"p":0.0012,"bayes_prob_v2_better":0.984},
      "p95_latency_ms":{"control":910,"v2":860,"diff":-50,"ci95":[-72,-28]},
      "cost_usd":{"control":0.0016,"v2":0.0013,"diff":-0.0003,"ci95":[-0.0004,-0.0001]}
    },
    "cuped":{"applied":true,"theta":0.42,"varianceReductionPct":18.5},
    "guardrails":{"slo_breach":false,"cost_overrun":false},
    "segments":[{"segment":"region=eu-central","uplift":0.053,"p":0.0008}],
    "decision":"promote|pause|rollback|increase_rollout|hold",
    "rationale":["uplift_sig","guardrails_ok","no_cost_risk"],
    "hash":"sha256:..."
  },

  "experiment.decision.suggested": {
    "event":"experiment.decision.suggested","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","action":{
      "kind":"increase_rollout","toPercent":50,"minStableMin":30
    },
    "requiresApproval":false,"ethicsChecked":true
  },

  "experiment.report.ready": {
    "event":"experiment.report.ready","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","format":"md|html",
    "path":"data/experiments/2025-09-15/kb.hybridSearch.v2.ab1/report.md",
    "summary":"v2 uplift +4.1pp (p=0.0012), p95 latency -50ms, cost -18%; guardrails OK; Ã¶neri: %25â†’%50.",
    "hash":"sha256:..."
  },

  "experiment.card": {
    "event":"experiment.card","timestamp":"iso8601",
    "title":"Deney Analizi â€” kb.hybridSearch.v2.ab1",
    "body":"Uplift +4.1pp â€¢ p95 -50ms â€¢ Cost -18% â€¢ Ã–neri: %25â†’%50 (30dk stabil).",
    "severity":"info","ttlSec":900
  },

  "experiment.alert": {
    "event":"experiment.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|guardrail_breach|underpowered|sequential_boundary|rbac_denied|ethics_denied|calc_error"
  },

  "experiment.metrics": {
    "event":"experiment.metrics","timestamp":"iso8601",
    "analyses":3,"decisions":2,"reports":3,
    "p95AnalyzeMs":78,"cupedVRPct":18.5,"underpowered":0,
    "guardrailTrips":{"slo":0,"cost":0}
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  methods:{
    frequentist:{ ratioTest:"welch_z|prop_z", meanTest:"welch_t", nonParam:"mann_whitney" },
    bayesian:{ binary:"beta_binomial", mean:"normal_inverse_gamma", draws:5000 },
    sequential:{ alphaSpend:"obrien_fleming|pocock", lookEveryMin:10, maxLooks:48 }
  },

  varianceReduction:{
    cuped:{ enabled:true, covariate:"pre_success_rate|pre_latency", minCorr:0.05 }
  },

  multipleTesting:{
    fdr:"bh", q:0.1, family:["primary","secondary","segments"]
  },

  metricsCatalog:{
    success_rate:{ kind:"ratio", num:"answers_accepted", den:"answers" },
    p95_latency_ms:{ kind:"mean_p95", source:"latency_ms" },
    cost_usd:{ kind:"mean", source:"cost_usd" },
    pnl_usd:{ kind:"mean", source:"pnl_usd" }
  },

  powerCalc:{
    minSamplePerVariant: 500,
    mdeDefault:{ success_rate:0.02, mean:0.03 },
    minDurationMin: 60
  },

  guardrails:{
    slo:{ relyOn:"L32", breachAction:"pause" },
    cost:{ relyOn:"L34", hardGuardPct:0.9, breachAction:"rollback" }
  },

  segments:{
    sliceBy:["region","role","symbol"],
    hetEffects:{ enabled:true, method:"simple_uplift_tree|bucketed" }
  },

  decisions:{
    promoteIf:{ pValue:"<=0.05", upliftSign:">0", guardrailsOk:true },
    increaseRolloutIf:{ pValue:"<=0.1", upliftSign:">=0", minStableMin:30 },
    pauseIf:{ guardrailBreach:true },
    rollbackIf:{ guardrailBreach:true, upliftSign:"<=0" }
  },

  reporting:{
    outputDir:"data/experiments/{YYYY-MM-DD}/{experimentId}",
    mdFile:"report.md", htmlFile:"report.html",
    html:{ embedMiniCSS:true, chartsInlineSvg:true },
    include:{ segmentsTopN:10, charts:["kpi_trend","cum_uplift","sequential_boundary"] }
  },

  integrations:{
    flags:"LIVIA-35", dist:"LIVIA-22", kb:"LIVIA-24", ethics:"LIVIA-26",
    sloGuard:"LIVIA-32", costGuard:"LIVIA-34"
  },

  redactionProfile:"generic",
  idempotencyTtlSec: 86400
}

5) Metodoloji (Ã¶zet)

Atama/Sticky: L35 ile aynÄ± murmur3 + salt; unit=subject Ã¶nerilir.

CUPED: Y* = Y - Î¸(X - mean(X)), Î¸ = cov(Y,X)/var(X); pre-period metriklerinden X.

Frequentist: oran iÃ§in z-testi; ortalama iÃ§in Welch t; p95 iÃ§in Hodgesâ€“Lehmann / non-parametrik yaklaÅŸÄ±m.

Bayesian: Betaâ€“Binomial (binary/ratio), Normalâ€“Inverse-Gamma (mean); P(v2>control) Ã§Ä±kar.

Sequential: Oâ€™Brienâ€“Fleming/Pocock sÄ±nÄ±rlarÄ±; erken durdurma & underpowered uyarÄ±sÄ±.

FDR: Benjaminiâ€“Hochberg q=0.1; segment Ã§oklamasÄ±nÄ± kontrol et.

6) Pipeline (Kompozisyon)

Collect: exposure.logged, outcome.logged, guardrail sinyalleri (L32/L34), flag rollout (L35)

Validate/Normalize: Zod .strict(); eksik/mÃ¼kerrerler tekilleÅŸtirilir (same subject+ts Â±1s â†’ dedup)

Prepare: atama doÄŸrulama (variant mix), pre-period baÄŸlama, CUPED uygulama

Estimate: seÃ§ili metod(lar) ile uplift/CI/p; Bayes posterior; sequential sÄ±nÄ±rlar

Guardrails: SLO/cost ihlallerine bak; breach â†’ pause/rollback sinyali

Decide: kurallara gÃ¶re promote|increase_rollout|pause|rollback|hold Ã¶nerisi

Report: Markdown/HTML (trend/cum_uplift/sequential sÄ±nÄ±r grafikleri, segment tablosu); L21 redaksiyon

Emit/Distribute: experiment.analysis.ready + experiment.decision.suggested + experiment.report.ready + experiment.card; L22 daÄŸÄ±t

Index: raporu L24 KBâ€™ye â€œexperimentsâ€ etiketiyle indeksle

Audit: Ã¶nemli kararlar L26 etik kapÄ±sÄ±na ve WORM append

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (experiment.start|outcome.logged|exposure.logged) â†’ COLLECT

COLLECT â†’ ESTIMATE (per schedule/look)

ESTIMATE â†’ (guardrail breach?) DECIDE(pause/rollback) | (sig & ok) DECIDE(promote/increase) | HOLD

DECIDE â†’ REPORT â†’ EMIT â†’ IDLE (rolling)

Hata â†’ ALERT + IDLE; idem: aynÄ± analysisKey tekrarlanmaz

8) Kenar Durumlar

Underpowered: Ã¶rnek < minSample veya sÃ¼re < minDurationMin â†’ underpowered uyarÄ±sÄ±; karar â€œholdâ€

Variant dengesizliÄŸi: bucket sapmasÄ± > %2 â†’ uyarÄ±; sticky/salt kontrol et

Carryover/Interference: aynÄ± subject birden Ã§ok varyanta maruz â†’ kayÄ±t dÄ±ÅŸla

Guardrail drift: p95 latency yÃ¼kseliÅŸi, cost artÄ±ÅŸÄ± â†’ pause/rollback Ã¶ner

Segments: kÃ¼Ã§Ã¼k dilimlerde FDR uygula; gizlilik iÃ§in N<50 â†’ â€œredactedâ€

Drill/Shadow: etiketli trafik analize dahil edilmez (ayrÄ± rapor bÃ¶lÃ¼mÃ¼)

RBAC/Observer: yalnÄ±z Ã¶zet KPI ve karar; ham metrik yok

9) Telemetri
{
  "experiment.metrics": {
    "event":"experiment.metrics","timestamp":"iso8601",
    "analyses":3,"decisions":2,"reports":3,
    "p50AnalyzeMs":42,"p95AnalyzeMs":78,
    "cupedVRPct":18.5,"underpowered":0,
    "guardrailTrips":{"slo":0,"cost":0}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/experimentAnalyzer.ts
services/livia/lib/exp/assign.ts          # sticky/bucket doÄŸrulama (L35 ile uyumlu)
services/livia/lib/exp/cuped.ts           # variance reduction
services/livia/lib/exp/stats.ts           # tests & bayesian
services/livia/lib/exp/sequential.ts      # alpha spending sÄ±nÄ±rlarÄ±
services/livia/lib/exp/segments.ts        # slice/HTE
services/livia/lib/exp/report.ts          # md/html + grafik (inline SVG)
services/livia/lib/redact.ts              # LIVIA-21
services/livia/lib/bridges.ts             # L22/L24/L26/L32/L34/L35 kÃ¶prÃ¼leri
services/livia/state/experimentStore.ts   # idem index + geÃ§miÅŸ analizler
services/livia/__tests__/experimentAnalyzer.test.ts
cfg/livia.experiments.yaml

11) Test Ä°skeleti (Jest/Vitest)

Frequentist & Bayes aynÄ± iÅŸaretli sonuÃ§ta; p & bayes prob uyumlu

CUPED ile varyans dÃ¼ÅŸÃ¼mÃ¼ >%10

Sequential boundary ihlali â†’ erken durdurma & sequential_boundary uyarÄ±sÄ±

Guardrail cost ihlali â†’ pause/rollback Ã¶nerisi

Segment FDR kontrolÃ¼; N<50 dilimler redacted

Idempotency: aynÄ± analysisKey yeniden yazmÄ±yor

RBAC/observer: Ã¶zet gÃ¶rÃ¼nÃ¼m; PII yok

Report yazÄ±mÄ±: md/html + grafik; L24 indeks; L22 kart

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

11:00 deney baÅŸladÄ±; 12:10 ilk ESTIMATE â†’ uplift +3.2pp (p=0.03), guardrails OK â†’ increase_rollout %10â†’%25 Ã¶nerisi

14:00 ikinci ESTIMATE â†’ uplift +4.1pp (p=0.0012), cost âˆ’18%, p95 âˆ’50ms â†’ promote/increase %50

Rapor & kart yayÄ±mlandÄ±; L24 indeks; L26 etik kontrolÃ¼nden geÃ§ti.

13) SLO

p95 analyze < 100 ms / pencere

Var. dÃ¼ÅŸÃ¼mÃ¼ (CUPED) â‰¥ %10 medyan

YanlÄ±ÅŸ karar (guardrail ihmal) â‰¤ %1

Ä°dempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-37 Â· guardrailBanditAllocator.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
CanlÄ± trafikte varyant paylaÅŸtÄ±rmayÄ± (A/B/n, feature flag varyantlarÄ±) bandit yaklaÅŸÄ±mlarÄ±yla otomatik ve gÃ¼venli yÃ¶netmek: Thompson Sampling / UCB / Epsilon-Greedy (baÄŸlamsal Ã¶zelliklerle), guardrail (SLO â€” L32, maliyet â€” L34, etik â€” L26) kÄ±sÄ±tlarÄ± ile emniyetli keÅŸif (safe exploration). Trafik yapÄ±ÅŸkan (L35 ile aynÄ± hash), sÃ¼reklilik / adÄ±m adÄ±m ramp-up ve rollback destekli. Kararlar event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; yerel pencere 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: policy|ops|data yÃ¶netir, observer salt okur

Gizlilik: PII yok; subject kimlikleri saltâ€™lÄ± hash (L35 ile uyumlu); serbest metinler L21 redakte

Ä°dempotency: banditKey = experimentId + version + windowISO + policyHash

Observability: spans (ba.collect,ba.update,ba.plan,ba.enforce) + metrics

Uyum: kararlar L26 etik kapÄ±sÄ±ndan geÃ§ebilir; kritik deÄŸiÅŸimler WORM benzeri append log

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "bandit.policy.define": {
    "event":"bandit.policy.define","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1",
    "version":"v1",
    "objective":"maximize_success_rate|minimize_latency|multi_objective",
    "algo":"thompson|ucb|eps_greedy|linucb|linTS",
    "context":["region","role","hourOfDay","symbol"],            // baÄŸlamsal Ã¶zellikler (opsiyonel)
    "variants":[{"name":"control"},{"name":"v2"}],
    "priors":{"success_rate":{"alpha":1,"beta":1}},              // Thompson iÃ§in Ã¶rnek
    "constraints":{
      "guardrails":{"slo":{"ref":"L32"}, "cost":{"ref":"L34"}},
      "minTrafficPctPerVariant":5,
      "maxRampPerStepPct":15,
      "cooldownMin":15,
      "requireStableMin":15
    },
    "sticky":{"by":"subject","saltRef":"daily"},
    "safeExplorePct":5,                                         // her zaman gÃ¼venli keÅŸif yÃ¼zdesi
    "segmentMode":"global|per_segment",                         // baÄŸlama gÃ¶re ayrÄ± bandit
    "killOnBreach":true
  },

  "bandit.policy.update": {
    "event":"bandit.policy.update","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","version":"v1",
    "patch":{"maxRampPerStepPct":10,"safeExplorePct":8},
    "reason":"faster ramp, keep safety"
  },

  "exposure.logged": {
    "event":"exposure.logged","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","variant":"control|v2",
    "subject":{"id":"user#9f3a","role":"ops","region":"eu-central"},
    "context":{"hourOfDay":14,"symbol":"AVAXUSDT|null"}
  },

  "outcome.logged": {
    "event":"outcome.logged","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","variant":"control|v2",
    "metrics":{"success":1,"latency_ms":820,"cost_usd":0.0018}
  },

  "slo.guard.triggered|slo.guard.recovered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"latency_p95","severity":"high"
  },

  "cost.guard.triggered|cost.guard.recovered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "component":"vector_query|embeddings","severity":"high"
  },

  "feature.flag.evaluate.request": {
    "event":"feature.flag.evaluate.request","timestamp":"iso8601",
    "flagId":"kb.hybridSearch.v2","env":"prod",
    "context":{"subject":{"id":"user#9f3a","role":"ops","region":"eu-central"},
               "scope":"global","symbol":"AVAXUSDT|null"}
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "bandit.plan.ready": {
    "event":"bandit.plan.ready","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","version":"v1",
    "weights":[{"variant":"control","pct":40},{"variant":"v2","pct":60}],
    "basis":"thompson_posterior|ucb_score|epsilon_schedule|lin_weights",
    "safeExplorePct":5,
    "segment":"global|region=eu-central|role=ops",
    "hash":"sha256:..."
  },

  "bandit.enforce.request": {
    "event":"bandit.enforce.request","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1","version":"v1",
    "via":"LIVIA-35","flagId":"kb.hybridSearch.v2","env":"prod",
    "weights":[{"variant":"control","pct":40},{"variant":"v2","pct":60}],
    "rampFromPrevPct":15,"cooldownUntil":"iso8601"
  },

  "bandit.rollback.request": {
    "event":"bandit.rollback.request","timestamp":"iso8601",
    "experimentId":"kb.hybridSearch.v2.ab1",
    "reason":"guardrail_breach|degradation|ethics_denied",
    "targetWeights":[{"variant":"control","pct":100}]
  },

  "bandit.card": {
    "event":"bandit.card","timestamp":"iso8601",
    "title":"Bandit GÃ¼ncellendi â€” kb.hybridSearch.v2.ab1",
    "body":"v2 payÄ± %45â†’%60 (TS), gÃ¼venli keÅŸif %5; SLO/Cost guardrails OK.",
    "severity":"info","ttlSec":900
  },

  "bandit.alert": {
    "event":"bandit.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|under_min_samples|guardrail_breach|ethics_denied|ramp_rate_blocked|calc_error"
  },

  "bandit.metrics": {
    "event":"bandit.metrics","timestamp":"iso8601",
    "updates":3,"rollbacks":1,"segments":2,
    "p95UpdateMs":12.4,"safeExplorePct":5,"avgReward_v2":0.781,"avgReward_control":0.74
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  algo:{
    kind:"thompson",                     // thompson|ucb|eps_greedy|linucb|linTS
    reward:"success_rate",               // primary metrik
    secondary:["latency_ms","cost_usd"], // guardrail iÃ§in izlenir (opt.)
    thompson:{ alpha0:1, beta0:1 },      // Beta-Binomial
    ucb:{ c:2.0 },                       // UCB1 param
    eps_greedy:{ epsStart:0.1, epsMin:0.02, halfLifeMin:120 },
    linucb:{ alpha:0.5, contextDimMax:16 },
    linTS:{ sigma:0.3 }
  },

  constraints:{
    minTrafficPctPerVariant: 5,
    maxRampPerStepPct: 15,
    cooldownMin: 15,
    requireStableMin: 15,                // guardrail ok kalma sÃ¼resi
    minSamplesPerVariant: 200
  },

  context:{
    enabled:true,
    oneHot:["region","role","symbol"],
    cyclical:["hourOfDay"]               // sin/cos dÃ¶nÃ¼ÅŸÃ¼mÃ¼
  },

  sticky:{ by:"subject", saltRef:"daily" },   // L35 ile aynÄ±

  safety:{
    safeExplorePct: 5,                   // daimi gÃ¼venli keÅŸif
    killOnBreach: true,
    ethicsRequiredForBigJumpPct: 30      // L26 kapÄ±sÄ±
  },

  integrations:{
    flags:"LIVIA-35",
    slo:"LIVIA-32",
    cost:"LIVIA-34",
    dist:"LIVIA-22",
    redact:"LIVIA-21",
    ethics:"LIVIA-26",
    experiments:"LIVIA-36"
  },

  schedule:{
    updateEverySec: 60,
    freezeDuringIncident: true           // L32/L15 gerÃ§ek olayda duraklat
  },

  idempotencyTtlSec: 3600
}

5) Ã–dÃ¼l Modeli (reward) & Guardrail MantÄ±ÄŸÄ±

Primary reward (Ã¶rnek): success_rate iÃ§in Betaâ€“Binomial (TS):
posterior ~ Beta(alpha0 + successes, beta0 + trials - successes)
Aday aÄŸÄ±rlÄ±klar, varyantÄ±n Ã¶rnekleminden Ã¶rneklenen baÅŸarÄ± olasÄ±lÄ±klarÄ±nÄ±n sÄ±rasÄ±na gÃ¶re verilir.

Multi-objective (opsiyonel): compositeReward = w1*success - w2*latency_norm - w3*cost_norm (wâ€™lar policyâ€™de)

Guardrails:

SLO (L32): p95 latency/uptime ihlali â†’ ramp bloke; gerekiyorsa bandit.rollback.request

Cost (L34): hard guard â‰¥%90 â†’ pay azalt veya freeze

Ethics (L26): bÃ¼yÃ¼k sÄ±Ã§rama (>%30) veya hassas etki â†’ onay gerek

6) Pipeline (Kompozisyon)

Collect: exposure.logged + outcome.logged olaylarÄ±nÄ± Ã§ek; segment/baÄŸlam ile eÅŸle

Validate/Normalize: Zod .strict(); duplikasyon Â±1s pencerede tekille; DRILL/SHADOW (L29/L33) harici say

Update Posteriors / Scores: seÃ§ilen algoritmaya gÃ¶re varyant parametrelerini gÃ¼ncelle (TS/UCB/Îµ vb.)

Plan Weights: minTraffic, maxRampPerStep ve safeExplorePct koÅŸullarÄ±nÄ± uygulayarak yeni hedef weights hesapla

Guardrail Check: L32/L34â€™den gelen tetiklere ve son pencereye bak; freeze / reduce / rollback kararlarÄ± Ã¼ret

Enforce: L35 Ã¼zerinden bayrak aÄŸÄ±rlÄ±klarÄ±nÄ± yayÄ±nla (bandit.enforce.request)

Cooldown & Stability: uygulandÄ±ktan sonra cooldownMin kadar freeze; requireStableMin saÄŸlanÄ±rsa bir sonraki ramp

Emit & Distribute: bandit.plan.ready, kart, metrikler; rapor/Ã¶zet L22; etik gerekirse L26

Feedback to Experiments: L36â€™ya bandit kararlarÄ±nÄ±n Ã¶zetini gÃ¶nder (analiz raporlarÄ±na ek)

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (schedule tick | new data) â†’ UPDATE

UPDATE â†’ PLAN (weights)

PLAN â†’ (guardrails OK) ENFORCE | (breach) ROLLBACK/FREEZE

ENFORCE â†’ COOLDOWN (cooldownMin)

COOLDOWN â†’ (requireStableMin OK) IDLE | (breach) ROLLBACK/FREEZE

FREEZE â†’ (recovery) IDLE

ROLLBACK â†’ COOLDOWN â†’ IDLE

Hata: ALERT ve durum korunur; idem: aynÄ± banditKey tekrar eylem doÄŸurmaz

8) Kenar Durumlar

Underpowered: minSamplesPerVariant altÄ± â†’ ramp yok, yalnÄ±z safeExplorePct sÃ¼rer

Variant aÃ§lÄ±k (starvation): minTraffic ile garanti; UCB/TS seÃ§imi sÄ±rasÄ±nda aÄŸÄ±rlÄ±ÄŸÄ± Ã§ok dÃ¼ÅŸen varyant asla 0 olmaz

BÃ¼yÃ¼k sÄ±Ã§rama: ramp>ethicsRequiredForBigJumpPct â†’ L26 onayÄ± zorunlu

GerÃ§ek olay (incident): freezeDuringIncident=true â†’ COOLDOWN/FREEZE

Segmentli mod: segmentMode='per_segment' â†’ her segment iÃ§in ayrÄ± bandit ve ayrÄ± aÄŸÄ±rlÄ±k seti

Sticky drift: salt rotasyonu (L35) sÄ±rasÄ±nda graceful geÃ§iÅŸ; mevcut atamalar korumaya Ã§alÄ±ÅŸÄ±lÄ±r

Cost/SLO Ã§akÄ±ÅŸmasÄ±: en emniyetli (daha dÃ¼ÅŸÃ¼k pay) kararÄ± uygula; L34/L32 ile uyumlu

Observer gÃ¶rÃ¼nÃ¼mÃ¼: yalnÄ±z toplam aÄŸÄ±rlÄ±klar ve kart; parametre/priors gizli

DRILL/SHADOW: tatbikat verileri Ã¶ÄŸrenmeye katÄ±lmaz, raporda ayrÄ± bÃ¶lÃ¼m

9) Telemetri
{
  "bandit.metrics": {
    "event":"bandit.metrics","timestamp":"iso8601",
    "updates":3,"rollbacks":1,"segments":2,
    "p50UpdateMs":6.2,"p95UpdateMs":12.4,
    "safeExplorePct":5,
    "avgReward_control":0.740,"avgReward_v2":0.781,
    "guardrailBlocks":{"slo":0,"cost":0,"ethics":0}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/guardrailBanditAllocator.ts
services/livia/lib/bandit/posterior.ts          # TS/UCB/Eps/Linear modelleri
services/livia/lib/bandit/context.ts            # baÄŸlamsal vektÃ¶rleÅŸtirme (one-hot, cyclical)
services/livia/lib/bandit/plan.ts               # minTraffic, maxRamp, safeExplore, segment
services/livia/lib/bandit/guardrails.ts         # L32/L34 kÃ¶prÃ¼sÃ¼
services/livia/lib/bridges.ts                   # L35/L22/L26/L36 kÃ¶prÃ¼leri
services/livia/state/banditStore.ts             # idem index + posterior param + plan geÃ§miÅŸi
services/livia/__tests__/guardrailBanditAllocator.test.ts
cfg/livia.bandit.yaml

11) Test Ä°skeleti (Jest/Vitest)

TS gÃ¼ncelleme: success akÄ±ÅŸÄ±nda v2 posteriÃ¶rÃ¼ â†‘ â†’ aÄŸÄ±rlÄ±k %45â†’%60

UCB modu: c=2.0 ile daha agresif keÅŸif; minTraffic ihlali yok

Epsilon programÄ±: 0.1â†’0.02 yarÄ±-Ã¶mÃ¼r 120dk; safeExplorePct ile birlikte Ã§alÄ±ÅŸÄ±r

Ramp kÄ±sÄ±tÄ±: maxRampPerStepPct=15 â†’ %40â†’%60 ok, %40â†’%70 blok

Guardrail ihlali: L32 p95 latency breach â†’ rollback.request + FREEZE

Cost artÄ±ÅŸÄ±: L34 hard guard â†’ pay azalt, freeze

Segmentli bandit: region=eu-central iÃ§in v2 %65 olurken global %55 kaldÄ±

Underpowered: N<200 â†’ yalnÄ±z safe explore; plan deÄŸiÅŸmedi

Idempotency: aynÄ± banditKey tekrar yazmÄ±yor; card yalnÄ±z gÃ¼ncelleniyor

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

12:00 baÅŸlangÄ±Ã§: control %55 / v2 %45

12:30 TS gÃ¼ncellemesi: v2 uplift â†’ plan %60; bandit.enforce.request â†’ L35

12:45 cooldown tamam; guardrails OK â†’ %60 kalÄ±r

13:10 cost early-warn yok; SLO normal â†’ %60â†’%65 (segment=eu-central)

13:25 L32 breach geldi â†’ bandit.rollback.request â†’ control %100 â†’ FREEZE 15dk â†’ recovery sonrasÄ± yeniden %55/%45

13) SLO

p95 update+plan < 15 ms

guardrail kaÃ§Ä±rma â‰¤ %1, yanlÄ±ÅŸ blok â‰¤ %1

ramp uygunsuzluÄŸu (maxRamp ihlali) = 0

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-38 Â· provenanceChainLogger.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
LIVIA ekosistemi iÃ§indeki tÃ¼m kritik kararlar, raporlar ve daÄŸÄ±tÄ±mlar iÃ§in menÅŸe zinciri (provenance) kaydÄ± tutmak: hangi kaynak(lar)dan hangi dÃ¶nÃ¼ÅŸÃ¼m adÄ±mlarÄ± ile kim tetikledi, ne Ã¼retildi? Her adÄ±m hashâ€™li, imzalÄ±, zaman damgalÄ±, append-only (WORM) zincire eklenir; gÃ¼nlÃ¼k/oturum bazlÄ± Merkle kÃ¶kleri Ã¼retilip â€œsealâ€ edilir. DoÄŸrulama iÃ§in zincir denetimi ve artifaktâ†’zincir eÅŸlemesi yapÄ±lÄ±r.
I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; L21 (redaksiyon), L27 (gizli anahtar tarama), L22 (daÄŸÄ±tÄ±m), L14 (digest), L15 (postmortem) ve L26 (etik/WORM) entegre.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy|compliance okur, yazÄ±m sistem

Gizlilik: PII yok; operatÃ¶r kimlikleri saltâ€™lÄ± hash; serbest metinler L21 ile redakte

Kripto: sha256 iÃ§erik/parÃ§a hashâ€™i, Merkle kÃ¶kÃ¼, Ed25519 zincir imzasÄ± (KMS/HSM)

Ä°dempotency: provKey = dayISO + chainId + sequenceNo

Observability: spans (prov.open,prov.append,prov.seal,prov.verify) + metrics

WORM: state/provenance/worm/{YYYY-MM-DD}/chain.log + seal.json; append-only kuralÄ±

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "provenance.open": {
    "event":"provenance.open","timestamp":"iso8601",
    "chainId":"daily|incident:{id}|release:{version}",
    "context":{"forDate":"2025-09-15","tz":"Europe/Istanbul","owner":"system"},
    "saltRef":"daily"  // operatÃ¶r pseudonym tuzu
  },

  "provenance.append": {
    "event":"provenance.append","timestamp":"iso8601",
    "chainId":"daily",
    "kind":"ingest|transform|decision|distribution|policy_change|seal_hint",
    "actor":{"role":"system|ops|policy|qa","pseudo":"op#7f9a12"},
    "inputRefs":[
      {"refType":"file|event|artifact","path":"data/digest/2025-09-15/digest.md","hash":"sha256:..."},
      {"refType":"event","id":"slo.guard.triggered#...","hash":"sha256:..."}
    ],
    "transform":{"name":"markdown.compose|policy.patch|gate.apply|analyze","version":"vX","params":{"p95":920}},
    "outputRef":{"refType":"artifact","path":"data/digest/2025-09-15/digest.html","hash":"sha256:..."},
    "notes":"Ã¶zet: SLO at_riskâ†’ok",
    "flags":{"DRILL":false,"SHADOW":false}
  },

  "provenance.link": {
    "event":"provenance.link","timestamp":"iso8601",
    "from":{"chainId":"daily","sequenceNo":128},
    "to":{"chainId":"incident:inc-2025-09-15-1","sequenceNo":12},
    "reason":"incident_summary_reference"
  },

  "provenance.seal.request": {
    "event":"provenance.seal.request","timestamp":"iso8601",
    "chainId":"daily","sealMode":"daily|rolling|incident_close"
  },

  "artifact.ready": {
    "event":"artifact.ready","timestamp":"iso8601",
    "kind":"digest|postmortem|policy|cost.report|drill.report",
    "path":"data/postmortem/2025-09-15/inc-.../report.md",
    "hash":"sha256:...",
    "links":[{"chainId":"incident:inc-2025-09-15-1","sequenceNo":42}]
  },

  "provenance.verify.request": {
    "event":"provenance.verify.request","timestamp":"iso8601",
    "chainId":"daily","target":{"path":"data/digest/2025-09-15/digest.html","hash":"sha256:..."},
    "mode":"fast|full"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "provenance.opened": {
    "event":"provenance.opened","timestamp":"iso8601",
    "chainId":"daily","chainPath":"state/provenance/worm/2025-09-15/chain.log",
    "sequenceStart":1,"prevSealHash":"sha256:..."
  },

  "provenance.appended": {
    "event":"provenance.appended","timestamp":"iso8601",
    "chainId":"daily","sequenceNo":129,
    "entryHash":"sha256:...","merkleLeaf":"sha256:...","chainTip":"sha256:..."
  },

  "provenance.sealed": {
    "event":"provenance.sealed","timestamp":"iso8601",
    "chainId":"daily",
    "merkleRoot":"sha256:...","entries":342,
    "seal":{"sig":"ed25519:...","signer":"kms:key/livia-prov","ts":"iso8601"},
    "sealPath":"state/provenance/worm/2025-09-15/seal.json",
    "optionalAnchors":[{"kind":"notary","txRef":"local:ots-2025-09-15.json"}]
  },

  "provenance.verify.result": {
    "event":"provenance.verify.result","timestamp":"iso8601",
    "chainId":"daily","target":{"path":"...","hash":"sha256:..."},
    "ok":true,"proof":{"merklePath":["sha256:...","sha256:..."],"root":"sha256:..."},
    "sealedAt":"iso8601","signer":"kms:key/livia-prov"
  },

  "provenance.alert": {
    "event":"provenance.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"worm_violation|hash_mismatch|seal_signature_invalid|idempotent_duplicate|rbac_denied|tsa_unavailable",
    "context":{"chainId":"daily","sequenceNo":130}
  },

  "provenance.metrics": {
    "event":"provenance.metrics","timestamp":"iso8601",
    "chainsOpen":2,"appends":342,"seals":1,"verifications":7,
    "p95AppendMs":3.8,"p95VerifyMs":6.1,"wormViolations":0
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  storage:{
    wormDir:"state/provenance/worm/{YYYY-MM-DD}",
    chainFile:"chain.log",           // JSONL append
    sealFile:"seal.json",
    indexFile:"index.json",          // sequenceNoâ†’byteOffset haritasÄ±
    rotateDaily:true
  },

  crypto:{
    hash:"sha256",
    merkle:{ fanout:2 },             // binary merkle
    sign:{ algo:"ed25519", keyRef:"kms:key/livia-prov" },
    tsa:{ enabled:false, kind:"rfc3161|ots", endpoint:"", timeoutMs:2000 } // opsiyonel
  },

  redaction:{ profile:"generic" },    // L21
  secretScan:{ enabled:true },        // L27 â€“ append edilen entryâ€™lerde tarama
  ethics:{ enforceFor:"policy_change|distribution" }, // L26

  links:{
    autoFromArtifacts:true,           // artifact.readyâ†’provenance.append
    acceptFrom:["L14","L15","L22","L23","L24","L31","L32","L34","L35","L36","L37"]
  },

  seal:{
    at:"23:59:30",                    // gÃ¼nlÃ¼k otomatik seal
    onIncidentClose:true,
    requireMinEntries:1
  },

  verify:{
    modeDefault:"fast",               // merkle proof + imza kontrolÃ¼
    fullScanSchedule:"Sun 04:00"      // haftalÄ±k tÃ¼m zincir tam tarama
  },

  idempotencyTtlSec: 86400
}

5) KayÄ±t ÅemasÄ± (entry formatÄ±)

Her provenance.append Ã§aÄŸrÄ±sÄ± zincire tek satÄ±r JSON ekler (JSONL).
Alanlar:

seq (artÄ±rÄ±mlÄ±), ts, chainId, prevHash, entryHash, merkleLeaf,

kind, actor.pseudo, inputRefs[], transform{}, outputRef, notes, flags{}.
entryHash = sha256(canonicalJson(entryWithoutEntryHash)).
Merkle yapraÄŸÄ± entryHashâ€™tir; seal sÄ±rasÄ±nda kÃ¶k hesaplanÄ±r.

6) Pipeline (Kompozisyon)

Open: zincir mevcutsa devam; deÄŸilse provenance.open â†’ provenance.opened

Append: gelen provenance.append ve artifact.ready olaylarÄ± â†’ redaksiyon (L21) + secret tarama (L27) â†’ hash/leaf hesap â†’ append (atomic fs) â†’ provenance.appended

Link: zincirler arasÄ± baÄŸ (provenance.link) append edilir; Ã§apraz zincir kanÄ±tÄ± oluÅŸur

Seal: planlÄ± veya istek Ã¼zerine Merkle kÃ¶kÃ¼ + Ed25519 imza; opsiyonel TSA/OTS Ã¢nkoru â†’ provenance.sealed

Verify: hedef artifaktÄ±n hashâ€™i zincirde var mÄ±? merkle path + imza doÄŸrula â†’ provenance.verify.result

Distribute/Index: Ã¶nemli sealed/verify sonuÃ§larÄ±nÄ± L22 ile daÄŸÄ±t, L24â€™te â€œprovenanceâ€ etiketiyle indeksle

Metrics: sayÄ±lar, p95 ms, WORM olaylarÄ±

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (provenance.open | gÃ¼n baÅŸÄ±) â†’ OPEN

OPEN â†’ (provenance.append|artifact.ready|provenance.link) â†’ APPEND (rolling)

APPEND â†’ (schedule seal.at | provenance.seal.request) â†’ SEAL

SEAL â†’ IDLE

VERIFY (istek Ã¼zerine) â†’ provenance.verify.result â†’ IDLE

Hata: ALERT + IDLE; idem: aynÄ± provKey ikinci kez yazmaz

8) Kenar Durumlar

WORM ihlali: dosya bÃ¼yÃ¼klÃ¼ÄŸÃ¼/byte offset uyuÅŸmaz â†’ worm_violation + zincir kilitlenir, yalnÄ±z okuma

Hash mismatch: artifakt yeniden Ã¼retildi ancak hash aynÄ± deÄŸil â†’ hash_mismatch uyarÄ±

Out-of-order append: sequence yanlÄ±ÅŸ â†’ reddet, idempotent_duplicate kontrolÃ¼

TSA unavailable: zincir yine seal edilir; TSA Ã¢nkoru â€œpendingâ€ kalÄ±r

Large chain: index file ile random-access; merkle fanout=2

Secrets/PII: secret taramasÄ± bulursa provenance.alert("secret_leak") + L27 yoluna karantinaya yÃ¶nlendir

Observer gÃ¶rÃ¼nÃ¼mÃ¼: detay maskeli (actor pseudo), hashler gÃ¶rÃ¼nÃ¼r

Cross-link dÃ¶ngÃ¼leri: linkâ€™e izin var ama doÄŸrulamada yalnÄ±z â€œaâ†’bâ€ yÃ¶nÃ¼ kanÄ±tlanÄ±r; dÃ¶ngÃ¼ kÄ±sÄ±tlama uyarÄ±sÄ±

9) Telemetri
{
  "provenance.metrics": {
    "event":"provenance.metrics","timestamp":"iso8601",
    "chainsOpen":2,"appends":342,"seals":1,"verifications":7,
    "p50AppendMs":1.9,"p95AppendMs":3.8,"p95VerifyMs":6.1,
    "wormViolations":0,"hashMismatches":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/provenanceChainLogger.ts          # FSM + orchestrator
services/livia/lib/prov/hasher.ts                # canonical JSON + sha256 + merkle
services/livia/lib/prov/signer.ts                # ed25519 + KMS/HSM kÃ¶prÃ¼sÃ¼
services/livia/lib/prov/worm.ts                  # append-only dosya, index yÃ¶netimi
services/livia/lib/prov/verify.ts                # proof oluÅŸturma/doÄŸrulama
services/livia/lib/redact.ts                     # LIVIA-21
services/livia/lib/bridges.ts                    # L22/L24/L26/L27/L14/L15 kÃ¶prÃ¼leri
services/livia/state/provenanceStore.ts          # idem index + seal state
services/livia/__tests__/provenanceChainLogger.test.ts
cfg/livia.provenance.yaml

11) Test Ä°skeleti (Jest/Vitest)

Open/Append: canonical JSON â†’ entryHash sabit, sÄ±ralama/doÄŸrulama doÄŸru

Seal: Merkle kÃ¶kÃ¼ + ed25519 imza doÄŸrulandÄ±; seal.json yazÄ±ldÄ±

Verify: artifact.ready hashâ€™i zincirde; merkle path + imza OK

WORM: dÄ±ÅŸ mÃ¼dahalede bÃ¼yÃ¼klÃ¼k/offset bozuldu â†’ worm_violation + kilit

Secret taramasÄ±: provenance.append notlarÄ±nda gizli anahtar â†’ secret_leak + karantina

Cross-link: daily â†” incident zinciri linkâ€™i doÄŸrulandÄ±

Idempotency: aynÄ± provKey ikinci yazÄ±ma izin yok

RBAC/Observer: maskeli gÃ¶rÃ¼nÃ¼m; PII yok

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

00:01 provenance.open(daily) â†’ zincir aÃ§Ä±ldÄ±

GÃ¼n iÃ§inde L14/L22/L32/L34 olaylarÄ± â†’ her biri provenance.append ile zincire iÅŸlendi

18:20 artifact.ready(digest.html) â†’ append; link ile incident zincirine baÄŸlandÄ±

23:59 provenance.seal.request(daily) â†’ Merkle root + ed25519 imza â†’ provenance.sealed

Ertesi gÃ¼n provenance.verify.request(target=digest.html) â†’ verify.result(ok).

13) SLO

p95 append < 5 ms

p95 verify < 10 ms

WORM ihlali = 0

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
_____________________________________________________________________________________________
LIVIA-39 Â· dataLineageIndexer.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
LIVIA ekosistemindeki uÃ§tan uca veri soy kÃ¼tÃ¼ÄŸÃ¼nÃ¼ (data lineage) kur, gÃ¼ncel tut ve sorgulanabilir hale getir: kaynak (stream/table/file) â†’ Ã¶zellik (feature) â†’ model â†’ politika/karar/rapor/artifakt zincirini zaman yolculuÄŸu (as-of) ile Ã§Ä±kar; blast radius/impact analizi yap; provenance (L38) ile baÄŸla; uyumsuzluk (schema drift, gizli anahtar sÄ±zÄ±ntÄ±sÄ±) ve kalite (SLO/L32) sinyalleriyle uyar.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; WORM benzeri append log; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: ops|data|policy|compliance okuyabilir; yazÄ±m sistem

Gizlilik: PII yok; operatÃ¶r kimlikleri saltâ€™lÄ± hash; serbest metinler L21 redaksiyon

Ä°dempotency: lineageKey = eventId|sha256(payload); snapshot: snapshotKey = asOfISO + scope

Observability: spans (lin.ingest,lin.index,lin.query,lin.impact) + metrics

Uyumluluk: WORM benzeri append (state/lineage/worm/{YYYY-MM-DD}/graph.log); L38 ile Ã§ift yÃ¶nlÃ¼ link

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "dataset.registered": {
    "event":"dataset.registered","timestamp":"iso8601",
    "id":"ds:kinesis:feed_ticks",
    "kind":"stream|table|file|topic",
    "schema":{"fields":[{"name":"symbol","type":"string"},{"name":"price","type":"float"},{"name":"ts","type":"timestamp"}],"version":"v7"},
    "owner":"ops","sla":{"freshnessMsP95":800,"availabilityPct":99.9},
    "tags":["market","realtime"]
  },

  "dataset.schema.updated": {
    "event":"dataset.schema.updated","timestamp":"iso8601",
    "id":"ds:kinesis:feed_ticks","prevVersion":"v7","newVersion":"v8",
    "diff":[{"op":"add","path":"/fields/-","value":{"name":"venue","type":"string"}}]
  },

  "feature.registered": {
    "event":"feature.registered","timestamp":"iso8601",
    "id":"feat:slip.p95","owner":"ops",
    "source":{"datasetId":"ds:kinesis:feed_ticks","transforms":["groupBy(symbol,5m)","p95(slip)"]},
    "version":"v3","tags":["guard","anomaly"]
  },

  "model.trained": {
    "event":"model.trained","timestamp":"iso8601",
    "id":"model:slip_anomaly:v5",
    "inputs":{"features":["feat:slip.p95","feat:lat.p95"],"window":"14d"},
    "artifact":{"path":"artifacts/models/slip_anom/v5.onnx","hash":"sha256:..."},
    "metrics":{"auprc":0.81,"latencyMsP95":18}
  },

  "job.run": {
    "event":"job.run","timestamp":"iso8601",
    "id":"job:compose.digest.daily","inputs":[
      {"refType":"feature","id":"feat:slip.p95"},
      {"refType":"event","id":"telemetry.slo.status#..."}
    ],
    "outputs":[{"refType":"artifact","path":"data/digest/2025-09-15/digest.md","hash":"sha256:..."}],
    "status":"success|failed","durationMs":820
  },

  "policy.change.applied": {
    "event":"policy.change.applied","timestamp":"iso8601",
    "id":"policy:bounds:v42",
    "changes":[{"path":"/spread_max","from":0.003,"to":0.002}],
    "impactTargets":["guard.activity","confirmation.bounds"]
  },

  "decision.emitted": {
    "event":"decision.emitted","timestamp":"iso8601",
    "id":"dec:gate.rate_limit:2025-09-15T14:08:00+03:00",
    "reason":"slo.guard.triggered#hash","scope":"feed_ws","artifactRef":"state/gates/active.json"
  },

  "artifact.ready": {
    "event":"artifact.ready","timestamp":"iso8601",
    "kind":"digest|postmortem|policy|cost.report|drill.report|model",
    "path":"data/digest/2025-09-15/digest.html","hash":"sha256:...","links":[]
  },

  "provenance.appended": {
    "event":"provenance.appended","timestamp":"iso8601",
    "chainId":"daily","sequenceNo":129,"entryHash":"sha256:...","outputRef":{"path":"data/digest/2025-09-15/digest.html"}
  }
}


Notlar:

Kaynak olaylarÄ±n Ã§oÄŸu diÄŸer modÃ¼llerden gelir (L14/L15/L22/L23/L32/L34/L35/L36/L37/L38).

Her id evrimseldir (SCD2): version alanÄ± veya asOf zarfÄ± ile izlenir.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "lineage.index.ready": {
    "event":"lineage.index.ready","timestamp":"iso8601",
    "asOf":"iso8601","nodes":1324,"edges":5340,
    "graphSig":"sha256:...","indexPath":"state/lineage/index/2025-09-15/asOf=.../graph.json"
  },

  "lineage.impact.ready": {
    "event":"lineage.impact.ready","timestamp":"iso8601",
    "source":"dataset.schema.updated#ds:kinesis:feed_ticks@v8",
    "blastRadius":{"downstreamArtifacts":9,"affectedModels":["model:slip_anomaly:v5"],"guards":["L32"],"flags":["kb.hybridSearch.v2"]},
    "recommendations":["notify:ops","run:tests:compat","freeze:bandit_for_segments"],
    "pathSample":[["ds:kinesis:feed_ticks","feat:slip.p95","model:slip_anomaly:v5","decision:gate.rate_limit"]]
  },

  "lineage.query.result": {
    "event":"lineage.query.result","timestamp":"iso8601",
    "requestId":"q#7f2a","mode":"downstream|upstream|both|why",
    "from":{"refType":"artifact","path":"data/digest/2025-09-15/digest.html"},
    "asOf":"iso8601","result":{"nodes":24,"edges":53,"subgraphPath":"state/lineage/queries/q#7f2a.json"}
  },

  "lineage.card": {
    "event":"lineage.card","timestamp":"iso8601",
    "title":"Lineage GÃ¼ncellendi â€” as-of 15:40",
    "body":"Yeni ÅŸema v8: feed_ticks â†’ 1 model, 2 guard, 9 artifakt etkilenebilir.",
    "severity":"info","ttlSec":600
  },

  "lineage.alert": {
    "event":"lineage.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"schema_drift|dangling_edge|cycle_detected|worm_violation|idempotent_duplicate|rbac_denied",
    "context":{"node":"feat:slip.p95"}
  },

  "lineage.metrics": {
    "event":"lineage.metrics","timestamp":"iso8601",
    "ingested":420,"nodes":1324,"edges":5340,
    "p95IngestMs":5.8,"p95QueryMs":8.1,"cycles":0,"dangling":3
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  storage:{
    wormDir:"state/lineage/worm/{YYYY-MM-DD}",
    appendFile:"graph.log",           // JSONL append (node/edge ops)
    snapshotDir:"state/lineage/index/{YYYY-MM-DD}",
    compactEvery:"1h"                 // snapshot/compact periyodu
  },

  graph:{
    // dÃ¼ÄŸÃ¼mler ve kenarlar iÃ§in tip sÃ¶zlÃ¼ÄŸÃ¼
    nodeTypes:["dataset","feature","model","job","policy","decision","artifact","event","flag","experiment","guard"],
    edgeTypes:["derives_from","consumes","produces","governs","emits","links_to","depends_on","explains"],
    maxInMemNodes: 200_000
  },

  sdc:{ // Slowly Changing Data
    trackVersions:true, mode:"type2", asOfQueries:true
  },

  quality:{
    onSchemaDrift:"warn_and_impact",
    onDanglingEdge:"repair_orphan|warn",
    onCycle:"break_with_virtual_node|error"
  },

  integrations:{
    provenance:"LIVIA-38",
    housekeeping:"LIVIA-31",
    sloGuard:"LIVIA-32",
    costGuard:"LIVIA-34",
    flags:"LIVIA-35",
    experiments:"LIVIA-36",
    bandit:"LIVIA-37",
    dist:"LIVIA-22",
    redact:"LIVIA-21",
    secrets:"LIVIA-27",
    kb:"LIVIA-24"
  },

  indexing:{
    buildReverseEdges:true,           // upstream/downstream hÄ±zlÄ±
    keepAdjacencyLists:true,
    hashGraph:true                    // graphSig hesapla (Merkle benzeri)
  },

  query:{
    defaultMode:"both",
    limitNodes: 5000,
    allowWhyAnswer:true               // provenance Ã¼zerinden aÃ§Ä±klama zinciri
  },

  retention:{
    hotDays: 14, warmDays: 90, coldDays: 365, keepForever:false
  },

  idempotencyTtlSec: 86400
}

5) Veri Modeli (Ã¶zet)

Node: { id, type, version?, asOf?, attrs:{...} }

id Ã¶rnek: ds:kinesis:feed_ticks, feat:slip.p95, model:slip_anomaly:v5, policy:bounds:v42, artifact:.../digest.html

Edge: { fromId, toId, type, atISO, attrs }

Ã–rnek: ds â†’ feat (derives_from), feat â†’ model (consumes), model â†’ decision (emits), policy â†’ guard (governs), artifact â†’ provenance (links_to)

6) Pipeline (Kompozisyon)

Ingest: gelen olaylarÄ± Zod ile doÄŸrula; node/edge Ã§Ä±kar; WORM graph.log a append et

Index: saatlik (veya tetikle) append log â†’ snapshot (adjacency list + reverse index + as-of haritalarÄ±)

Link with Provenance (L38): artifact.ready ve provenance.appended olaylarÄ±ndan why-chain kenarlarÄ± (explains)

Quality Checks: schema drift/dangling/cycle; drift varsa impact analizi yap

Impact Analyzer: deÄŸiÅŸen node iÃ§in downstream artifacts/models/guards/flags setini ve blast radius Ã¶lÃ§; Ã¶neriler Ã¼ret

Query: lineage.query.request ile upstream/downstream/both/why; as-of anÄ±nda alt-grafÄ± Ã§Ä±kar, dosyaya yaz

Distribute/Index: kart/raporlarÄ± L22 ile daÄŸÄ±t; L24 KB â€œlineageâ€ altÄ±nda indeksle

Metrics: ingest/query p95, node/edge sayÄ±larÄ±, anomaly uyarÄ±larÄ±

7) Sorgu API (olay olarak)
{
  "lineage.query.request": {
    "event":"lineage.query.request","timestamp":"iso8601",
    "requestId":"q#7f2a",
    "mode":"downstream|upstream|both|why",
    "from":{"refType":"node|artifact|dataset|feature|model|policy|decision","idOrPath":"feat:slip.p95"},
    "asOf":"2025-09-15T15:40:00+03:00",          // yoksa "now"
    "depthMax":6,
    "filters":{"nodeTypes":["model","artifact","guard"],"edgeTypes":["consumes","produces","emits","governs"]},
    "format":"json|dot|md", "includeAttrs":true
  }
}

8) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (*.registered|*.updated|job.run|artifact.ready|provenance.appended) â†’ INGEST

INGEST â†’ INDEX (planlÄ±/sinyal ile)

INDEX â†’ (lineage.query.request) â†’ QUERY

QUERY â†’ EMIT (query.result | impact.ready | card) â†’ IDLE

Hata: ALERT + IDLE; idem: aynÄ± lineageKey ikinci kez yazÄ±lmaz

9) Kenar Durumlar

Schema drift: dataset.schema.updated â†’ quality.onSchemaDrift uygula; drift etkisi impact.ready ile rapor

Cycle: ETL yanlÄ±ÅŸ eÅŸleme â†’ cycle_detected; alt-graf break_with_virtual_node ile kesilerek raporlanÄ±r

Dangling edge: toId yok â†’ repair_orphan dene; olmazsa dangling_edge warn

Version forks: aynÄ± id farklÄ± version eÅŸ zamanlÄ± â†’ SCD2 â€œas-ofâ€ ile ayrÄ±ÅŸtÄ±r

Large graph: maxInMemNodes aÅŸÄ±mÄ± â†’ streaming query; sonuÃ§lar parÃ§alÄ± yazÄ±lÄ±r

Secrets/PII: append metinlerinde L27 sÄ±zÄ±ntÄ±sÄ± â†’ block+quarantine

Observer: yalnÄ±z Ã¶zet kart ve why zinciri kÄ±sa listesi; ham path gizli

Drill/Shadow: L29/L33 iÅŸaretli node/edgeâ€™ler prod analizden ayrÄ± tutulur

10) Telemetri
{
  "lineage.metrics": {
    "event":"lineage.metrics","timestamp":"iso8601",
    "ingested":420,"nodes":1324,"edges":5340,
    "p50IngestMs":2.3,"p95IngestMs":5.8,"p95QueryMs":8.1,
    "cycles":0,"dangling":3,"schemaDrifts":1
  }
}

11) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/dataLineageIndexer.ts              # FSM + orchestrator
services/livia/lib/lineage/parser.ts              # olayâ†’node/edge Ã§Ä±karÄ±cÄ±
services/livia/lib/lineage/store.ts               # WORM append + snapshot/compact
services/livia/lib/lineage/query.ts               # upstream/downstream/why/as-of
services/livia/lib/lineage/impact.ts              # blast radius & Ã¶neriler
services/livia/lib/lineage/quality.ts             # drift/cycle/dangling denetimleri
services/livia/lib/prov/linker.ts                 # L38 kÃ¶prÃ¼sÃ¼ (why-chain)
services/livia/lib/redact.ts                      # L21
services/livia/lib/bridges.ts                     # L22/L24/L27/L31/L32/L34/L35/L36/L37/L38
services/livia/state/lineageStore.ts              # idem index + snapshot bilgisi
services/livia/__tests__/dataLineageIndexer.test.ts
cfg/livia.lineage.yaml

12) Test Ä°skeleti (Jest/Vitest)

Ingest/Index: datasetâ†’featureâ†’modelâ†’artifact zinciri oluÅŸturuldu; snapshot Ã¼retildi

Schema drift: v7â†’v8 alan ekleme â†’ impact.ready + kart

Why query: artifactâ†’provenanceâ†’inputs zinciri doÄŸru geri Ã§Ã¶zÃ¼ldÃ¼

Downstream blast: dataset deÄŸiÅŸimi â†’ model/guard/artifact seti listelendi

Cycle: yapay dÃ¶ngÃ¼ algÄ±landÄ± ve sanal dÃ¼ÄŸÃ¼mle kÄ±rÄ±ldÄ±

Dangling: orphan edge uyarÄ±ldÄ±; self-heal Ã§alÄ±ÅŸtÄ±

Idempotency: aynÄ± olay ikinci kez yazÄ±lmadÄ±

Secrets: sÄ±zÄ±ntÄ± denemesinde alert + karantina tetiklendi

Observer gÃ¶rÃ¼nÃ¼mÃ¼: Ã¶zet kartta yalnÄ±z sayÄ±lar/baÅŸlÄ±klar

13) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

10:05 dataset.registered(feed_ticks@v7) â†’ 10:10 feature.registered(slip.p95) â†’ 10:20 model.trained(v5)

14:00 dataset.schema.updated v8 â†’ impact: model:slip_anomaly:v5, L32, 9 artifakt potansiyel etki â†’ lineage.card

18:15 job.run(digest.compose) â†’ artifact.ready(digest.html) â†’ provenance.appended ile why-chain kuruldu

18:20 lineage.query.request(both, from=artifact, asOf=18:20) â†’ alt-graf JSON/DOT Ã§Ä±ktÄ±.

14) SLO

p95 ingest < 10 ms / olay

p95 query < 12 ms (â‰¤5K dÃ¼ÄŸÃ¼m alt-graf)

cycle yanlÄ±ÅŸ pozitif â‰¤ %1; dangling self-heal â‰¥ %80

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-40 Â· privacyRiskScorer.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Metin/Ã§Ä±ktÄ±/rapor/telemetri/kaynak dosyalarÄ±ndaki gizlilik riskini gerÃ§ek zamanlÄ± hesapla; k-anonimlik / l-Ã§eÅŸitlilik / t-yakÄ±nlÄ±k esinli sezgisel Ã¶lÃ§Ã¼ler + PII dedektÃ¶rleri (TR odaklÄ±) + baÄŸlam/audience kurallarÄ±yla risk skoru Ã¼ret. Skora gÃ¶re redaksiyon (L21), maskeleme/downgrade, karantina/blok, onay/consent kontrolÃ¼ ve (gerekirse) etik kapÄ± (L26) tetikleyerek gÃ¼venli yayÄ±n/indeksleme saÄŸlar. I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; provenance (L38) ve lineage (L39) ile izlenebilir.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: privacy|policy yazar, ops|observer sÄ±nÄ±rlÄ± okur

Gizlilik: PII tespit edilen ham iÃ§erik memory-safe; yalnÄ±z redakte edilmiÅŸ Ã¶rnekler daÄŸÄ±tÄ±lÄ±r

Ä°dempotency: privacyKey = sourceId + contentHash + scope + windowISO

Observability: OpenTelemetry spans (priv.detect,priv.score,priv.decide,priv.enforce) + metrics

Uyumluluk: KVKK/GDPR sezgisel kurallar; WORM (L38/L26) iÃ§in karar kayÄ±tlarÄ± append

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "text.submitted": {
    "event":"text.submitted","timestamp":"iso8601",
    "sourceId":"kb.ingest|ui.chat|runbook.log|postmortem|dist.msg",
    "content":"string",
    "lang":"tr|en|auto",
    "audience":"internal|partner|public",
    "tags":{"namespace":"kb_default","DRILL":false,"SHADOW":false}
  },

  "artifact.ready": {
    "event":"artifact.ready","timestamp":"iso8601",
    "kind":"digest|postmortem|policy|cost.report|drill.report|model.output",
    "path":"data/digest/2025-09-15/digest.html",
    "hash":"sha256:...","previewText":"kÄ±sa Ã¶zet veya null",
    "audience":"internal|partner|public","tags":{"namespace":"kb_default"}
  },

  "model.output": {
    "event":"model.output","timestamp":"iso8601",
    "modelId":"gpt:chat|onnx:anomaly","requestId":"req#abc",
    "content":"string","purpose":"assist|decision|notify",
    "audience":"internal|partner|public"
  },

  "kb.ingest.request": {
    "event":"kb.ingest.request","timestamp":"iso8601",
    "path":"uploads/hr/avans_2024.xlsx","kind":"file|html|md|pdf",
    "namespace":"kb_default","audience":"internal"
  },

  "telemetry.sample": {
    "event":"telemetry.sample","timestamp":"iso8601",
    "series":"dialog.turn|dist.sent|guard.activity","payload":{"text":"... veya null","meta":{"email":"..."}}
  },

  "consent.ledger.query": {
    "event":"consent.ledger.query","timestamp":"iso8601",
    "subjectHash":"sub#7f9a12","purpose":"kb_index|notification|ops",
    "result":"granted|denied|unknown","expiresAt":"iso8601|null"
  }
}


Not: DRILL/SHADOW (L29/L33) etiketli iÃ§erikler ayrÄ± skorlanÄ±r ve varsayÄ±lan olarak yayÄ±nlanmaz.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "privacy.score.ready": {
    "event":"privacy.score.ready","timestamp":"iso8601",
    "sourceId":"kb.ingest","contentHash":"sha256:...","audience":"internal",
    "score":0.78,"level":"low|medium|high|critical",
    "signals":{
      "pii":{"email":3,"phone":1,"tckn":1,"iban":0,"card":0,"address":2,"dob":1,"geo":0},
      "quasiIds":["zipcode","birth_year","gender"],
      "kAnonEst":4,"lDiv":1,"tClose":0.34
    },
    "actions":["redact","mask","consent_check","quarantine?false"],
    "hash":"sha256:..."
  },

  "privacy.action.proposed": {
    "event":"privacy.action.proposed","timestamp":"iso8601",
    "sourceId":"kb.ingest","level":"high",
    "plan":{"redact":["email","phone","tckn","address"],"mask":["iban"],"downgradeAudience":"internal","blockPublish":false}
  },

  "privacy.enforced": {
    "event":"privacy.enforced","timestamp":"iso8601",
    "sourceId":"kb.ingest","result":"ok|blocked|quarantined",
    "outputRef":{"path":"data/kb/redacted/2025-09-15/file.md","hash":"sha256:..."},
    "via":"LIVIA-21"
  },

  "privacy.card": {
    "event":"privacy.card","timestamp":"iso8601",
    "title":"Gizlilik Skoru â€” HIGH (0.78)",
    "body":"EmailÃ—3, TCKNÃ—1, adresÃ—2 bulundu â€¢ Redaksiyon uygulandÄ±, audience=internal.",
    "severity":"warn","ttlSec":600
  },

  "privacy.alert": {
    "event":"privacy.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|consent_unknown|redact_failed|quarantine|rbac_denied|ethics_required"
  },

  "privacy.metrics": {
    "event":"privacy.metrics","timestamp":"iso8601",
    "scored":128,"redacted":54,"blocked":3,"quarantined":1,
    "p95DetectMs":7.8,"p95ScoreMs":2.6,"falsePosRate":0.02
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  detectors:{
    email:{ regex: true },
    phoneTR:{ pattern: "\\b(?:\\+90|0)?\\s?5\\d{2}[\\s-]?\\d{3}[\\s-]?\\d{2}[\\s-]?\\d{2}\\b" },
    tckn:{ algo:"mod11", allowFormatted:true },        // TÃ¼rkiye Cumhuriyeti Kimlik No
    ibanTR:{ pattern:"\\bTR\\d{24}\\b" },
    card:{ luhn:true },
    address:{ ner:"address" },
    personName:{ ner:"person" },
    dob:{ pattern:"\\b\\d{2}[./-]\\d{2}[./-]\\d{4}\\b" },
    geo:{ pattern:"\\b(\\d{1,2}\\.\\d+),(\\d{1,2}\\.\\d+)\\b" }
  },

  quasiIdentifiers:["zipcode","birth_year","gender","city","employer","dept"],

  thresholds:{
    level:{ low:"score<0.3", medium:"0.3<=score<0.6", high:"0.6<=score<0.8", critical:"score>=0.8" },
    blockIf:{ level:"critical", tcknAny:true, cardAny:true },
    quarantineIf:{ massLeakFields: ["tckn","card","ibanTR"], countGte: 3 }
  },

  audiencePolicy:{
    publicMaxLevel:"low",
    partnerMaxLevel:"medium",
    internalMaxLevel:"high"
  },

  actions:{
    redactVia:"LIVIA-21",
    downgradeAudience:true,
    consentCheck:true,                 // unknown â†’ escalate/info
    ethicsGateFor:"public_high|critical", // L26
    lineageLink:true,                  // L39
    provenanceAppend:true              // L38
  },

  storage:{
    redactedDir:"data/redacted/{YYYY-MM-DD}",
    quarantineDir:"data/quarantine/{YYYY-MM-DD}"
  },

  idempotencyTtlSec: 3600
}

5) Skor Modeli (Ã¶zet)

score âˆˆ [0,1] â€” artan risk.

PII yoÄŸunluÄŸu (w=0.45): normalize(âˆ‘ tÃ¼r_aÄŸÄ±rlÄ±ÄŸÄ± Ã— adet)

AÄŸÄ±rlÄ±k Ã¶rn.: tckn:1.0, card:1.0, iban:0.8, email:0.4, phone:0.4, address:0.6, dob:0.6, name:0.3

K-anonimlik kestirimi (w=0.25): kAnonEst = min_grup_boyutu(quasiId kombinasyonlarÄ±) â†’ katkÄ± 1/kAnonEst (kâ‰¤5 riskli)

l-Ã§eÅŸitlilik (w=0.15): hassas nitelik (Ã¶rn. hastalÄ±k/maaÅŸ kategorisi) Ã§eÅŸit sayÄ±sÄ±; lDiv<2 â†’ risk â†‘

t-yakÄ±nlÄ±k (w=0.10): grup daÄŸÄ±lÄ±mÄ± ile evrensel daÄŸÄ±lÄ±m arasÄ±ndaki uzaklÄ±k (JS divergence ~ tClose)

BaÄŸlam/audience (w=0.05): public > partner > internal cezalarÄ±

Consent etkisi: consent=denied/unknown â†’ +0.1â€¦+0.2 ceza

Not: K ve l, akÄ±ÅŸta Ã¶rneklem/Ã¶zetleme ile tahmin edilir (namespace bazlÄ± counters). KÃ¼Ã§Ã¼k N â†’ belirsizlik dÃ¼zeltmesi (Bayes beta Ã¶ncÃ¼lÃ¼) uygulanÄ±r.

6) Pipeline (Kompozisyon)

Detect: iÃ§erikten PII tespiti (regex/NER/Luhn/algoritma); DRILL/SHADOW ayrÄ±ÅŸtÄ±r

Quasi-ID Aggregation: namespace iÃ§inde son 30 gÃ¼nde kAnon/lDiv/tClose iÃ§in sayÄ±mlar/gÃ¶stergeler gÃ¼ncellenir

Consent: varsa consent.ledger.query ile eÅŸle (subject hash/alanlardan)

Score: 5 bileÅŸenli skor; audience/consent cezalarÄ±

Decide:

blockIf â†’ blok +/veya karantina

Aksi halde actions planÄ±: redact (L21), mask, audience downgrade, gerekirse ethics gate (L26)

Enforce: L21 Ã¼zerinden redaksiyon/mask; Ã§Ä±ktÄ± yolu yazÄ±lÄ±r

Emit: privacy.score.ready + privacy.action.proposed + (uygulanÄ±nca) privacy.enforced + kart/alert/metrics

Provenance & Lineage: provenance.append (L38) ve lineage kenarlarÄ± (L39) eklenir

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (text.submitted|artifact.ready|model.output|kb.ingest.request|telemetry.sample) â†’ DETECT

DETECT â†’ SCORE â†’ DECIDE â†’ (ENFORCE) â†’ EMIT â†’ IDLE

Hata: ALERT + IDLE; idem: aynÄ± privacyKey tekrar yan etki doÄŸurmaz

8) Kenar Durumlar

False positive dÃ¼ÅŸÃ¼rme: e-posta tarzÄ± foo@local & test kartlarÄ± masum listede â†’ ceza dÃ¼ÅŸÃ¼r

FormatlanmÄ±ÅŸ veriler: CSV/Excel sÃ¼tun adlarÄ± (e.g. TC_Kimlik_No) â†’ otomatik yÃ¼ksek risk

MaskelenmiÅŸ iÃ§erik: **** ile saklÄ± veriler tespit edilirse risk katkÄ±sÄ± yarÄ±ya iner

Ã‡ok kÃ¼Ã§Ã¼k Ã¶rnek: kAnon hesaplanamÄ±yorsa belirsizlik â†’ score += 0.05

Public audience ihlali: publicMaxLevel aÅŸÄ±ldÄ± â†’ blockPublish + ethics_required uyarÄ±sÄ±

Consent unknown: partner/public iÃ§in warn + consent_check; internal iÃ§in bilgi

DRILL/SHADOW: yayÄ±n yapma, yalnÄ±z rapora yaz; digestâ€™te ayrÄ± bÃ¶lÃ¼m

RBAC/Observer: sadece Ã¶zet kart; ham iÃ§erik gÃ¶sterilmez

9) Telemetri
{
  "privacy.metrics": {
    "event":"privacy.metrics","timestamp":"iso8601",
    "scored":128,"levels":{"low":42,"medium":31,"high":45,"critical":10},
    "redacted":54,"blocked":3,"quarantined":1,
    "p50DetectMs":3.4,"p95DetectMs":7.8,"p95ScoreMs":2.6,
    "falsePosRate":0.02,"consentUnknown":12
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/privacyRiskScorer.ts            # FSM + orchestrator
services/livia/lib/privacy/detectors.ts        # regex/NER/Luhn/TCKN/IBAN/TR phone
services/livia/lib/privacy/score.ts            # k-anon/l-div/t-close + baÄŸlam/consent
services/livia/lib/privacy/actions.ts          # redact/mask/downgrade/quarantine
services/livia/lib/privacy/consent.ts          # consent ledger kÃ¶prÃ¼sÃ¼
services/livia/lib/redact.ts                   # LIVIA-21
services/livia/lib/bridges.ts                  # L22/L24/L26/L38/L39 kÃ¶prÃ¼leri
services/livia/state/privacyStore.ts           # idem index + counters + history
services/livia/__tests__/privacyRiskScorer.test.ts
cfg/livia.privacy.yaml

11) Test Ä°skeleti (Jest/Vitest)

TCKN + email + adres: score â‰¥ 0.8 â†’ critical â†’ block/quarantine

IBAN maskeli: risk dÃ¼ÅŸer, redact+mask uygulanÄ±r

Public audience: high â†’ ethics_required + blockPublish

kAnon kÃ¼Ã§Ã¼k (k=3): high seviye; redaksiyon sonrasÄ± mediuma iner

Consent unknown (partner): warn + consent_check

DRILL/SHADOW: yayÄ±n yok; yalnÄ±z metrics ve rapor

Idempotency: aynÄ± iÃ§erik ikinci kez yan etki yok

False positive seti: test kart numarasÄ± (4111â€¦1111) â†’ dÃ¼ÅŸÃ¼k risk

Provenance/Lineage: append ve link Ã§Ä±ktÄ±larÄ± yazÄ±ldÄ±

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

kb.ingest.request(upload.pdf) â†’ DETECT: emailÃ—3, TCKNÃ—1, adresÃ—2 â†’ score=0.78 (HIGH)

DECIDE: redact(email, tckn, address), mask IBAN, audience publicâ†’internal

ENFORCE: L21 redaksiyon; Ã§Ä±ktÄ± data/redacted/... â†’ privacy.enforced(ok)

privacy.card daÄŸÄ±tÄ±ldÄ± (L22) â†’ provenance.append + lineage baÄŸlantÄ±sÄ± oluÅŸturuldu â†’ digest (L14) Ã¶zetine girdi.

13) SLO

p95 detect < 10 ms / 2KB metin

p95 score < 5 ms

yanlÄ±ÅŸ blok â‰¤ %1, kaÃ§Ä±rma â‰¤ %1

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-41 Â· dataQualitySentinel.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
TÃ¼m veri akÄ±ÅŸlarÄ± ve tablolar iÃ§in veri kalite bekÃ§isi kur: tazelik (freshness), tamlÄ±k (completeness), tekillik (uniqueness/dedup), tutarlÄ±lÄ±k (consistency/RI), ÅŸema uyumu, daÄŸÄ±lÄ±m/outlier ve iÅŸ kurallarÄ± kontrollerini gerÃ§ek zamanlÄ± + pencere bazlÄ± Ã§alÄ±ÅŸtÄ±r; ihlalleri karantinaya al, replay/onarÄ±m (L31/L42) planla, rapor & kart Ã¼ret, lineage/provenance (L39/L38) ile baÄŸla, digestâ€™e (L14) Ã¶zet dÃ¼ÅŸ. I/O event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; yerel pencere 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: data|ops|policy yÃ¶netir, observer sÄ±nÄ±rlÄ± okur

Gizlilik: PII yok; serbest metin Ã¶zetleri L21 ile redakte; sÄ±zÄ±ntÄ± ÅŸÃ¼phesinde L27/L40 kÃ¶prÃ¼sÃ¼

Ä°dempotency: dqKey = datasetId + windowISO + ruleId + scope

Observability: OpenTelemetry spans (dq.collect,dq.check,dq.quarantine,dq.replay,dq.report) + metrics

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "dataset.registered": {
    "event":"dataset.registered","timestamp":"iso8601",
    "id":"ds:kinesis:feed_ticks|tbl:orders_daily|file:ingest/hr_2025-09.csv",
    "kind":"stream|table|file|topic",
    "schema":{"version":"v7","fields":[{"name":"ts","type":"timestamp"},{"name":"symbol","type":"string"},{"name":"price","type":"float"}]},
    "owner":"ops","sla":{"freshnessMsP95":800,"availabilityPct":99.9},
    "partitioning":{"by":"day|hour|none","field":"ts"}
  },

  "dq.rule.registered": {
    "event":"dq.rule.registered","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","ruleId":"r:feed_ticks.core",
    "dimensions":{
      "freshness":{"p95MsMax":900},
      "completeness":{"expectedPerMin":">=1200"},
      "uniqueness":{"key":["ts","symbol"],"toleranceDupPctMax":0.1},
      "schema":{"version":"v7"},
      "range":{"field":"price","min":0.0001,"max":100000},
      "consistency":[{"type":"ref_integrity","refDataset":"tbl:symbols","on":["symbol"]}]
    },
    "severity":"warn|error"
  },

  "dq.sample.ingested": {
    "event":"dq.sample.ingested","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","partitionKey":"2025-09-15T14:05:00+03:00",
    "count":1200,"minTs":"iso8601","maxTs":"iso8601",
    "dupCount":2,"nulls":{"symbol":0,"price":0},
    "badRows":[{"reason":"range_violation","rowHash":"sha256:...","ts":"iso8601","symbol":"AVAXUSDT","price":-1}]
  },

  "dataset.partition.ready": {
    "event":"dataset.partition.ready","timestamp":"iso8601",
    "datasetId":"tbl:orders_daily","partition":"2025-09-14"
  },

  "dataset.schema.updated": {
    "event":"dataset.schema.updated","timestamp":"iso8601",
    "id":"ds:kinesis:feed_ticks","prevVersion":"v7","newVersion":"v8",
    "diff":[{"op":"add","path":"/fields/-","value":{"name":"venue","type":"string"}}]
  },

  "dq.check.request": {
    "event":"dq.check.request","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks",
    "window":{"from":"2025-09-15T14:00:00+03:00","to":"2025-09-15T15:00:00+03:00"},
    "rules":["r:feed_ticks.core"],"dryRun":false
  },

  "dq.replay.request": {
    "event":"dq.replay.request","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","partitions":["2025-09-15T14:00:00+03:00/14:59:59"],
    "reason":"completeness_gap","priority":"high"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "dq.check.ready": {
    "event":"dq.check.ready","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","window":{"from":"iso8601","to":"iso8601"},
    "ruleId":"r:feed_ticks.core",
    "score":0.94,"levels":{"freshness":"ok","completeness":"at_risk","uniqueness":"ok","schema":"ok","range":"ok","consistency":"ok"},
    "findings":{"completenessGapPct":0.7,"dupPct":0.09,"p95FreshnessMs":760},
    "actions":["monitor","replay?true","quarantine?false"],
    "hash":"sha256:..."
  },

  "dq.quarantine": {
    "event":"dq.quarantine","timestamp":"iso8601",
    "datasetId":"tbl:orders_daily","partitions":["2025-09-14"],
    "reason":"uniqueness_violation","path":"data/quarantine/tbl_orders_daily/2025-09-14",
    "ttlDays":7
  },

  "dq.replay.enqueued": {
    "event":"dq.replay.enqueued","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks",
    "partitions":["2025-09-15T14:00:00+03:00/14:59:59"],
    "via":"LIVIA-31|LIVIA-42","jobId":"replay#7f9a12"
  },

  "dq.report.ready": {
    "event":"dq.report.ready","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","forDate":"2025-09-15",
    "path":"data/dq/2025-09-15/ds_kinesis_feed_ticks/report.md",
    "summary":"Freshness p95 760ms â€¢ Completeness -%0.7 gap (replay queued) â€¢ Dup %0.09 â€¢ Åema OK.",
    "hash":"sha256:..."
  },

  "dq.card": {
    "event":"dq.card","timestamp":"iso8601",
    "title":"DQ â€” feed_ticks (14:00â€“15:00)",
    "body":"Freshness OK â€¢ Completeness -%0.7 â†’ replay â€¢ DiÄŸerleri OK.",
    "severity":"info","ttlSec":600
  },

  "dq.alert": {
    "event":"dq.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"schema_drift|freshness_breach|completeness_gap|dup_spike|range_violation|consistency_fail|quarantine|replay_failed|idem_duplicate|rbac_denied"
  },

  "dq.metrics": {
    "event":"dq.metrics","timestamp":"iso8601",
    "checks":84,"violations":5,"quarantinedPartitions":2,"replays":3,
    "p95CheckMs":8.2,"dupPctAvg":0.04,"freshnessP95MsAvg":720
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  windows:["5m","1h","24h"],                // stream: 5m/1h; batch: 24h
  sampling:{ rate:1.0, maxBadRowsPerWin:100 },

  defaults:{
    freshness:{ p95MsMax:900 },
    completeness:{ expectedPerMin:">=1200" },  // stream Ã¶rneÄŸi
    uniqueness:{ toleranceDupPctMax:0.1 },
    range:{}, schema:{}, consistency:{}
  },

  quarantine:{
    enabled:true, dir:"data/quarantine/{datasetId}/{partition}",
    ttlDays:7, redactPreview:true   // L21
  },

  replay:{
    enabled:true, via:["LIVIA-31","LIVIA-42"], // housekeeper + ÅŸema adaptÃ¶rÃ¼
    maxPerRun:20, backoffMs:500
  },

  reporting:{
    outputDir:"data/dq/{YYYY-MM-DD}/{datasetId_sanitized}",
    mdFile:"report.md", htmlFile:"report.html",
    html:{ embedMiniCSS:true, chartsInlineSvg:true },
    include:{ topViolations:10, sampleBadRows:10 }
  },

  integrations:{
    digest:"LIVIA-14", dist:"LIVIA-22", lineage:"LIVIA-39", provenance:"LIVIA-38",
    privacy:"LIVIA-40", secrets:"LIVIA-27", housekeeper:"LIVIA-31", schemaMitigator:"LIVIA-42",
    sloGuard:"LIVIA-32"
  },

  scoring:{
    weights:{ freshness:0.25, completeness:0.30, uniqueness:0.20, schema:0.10, range:0.10, consistency:0.05 },
    bands:{ ok:"score>=0.95", at_risk:"0.85<=score<0.95", breach:"score<0.85" }
  },

  rbacViews:{
    observer:{ showBadRowSamples:false, showOnlySummary:true }
  },

  idempotencyTtlSec: 3600
}

5) Kontrol MantÄ±ÄŸÄ± (Ã¶zet)

Freshness: p95(now - event.ts) â‰¤ p95MsMax (stream) / â€œpartition arrived byâ€ SLA (batch)

Completeness: stream â†’ dakikada en az expectedPerMin; batch â†’ partition satÄ±r sayÄ±sÄ± eÅŸik/istatistik

Uniqueness: keyâ€™e gÃ¶re gÃ¶rÃ¼lmÃ¼ÅŸ-hash seti; dupPct â‰¤ tolerance

Schema: schema.version karÅŸÄ±laÅŸtÄ±r; drift â†’ L42â€™yi bilgilendir

Range/Outlier: alan bazlÄ± min/max; z-skor/IQR ile uÃ§ deÄŸer uyarÄ±larÄ±

Consistency: referans veri/RI; eÅŸleÅŸmeyen anahtar oranÄ±

Skor: her boyut 0â€¦1 normalize; weights ile birleÅŸik skor

6) Pipeline (Kompozisyon)

Collect: dq.sample.ingested|dataset.partition.ready|dataset.schema.updated

Aggregate: pencere/partition bazlÄ± sayaÃ§lar, p95 tazelik, dup %, null haritalarÄ±

Evaluate: kayÄ±tlÄ± dq.rule.* + defaults â†’ seviye/score + bulgular

Decide: quarantine & replay koÅŸullarÄ±; schema drift â†’ L42; freshness breach â†’ L32 early-warn

Enforce: karantina dizinine taÅŸÄ±, eriÅŸimi kÄ±sÄ±tla; replay kuyruÄŸa at (L31/L42)

Report: md/html rapor oluÅŸtur; L21 ile redaksiyon; dosyaya yaz

Emit & Distribute: dq.check.ready, dq.report.ready, dq.card, dq.alert, dq.metrics; L22 ile kart

Link: provenance.append (L38) + lineage kenarlarÄ± (L39)

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (Ã¶rnek/partition/istek) â†’ COLLECT

COLLECT â†’ EVAL â†’ (ENFORCE) â†’ REPORT â†’ EMIT â†’ IDLE

Hata: ALERT + IDLE; idem: aynÄ± dqKey iÃ§in ikinci yan etki yok

8) Kenar Durumlar

Pencere boÅŸluÄŸu: veri gelmezse completeness gap â†’ replay.enqueued (stream re-download)

Åema drift: minor (ek alan) â†’ warn + L42 adapt; breaking (alan tipi deÄŸiÅŸimi) â†’ error + quarantine

AÅŸÄ±rÄ± dup: dupPct > eÅŸik Ã—2 â†’ halt ingest (policy sinyali)

AÄŸÄ±rlÄ±klandÄ±rma: geÃ§ici pike karÅŸÄ± EWMA ile yumuÅŸatma

Observer: kÃ¶tÃ¼ satÄ±r Ã¶rnekleri gizli; yalnÄ±z sayÄ±lar

Gizlilik riski: kÃ¶tÃ¼ satÄ±rda PII â†’ L40 ile skorla, public raporda maskeli

Idempotency: aynÄ± partition/ts iÃ§in tekrar karantina yapÄ±lmaz, yalnÄ±z rapor gÃ¼ncellenir

9) Telemetri
{
  "dq.metrics": {
    "event":"dq.metrics","timestamp":"iso8601",
    "checks":84,"violations":5,"quarantinedPartitions":2,"replays":3,
    "p50CheckMs":3.6,"p95CheckMs":8.2,"freshnessP95MsAvg":720,
    "dupPctAvg":0.04,"schemaDrifts":1
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/dataQualitySentinel.ts           # FSM + orchestrator
services/livia/lib/dq/rules.ts                  # boyut kontrolleri (fresh/completeness/uniqueness/...)
services/livia/lib/dq/aggregate.ts              # pencere sayaÃ§larÄ± & p95 hesaplar
services/livia/lib/dq/enforce.ts                # quarantine & replay kÃ¶prÃ¼leri
services/livia/lib/dq/report.ts                 # md/html raporlama
services/livia/lib/bridges.ts                   # L14/L21/L22/L31/L32/L38/L39/L40/L42
services/livia/state/dqStore.ts                 # idem index + counters + history
services/livia/__tests__/dataQualitySentinel.test.ts
cfg/livia.dq.yaml

11) Test Ä°skeleti (Jest/Vitest)

Freshness breach: p95>900ms â†’ level=breach, card warn

Completeness gap: beklenen/dakika < eÅŸik â†’ replay.enqueued

Uniqueness: dupPct>0.1 â†’ quarantine ve halt ingest sinyali

Schema drift: v7â†’v8; minor â†’ warn, breaking â†’ quarantine

Consistency: RI miss >%1 â†’ consistency_fail uyarÄ±sÄ±

Report/Redaction: md/html yazÄ±ldÄ±, PII saklÄ± Ã¶rnekler maskelendi

Idempotency: aynÄ± dqKey ikinci kez yan etki yok

Observer gÃ¶rÃ¼nÃ¼mÃ¼: Ã¶rnek satÄ±rlar gizli

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

14:00â€“15:00 feed Ã¶rnekleri toplandÄ± â†’ EVAL: freshness OK, completeness âˆ’%0.7 â†’ replay.enqueued

15:05 dataset.schema.updated v8 â†’ minor drift â†’ warn + L42â€™ye iÅŸaret

18:00 gÃ¼n sonu dq.report.ready â†’ L22 ile daÄŸÄ±tÄ±ldÄ±, L14 digestâ€™e Ã¶zet girdi, L38/L39 zincirleri iÅŸlendi.

13) SLO

p95 check < 10 ms / pencere

yanlÄ±ÅŸ karantina â‰¤ %1, kaÃ§Ä±rÄ±lan ihlal â‰¤ %1

replay baÅŸarÄ± oranÄ± â‰¥ %95 (saÄŸlayÄ±cÄ± mÃ¼saitken)

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
ChatGPT:
12s boyunca dÃ¼ÅŸÃ¼ndÃ¼m
LIVIA-42 Â· schemaChangeAutoMitigator.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
AkÄ±ÅŸ/tablo/konu dosyalarÄ±nda ÅŸema deÄŸiÅŸimini (schema drift/evolution) otomatik tespit, risk sÄ±nÄ±flama, adaptÃ¶r Ã¼retimi (projection/cast/default/derive/rename/merge-split), gÃ¶lge doÄŸrulama (shadow), kanarya yayÄ±lÄ±m, backfill/replay ve rollback ile kesintisiz veri sÃ¼rekliliÄŸi saÄŸlamak.
Kaynak: L41 (DQ drift), L39 (lineage/impact), L38 (provenance), L31 (housekeeper), L32 (SLO guard).
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: data|ops|policy yazar, observer sÄ±nÄ±rlÄ± okur

Gizlilik: PII yok; metin Ã¶zetler L21 redakte

Ä°dempotency: schemaKey = datasetId + newSchemaVer + planHash + windowISO

Observability: Spans (sch.diff,sch.plan,sch.shadow,sch.apply,sch.backfill,sch.rollback) + metrics

Uyumluluk: Karar kayÄ±tlarÄ± L38 WORM; etkiler L39 lineageâ€™a iÅŸlenir

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "dataset.schema.updated": {
    "event":"dataset.schema.updated","timestamp":"iso8601",
    "id":"ds:kinesis:feed_ticks|tbl:orders_daily|topic:events_v2",
    "prevVersion":"v7","newVersion":"v8",
    "diff":[
      {"op":"add","path":"/fields/-","value":{"name":"venue","type":"string"}},
      {"op":"modify","path":"/fields/price/type","from":"float","to":"decimal(20,8)"},
      {"op":"rename","path":"/fields/sym","to":"symbol"}
    ],
    "breakingHint":false
  },

  "dq.alert": {
    "event":"dq.alert","timestamp":"iso8601",
    "level":"warn|error","message":"schema_drift",
    "context":{"datasetId":"ds:kinesis:feed_ticks","expectedVer":"v7","seenVer":"v8"}
  },

  "lineage.impact.ready": {
    "event":"lineage.impact.ready","timestamp":"iso8601",
    "source":"dataset.schema.updated#ds:kinesis:feed_ticks@v8",
    "blastRadius":{"downstreamArtifacts":9,"affectedModels":["model:slip_anomaly:v5"],"guards":["L32"]}
  },

  "schema.adapter.apply.request": {
    "event":"schema.adapter.apply.request","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","newSchema":"v8",
    "mode":"shadow|canary|full","dryRun":true,
    "plan":{"dsl":"...","hash":"sha256:plan"}
  },

  "schema.backfill.request": {
    "event":"schema.backfill.request","timestamp":"iso8601",
    "datasetId":"tbl:orders_daily","from":"2025-09-01","to":"2025-09-15",
    "reason":"type_widen|rename|add_field_default","priority":"normal|high"
  },

  "schema.rollback.request": {
    "event":"schema.rollback.request","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","targetSchema":"v7","reason":"shadow_mismatch|sla_breach|downstream_break"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "schema.adapter.suggested": {
    "event":"schema.adapter.suggested","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","from":"v7","to":"v8",
    "risk":"low|medium|high|breaking","plan":{"dsl":"...", "hash":"sha256:plan"},
    "actions":["shadow_validate","canary_10pct","notify_downstream"],"notes":"price cast decimal(20,8); symâ†’symbol rename; venue add default=null"
  },

  "schema.shadow.result": {
    "event":"schema.shadow.result","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","newSchema":"v8",
    "window":{"from":"iso8601","to":"iso8601"},
    "mismatchPct":0.0,"castErrors":0,"nullInflation":{"venue":0.0},
    "perf":{"p95ProcMs":2.1},"ok":true
  },

  "schema.adapter.applied": {
    "event":"schema.adapter.applied","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","mode":"canary|full","planHash":"sha256:plan",
    "rollout":{"percent":25,"minStableMin":20},"ok":true
  },

  "schema.backfill.enqueued": {
    "event":"schema.backfill.enqueued","timestamp":"iso8601",
    "datasetId":"tbl:orders_daily","range":{"from":"2025-09-01","to":"2025-09-15"},
    "via":"LIVIA-31","jobId":"bf#7f9a12","partitions":15
  },

  "schema.migration.report.ready": {
    "event":"schema.migration.report.ready","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","from":"v7","to":"v8",
    "path":"data/schema/2025-09-15/ds_kinesis_feed_ticks/migration.md",
    "summary":"Risk=low; shadow OK; canary %25; backfill gereksiz; downstream 1 model uyumlu.",
    "hash":"sha256:..."
  },

  "schema.rollback.done": {
    "event":"schema.rollback.done","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","to":"v7","reason":"sla_breach","ok":true
  },

  "schema.card": {
    "event":"schema.card","timestamp":"iso8601",
    "title":"Åema AdaptÃ¶rÃ¼ â€” ds:kinesis:feed_ticks (v7â†’v8)",
    "body":"Risk: dÃ¼ÅŸÃ¼k â€¢ Shadow OK â€¢ Canary %25 â€¢ Sonraki adÄ±m: %50 (20dk stabil).",
    "severity":"info","ttlSec":900
  },

  "schema.alert": {
    "event":"schema.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"breaking_change|shadow_mismatch|cast_error|downstream_break|rollback|idem_duplicate|rbac_denied"
  },

  "schema.metrics": {
    "event":"schema.metrics","timestamp":"iso8601",
    "adaptersSuggested":3,"shadowRuns":4,"canaries":2,"fullApplies":1,"rollbacks":0,
    "p95PlanMs":11.2,"p95ShadowMs":6.1,"castErrorRate":0.0001
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  classification:{
    rules:[
      { kind:"add_field", risk:"low", action:["default_null|constant|derive"] },
      { kind:"type_widen", from:["int","float"], to:["decimal*","double"], risk:"low", action:["cast_safe"] },
      { kind:"rename", risk:"medium", action:["map_field","update_downstream_refs"] },
      { kind:"type_narrow", risk:"high", action:["cast_check","shadow_required","canary_required"] },
      { kind:"drop_field", risk:"high", action:["projection_warn","backfill_optional"] },
      { kind:"semver_break", risk:"breaking", action:["block","manual_approval"] }
    ]
  },

  dsl:{
    version:"v1",
    // Ã¶rnek: map/cast/default/derive/merge/split
    functions:["map","cast","default","derive","rename","merge","split","drop","coalesce","parse_json","format_ts","hash"],
    validateStrict:true
  },

  defaults:{
    onAddField:{ default:"null" },
    onRename:{ updateDownstream:true },
    onTypeCast:{ mode:"safe", onError:"to_null|to_default|drop_row" }
  },

  rollout:{
    steps:[10,25,50,100], minStableMin:20,
    abortOn:{ dqBreach:true, sloGuard:true }
  },

  shadow:{
    enabled:true, percent:10, compareMode:"row_shape|value_sample",
    mismatchTolerancePct:0.01
  },

  backfill:{
    enable:true, partitionsPerJob:20, parallel:4, via:"LIVIA-31",
    throttleIO:"medium"
  },

  integrations:{
    dq:"LIVIA-41", lineage:"LIVIA-39", provenance:"LIVIA-38",
    housekeeper:"LIVIA-31", sloGuard:"LIVIA-32", dist:"LIVIA-22"
  },

  reporting:{
    outputDir:"data/schema/{YYYY-MM-DD}/{datasetId_sanitized}",
    mdFile:"migration.md", htmlFile:"migration.html",
    html:{ embedMiniCSS:true, chartsInlineSvg:true }
  },

  idempotencyTtlSec: 86400
}

5) AdaptÃ¶r DSL (Ã¶zet)

Åablon:

version: v1
from: v7
to: v8
mappings:
  - map: { from: "sym", to: "symbol" }
  - cast: { field: "price", to: "decimal(20,8)", onError: "to_null" }
  - default: { field: "venue", value: null }
  - derive: { field: "price_usd", expr: "price * fx('TRYUSD')" }
  - drop: { field: "legacy_flag" }
  - split: { field: "user_fullname", into: ["name","surname"], by: " " }
  - merge: { fields: ["city","country"], to: "location", sep: ", " }


DoÄŸrulama: zorunlu alanlar var mÄ±? tÃ¼r uyumu? onError politikasÄ±?

Yan etkiler: rename sonrasÄ± downstream referanslarÄ± gÃ¼ncellenebilir (L39).

Performans: format_ts/parse_json gibi aÄŸÄ±r fonksiyonlar canaryâ€™de Ã¶lÃ§Ã¼lÃ¼r.

6) Risk Skoru (Ã¶zet)

risk âˆˆ {low, medium, high, breaking} â†’ sÄ±nÄ±flandÄ±rma kurallarÄ± + bulgular:

Field add â‡’ low (default/derive ile telafi)

Type widen â‡’ low (cast safe)

Rename â‡’ medium (downstream mapping gerekir)

Type narrow / drop â‡’ high (veri kaybÄ± riski)

Semver break / primary key change â‡’ breaking (manuel onay ÅŸart)

7) Pipeline (Kompozisyon)

Diff & Classify: dataset.schema.updated|dq.alert(schema_drift) â†’ farkÄ± Ã§Ä±kar, risk sÄ±nÄ±fÄ± ata

Plan: DSL tabanlÄ± adaptÃ¶r planÄ±nÄ± synthesize et (rename/map/cast/default/deriveâ€¦); schema.adapter.suggested yay

Shadow: planÄ± shadow modda uygula; mismatchPct, castErrors, performans Ã¶lÃ§ â†’ schema.shadow.result

Canary/Full: shadow OK ise rollout.steps ile canary â†’ full; abortOn koÅŸullarÄ±nda dur/geri al

Backfill/Replay: batch tablolarÄ±nda tarih aralÄ±klarÄ± iÃ§in backfill kuyrukla (L31)

Rollback: SLA/DQ ihlalinde eski ÅŸemaya dÃ¶n; lineage/provenance gÃ¼ncelle

Report & Distribute: migration raporu md/html; kart/uyarÄ±; L22 daÄŸÄ±tÄ±m, L39/L38 baÄŸlantÄ±larÄ±

Metrics: plan/uygulama/geri alma sayaÃ§larÄ±, p95 sÃ¼reler

8) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (dataset.schema.updated|dq.alert) â†’ DIFF

DIFF â†’ PLAN (adapter DSL) â†’ SHADOW

SHADOW â†’ (ok) CANARY | (mismatch) ROLLBACK

CANARY â†’ (stabil) FULL | (dq/slo breach) ROLLBACK

FULL â†’ BACKFILL? â†’ REPORT â†’ IDLE

ROLLBACK â†’ REPORT â†’ IDLE

Hata: ALERT + IDLE; idem: aynÄ± schemaKey ikinci kez yan etki yok

9) Kenar Durumlar

JSON/Variant alan: ÅŸema dÄ±ÅŸÄ± serbest alanlar iÃ§in parse_json + derive ile normalize

PK/Ordering deÄŸiÅŸimi: ingestion sÄ±rasÄ± bozulursa breaking; yalnÄ±z gÃ¶lge doÄŸrulama ve manuel onay

Null ÅŸiÅŸmesi: yeni alanlarda aÅŸÄ±rÄ± null â†’ default/derive stratejisini deÄŸiÅŸtir

Cast hatalarÄ±: to_null yerine to_default geÃ§ici; hata oranÄ± eÅŸiÄŸi aÅŸarsa canary durdur

Downstream kÄ±rÄ±lma: L39 blast radius bÃ¼yÃ¼kse rollout adÄ±mlarÄ± kÃ¼Ã§Ã¼lt (%5, %10â€¦)

SLO etkisi: L32 p95 iÅŸlem sÃ¼resi yÃ¼kselirse adÄ±m geri alÄ±nÄ±r

Observer gÃ¶rÃ¼nÃ¼mÃ¼: plan Ã¶zet; DSL detaylarÄ± kapalÄ± (RBAC)

DRILL/SHADOW verisi: prod metriklerinden ayrÄ±ÅŸtÄ±r (etiket)

10) Telemetri
{
  "schema.metrics": {
    "event":"schema.metrics","timestamp":"iso8601",
    "adaptersSuggested":3,"shadowRuns":4,"canaries":2,"fullApplies":1,"rollbacks":0,
    "p50PlanMs":5.6,"p95PlanMs":11.2,"p95ShadowMs":6.1,
    "castErrorRate":0.0001,"nullInflationMax":0.01
  }
}

11) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/schemaChangeAutoMitigator.ts     # FSM + orchestrator
services/livia/lib/schema/diff.ts               # ÅŸema diff & sÄ±nÄ±flandÄ±rma
services/livia/lib/schema/dsl.ts                # adaptÃ¶r DSL parse/validate/suggest
services/livia/lib/schema/shadow.ts             # gÃ¶lge doÄŸrulama yÃ¼rÃ¼tÃ¼cÃ¼sÃ¼
services/livia/lib/schema/rollout.ts            # canary/full uygulatÄ±cÄ±
services/livia/lib/schema/backfill.ts           # L31 kuyruklama & izleme
services/livia/lib/bridges.ts                   # L41/L39/L38/L31/L32/L22 kÃ¶prÃ¼leri
services/livia/lib/redact.ts                    # LIVIA-21
services/livia/state/schemaStore.ts             # idem index + aktif planlar
services/livia/__tests__/schemaChangeAutoMitigator.test.ts
cfg/livia.schema.yaml

12) Test Ä°skeleti (Jest/Vitest)

Add field (venue) â†’ risk low, plan default=null, shadow OK, canary %10â†’%25â†’%100

Rename (symâ†’symbol) â†’ downstream referanslarÄ± gÃ¼ncellendi (lineage), shadow 0 mismatch

Type widen (floatâ†’decimal) â†’ cast hatasÄ± yok, p95 proc < 10ms

Type narrow (decimalâ†’int) â†’ risk high, canary durduruldu, rollback

Drop field â†’ risk high, backfill opsiyonlu uyarÄ±

Breaking (PK deÄŸiÅŸimi) â†’ blocking + manuel onay gereÄŸi

DQ entegrasyonu: L41 schema_drift uyarÄ±sÄ± geldikten sonra plan Ã¼retildi

SLO entegrasyonu: L32 lat p95 yÃ¼kseliÅŸi â†’ rollout durdu â†’ rollback

Idempotency: aynÄ± schemaKey ikinci yan etki yok

Observer gÃ¶rÃ¼nÃ¼mÃ¼: DSL gizlendi, yalnÄ±z Ã¶zet

13) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

14:05 dataset.schema.updated(v7â†’v8) â†’ DIFF risk=low/medium â†’ PLAN DSL Ã¼retildi â†’ schema.adapter.suggested

14:10 SHADOW 10% â†’ mismatch 0% â†’ CANARY %25 (20dk stabil) â†’ FULL

14:45 REPORT yazÄ±ldÄ±; kart daÄŸÄ±tÄ±ldÄ±; L39 etkiler, L38 kayÄ±tlarÄ± iÅŸlendi.

14) SLO

p95 plan < 12 ms

p95 shadow validate < 8 ms (pencere/partisyon baÅŸÄ±na)

yanlÄ±ÅŸ rollout â‰¤ %1, kaÃ§Ä±rÄ±lan breaking â‰¤ %1

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-43 Â· modelDriftWatcher.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Ãœretimdeki modeller iÃ§in covariate drift (Ã¶zellik daÄŸÄ±lÄ±mÄ± kaymasÄ±) ve concept drift (etiket/iliÅŸki kaymasÄ±) ile performans/kalibrasyon bozulmalarÄ±nÄ± erken saptamak; risk seviyesine gÃ¶re aksiyon planÄ± (uyarÄ±, eÅŸik ayarÄ±, scope daraltma, fallback/championâ€™e dÃ¶nÃ¼ÅŸ, L44 otomatik yeniden-eÄŸitim, L45 kanarya/kademeli geÃ§iÅŸ) Ã¼retmek. Lineage (L39) ve Provenance (L38) zincirlerine baÄŸla; rapor & kart (L22) Ã¼ret; SLO (L32) ve Maliyet (L34) guardâ€™larÄ±yla Ã§eliÅŸmeden hareket et. I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: data|mlops|policy yÃ¶netir; observer sÄ±nÄ±rlÄ± okur

Gizlilik: PII yok; serbest metinler L21 ile redakte

Ä°dempotency: driftKey = modelId + version + windowISO + detector + scope

Observability: Spans (drift.collect,drift.detect,drift.decide,drift.enforce,drift.report) + metrics

Uyum: kritik aksiyonlar L26 etik/WORM; kayÄ±tlar L38 append

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "model.registered": {
    "event":"model.registered","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","version":"v5",
    "task":"binary|multiclass|regression|ranking",
    "features":[
      {"name":"slip_p95","type":"float"},
      {"name":"lat_p95","type":"float"},
      {"name":"symbol","type":"categorical"}
    ],
    "baseline":{
      "window":"train|holdout|first_7d_prod",
      "metrics":{"auc":0.86,"auprc":0.81,"ece":0.03,"rmse":null},
      "featureStats":{
        "slip_p95":{"mean":1.2,"std":0.4,"hist":[[0.0,0.5,0.1],[0.5,1.0,0.3],[1.0,2.0,0.6]]},
        "symbol":{"counts":{"AVAXUSDT":0.22,"SOLUSDT":0.18,"...":"..."}}
      }
    },
    "thresholds":{"score_alert":0.2,"score_block":0.35}
  },

  "model.prediction.logged": {
    "event":"model.prediction.logged","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","version":"v5",
    "sampleId":"s#7f9a12",
    "features":{"slip_p95":1.8,"lat_p95":0.92,"symbol":"AVAXUSDT"},
    "pred":{"score":0.71,"label_hat":1},
    "segment":{"region":"eu-central","desk":"default","symbol":"AVAXUSDT"}
  },

  "groundtruth.logged": {
    "event":"groundtruth.logged","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","version":"v5",
    "sampleId":"s#7f9a12","y_true":1,"labelAt":"iso8601"
  },

  "feature.snapshot": {
    "event":"feature.snapshot","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","version":"v5","window":"1h|24h|7d",
    "stats":{
      "slip_p95":{"mean":1.35,"std":0.52,"hist":[[0.0,0.5,0.06],[0.5,1.0,0.22],[1.0,2.0,0.72]]},
      "lat_p95":{"mean":0.88,"std":0.31},
      "symbol":{"counts":{"AVAXUSDT":0.34,"SOLUSDT":0.09,"...":"..."}}
    },
    "n": 12450
  },

  "model.canary.metrics": {
    "event":"model.canary.metrics","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","champion":"v5","challenger":"v6",
    "window":"1h","metrics":{"auc_delta":-0.04,"ece_challenger":0.07,"latency_ms_p95":18}
  },

  "dq.finding": {
    "event":"dq.finding","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","kind":"schema_drift|freshness|completeness",
    "details":{"newField":"venue"}
  },

  "fsync.lag": {
    "event":"fsync.lag","timestamp":"iso8601",
    "featureStore":"online","lagMsP95":160,"namespace":"kb_default"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "model.drift.covariate": {
    "event":"model.drift.covariate","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","version":"v5","window":"24h",
    "detectors":{"psi":{"slip_p95":0.32,"symbol":0.28},"ks":{"lat_p95":0.19}},
    "overall":{"domainAUC":0.78,"mmd":0.21},
    "level":"low|medium|high|critical",
    "topShift":["symbol","slip_p95"],
    "hash":"sha256:..."
  },

  "model.drift.concept": {
    "event":"model.drift.concept","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","version":"v5","window":"24h",
    "metrics":{"auc":0.79,"delta_auc":-0.07,"ece":0.06,"ppv":0.68,"fnr":0.22},
    "tests":{"page_hinkley":"alarm|ok","ddm":"warn","calibration":"off"},
    "level":"medium|high|critical",
    "segments":[{"segment":"region=eu-central","delta_auc":-0.11}]
  },

  "model.guard.triggered": {
    "event":"model.guard.triggered","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","version":"v5",
    "kind":"covariate|concept|calibration","level":"high",
    "trigger":"psi>0.25|Î”AUC<-0.05|ECE>0.05",
    "actionPlan":{
      "fallback":{"to":"v4","mode":"immediate|graceful"},
      "flag":{"reduce_traffic_pct":25},        // L35/L37
      "retrain":{"kick":"LIVIA-44","priority":"high"},
      "canary":{"deploy":"v6","via":"LIVIA-45","ramp":[10,25]},
      "threshold":{"adjust":{"score_block":0.33}}
    },
    "hash":"sha256:..."
  },

  "model.health.report.ready": {
    "event":"model.health.report.ready","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","version":"v5",
    "path":"data/model-health/2025-09-15/slip_anomaly_v5/report.md",
    "summary":"Covariate drift: PSI symbol 0.28, slip_p95 0.32 (high). Concept: Î”AUC -0.07; ECE 0.06. Ã–neri: v6 canary %10, retrain kick, threshold -0.02.",
    "hash":"sha256:..."
  },

  "model.drift.card": {
    "event":"model.drift.card","timestamp":"iso8601",
    "title":"Model Drift â€” slip_anomaly v5",
    "body":"Covariate HIGH (PSI 0.32) â€¢ Concept MEDIUM (Î”AUC -0.07) â€¢ Aksiyon: v6 canary %10 + retrain.",
    "severity":"warn","ttlSec":900
  },

  "model.drift.alert": {
    "event":"model.drift.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|underpowered|label_delay|dq_block|guard_triggered|rollback|rbac_denied|calc_error"
  },

  "model.drift.metrics": {
    "event":"model.drift.metrics","timestamp":"iso8601",
    "evaluations":84,"covariateHigh":6,"conceptHigh":3,"guards":4,
    "p95EvalMs":12.8,"labelLatencyP95Min":45,"segmentsFlagged":5
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  windows:["1h","6h","24h","7d"],

  detectors:{
    psi:{ enabled:true, threshold:{ low:0.1, medium:0.2, high:0.25, critical:0.35 } },           // Population Stability Index
    ks:{ enabled:true, pValueMax:0.01 },                                                           // Kolmogorovâ€“Smirnov
    jsd:{ enabled:true, threshold:{ high:0.15 } },                                                 // Jensenâ€“Shannon
    domainClassifier:{ enabled:true, aucHigh:0.75 },                                               // train(prod vs base)
    mmd:{ enabled:false, threshold:0.15 },                                                         // Maximum Mean Discrepancy
    shapDrift:{ enabled:true, topK:10, popCorrDrop:0.2 }                                           // aÃ§Ä±klanabilirlik kaymasÄ±
  },

  concept:{
    labelPolicy:{ maxDelayMin:1440, requireMinPositives:200, requireMinSamples:1000 },
    tests:{ pageHinkley:{ delta:0.005, lambda:50 }, ddm:{ warn:2.0, alarm:3.0 } },
    performance:{ aucDropHigh:0.05, eceHigh:0.05, rmseWorsePct:0.1 }
  },

  segments:{ sliceBy:["region","desk","symbol"], topN:10, minSamples:300 },

  actions:{
    fallback:{ enabled:true, mode:"immediate", minLevel:"critical" },
    thresholdAdjust:{ enabled:true, maxDelta:0.05 },
    retrain:{ onLevel:"medium", via:"LIVIA-44", priority:"high" },
    canary:{ onLevel:"medium", via:"LIVIA-45", steps:[10,25,50], minStableMin:20 },
    trafficAllocator:{ via:"LIVIA-37", minPctPerVariant:5 }
  },

  integrations:{
    dq:"LIVIA-41",
    schemaMig:"LIVIA-42",
    slo:"LIVIA-32",
    cost:"LIVIA-34",
    flags:"LIVIA-35",
    experiments:"LIVIA-36",
    bandit:"LIVIA-37",
    retrain:"LIVIA-44",
    canary:"LIVIA-45",
    fsync:"LIVIA-46",
    lineage:"LIVIA-39",
    provenance:"LIVIA-38",
    dist:"LIVIA-22",
    redact:"LIVIA-21"
  },

  reporting:{
    outputDir:"data/model-health/{YYYY-MM-DD}/{modelId}_{version}",
    mdFile:"report.md", htmlFile:"report.html",
    html:{ embedMiniCSS:true, chartsInlineSvg:true },
    include:{ topShiftFeatures:10, segmentTables:true, calibrationPlot:true }
  },

  rbacViews:{ observer:{ hideFeatureNames:false, hideSHAPValues:true } },

  idempotencyTtlSec: 3600
}

5) Tespit YÃ¶ntemleri (Ã¶zet)

PSI (Population Stability Index): bucketâ€™lÄ± daÄŸÄ±lÄ±mda PSI = Î£ (p_i - q_i) * ln(p_i / q_i), q=baseline, p=prod.

KS (sÃ¼rekli Ã¶zellik): D = sup_x |F_p(x) - F_q(x)|, p-valueâ‰¤0.01 uyarÄ±.

JSD (kategori): JSD(P||Q) = 0.5*KL(P||M)+0.5*KL(Q||M), M=(P+Q)/2.

Domain Classifier AUC: prod vs baseline ayrÄ±mÄ±; AUC yÃ¼ksekse daÄŸÄ±lÄ±m ayrÄ±ÅŸmÄ±ÅŸ.

MMD: Ã§ekirdek tabanlÄ± genel uzaklÄ±k.

Concept Drift:

Prequential: akÄ±ÅŸta hatalara Page-Hinkley / DDM ile alarm.

Performans: AUC/PR/Accuracy farkÄ±; Calibration (ECE/Brier) artÄ±ÅŸÄ±.

Segment UÃ§urumlarÄ±: sliceByâ€™larda Î”AUC bÃ¼yÃ¼kse lokal drift.

SHAP Drift: ortalama |SHAP| sÄ±ralamasÄ±ndaki korelasyon dÃ¼ÅŸÃ¼ÅŸÃ¼ (Ã¶rn. Spearman < (1-0.2)).

6) Pipeline (Kompozisyon)

Collect: model.prediction.logged, feature.snapshot, etiketler (groundtruth.logged), canary/champion karÅŸÄ±laÅŸtÄ±rmalarÄ±

Validate/Normalize: Zod .strict(); eksik/tekrar kayÄ±tlar tekilleÅŸtirilir; DRILL/SHADOW ayrÄ±ÅŸtÄ±rÄ±lÄ±r

Covariate Detect: PSI/KS/JSD/Domain AUC/MMD + SHAP drift; Ã¼st 10 kaymÄ±ÅŸ Ã¶zellik listesi

Concept Detect: prequential testler + etiketli pencerede AUC/ECE/PPV/FNR (yeterli Ã¶rnek ÅŸartÄ±)

Segment Analysis: sliceBy segmentlerde drift/performans farklarÄ±

Decide: seviye (low/medium/high/critical) â†’ actionPlan (fallback, threshold adjust, retrain, canary, traffic shift)

Enforce (koÅŸullu):

L37/L35 ile trafik/flag ayarÄ±, L45 ile challenger canary, L44 ile retrain kick

SLO/L32 ihlali varsa agresif fallback; Cost/L34 ile pahalÄ± aksiyonlar (Ã¶r. geniÅŸ canary) sÄ±nÄ±rlanÄ±r

Report: model saÄŸlÄ±k raporu (MD/HTML + kalibrasyon, lift, PSI/KS grafikleri) â†’ dosyaya yaz

Emit & Distribute: model.drift.*, model.guard.triggered, model.health.report.ready, kart/alert/metrics; L22 ile daÄŸÄ±t

Provenance & Lineage: tÃ¼m karar/raporlar L38 ve L39 ile zincire eklenir

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (Ã¶rnek/Ã¶zet/etiket/planlÄ± saat) â†’ EVAL

EVAL â†’ (driftâ‰¥threshold) DECIDE â†’ (ENFORCE) â†’ REPORT â†’ EMIT â†’ IDLE

Hata: ALERT + IDLE; idem: aynÄ± driftKey ikinci kez yan etki yok

8) Kenar Durumlar

Label gecikmesi: yetersiz etiket â†’ underpowered|label_delay; concept kararlarÄ± hold, yalnÄ±z covariate raporu

DQ engeli: L41 â€œschema/freshness breachâ€ â†’ drift kararÄ± beklet ve dq_block uyarÄ±sÄ±

FS gecikmesi: L46 lagMsP95 yÃ¼ksek â†’ skorlar gÃ¶zaltÄ± (confidence dÃ¼ÅŸÃ¼r)

Regime shift (L54 sinyali): global daÄŸÄ±lÄ±m deÄŸiÅŸimi â†’ temporary thresholds + hÄ±zlandÄ±rÄ±lmÄ±ÅŸ retrain

Drill/Shadow: iÅŸaretli Ã¶rnekler Ã¶ÄŸrenmeye katÄ±lmaz; raporda ayrÄ± bÃ¶lÃ¼m

Observer gÃ¶rÃ¼nÃ¼mÃ¼: ham Ã¶zellik daÄŸÄ±lÄ±mÄ± yerine Ã¶zet/anonim bucketlar

Idempotency: aynÄ± pencere/detector iÃ§in tekrar aksiyon yok; yalnÄ±z kart yenilenir

9) Telemetri
{
  "model.drift.metrics": {
    "event":"model.drift.metrics","timestamp":"iso8601",
    "evaluations":84,"covariateHigh":6,"conceptHigh":3,"guards":4,
    "p50EvalMs":6.3,"p95EvalMs":12.8,"labelLatencyP95Min":45,
    "segmentsFlagged":5,"actions":{"fallback":1,"retrain":2,"canary":2,"threshold":1}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/modelDriftWatcher.ts
services/livia/lib/drift/covariate.ts            # PSI/KS/JSD/DomainAUC/MMD
services/livia/lib/drift/concept.ts              # prequential + performans + kalibrasyon
services/livia/lib/drift/shap.ts                 # SHAP drift Ã¶lÃ§er
services/livia/lib/drift/segments.ts             # dilim bazlÄ± analiz
services/livia/lib/drift/decider.ts              # seviye & aksiyon planÄ±
services/livia/lib/drift/report.ts               # md/html + grafikleri (inline SVG)
services/livia/lib/bridges.ts                    # L22/L32/L34/L35/L37/L38/L39/L44/L45/L46
services/livia/state/driftStore.ts               # idem index + baselines + pencere cache
services/livia/__tests__/modelDriftWatcher.test.ts
cfg/livia.drift.yaml

11) Test Ä°skeleti (Jest/Vitest)

PSI yÃ¼ksek: slip_p95 PSI=0.32 â†’ covariate high, kart warn

Concept dÃ¼ÅŸÃ¼ÅŸÃ¼: Î”AUC=-0.07, ECE=0.06 â†’ concept medium/high + model.guard.triggered

Segment uÃ§urumu: region=eu-central Î”AUC=-0.11 iÅŸaretlendi

Label gecikmesi: yetersiz Ã¶rnek â†’ underpowered ve concept kararÄ± hold

DQ blok: L41 drift Ã¶ncesi â€œfreshness breachâ€ â†’ karar bekletildi

Aksiyonlar: retrain kick, canary v6 %10, threshold -0.02 uygulandÄ±

Idempotency: aynÄ± driftKey tekrarÄ± yan etki Ã¼retmedi

Report yazÄ±mÄ±: md/html, kalibrasyon grafiÄŸi, PSI histogramlarÄ± Ã¼retildi

Observer gÃ¶rÃ¼nÃ¼mÃ¼: SHAP deÄŸerleri gizli; yalnÄ±z sÄ±ralama

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

11:00â€“12:00 feature.snapshot(1h) + model.prediction.logged â†’ PSI yÃ¼ksek (symbol 0.28, slip_p95 0.32)

13:30 ilk etiketler geldi â†’ Î”AUC=-0.07, ECE=0.06 â†’ model.guard.triggered

Aksiyon: L45 v6 canary %10, L44 retrain kick, L37 trafik %25 azalt â†’ kart/rapor â†’ L38/L39 zincirleri iÅŸlendi.

13) SLO

p95 EVAL < 15 ms / pencere

drift kaÃ§Ä±rma â‰¤ %1, yanlÄ±ÅŸ alarm â‰¤ %1

guardâ†’aksiyon MTTA â‰¤ 60 s

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-44 Â· autoRetrainOrchestrator.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Model yeniden-eÄŸitimini (auto retrain) tetikâ€planlaâ€yÃ¼rÃ¼t: drift/schedule/manuel tetiklerle veri malzemeleme â†’ HPO (HyperParam Opt.) â†’ eÄŸitim â†’ deÄŸerlendirme â†’ paketleme â†’ kanarya (L45) â†’ terfi/geri alma sÃ¼recini uÃ§tan uca orkestre et. DQ (L41), Åema Mitigasyonu (L42), Drift (L43), Maliyet (L34), SLO (L32), Bayrak/Bandit (L35/L37), SoykÃ¼tÃ¼k (L39) ve Provenance (L38) ile entegre.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Runtime: Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: mlops|data|policy yÃ¶netir, observer kÄ±sÄ±tlÄ± okur

Gizlilik: PII yok; serbest metin Ã¶zetleri L21 ile redakte

Ä°dempotency: retrainKey = modelId + targetTag + dataHash + hpoPlanHash

Observability: spans (rt.plan,rt.materialize,rt.train,rt.eval,rt.package,rt.publish,rt.canary) + metrics

Uyum: kritik kararlar L26 etik/WORM; tÃ¼m artefakt akÄ±ÅŸÄ± L38 append

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "retrain.triggered": {
    "event":"retrain.triggered","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","reason":"drift|schedule|manual",
    "source":{"ref":"model.drift.guard|cron|user#hashed"},
    "priority":"low|normal|high|urgent",
    "hints":{"targetTag":"v6-candidate","minDataDays":14,"segments":["region=eu-central"]}
  },

  "retrain.plan.request": {
    "event":"retrain.plan.request","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","targetTag":"v6-candidate",
    "objective":{"metric":"auprc|auc|rmse","direction":"max|min"},
    "constraints":{"maxTrainMin":60,"maxBudgetUSD":80,"maxConcurrent":2},
    "hpo":{"algo":"tpe|bayes|grid|hyperband","maxTrials":40,"earlyStop":{"kind":"median","minSteps":5}}
  },

  "dataset.snapshot.ready": {
    "event":"dataset.snapshot.ready","timestamp":"iso8601",
    "namespace":"kb_default","window":{"from":"iso8601","to":"iso8601"},
    "features":["feat:slip.p95","feat:lat.p95"],"labels":{"name":"y_true","positiveRate":0.21},
    "exclusions":{"DRILL":true,"incidentIds":["inc-2025-09-13-1"]},
    "stats":{"rows":240000,"missingPct":{"y_true":0.08}}
  },

  "fsync.lag": {
    "event":"fsync.lag","timestamp":"iso8601",
    "featureStore":"online|offline","lagMsP95":130
  },

  "dq.finding": {
    "event":"dq.finding","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","kind":"freshness|completeness|schema_drift","severity":"warn|error"
  },

  "schema.migration.classified": {
    "event":"schema.migration.classified","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","classification":"additive|breaking|mixed"
  },

  "training.job.progress": {
    "event":"training.job.progress","timestamp":"iso8601",
    "jobId":"train#7f9a12","trial":7,"step":42,
    "metrics":{"val_auprc":0.802,"val_auc":0.86,"loss":0.41}
  },

  "training.job.completed": {
    "event":"training.job.completed","timestamp":"iso8601",
    "jobId":"train#7f9a12","bestTrial":9,
    "artifact":{"path":"artifacts/train/slip_anom/v6-cand/best.ckpt","hash":"sha256:..."},
    "metrics":{"val_auprc":0.814,"val_auc":0.873,"train_min":48}
  },

  "eval.job.completed": {
    "event":"eval.job.completed","timestamp":"iso8601",
    "candidateTag":"v6-candidate",
    "holdout":{"auprc":0.812,"auc":0.871,"ece":0.028,"latency_ms_p95":19},
    "offlineCanary":{"delta_auc_vs_v5":+0.031,"delta_ece_vs_v5":-0.006}
  },

  "package.request": {
    "event":"package.request","timestamp":"iso8601",
    "candidateTag":"v6-candidate","formats":["onnx","torchscript","docker"],
    "opt":{"quantize":"int8|none","sig":"ed25519","repeatableSeed":42}
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "retrain.plan.ready": {
    "event":"retrain.plan.ready","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","targetTag":"v6-candidate",
    "data":{"window":{"from":"iso8601","to":"iso8601"},"segments":["global","region=eu-central"],"rows":240000,
            "exclusions":{"DRILL":true,"incidents":1}},
    "splits":{"method":"time_series","train":"70%","val":"15%","holdout":"15%"},
    "hpo":{"algo":"tpe","maxTrials":40,"searchSpace":{"lr":"[1e-5,1e-2]","depth":"[2,6]","dropout":"[0.0,0.5]"}},
    "constraints":{"maxTrainMin":60,"maxBudgetUSD":80},
    "gates":{"dq":"L41","schema":"L42","cost":"L34","slo":"L32","ethics":"L26"},
    "hash":"sha256:..."
  },

  "retrain.materialize.ready": {
    "event":"retrain.materialize.ready","timestamp":"iso8601",
    "manifest":{"features":["feat:slip.p95","feat:lat.p95"],"label":"y_true","rows":240000,
                "dataHash":"sha256:...","lineageRef":"state/lineage/.../manifest.json"},
    "path":"artifacts/data/slip_anom/v6-cand/manifest.json"
  },

  "training.job.enqueued": {
    "event":"training.job.enqueued","timestamp":"iso8601",
    "jobId":"train#7f9a12","targetTag":"v6-candidate","trials":40,"resources":{"gpu":1,"cpu":4}
  },

  "hpo.progress": {
    "event":"hpo.progress","timestamp":"iso8601",
    "jobId":"train#7f9a12","completed":18,"total":40,
    "best":{"trial":12,"val_auprc":0.813,"params":{"lr":0.0007,"depth":4,"dropout":0.2}}
  },

  "model.candidate.ready": {
    "event":"model.candidate.ready","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","candidateTag":"v6-candidate",
    "artifact":{"onnx":"artifacts/models/slip_anom/v6.onnx","hash":"sha256:..."},
    "metrics":{"holdout_auprc":0.812,"holdout_auc":0.871,"ece":0.028,"p95_ms":19},
    "meetsPromotion":"true|false","rationale":[">champion by +0.031 AUC","ECE improved","latency OK"]
  },

  "model.publish.proposed": {
    "event":"model.publish.proposed","timestamp":"iso8601",
    "candidateTag":"v6-candidate","champion":"v5",
    "gates":{"dq":"pass","schema":"pass","cost":"pass","ethics":"pass"},
    "proposal":{"canarySteps":[10,25,50],"minStableMin":20,"flagId":"kb.hybridSearch.v2"},
    "requiresApproval":["policy-lead"],"hash":"sha256:..."
  },

  "canary.deploy.request": {
    "event":"canary.deploy.request","timestamp":"iso8601",
    "candidateTag":"v6-candidate","steps":[10,25,50],"via":"LIVIA-45","minStableMin":20
  },

  "retrain.report.ready": {
    "event":"retrain.report.ready","timestamp":"iso8601",
    "modelId":"model:slip_anomaly","candidateTag":"v6-candidate","format":"md|html",
    "path":"data/retrain/2025-09-15/slip_anom_v6/report.md",
    "summary":"AUCPR +0.018, AUC +0.031, ECE -0.006 â€¢ Latency p95 19ms â€¢ Canary Ã¶nerildi (%10â†’%25â†’%50).",
    "hash":"sha256:..."
  },

  "retrain.card": {
    "event":"retrain.card","timestamp":"iso8601",
    "title":"Retrain HazÄ±r â€” slip_anomaly v6 aday",
    "body":"Holdout AUC +0.031 â€¢ ECE 0.028 â€¢ p95 19ms â€¢ Canary %10 Ã¶nerildi.",
    "severity":"info","ttlSec":900
  },

  "retrain.alert": {
    "event":"retrain.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"dq_block|schema_block|cost_exceeded|capacity_unavailable|underpowered|hpo_early_stop|train_fail|eval_fail|pack_fail|publish_denied|idem_duplicate|rbac_denied"
  },

  "retrain.metrics": {
    "event":"retrain.metrics","timestamp":"iso8601",
    "plans":3,"jobs":2,"completed":1,"hpoTrials":40,
    "p95PlanMs":22,"p95MaterializeMin":6,"p95TrainMin":48,
    "budgetUSD":54.2,"costGuardTrips":0
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  triggers:{
    fromDrift:{ minLevel:"medium", cooldownHours:12 },   // L43
    schedule:{ cron:"Mon,Thu 03:00" },
    manual:{ requireRole:"mlops|policy" }
  },

  data:{
    windowDays: 14,
    exclude:{ DRILL:true, incident:true },
    minRows: 100_000,
    labelLatencyMaxMin: 1440,
    splits:{ method:"time_series", train:0.7, val:0.15, holdout:0.15 },
    balance:{ enabled:true, method:"class_weight|downsample", targetPosRate:0.25 }
  },

  hpo:{
    algo:"tpe", maxTrials:40, parallel:2,
    earlyStop:{ kind:"median", minSteps:5 },
    searchSpace:{
      lr:"[1e-5,1e-2]", depth:"[2,6]", dropout:"[0.0,0.5]", l2:"[0.0,0.01]"
    }
  },

  training:{
    framework:"pytorch|xgboost",
    resources:{ gpu:1, cpu:4, memGB:16 },
    maxTrainMin: 60,
    seed: 42,
    checkpoint:{ everyMin:5, keepLast:3 }
  },

  evaluation:{
    primary:"auprc|auc|rmse",
    secondary:["ece","latency_ms_p95","cost_usd"],
    segments:["region","desk","symbol"],
    requireDelta:{ metric:"+0.01_auc|+0.008_auprc", ece:"-0.005" }
  },

  packaging:{
    formats:["onnx","torchscript","docker"],
    quantize:"none|int8",
    sign:{ algo:"ed25519", keyRef:"kms:key/model-sign" },
    reproducibility:{ lockDeps:true, recordEnv:true, dockerDigest:true }
  },

  gates:{
    dq:"LIVIA-41", schema:"LIVIA-42", cost:"LIVIA-34", slo:"LIVIA-32", ethics:"LIVIA-26"
  },

  promotion:{
    requireApproval:["policy-lead"],
    canary:{ via:"LIVIA-45", steps:[10,25,50], minStableMin:20 },
    allocator:{ via:"LIVIA-37", minPctPerVariant:5 }
  },

  storage:{
    dataDir:"artifacts/data/{modelId}/{targetTag}",
    modelDir:"artifacts/models/{modelId}/{targetTag}",
    reportDir:"data/retrain/{YYYY-MM-DD}/{modelId}_{targetTag}"
  },

  costBudgetUSD: 100,
  idempotencyTtlSec: 86400
}

5) Metodoloji (Ã¶zet)

Veri malzemeleme: L39 lineage Ã¼zerinden manifest Ã¼ret; L41 DQ kontrolleri geÃ§ilmezse blokla.

Split: zaman serisi veya K-fold (opsiyonel); label latency kÄ±sÄ±tlarÄ±.

HPO: TPE/Bayesian/Hyperband; erken durdurma (median/pruning).

EÄŸitim: deterministik tohum; checkpoint & erken durdurma; SLO/L32 ile eÄŸitim sÃ¼resi gÃ¶zetimi.

DeÄŸerlendirme: primary/secondary metrikler; segment bazlÄ± tablolar; kalibrasyon (ECE/Platt/Temp. Scaling).

SeÃ§im: championâ€™a gÃ¶re istatistiksel anlamlÄ± fark (bootstrap/DeLong); cost/latency guardrails.

Paketleme: ONNX/TorchScript + opsiyonel quantize; imza (ed25519); reproducibility log (deps/env/docker).

YayÄ±n: L45 kanarya planÄ±; L37/L35 trafik paylaÅŸtÄ±rma; baÅŸarÄ±sÄ±zlÄ±kta rollback.

6) Pipeline (Kompozisyon)

Plan: retrain.triggered|plan.request â†’ hedef tag, pencere, HPO alanÄ±, bÃ¼tÃ§e/kapasite kontrol

Materialize: veri manifest + hash; DQ/L41 ve Åema/L42 kapÄ±larÄ± â†’ pass ise eÄŸitim kuyruÄŸu

Train/HPO: kaynak ayÄ±r, denemeleri yÃ¼rÃ¼t; progress & early-stop olaylarÄ± yay

Eval: holdout + segment; driftte iÅŸaretli segmentlere ek aÄŸÄ±rlÄ±k raporu

Select & Gate: champion karÅŸÄ±laÅŸtÄ±r; L34/L32/L26 kapÄ±larÄ±; publish.proposed

Package: seÃ§ili aday artefaktlarÄ±nÄ± Ã¼ret & imzala; L38 provenance append

Canary: L45 ile daÄŸÄ±tÄ±m isteÄŸi; L37 ile pay yÃ¶netimi

Report & Emit: rapor md/html; kart/alert/metrics; L22 ile daÄŸÄ±t

Index: L39 lineage dÃ¼ÄŸÃ¼m/kenarlarÄ±nÄ± gÃ¼ncelle (modelâ†’artifactâ†’decision)

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (retrain.triggered|plan.request) â†’ PLAN

PLAN â†’ (DQ/Schema ok?) MATERIALIZE | (blok) PAUSE

MATERIALIZE â†’ TRAIN (HPO)

TRAIN â†’ EVAL (best trial)

EVAL â†’ (gates pass) PACKAGE | (fail) HOLD/ABORT

PACKAGE â†’ PUBLISH.PROPOSE â†’ (onay) CANARY | (ret) ABORT

CANARY â†’ (stabil) PROMOTE | (breach) ROLLBACK

Hata: ALERT + mevcut durum; idem: aynÄ± retrainKey ile ikinci yan etki yok

8) Kenar Durumlar

DQ/Schema blok: L41/L42 error â†’ plan PAUSE; otomatik yeniden dene +30 min

Underpowered: minRows altÄ± veya pozitif oran Ã§ok dÃ¼ÅŸÃ¼k â†’ underpowered uyarÄ±; yalnÄ±z plan/log

Kapasite yok: GPU/CPU yetersiz â†’ capacity_unavailable; L31 ile yeniden deneme planÄ±

Maliyet aÅŸÄ±ldÄ±: L34 hard â†’ cost_exceeded ve ABORT

FS lag: L46 lag yÃ¼ksek â†’ materialize ertelenir

Label gecikmesi: labelLatencyMaxMin aÅŸÄ±ldÄ± â†’ sadece semi-supervised/weak mod (opsiyonel)

Regime deÄŸiÅŸimi: L54 sinyaliyle param aralÄ±ÄŸÄ± geniÅŸlet & HPO maxTrialsâ†‘ (bÃ¼tÃ§e izin verirse)

Observer gÃ¶rÃ¼nÃ¼mÃ¼: yalnÄ±z Ã¶zet metrik ve kart; hiperparam/artefakt yollarÄ± gizlenebilir

Idempotency: aynÄ± plan tekrar tetiklenmez; yalnÄ±z status/card gÃ¼ncellenir

9) Telemetri
{
  "retrain.metrics": {
    "event":"retrain.metrics","timestamp":"iso8601",
    "plans":3,"jobs":2,"completed":1,
    "hpoTrials":40,"p50PlanMs":9,"p95PlanMs":22,
    "p95MaterializeMin":6,"p95TrainMin":48,"p95EvalMin":4,
    "budgetUSD":54.2,"costGuardTrips":0,"gateFails":{"dq":0,"schema":0,"cost":0,"ethics":0}
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/autoRetrainOrchestrator.ts
services/livia/lib/retrain/plan.ts             # tetikâ†’plan, hedef tag, HPO alanÄ±, bÃ¼tÃ§e
services/livia/lib/retrain/materialize.ts      # data manifest + hash + lineage link (L39)
services/livia/lib/retrain/hpo.ts              # TPE/Hyperband/Grid; early-stop
services/livia/lib/retrain/train.ts            # eÄŸitim yÃ¼rÃ¼tÃ¼cÃ¼ (PyTorch/XGBoost kÃ¶prÃ¼sÃ¼)
services/livia/lib/retrain/eval.ts             # holdout & segment metrikleri
services/livia/lib/retrain/package.ts          # onnx/ts/docker + imza
services/livia/lib/retrain/publish.ts          # gates (L41/L42/L34/L32/L26) + proposal
services/livia/lib/bridges.ts                  # L22/L26/L31/L32/L34/L35/L37/L38/L39/L41/L42/L43/L45/L46
services/livia/state/retrainStore.ts           # idem index + manifest + job durumlarÄ±
services/livia/__tests__/autoRetrainOrchestrator.test.ts
cfg/livia.retrain.yaml

11) Test Ä°skeleti (Jest/Vitest)

Plan Ã¼retimi: drift medium â†’ plan hazÄ±r; pencere 14g, HPO 40 deneme

DQ blok: dq.finding: error â†’ PAUSE ve yeniden deneme planlandÄ±

HPO erken durdurma: median rule; en iyi deneme ~ denemelerin %30â€™unda bulunur

Eval & seÃ§im: championâ€™a gÃ¶re AUC +0.03 â†’ publish.proposed

Paketleme: onnx + imza; reproducibility kayÄ±tlarÄ± yazÄ±ldÄ±

Canary: %10â†’%25â†’%50; ihlalde rollback

Maliyet sÄ±nÄ±rÄ±: 100 USD Ã¼stÃ¼ â†’ cost_exceeded + abort

Idempotency: aynÄ± retrainKey ikinci yÃ¼rÃ¼tme yok; yalnÄ±z kart gÃ¼ncellenir

Rapora yazÄ±m: md/html + grafikler; L22 daÄŸÄ±tÄ±ldÄ±; L38/L39 linkleri

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

10:05 L43 drift: medium â†’ retrain.triggered (priority=high)

10:10 PLAN: 14g veri, TPE 40 trial, bÃ¼tÃ§e $80 â†’ MATERIALIZE (manifest + hash)

10:20 TRAIN: 1 GPU, 48dk; HPO progress yayÄ±nlarÄ±

11:15 EVAL: AUC +0.031, ECE âˆ’0.006, p95 19ms â†’ PACKAGE (onnx)

11:25 PUBLISH.PROPOSED â†’ CANARY %10 (L45) â†’ kart/rapor; lineage & provenance iÅŸlendi.

13) SLO

p95 plan < 30 ms

materialize â‰¤ 10 dk (240K satÄ±r, disk lokal)

train p95 â‰¤ 60 dk (1Ã—GPU)

gateâ†’canary MTTA â‰¤ 2 dk
______________________________________________________________________________________________
LIVIA-46 Â· featureStoreSync.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Online ve offline feature storeâ€™larÄ±n tutarlÄ±lÄ±ÄŸÄ±nÄ± ve gecikmesini (lag) sÃ¼rekli izlemek; point-in-time correctness (sÄ±zÄ±ntÄ± yok), trainingâ†”serving skew (daÄŸÄ±lÄ±m/fill/Ã¶lÃ§ek farklarÄ±), TTL/expiry, join key uyumu, embedding norm/tip doÄŸrulamasÄ± ve cardinality/missingness kontrolÃ¼ yapmak. Ä°hlallerde karantina/backfill/repair planÄ± Ã§Ä±karmak; L41 DQ, L42 Åema, L39 Lineage, L38 Provenance, L43 Drift, L44 Retrain, L45 Canary ve L32/L34 guardrail modÃ¼lleriyle entegre Ã§alÄ±ÅŸmak.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel pencere 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: data|mlops|ops yÃ¶netir; observer salt okur

Gizlilik: PII yok; serbest metinler L21 ile redakte

Ä°dempotency: fsyncKey = namespace + featureId + asOfISO + checkKind + scope

Observability: spans (fsync.collect,fsync.compare,fsync.decide,fsync.repair,fsync.report) + metrics

Uyum: kritik kararlar L26 etik/WORM; deÄŸiÅŸimler L38 WORM append

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "feature.registered": {
    "event":"feature.registered","timestamp":"iso8601",
    "id":"feat:slip.p95","owner":"ops","version":"v3",
    "source":{"datasetId":"ds:kinesis:feed_ticks","transforms":["groupBy(symbol,5m)","p95(slip)"]},
    "ttlSec":1800,"dtype":"float","shape":"scalar|vector:128","fill":{"kind":"ffill|zero|mean|none"}
  },

  "feature.materialized": {
    "event":"feature.materialized","timestamp":"iso8601",
    "id":"feat:slip.p95","namespace":"kb_default",
    "store":"online|offline","asOf":"iso8601",
    "count":124500,"missingPct":0.04,"hist":[[0.0,0.5,0.1],[0.5,1.0,0.3],[1.0,2.0,0.6]],
    "cardinality":{"joinKey":"symbol","distinct":142}
  },

  "fsync.snapshot": {
    "event":"fsync.snapshot","timestamp":"iso8601",
    "namespace":"kb_default","asOf":"iso8601",
    "online":{"id":"feat:slip.p95","count":123980,"missingPct":0.05,"p95LagMs":140},
    "offline":{"id":"feat:slip.p95","count":124500,"missingPct":0.04},
    "joinKey":{"name":"symbol","diffMissingPct":0.8}
  },

  "fsync.lag": {
    "event":"fsync.lag","timestamp":"iso8601",
    "namespace":"kb_default","store":"online","p95LagMs":160,"maxLagMs":520
  },

  "fsync.ttl.expired": {
    "event":"fsync.ttl.expired","timestamp":"iso8601",
    "featureId":"feat:profile.embedding","namespace":"kb_default","expiredKeys":320
  },

  "feature.request.online": {
    "event":"feature.request.online","timestamp":"iso8601",
    "namespace":"kb_default","featureIds":["feat:slip.p95","feat:profile.embedding"],
    "subject":{"joinKey":"symbol","value":"AVAXUSDT"},"at":"iso8601"
  },

  "feature.validation.request": {
    "event":"feature.validation.request","timestamp":"iso8601",
    "namespace":"kb_default","featureIds":["feat:slip.p95","feat:lat.p95"],
    "asOf":"iso8601","mode":"point_in_time|skew|lag|full","dryRun":false
  },

  "embedding.norm.check": {
    "event":"embedding.norm.check","timestamp":"iso8601",
    "featureId":"feat:profile.embedding","namespace":"kb_default",
    "shape":"vector:128","dtype":"float32","l2Mean":1.02,"l2P95":1.31,"nanPct":0.0
  },

  "dataset.schema.updated": {
    "event":"dataset.schema.updated","timestamp":"iso8601",
    "id":"ds:kinesis:feed_ticks","prevVersion":"v7","newVersion":"v8","diff":[...]
  },

  "dq.finding": {
    "event":"dq.finding","timestamp":"iso8601",
    "datasetId":"ds:kinesis:feed_ticks","kind":"freshness|completeness|schema_drift","severity":"warn|error"
  },

  "fsync.backfill.request": {
    "event":"fsync.backfill.request","timestamp":"iso8601",
    "namespace":"kb_default","featureId":"feat:slip.p95",
    "from":"2025-09-14T00:00:00+03:00","to":"2025-09-15T00:00:00+03:00",
    "reason":"ttl_expired|lag_spike|schema_migration","priority":"high"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "fsync.check.ready": {
    "event":"fsync.check.ready","timestamp":"iso8601",
    "namespace":"kb_default","asOf":"iso8601","featureId":"feat:slip.p95",
    "kinds":{"lag":"ok|at_risk|breach","skew":"ok|warn|fail","ttl":"ok|warn|fail","joinKey":"ok|warn|fail","embedding":"ok|warn|fail"},
    "findings":{"lagP95Ms":160,"countDiffPct":0.42,"missingnessDeltaPct":0.01,"ksP":"0.008","psi":"0.22","ttlExpired":320},
    "actions":["replay|backfill|repair|quarantine?false"],
    "hash":"sha256:..."
  },

  "fsync.repair.enqueued": {
    "event":"fsync.repair.enqueued","timestamp":"iso8601",
    "namespace":"kb_default","featureId":"feat:slip.p95",
    "via":"LIVIA-31|LIVIA-42","jobId":"repair#7f9a12","kind":"backfill|recompute|key_sync|ttl_rehydrate"
  },

  "fsync.report.ready": {
    "event":"fsync.report.ready","timestamp":"iso8601",
    "namespace":"kb_default","forDate":"2025-09-15",
    "path":"data/fsync/2025-09-15/kb_default/report.md",
    "summary":"Online p95 lag 160ms (OK) â€¢ slip.p95 PSI 0.22 (warn) â€¢ 320 TTL expired key rehydrated â€¢ joinKey miss %0.8.",
    "hash":"sha256:..."
  },

  "fsync.card": {
    "event":"fsync.card","timestamp":"iso8601",
    "title":"Feature Sync â€” kb_default @ 15:40",
    "body":"Lag OK â€¢ PSI 0.22 (slip.p95, warn) â€¢ TTL expired 320 anahtar rehydrate.",
    "severity":"info","ttlSec":600
  },

  "fsync.alert": {
    "event":"fsync.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"lag_breach|ttl_expired|join_key_mismatch|skew_detected|dtype_mismatch|schema_drift|dq_block|repair_failed|idem_duplicate|rbac_denied"
  },

  "fsync.metrics": {
    "event":"fsync.metrics","timestamp":"iso8601",
    "checks":128,"repairs":3,"rehydratedKeys":320,
    "p95CheckMs":7.6,"avgLagP95Ms":140,"psiWarn":5,"ksFail":1
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  stores:{
    online:{ kind:"redis|dynamo|featurehub", tz:"UTC", clockSkewMsMax:200 },
    offline:{ kind:"parquet|iceberg|delta", tz:"UTC" }
  },

  thresholds:{
    lag:{ p95Ms:{ ok:200, at_risk:300, breach:500 }, maxMs:5000 },
    skew:{ psiWarn:0.2, psiFail:0.35, ksPMax:0.01, meanRelDiffPctMax:3.0, missingnessDeltaPctMax:1.0 },
    ttl:{ warnPct:0.5, failPct:2.0 },                 // expired key / toplam
    joinKey:{ mismatchPctWarn:0.5, mismatchPctFail:1.5 },
    embedding:{ l2Mean:[0.95,1.05], l2P95Max:1.25, nanPctMax:0.1 },
    dtype:{ strict:true },                              // online/offline dtype/shape eÅŸleÅŸmeli
    floatTolerance:{ abs:1e-6, relPct:0.5 }            // karÅŸÄ±laÅŸtÄ±rma toleransÄ±
  },

  pointInTime:{
    enable:true,
    lookbackSec: 120,                    // okuma penceresi
    antiLeak:{ forbidFutureGtNow:true }  // geleceÄŸe bakÄ±ÅŸÄ± blokla
  },

  sampling:{
    comparePct: 0.05,                    // bÃ¼yÃ¼k featureâ€™larda %5 Ã¶rnekle
    maxCompareRows: 100_000
  },

  repair:{
    enabled:true,
    via:["LIVIA-31","LIVIA-42"],
    strategies:["replay","recompute","ttl_rehydrate","key_sync"],
    maxJobsPerRun:20, backoffMs:500
  },

  reporting:{
    outputDir:"data/fsync/{YYYY-MM-DD}/{namespace}",
    mdFile:"report.md", htmlFile:"report.html",
    html:{ embedMiniCSS:true, chartsInlineSvg:true },
    include:{ topSkewFeatures:10, ttlKeysSample:10 }
  },

  integrations:{
    dq:"LIVIA-41", schemaMig:"LIVIA-42", drift:"LIVIA-43", retrain:"LIVIA-44",
    canary:"LIVIA-45", slo:"LIVIA-32", cost:"LIVIA-34", flags:"LIVIA-35",
    bandit:"LIVIA-37", lineage:"LIVIA-39", provenance:"LIVIA-38", dist:"LIVIA-22", redact:"LIVIA-21"
  },

  rbacViews:{ observer:{ hideKeySamples:true, showOnlySummary:true } },

  idempotencyTtlSec: 3600
}

5) DoÄŸrulama BoyutlarÄ± (Ã¶zet)

Lag: online p95 gecikme (event ts â†’ store ts); L32 ile iliÅŸkili SLOâ€™ya baÄŸla.

Skew (trainingâ†”serving): online vs offline aynÄ± as-of daÄŸÄ±lÄ±m/istatistik farklarÄ± (PSI/KS/mean diff/missingness delta).

TTL/Expiry: online Ã¶ÄŸelerin sÃ¼resi dolmuÅŸ anahtar sayÄ±sÄ± / yÃ¼zdesi; rehydrate gereksinimi.

Join key uyumu: online/offline join key kesiÅŸimi; mismatch/dangling oranÄ±.

Dtype/Shape: float32 vs float64, vector:128 vs vector:768; tolerans dÄ±ÅŸÄ± â†’ fail.

Embedding norm: L2 ortalama/p95 bandÄ±, NaN/Inf kontrolÃ¼; normalize edilmemiÅŸse uyar.

Fill politikasÄ±: ffill/zero/mean/none uyumsuzluÄŸu â†’ serving farkÄ± doÄŸurur; rapor/Ã¶neri Ã¼ret.

Cardinality/Missingness: joinKey distinct, null%; beklenenden sapma â†’ uyar.

Point-in-Time correctness: offline snapshot as-of ile online lookup zamanÄ± uyumlu; geleceÄŸe bakÄ±ÅŸ yok.

6) Pipeline (Kompozisyon)

Collect: feature.materialized, fsync.snapshot, fsync.lag, fsync.ttl.expired, embedding.norm.check

Align: aynÄ± namespace + asOf iÃ§in online/offline Ã¶rnekleri hizala; point-in-time penceresine gÃ¶re filtrele

Compare: lag/TTL/joinKey/dtype/shape/embedding kontrolleri + skew (PSI/KS/mean/missingness delta)

Decide: eÅŸiklere gÃ¶re kinds (ok/warn/breach/fail); aksiyon planÄ± (repair/backfill/recompute/key_sync)

Guardrails: dq.finding: error â†’ block repair; schema.updated â†’ L42 adaptÃ¶r, sonra yeniden dene

Enforce: L31/L42 Ã¼zerinden fsync.repair.enqueued; TTL rehydrate; join key senkronu

Emit/Report: fsync.check.ready, fsync.report.ready, kart/alert/metrics; L22 ile daÄŸÄ±t

Link: tÃ¼m adÄ±mlar L38 (provenance append) + L39 (lineage edges)

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (fsync.snapshot|feature.materialized|validation.request) â†’ COMPARE

COMPARE â†’ (violations?) DECIDE â†’ (repair?) REPAIR â†’ REPORT â†’ EMIT â†’ IDLE

Hata: ALERT + IDLE; idem: aynÄ± fsyncKey ikinci kez yan etki doÄŸurmaz

8) Kenar Durumlar

Saat/Clock skew: online store clock drift â‰¤ clockSkewMsMax; aksi halde lag Ã¶lÃ§Ã¼mÃ¼ dÃ¼zeltilir.

BÃ¼yÃ¼k veri: sampling.comparePct ile Ã¶rnekle; maxCompareRows sÄ±nÄ±rÄ±.

Ephemeral feature: TTL Ã§ok kÄ±sa olanlar iÃ§in pointInTime.lookbackSec geniÅŸletilir.

Åema migrasyonu: dtype/shape deÄŸiÅŸimi â†’ L42 adaptÃ¶r + recompute; eski veri backfill

DQ engeli: dq: error â†’ onarÄ±m durdur; rapora â€œblocked by DQâ€ yaz

Float toleransÄ±: kÃ¼Ã§Ã¼k farklar floatTolerance iÃ§inde ise OK sayÄ±lÄ±r

Embedding dtype uyuÅŸmazlÄ±ÄŸÄ±: float64 online â†’ cost artÄ±ÅŸÄ± (L34) uyar; recompute int8/quantize Ã¶ner

Join key map: alias/farklÄ± adlandÄ±rma â†’ key_sync stratejisi; dangling oranÄ± raporlanÄ±r

Observer gÃ¶rÃ¼nÃ¼mÃ¼: Ã¶rnek anahtarlar gizli; yalnÄ±z Ã¶zet

Idempotency: aynÄ± fsyncKey ile repair ikinci kez kuyruÄŸa alÄ±nmaz

9) Telemetri
{
  "fsync.metrics": {
    "event":"fsync.metrics","timestamp":"iso8601",
    "checks":128,"repairs":3,"rehydratedKeys":320,
    "p50CheckMs":3.2,"p95CheckMs":7.6,"avgLagP95Ms":140,
    "psiWarn":5,"ksFail":1,"dtypeMismatches":0,"ttlWarns":2
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/featureStoreSync.ts                 # FSM + orchestrator
services/livia/lib/fsync/align.ts                  # as-of hizalama & PIT doÄŸrulama
services/livia/lib/fsync/compare.ts                # lag/skew/ttl/joinKey/dtype/embedding
services/livia/lib/fsync/decide.ts                 # aksiyon planÄ±
services/livia/lib/fsync/repair.ts                 # L31/L42 kÃ¶prÃ¼leri (replay/recompute/rehydrate/key_sync)
services/livia/lib/fsync/report.ts                 # md/html + grafikler (inline SVG)
services/livia/lib/bridges.ts                      # L21/L22/L31/L32/L34/L38/L39/L41/L42/L43/L44/L45
services/livia/state/fsyncStore.ts                 # idem index + history
services/livia/__tests__/featureStoreSync.test.ts
cfg/livia.fsync.yaml

11) Test Ä°skeleti (Jest/Vitest)

Lag breach: p95>300ms â†’ kinds.lag='breach' + kart warn

Skew warn: PSI=0.22 â†’ kinds.skew='warn'; KS p-valueâ‰¤0.01 â†’ fail

TTL expired: 320 anahtar â†’ rehydrate enqueued

Join key mismatch: %1.8 â†’ key_sync planlandÄ±

Dtype/shape: vector:128 (offline) vs 768 (online) â†’ fail + recompute

DQ block: dq.finding:error â†’ repair blok, raporda â€œblocked by DQâ€

Idempotency: aynÄ± fsyncKey ikinci repair kuyruÄŸa alÄ±nmaz

Report: md/html yazÄ±ldÄ±; L22 daÄŸÄ±tÄ±ldÄ±; L38/L39 linkleri iÅŸlendi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

15:20 fsync.snapshot(asOf=15:15) â†’ COMPARE: lag OK (p95 160ms), PSI 0.22 (warn), TTL expired 320 â†’ DECIDE: rehydrate + monitor

15:22 fsync.repair.enqueued(ttl_rehydrate) â†’ 15:28 tamamlandÄ±; REPORT yazÄ±ldÄ± â†’ L22 kart â†’ L38/L39 zincirleri iÅŸlendi.

13) SLO

p95 check < 10 ms / feature

yanlÄ±ÅŸ fail â‰¤ %1, kaÃ§Ä±rÄ±lan kritik ihlal â‰¤ %1

repair MTTA â‰¤ 2 dk (kuyruÄŸa alma)

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
_____________________________________________________________________________________________
LIVIA-47 Â· kbIndexAutotuner.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Bilgi tabanÄ± (KB) arama yÄ±ÄŸÄ±nÄ±nÄ±n kaliteâ€“gecikmeâ€“maliyet dengesini otomatik ayarlamak: vektÃ¶r indeks (HNSW/IVF-PQ), embedding boyutu/kuantizasyon, topK, hybrid aÄŸÄ±rlÄ±k (BM25â†”dense), reranker (yok|light CE|heavy CE|ColBERT-lite), cache politikasÄ± ve segmente gÃ¶re (namespace/locale/intent) farklÄ± profiller. Offline (hakem/judgement) ve online (tÄ±klama/CTR/NDCG@k) deÄŸerlendirme ile Pareto sÄ±nÄ±rÄ± Ã§Ä±kar; A/Bâ€“bandit (L36/L37) ile canlÄ±da dene; guardrail (SLO â€“ L32, Maliyet â€“ L34, Gizlilik â€“ L40) altÄ±nda promote/rollback yap.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; Provenance (L38) + Lineage (L39) baÄŸlÄ±.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: search|mlops|ops|policy yÃ¶netir; observer sÄ±nÄ±rlÄ± okur

Gizlilik: sorgu/log PIIâ€™si L21/L40 ile redakte; anonim user/session

Ä°dempotency: tuneKey = namespace + profile + windowISO + candidateHash

Observability: spans (kb.plan,kb.gen,kb.offline,kb.online,kb.decide,kb.promote) + metrics

Uyumluluk: kararlar L26 etik/WORM; deÄŸiÅŸimler L38 WORM append

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "kb.index.stats": {
    "event":"kb.index.stats","timestamp":"iso8601",
    "namespace":"kb_default","profile":"global|tr|en|faq|code",
    "engine":{"type":"hnsw|ivf|ivf_pq","dim":768,"quant":"fp32|fp16|int8"},
    "params":{"hnsw":{"M":32,"efSearch":256},"ivf":{"nlist":4096,"nprobe":8},"pq":{"m":16,"codeBits":8}},
    "docCount":482_000,"memGB":9.8,"buildMin":28
  },

  "search.query.logged": {
    "event":"search.query.logged","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr",
    "query":{"q":"avax slip nedir","lang":"tr","intent":"howto|debug|ref|other"},
    "results":{"topK":50,"hybridAlpha":0.35,"reranker":"ce-small|null"},
    "latencyMs":132,"costUsd":0.0007,
    "clicks":[{"rank":1,"dwellMs":8200},{"rank":4,"dwellMs":2400}],
    "session":{"id":"sess#7f9a12","device":"web","region":"eu"},
    "flags":{"variant":"A"}                      // A/B
  },

  "judgement.ingested": {
    "event":"judgement.ingested","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr",
    "qrels":[{"qid":"q#1","docId":"d#42","label":3},{"qid":"q#1","docId":"d#7","label":2}],
    "metricSet":["NDCG@10","MRR@10","Recall@50"]
  },

  "kb.tuning.plan.request": {
    "event":"kb.tuning.plan.request","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr",
    "objectives":{"primary":"NDCG@10","secondary":["Recall@50","MRR@10"]},
    "constraints":{"p95LatencyMsMax":250,"costPer1kQUsdMax":1.2,"memGBMax":12},
    "ranges":{
      "topK":[10,200],
      "hybridAlpha":[0.0,0.8],                     // 0=BM25, 1=dense
      "reranker":["none","ce-small","ce-large","colbert-lite"],
      "engine":["hnsw","ivf","ivf_pq"],
      "hnsw.efSearch":[64,800],
      "ivf.nprobe":[1,64],
      "pq.codeBits":[6,8], "dim":[256,384,512,768]
    },
    "eval":{"offline":true,"online":"ab|bandit","banditAlgo":"thompson|ucb1"}
  },

  "reranker.candidate.ready": {
    "event":"reranker.candidate.ready","timestamp":"iso8601",
    "name":"ce-small","p95LatencyMs":18,"costUsdPer1k":0.22
  },

  "search.ab.metrics": {
    "event":"search.ab.metrics","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr",
    "window":"1h",
    "A":{"ctr":0.31,"ndcg10":0.412,"lat_p95":128,"cost_1k":0.74},
    "B":{"ctr":0.345,"ndcg10":0.441,"lat_p95":154,"cost_1k":0.92},
    "uplift":{"ndcg10":"+7.0%","ctr":"+11.3%","lat_p95":"+20%","cost_1k":"+24%"},
    "sig":{"p_value":0.03,"method":"welch_t|bootstrap"}
  },

  "cost.guard.triggered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "component":"search_stack","severity":"high","deltaUSDPer1kReq":0.35
  },

  "slo.guard.triggered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"search_p95","severity":"high"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "kb.tuning.plan.ready": {
    "event":"kb.tuning.plan.ready","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr",
    "candidates":[
      {"id":"cand#hnsw-768-ef256-k50-a0.35-rerank:ce-small",
       "engine":"hnsw","dim":768,"quant":"fp16","topK":50,"hybridAlpha":0.35,
       "reranker":"ce-small","expected":{"p95Ms":160,"cost_1k":0.88,"memGB":10.5}},
      {"id":"cand#ivf-pq-384-nprobe16-k100-a0.2-rerank:none",
       "engine":"ivf_pq","dim":384,"pq":{"m":16,"codeBits":8},"nprobe":16,"topK":100,"hybridAlpha":0.2,
       "reranker":"none","expected":{"p95Ms":110,"cost_1k":0.42,"memGB":6.1}}
    ],
    "pareto":{"front":[["NDCG@10",0.44,"p95",150,"cost_1k",0.8],["NDCG@10",0.41,"p95",110,"cost_1k",0.42]]},
    "hash":"sha256:..."
  },

  "kb.offline.eval.ready": {
    "event":"kb.offline.eval.ready","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr","candidateId":"cand#ivf-pq-384-nprobe16-k100-a0.2-rerank:none",
    "metrics":{"NDCG@10":0.432,"MRR@10":0.388,"Recall@50":0.71},
    "meets":"true|false"
  },

  "kb.online.test.started": {
    "event":"kb.online.test.started","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr","mode":"ab|bandit",
    "variants":[["A","baseline"],["B","cand#ivf-pq-384-..."]],
    "routing":{"via":"LIVIA-35|gateway","weights":[50,50]},
    "healthBudget":{"p95MsMax":250,"cost_1k_Max":1.2,"sloBurnPctMax":5.0}
  },

  "kb.tuning.health.snapshot": {
    "event":"kb.tuning.health.snapshot","timestamp":"iso8601",
    "window":"15m",
    "A":{"ndcg10":0.412,"ctr":0.31,"p95":128,"cost_1k":0.74},
    "B":{"ndcg10":0.441,"ctr":0.345,"p95":154,"cost_1k":0.92},
    "status":"ok|at_risk|breach","reason":"slo|cost|quality_drop"
  },

  "kb.tuning.promoted": {
    "event":"kb.tuning.promoted","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr",
    "from":"baseline","to":"cand#ivf-pq-384-...","mode":"ab|bandit",
    "downtimeMs":0
  },

  "kb.tuning.rolled.back": {
    "event":"kb.tuning.rolled.back","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr","to":"baseline",
    "reason":"slo_breach|cost_overrun|quality_no_sig|manual"
  },

  "kb.tuning.report.ready": {
    "event":"kb.tuning.report.ready","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr","format":"md|html",
    "path":"data/kb-tune/2025-09-15/kb_default_tr/report.md",
    "summary":"Pareto: 2 aday â€¢ Offline en iyi NDCG@10=0.432 â€¢ Online B uplift +7.0% NDCG, p95 +20%, cost +24% â€¢ Promote=YES.",
    "hash":"sha256:..."
  },

  "kb.tuning.card": {
    "event":"kb.tuning.card","timestamp":"iso8601",
    "title":"KB Tuning â€” tr profili: B %50â€™de",
    "body":"NDCG@10 +7% â€¢ p95 +20% (â‰¤250ms) â€¢ maliyet +24% (â‰¤$1.2/1k) â€¢ Promote adÄ±mÄ± sÄ±rada.",
    "severity":"info","ttlSec":900
  },

  "kb.tuning.alert": {
    "event":"kb.tuning.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|dq_block|privacy_risk|slo_breach|cost_overrun|ab_insufficient_power|route_failed|rbac_denied|calc_error"
  },

  "kb.tuning.metrics": {
    "event":"kb.tuning.metrics","timestamp":"iso8601",
    "plans":3,"candidates":6,"offlineRuns":4,"onlineTests":2,"promotions":1,"rollbacks":0,
    "p95PlanMs":24,"p95EvalMin":6,"avgP95LatencyMs":148,"avgCostPer1k":0.81
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  objectives:{ primary:"NDCG@10", secondary:["Recall@50","MRR@10"] },

  constraints:{
    p95LatencyMsMax: 250,
    costPer1kQUsdMax: 1.2,
    memGBMax: 12,
    minUpliftPct: { "NDCG@10": 2.0 },          // anlamlÄ±ysa
    sigLevel: 0.05,
    minSamplesOnline: 5000
  },

  searchSpace:{
    topK:[10,200],
    hybridAlpha:[0.0,0.8],
    reranker:["none","ce-small","ce-large","colbert-lite"],
    engine:["hnsw","ivf","ivf_pq"],
    hnsw:{ M:[16,48], efSearch:[64,800] },
    ivf:{ nlist:[1024,8192], nprobe:[1,64] },
    pq:{ m:[8,32], codeBits:[6,8] },
    dim:[256,384,512,768],
    quant:["fp32","fp16","int8"]
  },

  evaluation:{
    offline:{ enable:true, metrics:["NDCG@10","MRR@10","Recall@50"], stratifiedBy:["lang","intent"] },
    online:{ mode:"ab|bandit", banditAlgo:"thompson", minWindows:4, window:"15m" },
    debias:{ dwellMsMin:1500, botFilter:true, CUPED:true }
  },

  routing:{
    via:"LIVIA-35|gateway",
    stickiness:"session|subject",
    minTrafficPctPerVariant:10
  },

  caching:{
    enable:true,
    key:"normalizedQuery+profile",
    ttlSec: 600,
    warmTopQueries: 200
  },

  integrations:{
    dist:"LIVIA-22", slo:"LIVIA-32", cost:"LIVIA-34",
    experiments:"LIVIA-36", bandit:"LIVIA-37",
    lineage:"LIVIA-39", provenance:"LIVIA-38",
    privacy:"LIVIA-40", dq:"LIVIA-41", schemaMig:"LIVIA-42"
  },

  reporting:{
    outputDir:"data/kb-tune/{YYYY-MM-DD}/{namespace}_{profile}",
    mdFile:"report.md", htmlFile:"report.html",
    html:{ embedMiniCSS:true, chartsInlineSvg:true },
    include:{ pareto:true, abTimelines:true, errorBudget:true }
  },

  rbacViews:{ observer:{ hideEngineParams:true, showOnlySummary:true } },

  idempotencyTtlSec: 3600
}

5) YÃ¶ntem (Ã¶zet)

Aday Ã¼retimi: random + TPE/Bayesian arama; bÃ¼tÃ§e/mem/sig kÄ±sÄ±tlarÄ±yla filtre.

Offline deÄŸerlendirme: qrels â†’ NDCG@10/MRR@10/Recall@50; tÃ¼rkÃ§e/tr gibi profiller ayrÄ±.

Pareto sÄ±nÄ±rÄ±: (NDCG@10 â†‘, p95 â†“, cost â†“) Ã¼Ã§lÃ¼ uzayda Ã¶n cephe Ã§Ä±kar.

Online test: A/B veya bandit (Thompson/UCB); CUPED ile varyans dÃ¼ÅŸÃ¼rme.

Debiasing: bot/low-dwell filtre; Ã¶nceki etkileÅŸimle dÃ¼zeltilmiÅŸ CTR.

Karar: upliftâ‰¥min & kÄ±sÄ±tlar iÃ§inde â†’ promote; deÄŸilse rollback/hold.

Profil bazlÄ±: profile=tr|en|faq|code iÃ§in farklÄ± optimumlar; L35â€™te flag anahtarÄ±yla yÃ¶nlendirme.

Maliyet optimizasyonu: aynÄ± kaliteye daha ucuz aday â†’ prefer (L34 ile doÄŸrula).

6) Pipeline (Kompozisyon)

Plan: kb.tuning.plan.request â†’ mevcut istatistikleri ve arama alanÄ±nÄ± al; aday setini kur

Generate: param Ä±zgarasÄ± + akÄ±llÄ± arama; candidateHash Ã¼ret

Offline Eval: judgement.ingested varsa Ã§alÄ±ÅŸtÄ±r; sÄ±nÄ±r altÄ±nda kalan adaylarÄ± eler

Gate: L41/L42/L40 kontroller (DQ/Åema/Privacy); maliyet & SLO bÃ¼tÃ§eleri (L34/L32)

Online Test: kb.online.test.started â†’ routing (L35/gateway); search.ab.metrics topla

Decide: Uplift+sig ve kÄ±sÄ±tlara gÃ¶re promote/rollback/pause

Report: Pareto + A/B zaman Ã§izgisi + bÃ¼tÃ§e grafiÄŸi â†’ md/html

Emit & Distribute: card/alert/metrics; L22 ile kart daÄŸÄ±t

Provenance & Lineage: deÄŸiÅŸiklikler L38 append; L39â€™a kb_profile â†’ index_params â†’ search_stack kenarlarÄ±

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (plan.request) â†’ PLAN

PLAN â†’ GENERATE â†’ OFFLINE

OFFLINE â†’ (pass) ONLINE | (fail) DONE

ONLINE â†’ (ok) PROMOTE | (breach) ROLLBACK | (at_risk) PAUSE

PROMOTE/ROLLBACK/PAUSE â†’ REPORT â†’ EMIT â†’ IDLE

Hata: ALERT + IDLE; idem: aynÄ± tuneKey ikinci yan etki doÄŸurmaz

8) Kenar Durumlar

Yetersiz gÃ¼Ã§ (power): online Ã¶rnek < minSamplesOnline â†’ uzat veya banditâ€™e geÃ§

Click bias: pozisyon sapmasÄ± â†’ interleaving/shuffle veya CUPED dÃ¼zeltmesi

Bot/otomasyon: hÄ±zlÄ± tÄ±klama/dÃ¼ÅŸÃ¼k dwell â†’ filtre

Cold start profil: qrels yok â†’ yalnÄ±z online bandit + kÃ¼Ã§Ã¼k gÃ¼venli topK

Dil/locale: tr iÃ§in BM25 aÄŸÄ±rlÄ±ÄŸÄ± â†‘; en iÃ§in reranker small varsayÄ±lan

Uzun kuyruk (tail) sorgu: hybridAlpha otomatik adaptasyon (baÅŸarÄ±sÄ±z denseâ€™de BM25 yÃ¼kselt)

SLO spike: slo.guard.triggered â†’ topKâ†“ ve efSearch/nprobeâ†“ geÃ§ici; stabilize sonrasÄ± eski ayarlara dÃ¶n

Cost overrun: cost.guard.triggered â†’ reranker none|ce-smalla dÃ¼ÅŸÃ¼r; quant=int8 aday

Schema drift: doc alanlarÄ± deÄŸiÅŸti â†’ L42 adaptÃ¶r; tuning duraklar, offline tekrar

Privacy risk: ham sorgu logunda PII tespiti â†’ mask ve count dÃ¼ÅŸÃ¼r; raporda Ã¶zet

Observer gÃ¶rÃ¼nÃ¼mÃ¼: yalnÄ±z NDCG/latency/cost Ã¶zetleri; param detaylarÄ± gizli

Idempotency: aynÄ± candidateHash ile yeniden test idempotent; sadece status gÃ¼nceller

9) Telemetri
{
  "kb.tuning.metrics": {
    "event":"kb.tuning.metrics","timestamp":"iso8601",
    "plans":3,"candidates":6,"offlineRuns":4,"onlineTests":2,"promotions":1,"rollbacks":0,
    "p50PlanMs":9,"p95PlanMs":24,"p95EvalMin":6,
    "avgP95LatencyMs":148,"avgCostPer1k":0.81,"upliftNDCG10AvgPct":6.1
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/kbIndexAutotuner.ts                # FSM + orchestrator
services/livia/lib/kb/space.ts                    # arama alanÄ± & aday Ã¼retimi
services/livia/lib/kb/offlineEval.ts              # qrels â†’ NDCG/MRR/Recall
services/livia/lib/kb/onlineTest.ts               # A/B & bandit, CUPED, debias
services/livia/lib/kb/pareto.ts                   # pareto hesaplayÄ±cÄ±
services/livia/lib/kb/decider.ts                  # promote/rollback kurallarÄ±
services/livia/lib/kb/report.ts                   # md/html + grafikler (inline SVG)
services/livia/lib/bridges.ts                     # L22/L26/L32/L34/L35/L36/L37/L38/L39/L40/L41/L42
services/livia/state/kbTuneStore.ts               # idem index + aday & test state
services/livia/__tests__/kbIndexAutotuner.test.ts
cfg/livia.kb.tune.yaml

11) Test Ä°skeleti (Jest/Vitest)

Pareto: en az iki aday Ã¶n cephede; p95/cost kÄ±sÄ±tÄ± ihlal eden elenir

Offline pass/fail: NDCG@10 eÅŸiÄŸini aÅŸan aday pass

Online uplift: NDCG@10 +â‰¥2%, pâ‰¤0.05 â†’ promote; aksi â†’ rollback

SLO breach: p95>250ms â†’ rollback + kart error

Cost overrun: $/1k > 1.2 â†’ rollback

Bandit: Thompsonâ€™da yÃ¼ksek kazanÄ±m varyantÄ±na trafik artar (â‰¥+15pp)

Privacy/DQ/Schema: risk/drift uyarÄ±larÄ±nda test pause

Idempotency: aynÄ± tuneKey tekrarÄ± yan etki yapmaz; yalnÄ±z kart gÃ¼ncellenir

Rapor: md/html yazÄ±ldÄ±; L22 ile daÄŸÄ±tÄ±ldÄ±; L38/L39 baÄŸlarÄ± eklendi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

10:00 kb.tuning.plan.request(tr) â†’ iki aday Ã¼retildi; Pareto Ã§izildi

10:20 Offline eval: cand#ivf-pq-384â€¦ NDCG@10=0.432 PASS

10:30 Online A/B 50/50: 4Ã—15m pencere â†’ B uplift +7% NDCG, p95 154ms (â‰¤250), cost +24% (â‰¤1.2)

11:30 Promote: kb.tuning.promoted â†’ flag varsayÄ±lanÄ± B; rapor/karte daÄŸÄ±tÄ±ldÄ±; provenance/lineage iÅŸlendi.

13) SLO

p95 plan < 30 ms

offline eval â‰¤ 10 dk (â‰¤10K qrels)

online karar â‰¤ 2 saat (4 pencere Ã— 15m)

yanlÄ±ÅŸ promote â‰¤ %1, idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-48 Â· complianceAuditExporter.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Operasyon ve ML yaÅŸam dÃ¶ngÃ¼sÃ¼ndeki kanÄ±tlarÄ± denetlenebilir paket haline getir: WORM append kayÄ±tlarÄ± (L38), lineage alt-grafÄ± (L39), gÃ¼nlÃ¼k digest (L14), DQ raporlarÄ± (L41), ÅŸema migrasyon raporu (L42), drift & saÄŸlÄ±k (L43), retrain (L44), canary (L45), feature-sync (L46), KB tuning (L47) ve ilgili konfig/threshold dosyalarÄ± â†’ imzalÄ±, hashâ€™li, zaman damgalÄ± arÅŸiv. KVKK/GDPR/SOC2/ISO27001 izleri iÃ§in kanÄ±t haritasÄ± (evidence map) Ã¼ret; doÄŸrulanabilirlik: Merkle kÃ¶k + imza + opsiyonel RFC-3161 timestamp.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; AES-GCM ÅŸifreleme (opsiyonel KMS); RBAC & etik kapÄ±.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: compliance|audit tam; ops|mlops sÄ±nÄ±rlÄ±; observer salt okur

Gizlilik: PII Ã§Ä±karÄ±mÄ± L40 ile; operatÃ¶r/kimlikler L21 saltâ€™lÄ± hash; secrets L27 ile maskelenir

Ä°dempotency: auditKey = scope + target + windowISO + profile + version

Observability: spans (audit.plan,audit.collect,audit.compose,audit.pack,audit.verify) + metrics

Uyumluluk: WORM (append-only) kayÄ±t, immutable export; ethics (L26) onayÄ± gerekebilir

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "audit.request": {
    "event":"audit.request","timestamp":"iso8601",
    "scope":"daily|incident|model|kb_profile|regulatory",
    "target":{
      "forDate":"2025-09-15",                 // scope=daily
      "incidentId":"inc-2025-09-13-1",        // scope=incident
      "modelId":"model:slip_anomaly",         // scope=model
      "profile":"kb_default:tr"               // scope=kb_profile
    },
    "profile":"kvkk|gdpr|soc2|iso27001|custom",
    "format":"tar.gz|zip",
    "encrypt":{"enabled":true,"kmsKeyRef":"kms:key/audit-export"},
    "include":{"rawEvents":false,"htmlReports":true,"mdReports":true,"configs":true},
    "redact":{"operators":true,"hashSalt":"rotate-me-daily"},
    "reason":"regulator_request|partner_due_diligence|internal_review",
    "dryRun":false
  },

  "audit.append.evidence": {
    "event":"audit.append.evidence","timestamp":"iso8601",
    "kind":"file|blob|note|link",
    "path":"data/notes/2025-09-13/sess-avax-42.md",
    "label":"investigation note",
    "hash":"sha256:..."
  },

  "audit.verify.request": {
    "event":"audit.verify.request","timestamp":"iso8601",
    "bundlePath":"exports/audit/2025-09-15/daily_2025-09-15.tgz",
    "expectedMerkleRoot":"sha256:...","sig":{"algo":"ed25519","pubKeyId":"auditor#1"}
  }
}


Not: scope=regulatory iÃ§in target boÅŸ olabilir; zaman aralÄ±ÄŸÄ± window: {from,to} isteÄŸe baÄŸlÄ± eklenebilir.

3) Ã‡Ä±ktÄ±lar (Out)
{
  "audit.plan.ready": {
    "event":"audit.plan.ready","timestamp":"iso8601",
    "auditKey":"daily#2025-09-15#kvkk#v1",
    "scope":"daily","target":{"forDate":"2025-09-15"},
    "sections":["digest","incidents","dq","schema","drift","retrain","canary","fsync","kb_tune","configs","lineage","provenance","metrics"],
    "pathsPlanned":84,"hash":"sha256:..."
  },

  "audit.bundle.ready": {
    "event":"audit.bundle.ready","timestamp":"iso8601",
    "auditKey":"daily#2025-09-15#kvkk#v1",
    "format":"tar.gz","encrypted":true,
    "path":"exports/audit/2025-09-15/daily_2025-09-15.tgz",
    "bytes":12400532,
    "manifestPath":"exports/audit/2025-09-15/manifest.json",
    "merkleRoot":"sha256:...","signature":{"algo":"ed25519","keyId":"kms:key/audit-export"},
    "rfc3161Ts":"2025-09-15T18:30:07+03:00"
  },

  "audit.verify.result": {
    "event":"audit.verify.result","timestamp":"iso8601",
    "bundlePath":".../daily_2025-09-15.tgz",
    "verified":{"hashes":true,"merkleRoot":true,"signature":true,"timestamp":true},
    "issues":[]
  },

  "audit.card": {
    "event":"audit.card","timestamp":"iso8601",
    "title":"Denetim Paketi HazÄ±r â€” 15 Eyl (KVKK)",
    "body":"84 kanÄ±t, Merkle kÃ¶k ve imza Ã¼retildi. Åifreli arÅŸiv 11.8MB.",
    "severity":"info","ttlSec":900
  },

  "audit.alert": {
    "event":"audit.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"missing_evidence|worm_violation|signature_failed|timestamp_failed|privacy_risk|rbac_denied|idem_duplicate"
  },

  "audit.metrics": {
    "event":"audit.metrics","timestamp":"iso8601",
    "planned":1,"bundled":1,"verified":1,
    "paths":84,"bytes":12400532,"p95CollectMs":22,"p95PackMs":1800,
    "redactedItems":12,"privacyFindings":0
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  profiles:{
    kvkk:{ map:["L40:privacy","L21:redaction","consent_logs","access_rbac"], keepRawPII:false },
    gdpr:{ map:["purpose_limitation","data_minimization","access_log","deletion_log"], keepRawPII:false },
    soc2:{ map:["change_mgmt","security_monitoring","incident_response","backup_recovery"], keepRawPII:false },
    iso27001:{ map:["A.12.4 logging","A.16 incident","A.14 system acquisition","A.8 asset"], keepRawPII:false },
    custom:{ map:[], keepRawPII:false }
  },

  inputs:{
    // dosya kalÄ±plarÄ±; var olanlara gÃ¶re filtrelenir
    digest:"data/digest/{YYYY-MM-DD}/**/*",
    incidents:"data/incidents/{YYYY-MM-DD}/**/*",
    dq:"data/dq/{YYYY-MM-DD}/**/*",
    schema:"data/schema/{YYYY-MM-DD}/**/*",
    drift:"data/model-health/{YYYY-MM-DD}/**/*",
    retrain:"data/retrain/{YYYY-MM-DD}/**/*",
    canary:"data/canary/{YYYY-MM-DD}/**/*",
    fsync:"data/fsync/{YYYY-MM-DD}/**/*",
    kb_tune:"data/kb-tune/{YYYY-MM-DD}/**/*",
    configs:"cfg/**/*.yaml",
    lineage:"state/lineage/index/{YYYY-MM-DD}/**/*",
    provenance:"state/provenance/**/chain.jsonl",
    metrics:"state/**/metrics/*.jsonl"
  },

  packaging:{
    format:"tar.gz",
    outDir:"exports/audit/{YYYY-MM-DD}",
    manifest:"manifest.json",
    includeHtml:true, includeMd:true, includeConfigs:true,
    redact:{ operators:true, emails:true, phones:true, hashSalt:"rotate-me-daily" },
    exclude:{ rawPII:true, drillShadow:true }
  },

  cryptography:{
    sign:{ enabled:true, algo:"ed25519", keyRef:"kms:key/audit-export" },
    timestamp:{ enabled:true, rfc3161:true, tsaUrl:"tsa://internal" },
    encrypt:{ enabled:true, algo:"aes-256-gcm", kmsKeyRef:"kms:key/audit-export" },
    merkle:{ fanout:1024 } // bÃ¼yÃ¼k paketlerde verimli kÃ¶k
  },

  worm:{
    requireAppendOnly:true,
    verifyOnCollect:true
  },

  gating:{
    ethics:"LIVIA-26",
    privacy:"LIVIA-40",
    secrets:"LIVIA-27"
  },

  rbacViews:{
    observer:{ hidePIISnippets:true, showOnlySummary:true }
  },

  retention:{
    hotDays:30, warmDays:365, coldDays:1825, keepForever:false
  },

  idempotencyTtlSec: 86400
}

5) Paket Ä°Ã§eriÄŸi (YapÄ±)
/audit_bundle/
  manifest.json                      # tÃ¼m Ã¶ÄŸeler, sha256, boyut, kaynak olayÄ±
  evidence_map.json                  # KVKK/GDPR/SOC2/ISO karÅŸÄ±lÄ±klarÄ±
  checksums.merkle                   # Merkle aÄŸaÃ§ dÃ¼ÄŸÃ¼mleri + kÃ¶k
  signature.sig                      # ed25519 imza (manifest + kÃ¶k)
  timestamp.rfc3161                 # TSA damgasÄ± (opsiyonel)
  /digest/...                        # L14 Ã§Ä±ktÄ± dosyalarÄ±
  /incidents/...                     # olay raporlarÄ± + postmortem (L15)
  /dq/...                            # L41
  /schema/...                        # L42
  /drift/...                         # L43
  /retrain/...                       # L44
  /canary/...                        # L45
  /fsync/...                         # L46
  /kb_tune/...                       # L47
  /configs/...                       # cfg/*.yaml snapshot
  /lineage/...                       # L39 alt-graf (as-of)
  /provenance/chain.jsonl            # L38 append zinciri (sÃ¼zÃ¼lmÃ¼ÅŸ)
  /metrics/...                       # modÃ¼l metrikleri (Ã¶zet)


manifest.json alanlarÄ± (Ã¶zet):

{
  "bundle": {
    "auditKey":"daily#2025-09-15#kvkk#v1",
    "createdAt":"iso8601","tz":"Europe/Istanbul",
    "encrypted":true,"format":"tar.gz","version":"1.0.0"
  },
  "sources":[
    {"section":"dq","path":"data/dq/2025-09-15/.../report.md","sha256":"...","size":6200,
     "eventWindow":{"from":"2025-09-15T00:00:00+03:00","to":"2025-09-15T23:59:59+03:00"}}
  ],
  "merkleRoot":"sha256:...",
  "signature":{"algo":"ed25519","keyId":"kms:key/audit-export"},
  "privacy":{"piiRedacted":true,"operatorsHashed":true},
  "evidenceMap":{"kvkk":["privacy.metrics","redaction_policy","consent_summary"],"soc2":["change_mgmt","incident_response"]}
}

6) Pipeline (Kompozisyon)

Plan: audit.request â†’ scope/target/profile doÄŸrula; plan.ready Ã¼ret

Collect: konfig kaynaklarÄ±na gÃ¶re dosya ve olaylarÄ± topla; WORM bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ ve tarih penceresi denetimleri

Redact/Gate: L40/L21 redaksiyon; L27 secret mask; L26 etik onay (gerekirse)

Compose: manifest.json, evidence_map.json Ã¼ret; lineage alt-graf + provenance zincir sÃ¼zmesi

Pack: tar.gz (veya zip) oluÅŸtur; Merkle aÄŸacÄ±, ed25519 imza, RFC-3161 timestamp; opsiyonel AES-GCM ÅŸifreleme

Emit/Distribute: audit.bundle.ready + kart/alert/metrics; izne baÄŸlÄ± dÄ±ÅŸa aktarÄ±m (partner/regulator sftp)

Verify (ops.): audit.verify.request geldiÄŸinde: hash/merkle/imza/zaman damgasÄ± doÄŸrula â†’ verify.result

Index: L39 ile bundle dÃ¼ÄŸÃ¼mÃ¼ ve ilgili artefakt kenarlarÄ±; L38 append kayÄ±tlarÄ±

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (audit.request) â†’ PLAN

PLAN â†’ COLLECT

COLLECT â†’ (gates pass) COMPOSE | (privacy/secrets fail) ALERT

COMPOSE â†’ PACK â†’ EMIT (bundle/card/metrics) â†’ IDLE

VERIFY (yan kanal): audit.verify.request â†’ CHECK â†’ EMIT

Hata: ALERT; idem: aynÄ± auditKey iÃ§in ikinci paket yazÄ±lmaz (yalnÄ±z verify Ã§alÄ±ÅŸÄ±r)

8) Kenar Durumlar

Eksik kanÄ±t: bir bÃ¶lÃ¼m bulunamazsa missing_evidence; manifestte iÅŸaretlenir, profil gereklerine gÃ¶re fail veya warn

WORM ihlali: kaynak zincirde zaman/offset geriye gitmiÅŸ â†’ worm_violation (kritik)

PII sÄ±zÄ±ntÄ±sÄ±: redaksiyon sonrasÄ± dahi PII kaldÄ± â†’ privacy_risk (kritik, paket iptali)

Devasa paket: >1GB â†’ Ã§ok parÃ§alÄ± paket (split) + kÃ¶kleri Ã¼st-Merkle ile birleÅŸtir

Åifreleme anahtarÄ± yok: encrypt.enabled=true ama KMS ulaÅŸÄ±lamÄ±yor â†’ retry with backoff; 3 kez sonra alert

Regulator Ã¶zel istek: scope=regulatory â†’ Ã¶zel â€œkanÄ±t haritasÄ±â€ ÅŸablonu + ek sÃ¶zlÃ¼k (Ã¶rn. DPIA)

Observer gÃ¶rÃ¼nÃ¼mÃ¼: yalnÄ±z audit.card ve manifest baÅŸlÄ±klarÄ±; dosya iÃ§erikleri gizli

Idempotency: aynÄ± auditKey tekrarÄ±nda PACK atlanÄ±r; audit.bundle.ready yeniden yayÄ±labilir

9) Telemetri
{
  "audit.metrics": {
    "event":"audit.metrics","timestamp":"iso8601",
    "planned":1,"bundled":1,"verified":1,
    "paths":84,"bytes":12400532,
    "p50CollectMs":9,"p95CollectMs":22,"p95PackMs":1800,
    "redactedItems":12,"privacyFindings":0,"wormViolations":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/complianceAuditExporter.ts        # FSM + orchestrator
services/livia/lib/audit/plan.ts                 # scope/profile â†’ plan Ã¼retimi
services/livia/lib/audit/collect.ts              # dosya & olay toplama + WORM doÄŸrulama
services/livia/lib/audit/redact.ts               # L21/L27/L40/L26 kapÄ±larÄ±
services/livia/lib/audit/compose.ts              # manifest + evidence_map + lineage/prov sÃ¼zgeci
services/livia/lib/audit/pack.ts                 # tar.gz/zip + merkle + imza + timestamp + ÅŸifreleme
services/livia/lib/audit/verify.ts               # hash/merkle/imza doÄŸrulama
services/livia/lib/bridges.ts                    # L14/L15/L21/L22/L26/L27/L38/L39/L40/L41/L42/L43/L44/L45/L46/L47
services/livia/state/auditStore.ts               # idem index + paket geÃ§miÅŸi
services/livia/__tests__/complianceAuditExporter.test.ts
cfg/livia.audit.yaml

11) Test Ä°skeleti (Jest/Vitest)

Plan: audit.request(scope=daily) â†’ plan.ready ve 10+ bÃ¶lÃ¼m planlandÄ±

Collect: WORM kayÄ±tlarÄ± geriye gitmiyor â†’ PASS; kasÄ±tlÄ± ihlalde worm_violation

Redaction/Privacy: PII tespit simÃ¼lasyonu â†’ redaksiyon sonrasÄ± privacyFindings=0

Pack: tar.gz Ã¼retildi, Merkle kÃ¶k hesaplandÄ±, ed25519 imza ve RFC-3161 damgasÄ± eklendi

Encrypt: AES-GCM ÅŸifreli Ã§Ä±ktÄ±; KMS anahtar arÄ±zasÄ±nda retry + alert

Verify: merkle+imza+tarih true

Missing evidence: eksik DQ raporu â†’ manifestte iÅŸaretlendi; KVKK profilinde warn

Idempotency: aynÄ± auditKey tekrarÄ± dosya yazmaz; yalnÄ±z bundle.ready yeniden yayÄ±lÄ±r

Observer gÃ¶rÃ¼nÃ¼mÃ¼: iÃ§erik yok, yalnÄ±z kart ve manifest baÅŸÄ±

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

18:20 audit.request(scope=daily, forDate=2025-09-15, profile=kvkk, encrypt=true)

PLAN: 84 kalem â†’ COLLECT (L14/L41/L42/L43/L44/L45/L46/L47 + lineage/provenance)

REDACT/GATE: L40/L21/L27/L26 geÃ§ildi â†’ COMPOSE manifest & evidence_map

PACK: tar.gz + Merkle + imza + timestamp + AES-GCM â†’ audit.bundle.ready

VERIFY (opsiyonel): doÄŸrulama PASS â†’ kart daÄŸÄ±tÄ±ldÄ± (L22)

13) SLO

p95 collect < 30 ms / dosya (metadata)

p95 pack < 35 dk / 1GB paket (streaming tar)

doÄŸrulama hatasÄ± â‰¤ %0.5, WORM ihlali = 0 hedef

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-49 Â· multiRegionFailoverCoordinator.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Ã‡ok bÃ¶lgeli mimaride hizmet sÃ¼rekliliÄŸi iÃ§in proaktif saÄŸlÄ±k izleme â†’ karar â†’ trafik kaydÄ±rma â†’ veri kipleri (read-only/fence) â†’ geri dÃ¶nÃ¼ÅŸ (failback) sÃ¼reÃ§lerini otomatikleÅŸtir. RTO/RPO hedeflerini uygula; active-active / active-passive topolojileri destekle; DNS/GSLB, service mesh/gateway, mesaj kuyruÄŸu/broker, veritabanÄ± ve depolama katmanlarÄ±yla tutarlÄ± failover gerÃ§ekleÅŸtir. Split-brain Ã¶nleme, quorum/lease/fencing mekanizmalarÄ±; brownout vs blackout ayrÄ±mÄ±; flapping Ã¶nleyici histerezis. Kararlar SLO (L32), Maliyet (L34), Etik (L26), Provenance (L38), Lineage (L39) ile izlenir; olaylar Incident (L15) ve Drill (L50)â€™ye baÄŸlanÄ±r.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: ops|resilience|policy tam; observer sÄ±nÄ±rlÄ± okur

Gizlilik: PII yok; serbest metin Ã¶zetleri L21 ile redakte

Ä°dempotency: mrfKey = topologyHash + region + step + windowISO

Observability: spans (mrf.monitor,mrf.decide,mrf.execute,mrf.stabilize,mrf.failback) + metrics

Uyumluluk: kritik deÄŸiÅŸimler L26 etik/WORM; L38 WORM append

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "region.registered": {
    "event":"region.registered","timestamp":"iso8601",
    "region":"eu-central|us-east|me-west",
    "role":"primary|secondary|dr","Topology":"active_active|active_passive",
    "capacityPct":100,"priority":1,"gslbPool":"prod-gslb-a"
  },

  "service.health.probe": {
    "event":"service.health.probe","timestamp":"iso8601",
    "region":"eu-central","serviceId":"kb_api",
    "p95Ms":132,"errorRatePct":0.8,"availPct":99.93,
    "synthetic":{"/search":140,"/answer":180}
  },

  "dependency.health": {
    "event":"dependency.health","timestamp":"iso8601",
    "region":"eu-central","kind":"db|cache|broker|object_store|feature_store",
    "id":"db#orders","status":"ok|degraded|down","lagSec":12,"replication":"sync|async"
  },

  "datastore.replica.lag": {
    "event":"datastore.replica.lag","timestamp":"iso8601",
    "region":"us-east","primaryRegion":"eu-central",
    "store":"postgres|mysql|mongo|iceberg|kafka","lagSec":12,"maxLagSecObserved":28
  },

  "broker.partition.status": {
    "event":"broker.partition.status","timestamp":"iso8601",
    "region":"eu-central","broker":"kafka","topic":"events",
    "partitions":{"underReplicated":3,"offline":0}
  },

  "rto.rpo.policy": {
    "event":"rto.rpo.policy","timestamp":"iso8601",
    "serviceId":"kb_api","RTOsec":300,"RPOsec":30,
    "writeModeOnDegrade":"read_only|block|continue",
    "fencing":{"leaseProvider":"consul|etcd","ttlSec":30}
  },

  "failover.plan.request": {
    "event":"failover.plan.request","timestamp":"iso8601",
    "reason":"manual|incident|automation","targetRegion":"us-east|null",
    "scope":"service|tenant|global","dryRun":false
  },

  "traffic.shift.request": {
    "event":"traffic.shift.request","timestamp":"iso8601",
    "via":"gslb|mesh|gateway|flag",
    "weights":[["eu-central",40],["us-east",60]],
    "stickiness":"session|subject|null"
  },

  "dns.ttl.policy": {
    "event":"dns.ttl.policy","timestamp":"iso8601",
    "pool":"prod-gslb-a","ttlSecNominal":120,"ttlSecDuringIncident":10
  },

  "incident.started|incident.closed": {
    "event":"incident.started","timestamp":"iso8601",
    "id":"inc-2025-09-15-1","severity":"high","title":"EU latency spike"
  },

  "recovery.drill.request": {
    "event":"recovery.drill.request","timestamp":"iso8601",
    "scenario":"region-blackout|db-primary-loss|network-partition",
    "targetRegion":"us-east","scheduledAt":"iso8601","dryRun":true
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "failover.plan.ready": {
    "event":"failover.plan.ready","timestamp":"iso8601",
    "mode":"active_active|active_passive",
    "fromRegion":"eu-central","toRegion":"us-east","scope":"global",
    "actions":["dns_ttl_lower","traffic_20â†’80","db_read_only","fence_primary","promote_secondary","verify","traffic_0â†’100"],
    "rationale":{"rtoSec":300,"rpoSec":30,"lagOk":true,"brownout":true}
  },

  "failover.started": {
    "event":"failover.started","timestamp":"iso8601",
    "planId":"mrf#7f9a12","from":"eu-central","to":"us-east",
    "via":{"routing":"gslb+mesh","datastore":"postgres(kms-lock)","broker":"kafka(mirror)"},
    "dnsTtlSec":10
  },

  "traffic.shift.applied": {
    "event":"traffic.shift.applied","timestamp":"iso8601",
    "weights":[["eu-central",20],["us-east",80]],
    "stickiness":"session","p95RouteMs":8.4
  },

  "datastore.mode.changed": {
    "event":"datastore.mode.changed","timestamp":"iso8601",
    "store":"postgres","region":"eu-central","mode":"read_only","reason":"rpo_guard"
  },

  "quorum.lease.acquired": {
    "event":"quorum.lease.acquired","timestamp":"iso8601",
    "region":"us-east","provider":"consul","leaseId":"lease#abc","ttlSec":30
  },

  "splitbrain.detected": {
    "event":"splitbrain.detected","timestamp":"iso8601",
    "partition":"euâ†”us","symptom":"dual-primary-attempt","action":"fence_eu_primary"
  },

  "failover.stabilized": {
    "event":"failover.stabilized","timestamp":"iso8601",
    "toRegion":"us-east","p95Ms":118,"errPct":0.7,"dbLagSec":5,"brokerUnderReplicated":0
  },

  "failback.plan.ready": {
    "event":"failback.plan.ready","timestamp":"iso8601",
    "fromRegion":"us-east","toRegion":"eu-central",
    "checks":["health_ok","replication_caught_up","drill_pass"],"window":"low_traffic"
  },

  "failback.completed": {
    "event":"failback.completed","timestamp":"iso8601",
    "activeRegion":"eu-central","downtimeMs":0
  },

  "mrf.card": {
    "event":"mrf.card","timestamp":"iso8601",
    "title":"Failover %80â†’US-EST â€” Brownout mod",
    "body":"EU p95 600ms â€¢ RPO ok (12s lag) â€¢ DB EU read-only â€¢ DNS TTL 10s.",
    "severity":"warn","ttlSec":900
  },

  "mrf.alert": {
    "event":"mrf.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"split_brain|lease_lost|fencing_failed|rpo_risk|route_failed|idem_duplicate|rbac_denied"
  },

  "mrf.metrics": {
    "event":"mrf.metrics","timestamp":"iso8601",
    "failovers":1,"failbacks":1,"falseFailovers":0,
    "avgDetectSec":42,"mttrSec":420,"avgRpoSecObserved":14,
    "trafficShiftSteps":3,"p95RouteMs":9.1
  },

  "mrf.report.ready": {
    "event":"mrf.report.ready","timestamp":"iso8601",
    "path":"data/mrf/2025-09-15/failover_eu_to_us/report.md",
    "summary":"Brownoutâ†’gradual shift 20/80; EU DB read-only; lease US OK; stabilize 7m; RPO 12s.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  topology:{
    mode:"active_active",                     // veya active_passive
    regions:["eu-central","us-east","me-west"],
    priorities:{ "eu-central":1, "us-east":2, "me-west":3 },
    gslbPool:"prod-gslb-a"
  },

  objectives:{
    RTOsec:300, RPOsec:30,
    detectWindowSec:60, hysteresisWindows:2     // flapping Ã¶nleme
  },

  healthThresholds:{
    app:{ p95Ms:{warn:250, breach:500}, errorRatePct:{warn:1.0, breach:2.0}, availPctMin:99.9 },
    dep:{ dbLagSec:{warn:20, breach:60}, brokerUnderReplicatedMax:{warn:5, breach:10} }
  },

  decisionPolicy:{
    preferGradualShift:true,                    // 0â†’20â†’50â†’80â†’100
    shiftSteps:[20,50,80,100],
    stickiness:"session",                       // mesh/gateway/flag ile tutarlÄ±lÄ±k
    writeOnDegrade:"read_only",                 // RPO riski varsa EU write kapat
    requireLease:true,                          // quorum/lease olmadan promote yok
    freezeOnIncident:false
  },

  routing:{
    via:["gslb","mesh","gateway","flag"],       // bir veya birkaÃ§Ä±
    dns:{ ttlSecNominal:120, ttlSecDuringIncident:10 }
  },

  datastore:{
    fencing:{ provider:"consul", ttlSec:30, renewEverySec:10 },
    readOnlySQL:["SET default_transaction_read_only=on"],
    stonith:{ enabled:true, method:"asg/cordon&drain|vm-stop|k8s-fence" }
  },

  broker:{
    kafka:{ mirrorTopics:["events","audit"], enforceAck:"-1" }
  },

  safetyGuards:{
    slo:"LIVIA-32", cost:"LIVIA-34", ethics:"LIVIA-26",
    lineage:"LIVIA-39", provenance:"LIVIA-38", incidents:"LIVIA-15"
  },

  reporting:{
    outputDir:"data/mrf/{YYYY-MM-DD}/{from}_{to}",
    mdFile:"report.md", htmlFile:"report.html",
    html:{ embedMiniCSS:true, chartsInlineSvg:true },
    include:{ timelines:true, lagCharts:true, routeSteps:true }
  },

  rbacViews:{ observer:{ showRoutes:true, hideLeaseIds:true } },

  idempotencyTtlSec: 3600
}

5) DeÄŸerlendirme & Karar MantÄ±ÄŸÄ± (Ã¶zet)

SaÄŸlÄ±k PuanÄ±: regionHealth = w_app*app + w_dep*deps (app: p95/err/avail; dep: db lag, broker URP).

Durum: ok | brownout (degraded) | blackout (down).

RPO KontrolÃ¼: replicaLagSec â‰¤ RPOsec â†’ write devam/RO; deÄŸilse write block + fence.

RTO KontrolÃ¼: detect + execute â‰¤ RTOsec olacak ÅŸekilde gradual veya instant seÃ§.

Quorum/Lease: yeni aktif bÃ¶lgede lease elde edilmeden promote yok.

Split-brain Ã¶nleme: tekil lease/fence, eski birincil STONITH/cordon&drain.

Yol HaritasÄ±: gslb.dns ttlâ†“ â†’ traffic shift â†’ db read_only â†’ leaseâ†’ promote_secondary â†’ verify â†’ 100%.

6) Pipeline (Kompozisyon)

Monitor: service.health.probe + dependency.health + replica.lag + broker.status topla

Assess: eÅŸiklere gÃ¶re brownout/blackout; RPO/RTO uygunluk hesapla

Plan: failover.plan.ready â€” eylem adÄ±mlarÄ± & sÄ±ralÄ± trafik kaydÄ±rma

Execute:

Routing: GSLB DNS TTLâ†“, mesh/gateway aÄŸÄ±rlÄ±klarÄ±nÄ± uygula

Data: eski birincil read-only/fence; yeni bÃ¶lgede lease + promote

Broker: mirror/cutover; acks=-1 ile veri kaybÄ± riski â†“

Stabilize: pencereler boyunca p95/err/lag izlenir; sorun yoksa adÄ±m ilerlet

Failback: koÅŸullar oluÅŸunca planla â†’ dÃ¼ÅŸÃ¼k trafik penceresinde geri dÃ¶nÃ¼ÅŸ

Report/Emit: md/html rapor; card/alert/metrics; L22 ile daÄŸÄ±tÄ±m

Lineage/Provenance: karar/eylem kayÄ±tlarÄ±nÄ± L39/L38â€™e baÄŸla; L48 audit pakete girer

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (probe/dependency/lag) â†’ MONITOR

MONITOR â†’ (degradeâ‰¥hysteresis) DECIDE

DECIDE â†’ EXECUTE_FAILOVER (plan uygulama adÄ±mlarÄ±)

EXECUTE_FAILOVER â†’ STABILIZE (pencere saÄŸlÄ±ÄŸÄ±)

STABILIZE â†’ (ok) DONE | (issue) ROLL_FORWARD/ROLLBACK

FAILBACK: ayrÄ± yol â€” PLAN_FAILBACK â†’ EXECUTE â†’ STABILIZE â†’ DONE

Hata: ALERT; idem: aynÄ± mrfKey iÃ§in ikinci yan etki yok (yalnÄ±z kart gÃ¼ncellenir)

8) Kenar Durumlar

Brownout vs Blackout: brownoutâ€™ta gradual, blackoutâ€™ta instant to 100%.

Network Partition (asymmetric): her iki bÃ¶lge kendini aktif sanÄ±yorsa â†’ splitbrain.detected + STONITH.

DNS Propagation: TTL dÃ¼ÅŸÃ¼rÃ¼lmÃ¼ÅŸ ama istemciler cacheâ€™li â†’ mesh/gateway ile ek zorla yÃ¶nlendirme.

Flapping: histerezis + consecutiveWindowsâ‰¥2 olmadan failover yok.

Write-heavy servis: RPO riski yÃ¼ksek â†’ double-write buffer (opsiyonel), aksi halde RO.

Cross-region cost spike: L34 cost guard â†’ shiftSteps daha yavaÅŸ.

Ethics/Compliance: public etki (Ã¶r. veri konumu) deÄŸiÅŸiyorsa L26 onayÄ±.

Drill Modu: L50 senaryosu; gerÃ§ek trafiÄŸe dokunmadan tam yol prova.

Observer gÃ¶rÃ¼nÃ¼mÃ¼: lease/stun operasyon detaylarÄ± gizli.

Idempotency: aynÄ± adÄ±m tekrarÄ± yalnÄ±z durumu/karteyi yeniler.

9) Telemetri
{
  "mrf.metrics": {
    "event":"mrf.metrics","timestamp":"iso8601",
    "failovers":1,"failbacks":1,"falseFailovers":0,
    "avgDetectSec":42,"mttrSec":420,"avgRpoSecObserved":14,
    "dataLossBytes":0,"splitBrainEvents":0,
    "p50RouteMs":4.3,"p95RouteMs":9.1
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/multiRegionFailoverCoordinator.ts   # FSM + orchestrator
services/livia/lib/mrf/monitor.ts                  # saÄŸlÄ±k toplama & skor
services/livia/lib/mrf/decide.ts                   # RTO/RPO + plan Ã¼retimi
services/livia/lib/mrf/execute.ts                  # dns/mesh/gateway + db/broker adÄ±mlarÄ±
services/livia/lib/mrf/fencing.ts                  # lease/stonith/fence
services/livia/lib/mrf/stabilize.ts                # penceresel saÄŸlÄ±k & adÄ±m yÃ¼kseltme
services/livia/lib/mrf/failback.ts                 # geri dÃ¶nÃ¼ÅŸ planÄ±/uygulama
services/livia/lib/mrf/report.ts                   # md/html + grafik (inline SVG)
services/livia/lib/bridges.ts                      # L15/L22/L26/L32/L34/L38/L39/L41/L42/L45/L48/L50
services/livia/state/mrfStore.ts                   # idem index + plan/step/lease kayÄ±tlarÄ±
services/livia/__tests__/multiRegionFailoverCoordinator.test.ts
cfg/livia.mrf.yaml

11) Test Ä°skeleti (Jest/Vitest)

Brownout: EU p95 600ms, err 1.8% â†’ gradual shift 20/50/80â†’100, kart warn

Blackout: EU down â†’ instant 100% US, RTO â‰¤ 300s

RPO Guard: lag 12s (â‰¤30s) â†’ EU read-only; 65s â†’ block writes + fence

Lease & Fencing: lease alÄ±nmadan promote yok; Ã§ift birincil giriÅŸiminde splitbrain.detected

Broker mirror: URP=0; cutover tamam; veri kaybÄ± 0 byte

Failback: saÄŸlÄ±k & replication catch-up sonrasÄ± downtime 0ms

Flapping: tek pencere spike â†’ failover yok

Cost guard: cross-region maliyet alarmÄ±nda adÄ±mlar yavaÅŸlatÄ±ldÄ±

Idempotency: aynÄ± mrfKey yinelemesi yan etkisiz; yalnÄ±z kart gÃ¼ncellendi

Rapor: md/html yazÄ±ldÄ±; L22 daÄŸÄ±tÄ±ldÄ±; L38/L39 linkleri iÅŸlendi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

12:02 EU brownout: p95 620ms, err 1.6% â†’ DECIDE (RTO=300, RPO=30; lag=12s OK)

EXECUTE: DNS TTL 10s, traffic 20/80 US, EU DB read-only, US lease acquired â†’ promote

12:09 STABILIZE: p95 118ms, err 0.7% â†’ 100% US

13:40 EU toparladÄ±: failback.plan.ready dÃ¼ÅŸÃ¼k trafikte â†’ failback.completed (downtime 0ms).

Rapor/karte yayÄ±nlandÄ±; kararlar L38/L39; paket L48â€™e girdi.

13) SLO

Detect p95 < 60 s

Planâ†’first shift â‰¤ 90 s

RTO (brownout) â‰¤ 300 s; RTO (blackout) â‰¤ 120 s

RPO gÃ¶zlenen â‰¤ hedef + 5 s

YanlÄ±ÅŸ failover â‰¤ %1; idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-50 Â· disasterRecoveryDrills.ts â€” GeniÅŸ Prompt v3 (+ Hardening)

AmaÃ§:
Felaket kurtarma (DR) kabiliyetini sÃ¼rekli kanÄ±tlamak iÃ§in senaryo Ã¼ret â†’ planla â†’ gÃ¼venlik kontrolleri â†’ kontrollÃ¼ arÄ±za enjekte et (chaos) â†’ failover (L49) â†’ doÄŸrula (RTO/RPO/data loss=0) â†’ failback â†’ puanla â†’ bulgu & iyileÅŸtirme planÄ± â†’ raporla yaÅŸam dÃ¶ngÃ¼sÃ¼nÃ¼ otomatikleÅŸtir. Brownout/blackout, network partition, DB primary kaybÄ±, broker kesintisi, DNS/GSLB arÄ±zasÄ±, storage/object store unavailability, feature store lag (L46) gibi senaryolarÄ± kapsa. Kararlar SLO (L32), Maliyet (L34), Etik/Privacy (L26/L40), WORM/Provenance (L38), Lineage (L39) ve Audit Export (L48) ile izlenir.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: resilience|ops|policy tam, observer salt-okur

Gizlilik: PII yok; serbest metinler L21 ile redakte

Ä°dempotency: drillKey = scenarioId + windowISO + topologyHash + stageHash

Observability: spans (drill.plan,drill.guard,drill.inject,drill.execute,drill.verify,drill.score,drill.report) + metrics

Uyum: kritik adÄ±mlar L26 onay+, L38 WORM append; tatbikatlar production-safe (blast radius sÄ±nÄ±rlÄ±)

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "drill.catalog.registered": {
    "event":"drill.catalog.registered","timestamp":"iso8601",
    "scenarioId":"region-blackout-eu",
    "title":"Region Blackout â€” EU â†’ US failover",
    "topology":"active_active|active_passive",
    "stages":[
      {"name":"prewarm","timeoutSec":600},
      {"name":"inject_blackout","timeoutSec":120},
      {"name":"failover_execute","timeoutSec":900},
      {"name":"stabilize_verify","timeoutSec":900},
      {"name":"failback","timeoutSec":900}
    ],
    "slo":{"RTOsec":300,"RPOsec":30},
    "blastRadius":{"trafficMaxPct":25,"tenants":["sandbox","internal"]},
    "guards":{"freezeOnIncident":true,"abortOnSloBreach":true}
  },

  "drill.request": {
    "event":"drill.request","timestamp":"iso8601",
    "scenarioId":"region-blackout-eu",
    "schedule":{"at":"2025-09-16T02:00:00+03:00","windowMin":60},
    "env":"prod|staging",
    "dryRun":false,
    "syntheticLoad":{"enabled":true,"rps":120,"pattern":"bursty|steady"},
    "evidenceProfile":"soc2|iso27001|kvkk|gdpr|custom",
    "notes":"geceleri dÃ¼ÅŸÃ¼k trafik"
  },

  "drill.cancel.request": {
    "event":"drill.cancel.request","timestamp":"iso8601",
    "reason":"manual|incident|policy","by":"op#7f9a12"
  },

  "chaos.inject.result": {
    "event":"chaos.inject.result","timestamp":"iso8601",
    "stage":"inject_blackout|db_primary_loss|dns_outage|broker_fail",
    "tool":"simian|chaosmesh|custom",
    "success":true,"details":{"targets":["eu-central"],"durationSec":90}
  },

  "mrf.state.update": {
    "event":"mrf.state.update","timestamp":"iso8601",
    "fromRegion":"eu-central","toRegion":"us-east",
    "phase":"plan|execute|stabilize|failback","progressPct":80
  },

  "service.health.probe": {
    "event":"service.health.probe","timestamp":"iso8601",
    "region":"eu-central|us-east","serviceId":"kb_api",
    "p95Ms":128,"errorRatePct":0.7,"availPct":99.92
  },

  "datastore.replica.lag": {
    "event":"datastore.replica.lag","timestamp":"iso8601",
    "region":"us-east","primaryRegion":"eu-central",
    "store":"postgres|kafka|iceberg","lagSec":18
  },

  "slo.guard.triggered|slo.guard.recovered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"latency_p95|error_rate","severity":"high"
  },

  "cost.guard.triggered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "component":"traffic_shift","severity":"high","deltaUSDPerHour":42.5
  },

  "incident.started": {
    "event":"incident.started","timestamp":"iso8601",
    "id":"inc-2025-09-15-7","severity":"high","title":"Real prod incident"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "drill.plan.ready": {
    "event":"drill.plan.ready","timestamp":"iso8601",
    "drillKey":"region-blackout-eu#2025-09-16T02:00+03:00",
    "stages":["prewarm","inject_blackout","failover_execute","stabilize_verify","failback"],
    "blastRadius":{"trafficMaxPct":25,"tenants":["sandbox","internal"]},
    "guards":{"RTOsec":300,"RPOsec":30,"freezeOnIncident":true},
    "hash":"sha256:..."
  },

  "drill.guard.snapshot": {
    "event":"drill.guard.snapshot","timestamp":"iso8601",
    "status":"ok|at_risk|abort",
    "checks":{"changeFreeze":"off","activeIncident":false,"rbac":true,"sloBudgetOk":true,"costBudgetOk":true}
  },

  "drill.started": {
    "event":"drill.started","timestamp":"iso8601",
    "scenarioId":"region-blackout-eu","env":"prod","syntheticLoad":{"rps":120}
  },

  "drill.stage.progress": {
    "event":"drill.stage.progress","timestamp":"iso8601",
    "stage":"failover_execute","progressPct":60,"notes":"DNS TTL=10; traffic 20â†’80"
  },

  "drill.verify.snapshot": {
    "event":"drill.verify.snapshot","timestamp":"iso8601",
    "RTOsecObserved":278,"RPOsecObserved":14,
    "dataLossBytes":0,"errPct":"<=1%","p95Ms":118,"brokerUnderReplicated":0,
    "status":"pass|fail|partial"
  },

  "drill.scoring.ready": {
    "event":"drill.scoring.ready","timestamp":"iso8601",
    "score":{"total":92,"RTO":30,"RPO":30,"Runbook":12,"Observability":10,"Automation":10},
    "level":"green|yellow|red"
  },

  "drill.findings.ready": {
    "event":"drill.findings.ready","timestamp":"iso8601",
    "items":[
      {"severity":"high","title":"DNS TTL dÃ¼ÅŸÃ¼ÅŸÃ¼ geÃ§ uygulandÄ±","action":"gslb policy hot-reload"},
      {"severity":"medium","title":"Runbook adÄ±mÄ± manuel","action":"mesh weight API otomasyonu"}
    ]
  },

  "drill.remediation.plan.ready": {
    "event":"drill.remediation.plan.ready","timestamp":"iso8601",
    "tasks":[
      {"id":"rem-1","owner":"resilience","desc":"GSLB TTL hot-reload","etaDays":3},
      {"id":"rem-2","owner":"platform","desc":"Mesh route otomasyonu","etaDays":5}
    ]
  },

  "drill.report.ready": {
    "event":"drill.report.ready","timestamp":"iso8601",
    "path":"data/drills/2025-09-16/region-blackout-eu/report.md",
    "summary":"RTO 278s, RPO 14s, data loss 0, score 92/100; 2 bulgu, 2 remediation.",
    "hash":"sha256:..."
  },

  "drill.card": {
    "event":"drill.card","timestamp":"iso8601",
    "title":"DR Drill Tamam â€” Region Blackout (EUâ†’US)",
    "body":"RTO 278s â€¢ RPO 14s â€¢ Score 92 â€¢ 0 data loss â€¢ 2 bulgu/2 fix.",
    "severity":"info","ttlSec":900
  },

  "drill.alert": {
    "event":"drill.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"guard_abort|chaos_failed|route_failed|rpo_risk|long_rto|idem_duplicate|rbac_denied|incident_freeze"
  },

  "drill.metrics": {
    "event":"drill.metrics","timestamp":"iso8601",
    "drills":1,"passes":1,"fails":0,
    "avgRTOsec":278,"avgRPOsec":14,"dataLossBytes":0,
    "p95PlanMs":24,"p95StageMs":3200,"aborts":0
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  catalog:{
    scenarios:[
      "region-blackout","region-brownout","db-primary-loss",
      "network-partition","dns-outage","broker-fail","object-store-unavail",
      "featurestore-high-lag"
    ],
    defaults:{
      RTOsec:300, RPOsec:30,
      stages:["prewarm","inject","failover_execute","stabilize_verify","failback"]
    }
  },

  schedule:{
    cron:"Sun 02:00",                // dÃ¼ÅŸÃ¼k trafik
    maxConcurrent:1,
    autoSkipOnIncident:true
  },

  blastRadius:{
    trafficMaxPct: 25,
    tenants:["sandbox","internal"],
    blockWrites:"on_degrade|never|always"
  },

  guards:{
    freezeOnIncident:true,
    abortOnSloBreach:true,
    costBudgetUsdMaxPerHour: 100
  },

  syntheticLoad:{
    enabled:true, rps:120, pattern:"steady",
    headers:{"x-drill":"true"}
  },

  integrations:{
    mrf:"LIVIA-49",
    slo:"LIVIA-32",
    cost:"LIVIA-34",
    incidents:"LIVIA-15",
    lineage:"LIVIA-39",
    provenance:"LIVIA-38",
    audit:"LIVIA-48",
    flags_mesh_gateway:"LIVIA-35",
    dq:"LIVIA-41",
    fsync:"LIVIA-46"
  },

  reporting:{
    outputDir:"data/drills/{YYYY-MM-DD}/{scenarioId}",
    mdFile:"report.md", htmlFile:"report.html",
    html:{ embedMiniCSS:true, chartsInlineSvg:true },
    include:{ timelines:true, rto_rpo:true, chaos_timeline:true, findings:true }
  },

  rbacViews:{ observer:{ hideTargets:true, showOnlySummary:true } },

  idempotencyTtlSec: 86400
}

5) Puanlama (Scoring) & DoÄŸrulama

RTO: hedefe gÃ¶re puan: score_RTO = clamp(0,30, 30 * (target / observed)).

RPO: score_RPO = clamp(0,30, 30 * (target / (observed+Îµ))), data loss >0 ise keskin dÃ¼ÅŸÃ¼ÅŸ.

Runbook Otomasyon: manuel adÄ±m sayÄ±sÄ± azaldÄ±kÃ§a puan â†‘ (0â€“12).

Observability: eksiksiz saÄŸlÄ±k/lag/route grafikleri (0â€“10).

Automation/Idempotency: otomatik rollback/abort dÃ¼zgÃ¼n iÅŸlediyse (0â€“10).

Seviye: green â‰¥ 85, yellow 70â€“84, red < 70.

6) Pipeline (Kompozisyon)

Plan: drill.request veya cron â†’ katalogdan ÅŸablon + paramlar â†’ drill.plan.ready

Guard/Gate: L15 aktif incident? L32/L34 bÃ¼tÃ§e/SLO uygun mu? RBAC? â†’ drill.guard.snapshot

Prewarm: GSLB TTL â†“, ikincil bÃ¶lge Ä±sÄ±tma, synthetic load baÅŸlat

Inject: chaos aracÄ±yla hedef hata (region shutdown, DNS kesintisi, DB kill switch, broker throttle)

Failover: L49 planÄ±nÄ± Ã§aÄŸÄ±r; trafik adÄ±mlarÄ±, lease/fence, RO/lock modlarÄ±

Stabilize/Verify: p95/err/RPO Ã¶lÃ§; fsync (L46) ile data tutarlÄ±lÄ±ÄŸÄ±; 0 data loss hedefi

Failback: dÃ¼ÅŸÃ¼k trafik penceresinde geri dÃ¶nÃ¼ÅŸ

Score & Findings: puanla, bulgularÄ± Ã§Ä±kar; remediation planÄ± yaz

Report & Emit: md/html rapor + card/alert/metrics; L48 audit paketine ekle

Lineage/Provenance: koÅŸunun tÃ¼m adÄ±mlarÄ±nÄ± L39/L38â€™e baÄŸla

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (drill.request|cron) â†’ PLAN

PLAN â†’ GUARD

GUARD â†’ (ok) PREWARM | (abort) DONE

PREWARM â†’ INJECT â†’ EXECUTE_FAILOVER â†’ STABILIZE_VERIFY â†’ FAILBACK â†’ SCORE â†’ REPORT â†’ DONE

Ara olaylar: cancel.request â†’ ABORT; gerÃ§ek incident.started â†’ FREEZE/ABORT

Hata: ALERT + mevcut aÅŸamada rollback/cleanup; idem: aynÄ± drillKey tekrarÄ± yan etkisiz

8) Kenar Durumlar

GerÃ§ek olay Ã§akÄ±ÅŸmasÄ±: freezeOnIncident=true â†’ drill durur (FREEZE), hiÃ§bir rota deÄŸiÅŸikliÄŸi yapÄ±lmaz

Kaos baÅŸarÄ±sÄ±z: chaos.inject.result.success=false â†’ drill abort + finding

SLO ani yÃ¼kseliÅŸ: abortOnSloBreach=true â†’ otomatik rollback (trafik baselineâ€™a)

RPO riski: replika lag > hedef â†’ write block + fence ve verify sonra devam

Maliyet artÄ±ÅŸÄ±: cost.guard.triggered â†’ synthetic load dÃ¼ÅŸÃ¼r/ durdur; adÄ±m geciktir

DNS cache etkisi: TTL dÃ¼ÅŸse bile yayÄ±lma gecikirse mesh/gateway override kullan

Fsync mismatch: L46 uyarÄ±sÄ± â†’ partial durum ve zorunlu remediation

Observer gÃ¶rÃ¼nÃ¼mÃ¼: hedef IP/host bilgileri gizlenir; yalnÄ±z Ã¶zet metrik/kronoloji

Idempotency: aÅŸama tekrarÄ± yalnÄ±z kart/metrik gÃ¼nceller; ikinci yan etki yok

9) Telemetri
{
  "drill.metrics": {
    "event":"drill.metrics","timestamp":"iso8601",
    "drills":1,"passes":1,"fails":0,"aborts":0,
    "avgRTOsec":278,"avgRPOsec":14,"dataLossBytes":0,
    "p50PlanMs":8,"p95PlanMs":24,"p95StageMs":3200
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/disasterRecoveryDrills.ts          # FSM + orchestrator
services/livia/lib/drill/catalog.ts               # senaryo ÅŸablonlarÄ±
services/livia/lib/drill/guard.ts                 # SLO/Cost/Incident/RBAC kapÄ±larÄ±
services/livia/lib/drill/inject.ts                # chaos araÃ§ kÃ¶prÃ¼leri
services/livia/lib/drill/execute.ts               # L49 failover tetikÃ§isi
services/livia/lib/drill/verify.ts                # RTO/RPO, fsync, data loss=0
services/livia/lib/drill/score.ts                 # puanlama & bulgu Ã¼retimi
services/livia/lib/drill/report.ts                # md/html + grafik (inline SVG)
services/livia/lib/bridges.ts                     # L15/L22/L26/L32/L34/L35/L38/L39/L46/L48/L49
services/livia/state/drillStore.ts                # idem index + koÅŸu geÃ§miÅŸi
services/livia/__tests__/disasterRecoveryDrills.test.ts
cfg/livia.drill.yaml

11) Test Ä°skeleti (Jest/Vitest)

Plan & Guard: aktif incident varken abort; normalde prewarmâ€™a geÃ§iÅŸ

Inject: region blackout kaosu baÅŸarÄ±yla uygulandÄ± â†’ chaos.inject.result.success=true

Failover: L49 adÄ±mlarÄ± Ã§aÄŸrÄ±ldÄ±; trafik 20â†’80â†’100 uygulandÄ±

Verify: RTO â‰¤ 300s, RPO â‰¤ 30s, data loss 0 â†’ pass

Partial: fsync mismatch â†’ partial + remediation maddesi Ã¼retildi

SLO breach: p95>500ms â†’ otomatik rollback, kart error

Idempotency: aynÄ± drillKey tekrarÄ± yan etkisiz

Report: md/html Ã§Ä±ktÄ±; L48 audit paketine dahil

Observer gÃ¶rÃ¼nÃ¼mÃ¼: gizli alanlar sÄ±zdÄ±rÄ±lmadÄ± (testte kontrol)

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

01:55 PLAN/GUARD: aktif incident yok; SLO & cost bÃ¼tÃ§esi uygun

02:00 PREWARM: US Ä±sÄ±tÄ±ldÄ±, DNS TTL 10s, synthetic 120 rps

02:05 INJECT: EU blackout (chaosmesh) 90s

02:06 EXECUTE_FAILOVER: trafik 20â†’80, EU DB RO, lease US OK

02:12 STABILIZE_VERIFY: p95 118ms, err 0.7%, RPO 14s, data loss 0 â†’ PASS

02:20 FAILBACK: dÃ¼ÅŸÃ¼k trafik penceresiyle EUâ€™ya dÃ¶nÃ¼ÅŸ

02:25 SCORE/REPORT: 92/100, 2 bulgu, 2 remediation; kart & rapor; L48â€™e eklendi.

13) SLO

p95 plan < 30 ms

RTO gÃ¶zlenen â‰¤ 300 s, RPO gÃ¶zlenen â‰¤ 30 s

data loss = 0 hedef

yanlÄ±ÅŸ abort/promote â‰¤ %1

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-51 Â· releaseFreezeController.ts â€” GeniÅŸ Prompt v3.1 (+ Policy DSL, SimÃ¼lasyon, Ek UygulayÄ±cÄ±lar)

AmaÃ§:
Ãœretimde riskli dÃ¶nemlerde release/konfig deÄŸiÅŸikliklerini otomatik freeze (dondur) / thaw (Ã§Ã¶z) etmek; kapsamÄ± app release, infra IaC, feature flag, model publish/canary, schema migration, policy/config. Tetikler: Incident (L15), SLO (L32), Cost (L34), Multi-Region Failover (L49), DR Drills (L50), Audit pencereleri (L48), Takvim (blackout).
GÃ¼vence: RBAC + Ã§oklu onay + istisna akÄ±ÅŸÄ±, timeboxed, idempotent, WORM/Provenance (L38), Lineage (L39), gÃ¶zlemlenebilirlik.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul.

1) Standartlar

Runtime: Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: ops|release|policy tam yetki; observer salt okur

Gizlilik: PII yok; metinler L21 ile redakte

Ä°dempotency: freezeKey = scope + kind + reason + windowISO

Observability: spans (freeze.evaluate|apply|extend|lift|simulate) + metrics

Uyum: dondurma/Ã§Ã¶zme/istisna kararlarÄ± L26 (Ethics) ve L38 (WORM) kaydÄ±

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "freeze.policy.updated": {
    "event":"freeze.policy.updated","timestamp":"iso8601",
    "policyId":"rel-freeze-v1",
    "rules":[
      {
        "when":"incident.severity>=high",
        "scope":"global|service|tenant|namespace",
        "kind":["app_release","infra_iac","feature_flag","model_publish","schema_migration","policy_change"],
        "ttlMin":180,
        "requiresApprovals":["policy-lead"],
        "exceptions":["hotfix:sev1","security:critical_patch"]
      },
      {
        "when":"slo.burnPct>5 OR cost.guard=hard",
        "scope":"service",
        "kind":["app_release","feature_flag","model_publish"],
        "ttlMin":60
      }
    ]
  },

  "incident.started|incident.closed": {
    "event":"incident.started","timestamp":"iso8601",
    "id":"inc-2025-09-15-1","severity":"high","scope":"service:kb_api","title":"EU latency spike"
  },

  "slo.guard.triggered|slo.guard.recovered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"latency_p95","burnPct":7.2,"severity":"high"
  },

  "cost.guard.triggered|cost.guard.recovered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "component":"search_stack","severity":"high","deltaUSDPerHour":42.5
  },

  "mrf.state.update": {
    "event":"mrf.state.update","timestamp":"iso8601",
    "phase":"execute|stabilize|failback","fromRegion":"eu-central","toRegion":"us-east"
  },

  "drill.started|drill.ended": {
    "event":"drill.started","timestamp":"iso8601",
    "scenarioId":"region-blackout-eu","env":"prod","blastRadius":{"trafficMaxPct":25}
  },

  "schema.migration.classified": {
    "event":"schema.migration.classified","timestamp":"iso8601",
    "datasetId":"ds:orders","classification":"breaking|additive|mixed","windowMin":90
  },

  "audit.window.opened|audit.window.closed": {
    "event":"audit.window.opened","timestamp":"iso8601",
    "profile":"kvkk|gdpr|soc2|iso27001","strict":true
  },

  "calendar.blackout.added|calendar.blackout.removed": {
    "event":"calendar.blackout.added","timestamp":"iso8601",
    "name":"yÄ±lbaÅŸÄ±-yoÄŸun","from":"2025-12-30","to":"2026-01-03",
    "kinds":["app_release","model_publish"],"scopes":["global"]
  },

  "freeze.override.request": {
    "event":"freeze.override.request","timestamp":"iso8601",
    "action":"allow_single|extend|lift_now",
    "kind":"app_release|infra_iac|feature_flag|model_publish|schema_migration|policy_change",
    "scope":"global|service:kb_api|tenant:t1|namespace:kb_default",
    "reason":"hotfix|security|policy|manual",
    "requester":"op#7f9a12",
    "changeRef":{"repo":"app/web","branch":"hotfix/latency","pr":"#1241"},
    "approvals":["policy-lead?","sre-lead?"]
  },

  "change.attempted": {
    "event":"change.attempted","timestamp":"iso8601",
    "kind":"app_release|infra_iac|feature_flag|model_publish|schema_migration|policy_change",
    "scope":"service:kb_api",
    "ref":{"repo":"app/web","branch":"main","pr":"#1242","env":"prod","flagId":"kb.hybridSearch.v2?"},
    "actor":"ci#github-actions"
  },

  "override.approval.updated": {
    "event":"override.approval.updated","timestamp":"iso8601",
    "reqId":"ovr#7f9a12","approvedBy":"policy-lead|sre-lead","state":"approved|rejected"
  },

  "release.window.request": {
    "event":"release.window.request","timestamp":"iso8601",
    "scope":"service:kb_api","kind":["app_release","model_publish"],
    "from":"iso8601","to":"iso8601","mode":"freeze|thaw","reason":"promo|maintenance"
  },

  "freeze.policy.simulate.request": {
    "event":"freeze.policy.simulate.request","timestamp":"iso8601",
    "inputs":["incident.severity=high","slo.burnPct=7.2","mrf.phase=execute"],
    "scope":"service:kb_api","kinds":["app_release","feature_flag"]
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "freeze.state.changed": {
    "event":"freeze.state.changed","timestamp":"iso8601",
    "state":"frozen|partially_frozen|thawed",
    "scope":"global|service|tenant|namespace",
    "kind":["app_release","feature_flag","model_publish","infra_iac","schema_migration","policy_change"],
    "reason":"incident|slo|cost|mrf|drill|audit|calendar|manual",
    "until":"iso8601",
    "policyId":"rel-freeze-v1","hash":"sha256:..."
  },

  "freeze.violation.detected": {
    "event":"freeze.violation.detected","timestamp":"iso8601",
    "kind":"app_release","scope":"service:kb_api",
    "changeRef":{"repo":"app/web","pr":"#1242"},
    "action":"blocked|quarantined|allowed_via_exception",
    "rationale":"missing_approval|out_of_window|kind_blocked"
  },

  "freeze.exception.granted": {
    "event":"freeze.exception.granted","timestamp":"iso8601",
    "kind":"hotfix","scope":"service:kb_api",
    "approvedBy":["policy-lead","sre-lead"],
    "validUntil":"iso8601","changeRef":{"repo":"app/web","pr":"#1241"}
  },

  "freeze.policy.ready": {
    "event":"freeze.policy.ready","timestamp":"iso8601",
    "policyId":"rel-freeze-v1","rulesApplied":2,"calendarApplied":1
  },

  "freeze.report.ready": {
    "event":"freeze.report.ready","timestamp":"iso8601",
    "path":"data/freeze/2025-09-15/service_kb_api/report.md",
    "summary":"SLO burn yÃ¼ksek â†’ service freeze (app_release/flag/model); 2 ihlal bloklandÄ±; 1 hotfix istisnasÄ± onaylandÄ±.",
    "hash":"sha256:..."
  },

  "freeze.card": {
    "event":"freeze.card","timestamp":"iso8601",
    "title":"RELEASE FREEZE â€” service:kb_api (SLO burn 7.2%)",
    "body":"Kind: app_release, feature_flag, model_publish â€¢ Until: 15:30 â€¢ Override: 2 onay gerek.",
    "severity":"warn","ttlSec":900
  },

  "freeze.alert": {
    "event":"freeze.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|rbac_denied|missing_approval|policy_conflict|apply_failed|violation_blocked|calendar_overlap"
  },

  "freeze.metrics": {
    "event":"freeze.metrics","timestamp":"iso8601",
    "activeWindows":2,"violationsBlocked":3,"exceptionsGranted":1,
    "avgApplyMs":18,"avgLiftMs":12,"autoLifted":4
  },

  "freeze.simulate.result": {
    "event":"freeze.simulate.result","timestamp":"iso8601",
    "scope":"service:kb_api","kinds":["app_release","feature_flag"],
    "result":"would_freeze","ttlMin":90,"ruleId":"R-slo-001"
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  kinds:["app_release","infra_iac","feature_flag","model_publish","schema_migration","policy_change"],

  defaultTTLs:{
    incident:{ high:240, medium:120, low:60 },
    slo:{ high:90, medium:45, low:20 },
    cost:{ high:60, medium:30 },
    mrf:{ execute:180, stabilize:120, failback:90 },
    drill:{ running:120 },
    audit:{ strict:240 },
    calendar:{ default:1440 }
  },

  scopes:{
    precedence:["namespace","tenant","service","global"],
    mergeStrategy:"most_restrictive_wins"
  },

  approvals:{
    required:{
      app_release:["sre-lead"],
      infra_iac:["platform-lead"],
      model_publish:["mlops-lead","policy-lead"],
      schema_migration:["data-lead","policy-lead"]
    },
    quorum:{ min:2, rolesAnyOf:[["sre-lead","policy-lead","security-lead"]] },
    hotfixOverrides:{ minApprovals:2, roles:["sre-lead","policy-lead"] },
    expiryMin:60
  },

  enforcement:{
    cicd:{ blockPipelines:true, providers:["github","gitlab","jenkins"], branchProtection:true },
    registry:{ npmPublish:true, dockerPush:true },
    k8s:{ admissionWebhook:true, namespaces:["prod","infra"] },
    flags:{ providers:["launchdarkly|unleash|configcat"], namespaces:["prod_flags"], mode:"block_non_hotfix" },
    canary:{ via:"LIVIA-45", blockStart:true },
    retrain:{ via:"LIVIA-44", holdPublish:true },
    schema:{ via:"LIVIA-42", requireWindow:true },
    mrf:{ via:"LIVIA-49", freezeDuringFailover:true }
  },

  calendar:{
    holidays:["01-01","04-23","05-01","05-19","07-15","08-30","10-29"],
    blackoutWindows:[]
  },

  policyDSL:{
    // basit ifade grameri
    ops:["AND","OR","NOT"],
    fields:["incident.severity","slo.burnPct","cost.guard","mrf.phase","drill.active","audit.strict"],
    comparators:[">",">=","<","<=","=","in","matches"],
    examples:[
      "incident.severity>=high",
      "slo.burnPct>5 AND NOT drill.active",
      "mrf.phase in ['execute','stabilize']"
    ]
  },

  reporting:{
    outputDir:"data/freeze/{YYYY-MM-DD}/{scope}",
    mdFile:"report.md", htmlFile:"report.html",
    html:{ embedMiniCSS:true },
    include:{ timeline:true, violations:true, exceptions:true }
  },

  rbacViews:{ observer:{ showTimeline:true, hideChangeRefs:true } },

  idempotencyTtlSec: 3600
}

5) Kurallar & DeÄŸerlendirme

Tetikler â†’ Kapsam/Kind/TTL: olay tÃ¼rÃ¼/ÅŸiddet/alan â†’ kapsam (varsa dar: service:â€¦), kind (haritalÄ±), TTL (policy + default).

Merge: birden Ã§ok kural Ã§akÄ±ÅŸÄ±rsa en kÄ±sÄ±tlayÄ±cÄ± kazanÄ±r (most_restrictive_wins).

Override/Ä°stisna: freeze.override.request â†’ RBAC + Ã§oklu onay/quorum + sÃ¼reli izin (validUntil).

Ä°hlal Yakalama: change.attempted â†’ cicd/k8s/flag/model/schema yollarÄ±nda blok/karantina/istisna ile izin.

Histerezis: slo.guard.recovered iki ardÄ±ÅŸÄ±k pencerede gelmedikÃ§e auto-lift yapma.

Takvim: blackout + baÅŸka tetik Ã§akÄ±ÅŸÄ±rsa uzun TTL uygulanÄ±r; rapora calendar_overlap.

6) Pipeline (Kompozisyon)

Evaluate: tetik/istek â†’ Policy DSL ile eÅŸleÅŸtir â†’ kapsam/kind/TTL hesapla.

Apply: uygulayÄ±cÄ±lar (CI/CD, registry, k8s admission, flag provider, canary/retrain/schema/mrf kÃ¶prÃ¼leri).

Notify & Record: freeze.state.changed + card/alert/metrics; WORM append + lineage.

Monitor: recovered/closed + ttl â†’ auto-lift; extend talepleri â†’ TTL gÃ¼ncelle.

Override Flow: onaylar tamamlanÄ±rsa exception.granted; deÄŸilse violation.detected.

SimÃ¼lasyon: freeze.policy.simulate.request â†’ yan etki olmadan karar hesapla â†’ simulate.result.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (policy/trigger/calendar) â†’ EVALUATE

EVALUATE â†’ APPLY â†’ ACTIVE

ACTIVE â†’ (override.request) REVIEW | (recovered|ttl) LIFT

REVIEW â†’ (approved) EXCEPTION â†’ ACTIVE | (rejected) ACTIVE

LIFT â†’ freeze.state.changed(state='thawed') â†’ IDLE

Hata: ALERT; idem: aynÄ± freezeKey tekrarÄ±nda yan etki yok (yalnÄ±z kart/metrik gÃ¼ncellenir)

8) Kenar Durumlar

Policy Ã§atÄ±ÅŸmasÄ±: servis+global Ã§akÄ±ÅŸtÄ± â†’ most_restrictive_wins; freeze.alert(policy_conflict)

False-positive SLO: kÄ±sa sÃ¼reli spike â†’ histerezis nedeniyle thaw yok

MRF failover: freezeDuringFailover=true â†’ canary/release tamamen blok

Schema â€œadditiveâ€: yalnÄ±z app_release sÄ±nÄ±rlanÄ±r; migration serbest (policyâ€™ye baÄŸlÄ±)

Audit strict: audit.window.opened(strict) â†’ policy_change dahil blok; yalnÄ±z security hotfix istisna

Observer: PR/branch/flag kimlikleri gizli; yalnÄ±z Ã¶zet gÃ¶rÃ¼nÃ¼r

Idempotency: aynÄ± tetik iÃ§in ikinci APPLY yan etki yapmaz; yalnÄ±z TTL/karte gÃ¼ncellenir

9) Telemetri
{
  "freeze.metrics": {
    "event":"freeze.metrics","timestamp":"iso8601",
    "activeWindows":2,"violationsBlocked":3,"exceptionsGranted":1,
    "p50ApplyMs":7,"avgApplyMs":18,"avgLiftMs":12,
    "autoLifted":4,"policyConflicts":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/releaseFreezeController.ts
services/livia/lib/freeze/policy.ts           # Policy DSL yorumlayÄ±cÄ±, TTL/merge
services/livia/lib/freeze/enforce.ts          # CI/CD, registry, k8s, flags, canary, retrain, schema, mrf kÃ¶prÃ¼leri
services/livia/lib/freeze/override.ts         # Onay akÄ±ÅŸÄ±, quorum, istisna yÃ¶netimi
services/livia/lib/freeze/report.ts           # md/html rapor + timeline
services/livia/lib/freeze/simulate.ts         # Yan etkisiz politika simÃ¼lasyonu
services/livia/lib/bridges.ts                 # L15/L22/L26/L32/L34/L38/L39/L42/L44/L45/L48/L49/L50
services/livia/state/freezeStore.ts           # idem index + aktif pencereler + override kayÄ±tlarÄ±
services/livia/__tests__/releaseFreezeController.test.ts
cfg/livia.freeze.yaml

11) Test Ä°skeleti (Jest/Vitest)

Incident high â†’ freeze: service bazlÄ± freeze, CI/CD & k8s admission blok, kart warn

SLO burn 7.2%: freeze â†’ recoveredÃ—2 sonrasÄ± auto-lift

Cost guard hard: model publish/flag blok; violation.detected kaydÄ±

MRF execute: global freeze; override reddi

Schema breaking: migration pencere zorlamasÄ±; pencere dÄ±ÅŸÄ± deneme blocked

Calendar blackout: yÄ±lbaÅŸÄ± aralÄ±ÄŸÄ±nda global app_release freeze

Override hotfix (quorum): 2 onay yok â†’ blok; 2 onayla exception.granted (tek seferlik)

Policy simulate: girdi seti â†’ simulate.result=would_freeze

Idempotency: aynÄ± freezeKey yinelemesi yan etkisiz

Rapor: md/html yazÄ±ldÄ±; L22 daÄŸÄ±tÄ±ldÄ±; L38/L48â€™e eklendi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

14:05 slo.guard.triggered(burn=7.2, service=kb_api) â†’ EVALUATE: kinds app_release|flag|model, TTL 90 dk

14:06 APPLY: CI/CD, k8s, flag publish blok; freeze.state.changed(frozen) + kart

14:20 PR #1241 iÃ§in override.request(hotfix) â†’ quorum 2 onay geldi â†’ exception.granted(validUntil 15:00)

15:02 slo.guard.recovered Ã—2 pencere â†’ LIFT â†’ rapor/metrics gÃ¼ncellendi.

13) SLO

Apply p95 < 30 ms

Auto-lift gecikmesi â‰¤ 60 s

YanlÄ±ÅŸ blok oranÄ± â‰¤ %1

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-52 Â· chaosExperimentDesigner.ts â€” GeniÅŸ Prompt v3 (+ GÃ¼venli Limitler, Oto-Analiz, GameDay)

AmaÃ§:
Ãœretim/staging ortamlarÄ±nda parametrik kaos deneylerini gÃ¼venli biÃ§imde tasarla â†’ planla â†’ enjekte et â†’ gÃ¶zlemle â†’ deÄŸerlendir â†’ bulgu & iyileÅŸtirme Ã¶ner. Hedef: dayanÄ±klÄ±lÄ±k (resilience) zayÄ±flÄ±klarÄ±nÄ± erken bulup SLO (L32), Maliyet (L34), Release Freeze (L51), Failover (L49), DR Drills (L50) ve Audit (L48) ile entegre kanÄ±tlanabilir geliÅŸtirme saÄŸlamak.
AraÃ§ kÃ¶prÃ¼leri: Chaos Mesh / Litmus / Gremlin / AWS FIS / Toxiproxy / tc-netem / iptables / k8s fault-injection.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: resilience|ops|policy tam; observer salt okur

Gizlilik: PII yok; serbest metinler L21 ile redakte

Ä°dempotency: expKey = scenarioId + target + windowISO + seed + stageHash

Observability: spans (chaos.plan,chaos.guard,chaos.inject,chaos.observe,chaos.score,chaos.report) + metrics

Uyumluluk: kritik adÄ±mlar L26 etik / L38 WORM append; deÄŸiÅŸimler L39 lineageâ€™a baÄŸlanÄ±r

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "chaos.catalog.registered": {
    "event":"chaos.catalog.registered","timestamp":"iso8601",
    "scenarioId":"net-latency-eu-api",
    "title":"EU API net gecikme 300ms Â±50ms jitter",
    "targets":{"serviceIds":["kb_api"],"regions":["eu-central"]},
    "stages":[
      {"name":"ramp_up","durationSec":300,"params":{"latencyMs":150,"jitterMs":20,"lossPct":0}},
      {"name":"steady","durationSec":600,"params":{"latencyMs":300,"jitterMs":50,"lossPct":0}},
      {"name":"ramp_down","durationSec":300,"params":{"latencyMs":150,"jitterMs":20,"lossPct":0}}
    ],
    "tools":["chaosmesh","tc-netem"],
    "blastRadius":{"trafficMaxPct":15,"tenants":["sandbox","internal"]},
    "expected":{"p95MsDeltaMax":+200,"errPctMaxDelta":+0.5}
  },

  "chaos.request": {
    "event":"chaos.request","timestamp":"iso8601",
    "scenarioId":"net-latency-eu-api",
    "env":"prod|staging",
    "schedule":{"at":"2025-09-16T03:00:00+03:00","windowMin":30},
    "seed":42,
    "syntheticLoad":{"enabled":true,"rps":80,"pattern":"steady|bursty"},
    "safety":{"abortOnSloBreach":true,"abortOnCostHard":true},
    "notes":"geceleri dÃ¼ÅŸÃ¼k trafik"
  },

  "chaos.template.request": {
    "event":"chaos.template.request","timestamp":"iso8601",
    "kind":"network|cpu|memory|disk|io|dns|broker|db|fs|featurestore|time_skew|rate_limit|pod_kill",
    "severity":"low|medium|high",
    "durationMin":20,
    "targets":{"serviceIds":["kb_api"],"regions":["eu-central"]},
    "constraints":{"p95MsMax":400,"errPctMax":2.0}
  },

  "chaos.override.request": {
    "event":"chaos.override.request","timestamp":"iso8601",
    "action":"pause|resume|abort|extend",
    "reason":"manual|incident|policy|ethics","by":"op#7f9a12"
  },

  "release.freeze.state": {
    "event":"release.freeze.state","timestamp":"iso8601",
    "state":"frozen|thawed","scope":"service:kb_api","reason":"slo|mrf|drill|calendar"
  },

  "slo.guard.triggered|slo.guard.recovered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"latency_p95|error_rate","burnPct":6.1,"severity":"high"
  },

  "cost.guard.triggered|cost.guard.recovered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "component":"inference|search_stack","severity":"high","deltaUSDPerHour":35.2
  },

  "mrf.state.update": {
    "event":"mrf.state.update","timestamp":"iso8601",
    "phase":"execute|stabilize","fromRegion":"eu-central","toRegion":"us-east"
  }
}


HazÄ±r Template TÃ¼rleri (Ã¶neri):

network: latency/jitter/loss/dup/reorder; toxi/netem

cpu/memory/disk/io: k8s stress-ng; cgroup limit; io-throttle

dns: dns-outage/slow-resolver

broker: Kafka partition offline/URPâ†‘, throttle

db: primary kill / connection pool limit / read-only fence

featurestore: online lagâ†‘ (L46), TTL expirations

rate_limit: gateway 429 enjektesi

time_skew: NTP drift (sadece staging)

pod_kill: controlled chaos (termination, eviction)

3) Ã‡Ä±ktÄ±lar (Out)
{
  "chaos.plan.ready": {
    "event":"chaos.plan.ready","timestamp":"iso8601",
    "expKey":"net-latency-eu-api#kb_api#2025-09-16T03:00+03:00#seed42",
    "scenarioId":"net-latency-eu-api","env":"prod",
    "stages":["ramp_up","steady","ramp_down"],
    "tools":["chaosmesh","tc-netem"],
    "blastRadius":{"trafficMaxPct":15,"tenants":["sandbox","internal"]},
    "guards":{"abortOnSloBreach":true,"abortOnCostHard":true,"freezeCheck":true},
    "expectedImpact":{"p95MsDeltaMax":200,"errPctMaxDelta":0.5},
    "hash":"sha256:..."
  },

  "chaos.guard.snapshot": {
    "event":"chaos.guard.snapshot","timestamp":"iso8601",
    "status":"ok|at_risk|abort",
    "checks":{"releaseFreeze":"thawed","activeIncident":false,"rbac":true,"sloBudgetOk":true,"costBudgetOk":true,"blastRadiusOk":true}
  },

  "chaos.inject.started": {
    "event":"chaos.inject.started","timestamp":"iso8601",
    "stage":"steady","tool":"chaosmesh|tc-netem","targets":["kb_api@eu-central"],
    "params":{"latencyMs":300,"jitterMs":50,"lossPct":0}
  },

  "chaos.health.snapshot": {
    "event":"chaos.health.snapshot","timestamp":"iso8601",
    "window":"5m",
    "app":{"p95Ms":342,"errPct":1.3,"availPct":99.7,"sloBurnPct":2.2},
    "deps":{"dbLagSec":12,"brokerURP":0,"fsLagMsP95":160},
    "status":"ok|at_risk|breach","reason":"slo|cost|guardrail"
  },

  "chaos.inject.completed": {
    "event":"chaos.inject.completed","timestamp":"iso8601",
    "stage":"steady","success":true,"durationSec":600
  },

  "chaos.findings.ready": {
    "event":"chaos.findings.ready","timestamp":"iso8601",
    "items":[
      {"severity":"high","title":"Retry fÄ±rtÄ±nasÄ± p95â€™i 180ms artÄ±rdÄ±","evidence":"latency spike + error_rateâ†‘","component":"kb_api","suggestion":"exponential backoff jitter + circuit breaker threshold ayarÄ±"},
      {"severity":"medium","title":"FeatureStore lag p95 220ms","evidence":"fsLagMsP95>threshold","component":"fsync","suggestion":"cache warm + nodelocal read"}
    ]
  },

  "chaos.remediation.plan.ready": {
    "event":"chaos.remediation.plan.ready","timestamp":"iso8601",
    "tasks":[
      {"id":"rem-1","owner":"platform","desc":"Gateway rate-limit adaptif (token bucket)","etaDays":5},
      {"id":"rem-2","owner":"search","desc":"Reranker p95 limitte degrade policy","etaDays":3}
    ]
  },

  "chaos.report.ready": {
    "event":"chaos.report.ready","timestamp":"iso8601",
    "path":"data/chaos/2025-09-16/net-latency-eu-api/report.md",
    "summary":"p95 +214ms (OK sÄ±nÄ±r iÃ§inde), err +0.6pp, SLO burn 2.2% â€¢ 2 bulgu, 2 remediation.",
    "hash":"sha256:..."
  },

  "chaos.card": {
    "event":"chaos.card","timestamp":"iso8601",
    "title":"Chaos Net Latency (EU) â€” steady aÅŸama",
    "body":"p95 342ms â€¢ err 1.3% â€¢ SLO burn 2.2% â€¢ ilerleme %60.",
    "severity":"info","ttlSec":600
  },

  "chaos.alert": {
    "event":"chaos.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"abort_due_to_slo|abort_due_to_cost|rbac_denied|tool_failed|idem_duplicate|freeze_active|blast_radius_too_wide"
  },

  "chaos.metrics": {
    "event":"chaos.metrics","timestamp":"iso8601",
    "experiments":1,"passes":1,"aborts":0,
    "avgStageStartMs":420,"p95ObserveMs":9.2,
    "sloBreaches":0,"costHardBlocks":0,"blastRadiusViolations":0
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  safety:{
    freezeCheck:true,                   // L51: aktif freeze varsa koÅŸma
    abortOnSloBreach:true,
    abortOnCostHard:true,
    maxBlastTrafficPct: 20,
    tenantsAllowlist:["sandbox","internal"],
    businessHours:{ start:"09:00", end:"18:00", allowRun:false },
    chaosBudgetMinPerWeek: 120,         // toplam dakika Ã¼st sÄ±nÄ±rÄ±
    killSwitchFlag:"flags:chaos.killswitch"
  },

  sampling:{
    rampSchedule:"0â†’25â†’50â†’75â†’100",      // aÅŸamalÄ± etki
    window:"5m",                         // health snapshot penceresi
    minStableWindows:2
  },

  templates:{
    network:{ defaultLatencyMs:200, jitterMs:30, lossPct:0 },
    cpu:{ coresPct:80, durationSec:600 },
    memory:{ pct:60, leak:true },
    disk:{ iopsLimit:500, fioProfile:"randread" },
    dns:{ rcode:"SERVFAIL", delayMs:200 },
    broker:{ urpAdd:5, throttleMBps:10 },
    db:{ mode:"primary_kill|ro_fence|slow_queries" },
    fs:{ lagP95Ms:300, ttlExpireKeysPct:1.0 },
    rate_limit:{ http429Pct:10 },
    time_skew:{ offsetSec:120 },
    pod_kill:{ replicasPct:10 }
  },

  integrations:{
    freeze:"LIVIA-51",
    slo:"LIVIA-32",
    cost:"LIVIA-34",
    fsync:"LIVIA-46",
    mrf:"LIVIA-49",
    drills:"LIVIA-50",
    audit:"LIVIA-48",
    provenance:"LIVIA-38",
    lineage:"LIVIA-39",
    dist:"LIVIA-22"
  },

  reporting:{
    outputDir:"data/chaos/{YYYY-MM-DD}/{scenarioId}",
    mdFile:"report.md", htmlFile:"report.html",
    html:{ embedMiniCSS:true, chartsInlineSvg:true },
    include:{ timelines:true, slo_burn:true, deps_lag:true, findings:true }
  },

  rbacViews:{ observer:{ hideTargets:true, showOnlySummary:true } },

  idempotencyTtlSec: 3600
}

5) Deney TÃ¼rleri & Ã–lÃ§Ã¼mler (Ã¶zet)

Uygulama: p95 latency, error rate, availability, SLO burn, throughput.

BaÄŸÄ±mlÄ±lÄ±klar: DB lag/conns, broker URP, feature store lag/TTL, DNS latency/rcode.

Kaynaklar: CPU/memory/disk/IO; throttle/shed davranÄ±ÅŸÄ±; throttle sonrasÄ± degrade policy.

DavranÄ±ÅŸ: retry fÄ±rtÄ±nasÄ±, circuit breaker, backoff jitter, timeout bÃ¼tÃ§esi doÄŸrulamasÄ±.

Maliyet: deney baÅŸÄ±na ek $ etkisi (trafik + reranker/model maliyeti).

6) Pipeline (Kompozisyon)

Plan: chaos.request veya template.request â†’ katalog & ÅŸablonlardan plan Ã¼ret; expKey ve ramp ÅŸemasÄ± hesapla

Guard: L51 freeze, L32 SLO, L34 cost, blast radius ve RBAC kontrolleri â†’ chaos.guard.snapshot

Inject: seÃ§ilen araÃ§la aÅŸamalarÄ± uygula (netem/toxi, stress-ng, FIS, Kafka throttle, FS lag, DNS fault)

Observe: her 5m pencerede health snapshot; SLO burn/cost ihlali â†’ auto abort

Score/Findings: sapmalarÄ± baz Ã§izgiye gÃ¶re analiz et; kÃ¶k neden ipuÃ§larÄ± (retry, queue depth, lag)

Remediate: gÃ¶rev listesi Ã§Ä±kar; L22 ile daÄŸÄ±t; L48 denetim paketine ekle

Report: md/html rapor + grafikleri yaz; card/alert/metrics yayÄ±mla

Link: tÃ¼m adÄ±mlar L38/L39â€™a append; L50 drill raporlarÄ±na referanslanabilir

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (chaos.request|template.request) â†’ PLAN

PLAN â†’ GUARD

GUARD â†’ (ok) INJECT | (abort) DONE

INJECT â†’ OBSERVE (ramp & steady pencereleri)

OBSERVE â†’ (ok) NEXT_STAGE|COMPLETE | (breach) ABORT

COMPLETE/ABORT â†’ SCORE â†’ REPORT â†’ EMIT â†’ IDLE

Hata: ALERT; idem: aynÄ± expKey yinelemesinde yan etki yok

8) Kenar Durumlar

Aktif Freeze: L51 state=frozen â†’ freeze_active ve ABORT (yan etki yok).

GerÃ§ek Incident: aktif incident.started â†’ ABORT ve tÃ¼m etkiler geri alÄ±nÄ±r.

Blast Radius ihlali: trafik veya tenant kapsamÄ± aÅŸarsa â†’ abort + alert.

AraÃ§ HatasÄ±: Chaos Mesh/FIS Ã§aÄŸrÄ±sÄ± baÅŸarÄ±sÄ±z â†’ yeniden dene (3Ã—) â†’ tool_failed.

Flaky SLO: tek pencere spike â†’ EWMA ile yumuÅŸat; 2 ardÄ±ÅŸÄ±k pencere olmadan abort yok.

Cost Hard Guard: maliyet sÄ±nÄ±rÄ± aÅŸÄ±ldÄ± â†’ ABORT + freeze Ã¶nerisi.

FeatureStore TutarsÄ±zlÄ±ÄŸÄ±: L46 lag/ttl fail â†’ deney partial ve zorunlu remediation.

Staging â€œtime_skewâ€: Ã¼retimde devre dÄ±ÅŸÄ±; yalnÄ±z staging.

Observer gÃ¶rÃ¼nÃ¼mÃ¼: hedeflerin kimlikleri gizli, yalnÄ±z Ã¶zet verilir.

Idempotency: aynÄ± expKey tekrarÄ±nda yalnÄ±z kart/metrik gÃ¼ncellenir.

9) Telemetri
{
  "chaos.metrics": {
    "event":"chaos.metrics","timestamp":"iso8601",
    "experiments":1,"passes":1,"aborts":0,
    "p50PlanMs":10,"avgStageStartMs":420,"p95ObserveMs":9.2,
    "sloBreaches":0,"costHardBlocks":0,"blastRadiusViolations":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/chaosExperimentDesigner.ts        # FSM + orchestrator
services/livia/lib/chaos/catalog.ts              # senaryo ÅŸablonlarÄ± & kayÄ±t
services/livia/lib/chaos/plan.ts                 # parametre â†’ plan/ramp Ã¼retimi
services/livia/lib/chaos/guard.ts                # L51/L32/L34/RBAC/blast radius kapÄ±larÄ±
services/livia/lib/chaos/inject.ts               # chaosmesh|litmus|gremlin|FIS|toxiproxy|netem kÃ¶prÃ¼leri
services/livia/lib/chaos/observe.ts              # health snapshots + EWMA + abort kurallarÄ±
services/livia/lib/chaos/score.ts                # sapma analizi & bulgu/Ã¶neri
services/livia/lib/chaos/report.ts               # md/html + grafik (inline SVG)
services/livia/lib/bridges.ts                    # L21/L22/L26/L32/L34/L38/L39/L46/L48/L49/L50/L51
services/livia/state/chaosStore.ts               # idem index + koÅŸu geÃ§miÅŸi + chaos budget
services/livia/__tests__/chaosExperimentDesigner.test.ts
cfg/livia.chaos.yaml

11) Test Ä°skeleti (Jest/Vitest)

Plan: templateâ€™ten plan Ã¼retildi; ramp 0â†’25â†’50â†’75â†’100

Guard: aktif freeze â†’ ABORT; normalde INJECT

Inject/Observe: steady aÅŸamada p95 +200ms, err +0.5pp â†’ ok (eÅŸikler iÃ§inde)

SLO breach: 2 ardÄ±ÅŸÄ±k pencere ihlal â†’ ABORT + alert

Cost hard: maliyet sÄ±nÄ±rÄ± aÅŸÄ±mÄ± â†’ ABORT + card error

Blast radius: tenant dÄ±ÅŸÄ± hedef â€” reject

Remediation: 2 bulgu + gÃ¶rev planÄ± Ã¼retildi

Idempotency: aynÄ± expKey yinelemesi yan etkisiz

Report: md/html yazÄ±ldÄ±; L22 daÄŸÄ±tÄ±ldÄ±; L38/L48â€™e eklendi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

02:55 PLAN/GUARD: freeze yok; SLO & cost bÃ¼tÃ§eleri uygun; blast radius â‰¤15%

03:00 INJECT: netem 150â†’300ms latency ramp; synthetic 80 rps

03:05 OBSERVE: p95 342ms, err 1.3%, SLO burn 2.2% (OK)

03:20 COMPLETE: SCORE + FINDINGS (retry jitter, FS lag) â†’ REMEDIATION (2 gÃ¶rev)

03:25 REPORT + kart/alert/metrics; L48 denetim paketine eklendi.

13) SLO

p95 plan < 30 ms

false abort â‰¤ %1; missed critical breach â‰¤ %1

chaos budget ihlali = 0

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-53 Â· costAnomalyGuard.ts â€” GeniÅŸ Prompt v3 (+ Otomatik Degrade/Throttle, SimÃ¼lasyon, BÃ¼tÃ§e KorumasÄ±)

AmaÃ§:
GerÃ§ek zamanlÄ± maliyet anomalilerini (ani sÄ±Ã§rama, sÃ¼rÃ¼nen artÄ±ÅŸ, konfig deÄŸiÅŸimi sonrasÄ± beklenmeyen yÃ¼k) tespit et â†’ teÅŸhis et â†’ aksiyon planÄ± uygula â†’ raporla. BileÅŸenler: model/inference, reranker, vektÃ¶r indeks/KB arama, feature store, veri aktarÄ±m/egress, depolama/I/O, broker, DB, genel bulut kaynaklarÄ±.
Uygulama adÄ±mlarÄ±: throttle/shed, degrade merdiveni (Ã¶r. topKâ†“, reranker off/ce-small, quant=int8, batchâ†‘, cacheâ†‘, precisionâ†“), ucuz profile yÃ¶nlendirme, A/B-canary (L45) ile kontrollÃ¼ geÃ§iÅŸ, geri alma (rollback).
Ä°yileÅŸtirme: sebep analizi (konfig, trafik, hata oranÄ±/retry, fiyat tablosu deÄŸiÅŸimi), tasarruf raporu ve Ã¶neriler.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.
Entegrasyonlar: SLO (L32), Cost yÃ¶netimi (L34), KB Tuning (L47), Freeze (L51), Chaos (L52), Audit (L48), Failover/DR (L49/L50), FSync (L46).

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: finance|ops|mlops|policy tam, observer salt okur

Gizlilik: PII yok; yalnÄ±z maliyet metrikleri; operatÃ¶r kimliÄŸi L21 ile hash

Ä°dempotency: costGuardKey = service + component + scope + windowISO + ruleId

Observability: spans (cost.collect,cost.detect,cost.rca,cost.decide,cost.apply,cost.report) + metrics

Uyum: tÃ¼m kararlar L26 etik + L38 WORM append; L39 lineage kenarlarÄ±

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "price.table.updated": {
    "event":"price.table.updated","timestamp":"iso8601",
    "provider":"openai|bedrock|vertex|faiss|redis|s3|kafka|pg",
    "items":[
      {"resource":"inference:gpt-xyz","unit":"1k_tokens","usd":0.9},
      {"resource":"kb:hnsw_mem","unit":"GB_hour","usd":0.018}
    ],
    "effectiveAt":"iso8601"
  },

  "budget.policy.updated": {
    "event":"budget.policy.updated","timestamp":"iso8601",
    "serviceId":"kb_api",
    "window":"1h|1d","currency":"USD",
    "limits":{
      "inference_usd_per_1k_req": 0.8,
      "search_stack_usd_per_1k_req": 0.5,
      "total_usd_per_hour": 60
    },
    "hardGuards":{"total_usd_per_hour": 80}
  },

  "cost.usage.sample": {
    "event":"cost.usage.sample","timestamp":"iso8601",
    "serviceId":"kb_api","component":"inference|search|fsync|broker|db|egress",
    "unitCost":{"name":"inference:gpt-xyz","qty":2.1,"usd":0.00189},
    "request":{"id":"req#7f9a12","variant":"A|B","profile":"tr"},
    "aux":{"topK":100,"reranker":"ce-large","dim":768,"quant":"fp32"}
  },

  "cost.usage.rollup": {
    "event":"cost.usage.rollup","timestamp":"iso8601",
    "serviceId":"kb_api","window":"5m",
    "per1kReq":{"inference":0.92,"search":0.41,"total":1.45},
    "perHourUSD":{"total":64.2,"inference":40.1,"search":18.6,"egress":5.5},
    "reqRateRps": 35.4
  },

  "config.change.applied": {
    "event":"config.change.applied","timestamp":"iso8601",
    "serviceId":"kb_api",
    "change":{"key":"kb.topK","from":50,"to":120},
    "by":"op#28c1","reason":"quality_uplift"
  },

  "kb.tuning.promoted": {
    "event":"kb.tuning.promoted","timestamp":"iso8601",
    "namespace":"kb_default","profile":"tr",
    "to":"cand#ivf-pq-384-nprobe16-k100-a0.2-rerank:none"
  },

  "slo.guard.triggered|slo.guard.recovered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"latency_p95","severity":"high"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "cost.guard.triggered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","component":"inference|search|egress|total",
    "window":"5m|1h","severity":"warn|high|critical",
    "signal":{"kind":"spike|drift|step_change|chg_point","value":1.45,"baseline":0.92,"upliftPct":"+57%"},
    "ruleId":"R-per1k-total>1.2","budget":{"limit":1.2,"hard":1.5},
    "rca":{"suspects":["kb.topKâ†‘","reranker:ce-large","A/B:B variant"],"confidence":0.71}
  },

  "cost.action.plan.ready": {
    "event":"cost.action.plan.ready","timestamp":"iso8601",
    "serviceId":"kb_api","component":"search",
    "ladder":[
      {"step":1,"action":"topKâ†“","to":60,"expectedSavePct":22},
      {"step":2,"action":"rerankerâ†’ce-small","expectedSavePct":11},
      {"step":3,"action":"hybridAlphaâ†’0.2","expectedSavePct":6},
      {"step":4,"action":"cache.ttlâ†‘","toSec":900,"expectedSavePct":5}
    ],
    "canary":{"trafficPct":10,"durationMin":15},
    "rollbackOn":{"slo_breach":true,"quality_drop_ndcg10_pct":-3.0}
  },

  "cost.action.applied": {
    "event":"cost.action.applied","timestamp":"iso8601",
    "serviceId":"kb_api","step":1,"action":"topKâ†“","to":60,
    "via":"LIVIA-35|LIVIA-47","status":"ok"
  },

  "cost.guard.recovered": {
    "event":"cost.guard.recovered","timestamp":"iso8601",
    "serviceId":"kb_api","component":"total",
    "window":"1h","afterActions":["topKâ†“","rerankerâ†’ce-small"],"recoveryDelayMin":22
  },

  "cost.savings.report.ready": {
    "event":"cost.savings.report.ready","timestamp":"iso8601",
    "path":"data/cost/2025-09-16/kb_api/report.md",
    "summary":"TopK 100â†’60 ve ce-small ile saatlik maliyet -%34; kalite (NDCG@10) -%1.2; p95 +12ms.",
    "hash":"sha256:..."
  },

  "cost.card": {
    "event":"cost.card","timestamp":"iso8601",
    "title":"Maliyet Guard â€” kb_api (total +57%/5m)",
    "body":"Ladder step#1 uygulandÄ± (topK 60). Canary %10/15dk.",
    "severity":"warn","ttlSec":600
  },

  "cost.alert": {
    "event":"cost.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"hard_guard_breach|price_table_change|dq_gap|idem_duplicate|rbac_denied|apply_failed|rollback|freeze_active"
  },

  "cost.metrics": {
    "event":"cost.metrics","timestamp":"iso8601",
    "detections":3,"actionsApplied":2,"rollbacks":0,
    "avgDetectMs":28,"p95DetectMs":65,
    "avgSavingsPct":26.4,"hoursToRecoverP50":0.4
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul", currency:"USD" },

  windows:{ detect:"5m", budget:"1h", report:"1d" },

  thresholds:{
    per1k:{ total:{ warn:1.2, high:1.4, critical:1.6 }, inference:{ warn:0.7, high:0.9 } },
    perHourUSD:{ total:{ warn:60, high:70, critical:80 } },
    changePoint:{ z:3.0, minConsecutive:2 },
    driftEWMA:{ alpha:0.2, warnPct:15, highPct:30 },
    hardGuard:{ enforce:true }                 // aÅŸÄ±ldÄ±ÄŸÄ±nda degrade merdiveni atlanÄ±p hÄ±zlÄ± aksiyon
  },

  anomalyDetectors:{
    methods:["EWMA","CUSUM","IQR","STL+CP"],  // seÃ§ilebilir
    seasonality:{ weekly:true, businessHours:true },
    minSamples:24
  },

  budgetPolicy:{
    respectPriceTableEffectiveAt:true,
    currency:"USD",
    fx:{ enable:false }                        // Ã‡oklu para birimi iÃ§in geniÅŸletilebilir
  },

  degradeLadder:{
    search:[
      {"action":"topK_dec","bounds":[10,200],"step":20},
      {"action":"reranker_switch","order":["ce-large","ce-small","none"]},
      {"action":"hybridAlpha_dec","step":0.1,"floor":0.1},
      {"action":"cache_ttl_inc","maxSec":1800},
      {"action":"quant_switch","order":["fp32","fp16","int8"]}
    ],
    inference:[
      {"action":"model_fallback","order":["gpt-xl","gpt-l","gpt-m"]},
      {"action":"precision_dec","order":["fp16","int8"]},
      {"action":"batch_inc","ceiling":64}
    ],
    fsync:[ {"action":"read_local_cache_on","expectedSavePct":8} ]
  },

  canary:{ trafficPct:10, durationMin:15, eval:{ slo:"latency_p95", quality:"NDCG@10", maxDropPct:3 } },

  rca:{
    features:["topK","reranker","dim","quant","variant","traffic","price_change","retry_rate","egress_mb"],
    attribution:"shaplike"                     // basit katkÄ± hesaplayÄ±cÄ±
  },

  enforcement:{
    viaFlags:"LIVIA-35",
    viaTuner:"LIVIA-47",
    viaGateway:"gateway",
    freezeHook:"LIVIA-51"                      // aktif freeze varsa yalnÄ±z simÃ¼lasyon
  },

  reporting:{
    outputDir:"data/cost/{YYYY-MM-DD}/{serviceId}",
    mdFile:"report.md", htmlFile:"report.html",
    html:{ embedMiniCSS:true, chartsInlineSvg:true },
    include:{ ladders:true, savings:true, rca:true, timelines:true }
  },

  rbacViews:{ observer:{ hideRCAWeights:true, showOnlySummary:true } },

  idempotencyTtlSec: 3600
}

5) Tespit & TeÅŸhis (Ã¶zet)

Sinyaller: per1kReq maliyeti, perHourUSD, komponent bazlÄ± (inference/search/egress).

Anomali: EWMA sapma, CUSUM artÄ±ÅŸ, IQR outlier, change-point (konfig/fiyat deÄŸiÅŸimi sonrasÄ±).

RCA: yakÄ±n zamanda olan config.change.applied, kb.tuning.promoted, price.table.updated, retry_rateâ†‘, egress_mbâ†‘ ve A/B varyantÄ± ile iliÅŸkilendir; katkÄ± skoru Ã¼ret.

Kalite & SLO baÄŸlamÄ±: kalite metriÄŸi (Ã¶rn. NDCG@10) L47â€™den, SLO p95 L32â€™den; degrade adÄ±mlarÄ±nda kalite dÃ¼ÅŸÃ¼ÅŸ eÅŸiÄŸi korunur.

6) Pipeline (Kompozisyon)

Collect: cost.usage.sample/rollup + fiyat tablosu + bÃ¼tÃ§e politikalarÄ± alÄ±nÄ±r.

Detect: 5m pencerede anomali; 1h pencere iÃ§in bÃ¼tÃ§e ihlali kontrolÃ¼.

RCA: katkÄ± analizi â†’ ÅŸÃ¼pheli faktÃ¶r seti ve gÃ¼ven skoru.

Decide: hardGuard â†’ hÄ±zlÄ± adÄ±m; deÄŸilse degrade merdiveni + canary ile kademeli uygula.

Apply: L35/L47/gateway Ã¼zerinden parametre/rota deÄŸiÅŸiklikleri; freeze varsa yalnÄ±z simÃ¼lasyon.

Evaluate: canary penceresi â†’ kalite/SLO ve maliyet trendi; rollback veya promote.

Report/Emit: card/alert/metrics + tasarruf raporu (md/html); L22 ile daÄŸÄ±t.

Index: tÃ¼m adÄ±mlar L38 append; L39 lineage; L48 audit paketine girer.

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (cost.usage.rollup|price.table.updated) â†’ DETECT

DETECT â†’ (anomaly) RCA â†’ DECIDE â†’ APPLY â†’ EVALUATE â†’ REPORT â†’ IDLE

RECOVER: maliyet normale dÃ¶ndÃ¼ÄŸÃ¼nde cost.guard.recovered â†’ REPORT

Hata: ALERT; idem: aynÄ± costGuardKey yinelemesinde yan etki yok (yalnÄ±z kart/metrik gÃ¼ncellenir)

8) Kenar Durumlar

Fiyat Tablosu DeÄŸiÅŸimi: effectiveAt ile geÃ§miÅŸ pencereler yeniden yorumlanÄ±r (yanlÄ±ÅŸ pozitif azalt).

SezonsallÄ±k: hafta iÃ§i/sonu ve mesai saatleri farklÄ± baz Ã§izgileri; STL ile trend ayrÄ±ÅŸtÄ±r.

A/B Test: varyant B pahalÄ± ama kalite â†‘; min NDCG uplift karÅŸÄ±lanÄ±yorsa kabul edilebilir.

Failover/DR: L49/L50 sÄ±rasÄ±nda egress/broker maliyeti spike; freezeHook aktifse yalnÄ±z izleme.

Eksik Veri: rollup eksik â†’ dq_gap uyarÄ±sÄ±, karar ertelenir.

Ã–lÃ§Ã¼m KaymasÄ±: token sayacÄ±/KB hesaplama deÄŸiÅŸmiÅŸse step_change ama config.change.applied ile eÅŸler.

Observer gÃ¶rÃ¼nÃ¼mÃ¼: RCA ayrÄ±ntÄ±larÄ± gizli; yalnÄ±z Ã¶zet ve Ã¶neriler.

Idempotency: aynÄ± pencere/policy tekrarÄ±nda merdiven ikinci kez uygulanmaz.

9) Telemetri
{
  "cost.metrics": {
    "event":"cost.metrics","timestamp":"iso8601",
    "detections":3,"actionsApplied":2,"rollbacks":0,
    "avgDetectMs":28,"p95DetectMs":65,
    "avgSavingsPct":26.4,"hoursToRecoverP50":0.4,
    "rcaConfidenceAvg":0.68
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/costAnomalyGuard.ts                 # FSM + orchestrator
services/livia/lib/cost/collect.ts                 # rollup & price table ingest
services/livia/lib/cost/detect.ts                  # EWMA/CUSUM/IQR/STL+CP
services/livia/lib/cost/rca.ts                     # katkÄ± analizi (shaplike)
services/livia/lib/cost/decide.ts                  # merdiven & canary planlayÄ±cÄ±
services/livia/lib/cost/apply.ts                   # L35/L47/gateway kÃ¶prÃ¼leri
services/livia/lib/cost/report.ts                  # md/html + grafikler (inline SVG)
services/livia/lib/bridges.ts                      # L22/L26/L32/L34/L35/L38/L39/L45/L46/L47/L48/L49/L50/L51/L52
services/livia/state/costStore.ts                  # idem index + pencereler + ladders
services/livia/__tests__/costAnomalyGuard.test.ts
cfg/livia.cost.guard.yaml

11) Test Ä°skeleti (Jest/Vitest)

Spike: per1k total 0.92â†’1.45 (+57%) â†’ cost.guard.triggered(high)

Hard guard: saatlik > $80 â†’ merdiven atla, hÄ±zlÄ± model_fallback/reranker off

Canary: %10/15dk â†’ kalite dÃ¼ÅŸÃ¼ÅŸ â‰¤ %3, SLO ok â†’ promote; aksi â†’ rollback

RCA: topKâ†‘ + reranker=ce-large ÅŸÃ¼pheli; gÃ¼ven â‰¥ 0.6

Price change: fiyat yÃ¼kseldi â†’ price_table_change; yanlÄ±ÅŸ pozitif yok

Freeze aktif: L51 frozen â†’ freeze_active, apply yok, yalnÄ±z simulate

Failover etkisi: egress â†‘; failover bitince recovered

Idempotency: aynÄ± costGuardKey tekrarÄ± yan etkisiz

Report: md/html yazÄ±ldÄ±; kart/alert/metrics; L38/L48 baÄŸlandÄ±

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

11:05 cost.usage.rollup(5m) total/1k = 1.45 (baz 0.92) â†’ DETECT

RCA: kb.topK=100, reranker=ce-large, varyant B; gÃ¼ven 0.71

DECIDE: merdiven planÄ±; canary %10/15dk

11:25 EVALUATE: per1k 0.98, NDCG@10 -1.2%, p95 +12ms â†’ promote

11:30 RECOVER: saatlik toplam $42/h â†’ cost.guard.recovered; rapor + tasarruf Ã¶zeti yayÄ±nlandÄ±.

13) SLO

p95 detect < 70 ms (5m pencere kapatÄ±ldÄ±ktan sonra)

yanlÄ±ÅŸ pozitif â‰¤ %2, kaÃ§Ä±rÄ±lan kritik â‰¤ %1

recovery to budget p50 â‰¤ 45 dk (canaryâ†’promote ile)

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
Åunu dedin:
devam et
ChatGPT:
LIVIA-54 Â· trafficShaper.ts â€” GeniÅŸ Prompt v3 (+ SLA KatmanlarÄ±, PID+EWMA Kontrol, Adil PaylaÅŸÄ±m, SimÃ¼lasyon)

AmaÃ§:
Sistem yÃ¼kÃ¼ ve maliyet baskÄ±sÄ± altÄ±nda istek kabul/Ã¶nceliklendirme/ÅŸekillendirme/shed kararlarÄ±nÄ± gerÃ§ek zamanlÄ± yÃ¶netmek. SLO (p95 gecikme, hata oranÄ±) ve bÃ¼tÃ§e (L34) hedeflerini koruyarak SLA katmanlarÄ± (gold/silver/bronze), tenant ve iÅŸlev (search/answer/infer/ingest) bazlÄ± politikalarÄ± uygula. Oran sÄ±nÄ±rlama (token/leaky bucket), eÅŸzamanlÄ±lÄ±k limitleme, kuyruklama (WFQ/CBWFQ), Ã¶nceliklendirme + yaÅŸlandÄ±rma (aging), backpressure, graceful shedding, deadline-aware yÃ¼rÃ¼tme, Ã¶niÅŸlem degrade (Ã¶rn. topKâ†“, reranker off, maxTokensâ†“) ve A/B trafikleri iÃ§in baÄŸÄ±msÄ±z kotalar. Gateway/mesh (L35), Failover (L49), Freeze (L51), Cost Guard (L53), KB Tuning (L47), Canary (L45) ile entegre.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: ops|platform|policy tam, observer salt okur

Gizlilik: PII yok; aktÃ¶rler L21 ile hashlenir

Ä°dempotency: shapeKey = windowISO + policyHash + scope + tier + path

Observability: spans (shape.classify,shape.decide,shape.enqueue,shape.run,shape.drop) + metrics

Uyumluluk: kritik politika deÄŸiÅŸimi L26 etik/WORM (L38) append; kararlar L39 lineageâ€™a baÄŸlanÄ±r

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "shape.policy.updated": {
    "event":"shape.policy.updated","timestamp":"iso8601",
    "policyId":"traffic-v1",
    "tiers":[
      {"name":"gold","rpsMax":120,"burst":240,"concurrencyMax":64,"queueMsMax":250,"deadlineMs":1200,
       "wfqWeight":8,"dropPolicy":"taildrop|lifo-shed|headroom-shed","degrade":{"kb.topKMax":80,"reranker":"ce-small","maxTokens":800}},
      {"name":"silver","rpsMax":80,"burst":160,"concurrencyMax":40,"queueMsMax":350,"deadlineMs":1400,"wfqWeight":4,
       "degrade":{"kb.topKMax":60,"reranker":"none","maxTokens":600}},
      {"name":"bronze","rpsMax":40,"burst":80,"concurrencyMax":16,"queueMsMax":400,"deadlineMs":1600,"wfqWeight":1,
       "degrade":{"kb.topKMax":40,"reranker":"none","maxTokens":400}}
    ],
    "algorithms":{"rate":"token_bucket","queue":"wfq","scheduler":"edf|cbwfq","controller":"pid+ewma"},
    "priorityOrder":["incident|runbook","user:paying","user:trial","batch"],
    "fairness":{"tenantMinSharePct":5,"maxSharePctPerTenant":60,"agingSec":45}
  },

  "shape.target.updated": {
    "event":"shape.target.updated","timestamp":"iso8601",
    "serviceId":"kb_api",
    "targets":{"latencyP95Ms":250,"errorRatePctMax":1.0,"budgetUsdPerHour":60}
  },

  "request.arrived": {
    "event":"request.arrived","timestamp":"iso8601",
    "id":"req#7f9a12",
    "svc":"kb_api","path":"/search","method":"POST",
    "slaTier":"gold|silver|bronze",
    "tenant":"t#acme","subject":"user#f0a1",
    "variant":"A|B","importance":"interactive|background|batch",
    "hints":{"deadlineMs":900,"maxTokens":900,"kb.topK":100,"reranker":"ce-large"}
  },

  "shape.signal.telemetry": {
    "event":"shape.signal.telemetry","timestamp":"iso8601",
    "window":"1m",
    "svc":"kb_api","path":"/search",
    "latencyP95Ms":312,"latencyP50Ms":118,"errPct":1.4,"queueDepth":73,"activeConcurrency":58,"rps":92
  },

  "slo.guard.triggered|slo.guard.recovered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"latency_p95","severity":"high","burnPct":6.4"
  },

  "cost.guard.triggered|cost.guard.recovered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "component":"inference|search_stack|total","severity":"high"
  },

  "mrf.state.update": {
    "event":"mrf.state.update","timestamp":"iso8601",
    "phase":"execute|stabilize","fromRegion":"eu-central","toRegion":"us-east"
  },

  "freeze.state.changed": {
    "event":"freeze.state.changed","timestamp":"iso8601",
    "state":"frozen|thawed","scope":"global|service:kb_api","reason":"slo|mrf|drill|calendar"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "shape.admission.decision": {
    "event":"shape.admission.decision","timestamp":"iso8601",
    "id":"req#7f9a12","svc":"kb_api","tier":"gold","tenant":"t#acme",
    "decision":"admit|queue|shed","queuePos":3,"queueEtaMs":180,
    "appliedDegrade":{"kb.topK":80,"reranker":"ce-small","maxTokens":800},
    "rationale":"pid_control:over_target_p95; fairness:tenant_min_share"
  },

  "shape.rate.updated": {
    "event":"shape.rate.updated","timestamp":"iso8601",
    "svc":"kb_api","path":"/search",
    "rpsTarget":76,"burst":152,"concurrencyLimit":48,
    "controller":{"p95TargetMs":250,"p95ObservedMs":312,"pid":{"p":0.6,"i":0.12,"d":0.04}}
  },

  "shape.queue.snapshot": {
    "event":"shape.queue.snapshot","timestamp":"iso8601",
    "tiers":{"gold":12,"silver":38,"bronze":23},
    "tenants":[["t#acme",22],["t#beta",8]],
    "drops":{"gold":0,"silver":4,"bronze":11}
  },

  "shape.shed.event": {
    "event":"shape.shed.event","timestamp":"iso8601",
    "id":"req#7f9b00","tier":"bronze","reason":"deadline_violation|queue_overflow|budget_guard",
    "policy":"graceful","retryAfterMs":600,"advice":{"use":"background","degrade":"kb.topKâ‰¤30"}
  },

  "shape.apply.toGateway": {
    "event":"shape.apply.toGateway","timestamp":"iso8601",
    "via":"LIVIA-35|envoy|kong",
    "rules":[
      {"path":"/search","rps":76,"burst":152,"concurrency":48,"priority":{"gold":8,"silver":4,"bronze":1}},
      {"path":"/answer","rps":40,"burst":80,"concurrency":24}
    ],
    "status":"ok"
  },

  "shape.card": {
    "event":"shape.card","timestamp":"iso8601",
    "title":"Traffic Shaper Aktif â€” kb_api /search",
    "body":"p95 312ms>250 hedefi; rps 76, conc 48; gold Ã¶ncelik + min-tenant-paylaÅŸÄ±m aÃ§Ä±ldÄ±.",
    "severity":"warn","ttlSec":600
  },

  "shape.alert": {
    "event":"shape.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|rbac_denied|apply_failed|queue_starvation|tenant_quota_violation|deadline_spike|mrf_derate|freeze_active"
  },

  "shape.metrics": {
    "event":"shape.metrics","timestamp":"iso8601",
    "admitted":1240,"queued":860,"shed":93,"avgQueueMs":140,
    "p95BeforeMs":318,"p95AfterMs":246,"errPctBefore":1.4,"errPctAfter":0.9,
    "budgetUsdPerHourBefore":68.2,"budgetUsdPerHourAfter":55.7
  },

  "shape.report.ready": {
    "event":"shape.report.ready","timestamp":"iso8601",
    "path":"data/shape/2025-09-16/kb_api/search/report.md",
    "summary":"PID+EWMA ile p95 318â†’246ms; bÃ¼tÃ§e 68.2â†’55.7 $/h; gold SLA kayÄ±psÄ±z; bronze %6 graceful shed.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  tiers:{
    gold:{ rpsMax:120, burst:240, concurrencyMax:64, wfqWeight:8, queueMsMax:250, deadlineMs:1200,
           degrade:{ "kb.topKMax":80, "reranker":"ce-small", "maxTokens":800 } },
    silver:{ rpsMax:80,  burst:160, concurrencyMax:40, wfqWeight:4, queueMsMax:350, deadlineMs:1400,
           degrade:{ "kb.topKMax":60, "reranker":"none", "maxTokens":600 } },
    bronze:{ rpsMax:40,  burst:80,  concurrencyMax:16, wfqWeight:1, queueMsMax:400, deadlineMs:1600,
           degrade:{ "kb.topKMax":40, "reranker":"none", "maxTokens":400 } }
  },

  algorithms:{
    rateLimiter:"token_bucket",                 // token_bucket|leaky_bucket
    queueDiscipline:"wfq",                      // wfq|cbwfq|prio
    scheduler:"edf",                            // edf (deadline-aware)
    controller:{ type:"pid+ewma",
                 pid:{ kp:0.9, ki:0.15, kd:0.05, sampleSec:5, clamp:{ rps:[10,200], conc:[8,128] } },
                 ewmaAlpha:0.2 }
  },

  fairness:{
    tenantMinSharePct:5, maxSharePctPerTenant:60, agingSec:45, starvationGuard:true
  },

  quotas:{
    perTenant:{ defaultRps:20, burst:40 },
    perSubject:{ defaultRps:6, burst:12 },
    abVariant:{ A:{rpsSharePct:50}, B:{rpsSharePct:50} }
  },

  degradePolicies:{
    when:{ queueDepth:{warn:50, breach:100}, p95Ms:{warn:250, breach:350}, errPct:{warn:1.0, breach:2.0} },
    steps:[
      { action:"kb.topK_dec", tiers:["bronze","silver"], step:20, floor:30 },
      { action:"reranker_switch", order:["ce-large","ce-small","none"] },
      { action:"maxTokens_dec", step:100, floor:300 },
      { action:"queue_reject_low", tiers:["bronze"], ratio:0.1 } // graceful shed
    ],
    qualityGuard:{ ndcg10DropMaxPct:3.0 }
  },

  deadlines:{ defaultMs:1200, strictPaths:{ "/answer":900 } },

  integration:{
    gateway:"LIVIA-35", kbTune:"LIVIA-47", slo:"LIVIA-32", cost:"LIVIA-34", costGuard:"LIVIA-53",
    canary:"LIVIA-45", failover:"LIVIA-49", freeze:"LIVIA-51", drills:"LIVIA-50",
    provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48", dist:"LIVIA-22"
  },

  simulation:{
    enable:true, whatIf:{ rps:[-30, -10, +10, +30], mix:[["gold",60],["silver",30],["bronze",10]] }
  },

  rbacViews:{ observer:{ hideTenantIds:true, showOnlySummary:true } },

  idempotencyTtlSec: 1800
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

SÄ±nÄ±flandÄ±rma: her istek â†’ tier, tenant, importance, path Ã§Ä±kar; deadline = min(hint, policy).

Kontrol DÃ¶ngÃ¼sÃ¼: p95 hedefi iÃ§in PID + EWMA: p95â†‘ â†’ rpsTargetâ†“, concurrencyâ†“, queue capâ†“; p95â†“ â†’ yavaÅŸ slow-start.

Admisyon: token varsa admit, deÄŸilse queue; queueMs>queueMsMax âˆ¨ deadline<eta ise graceful shed.

Ã–ncelik & Adalet: WFQ/CBWFQ ile tierWeight; tenant min pay garantisi, max share sÄ±nÄ±rÄ±; aging ile aÃ§lÄ±k Ã¶nlenir.

Degrade: uyarÄ±/breach eÅŸiklerinde kademeli degrade + quality guard (L47 NDCG).

BÃ¼tÃ§e/SLO baÄŸlamÄ±: L53 (maliyet) veya L32 (SLO) ihlali varsa hedeflerin Ã¶nemi artar; PID sÄ±nÄ±rlarÄ± sÄ±kÄ±lÄ±r.

Failover/DR: L49/L50 sÄ±rasÄ±nda rps hedefi dÃ¼ÅŸÃ¼rÃ¼lÃ¼r, deadline gevÅŸetilebilir; bÃ¶lge baÅŸÄ±na sÄ±nÄ±rlar gÃ¼ncellenir.

Freeze: L51 frozen â†’ policy deÄŸiÅŸikliÄŸi yazÄ±lmaz (yalnÄ±z simÃ¼lasyon/Ã¶neri).

6) Pipeline (Kompozisyon)

Load policy/targets (shape.policy.updated, shape.target.updated)

Classify & Token Check (request.arrived) â†’ admit/queue/shed + opsiyonel degrade setleri

Control (shape.signal.telemetry) â†’ PID+EWMA ile rpsTarget, concurrency, queue caps gÃ¼ncelle

Apply (gateway/mesh) â†’ shape.apply.toGateway

Fairness â†’ WFQ/CBWFQ + tenant kotalarÄ±; aging ile terfi

Emit â†’ decision/queue/shed + card/alert/metrics/report

Link & Audit â†’ L38/L39, L48 paketine rapor

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (policy.updated|target.updated) â†’ READY

READY â†’ (request.arrived) ADMISSION â†’ (admit) RUN | (queue) QUEUE | (shed) DONE

QUEUE â†’ (ETAâ‰¤deadline âˆ§ token) RUN | (queueMs>max âˆ¨ deadline<ETA) SHED

RUN â†’ (complete) DONE

CONTROL (yan kanal): signal.telemetry â†’ PID param â†’ APPLY

APPLY â†’ kural/limitleri gatewayâ€™e uygula â†’ READY

Hata: ALERT; idem: aynÄ± shapeKey yinelemesinde yan etki yok (yalnÄ±z snapshot/karte gÃ¼ncellenir)

8) Kenar Durumlar

Queue Starvation: agingSec ile dÃ¼ÅŸÃ¼k tier istekleri terfi; maxSharePctPerTenant ile tek tenant iÅŸgalini engelle.

Burst FÄ±rtÄ±nasÄ±: burst bittiÄŸinde token refill yumuÅŸak; slow-start ile toparlan.

Deadline Spike: kÄ±sa sÃ¼reli piklerde EWMA yumuÅŸat; iki pencere Ã¼st Ã¼ste gelmeden sert shed yok.

Long-running Ä°ÅŸler: ETA>deadline â†’ erken shed; uzun Ã§alÄ±ÅŸan yÃ¼rÃ¼tmelerde iÅŸbirlikÃ§i iptal (cancellation) sinyali.

A/B Adaleti: varyantlar iÃ§in rps payÄ± korunur; varyant baskÄ±nlaÅŸÄ±yorsa cap uygulanÄ±r.

Degradeâ€“Quality Ã‡atÄ±ÅŸmasÄ±: NDCG dÃ¼ÅŸÃ¼ÅŸÃ¼ > %3 â†’ degrade geri sar; canary (L45) ile kademeli uygula.

Failover BÃ¶lge KaybÄ±: etkin bÃ¶lge kapasitesi dÃ¼ÅŸerse rpsTarget otomatik Ã¶lÃ§eklenir; mrf_derate uyarÄ±sÄ±.

Freeze Aktif: policy yazÄ±mÄ± blok, yalnÄ±z simÃ¼lasyon; uyarÄ± freeze_active.

Observer: tenant/subject kimlikleri maskeli; yalnÄ±z Ã¶zet verilir.

9) Telemetri
{
  "shape.metrics": {
    "event":"shape.metrics","timestamp":"iso8601",
    "admitted":1240,"queued":860,"shed":93,
    "avgQueueMs":140,"p95BeforeMs":318,"p95AfterMs":246,
    "errPctBefore":1.4,"errPctAfter":0.9,
    "budgetUsdPerHourBefore":68.2,"budgetUsdPerHourAfter":55.7,
    "goldLossPct":0.0,"silverLossPct":1.8,"bronzeLossPct":6.0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/trafficShaper.ts                     # FSM + orchestrator
services/livia/lib/shape/policy.ts                  # Zod ÅŸema + kural motoru
services/livia/lib/shape/controller.ts              # PID+EWMA hedef ayarlayÄ±cÄ±
services/livia/lib/shape/ratelimit.ts               # token/leaky bucket
services/livia/lib/shape/queue.ts                   # WFQ/CBWFQ + aging + fairness
services/livia/lib/shape/admission.ts               # admit/queue/shed + degrade
services/livia/lib/shape/apply.ts                   # L35/envoy/kong kural uygulayÄ±cÄ±
services/livia/lib/shape/report.ts                  # md/html + inline SVG
services/livia/lib/bridges.ts                       # L22/L26/L32/L34/L35/L38/L39/L45/L47/L48/L49/L50/L51/L53
services/livia/state/shapeStore.ts                  # idem index + Ã¶lÃ§Ã¼mler + anlÄ±k durum
services/livia/__tests__/trafficShaper.test.ts
cfg/livia.shape.yaml

11) Test Ä°skeleti (Jest/Vitest)

PID Kontrol: p95 318msâ†’ hedef 250ms; rpsTargetâ†“, concurrencyâ†“, p95 246ms

WFQ Adalet: gold %0 kayÄ±p, bronze %â‰¤6 shed; tenant min pay korunur

Deadline-aware: ETA>deadline â†’ erken shed; uygun istekler admit

Degrade: kuyruk derinliÄŸi 100 â†’ topKâ†“, reranker ce-small/none uygulanÄ±r, kalite dÃ¼ÅŸÃ¼ÅŸ â‰¤ %3

Cost Guard: L53 tetiklenince rps/conc hedefleri sÄ±kÄ±laÅŸÄ±r; bÃ¼tÃ§e â‰¤ hedef

Failover: L49 execute â†’ mrf_derate ve rps dÃ¼ÅŸÃ¼rme uygulanÄ±r

Freeze: L51 frozen â†’ gatewayâ€™e kalÄ±cÄ± kural yazÄ±lmaz; simÃ¼lasyon sonucu dÃ¶nÃ¼lÃ¼r

Idempotency: aynÄ± shapeKey yinelenince yan etki yok

Rapor: md/html Ã¼retildi; L22 daÄŸÄ±tÄ±ldÄ±; L38/L48â€™e eklendi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

13:00 p95 318ms, err 1.4%, rps 92 â†’ PID rpsTarget=76, concurrency=48

ADMISSION: gold admit/queue â‰¤250ms, silver sÄ±rada, bronze bazÄ± istekler graceful shed

DEGRADE: topK 100â†’80; reranker ce-largeâ†’ce-small; tokens 900â†’800

13:10 p95 246ms, err 0.9%, bÃ¼tÃ§e 55.7$/h â†’ shape.report.ready, kart warnâ†’info.

13) SLO

Karar gecikmesi p95 < 3 ms (admission yolunda)

Kontrol tepki sÃ¼resi â‰¤ 2 pencere (â‰¤10 sn)

Gold kayÄ±p â‰¤ %0.1, Bronze shed â‰¤ %10 (konfigâ€™e baÄŸlÄ±)

SLO iyileÅŸmesi: p95 dÃ¼ÅŸÃ¼ÅŸÃ¼ â‰¥ %15 (aÅŸÄ±rÄ± yÃ¼kte)

idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-55 Â· queryOrchestrator.ts â€” GeniÅŸ Prompt v3 (+ Latency/Cost-Aware Planner, Step-Degrade, Cache/Memoization)

AmaÃ§:
KullanÄ±cÄ± sorgularÄ±nÄ± Ã§ok-aÅŸamalÄ± akÄ±ÅŸ ile yÃ¶net: parse â†’ intent/route â†’ retrieve (hybrid) â†’ rerank â†’ synthesize/reason â†’ tool-use â†’ finalize â†’ stream. SLO (L32) ve maliyet (L34/L53) hedeflerine gÃ¶re plan seÃ§imi (latency/cost aware), adÄ±m-degradasyon (L54 ile uyumlu), cache/memoization, A/B & canary (L45), KB tuning (L47) ile kalite (NDCG/MRR/CTR) korumasÄ±.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: app|mlops|policy tam; observer salt-okur

Gizlilik: PII yok; aktÃ¶rler L21 ile hash; prompt/answer redaksiyon politikasÄ±

Ä°dempotency: qKey = hash(query + profile + scope + planId + topK)

Observability: spans (qo.parse|route|plan|retrieve|rerank|reason|tool|finalize|stream) + breadcrumbs; OTel attributes (lat/cost/toks)

Uyumluluk: karar ve izlenceler L38 WORM append + L39 lineage; freeze (L51) durumunda yalnÄ±z gÃ¼venli degrade

2) Girdiler (In) â€” Zod .strict() Ã¶rnekleri
{
  "query.request": {
    "event":"query.request","timestamp":"iso8601",
    "id":"q#7f9a12",
    "text":"Avalanche staking APR nedir?",
    "lang":"tr|en|auto","profile":"tr","tenant":"t#acme",
    "mode":"search|answer|chat|tooling",
    "hints":{"deadlineMs":1200,"costHardUsd":0.02,"stream":true,"variant":"A|B"},
    "context":{"userTier":"gold|silver|bronze","sessionId":"sess#abc"}
  },

  "kb.route.policy": {
    "event":"kb.route.policy","timestamp":"iso8601",
    "namespace":"kb_default","strategies":["hybrid","bm25","vector","gen-search"],
    "hybrid":{"alpha":0.35,"bm25TopK":80,"vecTopK":80,"merge":"RRf|BM25â†’CE|CEâ†’BM25"}
  },

  "qo.plan.catalog.registered": {
    "event":"qo.plan.catalog.registered","timestamp":"iso8601",
    "planId":"P-hybrid-fast",
    "steps":["parse","expand","retrieve","rerank","synthesize","finalize"],
    "latencyBudgetMs":900,"costBudgetUsd":0.015,
    "defaults":{"topK":60,"reranker":"ce-small","reasoner":"gpt-m","maxTokens":700}
  },

  "kb.tuning.profile": {
    "event":"kb.tuning.profile","timestamp":"iso8601",
    "profileId":"kb_default:tr",
    "index":{"type":"ivf-pq","dim":384,"nprobe":16,"quant":"int8"},
    "rerankers":["ce-large","ce-small","none"],
    "synthModels":["gpt-xl","gpt-l","gpt-m"]
  },

  "traffic.shape.hint": {
    "event":"traffic.shape.hint","timestamp":"iso8601",
    "tier":"gold|silver|bronze","rpsTarget":76,"deadlineMs":1200
  },

  "slo.guard.triggered|slo.guard.recovered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"latency_p95","severity":"high","burnPct":6.2
  },

  "cost.guard.triggered|cost.guard.recovered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "component":"inference|search_stack|total","severity":"high"
  },

  "freeze.state.changed": {
    "event":"freeze.state.changed","timestamp":"iso8601",
    "state":"frozen|thawed","scope":"service:kb_api","reason":"slo|mrf|drill|calendar"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "qo.plan.ready": {
    "event":"qo.plan.ready","timestamp":"iso8601",
    "qKey":"sha256:...","planId":"P-hybrid-fast",
    "steps":["parse","expand","retrieve(hybrid 40/40)","rerank(ce-small 60â†’20)","synthesize(gpt-m)","finalize(stream)"],
    "budgets":{"latencyMs":900,"costUsd":0.015},
    "expected":{"ndcg@10":">=0.52","p95Ms":"<=900"},
    "hash":"sha256:..."
  },

  "qo.cache": {
    "event":"qo.cache","timestamp":"iso8601",
    "kind":"hit|miss|store|bloom_negative",
    "scope":"query|passage|rerank|answer","key":"sha256:...","ageSec":42
  },

  "qo.decision.path": {
    "event":"qo.decision.path","timestamp":"iso8601",
    "route":"hybrid","expand":"multi-lingual|synonyms",
    "degrade":"step#1 topK 60â†’40 (cost guard)","fallback":"reranker ce-smallâ†’none?",
    "canary":{"enabled":true,"pct":10}
  },

  "qo.trace.ready": {
    "event":"qo.trace.ready","timestamp":"iso8601",
    "id":"q#7f9a12","spans":[
      ["parse",12],["expand",18],["retrieve.vec",140],["retrieve.bm25",90],
      ["merge",8],["rerank.ce-small",120],["synthesize.gpt-m",330],["finalize",10]
    ],
    "tokenUsage":{"prompt":620,"completion":210,"total":830}
  },

  "query.result.ready": {
    "event":"query.result.ready","timestamp":"iso8601",
    "id":"q#7f9a12","mode":"answer","stream":true,
    "topDocs":[{"id":"doc#1","score":0.82},{"id":"doc#7","score":0.78}],
    "answerMd":"...kÄ±sa Ã¶zet + kaynak iÅŸaretleri...","citations":["doc#1","doc#7"],
    "guardrails":{"pii":"ok","toxicity":"ok"},
    "hash":"sha256:..."
  },

  "qo.card": {
    "event":"qo.card","timestamp":"iso8601",
    "title":"Plan P-hybrid-fast (ndcg@10 â‰¥0.52) â€” canlÄ±",
    "body":"topK 60â†’40 (cost) â€¢ ce-small â€¢ gpt-m â€¢ p95 hedef 900ms.",
    "severity":"info","ttlSec":600
  },

  "qo.alert": {
    "event":"qo.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"deadline_risk|budget_over|freeze_active|dq_gap|vec_index_stale|tool_failure|idem_duplicate|rbac_denied"
  },

  "qo.metrics": {
    "event":"qo.metrics","timestamp":"iso8601",
    "qps":31.2,"p50Ms":410,"p95Ms":882,"avgCostUsd":0.011,
    "cacheHitPct":{"query":38,"passage":22,"answer":9},
    "quality":{"ndcg@10":0.55,"mrr@10":0.61},
    "degradeStepsApplied":0
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  planner:{
    catalog:[
      { id:"P-hybrid-fast", steps:["parse","expand","retrieve","rerank","synthesize","finalize"],
        budget:{ latencyMs:900, costUsd:0.015 },
        defaults:{ topK:60, reranker:"ce-small", reasoner:"gpt-m", maxTokens:700 } },
      { id:"P-vec-lite", steps:["parse","retrieve.vec","synthesize","finalize"],
        budget:{ latencyMs:600, costUsd:0.008 }, defaults:{ topK:40, reasoner:"gpt-m" } },
      { id:"P-bm25-lowcost", steps:["parse","retrieve.bm25","synthesize","finalize"],
        budget:{ latencyMs:700, costUsd:0.004 }, defaults:{ bm25TopK:80, reasoner:"gpt-m" } },
      { id:"P-hybrid-quality", steps:["parse","expand","retrieve","rerank(ce-large)","synthesize(gpt-l)","finalize"],
        budget:{ latencyMs:1400, costUsd:0.03 }, defaults:{ topK:100, maxTokens:900 } }
    ],
    policy:{ pick:"argmin(cost) s.t. p95<=deadline âˆ§ quality>=target" }
  },

  degrade:{
    when:{ p95Ms:{warn:900, breach:1100}, costUsd:{warn:0.015, breach:0.02} },
    steps:[
      { action:"topK_dec", step:20, floor:20 },
      { action:"reranker_switch", order:["ce-large","ce-small","none"] },
      { action:"reasoner_switch", order:["gpt-l","gpt-m"] },
      { action:"maxTokens_dec", step:100, floor:400 },
      { action:"expand_off" }
    ],
    qualityGuard:{ ndcg10DropMaxPct:3.0 }
  },

  caches:{
    query:{ kind:"lfu", maxItems:10000, ttlSec:7200, bloom:true },
    passage:{ kind:"lru", maxItems:50000, ttlSec:86400 },
    rerank:{ kind:"lru", maxItems:20000, ttlSec:14400 },
    answer:{ kind:"kvstore", ttlSec:10800, keyBy:"qKey+topDocsHash+model" }
  },

  retrieval:{
    vector:{ topK:80, ef:64, timeoutMs:250, prefetch:true },
    bm25:{ topK:80, timeoutMs:200 },
    hybrid:{ alpha:0.35, merge:"RRf" },
    diversity:{ method:"mmr", lambda:0.7 }
  },

  rerank:{ model:"ce-small", truncateTopK:20, timeoutMs:300 },

  synthesize:{
    models:{ fast:"gpt-m", quality:"gpt-l" },
    guardrails:{ pii:true, toxicity:true, jailbreak:true },
    streaming:true, maxTokens:700, citationStyle:"compact"
  },

  qualityTargets:{ "ndcg@10":0.52, "mrr@10":0.58 },

  integrations:{
    shape:"LIVIA-54", cost:"LIVIA-34", costGuard:"LIVIA-53", slo:"LIVIA-32",
    canary:"LIVIA-45", kbTune:"LIVIA-47", fsync:"LIVIA-46",
    audit:"LIVIA-48", provenance:"LIVIA-38", lineage:"LIVIA-39", dist:"LIVIA-22",
    freeze:"LIVIA-51"
  },

  rbacViews:{ observer:{ hidePrompts:true, showOnlySummary:true } },

  idempotencyTtlSec: 600
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

Parse/Intent: dil tespiti, soru tÃ¼rÃ¼, araÃ§ ihtiyacÄ± (calc/web/tool) â†’ route.

Plan SeÃ§imi: deadline/cost/tier/traffic hedeflerine gÃ¶re katalogtan plan; quality hedefi saÄŸlanmÄ±yorsa bir Ã¼st kalite plana terfi.

Retrieve: hybrid (BM25+Vector) â†’ diversity/MMR; kaynak sÃ¼re dolarsa kÄ±smi sonuÃ§la devam.

Rerank: CE (large/small/none) â€“ kalite/latency dengesi.

Synthesize: model seÃ§imi (fast/quality); citation zorunlu; guardrails filtreleri.

Step-Degrade: p95 veya cost ihlalinde plan iÃ§inde adÄ±m kÄ±sÄ±lÄ±r (topKâ†“, ce-smallâ†’none, tokensâ†“).

Cache/Memo: query/passsage/answer; bloom negative ile gereksiz arama kaÃ§Ä±nma.

Canary: yeni plan/param iÃ§in %10/15dk; sonuÃ§ iyi â†’ promote (L45).

Freeze: aktifse yalnÄ±z gÃ¼venli degrade/plan dÃ¼ÅŸÃ¼rme; param yazÄ±mÄ± yok (L51).

6) Pipeline

Parse/Route â†’ niyet & araÃ§ ihtiyacÄ±, dil/tema

Plan â†’ katalogtan seÃ§; bÃ¼tÃ§eler ayarla

Retrieve â†’ vector/bm25/hybrid; diversity + prefetch

Rerank â†’ CE; truncateâ†’TopN

Synthesize/Guardrails â†’ akÄ±ÅŸ ve citasyonlar

Finalize/Stream â†’ parÃ§alÄ± teslim, md/html biÃ§imi

Record â†’ trace.ready, decision.path, cache olaylarÄ±; audit/lineage

Emit â†’ result.ready, card/alert/metrics

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (query.request) PARSE

PARSE â†’ PLAN â†’ RETRIEVE â†’ RERANK â†’ SYNTH â†’ FINALIZE â†’ DONE

Yan kanallar: DEGRADE, CACHE (hit/miss), CANARY, ALERT

Hata: ALERT (dq_gap|index_stale|tool_failure); idem: aynÄ± qKey tekrarÄ±nda cacheâ€™den yan etkisiz cevap

8) Kenar Durumlar

DQ Gap: L41 veri boÅŸluÄŸu â†’ BM25 fallback; uyarÄ± dq_gap.

Index Stale: fsync gecikmesi yÃ¼ksek (L46) â†’ vec_index_stale, BM25 aÄŸÄ±rlÄ±ÄŸÄ± â†‘.

Cost Hard: L53 critical â†’ reranker none, topK min, model gpt-m; bÃ¼tÃ§e korunur.

SLO Burn: deadline daralt; plan vec-liteâ€™a dÃ¼ÅŸ.

Long Answers: token limiti aÅŸÄ±mÄ± â†’ Ã¶zetle parÃ§a parÃ§a.

Language Mismatch: lang=auto ve TRâ†’EN iÃ§erik â†’ Ã§eviri-Ã¶ncesi geniÅŸletme (expand).

Observer: prompt/answer gÃ¶vdeleri gizli.

9) Telemetri
{
  "qo.metrics": {
    "event":"qo.metrics","timestamp":"iso8601",
    "qps":31.2,"p50Ms":410,"p95Ms":882,"avgCostUsd":0.011,
    "cacheHitPct":{"query":38,"passage":22,"answer":9},
    "quality":{"ndcg@10":0.55,"mrr@10":0.61},
    "degradeStepsApplied":0,"canaryPromoted":1
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/queryOrchestrator.ts                 # FSM + orchestrator
services/livia/lib/qo/parse.ts                      # dil/intent/route
services/livia/lib/qo/plan.ts                       # latency/cost-aware plan seÃ§ici
services/livia/lib/qo/retrieve.ts                   # vector/bm25/hybrid + diversity
services/livia/lib/qo/rerank.ts                     # CE large/small/none
services/livia/lib/qo/synthesize.ts                 # LLM Ã§aÄŸrÄ±sÄ± + guardrails + citations
services/livia/lib/qo/finalize.ts                   # stream + md/html cevaplayÄ±cÄ±
services/livia/lib/qo/degrade.ts                    # step-degrade + quality guard
services/livia/lib/qo/cache.ts                      # query/passage/answer cache + bloom
services/livia/lib/qo/report.ts                     # md/html rapor + inline SVG
services/livia/lib/bridges.ts                       # L21/L22/L32/L34/L35/L38/L39/L41/L45/L46/L47/L48/L51/L53/L54
services/livia/state/qoStore.ts                     # idem index + trace & cache meta
services/livia/__tests__/queryOrchestrator.test.ts
cfg/livia.qo.yaml

11) Test Ä°skeleti (Jest/Vitest)

Plan seÃ§imi: deadline=900ms, budget $0.015 â†’ P-hybrid-fast seÃ§ildi

Hybrid retrieve: vector+bm25 birleÅŸtirme; MMR Ã§eÅŸitlilik; timeoutâ€™ta kÄ±smi sonuÃ§

Rerank degrade: cost guard uyarÄ±sÄ±nda ce-smallâ†’none; ndcg dÃ¼ÅŸÃ¼ÅŸ â‰¤ %3

Cache: aynÄ± qKey â†’ answer cache hit; yeni varyantta miss

Canary: %10/15dk â†’ metrikler iyi â†’ promote

Freeze: state=frozen â†’ yalnÄ±z plan dÃ¼ÅŸÃ¼rme; param yazÄ±mÄ± yok

Index stale: L46 lag yÃ¼ksek â†’ BM25 aÄŸÄ±rlÄ±k â†‘; alert vec_index_stale

Idempotency: aynÄ± qKey tekrarÄ± yan etkisiz; sadece qo.cache(hit)

Rapor: md/html, trace.ready, decision.path Ã¼retildi; L48â€™e eklendi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

10:02 query.request (gold, deadline 1200ms) â†’ PLAN: P-hybrid-fast

RETRIEVE: vec(80)+bm25(80) â†’ MMR â†’ 60 doc

RERANK: ce-small â†’ Top20

SYNTH: gpt-m, citations; stream aÃ§Ä±k

10:03 RESULT: p95 820ms, avgCost $0.011, NDCG@10 0.56 â†’ kart/info, metrikler gÃ¼ncellendi.

13) SLO

p95 planâ†’finalize â‰¤ budget latency (Ã¶rn. 900ms)

avgCostUsd â‰¤ budget (Â±%10 tolerans)

quality (ndcg@10) â‰¥ hedef (Ã¶rn. â‰¥0.52)

cache hit toplam â‰¥ %30; idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-56 Â· querySafetyGuard.ts â€” GeniÅŸ Prompt v3 (+ AkÄ±ÅŸ-Ä°Ã§i GÃ¼venlik, KanÄ±t ZorlamasÄ±, Redaksiyon, RÄ±za)

AmaÃ§:
Sorgu/cevap akÄ±ÅŸÄ±nda gÃ¼venlik ve uygunluk katmanÄ± saÄŸla: istek Ã¶n-kontrol â†’ kanÄ±t/zemin denetimi â†’ PII/duyarlÄ± veri redaksiyonu â†’ toksisite/nefret/ÅŸiddet/Ã¶z-zarar â†’ yasa-dÄ±ÅŸÄ± eylem â†’ tÄ±bbi/hukuki/finansal yÃ¶nlendirme â†’ rÄ±za (consent). Cevap akÄ±ÅŸ-Ä°Ã‡Ä° (stream) kontrolÃ¼yle ihlal durdurma â†’ gÃ¼venli alternatif/Ã¶zet â†’ sitasyon zorlamasÄ± uygula. KVKK/GDPR farkÄ±ndalÄ±ÄŸÄ±, WORM/Provenance (L38) ve Lineage (L39) ile tam izlenebilirlik. SLO (L32), Maliyet (L34/53), OrkestratÃ¶r (L55), Freeze (L51), KB Tuning (L47), Traffic Shaper (L54) ile entegre.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601, yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: policy|compliance|ops tam, observer salt okur

Gizlilik: PII saptanÄ±r ve L21 ile redakte edilir; operatÃ¶r kimliÄŸi hashâ€™lenir

Ä°dempotency: safetyKey = queryId + stage + windowISO + policyHash

Observability: spans (safety.precheck|classify|redact|ground|streamGuard|finalize) + metrics

Uyumluluk: tÃ¼m kararlar L26 (Etik), L38 (WORM append) ve L39 (lineage)â€™e yazÄ±lÄ±r

2) Girdiler (In) â€” Zod .strict() ÅŸemalarÄ±
{
  "safety.policy.updated": {
    "event":"safety.policy.updated","timestamp":"iso8601",
    "policyId":"safety-v1",
    "locale":"tr-TR",
    "categories": {
      "toxicity":"block|filter|allow",
      "hate":"block|filter",
      "violence":"filter|allow",
      "self_harm":"block|safe_alt",
      "illicit":"block|contextual",
      "sexual":"filter|block",
      "extremism":"block",
      "medical":"consent|disclaimer|safe_alt",
      "legal":"consent|disclaimer|safe_alt",
      "financial":"consent|disclaimer|safe_alt",
      "political":"disclaimer|safe_alt",
      "privacy":"strict"
    },
    "pii": { "enable": true, "confidenceMin": 0.85, "redactStyle":"hash|mask|drop",
      "patterns":["iban_tr","tckn","email","phone","address","credit_card"] },
    "grounding": {
      "requireCitationsFor": ["stats","dates","medical","legal","finance"],
      "minCitationCoveragePct": 60,
      "hallucinationScoreThreshold": 0.65
    },
    "streaming": { "cutoffOnViolation": true, "graceTokens": 20 }
  },

  "pii.lexicon.updated": {
    "event":"pii.lexicon.updated","timestamp":"iso8601",
    "patterns":[
      {"code":"tckn","regex":"\\b\\d{11}\\b"},
      {"code":"iban_tr","regex":"\\bTR\\d{24}\\b"},
      {"code":"phone_tr","regex":"\\b\\+?90\\d{10}\\b"}
    ]
  },

  "consent.policy.updated": {
    "event":"consent.policy.updated","timestamp":"iso8601",
    "requiresConsent":["medical","legal","financial","geolocation","biometric"],
    "templates":{
      "medical":"TÄ±bbi iÃ§erik iÃ§in bilgilendirme onayÄ± veriyor musunuz? (E/H)",
      "legal":"Hukuki bilgi iÃ§in yÃ¶nlendirici iÃ§erik sunacaÄŸÄ±m; onaylÄ±yor musunuz? (E/H)"
    }
  },

  "user.context": {
    "event":"user.context","timestamp":"iso8601",
    "region":"TR|EU|US|â€¦","age":"unknown|adult|minor",
    "tenant":"t#acme","tier":"gold|silver|bronze"
  },

  "user.consent.event": {
    "event":"user.consent.event","timestamp":"iso8601",
    "category":"medical|legal|financial|geolocation|biometric",
    "given": true, "expiresAt":"iso8601", "by":"user#hash"
  },

  "query.request": {
    "event":"query.request","timestamp":"iso8601",
    "id":"q#7f9a12","text":"...", "lang":"auto|tr|en","mode":"search|answer|chat",
    "hints":{"deadlineMs":1200,"stream":true}
  },

  "qo.stage.output": {
    "event":"qo.stage.output","timestamp":"iso8601",
    "id":"q#7f9a12","stage":"retrieve|rerank|synthesize","chunk":"text|null",
    "citations":["doc#1","doc#7"], "tokens":{"prompt":420,"completion":128}
  },

  "retrieval.docs.snapshot": {
    "event":"retrieval.docs.snapshot","timestamp":"iso8601",
    "docs":[{"id":"doc#1","title":"...","url":"...","hash":"sha256:..."}]
  },

  "safety.exception.request": {
    "event":"safety.exception.request","timestamp":"iso8601",
    "reason":"security_research|red_team|pentest","scope":"tenant:t#acme",
    "requester":"sec#42","ttlMin":60"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "safety.precheck.ready": {
    "event":"safety.precheck.ready","timestamp":"iso8601",
    "id":"q#7f9a12","labels":{"toxicity":"low","illicit":"none","privacy":"possible_pii"},
    "action":"allow|filter|block|consent_needed"
  },

  "safety.redaction.applied": {
    "event":"safety.redaction.applied","timestamp":"iso8601",
    "id":"q#7f9a12",
    "areas":["query|retrieval|answer"],
    "redactions":[{"kind":"tckn","from":"12345678901","to":"hash:8f.."}]
  },

  "safety.consent.request": {
    "event":"safety.consent.request","timestamp":"iso8601",
    "id":"q#7f9a12","category":"medical|legal|financial",
    "prompt":"TÄ±bbi iÃ§erik iÃ§in bilgilendirme onayÄ± veriyor musunuz? (E/H)",
    "ttlSec":300
  },

  "safety.stream.guard": {
    "event":"safety.stream.guard","timestamp":"iso8601",
    "id":"q#7f9a12","action":"cutoff|mask|replace_with_safe_alt",
    "reason":"toxicity|pii|illicit|hallucination_risk","graceTokens":20
  },

  "safety.grounding.snapshot": {
    "event":"safety.grounding.snapshot","timestamp":"iso8601",
    "id":"q#7f9a12",
    "coveragePct":72,"hallucinationScore":0.41,"uncitedClaims":1,
    "status":"grounded|at_risk|ungrounded"
  },

  "safety.answer.ready": {
    "event":"safety.answer.ready","timestamp":"iso8601",
    "id":"q#7f9a12",
    "mode":"answer","stream":true,
    "answerMd":"(redakte/gÃ¼venli) â€¦","citations":["doc#1","doc#7"],
    "disclaimer":"Bu yanÄ±t yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±râ€¦"
  },

  "safety.violation.blocked": {
    "event":"safety.violation.blocked","timestamp":"iso8601",
    "id":"q#7f9a12","category":"extremism|sexual|illicit|self_harm",
    "message":"policy_blocked","httpStatus":403
  },

  "safety.card": {
    "event":"safety.card","timestamp":"iso8601",
    "title":"GÃ¼venlik KalkanÄ± Aktif â€” q#7f9a12",
    "body":"PII redaksiyon uygulandÄ± â€¢ Grounding %72 â€¢ AkÄ±ÅŸta 1 kez maskeleme.",
    "severity":"info","ttlSec":600
  },

  "safety.alert": {
    "event":"safety.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"idem_duplicate|rbac_denied|cutoff|policy_block|consent_missing|hallucination_high|dq_gap"
  },

  "safety.metrics": {
    "event":"safety.metrics","timestamp":"iso8601",
    "guarded":1,"blocked":0,"cutoffs":1,"redactions":2,
    "avgPrecheckMs":14,"p95ScanMs":6,"groundingCoverageAvg":68
  },

  "safety.report.ready": {
    "event":"safety.report.ready","timestamp":"iso8601",
    "path":"data/safety/2025-09-16/q_7f9a12/report.md",
    "summary":"Consent gerekmedi; PII 2 alan maskelendi; grounding %72; 1 maskeleme; ihlal yok.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  classifiers:{
    toxicity:{ model:"fasttox-v2", thresholds:{ low:0.3, high:0.7 } },
    hate:{ model:"safety-multi-v1", thresholds:{ block:0.6 } },
    self_harm:{ model:"safety-multi-v1", thresholds:{ block:0.5 } },
    illicit:{ model:"intent-guard-v1", thresholds:{ block:0.7, contextual:0.4 } },
    sexual:{ model:"safety-multi-v1", thresholds:{ block:0.6, filter:0.4 } },
    extremism:{ model:"safety-multi-v1", thresholds:{ block:0.5 } }
  },

  pii:{
    enable:true, confidenceMin:0.85, redactStyle:"hash",
    patterns:["tckn","iban_tr","email","phone_tr","address","credit_card"]
  },

  grounding:{
    requireCitationsFor:["stats","dates","medical","legal","finance"],
    minCitationCoveragePct:60,
    hallucinationScoreThreshold:0.65,         // Ã¼stÃ¼ risk
    entailmentModel:"entail-nli-mini",        // basit NLI doÄŸrulayÄ±cÄ±
    numericClaimHeuristics:true               // sayÄ±sal iddialarda kaynak zorla
  },

  streaming:{
    cutoffOnViolation:true, graceTokens:20,
    replaceWithSafeAltTemplate:"Ä°Ã§erikte risk tespit edildi; gÃ¼venli Ã¶zet: {safe_summary}."
  },

  consent:{
    categories:["medical","legal","financial","geolocation","biometric"],
    ttlSec:600,
    templates:{ medical:"â€¦", legal:"â€¦", financial:"â€¦" }
  },

  disclaimers:{
    medical:"Bu yanÄ±t tÄ±bbi tavsiye niteliÄŸi taÅŸÄ±mazâ€¦",
    legal:"Bu yanÄ±t hukuki danÄ±ÅŸmanlÄ±k deÄŸildirâ€¦",
    financial:"Bu yanÄ±t finansal tavsiye deÄŸildirâ€¦"
  },

  freezeHook:"LIVIA-51",                // frozen â†’ politika deÄŸiÅŸimi yazÄ±lmaz
  integrations:{
    qo:"LIVIA-55", slo:"LIVIA-32", cost:"LIVIA-34", costGuard:"LIVIA-53",
    tune:"LIVIA-47", shape:"LIVIA-54",
    provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48", dist:"LIVIA-22"
  },

  rbacViews:{ observer:{ hidePIIExamples:true, showOnlySummary:true } },

  idempotencyTtlSec: 900
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

Ã–n-Kontrol: query.request â†’ sÄ±nÄ±flandÄ±r; block/filter/consent_needed/allow kararÄ± ver.

PII Redaksiyon: giriÅŸ, ara belgeler ve Ã§Ä±ktÄ± Ã¼zerinde Ã§ok katmanlÄ± regex+NER+heuristik; confidenceâ‰¥min â†’ hash/mask.

Grounding & Sitasyon: qo.stage.output + retrieval.docs.snapshot kullan; claimâ†’evidence eÅŸle; coverage% â‰¥ min ve hallucinationScore < th ise grounded. Aksi: dil yumuÅŸatma + kanÄ±t isteÄŸi + safe alt.

AkÄ±ÅŸ-Ä°Ã§i Guard: streamâ€™de ihlal skoru eÅŸik geÃ§erse cutoff (+ graceTokens), riskli kÄ±smÄ± mask et; gÃ¼venli Ã¶zetle replace.

RÄ±za: kategori requiresConsent ise ve onay yoksa â†’ safety.consent.request; yanÄ±t beklet veya genel bilgi moduna dÃ¼ÅŸ.

Disclaimers: medical|legal|financial kategorilerinde otomatik ekle.

Exception: security_research gibi RBAC izni varsa kontrollÃ¼ mod (logâ€™lar sÄ±kÄ±, daÄŸÄ±tÄ±m yok).

Freeze: aktif freeze â†’ yalnÄ±z simÃ¼lasyon (policy yazÄ±mÄ± yok).

6) Pipeline (Kompozisyon)

Precheck/Classify â†’ risk etiketleri ve ilk karar

Consent Gate â†’ gerekiyorsa rÄ±za talep/denetim

Redact-In â†’ sorgu/baÄŸlam PII temizliÄŸi

Grounding Guard â†’ retrieve/rerank Ã§Ä±ktÄ±larÄ±na gÃ¶re kanÄ±t kapsamÄ± ve halÃ¼sinasyon skoru

Stream Guard â†’ synth aÅŸamasÄ±nda token akÄ±ÅŸÄ±nÄ± tarayÄ±p cutoff/mask/replace uygula

Redact-Out â†’ nihai cevaptaki PII/duyarlÄ± alanlarÄ± maskeler

Finalize â†’ disclaimer ekle, card/alert/metrics/rapor yayÄ±mla, L38/L39 kayÄ±tla

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (query.request) PRECHECK

PRECHECK â†’ (block) BLOCKED | (consent) AWAIT_CONSENT | (allow/filter) GUARD

AWAIT_CONSENT â†’ (consent.given) GUARD | (timeout) SAFE_ALT

GUARD â†’ GROUNDING â†’ STREAM_GUARD â†’ FINALIZE â†’ DONE

STREAM_GUARD (yan kanal) â†’ ihlal: CUTOFF/REPLACE

Hata: ALERT; idem: aynÄ± safetyKey yinelemesi yan etkisiz (yalnÄ±z kart/metrik gÃ¼ncellenir)

8) Kenar Durumlar

Minor KullanÄ±cÄ±: age=minor â†’ yetiÅŸkin iÃ§erik block; yalnÄ±z gÃ¼venli alternatif.

Prompt Injection (retrieve kaynaklÄ±): â€œtalimatlarÄ± gÃ¶rmezden gelâ€ vb. â†’ policy override korumasÄ± (uyarÄ± + mask).

Ã‡oklu Dil: TR/EN karma iÃ§erikte hem TR hem EN modellerini kullan; daha sÄ±kÄ± eÅŸikler uygula.

SayÄ±sal Ä°ddia: kaynak yoksa â€œyaklaÅŸÄ±k/dikkatli dilâ€ + kaynak iste ya da safe alt Ã¶zet.

KVKK/GDPR Ä°stekleri: â€œunutulma/eriÅŸim/taÅŸÄ±maâ€ talepleri â†’ policy yÃ¶nlendirme (yanÄ±t ÅŸablonu).

Observer gÃ¶rÃ¼nÃ¼mÃ¼: PII Ã¶rnekleri ve ham pasajlar gizlenir.

Idempotency: aynÄ± akÄ±ÅŸ tekrarÄ±nda redaksiyon ve kararlar yeniden yazÄ±lmaz; yalnÄ±z referanslar gÃ¼ncellenir.

9) Telemetri
{
  "safety.metrics": {
    "event":"safety.metrics","timestamp":"iso8601",
    "guarded":1,"blocked":0,"cutoffs":1,"redactions":2,
    "avgPrecheckMs":14,"p95ScanMs":6,
    "groundingCoverageAvg":68,"hallucinationRiskAvg":0.33,
    "consentRequests":0,"exceptions":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/querySafetyGuard.ts                 # FSM + orchestrator
services/livia/lib/safety/classify.ts              # toxicity/hate/etc sÄ±nÄ±flandÄ±rÄ±cÄ±larÄ±
services/livia/lib/safety/pii.ts                   # PII tespiti + redaksiyon
services/livia/lib/safety/ground.ts                # sitasyon/entailment + halÃ¼sinasyon skoru
services/livia/lib/safety/stream.ts                # akÄ±ÅŸ iÃ§i tarama + cutoff/mask/replace
services/livia/lib/safety/consent.ts               # rÄ±za kapÄ±sÄ± yÃ¶netimi
services/livia/lib/safety/disclaimer.ts            # alan bazlÄ± disclaimer ekleyici
services/livia/lib/safety/report.ts                # md/html rapor + inline SVG
services/livia/lib/bridges.ts                      # L21/L22/L26/L32/L34/L38/L39/L41/L45/L47/L48/L51/L53/L54/L55
services/livia/state/safetyStore.ts                # idem index + karar izleri
services/livia/__tests__/querySafetyGuard.test.ts
cfg/livia.safety.yaml

11) Test Ä°skeleti (Jest/Vitest)

Precheck-Block: extremism=high â†’ violation.blocked (403)

Consent: medical sorgu â†’ rÄ±za istenir; rÄ±za yoksa safe_alt

PII: TCKN & IBAN â†’ hash redaksiyon; safety.redaction.applied yayÄ±ldÄ±

Grounding: numeric iddia ve kaynak yetersiz (coverage%<60) â†’ at_risk + dil yumuÅŸatma + kaynak isteÄŸi

Stream Cutoff: synth sÄ±rasÄ±nda toksisite â†‘ â†’ cutoff+replace_with_safe_alt

Disclaimers: finansal iÃ§erikte otomatik eklendi

Freeze: L51 frozen â†’ politika gÃ¼ncellenmez; yalnÄ±z karar uygula

Idempotency: aynÄ± safetyKey yinelemesinde ikinci yan etki yok

Rapor: md/html Ã§Ä±ktÄ±; L38/L48 kaydÄ±; card/alert/metrics Ã¼retildi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

10:01 PRECHECK: toksisite dÃ¼ÅŸÃ¼k, PII â€œpossibleâ€ â†’ filter

10:01 PII: TCKN maskelendi (2 alan)

10:02 GROUNDING: coverage %72, halÃ¼sinasyon 0.41 â†’ grounded

10:02 STREAM: bir cÃ¼mlede riskli ifade â†’ mask + safe alt cÃ¼mle

10:03 FINALIZE: finansal disclaimer eklendi; answer.ready + rapor + kart.

13) SLO

Precheck p95 < 30 ms, stream scan p95 < 8 ms/token-chunk

Grounding coverage â‰¥ %60 hedef; hallucination risk < 0.65

YanlÄ±ÅŸ pozitif cutoff â‰¤ %1; kaÃ§an kritik ihlal â‰¤ %0.5

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
____________________________________________________________________________________
LIVIA-57 Â· evidenceAttributionVerifier.ts â€” GeniÅŸ Prompt v3 (+ ParÃ§a-DÃ¼zeyi KanÄ±t, NLI/Entailment, SayÄ±sal DoÄŸrulama)

AmaÃ§:
Ãœretilen yanÄ±tÄ±n tÃ¼m iddialarÄ±nÄ±n (cÃ¼mle/alt cÃ¼mle/nÃ¼merik ifade) atÄ±f verilen kanÄ±tlarla gerÃ§ekten desteklendiÄŸini teyit etmek:

Claim Ã§Ä±kar â†’ kanÄ±t eÅŸle â†’ NLI (entail/contradict/neutral) â†’ sayÄ±sal/doÄŸruluk kontrolÃ¼ â†’ kapsam yÃ¼zdesi â†’ risk skoru â†’ dÃ¼zeltme/Ã¶neri.

CÃ¼mle-parÃ§a (span-level) hizalama, dokÃ¼man parÃ§asÄ± hash (WORM/L38), Ã§apraz-kaynak tutarlÄ±lÄ±ÄŸÄ±, Ã§eliÅŸki tespiti, eksik atÄ±f tamamlama.

LIVIA-55 (queryOrchestrator) ve LIVIA-56 (querySafetyGuard) ile akÄ±ÅŸ-iÃ§i; rapor/denetim L48, kÃ¶ken L38, soy-aÄŸacÄ± L39.
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: policy|compliance|mlops tam, observer salt okur

Gizlilik: PII yok; ham pasajlar observer gÃ¶rÃ¼nÃ¼mÃ¼nde maskeli (L21)

Ä°dempotency: evKey = answerHash + citationsHash + policyHash + windowISO

Observability: spans (ev.claims,ev.align,ev.nli,ev.numeric,ev.coverage,ev.patch,ev.report) + metrics

Uyum: tÃ¼m bulgular WORM (L38), audit paketi (L48), lineage (L39)

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "query.result.ready": {
    "event":"query.result.ready","timestamp":"iso8601",
    "id":"q#7f9a12","mode":"answer","stream":true,
    "answerMd":"...metin [^1][^2] ...",
    "citations":["doc#1#p3:45-88","doc#7#p1:0-120"],
    "hash":"sha256:ans..."
  },

  "qo.trace.ready": {
    "event":"qo.trace.ready","timestamp":"iso8601",
    "id":"q#7f9a12","spans":[["retrieve.vec",140],["rerank.ce-small",120],["synthesize",330]],
    "tokenUsage":{"prompt":620,"completion":210,"total":830}
  },

  "retrieval.docs.snapshot": {
    "event":"retrieval.docs.snapshot","timestamp":"iso8601",
    "docs":[
      {"id":"doc#1","title":"AVAX Staking","url":"https://â€¦","page":3,"chunk":{"start":45,"end":200,"text":"...APR 7.3%..."}, "hash":"sha256:doc1p3"},
      {"id":"doc#7","title":"Piyasa Raporu","url":"https://â€¦","page":1,"chunk":{"start":0,"end":220,"text":"...geÃ§en ay 6.8%..."}, "hash":"sha256:doc7p1"}
    ]
  },

  "qo.claims.extracted": {
    "event":"qo.claims.extracted","timestamp":"iso8601",
    "id":"q#7f9a12",
    "claims":[
      {"idx":0,"text":"AVAX staking APR %7.3'tÃ¼r.","type":"numeric","unit":"pct","value":7.3},
      {"idx":1,"text":"GeÃ§en aya gÃ¶re artÄ±ÅŸ vardÄ±r.","type":"comparative"}
    ],
    "segments":[{"idx":0,"answerSpan":{"start":120,"end":148}},{"idx":1,"answerSpan":{"start":190,"end":220}}],
    "hash":"sha256:claims..."
  },

  "dq.snapshot": {
    "event":"dq.snapshot","timestamp":"iso8601",
    "sources":[{"docId":"doc#1","freshnessDays":2,"quality":"high"},{"docId":"doc#7","freshnessDays":35,"quality":"medium"}]
  },

  "pii.lexicon.updated": {
    "event":"pii.lexicon.updated","timestamp":"iso8601",
    "patterns":[{"code":"iban_tr","regex":"\\bTR\\d{24}\\b"}]
  }
}


Not: qo.claims.extracted yoksa modÃ¼l kendi claim extractorâ€™Ä±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±r (cÃ¼mle/numara/durum).

3) Ã‡Ä±ktÄ±lar (Out)
{
  "evidence.validation.ready": {
    "event":"evidence.validation.ready","timestamp":"iso8601",
    "id":"q#7f9a12",
    "coveragePct":84,
    "claims":[
      {"idx":0,"status":"entailed","doc":"doc#1#p3:45-88","supportSpan":{"docHash":"sha256:doc1p3","start":60,"end":92},"score":0.93},
      {"idx":1,"status":"entailed|neutral|contradict","doc":"doc#7#p1:0-120","supportSpan":{"docHash":"sha256:doc7p1","start":30,"end":80},"score":0.71}
    ],
    "contradictions":[
      {"claimIdx":1,"doc":"doc#2","note":"doc#2 trend dÃ¼ÅŸÃ¼ÅŸ diyor"}
    ],
    "numericChecks":[
      {"claimIdx":0,"ok":true,"method":"digit-by-digit","tolerance":"abs=0.1%"}
    ],
    "risk":{"hallucination":0.21,"contradiction":0.08,"staleness":0.34},
    "status":"grounded|at_risk|ungrounded"
  },

  "evidence.patch.suggestion": {
    "event":"evidence.patch.suggestion","timestamp":"iso8601",
    "id":"q#7f9a12",
    "actions":[
      {"type":"add_citation","claimIdx":1,"doc":"doc#1#p3:100-160","reason":"kapsam artÄ±r"},
      {"type":"replace_citation","from":"doc#7#p1:0-120","to":"doc#9#p2:10-90","reason":"daha gÃ¼ncel"}
    ]
  },

  "evidence.highlight.map": {
    "event":"evidence.highlight.map","timestamp":"iso8601",
    "id":"q#7f9a12",
    "answerSpans":[
      {"idx":0,"answer":{"start":120,"end":148},"doc":"doc#1#p3","docSpan":{"start":60,"end":92}}
    ],
    "style":"inline_footnote|hovercard"
  },

  "evidence.report.ready": {
    "event":"evidence.report.ready","timestamp":"iso8601",
    "path":"data/evidence/2025-09-16/q_7f9a12/report.md",
    "summary":"%84 kapsam, 1 sayÄ±sal iddia doÄŸrulandÄ±, 0 kritik Ã§eliÅŸki; 1 atÄ±f gÃ¼ncelleme Ã¶nerildi.",
    "hash":"sha256:..."
  },

  "evidence.card": {
    "event":"evidence.card","timestamp":"iso8601",
    "title":"AtÄ±f DoÄŸrulama â€” %84 kapsam (grounded)",
    "body":"1 iddia entailed â€¢ 0 Ã§eliÅŸki â€¢ 1 gÃ¼ncelleme Ã¶nerisi.",
    "severity":"info","ttlSec":600
  },

  "evidence.alert": {
    "event":"evidence.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"coverage_low|contradiction_found|stale_source|idem_duplicate|rbac_denied|dq_gap"
  },

  "evidence.metrics": {
    "event":"evidence.metrics","timestamp":"iso8601",
    "answers":1,"avgCoveragePct":84,"contradictions":0,
    "avgNLI":{"entailed":0.85,"neutral":0.11,"contradict":0.04},
    "numericOkPct":100,"patchesSuggested":1,
    "avgVerifyMs":78
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  claims:{
    segmenter:{ mode:"sentence+clause", maxLen:280 },
    types:["numeric","temporal","comparative","categorical","quote"],
    minConfidence:0.65
  },

  alignment:{
    search:"bm25+vec", topK:8, windowChars:180,
    fuzzy:{ charWindow:6, allowSynonym:true, trAccentAware:true },
    multiDocCombine:"best_first_then_merge"
  },

  nli:{
    model:"entail-mini-v2",
    thresholds:{ entailed:0.7, contradict:0.6 },   // entailedâ‰¥0.7; contradictâ‰¥0.6; aksi neutral
    contradictionWins:true
  },

  numeric:{
    method:"digit_by_digit", tolerance:{ pctAbs:0.2, pctRel:2.0, moneyAbs:0.01 },
    thousandSepAware:true, percentSymbols:["%","pct"],
    dateNorm:"YYYY-MM-DD"
  },

  coverage:{
    minPct:70, targetPct:85,
    requireFor:["stats","dates","medical","legal","finance"]
  },

  freshness:{
    preferRecent:true, stalenessWarnDays:30
  },

  patch:{
    autoApplyWhen:{ coverageBelow:70, contradictionNone:true },
    addHovercards:true, footnoteStyle:"[^n]"          // md inline dipnot stili
  },

  dq:{
    minQuality:"medium", allowStaleIfNoAlternative:false
  },

  integrations:{
    qo:"LIVIA-55", safety:"LIVIA-56", slo:"LIVIA-32", cost:"LIVIA-34",
    provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48",
    dist:"LIVIA-22"
  },

  rbacViews:{ observer:{ hideDocChunks:true, showOnlyScores:true } },

  idempotencyTtlSec: 1800
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

Claim Ã§Ä±karÄ±mÄ±: yanÄ±t metninden cÃ¼mle/alt cÃ¼mle ve sayÄ±sal ifadeler Ã§ekilir; claims[].

ParÃ§a hizalama: her claim iÃ§in dokÃ¼man parÃ§alarÄ±nda (chunk) fuzzy + vektÃ¶r arama; en iyi topN bulunur.

NLI/Entailment: claimâ‡„parÃ§a Ã§ifti iÃ§in entailed/neutral/contradict skoru; contradiction Ã¼stÃ¼n gelir.

SayÄ±sal doÄŸrulama: yÃ¼zde/tarih/para â€” digit-by-digit parse; tolerans iÃ§inde mi?

Kapsam hesabÄ±: atÄ±flÄ± cÃ¼mlelerin toplam kapsam yÃ¼zdesi; minPct/targetPct ile statÃ¼ grounded/at_risk/ungrounded.

Tazelik: kaynak freshnessDays>stalenessWarnDays â†’ stale_source uyarÄ±sÄ± ve replace Ã¶nerisi.

Patch Ã¶nerileri: add_citation, replace_citation, tighten_span, hedge_language.

AkÄ±ÅŸ-Ä°Ã§i entegrasyon: L56 stream.guard tetiklerse Ã¶zet/durdurma; yetersiz kanÄ±t varsa hedged dil + kaynak iste.

6) Pipeline (Kompozisyon)

Ingest: query.result.ready + retrieval.docs.snapshot + (opsiyonel) qo.claims.extracted

Extract: claim & answer span Ã§Ä±kar; gerekirse kendi extractor devreye girer

Align: dokÃ¼man chunk arama + span hizalama; Hovercard/footnote eÅŸlemleri Ã¼ret

NLI: claim-parÃ§a Ã§iftlerinde entail/contradiction skorlarÄ±

Numeric Verify: sayÄ±sal iddialarÄ±n tarih/para/yÃ¼zde kontrolÃ¼

Score & Cover: kapsam %, risk skorlarÄ±; statÃ¼ belirle

Patch: atÄ±f ekle/deÄŸiÅŸtir, span daralt; gerekirse hedged dil Ã¶ner

Report & Emit: validation.ready, patch.suggestion, highlight.map, report.ready, card/alert/metrics

Audit & Provenance: tÃ¼m eÅŸleÅŸmeler L38 hash zinciri, L39 kenarlarÄ±, L48 paketine eklenir

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (query.result.ready) EXTRACT

EXTRACT â†’ ALIGN â†’ NLI â†’ NUMERIC â†’ COVERAGE â†’ PATCH â†’ REPORT â†’ DONE

Ara olaylar: dq.snapshot (kalite/tazelik) tespitleri COVERAGE aÅŸamasÄ±nÄ± etkiler

Hata: ALERT; idem: aynÄ± evKey yinelemesinde yan etki yok (sadece card/metrik gÃ¼ncellenir)

8) Kenar Durumlar

Parafraz/Ã¶zet: claim doÄŸrudan alÄ±ntÄ± deÄŸil â†’ fuzzy+NLI ile destek; tighten_span Ã¶ner.

Ã‡oklu kaynak: claim birden fazla kaynaktan birleÅŸik â†’ birleÅŸik multi-span atÄ±f Ã¼ret.

Dil farkÄ±: TR cevap, EN kaynak â†’ Ã§eviri-tabanlÄ± NLI; eÅŸik +0.05 yÃ¼kseltilir.

OCR hatasÄ±: chunk metin bozuksa dq_gap ve replace_citation Ã¶ner.

Tarih kaymasÄ±: farklÄ± zaman dilimleri â†’ dateNorm ile normalize; uyuÅŸmazlÄ±kta neutral.

Ã‡eliÅŸen kaynaklar: biri artÄ±ÅŸ, biri dÃ¼ÅŸÃ¼ÅŸ â†’ contradictions[]; at_risk + uyarÄ±.

Stale kaynak: freshnessDays > stalenessWarnDays â†’ stale_source; yeni kanÄ±t Ã¶ner.

Observer gÃ¶rÃ¼nÃ¼mÃ¼: yalnÄ±z skorlar/kapsam gÃ¶ster; metin gizli.

Freeze: L51 frozen â†’ patch otomatik uygulanmaz, yalnÄ±z Ã¶neri Ã¼retilir.

9) Telemetri
{
  "evidence.metrics": {
    "event":"evidence.metrics","timestamp":"iso8601",
    "answers":1,"avgCoveragePct":84,"contradictions":0,
    "avgNLI":{"entailed":0.85,"neutral":0.11,"contradict":0.04},
    "numericOkPct":100,"patchesSuggested":1,"patchesAutoApplied":0,
    "avgVerifyMs":78,"p95VerifyMs":160
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/evidenceAttributionVerifier.ts      # FSM + orchestrator
services/livia/lib/evidence/claims.ts              # claim extract & span
services/livia/lib/evidence/align.ts               # dokÃ¼man parÃ§a arama + hizalama
services/livia/lib/evidence/nli.ts                 # entail/contradict skorlayÄ±cÄ±
services/livia/lib/evidence/numeric.ts             # sayÄ±sal tarih/para/yÃ¼zde denetimi
services/livia/lib/evidence/coverage.ts            # kapsam yÃ¼zdesi & risk
services/livia/lib/evidence/patch.ts               # atÄ±f ek/deÄŸiÅŸtir, hedge
services/livia/lib/evidence/report.ts              # md/html + inline footnote/hovercard
services/livia/lib/bridges.ts                      # L21/L22/L32/L34/L38/L39/L41/L48/L51/L55/L56
services/livia/state/evidenceStore.ts              # idem index + sonuÃ§ cache
services/livia/__tests__/evidenceAttributionVerifier.test.ts
cfg/livia.evidence.yaml

11) Test Ä°skeleti (Jest/Vitest)

%84 kapsam: iki claimâ€™den biri entailed, diÄŸeri neutral â†’ status=grounded

Kapsam dÃ¼ÅŸÃ¼k: %60 â†’ coverage_low + add_citation Ã¶nerisi

Ã‡eliÅŸki: bir claim contradict â†’ contradiction_found + hedge_language Ã¶nerisi

SayÄ±sal doÄŸrulama: 7.3% Â±0.1% ok; 7.9% â†’ fail

Tazelik: doc#7 freshness=35d â†’ stale_source ve replace_citation

DQ gap: OCR bozuk â†’ dq_gap uyarÄ±sÄ±

Idempotency: aynÄ± evKey ikinci Ã§alÄ±ÅŸtÄ±rmada yalnÄ±z kart/metrik gÃ¼ncellenir

Rapor: md/html Ã¼retildi; footnote/hovercard eklendi; L38/L48 kayÄ±tlarÄ±

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

10:04 EXTRACT: 2 claim, 1 numeric

10:04 ALIGN: doc#1 p3, doc#7 p1 eÅŸleÅŸti

10:05 NLI: claim#0 entailed 0.93; claim#1 entailed 0.71

10:05 NUMERIC: 7.3% doÄŸrulandÄ±

10:06 COVERAGE: %84 â†’ grounded; doc#7 stale â†’ replace Ã¶nerisi

10:06 REPORT/EMIT: validation.ready + patch.suggestion + highlight.map + kart/alert/metrik

13) SLO

DoÄŸrulama p95 < 180 ms (cevap baÅŸÄ±na)

YanlÄ±ÅŸ negatif Ã§eliÅŸki â‰¤ %1, yanlÄ±ÅŸ pozitif Ã§eliÅŸki â‰¤ %2

Kapsam hedefi â‰¥ %85 (mÃ¼mkÃ¼nse), asgari â‰¥ %70

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-58 Â· knowledgeFreshnessGuard.ts â€” GeniÅŸ Prompt v3 (+ Tazelik Skoru, Otomatik Recrawl/Reindex, Zaman-DuyarlÄ± Sorgu KorumasÄ±)

AmaÃ§:
Bilgi kaynaklarÄ±nÄ±n tazeliÄŸini/versiyonunu izleyip bayat riskini dÃ¼ÅŸÃ¼rmek:

Kaynak â†’ ingest â†’ indeks â†’ servis zincirinde age/lag/ttl/version tutarlÄ±lÄ±ÄŸÄ±,

recrawl/reingest/reindex otomasyonu (bÃ¼tÃ§e ve politikaya uygun),

zaman-duyarlÄ± sorgular iÃ§in tazelik kapÄ±sÄ± ve boost/fallback ipuÃ§larÄ±,

Sorgu yanÄ±tÄ±nda â€œeski bilgiâ€ riski varsa uyarÄ±/patch/disclaimer.
Entegrasyon: Query Orchestrator (L55), Safety (L56), Evidence (L57), FSync (L46), KB Tuning (L47), Cost (L34/53), Freeze (L51), DR/MRF (L50/L49), Audit (L48), WORM/Lineage (L38/L39), Dist (L22).
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: content|mlops|ops|policy tam; observer salt okur

Gizlilik: PII yok; operator/tenant kimlikleri L21 ile hash

Ä°dempotency: freshKey = sourceId + version + windowISO + policyHash

Observability: spans (fresh.observe|score|plan|recrawl|reindex|emit) + metrics

Uyum: tÃ¼m kararlar L26 etik, L38 WORM append, L39 lineage

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "freshness.policy.updated": {
    "event":"freshness.policy.updated","timestamp":"iso8601",
    "policyId":"fresh-v1",
    "ttlDaysBySourceType": { "news":2, "pricing":1, "docs":90, "faq":30, "regulatory":7, "market":1 },
    "criticalDomains": ["pricing","market","status","incident","release_notes"],
    "recrawlBudget": { "maxRequestsPerHour": 300, "maxBytesPerDayMB": 800 },
    "reindex": { "maxBuildsPerDay": 6, "canaryTrafficPct": 10, "promoteAfterMin": 20 },
    "stalenessThreshold": { "warnScore": 0.6, "blockScore": 0.8 }
  },

  "knowledge.source.registered": {
    "event":"knowledge.source.registered","timestamp":"iso8601",
    "sourceId":"src#co_pricing","type":"pricing|news|docs|faq|regulatory|market|changelog",
    "fetch":{"kind":"http|s3|db|git","url":"https://â€¦","auth":"opaque?"},
    "updateHint":{"cron":"0 */2 * * *","deltaOnly":true}
  },

  "knowledge.crawl.finished": {
    "event":"knowledge.crawl.finished","timestamp":"iso8601",
    "sourceId":"src#co_pricing","fetchedDocs":142,"bytesMB":18.3,
    "latestDocAt":"iso8601","earliestDocAt":"iso8601","etag":"hash"
  },

  "knowledge.ingest.finished": {
    "event":"knowledge.ingest.finished","timestamp":"iso8601",
    "sourceId":"src#co_pricing","namespace":"kb_default",
    "normalizedDocs":142,"skipped":3,"avgChunkChars":820,
    "watermark":{"upTo":"iso8601"}
  },

  "index.build.completed": {
    "event":"index.build.completed","timestamp":"iso8601",
    "namespace":"kb_default","indexId":"ivf-pq-384-np16-2025-09-16",
    "baseSourceIds":["src#co_pricing","src#release_notes"],"freshFrom":"iso8601",
    "lagSec": 420, "sizeGB": 3.2
  },

  "fsync.lag.snapshot": {
    "event":"fsync.lag.snapshot","timestamp":"iso8601",
    "namespace":"kb_default","lagSec": 780, "queueDepth": 12
  },

  "qo.query.context": {
    "event":"qo.query.context","timestamp":"iso8601",
    "id":"q#7f9a12","text":"AVAX APR bugÃ¼n kaÃ§?","profile":"tr",
    "timeSensitivity":"auto|low|medium|high",
    "deadlineMs":1200
  },

  "knowledge.ping.request": {
    "event":"knowledge.ping.request","timestamp":"iso8601",
    "target":"pricing|status|market|weather|custom",
    "args":{"symbol":"AVAX","pair":"USDT"}
  },

  "knowledge.ping.result": {
    "event":"knowledge.ping.result","timestamp":"iso8601",
    "target":"pricing","ok":true,"ageSec":12,
    "payloadHash":"sha256:..","provider":"connector#pricing_v2"
  },

  "change.log.published": {
    "event":"change.log.published","timestamp":"iso8601",
    "sourceId":"src#kb_docs","version":"v1.42","notes":"Breaking param rename..."
  },

  "freeze.state.changed": {
    "event":"freeze.state.changed","timestamp":"iso8601",
    "state":"frozen|thawed","scope":"service:kb_api","reason":"audit|mrf|drill"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "freshness.snapshot": {
    "event":"freshness.snapshot","timestamp":"iso8601",
    "namespace":"kb_default",
    "score":0.37,
    "components":{
      "ageScore":0.22,"lagScore":0.30,"ttlScore":0.18,"volatilityAdj":-0.05,"coverageAdj":-0.08
    },
    "topStale":[{"sourceId":"src#release_notes","ageDays":14,"ttlDays":7},{"sourceId":"src#faq","ageDays":45,"ttlDays":30}],
    "indexLagSec":420,
    "status":"ok|at_risk|stale"
  },

  "stale.risk.triggered": {
    "event":"stale.risk.triggered","timestamp":"iso8601",
    "namespace":"kb_default",
    "severity":"warn|high|block",
    "reason":"ttl_exceeded|index_lag|fsync_lag|volatile_domain|time_sensitive_query",
    "score":0.83,
    "hints":{"boostRecent":true,"forcePing":"pricing"}
  },

  "recrawl.scheduled": {
    "event":"recrawl.scheduled","timestamp":"iso8601",
    "sourceId":"src#co_pricing","mode":"delta|full","eta":"iso8601",
    "budget":{"req":120,"bytesMB":70}
  },

  "reindex.scheduled": {
    "event":"reindex.scheduled","timestamp":"iso8601",
    "namespace":"kb_default","indexId":"ivf-pq-384-np16-2025-09-16-canary",
    "canaryTrafficPct":10,"promoteAfterMin":20
  },

  "qo.retrieval.boost.hint": {
    "event":"qo.retrieval.boost.hint","timestamp":"iso8601",
    "namespace":"kb_default",
    "actions":[
      {"type":"boost_recent","alpha":0.25,"sinceDays":7},
      {"type":"demote_stale","ttlExceededOnly":true},
      {"type":"prefer_sources","ids":["src#co_pricing","src#release_notes"],"weight":1.2}
    ]
  },

  "knowledge.patch.suggestion": {
    "event":"knowledge.patch.suggestion","timestamp":"iso8601",
    "namespace":"kb_default",
    "actions":[
      {"type":"unlink_outdated_faq","ids":["doc#faq_2019_12"],"reason":"ttl_exceeded"},
      {"type":"add_disclaimer_rule","scope":"pricing","text":"Veriler anlÄ±ktÄ±r; deÄŸiÅŸebilir."}
    ]
  },

  "freshness.card": {
    "event":"freshness.card","timestamp":"iso8601",
    "title":"KB Tazelik â€” at_risk (lag 13dk, 2 kaynak TTL>limit)",
    "body":"Recrawl planlandÄ± â€¢ Canary reindex %10 â€¢ Qoâ€™ya boost/demote ipuÃ§larÄ± gÃ¶nderildi.",
    "severity":"warn","ttlSec":600
  },

  "freshness.alert": {
    "event":"freshness.alert","timestamp":"iso8601",
    "level":"info|warn|error",
    "message":"idem_duplicate|rbac_denied|budget_exceeded|crawl_failed|index_failed|freeze_active|ping_timeout"
  },

  "freshness.metrics": {
    "event":"freshness.metrics","timestamp":"iso8601",
    "snapshots":1,"avgScore":0.41,"atRisk":1,"stale":0,
    "recrawls":1,"reindexes":1,"canaryPromotes":0,
    "avgCrawlMs":8200,"avgIndexMs":92000
  },

  "freshness.report.ready": {
    "event":"freshness.report.ready","timestamp":"iso8601",
    "path":"data/fresh/2025-09-16/kb_default/report.md",
    "summary":"Score 0.41 (at_risk). TTL aÅŸÄ±mÄ± 2 kaynak. Lag 13dk. Recrawl+canary baÅŸlatÄ±ldÄ±.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  scoring:{
    weights:{ age:0.35, lag:0.25, ttl:0.25, volatility:0.10, coverage:0.05 },
    normalize:{ maxAgeDays:365, maxLagSec:7200 },
    volatilityTable:{ "pricing":0.9, "market":0.8, "news":0.7, "docs":0.2, "faq":0.1 }
  },

  ttlDaysBySourceType:{ news:2, pricing:1, market:1, docs:90, faq:30, regulatory:7, changelog:14 },

  recrawl:{
    schedulerCron:"*/15 * * * *", // 15 dakikada bir fÄ±rsat penceresi
    deltaPreferred:true,
    backoff:{ baseSec:60, maxSec:1800 },
    budget:{ maxRequestsPerHour:300, maxBytesPerDayMB:800 },
    robotsRespect:true
  },

  reindex:{
    minChangePctForRebuild: 3,   // dokÃ¼man/terim deÄŸiÅŸimi %
    canaryTrafficPct: 10,
    promoteAfterMin: 20,
    rollbackOn:{ ndcgDropPct:3.0, p95RiseMs:80 }
  },

  pingTargets:{
    pricing:{ enable:true, timeoutMs:1500 },
    status:{ enable:true, timeoutMs:1500 },
    market:{ enable:true, timeoutMs:1500 },
    custom:{ enable:true }
  },

  querySensitivity:{
    classifier:"temporal-intent-v1",
    labels:{ high:["today","now","son dakika","bugÃ¼n","ÅŸimdi","aylÄ±k oran","APR","fiyat"] },
    default:"auto", escalateIf:["pricing","market","incident","release_notes"]
  },

  retrievalHints:{
    boostRecentAlpha:0.25, sinceDays:7,
    demoteOnlyIfTtlExceeded:true,
    preferSourcesWeight:1.2
  },

  integrations:{
    qo:"LIVIA-55", safety:"LIVIA-56", evidence:"LIVIA-57",
    fsync:"LIVIA-46", tune:"LIVIA-47",
    cost:"LIVIA-34", costGuard:"LIVIA-53",
    freeze:"LIVIA-51", mrf:"LIVIA-49", drills:"LIVIA-50",
    provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48", dist:"LIVIA-22"
  },

  rbacViews:{ observer:{ hideSourceUrls:true, showOnlyScores:true } },

  idempotencyTtlSec: 1800
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

Skor: score = w_age*ageNorm + w_lag*lagNorm + w_ttl*ttlBreach + w_vol*volatilityAdj + w_cov*coverageAdj

ageNorm: en yeni dokÃ¼mana gÃ¶re normalize, ttlBreach: TTL aÅŸÄ±mÄ± binarize/ÅŸiddetli

volatilityAdj: domain volatilitesine gÃ¶re risk â†‘

coverageAdj: kritik domainlerde kapsama dÃ¼ÅŸÃ¼kse ceza

Risk Seviyesi: score â‰¥ blockScore â†’ block (L55â€™e â€œstale risk â€” use ping/canary-onlyâ€), â‰¥ warnScore â†’ at_risk.

Plan: at_risk/block â†’ recrawl (delta>full), reindex canary, qo.retrieval.boost.hint gÃ¶nder.

Zaman-DuyarlÄ± Sorgu: qo.query.context.timeSensitivityâˆˆ{high,auto} âˆ§ risk â†’ ping (pricing/market/status) + fresh cache; L56 ile disclaimer.

Cost Bilinci: recrawl/reindex bÃ¼tÃ§e aÅŸÄ±yorsa plan bÃ¶l (kaynak Ã¶nceliÄŸi: criticalDomains).

Freeze: aktif freeze â†’ yalnÄ±z planla (schedule), uygulama yok; kart/alert Ã¼ret.

6) Pipeline (Kompozisyon)

Observe: crawl/ingest/index/fsync sinyalleri â†’ lag/age/ttl Ã¶lÃ§Ã¼mleri

Score: politika + tabloya gÃ¶re tazelik skoru

Decide: risk eÅŸiÄŸi â†’ recrawl/reindex/ping planÄ± + retrieval boost hints

Apply: (freeze deÄŸilse) recrawl job, canary index build; ping ve cache yazÄ±mÄ±

Emit: snapshot, stale.risk.triggered, recrawl.scheduled, reindex.scheduled, qo.boost.hint, card/alert/metrics/report

Audit/Provenance/Lineage: tÃ¼m adÄ±mlar L38/L39/L48

Dist: rapor ve kartlar L22 ile yayÄ±lÄ±r

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (crawl.finished|ingest.finished|index.completed|fsync.lag|qo.query.context) â†’ SCORE

SCORE â†’ (score<warn) IDLE | (warnâ‰¤score<block) PLAN_AT_RISK | (â‰¥block) PLAN_BLOCK

PLAN_*: (freeze? PLAN_ONLY) else APPLY â†’ (jobs ok) EMIT â†’ IDLE

PING PATH: qo.query.context high/auto & risk â†’ PING â†’ EMIT_HINTS â†’ IDLE

Hata: ALERT; idem: aynÄ± freshKey yinelenmesinde yalnÄ±z snapshot gÃ¼ncellenir

8) Kenar Durumlar

Volatil Domain: pricing/market/status kaynaklarÄ± TTL aÅŸÄ±mÄ± olmasa bile age/lag ile at_risk olabilir.

Index Drift: ingest gÃ¼ncel fakat index eski â†’ reindex canary; baÅŸarÄ±sÄ±zsa rollback.

Partial Crawl: delta eksik â†’ fullâ€™e terfi (backoff ve bÃ¼tÃ§e kontrolÃ¼).

Robots/Legal Hold: crawl engeli â†’ budget_exceeded|rbac_denied|legal_hold uyarÄ±larÄ±.

Duplicate/Canonical: aynÄ± iÃ§eriÄŸin farklÄ± URLâ€™leri â†’ canonicalize ve tek kaynaÄŸÄ± yaÅŸat.

Multi-TZ Tarihler: belge tarihleri normalize (Europe/Istanbul) yoksa stale yanlÄ±ÅŸ pozitif Ã¶nleme.

MRF/DR: failover sÄ±rasÄ±nda dÄ±ÅŸ kaynak ping kapasitesi sÄ±nÄ±rlanÄ±r; retry/backoff.

Observer: kaynak URL/ham veri gizli; skorlar gÃ¶rÃ¼nÃ¼r.

Freeze: yalnÄ±z plan/rapor; job uygulanmaz (uygulama sonrasÄ± otomatik tetiklenecek ÅŸekilde kuyruklanÄ±r).

9) Telemetri
{
  "freshness.metrics": {
    "event":"freshness.metrics","timestamp":"iso8601",
    "snapshots":1,"avgScore":0.41,"atRisk":1,"stale":0,
    "recrawls":1,"reindexes":1,"canaryPromotes":0,
    "avgCrawlMs":8200,"avgIndexMs":92000,
    "pingOkPct":96,"budgetUsePct":72
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/knowledgeFreshnessGuard.ts        # FSM + orchestrator
services/livia/lib/fresh/score.ts                # tazelik skoru (age/lag/ttl/volatility/coverage)
services/livia/lib/fresh/plan.ts                 # recrawl/reindex/ping planlayÄ±cÄ± + bÃ¼tÃ§e/gÃ¼venlik
services/livia/lib/fresh/apply.ts                # crawler/indexer/connector kÃ¶prÃ¼leri
services/livia/lib/fresh/hints.ts                # Qo retrieval boost/demote tercihleri
services/livia/lib/fresh/report.ts               # md/html + grafik (inline SVG)
services/livia/lib/bridges.ts                    # L22/L26/L34/L38/L39/L46/L47/L48/L49/L50/L51/L53/L55/L56/L57
services/livia/state/freshStore.ts               # idem index + snapshot cache + job queue
services/livia/__tests__/knowledgeFreshnessGuard.test.ts
cfg/livia.fresh.yaml

11) Test Ä°skeleti (Jest/Vitest)

TTL AÅŸÄ±mÄ±: docs TTL 30g, age 45g â†’ stale.risk.triggered(warn) + recrawl.scheduled

Index Lag: ingest gÃ¼ncel, index lag 15dk â†’ reindex.scheduled(canary 10%)

Temporal Query: â€œbugÃ¼n/ÅŸimdiâ€ â†’ ping.request(pricing) ve Qoâ€™ya boost_recent

Freeze: state=frozen â†’ planlandÄ± ama apply edilmedi; kart freeze_active

BÃ¼tÃ§e Limit: recrawl talebi > saatlik kota â†’ throttle ve batch

Rollback: canary promote sonrasÄ± NDCG dÃ¼ÅŸÃ¼ÅŸÃ¼ %3.5 â†’ rollback

Idempotency: aynÄ± freshKey ikinci Ã§alÄ±ÅŸtÄ±rmada yalnÄ±z snapshot/gÃ¼ncelleme

Rapor: md/html Ã¼retildi; L22 daÄŸÄ±tÄ±ldÄ±; L38/L48 kaydedildi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

12:05 SCORE: kb_default score 0.67 (at_risk), lag 13dk, 2 TTL aÅŸÄ±mÄ±

12:06 PLAN: pricing/news recrawl (delta), reindex canary %10

12:20 APPLY: crawl bitti, index canary hazÄ±r â†’ Qoâ€™ya boost_recent+demote_stale ipuÃ§larÄ±

12:45 EVALUATE: canary iyi (NDCG -0.4pp, p95 +18ms) â†’ promote; kart/rapor/metrik yayÄ±mlandÄ±

13) SLO

Snapshot p95 < 50 ms

Recrawl tetik gecikmesi â‰¤ 5 dk (at_risk)

Canary promote/rollback kararÄ± â‰¤ 30 dk iÃ§inde

YanlÄ±ÅŸ blok â‰¤ %1, kaÃ§an stale risk â‰¤ %2

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-59 Â· personalizationPolicyEngine.ts â€” GeniÅŸ Prompt v3 (+ Ã‡ok-KÄ±sÄ±tlÄ± Optimizasyon, Segment-DSL, Adil KiÅŸiselleÅŸtirme)

AmaÃ§:
Tenant/rol/tier/bÃ¶lge/dil/kanal baÄŸlamÄ±na gÃ¶re model/pipeline/cevap stili ve UI/guardrail politikalarÄ±nÄ± dinamik ve denetlenebilir biÃ§imde belirlemek.
Hedef: kalite (NDCG/MRR/CTR), maliyet ($/sorgu) ve SLO (p95/hata oranÄ±) arasÄ±nda Ã§ok-kÄ±sÄ±tlÄ± optimizasyon yaparak kiÅŸiselleÅŸtirme sunmak; aynÄ± zamanda adil kullanÄ±m (fairness), gizlilik, etik, yasal kÄ±sÄ±tlarÄ± korumak.
Entegrasyon: Qo (L55) plan seÃ§imi, Traffic Shaper (L54) katmanlarÄ±, KB Tuning (L47) profilleri, Safety (L56)/ Evidence (L57), Freshness (L58), Cost Guard (L53), Freeze (L51), Provenance (L38), Lineage (L39), Audit (L48).
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: policy|mlops|ops|compliance tam; observer salt okur

Gizlilik: PII yok; kullanÄ±cÄ±/operatÃ¶r kimlikleri L21 ile hash; â€œdo-not-personalizeâ€ bayraÄŸÄ±na saygÄ±

Ä°dempotency: persKey = tenant + tier + region + locale + channel + policyHash + windowISO

Observability: spans (pers.resolve|score|apply|report) + metrics; bÃ¼tÃ¼n kararlar WORM (L38) ve Lineage (L39)

Uyum/Etik: L26; adil kullanÄ±m kÄ±sÄ±tlarÄ± (korunan Ã¶zelliklere gÃ¶re kiÅŸiselleÅŸtirme yok)

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "personalization.policy.updated": {
    "event":"personalization.policy.updated","timestamp":"iso8601",
    "policyId":"pers-v1",
    "objectives":{"quality":0.5,"latency":0.25,"cost":0.25},        // aÄŸÄ±rlÄ±klar
    "constraints":{
      "latencyP95Ms":{"max":900,"goldBonus":-100},
      "costPerQueryUsd":{"max":0.015,"bronzeHard":0.008},
      "quality":{"ndcg10Min":0.50,"mrr10Min":0.55}
    },
    "fairness":{"protectedAttributes":["age","gender","religion"],"noUse":true,"proxyGuard":true},
    "segmentDSL":[
      {
        "if":"tier=gold AND region in ['TR','EU'] AND lang in ['tr','auto']",
        "then":{
          "qo.plan":"P-hybrid-fast",
          "reranker":"ce-small",
          "synthModel":"gpt-m",
          "ui.variant":"gold-tr",
          "style":{"locale":"tr-TR","units":"metric","currency":"USD"}
        }
      },
      {
        "if":"tier=bronze OR channel='batch'",
        "then":{
          "qo.plan":"P-bm25-lowcost",
          "reranker":"none","synthModel":"gpt-m",
          "caps":{"maxTokens":600,"kb.topK":50}
        }
      }
    ],
    "dayparting":[{"windowLocal":"09:00-18:00","boost":"quality:+0.05"},{"windowLocal":"18:00-23:59","boost":"latency:+0.05"}],
    "flags":{"doNotPersonalizeRespect":true,"abEnable":true}
  },

  "tenant.profile.updated": {
    "event":"tenant.profile.updated","timestamp":"iso8601",
    "tenant":"t#acme","region":"TR","locale":"tr-TR","tier":"gold",
    "channels":["web","api"],"vertical":"finance","consent":{"personalization":true}
  },

  "user.preference.updated": {
    "event":"user.preference.updated","timestamp":"iso8601",
    "user":"user#f0a1","tenant":"t#acme","locale":"tr-TR","units":"metric",
    "doNotPersonalize":false,"topics":{"block":["politics"],"favor":["devops"]}
  },

  "context.request": {
    "event":"context.request","timestamp":"iso8601",
    "id":"q#7f9a12","tenant":"t#acme","user":"user#f0a1",
    "tier":"gold","region":"TR","locale":"auto|tr-TR|en-US","channel":"web",
    "mode":"search|answer|chat","deadlineMs":1200,
    "hints":{"qualityBias":"+0.03","costHardUsd":0.02}
  },

  "freeze.state.changed": {
    "event":"freeze.state.changed","timestamp":"iso8601",
    "state":"frozen|thawed","scope":"service:kb_api","reason":"audit|mrf|drill"
  },

  "slo.guard.triggered|slo.guard.recovered": {
    "event":"slo.guard.triggered","timestamp":"iso8601",
    "serviceId":"kb_api","slo":"latency_p95","severity":"high","burnPct":6.4
  },

  "cost.guard.triggered|cost.guard.recovered": {
    "event":"cost.guard.triggered","timestamp":"iso8601",
    "component":"inference|search_stack|total","severity":"high"
  },

  "ab.experiment.registered": {
    "event":"ab.experiment.registered","timestamp":"iso8601",
    "expId":"EXP-qo-plan","scope":"tenant:t#acme",
    "arms":[{"id":"A","sharePct":50},{"id":"B","sharePct":50}],
    "metrics":["ndcg10","mrr10","p95ms","costUsd","acceptRate"],
    "guardrails":{"p95msMax":950,"costUsdMax":0.016,"ndcg10Min":0.50}
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "personalization.decision.ready": {
    "event":"personalization.decision.ready","timestamp":"iso8601",
    "id":"q#7f9a12","policyId":"pers-v1","segment":"gold-tr",
    "plan":{"qo.plan":"P-hybrid-fast","reranker":"ce-small","synthModel":"gpt-m","kb.topK":60,"maxTokens":700},
    "localization":{"locale":"tr-TR","units":"metric","currency":"USD"},
    "ui":{"variant":"gold-tr","disclaimer":"tr-finance?"},
    "constraintsApplied":{"p95MsMax":900,"costUsdMax":0.015,"ndcg10Min":0.50},
    "reasoning":["segmentDSL#1 matched","dayparting:quality+0.05 applied"],
    "hash":"sha256:..."
  },

  "personalization.hint.qo": {
    "event":"personalization.hint.qo","timestamp":"iso8601",
    "id":"q#7f9a12","overrides":{"plan":"P-hybrid-fast","reranker":"ce-small","synthModel":"gpt-m"},
    "caps":{"kb.topK":60,"maxTokens":700}
  },

  "personalization.hint.shape": {
    "event":"personalization.hint.shape","timestamp":"iso8601",
    "svc":"kb_api","tier":"gold","priorityBoost":2,"deadlineMs":1100
  },

  "personalization.ui.assets": {
    "event":"personalization.ui.assets","timestamp":"iso8601",
    "variantId":"gold-tr","strings":{"greet":"Merhaba","cta":"Devam"},
    "style":{"dateFmt":"DD MMM YYYY","thousandsSep":"."}
  },

  "personalization.fairness.snapshot": {
    "event":"personalization.fairness.snapshot","timestamp":"iso8601",
    "scope":"tenant:t#acme","period":"1d",
    "parity":{"acceptRate":{"gold":0.78,"silver":0.61,"bronze":0.55},"tierDisparity":"ok"},
    "proxyScan":{"passed":true}
  },

  "personalization.card": {
    "event":"personalization.card","timestamp":"iso8601",
    "title":"KiÅŸiselleÅŸtirme Aktif â€” gold-tr",
    "body":"P-hybrid-fast â€¢ ce-small â€¢ gpt-m â€¢ p95â‰¤900ms â€¢ $â‰¤0.015/sorgu.",
    "severity":"info","ttlSec":600
  },

  "personalization.alert": {
    "event":"personalization.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"idem_duplicate|rbac_denied|freeze_active|constraint_conflict|fairness_violation|proxy_flag|dq_gap"
  },

  "personalization.metrics": {
    "event":"personalization.metrics","timestamp":"iso8601",
    "decisions":1,"segmentsUsed":1,"abActive":true,
    "avgP95Ms":842,"avgCostUsd":0.011,"quality":{"ndcg10":0.56,"mrr10":0.61},
    "fairnessOk":true
  },

  "personalization.report.ready": {
    "event":"personalization.report.ready","timestamp":"iso8601",
    "path":"data/pers/2025-09-16/t_acme/report.md",
    "summary":"gold-tr segmenti, p95 842ms, ndcg@10 0.56, maliyet $0.011. Fairness ok.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul", currency:"USD" },

  objectives:{ quality:0.5, latency:0.25, cost:0.25 },   // aÄŸÄ±rlÄ±k tabanÄ±
  constraints:{
    latencyP95Ms:{ max:900, goldBonus:-100, bronzeRelax:+100 },
    costPerQueryUsd:{ max:0.015, bronzeHard:0.008 },
    quality:{ ndcg10Min:0.50, mrr10Min:0.55 }
  },

  fairness:{
    protectedAttributes:["age","gender","religion","ethnicity"],
    noUse:true,                      // korunanlarÄ±n doÄŸrudan kullanÄ±mÄ± yasak
    proxyGuard:true,                 // proxy sinyaller (coarse usage) taranÄ±r
    parityChecks:["acceptRate","latencyP95","costUsd"],
    disparityTolerancePct:10
  },

  segmentDSL:{
    ops:["AND","OR","NOT"],
    fields:["tier","region","locale","lang","channel","vertical","consent.personalization","doNotPersonalize"],
    comparators:[">=","=","in","matches"],
    examples:[
      "tier=gold AND region in ['TR','EU']",
      "doNotPersonalize=true â†’ enforce: plan='P-bm25-lowcost', reranker='none'"
    ]
  },

  defaults:{
    plan:"P-vec-lite", reranker:"ce-small", synthModel:"gpt-m",
    caps:{ "kb.topK":60, "maxTokens":700 },
    ui:{ variant:"default", locale:"tr-TR", units:"metric" }
  },

  dayparting:[
    { windowLocal:"09:00-18:00", boosts:{ quality:+0.05 } },
    { windowLocal:"18:00-23:59", boosts:{ latency:+0.05 } }
  ],

  ab:{ enable:true, minSample:500, guardrails:{ p95MsMax:950, costUsdMax:0.016, ndcg10Min:0.50 } },

  integrations:{
    qo:"LIVIA-55", shape:"LIVIA-54", tune:"LIVIA-47",
    cost:"LIVIA-34", costGuard:"LIVIA-53", slo:"LIVIA-32",
    safety:"LIVIA-56", evidence:"LIVIA-57", fresh:"LIVIA-58",
    freeze:"LIVIA-51", provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48", dist:"LIVIA-22"
  },

  rbacViews:{ observer:{ hideDSL:true, showOnlyDecisions:true } },

  cache:{ ttlSec:900, keyBy:["tenant","tier","region","locale","channel","policyHash"] },

  idempotencyTtlSec: 900
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

Segment EÅŸleÅŸtirme: tenant/tier/region/locale/channel/lang/consent â†’ Segment-DSL kurallarÄ±nÄ± sÄ±rayla deÄŸerlendir; ilk eÅŸleÅŸen + varsayÄ±lanlar birleÅŸik olur (most_specific_overrides).

Ã‡ok-KÄ±sÄ±tlÄ± Optimizasyon: hedef fonksiyon score = w_q*Q - w_l*L - w_c*C; kÄ±sÄ±tlar: p95 â‰¤ limit, cost â‰¤ limit, NDCG/MRR â‰¥ min. Ã‡akÄ±ÅŸma â†’ constraint_conflict uyarÄ±sÄ± ve en yakÄ±n feasible profil seÃ§imi.

Fairness & Gizlilik: korunan Ã¶zellikler politikada kullanÄ±lamaz; proxyGuard ile korelasyon taramasÄ±; eÅŸik aÅŸÄ±mÄ± â†’ fairness_violation ve varsayÄ±lan profile dÃ¼ÅŸ.

Do-Not-Personalize: kullanÄ±cÄ±/tenant bayraÄŸÄ± â†’ kiÅŸiselleÅŸtirme kapalÄ±; yalnÄ±z gÃ¼venli varsayÄ±lan.

SLO/Cost Etkisi: L32/L53 uyarÄ±sÄ±nda latency/cost aÄŸÄ±rlÄ±klarÄ± â†‘, plan dÃ¼ÅŸÃ¼rme (topKâ†“, reranker none, tokensâ†“).

Freeze: L51 frozen â†’ politika yazÄ±lmaz, yalnÄ±z resolve ve hint Ã¼retilir.

AB & Dayparting: trafik dilimlerine gÃ¶re aÄŸÄ±rlÄ±k dÃ¼zelt; AB aktifse kollarÄ± guardrail altÄ±nda daÄŸÄ±t.

Localization: dil/Ã¼lke â†’ sayÄ±/tarih/para biÃ§imleri, UI stringleri, uyarÄ±/disclaimer ÅŸablonlarÄ±.

6) Pipeline (Kompozisyon)

Load: personalization.policy.updated, tenant.profile.updated, user.preference.updated

Resolve: context.request â†’ segment match â†’ plan & overrides â†’ Qo/Shape ipuÃ§larÄ±

Constrain: SLO/Cost/Freshness/Safety baÄŸlamÄ±nÄ± uygula (kÄ±sÄ±tlar)

Fairness Scan: proxy sinyalleri ve tier daÄŸÄ±lÄ±mÄ±nda parity analizi

Emit: decision.ready, hint.qo, hint.shape, ui.assets, card/alert/metrics

Audit: karar & gerekÃ§eler WORM/Lineage; rapor L48

Cache: persKey ile snapshot sakla

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (policy/tenant/user updated) READY

READY â†’ (context.request) RESOLVE â†’ CONSTRAIN â†’ FAIRNESS â†’ EMIT â†’ IDLE

Hata: ALERT; idem: aynÄ± persKey yinelemesinde yan etki yok (yalnÄ±z kart/metrik gÃ¼ncellenir)

8) Kenar Durumlar

Ã‡eliÅŸen DSL KurallarÄ±: birden Ã§ok kural uygunsa en spesifik (en Ã§ok alanÄ± eÅŸleyen) kazanÄ±r; eÅŸitlikte son gÃ¼ncellenen.

Do-Not-Personalize: true â†’ tÃ¼m DSL atlanÄ±r; varsayÄ±lan plan + minimal caps.

Minor KullanÄ±cÄ±: kiÅŸiselleÅŸtirme seviyesi kÄ±sÄ±tlanÄ±r; pazarlama/Ã¶zel ilgi temelli varyantlar devre dÄ±ÅŸÄ±.

Proxy ÅÃ¼phesi: bÃ¶lge + saat + cihaz â†’ korunan Ã¶zelliÄŸe yÃ¼ksek korelasyon â†’ uyarÄ± ve otomatik sade profil.

Vertical KÄ±sÄ±t: vertical=health/legal/finance â†’ Safety (L56) consent/disclaimer zorunlu.

Freshness At-Risk: L58 at_risk â†’ boost_recent, demote_stale ipuÃ§larÄ±nÄ± karar iÃ§ine gÃ¶m.

AB Guardrail Ä°hlali: kol B p95>950ms â†’ otomatik pause ve kol Aâ€™ya geri sar.

Freeze Aktif: yalnÄ±z karar/hint/rapor; persist yok.

Observer GÃ¶rÃ¼nÃ¼mÃ¼: DSL gizli; yalnÄ±z sonuÃ§ ve kÄ±sÄ±t Ã¶zetleri.

9) Telemetri
{
  "personalization.metrics": {
    "event":"personalization.metrics","timestamp":"iso8601",
    "decisions":1,"segmentsUsed":1,
    "avgScore":0.62,"avgP95Ms":842,"avgCostUsd":0.011,
    "quality":{"ndcg10":0.56,"mrr10":0.61},
    "fairnessOk":true,"abActive":true,"abAutoPaused":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/personalizationPolicyEngine.ts        # FSM + resolver
services/livia/lib/pers/dsl.ts                       # Segment-DSL deÄŸerlendirici
services/livia/lib/pers/optimizer.ts                 # Ã§ok-kÄ±sÄ±tlÄ± optimizasyon (quality/latency/cost)
services/livia/lib/pers/fairness.ts                  # parity/proxy guard (korunan kullanÄ±mÄ± yok)
services/livia/lib/pers/localize.ts                  # locale/units/currency/ui strings
services/livia/lib/pers/hints.ts                     # Qo/Shape override & caps Ã¼retimi
services/livia/lib/pers/report.ts                    # md/html rapor + inline SVG
services/livia/lib/bridges.ts                        # L21/L22/L26/L32/L34/L38/L39/L41/L45/L47/L48/L51/L53/L54/L55/L56/L57/L58
services/livia/state/persStore.ts                    # idem index + cache + fairness snapshot
services/livia/__tests__/personalizationPolicyEngine.test.ts
cfg/livia.pers.yaml

11) Test Ä°skeleti (Jest/Vitest)

Gold-TR EÅŸleÅŸmesi: segmentDSL#1 â†’ P-hybrid-fast, ce-small, gpt-m, locale tr-TR

Bronze/Batch: P-bm25-lowcost, reranker none, caps uygulanÄ±r

SLO/COST BaskÄ±sÄ±: L32/L53 tetik â†’ plan dÃ¼ÅŸÃ¼rme, p95â‰¤limit, costâ‰¤limit

Fairness: acceptRate farkÄ± > %10 â†’ fairness_violation ve varsayÄ±lan profile dÃ¼ÅŸÃ¼ÅŸ

Do-Not-Personalize: true â†’ kiÅŸiselleÅŸtirme kapalÄ±

AB Guardrail: kol B p95>950 â†’ auto-pause

Freeze: frozen â†’ freeze_active, persist yok; yalnÄ±z hints

Idempotency: aynÄ± persKey yinelemesinde yan etki yok

Rapor: md/html Ã¼retildi; L38/L48 kaydÄ±

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

14:02 context.request(gold, TR, web) â†’ RESOLVE: segment gold-tr

CONSTRAIN: p95â‰¤900, $â‰¤0.015, NDCGâ‰¥0.50 â†’ P-hybrid-fast, ce-small, gpt-m, topK 60, tokens 700

FAIRNESS: parity â€œokâ€; proxyGuard â€œpassedâ€

EMIT: Qo/Shape hints + UI assets + card/metrics + rapor

13) SLO

Resolve p95 < 20 ms (cache varken <10 ms)

HatalÄ± segment oranÄ± â‰¤ %1

Fairness uyarÄ±sÄ± yanlÄ±ÅŸ pozitif â‰¤ %2, kaÃ§an ihlal â‰¤ %1

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-60 Â· multilingualAdaptationLayer.ts â€” GeniÅŸ Prompt v3 (+ Oto-Dil AlgÄ±lama, Terminoloji ZorlamasÄ±, BiÃ§im/Ãœslup Uyumlama, DoÄŸrulama)

AmaÃ§:
Sorgu ve yanÄ±tlarÄ± Ã§ok dilli akÄ±ÅŸta gÃ¼venli ve tutarlÄ± biÃ§imde algÄ±la â†’ Ã§evir (gerekirse) â†’ uyarlama (terminoloji/Ã¼slup/biÃ§im) â†’ doÄŸrula â†’ teslim et.
Hedef: kalite (anlam koruma, terminoloji tutarlÄ±lÄ±ÄŸÄ±), SLO (p95 gecikme), maliyet (token/Ã§eviri), gÃ¼venlik (PII/toksisite) ve kanÄ±t (atÄ±f hizalama) standartlarÄ±nÄ± korumak.
Entegrasyon: Qo (L55), Safety (L56), Evidence (L57), Freshness (L58), Personalization (L59), Traffic (L54), KB Tuning (L47), FSync (L46), Cost (L34/53), Freeze (L51), Audit/Provenance/Lineage (L48/L38/L39).
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: mlops|policy|localization|ops tam, observer salt okur

Gizlilik: PII Ã§eviri Ã¶ncesi ve sonrasÄ± (L56) maskelenir; kullanÄ±cÄ±/operatÃ¶r kimliÄŸi L21 hash

Ä°dempotency: mlangKey = queryId + srcLang + tgtLang + styleProfile + glossaryHash + windowISO

Observability: spans (mlang.detect|plan|translate|adapt|verify|finalize) + metrics

Uyumluluk: tÃ¼m kararlar L26 etik, L38 WORM append, L39 lineage

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "mlang.policy.updated": {
    "event":"mlang.policy.updated","timestamp":"iso8601",
    "policyId":"mlang-v1",
    "defaultTarget":"auto",                         // auto â†’ user/tenant/l59â€™dan
    "preserveBlocks":["code","math","urls","emails","citations","footnotes"],
    "style":{"tone":"neutral","formality":"medium","localeAwareNumbers":true,"spellVariant":"tr-TR"},
    "constraints":{"maxLatencyMs":250,"maxCostUsdPerQuery":0.004},
    "fallbacks":{"pivotLang":"en","lowResourceDegrade":"lexical+glossary_only"}
  },

  "translation.engine.catalog": {
    "event":"translation.engine.catalog","timestamp":"iso8601",
    "engines":[
      {"id":"nmt-fast","kind":"NMT","langs":["tr","en","ar","ru","de"],"latencyMsP95":120,"costUsdPerK":0.2},
      {"id":"nmt-quality","kind":"NMT","langs":["tr","en","fr","de"],"latencyMsP95":240,"costUsdPerK":0.35},
      {"id":"llm-translate","kind":"LLM","langs":["*"],"latencyMsP95":420,"costUsdPerK":0.9}
    ],
    "routing":{"default":"nmt-fast","hiQuality":"nmt-quality","fallback":"llm-translate"}
  },

  "glossary.updated": {
    "event":"glossary.updated","timestamp":"iso8601",
    "namespace":"kb_default:tr",
    "entries":[
      {"src":"retrieval-augmented generation","tgt":"retrieval destekli Ã¼retim"},
      {"src":"reranker","tgt":"yeniden sÄ±ralayÄ±cÄ±"}
    ],
    "enforce":true
  },

  "style.guide.updated": {
    "event":"style.guide.updated","timestamp":"iso8601",
    "profileId":"sg-tr-tech",
    "rules":{
      "quoteStyle":"Â«Â»|â€œâ€","listMarker":"-","codeFence":"```",
      "capitalization":"turkish","diacritics":"strict","genderNeutrality":true
    }
  },

  "terminology.enforce.list": {
    "event":"terminology.enforce.list","timestamp":"iso8601",
    "items":[{"src":"GPU","tgt":"GPU"},{"src":"token","tgt":"token"}],
    "caseSensitive":true
  },

  "query.request": {
    "event":"query.request","timestamp":"iso8601",
    "id":"q#7f9a12","text":"AVAX staking APR nedir?","lang":"auto|tr|en","profile":"tr",
    "mode":"answer","hints":{"deadlineMs":1200,"stream":true}
  },

  "qo.stage.output": {
    "event":"qo.stage.output","timestamp":"iso8601",
    "id":"q#7f9a12","stage":"synthesize|finalize","chunk":"partial answer text",
    "citations":["doc#1","doc#7"],"tokens":{"prompt":420,"completion":128},"lang":"en|tr|auto"
  },

  "personalization.decision.ready": {
    "event":"personalization.decision.ready","timestamp":"iso8601",
    "id":"q#7f9a12","localization":{"locale":"tr-TR","units":"metric","currency":"USD"}
  },

  "evidence.validation.ready": {
    "event":"evidence.validation.ready","timestamp":"iso8601",
    "id":"q#7f9a12","coveragePct":84,"claims":[{"idx":0,"status":"entailed"}]
  },

  "freeze.state.changed": {
    "event":"freeze.state.changed","timestamp":"iso8601",
    "state":"frozen|thawed","scope":"service:kb_api","reason":"audit|mrf|drill"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "mlang.detected": {
    "event":"mlang.detected","timestamp":"iso8601",
    "id":"q#7f9a12","srcLang":"en","tgtLang":"tr","confidence":0.98,
    "reason":"l59 locale=tr-TR; query.lang=auto; chunk.lang=en"
  },

  "mlang.plan.ready": {
    "event":"mlang.plan.ready","timestamp":"iso8601",
    "id":"q#7f9a12",
    "engine":"nmt-quality","pivot":"none|en",
    "preserve":["code","citations","footnotes"],
    "styleProfile":"sg-tr-tech","glossary":"kb_default:tr",
    "budget":{"latencyMs":250,"costUsd":0.0032},
    "hash":"sha256:..."
  },

  "mlang.redaction.in": {
    "event":"mlang.redaction.in","timestamp":"iso8601",
    "id":"q#7f9a12","areas":["query|chunk"],"piiMasked":2
  },

  "mlang.translation.chunk": {
    "event":"mlang.translation.chunk","timestamp":"iso8601",
    "id":"q#7f9a12","seq":3,"src":"...","tgt":"...","engine":"nmt-quality",
    "preserved":{"codeBlocks":1,"citations":2}
  },

  "mlang.adaptation.applied": {
    "event":"mlang.adaptation.applied","timestamp":"iso8601",
    "id":"q#7f9a12",
    "steps":["glossary_enforce","number_format_locale","date_fmt_locale","style_rules","terminology_lock"],
    "unitsConverted":[],"currencyConverted":false
  },

  "mlang.verify.snapshot": {
    "event":"mlang.verify.snapshot","timestamp":"iso8601",
    "id":"q#7f9a12",
    "scores":{"COMET":0.84,"TER":0.19,"styleCompliance":0.93,"toxicityDelta":-0.01},
    "terminologyMismatches":0,"citationPreserved":true,
    "status":"ok|at_risk|retry_pivot"
  },

  "mlang.answer.final": {
    "event":"mlang.answer.final","timestamp":"iso8601",
    "id":"q#7f9a12","lang":"tr","stream":true,
    "answerMd":"â€¦(TÃ¼rkÃ§e, uygun terminoloji ve biÃ§im)â€¦","citations":["doc#1","doc#7"]
  },

  "mlang.card": {
    "event":"mlang.card","timestamp":"iso8601",
    "title":"Ã‡ok Dilli Uyum â€” tr-TR (glossary enforced)",
    "body":"nmt-quality â€¢ COMET 0.84 â€¢ stil uyumu %93 â€¢ atÄ±f korundu.",
    "severity":"info","ttlSec":600
  },

  "mlang.alert": {
    "event":"mlang.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"idem_duplicate|rbac_denied|engine_timeout|pivot_retry|glossary_violation|style_mismatch|freeze_active"
  },

  "mlang.metrics": {
    "event":"mlang.metrics","timestamp":"iso8601",
    "translatedChars":1820,"chunks":6,"p50Ms":88,"p95Ms":210,
    "avgCostUsd":0.0026,"COMETavg":0.83,"styleComplianceAvg":0.92,
    "piiMasked":2,"citationPreservePct":100
  },

  "mlang.report.ready": {
    "event":"mlang.report.ready","timestamp":"iso8601",
    "path":"data/mlang/2025-09-16/q_7f9a12/report.md",
    "summary":"tr-TR Ã§Ä±ktÄ±, glossary & stil uygulandÄ±, COMET 0.84, atÄ±f/PII korundu.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  detection:{
    model:"langid-fast-v2",
    threshold:0.85,
    mixedChunkStrategy:"majority_vote+per_chunk",
    trDiacriticsAware:true                    // I/Ä°, Ä±/i ayrÄ±mÄ±
  },

  routing:{
    engineByQuality:{ default:"nmt-fast", high:"nmt-quality", llm:"llm-translate" },
    pick:"argmin(cost) s.t. p95<=250ms âˆ§ quality>=target",
    qualityTargets:{ COMET:0.80, TER:0.25 },
    pivot:{ enable:true, lang:"en", when:{ lowResource:true, backoff:true } }
  },

  adaptation:{
    glossary:{ enforce:true, caseSensitive:false, fallbackSuggest:true },
    styleProfile:"sg-tr-tech",
    styleRules:{
      quoteStyle:"â€œâ€",
      capitalization:"turkish",      // TÃ¼rkÃ§e bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf kurallarÄ±
      diacritics:"strict",
      genderNeutrality:true
    },
    localeFormat:{ numbers:true, dates:true, currency:false }, // currency sadece aÃ§Ä±k istekle
    keepSections:["code","math","urls","citations","footnotes"],
    entityPolicy:{ names:"preserve_original|transliterate_if_known" }
  },

  verification:{
    metrics:["COMET","TER","styleCompliance","toxicityDelta"],
    thresholds:{ COMET:0.80, TER:0.25, styleCompliance:0.90, toxicityDeltaMax:0.05 },
    citationPreserveRequired:true,
    retry:{ pivotOnFail:true, maxRetries:1 }
  },

  streaming:{
    enable:true, chunkChars:600, graceTokens:20,
    cutOnSafetyViolation:true                   // L56 ile birlikte
  },

  conversions:{
    units:{ enable:false, allow:["metricâ†”imperial"], requireUserOptIn:true },
    currency:{ enable:false, fxSource:"L34/L53", requireExplicit:true }
  },

  integrations:{
    qo:"LIVIA-55", safety:"LIVIA-56", evidence:"LIVIA-57",
    fresh:"LIVIA-58", pers:"LIVIA-59", shape:"LIVIA-54",
    tune:"LIVIA-47", fsync:"LIVIA-46",
    cost:"LIVIA-34", costGuard:"LIVIA-53",
    freeze:"LIVIA-51", provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48", dist:"LIVIA-22"
  },

  rbacViews:{ observer:{ hideSourceText:true, showOnlyScores:true } },

  cache:{ ttlSec:900, keyBy:["srcLang","tgtLang","styleProfile","glossaryHash"] },

  idempotencyTtlSec: 900
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

AlgÄ±lama: query/qo.chunk dilini saptar; L59 locale ve kullanÄ±cÄ± tercihiyle hedef dili seÃ§.

Plan: kalite hedefleri ve SLOâ‰¤250ms altÄ±nda motor seÃ§imi; karma dil â†’ per-chunk.

Redaksiyon (In): PII (L56) â†’ mask; preserveBlocks maskeleri (code/citations/footnotes) korunur.

Ã‡eviri: seÃ§ilen NMT/LLM; dÃ¼ÅŸÃ¼k kaynak â†’ pivot EN (isteÄŸe baÄŸlÄ±).

Uyarlama: terminoloji/glossary zorlamasÄ±, TÃ¼rkÃ§e bÃ¼yÃ¼k harf/diakritik, liste/alÄ±ntÄ±/baÅŸlÄ±k biÃ§imi; locale-aware sayÄ±/tarih.

DoÄŸrulama: COMET/TER + stil uyumu + toksisite delta; atÄ±f korumasÄ± (L57).

Geri DÃ¶nÃ¼ÅŸ: eÅŸikler tutmazsa retry_pivot (tek deneme); olmazsa â€œat_riskâ€ + yumuÅŸatÄ±lmÄ±ÅŸ dil uyarÄ±sÄ±.

Freeze: aktifse politika gÃ¼ncellemesi yapÄ±lmaz; sadece plan/uyarlama uygulanÄ±r ve raporlanÄ±r.

6) Pipeline (Kompozisyon)

Detect â†’ mlang.detected

Plan â†’ motor seÃ§imi + preserve seti + bÃ¼tÃ§e

Redact-In â†’ PII & blok koruma

Translate (stream) â†’ chunk chunk; preserve yer tutucular

Adapt â†’ glossary/style/locale + terminoloji kilidi

Verify â†’ COMET/TER/stil/toksisite + atÄ±f koruma

Finalize â†’ placeholder geri koy, akÄ±ÅŸla teslim; kart/alert/metrics/rapor

Audit â†’ WORM/Lineage; daÄŸÄ±tÄ±m (L22)

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (query.request|qo.stage.output) DETECT

DETECT â†’ PLAN â†’ REDACT_IN â†’ TRANSLATE â†’ ADAPT â†’ VERIFY â†’ FINALIZE â†’ DONE

VERIFY sonucu at_risk â†’ RETRY_PIVOT? (opsiyonel) â†’ FINALIZE

Hata: ALERT; idem: aynÄ± mlangKey yinelemesinde yan etki yok (yalnÄ±z snapshot/metrik gÃ¼ncellenir)

8) Kenar Durumlar

TR Diakritik SorunlarÄ±: I/Ä°/Ä±/i yanlÄ±ÅŸ â†’ diacritics=strict ve otomatik dÃ¼zeltme.

Kod/Matematik: triple-fence iÃ§i asla Ã§evrilmez; satÄ±r sonlarÄ± korunur.

AtÄ±f AyraÃ§larÄ±: [^n] dipnotlarÄ± ve URLâ€™ler korunur; Ã§evrilmez.

Ad/Marka/ÃœrÃ¼n: preserve_original, yalnÄ±z bilinen transliterasyon varsa teklif edilir.

KarÄ±ÅŸÄ±k Dil ParagraflarÄ±: per-sentence dil; tek chunk iÃ§inde Ã§ok dilli iÅŸleme.

Toksisite Drift: Ã§eviri sonrasÄ± toksisite â†‘ â†’ L56 stream guard ile mask/replace.

Tarih/Para/SayÄ±: TR yerel biÃ§im; para/dÃ¶viz dÃ¶nÃ¼ÅŸÃ¼mÃ¼ yalnÄ±z aÃ§Ä±k istekle.

DÃ¼ÅŸÃ¼k Kaynak Dil: pivot EN, yetmezse lexical+glossary_only (terim tabanlÄ±).

Observer gÃ¶rÃ¼nÃ¼mÃ¼: kaynak metin gizli, yalnÄ±z skor/Ã¶zet.

Freeze: frozen â†’ freeze_active uyarÄ±sÄ±; kalÄ±cÄ± politika yazÄ±mÄ± yok.

9) Telemetri
{
  "mlang.metrics": {
    "event":"mlang.metrics","timestamp":"iso8601",
    "translatedChars":1820,"chunks":6,
    "p50Ms":88,"p95Ms":210,"avgCostUsd":0.0026,
    "COMETavg":0.83,"TERavg":0.21,"styleComplianceAvg":0.92,
    "terminologyMismatches":0,"pivotUsedPct":4,
    "citationPreservePct":100,"piiMasked":2
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/multilingualAdaptationLayer.ts        # FSM + orchestrator
services/livia/lib/mlang/detect.ts                   # dil algÄ±lama + per-chunk karar
services/livia/lib/mlang/route.ts                    # motor seÃ§imi (SLO/cost/quality)
services/livia/lib/mlang/redact.ts                   # PII & block-preserve maskeleri
services/livia/lib/mlang/translate.ts                # NMT/LLM/pivot Ã§eviri
services/livia/lib/mlang/adapt.ts                    # glossary/style/locale/terminoloji kilidi
services/livia/lib/mlang/verify.ts                   # COMET/TER/stil/toksisite + atÄ±f koruma
services/livia/lib/mlang/finalize.ts                 # placeholder restore + stream
services/livia/lib/bridges.ts                        # L21/L22/L26/L32/L34/L38/L39/L46/L47/L48/L51/L53/L54/L55/L56/L57/L58/L59
services/livia/state/mlangStore.ts                   # idem index + cache + glossary hash
services/livia/__tests__/multilingualAdaptationLayer.test.ts
cfg/livia.mlang.yaml

11) Test Ä°skeleti (Jest/Vitest)

AlgÄ±lama: EN chunk, hedef TR (locale tr-TR) â†’ mlang.detected(enâ†’tr)

Glossary & Stil: â€œretrieval-augmented generationâ€ â†’ â€œretrieval destekli Ã¼retimâ€; tÄ±rnak â€œâ€; Ä°/Ä± doÄŸru

Preserve: code fence ve [^1] dipnot korundu

DoÄŸrulama: COMET â‰¥0.80, TER â‰¤0.25, stil â‰¥0.90; geÃ§mezse pivot retry

Toksisite Delta: |Î”| â‰¤ 0.05; aÅŸarsa L56 ile mask/replace

AtÄ±f: citationPreserved=true; L57 kapsama dÃ¼ÅŸmez

SLO/Cost: p95â‰¤250ms; maliyet â‰¤ 0.004$/sorgu

Freeze: frozen â†’ freeze_active; politika yazÄ±lmaz

Idempotency: aynÄ± mlangKey tekrarÄ±nda yan etki yok; yalnÄ±z metrik gÃ¼ncellenir

Rapor: md/html Ã¼retildi; L38/L48 kaydedildi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

10:12 qo.stage.output(lang=en, stream) â†’ DETECT (tgt=tr, pers L59â€™dan)

PLAN: nmt-quality, glossary kb_default:tr, stil sg-tr-tech, preserve code/citations

REDACT_IN: 2 PII alan maskelendi

TRANSLATE: 6 chunk Ã§evrildi; code & dipnot korunarak

ADAPT: terminoloji/stil/biÃ§im uygulandÄ±; sayÄ±lar TR biÃ§imi

VERIFY: COMET 0.84, TER 0.19, stil 0.93, toksisite Î” -0.01 â†’ ok

FINALIZE: mlang.answer.final(tr) + kart/rapor/metrik yayÄ±mlandÄ±

13) SLO

Ã‡eviri+Uyarlama p95 < 250 ms (sorgu baÅŸÄ±na; stream chunkâ€™Ä± baÅŸÄ±na <90 ms)

Terminoloji uyumu hata oranÄ± â‰¤ %1

AtÄ±f koruma = %100 (dipnot/URL bozulmaz)

YanlÄ±ÅŸ dil algÄ±lama â‰¤ %1.5

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-61 Â· feedbackLearningLooper.ts â€” GeniÅŸ Prompt v3 (+ GÃ¼venli Ã–ÄŸrenme DÃ¶ngÃ¼sÃ¼, KarÅŸÄ±-Olgusal DeÄŸerlendirme, Politika Ã–neriâ†’Canaryâ†’Promote)

AmaÃ§:
KullanÄ±cÄ± ve sistem geri bildirimlerinden (explicit: beÄŸen/puan/dÃ¼zeltme/rapor; implicit: dwell/abandon/eskalasyon/tekrar-sorgu/konversiyon; sistem: SLO, maliyet, kanÄ±t/safety) online+offline bir dÃ¶ngÃ¼ kurup plan/parametre/pipeline ayarlarÄ±nÄ± gÃ¼venli biÃ§imde iyileÅŸtirmek:
topla â†’ normalize â†’ iliÅŸkilendir (attribution) â†’ Ã¶ÄŸren (bandit/linUCB/TS) â†’ karÅŸÄ±-olgusal deÄŸerlendir (IPS/DR) â†’ Ã¶neri Ã¼ret â†’ canary (L45) â†’ guardrail (SLO/Cost/Safety/Fairness) â†’ promote/rollback â†’ raporla.
Entegrasyon: Qo (L55), Traffic (L54), KB Tuning (L47), Cost Guard (L53), Safety (L56), Evidence (L57), Freshness (L58), Freeze (L51), Audit/Provenance/Lineage (L48/L38/L39), Release Freeze (L51).
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: mlops|policy|ops|compliance tam, observer salt okur

Gizlilik: PII yok; kullanÄ±cÄ±/operatÃ¶r kimlikleri L21 ile hash; â€œdo-not-personalizeâ€ ve â€œopt-out-of-learningâ€ bayraklarÄ±na saygÄ±

Ä°dempotency: learnKey = windowISO + scope + policyHash + datasetHash

Observability: spans (learn.collect|join|attrib|estimate|propose|rollout|report) + metrics

Uyumluluk: karar/Ã¶neri/deneyler WORM (L38) ve Lineage (L39); L26 etik kÄ±sÄ±tlarÄ±

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "feedback.user.thumbs": {
    "event":"feedback.user.thumbs","timestamp":"iso8601",
    "id":"q#7f9a12","tenant":"t#acme","user":"user#f0a1",
    "thumb":"+1|-1","reason":"helpful|wrong|outdated|unsafe|other","freeText":"..."
  },

  "feedback.user.rating": {
    "event":"feedback.user.rating","timestamp":"iso8601",
    "id":"q#7f9a12","score":1..5,"dimensions":{"accuracy":5,"usefulness":4,"style":4}
  },

  "feedback.user.edit.patch": {
    "event":"feedback.user.edit.patch","timestamp":"iso8601",
    "id":"q#7f9a12","before":"...","after":"...","diffChars":182,
    "labels":{"fix_kind":"factual|style|format","severity":"low|med|high"}
  },

  "feedback.user.flag": {
    "event":"feedback.user.flag","timestamp":"iso8601",
    "id":"q#7f9a12","category":"safety|privacy|bias|copyright|other"
  },

  "session.behavior.snapshot": {
    "event":"session.behavior.snapshot","timestamp":"iso8601",
    "id":"q#7f9a12","metrics":{
      "dwellMs":12800,"abandon":false,"followupWithinMin":12,"escalation":false,"conversion":true
    }
  },

  "qo.decision.path": {
    "event":"qo.decision.path","timestamp":"iso8601",
    "route":"hybrid","planId":"P-hybrid-fast",
    "params":{"topK":60,"reranker":"ce-small","model":"gpt-m","maxTokens":700},
    "propensity":0.62, "variant":"A|B"
  },

  "slo.window.metrics": {
    "event":"slo.window.metrics","timestamp":"iso8601",
    "window":"5m|1h","p95Ms":842,"errPct":0.9
  },

  "cost.window.metrics": {
    "event":"cost.window.metrics","timestamp":"iso8601",
    "window":"5m|1h","avgUsdPerQuery":0.011,"per1kReqTotal":1.05
  },

  "evidence.validation.ready": {
    "event":"evidence.validation.ready","timestamp":"iso8601",
    "id":"q#7f9a12","coveragePct":84,"status":"grounded|at_risk|ungrounded"
  },

  "safety.stream.guard|safety.violation.blocked": {
    "event":"safety.stream.guard","timestamp":"iso8601",
    "id":"q#7f9a12","action":"mask|cutoff|replace","reason":"toxicity|pii"
  },

  "freshness.snapshot": {
    "event":"freshness.snapshot","timestamp":"iso8601",
    "namespace":"kb_default","status":"ok|at_risk|stale","score":0.41
  },

  "learning.dataset.snapshot": {
    "event":"learning.dataset.snapshot","timestamp":"iso8601",
    "period":"1d|1h","size":182000,"biasChecks":{"classImbalance":"ok","propensityCoverage":"ok"},
    "hash":"sha256:dataset..."
  },

  "policy.candidate.registered": {
    "event":"policy.candidate.registered","timestamp":"iso8601",
    "scope":"qo|shape|tune|cost","id":"cand#qo-topK-40","base":"P-hybrid-fast",
    "diff":{"topK":40,"reranker":"ce-small"},"rationale":"costâ†“, qualityâ‰ˆ"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "learn.estimate.snapshot": {
    "event":"learn.estimate.snapshot","timestamp":"iso8601",
    "scope":"qo","policyBase":"P-hybrid-fast",
    "method":"IPS|DR","uplift":{"acceptRate":"+2.1pp","ndcg10":"+0.7pp"},
    "risk":{"p95Ms":"+14ms","costUsd":"-0.002"},
    "ci95":{"acceptRate":[+0.9,+3.2],"p95Ms":[+6,+22]},
    "sampleSize":12420,"effectiveSample":9320
  },

  "learn.proposal.ready": {
    "event":"learn.proposal.ready","timestamp":"iso8601",
    "id":"prop#qo-topK-40","scope":"qo",
    "changes":{"topK":40,"reranker":"ce-small"},
    "constraints":{"p95MsMax":900,"costUsdMax":0.015,"ndcg10Min":0.50},
    "explain":{"shaplike":[["query_len",0.22],["fresh_score",-0.11],["tier_gold",0.07]]},
    "guardrails":{"safety_incidents_no_increase":true,"fairness_parity":"Â±10%"},
    "recommendation":"canary_10pct_30min_then_promote_if_ok"
  },

  "learn.rollout.started": {
    "event":"learn.rollout.started","timestamp":"iso8601",
    "scope":"qo","candidate":"cand#qo-topK-40",
    "canary":{"trafficPct":10,"durationMin":30,"owner":"mlops#hash"},
    "monitor":{"metrics":["p95Ms","costUsd","ndcg10","acceptRate"],"thresholds":{"p95MsMax":900,"ndcg10Min":0.50}}
  },

  "learn.rollout.evaluation": {
    "event":"learn.rollout.evaluation","timestamp":"iso8601",
    "scope":"qo","candidate":"cand#qo-topK-40",
    "result":"promote|rollback|extend","obs":{"p95Ms":848,"ndcg10":0.553,"costUsd":0.0098}
  },

  "learn.policy.applied": {
    "event":"learn.policy.applied","timestamp":"iso8601",
    "scope":"qo","candidate":"cand#qo-topK-40",
    "via":"LIVIA-45|LIVIA-55|LIVIA-47","status":"ok",
    "hash":"sha256:apply..."
  },

  "learn.policy.rolledback": {
    "event":"learn.policy.rolledback","timestamp":"iso8601",
    "scope":"qo","candidate":"cand#qo-topK-40","reason":"ndcg_drop>3pp"
  },

  "learn.card": {
    "event":"learn.card","timestamp":"iso8601",
    "title":"Ã–ÄŸrenme Ã–nerisi UygulandÄ± â€” Qo topK 60â†’40",
    "body":"acceptRate +2.1pp, p95 +14ms (â‰¤900), cost -$0.002/sorgu.",
    "severity":"info","ttlSec":600
  },

  "learn.alert": {
    "event":"learn.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"idem_duplicate|rbac_denied|freeze_active|dataset_bias|propensity_low|guardrail_breach|apply_failed"
  },

  "learn.metrics": {
    "event":"learn.metrics","timestamp":"iso8601",
    "onlineBandit":{"method":"linUCB","explorePct":5,"regretMean":-0.012},
    "proposals":3,"applied":1,"rolledBack":0,
    "ipsVar":0.006,"drVar":0.004,
    "quality":{"ndcg10":"+0.6pp","acceptRate":"+1.8pp"},
    "slo":{"p95Ms":"+10ms"},"cost":{"usdPerQuery":"-0.0016"}
  },

  "learn.report.ready": {
    "event":"learn.report.ready","timestamp":"iso8601",
    "path":"data/learn/2025-09-16/report.md",
    "summary":"Qo topK 60â†’40 canary %10/30dk; promote edildi. NDCG +0.6pp, p95 +10ms, cost -$0.0016.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  learning:{
    mode:"hybrid",                              // offline+online
    online:{ method:"linUCB", explorePct:5, contextFeat:["tier","lang","hour","query_len","fresh_score","cost_per1k","topK","reranker","model"] },
    offline:{ estimator:"DR", clipW:10, minPropensity:0.05, bootstrapB:200 },
    safety:{ spi:"conservative", deltaMax:{ p95Ms:+30, ndcg10:-0.02, costUsd:+0.002 }, hardStops:{ safetyIncidents:true } },
    fairness:{ check:["acceptRate","p95Ms","costUsd"], tolerancePct:10, protected:["age","gender","religion","ethnicity"], proxyGuard:true },
    exploration:{ perTenantBudgetPct:3, guardByTier:{ gold:1, silver:3, bronze:5 } }, // trafikten
    dataset:{ minSize:5000, maxAgeDays:7, balanceTarget:"class_weighted" }
  },

  attribution:{
    method:"shaplike+last_touch",
    credit:["retrieve","rerank","model","kb_profile","shape"]       // hangi kararlar pay alÄ±r
  },

  propose:{
    candidates:[
      { scope:"qo", diff:{ topK:"-20|floor:20" } },
      { scope:"qo", diff:{ reranker:"ce-smallâ†’none" } },
      { scope:"tune", diff:{ profile:"ivf-pq np:16â†’12" } },
      { scope:"shape", diff:{ deadlineMs:"-100" } }
    ],
    maxSimultaneous:2,
    needHumanReviewIf:{ riskHigh:true, fairnessCloseToLimit:true }
  },

  rollout:{
    canary:{ trafficPct:10, durationMin:30 },
    promoteCriteria:{ p95MsMax:900, ndcg10Min:0.50, costUsdMax:0.015, safetyNoWorse:true },
    rollbackCriteria:{ ndcgDropPct:3.0, p95RiseMs:80, safetyEvent:true }
  },

  integrations:{
    qo:"LIVIA-55", shape:"LIVIA-54", tune:"LIVIA-47",
    cost:"LIVIA-34", costGuard:"LIVIA-53", slo:"LIVIA-32",
    safety:"LIVIA-56", evidence:"LIVIA-57", fresh:"LIVIA-58",
    freeze:"LIVIA-51", ab:"LIVIA-45",
    provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48", dist:"LIVIA-22"
  },

  rbacViews:{ observer:{ hideBanditParams:true, showOnlyOutcomes:true } },

  cache:{ ttlSec:1800, keyBy:["policyHash","datasetHash","scope"] },

  idempotencyTtlSec: 3600
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

Toplama & Normalize: explicit/implicit/sistem sinyallerini aynÄ± Ã¶rnek uzayÄ±nda birleÅŸtir; opt-out ve observer kurallarÄ±nÄ± uygula.

Attribution: karar yolundaki adÄ±mlara (retrieve/rerank/model/shape/tune) SHAP-vari + last-touch ile kredi daÄŸÄ±t.

Tahmin & DeÄŸerlendirme:

Online: linUCB/TS ile baÄŸlamsal seÃ§im; exploration bÃ¼tÃ§esi ve tier sÄ±nÄ±rlarÄ±.

Offline: IPS/DR (propensity-logâ€™lu) ile karÅŸÄ±-olgusal; clipW ve bootstrap CI.

Ã–neri: propose.candidates ve Ã¶ÄŸrenme sinyalleriyle en gÃ¼venli deÄŸiÅŸiklikleri hazÄ±rla.

Guardrails: SLO/Cost/Safety/Fairness kÄ±sÄ±tlarÄ± + SPI (safe policy improvement); risk yÃ¼ksekse manual review.

Rollout: canary (L45) â†’ promote/rollback; freeze aktifse yalnÄ±z simÃ¼lasyon.

Rapor: WORM/Lineage/Audit ile kaydet; dist (L22) ile kart/rapor daÄŸÄ±t.

6) Pipeline (Kompozisyon)

Collect: feedback & davranÄ±ÅŸ & sistem metrikleri

Join: qo.decision.path + propensities + outcomeâ€™lar

Attrib: karar adÄ±mlarÄ±na etki paylaÅŸtÄ±r

Estimate: IPS/DR ile uplift, CI, risk

Propose: gÃ¼venli deÄŸiÅŸiklik seti oluÅŸtur

Rollout: canary baÅŸlat, izle, promote/rollback

Emit: estimate.snapshot, proposal.ready, rollout.started/evaluation, policy.applied/rolledback, card/alert/metrics/report

Audit/Provenance/Lineage: tam izlenebilirlik

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (learning.dataset.snapshot veya yeterli sinyal eÅŸiÄŸi) ESTIMATE

ESTIMATE â†’ PROPOSE â†’ (freeze? SIMULATE) else ROLLOUT â†’ EVALUATE â†’ APPLY/ROLLBACK â†’ REPORT â†’ IDLE

Hata: ALERT; idem: aynÄ± learnKey yinelemesinde yalnÄ±z snapshot/metrik gÃ¼ncellenir

8) Kenar Durumlar

Propensity Eksik/DÃ¼ÅŸÃ¼k: DR kullan, clipW uygula; propensity_low uyarÄ±sÄ±.

Bias/Ä°mbalance: veri dengesizse reweigh/stratified resample; dataset_bias.

Konsept KaymasÄ±: PSI/KS test â†’ bÃ¼yÃ¼k sapmada eski politikaya aÄŸÄ±rlÄ±k; yeni politika canary-only.

Fairness YakÄ±n Limit: Â±10% eÅŸik yakÄ±n â†’ human review zorunlu.

Safety/PII: safety olaylarÄ± artÄ±yorsa Ã¶neri reddedilir.

Freeze Aktif: yalnÄ±z proposal.ready ve simulate; freeze_active.

Observer: bandit parametreleri gizlenir; yalnÄ±z sonuÃ§lar gÃ¶rÃ¼nÃ¼r.

Idempotency: aynÄ± dataset/pencere iÃ§in ikinci Ã¶ÄŸrenim yan etkisiz.

9) Telemetri
{
  "learn.metrics": {
    "event":"learn.metrics","timestamp":"iso8601",
    "onlineBandit":{"method":"linUCB","explorePct":5,"regretMean":-0.012,"updates":84},
    "offline":{"ipsVar":0.006,"drVar":0.004,"ciWidth.acceptRate":2.3},
    "proposals":3,"applied":1,"rolledBack":0,
    "quality":{"ndcg10":"+0.6pp","acceptRate":"+1.8pp"},
    "slo":{"p95Ms":"+10ms"},"cost":{"usdPerQuery":"-0.0016"},
    "fairnessOk":true,"safetyIncidentsDelta":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/feedbackLearningLooper.ts               # FSM + orchestrator
services/livia/lib/learn/collect.ts                    # sinyal ingest + normalize
services/livia/lib/learn/attrib.ts                     # attribution (shaplike+last_touch)
services/livia/lib/learn/estimate.ts                   # IPS/DR + CI + drift test
services/livia/lib/learn/propose.ts                    # gÃ¼venli deÄŸiÅŸiklik Ã¼retici
services/livia/lib/learn/rollout.ts                    # canary/promote/rollback orkestrasyonu
services/livia/lib/learn/report.ts                     # md/html rapor + inline grafik
services/livia/lib/bridges.ts                          # L21/L22/L26/L32/L34/L38/L39/L45/L47/L48/L51/L53/L54/L55/L56/L57/L58
services/livia/state/learnStore.ts                     # idem index + dataset cache + proposals
services/livia/__tests__/feedbackLearningLooper.test.ts
cfg/livia.learn.yaml

11) Test Ä°skeleti (Jest/Vitest)

Offline DR: topK -20 iÃ§in DR uplift +1.5pp (CI>0) â†’ proposal.ready

Guardrail Ä°hlali: NDCG dÃ¼ÅŸÃ¼ÅŸ â‰¥3pp â†’ learn.rollout.evaluation(result=rollback)

Freeze: frozen â†’ simulate ve freeze_active uyarÄ±sÄ±; apply yok

Fairness: acceptRate tier disparity >10% â†’ fairness_violation, Ã¶neri iptal

Propensity Low: IPS varyans yÃ¼ksek â†’ drâ€™a geÃ§iÅŸ

Konsept KaymasÄ±: PSI>0.2 â†’ canary extended; promote ertelendi

Idempotency: aynÄ± learnKey yinelenmesinde ikinci kez yan etki yok

Rapor: md/html Ã¼retildi; L38/L48 kaydÄ±; kart/metrik Ã¼retildi

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

14:00â€“15:00 sinyaller toplandÄ±; dataset 12420 Ã¶rnek, DR uplift +2.1pp

PROPOSE: Qo topK 60â†’40, guardrails: p95â‰¤900, NDCGâ‰¥0.50

ROLLOUT: canary %10/30dk; sonuÃ§lar iyi â†’ promote

APPLY: L45/L55/L47 ile uygulandÄ±; kart info, rapor ve metrikler yayÄ±nlandÄ±

13) SLO

Estimate p95 < 120 ms (1k Ã¶rnek baÅŸÄ±na)

YanlÄ±ÅŸ promote â‰¤ %1.5, gereksiz rollback â‰¤ %3

Fairness ihlali â‰¤ %1, safety olay artÄ±ÅŸÄ± â‰¤ 0

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0

hazÄ±r. SÄ±rada LIVIA-62 Â· autoRunbookSynthesizer.ts (incident ve tekrarlÄ± gÃ¶revlerden canlÄ± Ã§alÄ±ÅŸtÄ±rÄ±labilir runbook Ã¼retimi: adÄ±m Ã§Ä±karÄ±mÄ±, koÅŸul/if-guard, parametreleÅŸme, simÃ¼lasyon ve onay akÄ±ÅŸÄ±). â€œDevamâ€ dersen aynÄ± kalitede Ã§Ä±karÄ±rÄ±m.

Åunu dedin:
Devam et
ChatGPT:
LIVIA-62 Â· autoRunbookSynthesizer.ts â€” GeniÅŸ Prompt v3 (+ CanlÄ± Ã‡alÄ±ÅŸtÄ±rÄ±labilir Runbook, AdÄ±m MadenciliÄŸi, SimÃ¼lasyon, Onay AkÄ±ÅŸÄ±)

AmaÃ§:
Incidentâ€™lar ve tekrarlayan operasyon gÃ¶revlerinden canlÄ± Ã§alÄ±ÅŸtÄ±rÄ±labilir runbook Ã¼retmek:
log/konuÅŸma/olay akÄ±ÅŸÄ± â†’ adÄ±m madenciliÄŸi â†’ koÅŸullar/guardlar â†’ parametreleÅŸme â†’ pre/post-checkâ€™ler â†’ simÃ¼lasyon (dry-run) â†’ onay â†’ yÃ¼rÃ¼tme/izleme â†’ geri-al (rollback).
Ã‡Ä±ktÄ±: Markdown rehber + yÃ¼rÃ¼tÃ¼lebilir DSL (YAML/JSON); idempotent, audit + lineage, RBAC & gÃ¼venlik gÃ¶zetimli.
Entegrasyon: Incident (L15/L52), Release Freeze (L51), SLO (L32), Traffic (L54), Qo (L55), Safety (L56), Evidence (L57), Freshness (L58), KB Tuning (L47), Cost (L34/L53), Drills (L50), Failover (L49), Provenance/Audit/Lineage (L38/L48/L39), Dist (L22).
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel gÃ¼n 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: ops|sre|policy|security tam, observer salt okur

Gizlilik: PII/sÄ±r bilgiler redakte (L21); gizli anahtarlar vault ref ile kullanÄ±lÄ±r

Ä°dempotency: rbKey = incidentId|taskId + templateId + env + version + windowISO

Observability: spans (rb.mine|design|simulate|approve|execute|rollback|report) + OTel metrics

Uyumluluk: tÃ¼m adÄ±mlar WORM (L38) ve Audit (L48)â€™e; Lineage (L39) ile baÄŸlar

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "incident.timeline.snapshot": {
    "event":"incident.timeline.snapshot","timestamp":"iso8601",
    "id":"inc-2025-09-13-1","severity":"high",
    "events":[
      {"t":"iso8601","kind":"alert","msg":"Slip spike on SG02"},
      {"t":"iso8601","kind":"action","actor":"ops#h1","cmd":"rollback policy v42â†’v41"},
      {"t":"iso8601","kind":"result","msg":"latency normalized"}
    ],
    "rootCause":"policy-regression"
  },

  "ops.activity.logs": {
    "event":"ops.activity.logs","timestamp":"iso8601",
    "source":"cli|slack|pagerduty|jira|kubectl",
    "entries":[
      {"t":"iso8601","actor":"ops#h1","cmd":"kubectl rollout undo deploy/kb-api --to-revision=41","exit":0},
      {"t":"iso8601","actor":"ops#h2","cmd":"helm rollback kb-api 41","exit":0}
    ]
  },

  "slo.window.metrics": {
    "event":"slo.window.metrics","timestamp":"iso8601",
    "serviceId":"kb_api","window":"5m","p95Ms":920,"errPct":1.3,"burnPct":4.8
  },

  "capability.registry": {
    "event":"capability.registry","timestamp":"iso8601",
    "actions":[
      {"id":"kubectl.rollout.undo","params":["deploy","toRevision"],"pre":["kube.ctx"],"post":["deploy.status"],"risk":"med"},
      {"id":"feature.flag.set","params":["flag","value"],"risk":"low"},
      {"id":"gateway.rate.update","params":["path","rps","burst"],"risk":"med"}
    ]
  },

  "runbook.template.registered": {
    "event":"runbook.template.registered","timestamp":"iso8601",
    "templateId":"rb-rollback-policy",
    "dslVersion":"1.0",
    "steps":[
      {"use":"gateway.rate.update","with":{"path":"/answer","rps":40,"burst":80},"if":"slo.burn>4"},
      {"use":"kubectl.rollout.undo","with":{"deploy":"kb-api","toRevision":41}},
      {"checkpoint":"verify_slo","expect":{"p95<":"900","errPct<":"1.0"}}
    ]
  },

  "environment.inventory": {
    "event":"environment.inventory","timestamp":"iso8601",
    "env":"prod","services":["kb_api","gateway","search"],"regions":["eu-central","us-east"]
  },

  "policy.guardrails": {
    "event":"policy.guardrails","timestamp":"iso8601",
    "constraints":{
      "requiresApprovalFor":["risk=high|med","prod"],
      "maxConcurrentActions":2,"freezeRespect":true,
      "costMaxUsdPerChange":10
    }
  },

  "approval.state": {
    "event":"approval.state","timestamp":"iso8601",
    "runbookId":"rb#inc-2025-09-13-1","status":"pending|approved|rejected",
    "by":"opslead#h0","ttlMin":30
  },

  "secret.vault.reference": {
    "event":"secret.vault.reference","timestamp":"iso8601",
    "keys":[{"name":"kube.ctx","ref":"vault://kube/prod/context"}]
  },

  "freeze.state.changed": {
    "event":"freeze.state.changed","timestamp":"iso8601",
    "state":"frozen|thawed","scope":"global|service:kb_api","reason":"incident|audit|drill"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "runbook.synth.ready": {
    "event":"runbook.synth.ready","timestamp":"iso8601",
    "runbookId":"rb#inc-2025-09-13-1",
    "title":"Rollback Policy v42â†’v41 + SLO Stabilizasyonu",
    "dslVersion":"1.0",
    "pathYaml":"data/runbooks/2025-09-13/rb_inc-1.yaml",
    "pathMd":"data/runbooks/2025-09-13/rb_inc-1.md",
    "summary":"Ã–nce gateway kÄ±sma, sonra rollback, ardÄ±ndan SLO doÄŸrulama.",
    "params":{"deploy":"kb-api","toRevision":41,"path":"/answer","rps":40,"burst":80},
    "hash":"sha256:..."
  },

  "runbook.simulation.report": {
    "event":"runbook.simulation.report","timestamp":"iso8601",
    "runbookId":"rb#inc-2025-09-13-1",
    "mode":"dry-run","checks":{
      "pre":"ok","capabilities":{"missing":[]},
      "impactEst":{"p95":"-80ms","costUsd":"+1.2","risk":"med"}
    },
    "issues":[]
  },

  "runbook.approval.request": {
    "event":"runbook.approval.request","timestamp":"iso8601",
    "runbookId":"rb#inc-2025-09-13-1",
    "needed":["ops_lead"],"ttlSec":1800,
    "reason":"risk=med & env=prod (guardrail)"
  },

  "runbook.execute.request": {
    "event":"runbook.execute.request","timestamp":"iso8601",
    "runbookId":"rb#inc-2025-09-13-1","env":"prod","region":"eu-central",
    "mode":"automated|semi|manual","approvedBy":"opslead#h0"
  },

  "runbook.execute.progress": {
    "event":"runbook.execute.progress","timestamp":"iso8601",
    "runbookId":"rb#inc-2025-09-13-1",
    "step":2,"use":"kubectl.rollout.undo","status":"ok|fail|skipped",
    "stdout":"...","stderr":"...", "durationMs":4200
  },

  "runbook.execute.status": {
    "event":"runbook.execute.status","timestamp":"iso8601",
    "runbookId":"rb#inc-2025-09-13-1","final":"success|partial|failed",
    "observations":{"p95Ms":860,"errPct":0.9},
    "rollbackUsed":false
  },

  "runbook.rollback.invoked": {
    "event":"runbook.rollback.invoked","timestamp":"iso8601",
    "runbookId":"rb#inc-2025-09-13-1","reason":"checkpoint_failed","status":"ok|fail"
  },

  "runbook.card": {
    "event":"runbook.card","timestamp":"iso8601",
    "title":"Runbook HazÄ±r â€” inc-2025-09-13-1",
    "body":"dry-run ok â€¢ onay bekliyor â€¢ 3 adÄ±m â€¢ risk: orta.",
    "severity":"info","ttlSec":600
  },

  "runbook.alert": {
    "event":"runbook.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"idem_duplicate|rbac_denied|freeze_active|capability_missing|precheck_failed|approval_required|exec_failed|checkpoint_failed|rollback_failed|cost_limit"
  },

  "runbook.metrics": {
    "event":"runbook.metrics","timestamp":"iso8601",
    "synth":1,"dryRuns":1,"exec":1,"rollbacks":0,
    "avgDesignMs":92,"avgExecMs":8500,"stepSuccessPct":96
  },

  "runbook.report.ready": {
    "event":"runbook.report.ready","timestamp":"iso8601",
    "path":"data/runbooks/2025-09-13/rb_inc-1/report.md",
    "summary":"3 adÄ±m yÃ¼rÃ¼tÃ¼ldÃ¼, p95 920â†’860ms; rollback gerekmedi.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  dsl:{ version:"1.0", schema:"zod.strict", fileExt:"yaml", allowIncludes:true },

  mining:{
    sources:["incident.timeline","ops.logs","chat.slack","jira"],
    heuristics:{
      mergeDuplicates:true, orderBy:"causal", collapseNoops:true,
      parameterize:{ detectEnv:true, detectVersions:true, detectPaths:true }
    },
    patterns:[
      { name:"rollback_then_verify", match:["rollout.undo","verify_slo"] },
      { name:"rate_limit_then_change", match:["gateway.rate.update","apply_change","verify"] }
    ],
    libraryPreference:["runbook.template.registered","capability.registry"]
  },

  guardrails:{
    requiresApprovalFor:["riskâ‰¥med","env=prod"],
    maxConcurrentActions:2, checkpointEnforce:true,
    freezeRespect:true, costMaxUsdPerChange:10
  },

  simulation:{
    enable:true, mode:"dry-run", sandbox:"ephemeral-ns", mockIO:true,
    impactModel:{ sloDeltaMsPerAction:{ "gateway.rate.update":-60, "kubectl.rollout.undo":-40 }, costPerActionUsd:{ "kubectl.rollout.undo":0.8 } }
  },

  execution:{
    modeDefault:"semi", retry:{ max:1, backoffMs:1500 },
    timeouts:{ perStepMs:120000, totalMs:900000 },
    secrets:{ via:"vault", redact:true },
    checkpoint:{
      slo:{ p95MsMax:900, errPctMax:1.0 },
      custom:["deploy.status","gateway.rules.applied"]
    }
  },

  approvals:{ roles:["ops_lead","security"], ttlMin:30 },

  integrations:{
    incident:"LIVIA-15|LIVIA-52", freeze:"LIVIA-51", slo:"LIVIA-32",
    traffic:"LIVIA-54", qo:"LIVIA-55", safety:"LIVIA-56",
    evidence:"LIVIA-57", fresh:"LIVIA-58", tune:"LIVIA-47",
    cost:"LIVIA-34", costGuard:"LIVIA-53", drills:"LIVIA-50",
    provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48", dist:"LIVIA-22"
  },

  rbacViews:{ observer:{ hideSecrets:true, showOnlySummary:true } },

  idempotencyTtlSec: 3600
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

AdÄ±m MadenciliÄŸi: incident zaman akÄ±ÅŸÄ± + komut loglarÄ± + kapasiteler â†’ kanditat adÄ±mlar; de-dup, sÄ±ralama (nedensel), parametreleÅŸme.

Åablonlama: varsa template ile eÅŸle; yoksa motif/pattern ile iskelet Ã¼ret.

Guardlar: freeze aktifse yalnÄ±z taslak & simÃ¼lasyon; prod & riskâ‰¥med â†’ onay zorunlu; maliyet sÄ±nÄ±rÄ±.

SimÃ¼lasyon: sandbox/dry-run ile precheck (capability, env, secret); etki tahmini (SLO/cost).

KoÅŸullar/Checkpointâ€™ler: if/when ile koÅŸullu adÄ±mlar; pre/post-check zorunlu.

YÃ¼rÃ¼tme: onay alÄ±ndÄ±ysa seri + maxConcurrentActions; adÄ±m baÅŸarÄ±sÄ±zsa rollback dalÄ±.

Telemetri & Rapor: her adÄ±m stdout/stderr + sÃ¼resi; SLO gÃ¶zlemi; sonuÃ§lar WORM/Audit/Lineage.

6) Pipeline (Kompozisyon)

Mine: timeline/loglardan adÄ±mlarÄ± Ã§Ä±kar

Design: template/motif ile DSL + Markdown Ã¼ret

Simulate: dry-run; precheck, impact estimasyonu

Approve: guardrail gereÄŸi onay iste

Execute: adÄ±mlarÄ± yÃ¼rÃ¼t; pre/post-check, rollback planÄ±

Observe: SLO/metrikler; cost & etkiler

Emit: synth.ready, simulation.report, approval.request, execute.*, card/alert/metrics/report

Persist: L38/L48/L39 kayÄ±tlarÄ±; runbook kataloguna ekle

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (incident.timeline.snapshot|ops.activity.logs|runbook.template.registered) MINE

MINE â†’ DESIGN â†’ SIMULATE â†’ (freeze? PARKED) | (approval_needed? AWAIT_APPROVAL) | READY_TO_EXEC

AWAIT_APPROVAL â†’ (approved) READY_TO_EXEC | (rejected/timeout) DONE

READY_TO_EXEC â†’ EXECUTE â†’ (success) REPORT | (checkpoint_failed) ROLLBACK â†’ REPORT

Hata: ALERT; idem: aynÄ± rbKey yinelemesinde yan etki yok (yalnÄ±z rapor/gÃ¼ncelleme)

8) Kenar Durumlar

Capability Eksik: kayÄ±tlÄ± aksiyon yok â†’ capability_missing + Ã¶neri: â€œmanual step / template registerâ€.

Ã‡akÄ±ÅŸan AdÄ±mlar: aynÄ± hedefi etkileyen paralel adÄ±mlar â†’ seri hale getir veya maxConcurrentActions uygulanÄ±r.

Environment Drift: simÃ¼lasyon ok, gerÃ§ek yÃ¼rÃ¼tmede env farkÄ± â†’ precheck_failed; rollback.

Freeze Aktif: yalnÄ±z taslak + dry-run; freeze_active uyarÄ±sÄ±, yÃ¼rÃ¼tme yok.

Gizli Anahtar Eksik: vault referansÄ± Ã§Ã¶zÃ¼lemez â†’ rbac_denied|secret_missing.

Maliyet SÄ±nÄ±rÄ±: planlanan deÄŸiÅŸiklik cost Ã¼stÃ¼ â†’ cost_limit ve onay zorunlu.

Drill Modu: L50 tatbikatÄ±nda sandbox-only yÃ¼rÃ¼t; prod kapalÄ±.

Observer: stdout/stderr ve secrets gizlenir; sadece Ã¶zet.

Ä°dempotency: aynÄ± incident/runbook tekrarÄ±nda mevcut DSL Ã¼zerine append (versiyonlama); ikinci yÃ¼rÃ¼tmede skip.

9) Telemetri
{
  "runbook.metrics": {
    "event":"runbook.metrics","timestamp":"iso8601",
    "synth":1,"dryRuns":1,"exec":1,"rollbacks":0,
    "avgDesignMs":92,"avgExecMs":8500,"stepSuccessPct":96,
    "approvalWaitMs":42000,"costUsd":1.2
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/autoRunbookSynthesizer.ts              # FSM + orchestrator
services/livia/lib/runbook/mine.ts                     # adÄ±m madenciliÄŸi (timeline/log/chat)
services/livia/lib/runbook/design.ts                   # DSL Ã¼retimi + Markdown ÅŸablonu
services/livia/lib/runbook/simulate.ts                 # dry-run + etki tahmini + precheck
services/livia/lib/runbook/approve.ts                  # onay akÄ±ÅŸÄ± (ttl/roles)
services/livia/lib/runbook/execute.ts                  # adÄ±m yÃ¼rÃ¼tÃ¼cÃ¼ + checkpoint/rollback
services/livia/lib/runbook/report.ts                   # md/html rapor + inline grafik
services/livia/lib/bridges.ts                          # L21/L22/L26/L32/L34/L38/L39/L47/L48/L49/L50/L51/L53/L54/L55/L56/L57/L58
services/livia/state/runbookStore.ts                   # idem index + katalog + sÃ¼rÃ¼mler
services/livia/__tests__/autoRunbookSynthesizer.test.ts
cfg/livia.runbook.yaml

11) Test Ä°skeleti (Jest/Vitest)

Madencilik: timeline+logs â†’ 3 adÄ±m, parametreleÅŸme doÄŸru

Template EÅŸlemesi: rb-rollback-policy seÃ§ildi; DSL oluÅŸtu

SimÃ¼lasyon: dry-run ok; etkiler (p95 -80ms) tahmin edildi

Onay: risk=med & prod â†’ onay istenir; onay gelmeden execute yok

YÃ¼rÃ¼tme: adÄ±mlar sÄ±rasÄ±yla, checkpoint p95<900 & err<1.0 geÃ§ti

Rollback DalÄ±: checkpoint fail â†’ rollback Ã§aÄŸrÄ±lÄ±r

Freeze: frozen â†’ yalnÄ±z synth.ready + simulation.report; execute.request yok

Idempotency: aynÄ± rbKey tekrarÄ±nda dosya overwrite yok; versiyon artÄ±ÅŸÄ±

Rapor: md/html dosyalarÄ± yazÄ±ldÄ±; L22 ile daÄŸÄ±tÄ±ldÄ±; L38/L48 kayÄ±tlandÄ±

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

18:12 MINE: incident + ops log â†’ â€œrate limit â†“ â†’ rollback â†’ verify SLOâ€

18:13 DESIGN: DSL + Markdown Ã¼retildi; vault ref eklendi

18:13 SIMULATE: dry-run ok; p95 tahmini -80ms

18:14 APPROVE: ops_lead onayladÄ± (TTL 30dk)

18:15 EXECUTE: 3 adÄ±m, 8.5s toplam; SLO p95 920â†’860ms; rollback gerekmedi

18:16 REPORT: kart/metrik/rapor yayÄ±mlandÄ±

13) SLO

Synth (design) p95 < 150 ms

Dry-run precheck p95 < 400 ms

Exec baÅŸarÄ±sÄ± â‰¥ %95 (checkpointâ€™lerle)

YanlÄ±ÅŸ yÃ¼rÃ¼tme (rollback gerektiren) â‰¤ %2

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-63 Â· policyDriftDetector.ts â€” GeniÅŸ Prompt v3 (+ Ã‡ok-KatmanlÄ± Drift, Risk Skoru, Oto-DÃ¼zeltme PlanÄ±)

AmaÃ§:
TÃ¼m kritik politika/konfig yÃ¼zeylerinde (LLM/qo planlarÄ±, guardrail/safety, KB/freshness, cost/slo, release, RBAC/iam, feature-flag, connector/secret, infra) drift (hedef â†’ gerÃ§ek) tespit etmek; risk skorla, kÃ¶k nedenlendir, etki simÃ¼le et, dÃ¼zeltme planÄ± (fix/roll-forward/roll-back) Ã¶ner ve (gerekirse) canary + onay ile uygula.
Entegrasyon: Release Freeze (L51), Qo (L55), Safety (L56), Evidence (L57), Freshness (L58), Personalization (L59), MLang (L60), Learning (L61), Runbook (L62), Cost (L34/L53), SLO (L32), Audit/Provenance/Lineage (L48/L38/L39), Dist (L22).
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; yerel pencere 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: policy|mlops|ops|security|compliance tam, observer salt-okur

Gizlilik: PII yok; aktÃ¶r/tenant kimlikleri L21 hash

Ä°dempotency: driftKey = scope + target + baselineHash + windowISO

Observability: spans (drift.collect|diff|score|simulate|propose|apply|report)

Uyumluluk: karar/Ã¶neri/uygulamalar WORM (L38), Lineage (L39), Audit (L48)

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "baseline.snapshot.registered": {
    "event":"baseline.snapshot.registered","timestamp":"iso8601",
    "target":"qo|safety|fresh|cost|slo|release|rbac|feature|connector|infra",
    "version":"2025-09-15#42",
    "specHash":"sha256:...","specUrl":"git+https://...#commit",
    "spec":{"json|yaml": "..."}                      // normalize edilmiÅŸ
  },

  "runtime.snapshot.captured": {
    "event":"runtime.snapshot.captured","timestamp":"iso8601",
    "target":"qo|safety|fresh|cost|slo|release|rbac|feature|connector|infra",
    "env":"prod|stg|dev","source":"live_api|k8s|vault|flags|cfgdb",
    "specHash":"sha256:...","spec":{"json":"..."}     // gerÃ§ek durum
  },

  "change.intent.declared": {
    "event":"change.intent.declared","timestamp":"iso8601",
    "ticket":"jira-1234","actor":"ops#h1","target":"qo",
    "diff":{"plan":"P-hybrid-fastâ†’P-vec-lite"},"window":"iso8601-iso8601"
  },

  "freeze.state.changed": {
    "event":"freeze.state.changed","timestamp":"iso8601",
    "state":"frozen|thawed","scope":"global|service:kb_api","reason":"incident|audit|drill"
  },

  "policy.guardrails": {
    "event":"policy.guardrails","timestamp":"iso8601",
    "constraints":{
      "allowAutoApplyFor":["risk=low","env=stg"],
      "requireApprovalFor":["riskâ‰¥med","env=prod"],
      "maxAutoChangesPerDay":3
    }
  },

  "slo.window.metrics": {
    "event":"slo.window.metrics","timestamp":"iso8601",
    "serviceId":"kb_api","window":"5m|1h",
    "p95Ms":842,"errPct":0.7,"burnPct":3.1
  },

  "cost.window.metrics": {
    "event":"cost.window.metrics","timestamp":"iso8601",
    "window":"1h","avgUsdPerQuery":0.011
  },

  "ab.experiment.registered": {
    "event":"ab.experiment.registered","timestamp":"iso8601",
    "expId":"EXP-safety-thresholds","scope":"tenant:t#acme",
    "arms":[{"id":"A","sharePct":50},{"id":"B","sharePct":50}]
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "drift.diff.ready": {
    "event":"drift.diff.ready","timestamp":"iso8601",
    "target":"safety","env":"prod",
    "baselineVersion":"2025-09-15#42",
    "changes":[
      {"path":"/pii/confidenceMin","from":0.85,"to":0.75,"kind":"numeric"},
      {"path":"/grounding/minCitationCoveragePct","from":60,"to":40,"kind":"numeric"},
      {"path":"/categories/self_harm","from":"block","to":"filter","kind":"enum"}
    ],
    "semanticEquivalence":{"notes":"none","ok":false},
    "hash":"sha256:..."
  },

  "drift.score.snapshot": {
    "event":"drift.score.snapshot","timestamp":"iso8601",
    "target":"safety","env":"prod",
    "riskScore":0.83,
    "factors":{
      "surface":"safety","blastRadius":"global","severity":"high",
      "sloContext":{"p95Ms":842,"errPct":0.7,"burnPct":3.1},
      "costContext":{"avgUsdPerQuery":0.011},
      "changeIntentOverlap":false
    },
    "status":"warn|high|block"
  },

  "drift.impact.simulation": {
    "event":"drift.impact.simulation","timestamp":"iso8601",
    "target":"safety","env":"prod",
    "method":"counterfactual-replay",
    "estimates":{
      "toxicityIncidents":"+0.4pp [CI 0.1,0.8]",
      "acceptRate":"+0.2pp [CI -0.1,0.5]",
      "costUsd":"+0.0002"
    }
  },

  "drift.proposal.ready": {
    "event":"drift.proposal.ready","timestamp":"iso8601",
    "target":"safety","env":"prod",
    "actions":[
      {"type":"roll_back","paths":["/pii/confidenceMin","/grounding/minCitationCoveragePct","/categories/self_harm"],"toBaseline":"2025-09-15#42"},
      {"type":"guardrail","rule":"requireApprovalFor:safety.high"}
    ],
    "recommendation":"canary_10pct_20min_then_promote_if_ok",
    "needsApproval":true
  },

  "drift.apply.started": {
    "event":"drift.apply.started","timestamp":"iso8601",
    "target":"safety","env":"prod",
    "mode":"canary","trafficPct":10,"durationMin":20,
    "owner":"policy#h9"
  },

  "drift.apply.evaluation": {
    "event":"drift.apply.evaluation","timestamp":"iso8601",
    "target":"safety","result":"promote|rollback|extend",
    "guardrails":{"p95MsMax":900,"ndcg10Min":0.50,"safetyNoWorse":true}
  },

  "drift.card": {
    "event":"drift.card","timestamp":"iso8601",
    "title":"Policy Drift â€” safety (risk: yÃ¼ksek) â€¢ prod",
    "body":"3 alan baselineâ€™dan saptÄ± â€¢ Ã¶neri: roll-back (canary %10/20dk).",
    "severity":"warn","ttlSec":600
  },

  "drift.alert": {
    "event":"drift.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"idem_duplicate|rbac_denied|freeze_active|baseline_missing|runtime_missing|apply_failed|guardrail_breach"
  },

  "drift.metrics": {
    "event":"drift.metrics","timestamp":"iso8601",
    "targetsScanned":8,"driftFound":2,"autoFixed":1,
    "avgDiffMs":46,"avgScore":0.41,"blocked":0
  },

  "drift.report.ready": {
    "event":"drift.report.ready","timestamp":"iso8601",
    "path":"data/drift/2025-09-16/prod/report.md",
    "summary":"safety ve feature flag yÃ¼zeylerinde drift; safety roll-back canary ile dÃ¼zeldi.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  surfaces:[
    "qo","safety","fresh","cost","slo","release","rbac","feature","connector","infra"
  ],

  diff:{
    numericTolerance:{ relPct:1.0, abs:0.0001 },
    unorderedSets:true, caseInsensitiveKeys:true,
    semanticEquivalence:{ enable:true, nlpModel:"spec-sim-mini", threshold:0.92 }, // metin tabanlÄ± kurallar aynÄ± mÄ±?
    ignorePaths:["/metadata/updatedAt","/comments/*","/notes/*"]
  },

  scoring:{
    baseWeightBySurface:{ safety:0.35, qo:0.2, release:0.15, rbac:0.1, fresh:0.08, cost:0.06, slo:0.06 },
    blastRadiusWeights:{ global:1.0, tenant:0.6, service:0.7, feature:0.4 },
    severityMap:{ low:0.2, med:0.5, high:0.8 },
    contextMods:{ sloBurn:{ lt2:0, lt5:0.05, gte5:0.1 }, costHigh:+0.05 },
    thresholds:{ warn:0.6, block:0.8 }
  },

  simulate:{
    method:"counterfactual-replay",            // geÃ§miÅŸ log + propensities
    minSamples:1000, ci:"bootstrapB=200", clipW:10,
    guardrails:{ p95MsMax:900, ndcg10Min:0.50, safetyNoWorse:true }
  },

  proposals:{
    actions:["fix","roll_back","roll_forward","guardrail","document"],
    prefer:"roll_back_if_riskâ‰¥high_else_fix",
    requireApprovalFor:["env=prod","riskâ‰¥med"],
    maxAutoChangesPerDay:3
  },

  apply:{
    via:"LIVIA-45 (canary) + L62 (runbook) when needed",
    canary:{ trafficPct:10, durationMin:20, promoteIf:"guardrails_ok" },
    rollbackCriteria:{ ndcgDropPct:3.0, p95RiseMs:80, safetyEvent:true }
  },

  schedule:{ cron:"*/15 * * * *" },           // 15 dakikada bir tarama

  integrations:{
    freeze:"LIVIA-51", qo:"LIVIA-55", safety:"LIVIA-56", evidence:"LIVIA-57",
    fresh:"LIVIA-58", pers:"LIVIA-59", mlang:"LIVIA-60", learn:"LIVIA-61", runbook:"LIVIA-62",
    slo:"LIVIA-32", cost:"LIVIA-34", costGuard:"LIVIA-53",
    provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48", dist:"LIVIA-22"
  },

  rbacViews:{ observer:{ hideDiffDetails:true, showOnlyScores:true } },

  cache:{ ttlSec:600, keyBy:["target","env","baselineHash"] },

  idempotencyTtlSec: 1800
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

Topla: en gÃ¼ncel baseline (git/registry) ve runtime (live kaynaklar) snapshotâ€™larÄ±nÄ± Ã§ek.

KarÅŸÄ±laÅŸtÄ±r: yapÄ±landÄ±rÄ±lmÄ±ÅŸ diff (numeric tolerans, set eÅŸleme, anahtar duyarsÄ±zlÄ±ÄŸÄ±) + semantik eÅŸdeÄŸerlik.

SÄ±nÄ±fla: drift â†’ noise|benign|risk_low|risk_med|risk_high; blastRadius (global/tenant/service) ve surface aÄŸÄ±rlÄ±klarÄ±yla riskScore Ã¼ret.

Kapsam & BaÄŸlam: SLO/cost penceresi ve ilan edilmiÅŸ deÄŸiÅŸikliklerle (change.intent) niyet uyumu kontrol et; niyet dÄ±ÅŸÄ± sapmalara Ã¶ncelik ver.

SimÃ¼le: karÅŸÄ±-olgusal replay ile etki tahmini (acceptRate, p95, cost, safety).

Ã–ner: kural: riskâ‰¥high â†’ roll_back; risk=med â†’ fix (targeted); low â†’ document or schedule. Guardrail ve freezeâ€™e saygÄ±.

Uygula: freeze aktifse yalnÄ±z Ã¶neri/rapor; deÄŸilse canary + guardrail; gerekirse L62 runbook ile yarÄ±-otomatik.

Kaydet & Yay: diff/score/sim/Ã¶neri/uygulama durumlarÄ±nÄ± WORM/Lineage/Audit; kart/rapor L22.

6) Pipeline (Kompozisyon)

Collect â†’ baseline & runtime snapshotlarÄ±nÄ± oku

Diff â†’ yapÄ±sal + semantik karÅŸÄ±laÅŸtÄ±rma

Score â†’ risk puanÄ± (surface/blastRadius/severity + baÄŸlam)

Simulate â†’ karÅŸÄ±-olgusal replay + CI

Propose â†’ fix/roll-back/roll-forward/guardrail

Apply â†’ (freeze? park et) | (canary + guardrails) | (runbook ile yarÄ±-otomatik)

Emit â†’ diff.ready, score.snapshot, impact.simulation, proposal.ready, apply.*, card/alert/metrics/report

Persist â†’ L38/L39/L48 kayÄ±tlarÄ±; cache gÃ¼ncelle

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (baseline.registered|runtime.captured|schedule.tick) DIFF

DIFF â†’ SCORE â†’ (risk<warn) REPORT | (warnâ‰¤risk<block) SIMULATE â†’ PROPOSE | (â‰¥block) PROPOSE

PROPOSE â†’ (freeze? PARK) | (approval? AWAIT_APPROVAL) | APPLY

APPLY â†’ EVALUATE â†’ PROMOTE/ROLLBACK/EXTEND â†’ REPORT â†’ IDLE

Hata: ALERT; idem: aynÄ± driftKey yinelemesinde yalnÄ±z kart/metrik gÃ¼ncellenir

8) Kenar Durumlar

Baseline Eksik/Eski: baseline_missing â†’ L58â€™le freshness uyar; varsayÄ±lan: no-op + document.

Runtime Ã‡ok KaynaklÄ±: Ã§akÄ±ÅŸan kaynaklar â†’ consensus (Ã§oÄŸunluk/Ã¶ncelik sÄ±rasÄ±) + uyarÄ±.

AB Deneyleri: deney kapsamÄ±nda beklenen farklar harici tutulur (whitelist).

Drift Storm: Ã§ok sayÄ±da kÃ¼Ã§Ã¼k drift â†’ coalesce ve batch Ã¶neri Ã¼ret.

Gizli Anahtar/Flag: vault/flag provider tutarsÄ±z â†’ connector drift, riskâ†‘.

NIYET Ã–rtÃ¼ÅŸmesi: change.intent ile eÅŸleÅŸen farklar benign puan dÃ¼ÅŸÃ¼rÃ¼r (zaman penceresi iÃ§inde).

Observer: diff ayrÄ±ntÄ±larÄ± gizlenir; yalnÄ±z risk/Ã¶neri gÃ¶sterilir.

Freeze: frozen â†’ yalnÄ±z propose/report; apply yok.

Idempotency: aynÄ± driftKey iÃ§in ikinci Ã§alÄ±ÅŸtÄ±rma yan etkisiz.

9) Telemetri
{
  "drift.metrics": {
    "event":"drift.metrics","timestamp":"iso8601",
    "targetsScanned":8,"driftFound":2,"autoFixed":1,"blocked":0,
    "avgDiffMs":46,"avgScore":0.41,
    "proposals":2,"applied":1,"rolledBack":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/policyDriftDetector.ts                # FSM + orchestrator
services/livia/lib/drift/collect.ts                  # baseline/runtime Ã§ekme (git/registry/k8s/vault/flags)
services/livia/lib/drift/diff.ts                     # yapÄ±sal + semantik diff
services/livia/lib/drift/score.ts                    # risk skoru (surface/blast/severity/baÄŸlam)
services/livia/lib/drift/simulate.ts                 # counterfactual replay + CI
services/livia/lib/drift/propose.ts                  # fix/roll-back/roll-forward/guardrail Ã¶nerici
services/livia/lib/drift/apply.ts                    # canary + guardrails + runbook kÃ¶prÃ¼leri
services/livia/lib/drift/report.ts                   # md/html rapor + inline grafik
services/livia/lib/bridges.ts                        # L22/L32/L34/L38/L39/L45/L48/L51/L55/L56/L57/L58/L59/L60/L61/L62
services/livia/state/driftStore.ts                   # idem index + snapshots + proposals
services/livia/__tests__/policyDriftDetector.test.ts
cfg/livia.drift.yaml

11) Test Ä°skeleti (Jest/Vitest)

Safety Drift: 3 kritik alan deÄŸiÅŸti â†’ riskâ‰¥high â†’ roll_back Ã¶nerisi

Qo Benign Drift: plan A/B deney whitelisted â†’ benign ve document

Counterfactual: 5k replay â†’ toxicity +0.3pp [CI pozitif] â†’ risk â†‘

Freeze: frozen â†’ apply yok; freeze_active kartÄ±

Canary Promote: guardrail OK â†’ promote; NDCG dÃ¼ÅŸÃ¼ÅŸÃ¼ %3.5 â†’ rollback

Batching: 12 kÃ¼Ã§Ã¼k feature-flag farkÄ± â†’ tek batch Ã¶neri

Idempotency: aynÄ± driftKey â†’ yalnÄ±z metrik gÃ¼ncellenir

Rapor: md/html yazÄ±ldÄ±; L22 ile daÄŸÄ±tÄ±ldÄ±; L38/L48 kayÄ±tlandÄ±

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

10:10 DIFF: safety (prod) baselineâ€™dan saptÄ± (3 alan).

10:11 SCORE: risk 0.83 (high); blastRadius global.

10:12 SIMULATE: toxicity +0.4pp (CI pozitif).

10:13 PROPOSE: roll_back + guardrail (canary %10/20dk, onay gerekir).

10:35 APPLY/EVAL: canary iyi â†’ promote.

10:40 REPORT: kart, metrik, rapor; WORM/Lineage/Audit tamamlandÄ±.

13) SLO

Tarama p95 < 70 ms/surface

YanlÄ±ÅŸ pozitif drift â‰¤ %2, kaÃ§an kritik drift â‰¤ %1

Ã–neri â†’ karar sÃ¼resi â‰¤ 15 dk (block durumlarÄ±nda)

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-64 Â· zeroDowntimeConfigApplier.ts â€” GeniÅŸ Prompt v3 (+ Atomic/Staged Apply, Health-Probe, Traffic-Shift, Rollback-Safe)

AmaÃ§:
Ã‡oklu yÃ¼zeylerde (Qo/Safety/Fresh/Cost/SLO/Release/RBAC/Feature/Connector/Infra) sÄ±fÄ±r kesinti ile konfig/politika deÄŸiÅŸikliklerini atomic/staged/canary olarak uygula:
diffâ†’planâ†’preflightâ†’shadow/dry-runâ†’staged apply (canary %X)â†’health/telemetri doÄŸrulamaâ†’traffic shiftâ†’promoteâ†’finalize; baÅŸarÄ±sÄ±zlÄ±kta otomatik rollback.
Entegrasyon: PolicyDrift (L63), Runbook (L62), Release Freeze (L51), AB/Canary (L45), Qo (L55), Traffic Shaper (L54), SLO (L32), Cost Guard (L53/L34), Safety (L56), Evidence (L57), Freshness (L58), Provenance/Lineage/Audit (L38/L39/L48), DR/MRF (L49/L50).
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

ISO-8601; gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: ops|policy|mlops|release tam, observer salt okur

Gizlilik: PII yok; kimlikler L21 ile hash; sÄ±rlar vault ref

Ä°dempotency: applyKey = target + env + planHash + windowISO

Observability: spans (zd.plan|preflight|shadow|apply.stage|probe|shift|promote|rollback|finalize) + metrics

Uyumluluk: her adÄ±m WORM (L38), Lineage (L39), Audit (L48) kayÄ±tlÄ±

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "config.apply.request": {
    "event":"config.apply.request","timestamp":"iso8601",
    "requestId":"req#8c12","target":"safety|qo|fresh|cost|slo|release|rbac|feature|connector|infra",
    "env":"prod|stg|dev","mode":"atomic|staged|canary",
    "diff":{"path":"/grounding/minCitationCoveragePct","from":60,"to":70},
    "sources":{"baseline":"2025-09-15#42","intent":"jira-1234"},
    "constraints":{"p95MsMax":900,"errPctMax":1.0,"costUsdMax":0.015},
    "canary":{"trafficPct":10,"durationMin":20},
    "freezeRespect":true
  },

  "config.bundle.request": {
    "event":"config.bundle.request","timestamp":"iso8601",
    "requestId":"req#8c12","env":"prod",
    "items":[
      {"target":"qo","diff":{"path":"/plan","from":"P-vec-lite","to":"P-hybrid-fast"}},
      {"target":"feature","diff":{"path":"/answer.rps","from":80,"to":120}}
    ],
    "atomicGroup":true, "ordering":"qoâ†’feature"
  },

  "health.probe.policy": {
    "event":"health.probe.policy","timestamp":"iso8601",
    "rules":{
      "slo":{"p95MsMax":900,"errPctMax":1.0},
      "acceptRateMin":0.50,
      "safetyNoWorse":true,
      "evidenceCoverageMin":0.60
    },
    "probeWindow":"5m","graceMin":5
  },

  "traffic.shift.capabilities": {
    "event":"traffic.shift.capabilities","timestamp":"iso8601",
    "providers":["envoy","istio","nginx"],
    "supports":{"weightedRoutes":true,"headerStickiness":true,"canaryByTenant":true}
  },

  "freeze.state.changed": {
    "event":"freeze.state.changed","timestamp":"iso8601",
    "state":"frozen|thawed","scope":"global|service:kb_api","reason":"incident|audit|drill"
  },

  "runbook.template.registered": {
    "event":"runbook.template.registered","timestamp":"iso8601",
    "templateId":"rb-config-rollback",
    "steps":[{"use":"config.rollback","with":{"requestId":"${requestId}"}}]
  },

  "slo.window.metrics": {
    "event":"slo.window.metrics","timestamp":"iso8601",
    "serviceId":"kb_api","window":"5m","p95Ms":860,"errPct":0.8
  },

  "cost.window.metrics": {
    "event":"cost.window.metrics","timestamp":"iso8601",
    "window":"5m","avgUsdPerQuery":0.0108
  },

  "traffic.current.split": {
    "event":"traffic.current.split","timestamp":"iso8601",
    "serviceId":"kb_api","splits":[{"rev":"baseline","pct":90},{"rev":"canary","pct":10}]
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "config.plan.ready": {
    "event":"config.plan.ready","timestamp":"iso8601",
    "requestId":"req#8c12","env":"prod","mode":"canary",
    "stages":[
      {"id":"shadow","desc":"dry-run+shadow read","checks":["schema","rbac","safety"]},
      {"id":"canary10","trafficPct":10,"durationMin":20,"checks":["slo","cost","safety","evidence"]},
      {"id":"promote","trafficPct":100,"checks":["post-verify"]}
    ],
    "rollbackPlan":"rb-config-rollback","hash":"sha256:..."
  },

  "config.preflight.report": {
    "event":"config.preflight.report","timestamp":"iso8601",
    "requestId":"req#8c12",
    "schemaOk":true,"rbacOk":true,"freeze":"thawed",
    "shadowWrite":"skipped|applied_to_shadow_env","issues":[]
  },

  "config.apply.stage.started": {
    "event":"config.apply.stage.started","timestamp":"iso8601",
    "requestId":"req#8c12","stage":"canary10","trafficPct":10
  },

  "health.probe.snapshot": {
    "event":"health.probe.snapshot","timestamp":"iso8601",
    "requestId":"req#8c12","stage":"canary10",
    "metrics":{"p95Ms":848,"errPct":0.7,"acceptRate":0.57,"evidenceCoverage":0.72,"safetyIncidentsDelta":0},
    "status":"ok|warn|fail"
  },

  "traffic.shift.applied": {
    "event":"traffic.shift.applied","timestamp":"iso8601",
    "requestId":"req#8c12","from":{"baseline":100},"to":{"canary":10,"baseline":90},
    "provider":"istio","stickiness":"header:tenant"
  },

  "config.apply.promoted": {
    "event":"config.apply.promoted","timestamp":"iso8601",
    "requestId":"req#8c12","finalTraffic":{"baseline":0,"canary":100},
    "postVerify":{"p95Ms":842,"errPct":0.8,"acceptRate":0.58}
  },

  "config.apply.rolledback": {
    "event":"config.apply.rolledback","timestamp":"iso8601",
    "requestId":"req#8c12","reason":"probe_fail|guardrail_breach|freeze_active",
    "via":"runbook:rb-config-rollback","durationSec":38
  },

  "config.card": {
    "event":"config.card","timestamp":"iso8601",
    "title":"Konfig UygulandÄ± â€” safety (canary %10â†’%100)",
    "body":"p95 860â†’842ms, err 0.8% â€¢ guardrails OK â€¢ zero-downtime.",
    "severity":"info","ttlSec":600
  },

  "config.alert": {
    "event":"config.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"idem_duplicate|rbac_denied|schema_incompatible|freeze_active|preflight_fail|probe_fail|guardrail_breach|shift_failed|rollback_failed|budget_exceeded"
  },

  "config.metrics": {
    "event":"config.metrics","timestamp":"iso8601",
    "applies":1,"promoted":1,"rolledBack":0,
    "avgPreflightMs":110,"avgProbeMs":4200,"avgStageMs":120000,
    "trafficShifts":2,"downtimeSec":0
  },

  "config.report.ready": {
    "event":"config.report.ready","timestamp":"iso8601",
    "path":"data/config/2025-09-16/req_8c12/report.md",
    "summary":"Canary %10/20dk â†’ promote. Guardrail ihlali yok. Zero-downtime.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  modes:{
    atomic:{ enable:true, requireMaintenanceWindow:true },
    staged:{ enable:true, stages:["shadow","25%","50%","100%"] },
    canary:{ enable:true, defaultTrafficPct:10, defaultDurationMin:20, provider:"istio" }
  },

  preflight:{
    schemaCompat:true, semanticCompat:true, // L63 semantik eÅŸdeÄŸerlik
    rbacEnforce:true, freezeRespect:true,
    budget:{ maxChangesPerHour:5, costUsdMax:15 }
  },

  shadow:{
    enable:true, kind:"read-only|shadow-env", // dry-run veya shadow namespace
    dataWrite:"none", sideEffects:"none"
  },

  probes:{
    window:"5m", graceMin:5,
    rules:{ p95MsMax:900, errPctMax:1.0, acceptRateMin:0.50, safetyNoWorse:true, evidenceCoverageMin:0.60 },
    evaluateEverySec:30, requireConsecutivePasses:2
  },

  traffic:{
    provider:"istio", stickiness:"header:tenant|cookie:session",
    stepPct:[10,25,50,100], rampDelayMin:10,
    failFast:true, autoPauseOnProbeFail:true
  },

  guardrails:{
    slo:{ p95MsMax:900, errPctMax:1.0 },
    cost:{ usdPerQueryMax:0.015 },
    safety:{ noWorse:true },
    evidence:{ coverageMin:0.60 }
  },

  rollback:{
    strategy:"immediate_on_fail|graceful", via:"runbook:rb-config-rollback",
    timeoutSec:60, postRollbackVerify:true
  },

  bundle:{
    atomicGroup:true, orderingStrategy:"topo|declared",
    twoPhaseCommit:true, // prepareâ†’commit/abort (best-effort across surfaces)
    partialFailurePolicy:"abort_all"
  },

  freezeHook:"LIVIA-51",
  integrations:{
    drift:"LIVIA-63", runbook:"LIVIA-62", canary:"LIVIA-45",
    traffic:"LIVIA-54", slo:"LIVIA-32", cost:"LIVIA-34", costGuard:"LIVIA-53",
    qo:"LIVIA-55", safety:"LIVIA-56", evidence:"LIVIA-57", fresh:"LIVIA-58",
    provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48", dist:"LIVIA-22",
    drills:"LIVIA-50", failover:"LIVIA-49"
  },

  rbacViews:{ observer:{ hideDiff:true, showOnlyOutcome:true } },

  idempotencyTtlSec: 3600
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

Planlama: istek â†’ mod (atomic|staged|canary) seÃ§imi; bundle ise iki-aÅŸamalÄ± (prepare/commit).

Preflight: ÅŸema/semantik uyum (L63), RBAC, freeze, bÃ¼tÃ§e; shadow dry-run.

Uygulama:

Canary/Staged: trafik %Xâ€™e yÃ¶nlendir; konfig yalnÄ±z hedef pods/routeâ€™larda etkin.

Atomic: bakÄ±m penceresi zorunlu; tek hamlede apply + hÄ±zlÄ± prob.

Probe & Guardrails: SLO/Cost/Safety/Evidence eÅŸiÄŸi; ardÄ±ÅŸÄ±k geÃ§iÅŸ sayÄ±sÄ± â†’ promote ya da rollback.

Traffic Shift: L54 ile istio/envoy/nginx; stickiness=tenant/session; fail-fast destekli.

Rollback: fail/ihlal durumunda otomatik; runbook (L62) ile gÃ¼venli geri dÃ¶nÃ¼ÅŸ + post-verify.

Persist: tÃ¼m aÅŸamalar WORM/Lineage/Audit; rapor ve kart L22.

6) Pipeline (Kompozisyon)

Ingest: config.apply.request|bundle.request|health.probe.policy|traffic.capabilities

Plan: mod+stages; rollback planÄ± ve guardrails

Preflight/Shadow: schema/semantik/RBAC/freeze/bÃ¼tÃ§e; shadow/dry-run

Apply Stage: (canary/staged/atomic)

Probe: SLO/Cost/Safety/Evidence Ã¶lÃ§; status ok|warn|fail

Shift: trafik aÄŸÄ±rlÄ±klarÄ±nÄ± gÃ¼ncelle

Promote/Rollback: kurallara gÃ¶re nihai karar

Finalize: rapor, kart, metrik, audit; idempotent kayÄ±t

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (apply.request|bundle.request) PLAN

PLAN â†’ PREFLIGHT â†’ (fail) ALERT/DONE | SHADOW

SHADOW â†’ (ok) APPLY_STAGE | (fail) ALERT/DONE

APPLY_STAGE â†’ PROBE â†’ (ok) SHIFT â†’ (tÃ¼m aÅŸamalar bitti) PROMOTE â†’ FINALIZE

PROBE â†’ (fail/warn>limit) ROLLBACK â†’ FINALIZE

Hata: ALERT; idem: aynÄ± applyKey yinelemesinde yalnÄ±z snapshot/metrik gÃ¼ncellenir

8) Kenar Durumlar

Freeze Aktif: freeze_active â†’ yalnÄ±z plan/preflight/shadow; apply yok.

Schema Ä°nkompatibilitesi: schema_incompatible â†’ plan iptal, migration Ã¶ner.

Bundle Partial Failure: iki-aÅŸamalÄ± commit; bir yÃ¼zey fail â†’ abort_all + rollback.

Probe Flap (gÃ¼rÃ¼ltÃ¼): ardÄ±ÅŸÄ±k geÃ§iÅŸ koÅŸulu ve grace ile yanlÄ±ÅŸ negatif azalt.

Stickiness Yoksa: kullanÄ±cÄ±lar kol arasÄ±nda zÄ±plar â†’ header/cookie ile sabitle.

Cost BaskÄ±sÄ±: L53 tetik â†’ stage sÃ¼resini uzat veya promote eÅŸiÄŸini sÄ±kÄ±laÅŸtÄ±r.

DR/Failover: L49 aktif â†’ yalnÄ±z shadow/staged dÃ¼ÅŸÃ¼k %; promote kapalÄ±.

Observer: diff/secret gizli; yalnÄ±z sonuÃ§/telemetri.

Idempotency: aynÄ± applyKey ikinci kez â†’ no-op (card/metrik gÃ¼ncellenir).

9) Telemetri
{
  "config.metrics": {
    "event":"config.metrics","timestamp":"iso8601",
    "applies":1,"promoted":1,"rolledBack":0,
    "avgPreflightMs":110,"avgProbeMs":4200,"avgStageMs":120000,
    "trafficShifts":2,"downtimeSec":0,
    "guardrailBreaches":0,"autoPauses":0
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/zeroDowntimeConfigApplier.ts          # FSM + orchestrator
services/livia/lib/zd/plan.ts                        # stage planlayÄ±cÄ± + rollback stratejisi
services/livia/lib/zd/preflight.ts                   # schema/semantik/RBAC/freeze/bÃ¼tÃ§e
services/livia/lib/zd/shadow.ts                      # shadow/dry-run yÃ¼rÃ¼tÃ¼cÃ¼
services/livia/lib/zd/apply.ts                       # stage/canary/atomic apply
services/livia/lib/zd/probe.ts                       # health probe + guardrail deÄŸerlendirme
services/livia/lib/zd/shift.ts                       # traffic provider kÃ¶prÃ¼leri (istio/envoy/nginx)
services/livia/lib/zd/rollback.ts                    # runbook kÃ¶prÃ¼sÃ¼ + otomatik geri dÃ¶nÃ¼ÅŸ
services/livia/lib/zd/report.ts                      # md/html rapor + inline grafik
services/livia/lib/bridges.ts                        # L22/L32/L34/L38/L39/L45/L48/L49/L50/L51/L53/L54/L55/L56/L57/L58/L62/L63
services/livia/state/zdStore.ts                      # idem index + plan cache + probe geÃ§miÅŸi
services/livia/__tests__/zeroDowntimeConfigApplier.test.ts
cfg/livia.zd.yaml

11) Test Ä°skeleti (Jest/Vitest)

Canary BaÅŸarÄ±lÄ±: %10/20dk â†’ guardrails OK â†’ promote

Probe Fail: p95>900ms â†’ rollback ve post-verify

Freeze: frozen â†’ freeze_active; apply yok

Schema Ä°ncompatible: preflight fail â†’ schema_incompatible uyarÄ±sÄ±

Bundle Atomic: Qo + Feature iki-aÅŸamalÄ± commit; bir fail â†’ abort_all

Traffic Stickiness: header stickiness olmadan A/B sÄ±zÄ±ntÄ±sÄ± tespit; stickiness eklenir

Idempotency: aynÄ± applyKey tekrarÄ±nda yan etki yok

Rapor: md/html Ã¼retildi; L22 daÄŸÄ±tÄ±ldÄ±; L38/L48 kayÄ±tlandÄ±

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

16:02 config.apply.request(safety, prod, canary 10%)

16:03 PREFLIGHT/SHADOW: ÅŸema/RBAC ok, freeze yok â†’ shadow ok

16:05 APPLY_STAGE: canary %10 â†’ PROBE: p95 848ms, err 0.7%, accept 0.57, evidence 0.72 â†’ ok

16:16 SHIFT: %10â†’%100; PROMOTE + post-verify p95 842ms

16:18 FINALIZE: kart/metrik/rapor yayÄ±mlandÄ±; downtime=0

13) SLO

Preflight p95 < 150 ms

Stage ramp â‰¤ 10 dk (varsayÄ±lan), probe deÄŸerlendirme â‰¤ 30 sn

Downtime = 0 sn (canary/staged)

YanlÄ±ÅŸ promote â‰¤ %1, gereksiz rollback â‰¤ %3

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
______________________________________________________________________________________________
LIVIA-65 Â· costAnomalySentinel.ts â€” GeniÅŸ Prompt v3 (+ GerÃ§ek-ZamanlÄ± Maliyet Anomalisi, Otomatik KÄ±sÄ±tlama/Degrade, GÃ¼venli Geri DÃ¶nÃ¼ÅŸ)

AmaÃ§:
GerÃ§ek-zamanlÄ± ve yakÄ±n-zaman pencerelerinde maliyet anomalilerini yakalayÄ±p kÃ¶k neden Ã§Ä±karÄ±mÄ± yaparak otomatik ve gÃ¼venli biÃ§imde kÄ±sÄ±tlama (throttle/cap), degrade (model/plan/topK/reranker/features), trafik kaydÄ±rma, politik ayar ve geri dÃ¶nÃ¼ÅŸ (restore) kararlarÄ±nÄ± uygulamak.

Kapsam: inference, retrieval/search, vektÃ¶r indeks, trafik/Ã§Ä±ktÄ± token, Ã¼Ã§Ã¼ncÃ¼ taraf API, depolama/transfer.

Hedefler: bÃ¼tÃ§e uyumu, $/sorgu, $/1k token, $/tenant/kanal, maliyet/SLO/fairness dengesi.

Entegrasyonlar: Cost Analytics (L34), Cost Guard (L53), Traffic Shaper (L54), Qo (L55), Safety (L56), Evidence (L57), Freshness (L58), Personalization (L59), MLang (L60), Learning (L61), Runbook (L62), Drift (L63), Zero-Downtime Apply (L64), Freeze (L51), SLO (L32), Audit/Provenance/Lineage (L48/L38/L39), Dist (L22).
I/O: event-driven JSON, Zod .strict(), TZ=Europe/Istanbul; idempotent + audit + metrics; OpenTelemetry.

1) Standartlar

Node 18+, TypeScript, pnpm, Jest/Vitest

Zaman: ISO-8601; gÃ¼n penceresi 00:00â€“23:59:59 (Europe/Istanbul)

GÃ¼venlik: HMAC/JWT; RBAC: ops|finance|mlops|policy tam; observer salt okur

Gizlilik: PII yok; tenant/kullanÄ±cÄ± kimlikleri L21 hash

Ä°dempotency: costKey = windowISO + scope + detectorHash + policyHash

Observability: spans (cost.ingest|baseline|detect|rca|decide|apply|restore|report) + metrics

Uyumluluk: tÃ¼m eylemler WORM (L38), Lineage (L39), Audit (L48) kayÄ±tlÄ±

2) Girdiler (In) â€” Zod .strict() ÅŸema Ã¶rnekleri
{
  "cost.stream.sample": {
    "event":"cost.stream.sample","timestamp":"iso8601",
    "component":"inference|retrieval|index|traffic|external",
    "tenant":"t#acme","channel":"web|api|batch","region":"TR|EU|US",
    "metrics":{"usd":0.0042,"tokensOut":380,"tokensIn":620,"calls":1}
  },

  "cost.window.metrics": {
    "event":"cost.window.metrics","timestamp":"iso8601",
    "window":"1m|5m|1h|1d",
    "agg":{"usdPerQuery":0.012,"usdPer1kTok":0.68,"totalUsd":42.3},
    "byComponent":{"inference":0.008,"retrieval":0.003,"index":0.001},
    "byTenant":{"t#acme":0.014,"t#beta":0.009}
  },

  "billing.usage.snapshot": {
    "event":"billing.usage.snapshot","timestamp":"iso8601",
    "provider":"cloud|llm|search","period":"hour","amountUsd":128.4,
    "usage":{"calls":18200,"tokIn":3_200_000,"tokOut":5_600_000}
  },

  "traffic.current.split": {
    "event":"traffic.current.split","timestamp":"iso8601",
    "serviceId":"kb_api","splits":[{"rev":"baseline","pct":85},{"rev":"lowcost","pct":15}]
  },

  "qo.decision.path": {
    "event":"qo.decision.path","timestamp":"iso8601",
    "route":"hybrid","planId":"P-hybrid-fast",
    "params":{"topK":60,"reranker":"ce-small","model":"gpt-m","maxTokens":700}
  },

  "slo.window.metrics": {
    "event":"slo.window.metrics","timestamp":"iso8601",
    "serviceId":"kb_api","window":"5m","p95Ms":860,"errPct":0.8
  },

  "cost.policy.updated": {
    "event":"cost.policy.updated","timestamp":"iso8601",
    "budget":{"period":"1d","tenantUsd":{"t#acme":300,"t#beta":200},"globalUsd":1200},
    "caps":{"usdPerQueryMax":0.015,"usdPer1kTokMax":0.80},
    "actions":{"allowAutoThrottle":true,"allowAutoDegrade":true}
  },

  "thresholds.cost.anomaly": {
    "event":"thresholds.cost.anomaly","timestamp":"iso8601",
    "detectors":{"ewma":{"alpha":0.3,"k":3},"stl":{"season":"1d"},"esd":{"alpha":0.05}},
    "minTraffic":200,"minSpendUsd":5
  },

  "freeze.state.changed": {
    "event":"freeze.state.changed","timestamp":"iso8601",
    "state":"frozen|thawed","scope":"global|service:kb_api","reason":"incident|audit|drill"
  }
}

3) Ã‡Ä±ktÄ±lar (Out)
{
  "cost.anomaly.detected": {
    "event":"cost.anomaly.detected","timestamp":"iso8601",
    "severity":"low|med|high|block",
    "scope":"global|tenant|channel|component",
    "signal":{"zScore":4.1,"deltaPct":+65,"window":"5m","baseline":"1d same-hour"},
    "where":{"tenant":"t#acme","component":"inference","channel":"api"},
    "rca":{"drivers":[["tokensOutPerQuery",+38],["reranker","on"],["model","gpt-m"]]}
  },

  "cost.sentinel.action.plan": {
    "event":"cost.sentinel.action.plan","timestamp":"iso8601",
    "severity":"high",
    "actions":[
      {"type":"throttle","via":"L54","args":{"path":"/answer","rpsCap":45}},
      {"type":"degrade","via":"L55","args":{"plan":"P-vec-lite","topK":40,"reranker":"none","model":"gpt-s"}},
      {"type":"cap_tokens","via":"L55","args":{"maxTokens":500}},
      {"type":"feature_toggle","via":"L64","args":{"flag":"rich_html","value":false}}
    ],
    "guardrails":{"p95MsMax":900,"acceptRateMin":0.50,"safetyNoWorse":true},
    "cooldownMin":20,"restoreHint":"gradual"
  },

  "cost.sentinel.action.applied": {
    "event":"cost.sentinel.action.applied","timestamp":"iso8601",
    "applied":["throttle","degrade","cap_tokens","feature_toggle"],
    "expectedImpact":{"usdPerQuery":"-0.0045","p95Ms":"+18ms","acceptRate":"-0.6pp"}
  },

  "cost.sentinel.restore.plan": {
    "event":"cost.sentinel.restore.plan","timestamp":"iso8601",
    "mode":"gradual","steps":[{"afterMin":20,"lift":"feature_toggle"},{"afterMin":40,"lift":"cap_tokens"},{"afterMin":60,"lift":"degrade"}]
  },

  "cost.sentinel.restore.applied": {
    "event":"cost.sentinel.restore.applied","timestamp":"iso8601",
    "finalState":"normal","residualRisk":"low"
  },

  "cost.card": {
    "event":"cost.card","timestamp":"iso8601",
    "title":"Maliyet Anomalisi â€” inference/api (t#acme)",
    "body":"+65%/5dk â€¢ throttle+degrade uygulandÄ± â€¢ restore: kademeli.",
    "severity":"warn","ttlSec":600
  },

  "cost.alert": {
    "event":"cost.alert","timestamp":"iso8601",
    "level":"warn|error",
    "message":"idem_duplicate|rbac_denied|freeze_active|budget_exceeded|apply_failed|guardrail_breach"
  },

  "cost.metrics": {
    "event":"cost.metrics","timestamp":"iso8601",
    "anomalies":1,"actionsApplied":3,"restores":0,
    "avgDetectMs":68,"avgApplyMs":2200,
    "usdPerQueryDelta":"-0.0038","p95DeltaMs":"+12","acceptRateDelta":"-0.4pp"
  },

  "cost.report.ready": {
    "event":"cost.report.ready","timestamp":"iso8601",
    "path":"data/cost/2025-09-16/sentinel/report.md",
    "summary":"inference/api t#acme +65% (5m). throttle+degrade ile $/query -0.0038; SLO korundu.",
    "hash":"sha256:..."
  }
}

4) Konfig (varsayÄ±lanlar)
{
  i18n:{ locale:"tr-TR", tz:"Europe/Istanbul" },

  detectors:{
    ewma:{ alpha:0.3, k:3 },         // |x - Î¼_ewma| > k*Ïƒ_ewma
    stl:{ season:"1d", trend:"robust" },
    esd:{ alpha:0.05 },              // generalized ESD
    minTraffic:200, minSpendUsd:5,
    combine:"vote_majority|max_zscore"
  },

  baselines:{
    compareWindows:["prev_1h","prev_24h_same_hour","dow_7d"],
    normalizeBy:["queries","1k_tokens","tenant_mix"]
  },

  budgets:{
    globalUsdPerDay:1200,
    perTenantUsdPerDay:{"t#acme":300,"t#beta":200},
    caps:{ usdPerQueryMax:0.015, usdPer1kTokMax:0.80 }
  },

  rca:{
    features:["tokensOutPerQuery","topK","reranker","model","retrievalHits","indexLatencyMs","trafficMix","lang","fmt_html"],
    shaplikeTopN:5
  },

  actions:{
    throttle:{ enable:true, provider:"L54", rpsCapsByTier:{ gold:60, silver:40, bronze:25 } },
    degrade:{
      enable:true, via:"L55",
      plans:[
        {"from":"P-hybrid-fast","to":"P-vec-lite","topK":"-20","reranker":"none","model":"gpt-s","maxTokens":"-200"}
      ]
    },
    cap_tokens:{ enable:true, minMaxTokens:400 },
    feature_toggle:{ enable:true, flags:["rich_html","inline_svg","long_citations"] },
    traffic_shift:{ enable:true, provider:"L54", toRevision:"lowcost", pct:15 }
  },

  guardrails:{
    slo:{ p95MsMax:900, errPctMax:1.0, acceptRateMin:0.50 },
    safety:{ noWorse:true }, evidence:{ coverageMin:0.60 },
    fairness:{ protected:["tier","region"], parityTolerancePct:10 } // dÃ¼ÅŸÃ¼k tier'Ä± orantÄ±sÄ±z etkileme
  },

  restore:{
    mode:"gradual", stepMin:20, requireStableWindows:2, hysteresisPct:10
  },

  freezeRespect:true,

  integrations:{
    cost:"LIVIA-34", costGuard:"LIVIA-53", traffic:"LIVIA-54",
    qo:"LIVIA-55", safety:"LIVIA-56", evidence:"LIVIA-57", fresh:"LIVIA-58",
    pers:"LIVIA-59", mlang:"LIVIA-60", learn:"LIVIA-61",
    runbook:"LIVIA-62", drift:"LIVIA-63", zd:"LIVIA-64",
    slo:"LIVIA-32", provenance:"LIVIA-38", lineage:"LIVIA-39", audit:"LIVIA-48", dist:"L22"
  },

  rbacViews:{ observer:{ hideDrivers:true, showOnlyTotals:true } },

  idempotencyTtlSec: 1800
}

5) Karar MantÄ±ÄŸÄ± (Ã¶zet)

Tespit: EWMA/STL/ESD Ã§oklu-dedektÃ¶r; trafik/spend eÅŸiÄŸi saÄŸlanÄ±rsa anomaly.

RCA: SHAP-vari katkÄ±larla sÃ¼rÃ¼cÃ¼leri sÄ±rala (tokensOut/topK/model/reranker/feature/trafficMixâ€¦).

Åiddet: deltaPct, zScore, budget gap, blast radius â†’ low/med/high/block.

Eylem PlanÄ±: ÅŸiddete gÃ¶re throttle â†’ degrade â†’ cap_tokens â†’ feature_toggle â†’ traffic_shift; guardrail ve fairness kontrolÃ¼.

Uygulama: L54/L55/L64 Ã¼zerinden zero-downtime; Freeze aktifse yalnÄ±z plan/rapor.

Restore: koÅŸullar normale dÃ¶ndÃ¼ÄŸÃ¼nde kademeli kaldÄ±r (histerezis + stabil pencere).

Ã–ÄŸrenme: L61â€™e kalÄ±cÄ± tuning Ã¶nerileri (Ã¶rn. varsayÄ±lan topK â†“).

Raporlama: card/alert/metrics/report; WORM/Lineage/Audit.

6) Pipeline (Kompozisyon)

Ingest: cost/billing/traffic/qo/slo akÄ±ÅŸlarÄ±

Baseline: normalizasyon ve sezonluk tabanlar (aynÄ± saat/hafta gÃ¼nÃ¼)

Detect: Ã§oklu dedektÃ¶r â†’ anomaly + ÅŸiddet

RCA: sÃ¼rÃ¼cÃ¼ler ve etkileri

Decide: eylem planÄ± + guardrails + fairness

Apply: throttle/degrade/cap/feature/traffic (freeze deÄŸilse)

Observe: etkileri Ã¶lÃ§; restore iÃ§in stabiliteyi izle

Emit: anomaly.detected, action.plan/applied, restore.plan/applied, card/alert/metrics/report

Persist: L38/L39/L48 ve cache

7) FSM â€” advance(state, event, cfg, now) â†’ emissions[]

IDLE â†’ (cost.stream.sample|cost.window.metrics|billing.snapshot) DETECT

DETECT â†’ (no anomaly) IDLE | (anomaly) RCA â†’ DECIDE â†’ (freeze? PARK) | APPLY â†’ OBSERVE â†’ (stable) RESTORE â†’ REPORT â†’ IDLE

Hata: ALERT; idem: aynÄ± costKey yinelemesinde yan etki yok (yalnÄ±z kart/metrik gÃ¼ncellenir)

8) Kenar Durumlar

DÃ¼ÅŸÃ¼k Trafik: minTraffic altÄ±nda â†’ tespit ertelenir, false positive Ã¶nlenir.

SezonsallÄ±k: stl sezon farkÄ± â†’ sahte alarm; sezon tabanÄ± ile dÃ¼zeltilir.

Token PatlamasÄ±: tek tenant/kanal tokenOut sÄ±Ã§rar â†’ cap_tokens Ã¶ncelik.

Fairness: sadece dÃ¼ÅŸÃ¼k tierâ€™i etkileyecek throttle â†’ parity kontrolÃ¼ ÅŸart.

SLO BaskÄ±sÄ±: degrade p95â€™i bozmamalÄ±; aÅŸarsa geri al.

Freeze: frozen â†’ yalnÄ±z plan ve rapor; apply yok.

Zincirleme Etki: feature kapatmasÄ± Evidence/Freshnessâ€™i dÃ¼ÅŸÃ¼rÃ¼rse alternatif plan.

Partial Success: bazÄ± eylemler uygulanamadÄ± â†’ Runbook (L62) devreye girer.

Idempotency: aynÄ± anomaly iÃ§in ikinci Ã§alÄ±ÅŸtÄ±rma yan etkisiz.

9) Telemetri
{
  "cost.metrics": {
    "event":"cost.metrics","timestamp":"iso8601",
    "anomalies":1,"actionsApplied":3,"restores":0,
    "avgDetectMs":68,"avgApplyMs":2200,
    "usdPerQueryDelta":"-0.0038","p95DeltaMs":"+12","acceptRateDelta":"-0.4pp",
    "falsePositivePct":1.2
  }
}

10) Dosya YapÄ±sÄ± (Ã¶neri)
services/livia/costAnomalySentinel.ts                 # FSM + orchestrator
services/livia/lib/cost/detect.ts                     # EWMA/STL/ESD + sezon tabanÄ±
services/livia/lib/cost/rca.ts                        # sÃ¼rÃ¼cÃ¼ analizi (SHAP-vari)
services/livia/lib/cost/decide.ts                     # aksiyon seÃ§im/guardrail/fairness
services/livia/lib/cost/apply.ts                      # L54/L55/L64 entegrasyonlarÄ±
services/livia/lib/cost/restore.ts                    # kademeli restore + histerezis
services/livia/lib/cost/report.ts                     # md/html rapor + grafik
services/livia/lib/bridges.ts                         # L22/L32/L34/L38/L39/L48/L51/L53/L54/L55/L56/L57/L58/L59/L60/L61/L62/L63/L64
services/livia/state/costStore.ts                     # idem index + baseline cache + cooldown
services/livia/__tests__/costAnomalySentinel.test.ts
cfg/livia.cost.yaml

11) Test Ä°skeleti (Jest/Vitest)

SÄ±Ã§rama: +65%/5m â†’ anomaly.detected(high) â†’ throttle+degrade uygulanÄ±r

Sahte Alarm: dÃ¼ÅŸÃ¼k trafik â†’ alarm bastÄ±rÄ±lÄ±r

Guardrail Ä°hlali: degrade sonrasÄ± p95>900 â†’ otomatik restore

Fairness: throttle dÃ¼ÅŸÃ¼k tierâ€™e orantÄ±sÄ±z â†’ plan revize edilir

Freeze: frozen â†’ plan/rapor, apply yok

Restore: 2 stabil pencere â†’ kademeli kaldÄ±rma

Idempotency: aynÄ± costKey ilkinden sonra yan etki yok

Rapor: md/html Ã¼retildi; L22 daÄŸÄ±tÄ±ldÄ±; L38/L48 kayÄ±tlandÄ±

12) Ã–rnek AkÄ±ÅŸ (kÄ±sa)

15:05 DETECT: inference/api t#acme +65% (5m, z=4.1)

15:06 RCA: tokensOut â†‘, reranker on, model gpt-m â†’ sÃ¼rÃ¼cÃ¼ler belirlendi

15:07 DECIDE/APPLY: throttle 45 rps + plan P-vec-lite + maxTokens 500 + rich_html=false

15:25 OBSERVE: $/query -0.0038, p95 +12ms, accept -0.4pp (guardrails OK)

16:00 RESTORE: kademeli kaldÄ±rma â†’ sistem normal

16:05 REPORT: kart/metrik/rapor yayÄ±mlandÄ±

13) SLO

Tespit p95 < 100 ms

YanlÄ±ÅŸ pozitif â‰¤ %2, kaÃ§an yÃ¼ksek ÅŸiddet â‰¤ %1

Uygulama p95 < 3 s (trafik/plan eylemleri)

BÃ¼tÃ§e ihlali sÃ¼resi â‰¤ 15 dk

Idempotent Ã§akÄ±ÅŸma â‰ˆ 0
_____________________________________________________________________________________________
